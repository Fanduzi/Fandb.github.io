<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mha failover测试 | Fan()</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="MySQLMHA" />
  
  
  
  
  <meta name="description" content="TL;DR   用例 ping_type&#x3D;CONNECT ping_type&#x3D;INSERT     master too many connection 不会触发failover 不会触发failover   master hang 不会触发failover 会触发failover且成功   仅manager无法连通master 不会触发failover 不会触发failover   manage">
<meta property="og:type" content="article">
<meta property="og:title" content="MHA Failover测试">
<meta property="og:url" content="http://fuxkdb.com/2021/02/07/2021-02-07-MHA-Failover%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="Fan()">
<meta property="og:description" content="TL;DR   用例 ping_type&#x3D;CONNECT ping_type&#x3D;INSERT     master too many connection 不会触发failover 不会触发failover   master hang 不会触发failover 会触发failover且成功   仅manager无法连通master 不会触发failover 不会触发failover   manage">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-07T14:16:00.000Z">
<meta property="article:modified_time" content="2021-02-07T14:18:21.289Z">
<meta property="article:author" content="大范">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="MHA">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Fan()" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpeg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpeg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("/css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("/css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("/css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

<meta name="generator" content="Hexo 6.2.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpeg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2021-02-07-MHA-Failover测试" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      MHA Failover测试
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2021/02/07/2021-02-07-MHA-Failover%E6%B5%8B%E8%AF%95/" class="article-date">
	  <time datetime="2021-02-07T14:16:00.000Z" itemprop="datePublished">2021-02-07</time>
	</a>

      
      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><table>
<thead>
<tr>
<th>用例</th>
<th>ping_type=CONNECT</th>
<th>ping_type=INSERT</th>
</tr>
</thead>
<tbody>
<tr>
<td>master too many connection</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>master hang</td>
<td>不会触发failover</td>
<td>会触发failover且成功</td>
</tr>
<tr>
<td>仅manager无法连通master</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, 且无法ssh slave1</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, 且无法ssh slave1和slave2</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, ssh到slave1后无法连通master</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, ssh到slave1和slave2后均无法连通master</td>
<td>会触发failover且成功</td>
<td>会触发failover且成功(长连接断开后才会)</td>
</tr>
<tr>
<td>master宕机前slave1也宕机了</td>
<td>会触发failover, 但failover失败</td>
<td>会触发failover, 但failover失败</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 io_thread stop了</td>
<td>会failover且成功</td>
<td>会failover且成功</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 io_thread error了</td>
<td>会failover且成功</td>
<td>会failover且成功</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 sql_thread stop了</td>
<td>会failover且成功</td>
<td>会failover且成功</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 sql_thread error了</td>
<td>会触发failover, 但failover失败</td>
<td>会触发failover, 但failover失败</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master: 172.16.120.10 centos-1 主 + proxysql</span><br><span class="line">slave1: 172.16.120.11 centos-2 从 + proxysql</span><br><span class="line">slave2: 172.16.120.12 centos-3 从 + proxysql</span><br><span class="line">172.16.120.13 centos-4 mha manager</span><br></pre></td></tr></table></figure>
<p>MHA配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat /etc/masterha/conf/masterha_default.cnf </span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="comment"># mysql user and password，此处的密码不能加引号</span></span><br><span class="line"><span class="attr">user</span>=mha</span><br><span class="line"><span class="attr">password</span>=xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#replication_user</span></span><br><span class="line"><span class="attr">repl_user</span>=repler</span><br><span class="line"><span class="attr">repl_password</span>=xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#checking master every 3 second </span></span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用短连接检测，默认是长连接</span></span><br><span class="line"><span class="attr">ping_type</span>=INSERT</span><br><span class="line"><span class="comment">#ping_type=CONNECT</span></span><br><span class="line"><span class="comment">#下面会测试两种type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ssh user</span></span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="comment">#发送邮件脚本</span></span><br><span class="line"><span class="attr">report_script</span>=/etc/masterha/scripts/send_report</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点工作目录</span></span><br><span class="line"><span class="attr">remote_workdir</span>=/masterha/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#cat /etc/masterha/conf/cls_new.cnf</span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="comment">#workdir on the management server</span></span><br><span class="line"><span class="attr">manager_workdir</span>=/masterha/cls_new/</span><br><span class="line"><span class="attr">manager_log</span>=/masterha/cls_new/manager.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#workdir on the node for mysql server</span></span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql_3358/data/</span><br><span class="line"></span><br><span class="line"><span class="comment">#自动故障VIP切换调用脚本</span></span><br><span class="line"><span class="attr">master_ip_failover_script</span>=/etc/masterha/scripts/master_ip_failover_vip --vip=<span class="number">172.16</span>.<span class="number">120.128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#手动故障切换调用脚本</span></span><br><span class="line"><span class="attr">master_ip_online_change_script</span>=/etc/masterha/scripts/master_ip_online_change_vip --vip=<span class="number">172.16</span>.<span class="number">120.128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检测master的可用性</span></span><br><span class="line"><span class="attr">secondary_check_script</span>=masterha_secondary_check -s <span class="number">172.16</span>.<span class="number">120.11</span> -s <span class="number">172.16</span>.<span class="number">120.12</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.10</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.11</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.12</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-too-many-connection"><a href="#用例测试-master-too-many-connection" class="headerlink" title="[用例测试] master too many connection"></a>[用例测试] master too many connection</h2><h3 id="ping-type-CONNECT"><a href="#ping-type-CONNECT" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:43:29 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      7 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |      2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |     14 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 952922 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 952902 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |      2 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    120 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     58 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     17 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |      0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">43</span>:<span class="number">30</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%max_connec%&#x27;</span>;</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| Variable_name         | Value   |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| extra_max_connections | 1       |</span><br><span class="line">| max_connect_errors    | 1000000 |</span><br><span class="line">| max_connections       | 1024    |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">49</span>:<span class="number">34</span> [dbms_monitor]&gt; <span class="keyword">set</span> <span class="keyword">global</span> max_connections=<span class="number">5</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec);</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover"><a href="#结论-不会failover" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 11:42:57 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Oct  9 11:42:57 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri Oct  9 11:42:57 2020 - [info]  OK.</span><br><span class="line">Fri Oct  9 11:42:57 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Oct  9 11:42:57 2020 - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:49:51 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Too many connections at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">1040 (Too many connections)</span><br><span class="line">Fri Oct  9 11:49:51 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">51</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">54</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">1040</span> (Too many connections)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">54</span> <span class="number">2020</span> - [info] Got MySQL <span class="keyword">error</span> <span class="number">1040</span>, but this <span class="keyword">is</span> <span class="keyword">not</span> a MySQL crash. Continue health check..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">1040</span> (Too many connections)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Got MySQL <span class="keyword">error</span> <span class="number">1040</span>, but this <span class="keyword">is</span> <span class="keyword">not</span> a MySQL crash. Continue health check..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">1040</span> (Too many connections)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">00</span> <span class="number">2020</span> - [info] Got MySQL <span class="keyword">error</span> <span class="number">1040</span>, but this <span class="keyword">is</span> <span class="keyword">not</span> a MySQL crash. Continue health check..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT"><a href="#ping-type-INSERT" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:55:13 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      1 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |     18 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     16 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      8 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 953626 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 953606 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |      6 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    103 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     41 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |      1 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |      0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2160</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34660</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |      <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">55</span>:<span class="number">14</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%max_connec%&#x27;</span>;</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| Variable_name         | Value   |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| extra_max_connections | 1       |</span><br><span class="line">| max_connect_errors    | 1000000 |</span><br><span class="line">| max_connections       | 1024    |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">55</span>:<span class="number">19</span> [dbms_monitor]&gt; <span class="keyword">set</span> <span class="keyword">global</span> max_connections=<span class="number">5</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:55:25 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      6 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      3 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     31 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      3 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 953641 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 953621 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |      0 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    118 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     56 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |      6 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |      0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2160</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34660</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |      <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>ping_type=INSERT是长连接, 不会感知<code>too many connection</code>.</p>
<p>手动kill掉mha连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:55:29 [dbms_monitor]&gt; kill 2160;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-1"><a href="#结论-不会failover-1" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 11:54:48 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Oct  9 11:54:48 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri Oct  9 11:54:48 2020 - [info]  OK.</span><br><span class="line">Fri Oct  9 11:54:48 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Oct  9 11:54:48 2020 - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">48</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">48</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">48</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:42 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:42 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:42 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">ERROR 1040 (HY000): Too many connections</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not writable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">ERROR 1040 (HY000): Too many connections</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not writable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:43 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:45 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:45 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:48 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:48 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:51 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:51 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:54 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:54 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:57 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:57 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:57:00 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-hang"><a href="#用例测试-master-hang" class="headerlink" title="[用例测试] master hang"></a>[用例测试] master hang</h2><h3 id="ping-type-CONNECT-1"><a href="#ping-type-CONNECT-1" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>master hang不好模拟, 这里间接模拟. 需要将ping_select的执行的<code>select 1</code>改为<code>select innodb_table</code>查询一个innodb表</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">ping_select</span>($) </span>&#123;</span><br><span class="line">  <span class="keyword">my</span> $self = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">my</span> $log  = $self-&gt;&#123;logger&#125;;</span><br><span class="line">  <span class="keyword">my</span> $dbh  = $self-&gt;&#123;dbh&#125;;</span><br><span class="line">  <span class="keyword">my</span> ( $query, $sth, $href );</span><br><span class="line">  <span class="keyword">eval</span> &#123;</span><br><span class="line">    $dbh-&gt;&#123;RaiseError&#125; = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">#$sth = $dbh-&gt;prepare(&quot;SELECT 1 As Value&quot;);</span></span><br><span class="line">    $sth = $dbh-&gt;prepare(<span class="string">&quot;SELECT 1 As Value from infra.chk_masterha limit 1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>然后修改<code>innodb_thread_concurrency</code>值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:25:34 [dbms_monitor]&gt; set global innodb_thread_concurrency=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>手动执行一个查询, 查询innodb表, 这样mha的select会被阻塞</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:25:45 [dbms_monitor]&gt; select sleep(600) from infra.chk_masterha limit 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@localhost 12:29:09 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info                                              | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |     16 |                                                               | NULL                                              |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      4 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |      1 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      4 |                                                               | NULL                                              |         1 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 955662 | Master has sent all binlog to slave; waiting for more updates | NULL                                              |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 955642 | Master has sent all binlog to slave; waiting for more updates | NULL                                              |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     11 |                                                               | NULL                                              |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |     96 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     34 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |      6 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |     21 | User sleep                                                    | <span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">600</span>) <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2260</span> | root     | localhost           | dbms_monitor       | <span class="keyword">Query</span>            |      <span class="number">0</span> | <span class="keyword">starting</span>                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span>                                  |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2303</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34982</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">20</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2305</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34988</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">17</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2308</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34994</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">14</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2310</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34998</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">11</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2312</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35002</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">8</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2314</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35006</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">5</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2317</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35010</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">2</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">19</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-mha-manager可能报错退出"><a href="#结论-不会failover-mha-manager可能报错退出" class="headerlink" title="结论: 不会failover, mha manager可能报错退出"></a>结论: 不会failover, mha manager可能报错退出</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 12:28:44 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Oct  9 12:28:44 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri Oct  9 12:28:44 2020 - [info]  OK.</span><br><span class="line">Fri Oct  9 12:28:44 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Oct  9 12:28:44 2020 - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">44</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">44</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">53</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">timeout</span> <span class="keyword">on</span> MySQL Ping(<span class="keyword">CONNECT</span>) <span class="keyword">child</span> process <span class="keyword">and</span> killed it! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">435.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:59 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:59 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">timeout</span> <span class="keyword">on</span> MySQL Ping(<span class="keyword">CONNECT</span>) <span class="keyword">child</span> process <span class="keyword">and</span> killed it! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">435.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">47</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">手动ctrl+c终止select sleep(600) from infra.chk_masterha limit 1后, mha manager报错退出了</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Fri Oct  9 12:30:49 2020 - [warning] Got error when monitoring master:  at /usr/local/share/perl5/MHA/MasterMonitor.pm line 489.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:30:49 2020 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln491] Target master&#x27;</span>s advisory <span class="keyword">lock</span> <span class="keyword">is</span> already held <span class="keyword">by</span> someone. Please <span class="keyword">check</span> whether you monitor the same <span class="keyword">master</span> <span class="keyword">from</span> multiple <span class="keyword">monitoring</span> processes.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">error</span>][/usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/MasterMonitor.pm, ln511] <span class="keyword">Error</span> happened <span class="keyword">on</span> health checking.  <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/masterha_manager line <span class="number">50.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">error</span>][/usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/MasterMonitor.pm, ln525] <span class="keyword">Error</span> happened <span class="keyword">on</span> <span class="keyword">monitoring</span> servers.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Got <span class="keyword">exit</span> code <span class="number">1</span> (<span class="keyword">Not</span> <span class="keyword">master</span> dead).</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-1"><a href="#ping-type-INSERT-1" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>master hang不好模拟, 这里间接模拟. 修改<code>innodb_thread_concurrency</code>值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:25:34 [dbms_monitor]&gt; set global innodb_thread_concurrency=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>手动执行一个查询, 查询innodb表, 这样mha的insert会被阻塞</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:35:21 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info                                                                                                 | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      3 |                                                               | NULL                                                                                                 |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      1 |                                                               | NULL                                                                                                 |         1 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |      8 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      1 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 956039 | Master has sent all binlog to slave; waiting for more updates | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 956019 | Master has sent all binlog to slave; waiting for more updates | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     28 |                                                               | NULL                                                                                                 |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    113 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     51 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     13 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |     15 | User sleep                                                    | <span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">600</span>) <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span>                                                    |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2260</span> | root     | localhost           | dbms_monitor       | <span class="keyword">Query</span>            |      <span class="number">0</span> | <span class="keyword">starting</span>                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span>                                                                                     |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2395</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35206</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">13</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2398</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35208</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">11</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2400</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">32908</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">10</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2401</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35216</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">8</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2403</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">58066</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">7</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2404</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35222</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">5</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">18</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover"><a href="#结论-会failover" class="headerlink" title="结论: 会failover"></a>结论: 会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 12:35:00 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:16 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:16 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:16 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:17 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:19 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:19 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not writable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:22 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:22 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not writable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:23 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">start down vipRTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:827239</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:8822-10390</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:827239</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:8822-10390</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000008</span>:<span class="number">811243</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Fri Oct  9 12:35:28 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 811243, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-10390,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Fri Oct  9 12:35:28 2020 - [info] Executing master IP activate script:</span><br><span class="line">Fri Oct  9 12:35:28 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 44798. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009123527.log if it takes time..</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-10390</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] Sending mail..</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="以下情况都不会failover-即便是手动failover指定了-–master-state-dead-也不行"><a href="#以下情况都不会failover-即便是手动failover指定了-–master-state-dead-也不行" class="headerlink" title="以下情况都不会failover, 即便是手动failover指定了 –master_state=dead 也不行"></a>以下情况都不会failover, 即便是手动failover指定了 –master_state=dead 也不行</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">our</span> @ALIVE_ERROR_CODES = (</span><br><span class="line">  <span class="number">1040</span>,    <span class="comment"># ER_CON_COUNT_ERROR                  -- too many connection</span></span><br><span class="line">  <span class="number">1042</span>,    <span class="comment"># ER_BAD_HOST_ERROR                   -- Can&#x27;t get hostname for your address</span></span><br><span class="line">  <span class="number">1043</span>,    <span class="comment"># ER_HANDSHAKE_ERROR                  -- Bad handshake</span></span><br><span class="line">  <span class="number">1044</span>,    <span class="comment"># ER_DBACCESS_DENIED_ERROR            -- Access denied for user &#x27;%s&#x27;@&#x27;%s&#x27; to database &#x27;%s&#x27;</span></span><br><span class="line">  <span class="number">1045</span>,    <span class="comment"># ER_ACCESS_DENIED_ERROR              -- Access denied for user &#x27;%s&#x27;@&#x27;%s&#x27; (using password: %s)</span></span><br><span class="line">  <span class="number">1129</span>,    <span class="comment"># ER_HOST_IS_BLOCKED                  -- Host &#x27;%s&#x27; is blocked because of many connection errors; unblock with &#x27;mysqladmin flush-hosts&#x27;</span></span><br><span class="line">  <span class="number">1130</span>,    <span class="comment"># ER_HOST_NOT_PRIVILEGED              -- Host &#x27;%s&#x27; is not allowed to connect to this MySQL server</span></span><br><span class="line">  <span class="number">1203</span>,    <span class="comment"># ER_TOO_MANY_USER_CONNECTIONS        -- User %s already has more than &#x27;max_user_connections&#x27; active connections</span></span><br><span class="line">  <span class="number">1226</span>,    <span class="comment"># ER_USER_LIMIT_REACHED               -- User &#x27;%s&#x27; has exceeded the &#x27;%s&#x27; resource (current value: %ld)</span></span><br><span class="line">  <span class="number">1251</span>,    <span class="comment"># ER_NOT_SUPPORTED_AUTH_MODE          -- Client does not support authentication protocol requested by server; consider upgrading MySQL client</span></span><br><span class="line">  <span class="number">1275</span>,    <span class="comment"># ER_SERVER_IS_IN_SECURE_AUTH_MODE    -- Server is running in --secure-auth mode, but &#x27;%s&#x27;@&#x27;%s&#x27; has a password in the old format; please change the password to the new format</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>详见<a target="_blank" rel="noopener" href="https://yunwiki.new.net/pages/viewpage.action?pageId=60342333">MHA-为什么too many connection不会failover?</a></p>
<h2 id="用例测试-master-与-mha-manager间网络异常1"><a href="#用例测试-master-与-mha-manager间网络异常1" class="headerlink" title="[用例测试] master 与 mha manager间网络异常1"></a>[用例测试] master 与 mha manager间网络异常1</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 正常 –&gt; S1 &lt;– 正常 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-2"><a href="#ping-type-CONNECT-2" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-2"><a href="#结论-不会failover-2" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:29:50 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:32:56 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 15:32:56 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:00 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:01 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:06 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:06 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:12 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:14 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">18</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:18 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:18 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">24</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:24 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:26 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:27 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">27</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:30 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:30 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:33 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">34</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-2"><a href="#ping-type-INSERT-2" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>此时manager工作正常, 因为ping_type=INSERT是长连接.</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:39:31 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |    22 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     9 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |     2 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |    19 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |   111 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    49 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 10898 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 10873 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2627 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2836</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35810</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">15</span>:<span class="number">39</span>:<span class="number">39</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">2836</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-3"><a href="#结论-不会failover-3" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:37:54 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:46 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:46 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:46 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:47 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:51 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:52 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:55 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:58 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">01</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:04 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">04</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">07</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:07 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:10 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">10</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">10</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">13</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:14 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">14</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常2"><a href="#用例测试-master-与-mha-manager间网络异常2" class="headerlink" title="[用例测试] master 与 mha manager间网络异常2"></a>[用例测试] master 与 mha manager间网络异常2</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 不通 –&gt; S1 &lt;– 正常 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-3"><a href="#ping-type-CONNECT-3" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>此时manager已经无法连通slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.349 ms</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.651 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.349/0.500/0.651/0.151 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 15:48:55 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-4"><a href="#结论-不会failover-4" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:48:03 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:40 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 15:50:40 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">40</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:44 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:45 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:45 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:47 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">50</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:50 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:50 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:53 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">53</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">53</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:56 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:58 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:58 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:59 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">59</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:02 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:02 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:05 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:09 2020 - [warning] Got timeout on Secondary Check child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-3"><a href="#ping-type-INSERT-3" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>此时manager已经无法连通slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.349 ms</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.651 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.349/0.500/0.651/0.151 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 15:48:55 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>因为ping_type=INSERT是长连接,1 所以此时无异常.</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:39:45 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |     3 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |     1 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     8 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |    11 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     8 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    89 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    26 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     3 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 11837 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 11812 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2627 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2953</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">36174</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">0</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">15</span>:<span class="number">55</span>:<span class="number">18</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">2953</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-5"><a href="#结论-不会failover-5" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:52:43 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:24 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:24 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:24 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:29 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:29 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:30 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">33</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:33 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:36 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">36</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">36</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">39</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:39 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:39 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:39 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:42 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">42</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">45</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:45 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:48 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">48</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">48</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">51</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:51 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:51 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:54 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">54</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">57</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:57 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:00 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常3"><a href="#用例测试-master-与-mha-manager间网络异常3" class="headerlink" title="[用例测试] master 与 mha manager间网络异常3"></a>[用例测试] master 与 mha manager间网络异常3</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 不通 –&gt; S1 &lt;– 正常 –&gt; master<br>Manager &lt;– 不通 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-4"><a href="#ping-type-CONNECT-4" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>slave-1, slave-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.442 ms</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.441 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.441/0.441/0.442/0.021 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 16:44:27 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2 </span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">[root@centos-4 16:44:30 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ping centos-3</span></span><br><span class="line">PING centos-3 (172.16.120.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-3 (172.16.120.12): icmp_seq=1 ttl=64 time=0.335 ms</span><br><span class="line">64 bytes from centos-3 (172.16.120.12): icmp_seq=2 ttl=64 time=0.575 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-3 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.335/0.455/0.575/0.120 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 16:44:34 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-3</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-6"><a href="#结论-不会failover-6" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 16:43:25 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:45:55 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 16:45:55 2020 - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">59</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:45:59 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:00 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:00 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:05 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:05 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:08 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">08</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">08</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">08</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:11 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:13 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:13 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">15</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-4"><a href="#ping-type-INSERT-4" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>slave-1,slave-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.352 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.352/0.352/0.352/0.000 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 17:52:38 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">ping centos-3</span></span><br><span class="line">PING centos-3 (172.16.120.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-3 (172.16.120.12): icmp_seq=1 ttl=64 time=0.221 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-3 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.221/0.221/0.221/0.000 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 17:52:41 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2 </span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">[root@centos-4 17:52:44 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-3</span></span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>由于ping_type=INSERT是长连接, 所以无异常</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 17:48:11 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |    14 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    32 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 18936 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 18911 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 3192 | proxysql | 172.16.120.11:33786 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 3238 | proxysql | 172.16.120.12:59006 | NULL               | Sleep            |     4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3245 | proxysql | 172.16.120.11:33888 | NULL               | Sleep            |    14 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 3262 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">3268</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">36868</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">17</span>:<span class="number">53</span>:<span class="number">37</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">3268</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-7"><a href="#结论-不会failover-7" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 17:50:48 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:43 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:43 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:43 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:48 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:48 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:49 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:52 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:55 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:58 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:58 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:58 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:01 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">01</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">04</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:04 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:07 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">07</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">07</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">10</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:10 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:10 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:10 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:13 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">13</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">16</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:16 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:16 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常4"><a href="#用例测试-master-与-mha-manager间网络异常4" class="headerlink" title="[用例测试] master 与 mha manager间网络异常4"></a>[用例测试] master 与 mha manager间网络异常4</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 正常 –&gt; S1 &lt;– 不通 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-5"><a href="#ping-type-CONNECT-5" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-8"><a href="#结论-不会failover-8" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 16:05:55 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:43 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 16:06:43 2020 - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">43</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:47 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:48 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.12!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:48 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">50</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:53 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:53 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">59</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:59 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:01 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.12!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:01 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:05 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:05 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:05 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-5"><a href="#ping-type-INSERT-5" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>由于ping_type=INSERT是长连接, 所以无异常</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:55:23 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |    19 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |     7 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |    27 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |    14 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |   114 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    51 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     9 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 12703 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 12678 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2627 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">3022</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">36466</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">16</span>:<span class="number">09</span>:<span class="number">44</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">3022</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-9"><a href="#结论-不会failover-9" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 16:08:29 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:51 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:51 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:56 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.12!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:57 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:57 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:00 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:06 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:06 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:06 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:12 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">18</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:18 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:18 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:18 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">21</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:21 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:21 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常5"><a href="#用例测试-master-与-mha-manager间网络异常5" class="headerlink" title="[用例测试] master 与 mha manager间网络异常5"></a>[用例测试] master 与 mha manager间网络异常5</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 正常 –&gt; S1 &lt;– 不通 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 不通 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-6"><a href="#ping-type-CONNECT-6" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover-1"><a href="#结论-会failover-1" class="headerlink" title="结论: 会failover"></a>结论: 会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 18:21:13 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:07 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 18:22:07 2020 - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">07</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:11 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:12 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">17</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:17 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [warning] SSH is NOT reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stop </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:3084318</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:10391-19970</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:3084318</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:10391-19970</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000008</span>:<span class="number">3052407</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Fri Oct  9 18:22:21 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 3052407, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-19970,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Fri Oct  9 18:22:21 2020 - [info] Executing master IP activate script:</span><br><span class="line">Fri Oct  9 18:22:21 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 68999. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009182219.log if it takes time..</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-19970</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-6"><a href="#ping-type-INSERT-6" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>由于ping_type=INSERT是长连接, 所以无异常</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 18:24:52 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |    1 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |    2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |   74 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |    2 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3192 | proxysql | 172.16.120.11:33786 | NULL               | Sleep            |    3 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3238 | proxysql | 172.16.120.12:59006 | NULL               | Sleep            |    1 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3245 | proxysql | 172.16.120.11:33888 | NULL               | Sleep            |    2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 3262 | root     | localhost           | dbms_monitor       | Query            |    0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">3357</span> | repler   | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">34036</span> | <span class="literal">NULL</span>               | <span class="keyword">Binlog</span> Dump GTID |  <span class="number">142</span> | <span class="keyword">Master</span> has sent <span class="keyword">all</span> <span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">slave</span>; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 3359 | repler   | 172.16.120.12:59166 | NULL               | Binlog Dump GTID |  123 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 3364 | mha      | 172.16.120.13:37512 | NULL               | Sleep            |    2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">11 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">18</span>:<span class="number">26</span>:<span class="number">25</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">3364</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-长连接断开后才会failover-否则不会failover"><a href="#结论-长连接断开后才会failover-否则不会failover" class="headerlink" title="结论: 长连接断开后才会failover, 否则不会failover"></a>结论: 长连接断开后才会failover, 否则不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 18:25:33 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:44 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:44 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:44 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:49 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">50</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:53 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:54 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] SSH <span class="keyword">is</span> <span class="keyword">NOT</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Connecting <span class="keyword">to</span> a <span class="keyword">master</span> <span class="keyword">server</span> failed. Reading configuration <span class="keyword">file</span> /etc/masterha/conf/masterha_default.cnf <span class="keyword">and</span> /etc/masterha/conf/cls_new.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">all</span> servers <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">server</span> status..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/masterha_default.cnf..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> down!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Terminating <span class="keyword">monitoring</span> script.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (<span class="keyword">Master</span> dead).</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] MHA::MasterFailover <span class="keyword">version</span> <span class="number">0.58</span>.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> GTID based failover.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Forcing <span class="keyword">shutdown</span> so that applications <span class="keyword">never</span> <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stop </span></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> <span class="keyword">old</span> <span class="keyword">master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> </span><br><span class="line">Fake!!! 原主库 rpl_semi_sync_master_enabled=<span class="number">0</span> rpl_semi_sync_slave_enabled=<span class="number">1</span> </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  done.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> set. Skipping explicit shutting down <span class="keyword">of</span> the dead master.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000009</span>:<span class="number">3101017</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">19971</span><span class="number">-20041</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000009</span>:<span class="number">3101017</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">19971</span><span class="number">-20041</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Oldest slaves:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> <span class="keyword">Master</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Searching <span class="keyword">new</span> <span class="keyword">master</span> <span class="keyword">from</span> slaves..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration <span class="keyword">file</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Non-candidate masters:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> events..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">is</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="keyword">From</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) (<span class="keyword">new</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied.. </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   done.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Getting <span class="keyword">new</span> <span class="keyword">master</span><span class="string">&#x27;s binlog name and position..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  mysql-bin.000008:3068991</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span><span class="string">&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;</span>repler<span class="string">&#x27;, MASTER_PASSWORD=&#x27;</span>xxx<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 3068991, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20041,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] Executing master IP activate script:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;</span>mha<span class="string">&#x27;   --new_master_password=xxx</span></span><br><span class="line"><span class="string">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span></span><br><span class="line"><span class="string">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span></span><br><span class="line"><span class="string">Set read_only=0 on the new master.</span></span><br><span class="line"><span class="string">Creating app user on the new master..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] ** Finished master recovery successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] * Phase 3: Master Recovery Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] * Phase 4: Slaves Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] * Phase 4.1: Starting Slaves in parallel..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 69850. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009182657.log if it takes time..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Log messages from 172.16.120.12 ...</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20041,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] End of log messages from 172.16.120.12.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] All new slave servers recovered successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] * Phase 5: New master cleanup phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Resetting slave info on the new master..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info]  172.16.120.11: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----- Failover Report -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeeded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Master 172.16.120.10(172.16.120.10:3358) is down!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Started automated(non-interactive) failover.</span></span><br><span class="line"><span class="string">Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Selected 172.16.120.11(172.16.120.11:3358) as a new master.</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Sending mail..</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题1-部分slave宕机"><a href="#用例测试-master挂了-且slave也有问题1-部分slave宕机" class="headerlink" title="[用例测试] master挂了, 且slave也有问题1(部分slave宕机)"></a>[用例测试] master挂了, 且slave也有问题1(部分slave宕机)</h2><blockquote>
<p>master挂了, 在此之前slave-1宕机了</p>
</blockquote>
<h3 id="ping-type-CONNECT-7"><a href="#ping-type-CONNECT-7" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 关闭slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 10:28:35 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>
<p>关闭slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-2 10:19:38 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor       </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2118</span><br><span class="line">Server version: 5.7.31-34-log Percona Server (GPL), Release 34, Revision 2e68637</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2020 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@localhost 10:20:52 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<p>关闭后, mha manager仍然是正常的</p>
<p>关闭master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-1 10:20:35 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor                                              </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3413</span><br><span class="line">Server version: 5.7.31-34-log Percona Server (GPL), Release 34, Revision 2e68637</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2020 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@localhost 10:20:47 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会触发failover-但failover失败"><a href="#结论-会触发failover-但failover失败" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 10:50:38 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 10:50:38 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">38</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">38</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">38</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">41</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:41 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:44 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln492]  Server 172.16.120.11(172.16.120.11:3358) is dead, but must be alive! Check server settings.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177] Got ERROR:  at /usr/local/share/perl5/MHA/MasterFailover.pm line 269.</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-7"><a href="#ping-type-INSERT-7" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>其实和connect应该是一样的, 不过还是走一遍流程</p>
<p>启动manager后, 关闭slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 10:59:07 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure>
<p>关闭slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-2 10:56:24 /usr/local/Percona-Server-5.7.29-32-Linux.x86_64.ssl101]</span><br><span class="line"><span class="meta">#</span><span class="bash">2020-10-10T03:00:49.502943Z mysqld_safe mysqld from pid file /data/mysql_3358/run/mysql.pid ended</span></span><br></pre></td></tr></table></figure>
<p>关闭master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-1 11:07:08 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor    </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 35</span><br><span class="line">Server version: 5.7.29-32-log Percona Server (GPL), Release 32, Revision 56bce88</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2020 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@localhost 11:07:09 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会触发failover-但failover失败-1"><a href="#结论-会触发failover-但failover失败-1" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:07:15 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span><br><span class="line">Sat Oct 10 11:07:15 2020 - [info] Executing SSH check script: exit 0</span><br><span class="line">Sat Oct 10 11:07:15 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span><br><span class="line">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span><br><span class="line">Sat Oct 10 11:07:16 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span><br><span class="line">Sat Oct 10 11:07:16 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Sat Oct 10 11:07:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:07:18 2020 - [warning] Connection failed 2 time(s)..</span><br><span class="line">Sat Oct 10 11:07:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:07:21 2020 - [warning] Connection failed 3 time(s)..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Connection failed 4 time(s)..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Master is not reachable from health checker!</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] SSH is reachable.</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Master is down!</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Terminating monitoring script.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Got exit code 20 (Master dead).</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] MHA::MasterFailover version 0.58.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Starting master failover.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] </span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] </span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln492]  Server 172.16.120.11(172.16.120.11:3358) is dead, but must be alive! Check server settings.</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177] Got ERROR:  at /usr/local/share/perl5/MHA/MasterFailover.pm line 269.</span><br></pre></td></tr></table></figure>
<h3 id="总结-如不希望slave-1宕机影响failover-需要在配置文件中对slave-1设置ignore-fail-1"><a href="#总结-如不希望slave-1宕机影响failover-需要在配置文件中对slave-1设置ignore-fail-1" class="headerlink" title="总结: 如不希望slave-1宕机影响failover, 需要在配置文件中对slave-1设置ignore_fail=1"></a>总结: 如不希望slave-1宕机影响failover, 需要在配置文件中对slave-1设置ignore_fail=1</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.11</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">ignore_fail</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题2-部分slave-io-thread-stop"><a href="#用例测试-master挂了-且slave也有问题2-部分slave-io-thread-stop" class="headerlink" title="[用例测试] master挂了, 且slave也有问题2(部分slave io_thread stop)"></a>[用例测试] master挂了, 且slave也有问题2(部分slave io_thread stop)</h2><blockquote>
<p>master挂了, 在此之前slave-1 io_thread stop了</p>
</blockquote>
<h3 id="ping-type-CONNECT-8"><a href="#ping-type-CONNECT-8" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 关闭slave-1 io_thread</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:13:58 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure>
<p>关闭slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:17:29 [dbms_monitor]&gt; stop slave io_thread;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:17:33 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">17</span>:<span class="number">49</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000011</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000009</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">407</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000011</span></span><br><span class="line">             Slave_IO_Running: <span class="keyword">No</span></span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates</span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>关闭io_thread后 manager仍然正常</p>
<p>关闭master</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:21:18 [dbms_monitor]&gt; insert into monitor_delay values(1,now());</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:21:39 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">21</span>:<span class="number">54</span> [dbms_monitor]&gt; <span class="keyword">shutdown</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:17:49 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 10:20:54 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover且成功"><a href="#结论-会failover且成功" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:22:12 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:22:12 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:15 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">18</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000011:486</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20042-20531</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000011:194</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20143-20530</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">23</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000007</span>:<span class="number">3182161</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">23</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.12&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 11:22:23 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3182161, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 11:22:23 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 11:22:23 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 77208. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010112222.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-20531</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>). Executed <span class="number">2</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<p>slave-1正常change到new master slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:21:44 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.12</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Master_Log_Pos: 3182161</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 681</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000007</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 3182161</span><br><span class="line">              Relay_Log_Space: 888</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120123358</span><br><span class="line">                  Master_UUID: 45e70f96-fcad-11ea-a2f0-0050563108d2</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20531</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">24</span>:<span class="number">39</span> [dbms_monitor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-8"><a href="#ping-type-INSERT-8" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager后, 关闭slave-1 io_thread</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:29:28 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>
<p>关闭slave-1 io_thread</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:30:30 [dbms_monitor]&gt; stop slave io_thread;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:30:43 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">30</span>:<span class="number">45</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000012</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">18307</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">18480</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000012</span></span><br><span class="line">             Slave_IO_Running: <span class="keyword">No</span></span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">18307</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates</span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>关闭io_thread后 manager仍然正常</p>
<p>关闭master</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:31:40 [dbms_monitor]&gt; insert into monitor_delay values(2,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:31:45 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">31</span>:<span class="number">51</span> [dbms_monitor]&gt; <span class="keyword">shutdown</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:30:45 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:27:07 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover且成功-1"><a href="#结论-会failover且成功-1" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:33:09 2020 - [warning] SSH is reachable.</span><br><span class="line">Sat Oct 10 11:33:09 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to <span class="keyword">check</span> <span class="keyword">server</span> status..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/masterha_default.cnf..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> down!</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Terminating <span class="keyword">monitoring</span> script.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (<span class="keyword">Master</span> dead).</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] MHA::MasterFailover <span class="keyword">version</span> <span class="number">0.58</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> GTID based failover.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Forcing <span class="keyword">shutdown</span> so that applications <span class="keyword">never</span> <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> <span class="keyword">old</span> <span class="keyword">master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> </span><br><span class="line">RTNETLINK answers: Cannot assign requested address</span><br><span class="line">Fake!!! 原主库 rpl_semi_sync_master_enabled=<span class="number">0</span> rpl_semi_sync_slave_enabled=<span class="number">1</span> </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  done.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> set. Skipping explicit shutting down <span class="keyword">of</span> the dead master.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000012</span>:<span class="number">50590</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">20532</span><span class="number">-20745</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000012</span>:<span class="number">18307</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">20532</span><span class="number">-20608</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Oldest slaves:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> <span class="keyword">Master</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Searching <span class="keyword">new</span> <span class="keyword">master</span> <span class="keyword">from</span> slaves..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration <span class="keyword">file</span>:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Non-candidate masters:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> events..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">is</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="keyword">From</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) (<span class="keyword">new</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied.. </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   done.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Getting <span class="keyword">new</span> <span class="keyword">master</span><span class="string">&#x27;s binlog name and position..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  mysql-bin.000007:3232182</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span><span class="string">&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;</span>repler<span class="string">&#x27;, MASTER_PASSWORD=&#x27;</span>xxx<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3232182, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] Executing master IP activate script:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;</span>mha<span class="string">&#x27;   --new_master_password=xxx</span></span><br><span class="line"><span class="string">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span></span><br><span class="line"><span class="string">RTNETLINK answers: File exists</span></span><br><span class="line"><span class="string">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span></span><br><span class="line"><span class="string">Set read_only=0 on the new master.</span></span><br><span class="line"><span class="string">Creating app user on the new master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  OK.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] ** Finished master recovery successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] * Phase 3: Master Recovery Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] * Phase 4: Slaves Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] * Phase 4.1: Starting Slaves in parallel..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] -- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 78319. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010113310.log if it takes time..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] Log messages from 172.16.120.11 ...</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info]  gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.11(172.16.120.11:3358). Executed 2 events.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] End of log messages from 172.16.120.11.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] -- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] All new slave servers recovered successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] * Phase 5: New master cleanup phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] Resetting slave info on the new master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info]  172.16.120.12: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info] Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----- Failover Report -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.12(172.16.120.12:3358) succeeded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Master 172.16.120.10(172.16.120.10:3358) is down!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Started automated(non-interactive) failover.</span></span><br><span class="line"><span class="string">Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Selected 172.16.120.12(172.16.120.12:3358) as a new master.</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): OK: Applying all logs succeeded.</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): OK: Activated master IP address.</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): OK: Slave started, replicating from 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info] Sending mail..</span></span><br></pre></td></tr></table></figure>
<p>slave-1已经change到了slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:32:04 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.12</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Master_Log_Pos: 3232182</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 32447</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000007</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 3232182</span><br><span class="line">              Relay_Log_Space: 32654</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120123358</span><br><span class="line">                  Master_UUID: 45e70f96-fcad-11ea-a2f0-0050563108d2</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20609-20745</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">34</span>:<span class="number">29</span> [dbms_monitor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题3-部分slave-io-thread-error"><a href="#用例测试-master挂了-且slave也有问题3-部分slave-io-thread-error" class="headerlink" title="[用例测试] master挂了, 且slave也有问题3(部分slave io_thread error)"></a>[用例测试] master挂了, 且slave也有问题3(部分slave io_thread error)</h2><blockquote>
<p>master挂了, 在此之前slave-1 io_thread error了</p>
</blockquote>
<h3 id="ping-type-CONNECT-9"><a href="#ping-type-CONNECT-9" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:58:40 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.13 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure><br>kill slave-1 io_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:04:35 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id  | User     | Host                | db           | Command          | Time | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">|   2 | proxysql | 172.16.120.12:33384 | NULL         | Sleep            |    9 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">|   3 | root     | localhost           | dbms_monitor | Query            |    0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|   <span class="number">4</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">34072</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">4</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|   <span class="number">6</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35090</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|   <span class="number">7</span> | repler   | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35092</span> | <span class="literal">NULL</span>         | <span class="keyword">Binlog</span> Dump GTID |  <span class="number">485</span> | <span class="keyword">Master</span> has sent <span class="keyword">all</span> <span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">slave</span>; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">|   8 | repler   | 172.16.120.12:33392 | NULL         | Binlog Dump GTID |  472 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 110 | proxysql | 172.16.120.10:34094 | NULL         | Sleep            |    4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">+<span class="comment">-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">7 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">04</span>:<span class="number">46</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">7</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:05:20 [dbms_monitor]&gt; insert into monitor_delay values(6,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:05:02 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">|  4 | 2020-10-10 11:59:15 |</span><br><span class="line">|  5 | 2020-10-10 12:04:35 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">07</span>:<span class="number">32</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">               Slave_IO_State: Reconnecting <span class="keyword">after</span> a <span class="keyword">failed</span> <span class="keyword">master</span> <span class="keyword">event</span> <span class="keyword">read</span></span><br><span class="line">                  Master_Host: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span></span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: <span class="number">3358</span></span><br><span class="line">                Connect_Retry: <span class="number">1</span></span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000014</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">778</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000003</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">605</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000014</span></span><br><span class="line">             Slave_IO_Running: Connecting</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">778</span></span><br><span class="line">              Relay_Log_Space: <span class="number">1317</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: <span class="literal">NULL</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">2003</span></span><br><span class="line">                Last_IO_Error: <span class="keyword">error</span> reconnecting <span class="keyword">to</span> <span class="keyword">master</span> <span class="string">&#x27;repler@172.16.120.10:3358&#x27;</span> - retry-<span class="built_in">time</span>: <span class="number">1</span>  retries: <span class="number">2</span></span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: <span class="number">120103358</span></span><br><span class="line">                  Master_UUID: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: <span class="number">0</span></span><br><span class="line">          SQL_Remaining_Delay: <span class="literal">NULL</span></span><br><span class="line">      Slave_SQL_Running_State: <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: 201010 12:06:57</span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20748</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20748,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:04:42 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">|  4 | 2020-10-10 11:59:15 |</span><br><span class="line">|  5 | 2020-10-10 12:04:35 |</span><br><span class="line">|  6 | 2020-10-10 12:05:30 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:24 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-2"><a href="#结论-会failover且成功-2" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 12:11:18 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 12:11:18 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">18</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">19</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:21 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:24 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">24</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">27</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000014:1070</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20749</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000014:778</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20748</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000007</span>:<span class="number">3233250</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.12&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 12:11:29 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3233250, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20749,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 12:11:29 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 12:11:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span><br><span class="line">RTNETLINK answers: File exists</span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 81557. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010121128.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-20749</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>). Executed <span class="number">2</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-9"><a href="#ping-type-INSERT-9" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager后, 调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 12:14:59 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 12:15:01 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure></p>
<p>调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.13 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure></p>
<p>在master kill slave-1 io_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:13:11 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id | User     | Host                | db           | Command          | Time | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">|  2 | proxysql | 172.16.120.12:33486 | NULL         | Sleep            |    9 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">|  3 | root     | localhost           | dbms_monitor | Query            |    0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|  <span class="number">4</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">34148</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">4</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|  <span class="number">5</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35190</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|  <span class="number">8</span> | repler   | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35200</span> | <span class="literal">NULL</span>         | <span class="keyword">Binlog</span> Dump GTID |  <span class="number">428</span> | <span class="keyword">Master</span> has sent <span class="keyword">all</span> <span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">slave</span>; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">|  9 | repler   | 172.16.120.12:33490 | NULL         | Binlog Dump GTID |  379 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 13 | mha      | 172.16.120.13:40526 | NULL         | Sleep            |    0 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 17 | proxysql | 172.16.120.10:34164 | NULL         | Sleep            |   14 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">+<span class="comment">----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">20</span>:<span class="number">46</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">8</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:20:59 [dbms_monitor]&gt; truncate table monitor_delay;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:21:10 [dbms_monitor]&gt; insert into monitor_delay values(88,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:21:17 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:29 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Reconnecting after a failed master event read</span><br><span class="line">                  Master_Host: 172.16.120.10</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000015</span><br><span class="line">          Read_Master_Log_Pos: 85472</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 85645</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000015</span><br><span class="line">             Slave_IO_Running: Connecting</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 85472</span><br><span class="line">              Relay_Log_Space: 85852</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 2003</span><br><span class="line">                Last_IO_Error: error reconnecting to master &#x27;repler@172.16.120.10:3358&#x27; - retry-time: 1  retries: 1</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120103358</span><br><span class="line">                  Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: 201010 12:21:59</span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21111</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21111,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">22</span>:<span class="number">03</span> [dbms_monitor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">|  4 | 2020-10-10 11:59:15 |</span><br><span class="line">|  5 | 2020-10-10 12:04:35 |</span><br><span class="line">|  6 | 2020-10-10 12:05:30 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:32 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:24 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-3"><a href="#结论-会failover且成功-3" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 12:22:43 2020 - [warning] Got error on MySQL <span class="keyword">insert</span> ping: <span class="number">2006</span> (MySQL <span class="keyword">server</span> has gone away)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">43</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">43</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">43</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">46</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:46 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:48 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:49 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">RTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000015:110146</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21216</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000015:85472</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21111</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000007</span>:<span class="number">3342407</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.12&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 12:22:54 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3342407, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21216,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 12:22:54 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 12:22:54 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span><br><span class="line">RTNETLINK answers: File exists</span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 82756. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010122253.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-21216</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>). Executed <span class="number">2</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题4-部分slave-sql-thread-stop"><a href="#用例测试-master挂了-且slave也有问题4-部分slave-sql-thread-stop" class="headerlink" title="[用例测试] master挂了, 且slave也有问题4(部分slave sql_thread stop)"></a>[用例测试] master挂了, 且slave也有问题4(部分slave sql_thread stop)</h2><blockquote>
<p>master挂了, 在此之前slave-1 sql_thread stop了</p>
</blockquote>
<h3 id="ping-type-CONNECT-10"><a href="#ping-type-CONNECT-10" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 关闭slave-1 sql_thread<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:43:34 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>关闭slave-1 sql_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:44:26 [dbms_monitor]&gt; stop slave sql_thread;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:50:00 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">50</span>:<span class="number">04</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000013</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">367</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000013</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: <span class="keyword">No</span></span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><br>关闭sql_thread后 manager仍然正常</p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:40:00 [dbms_monitor]&gt; insert into monitor_delay values(3,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:51:01 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><br>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:50:04 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><br>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:36:17 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-4"><a href="#结论-会failover且成功-4" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:51:18 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:51:18 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">18</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">18</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">18</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:21 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">24</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">27</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Starting SQL thread on 172.16.120.11(172.16.120.11:3358) ..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">RTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000013:486</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20746</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000013:486</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20746</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Replicating from the latest slave 172.16.120.12(172.16.120.12:3358) and waiting to apply..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Waiting all logs to be applied on the latest slave.. </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Waiting to execute all relay logs on 172.16.120.11(172.16.120.11:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  master_pos_wait(mysql-bin.000007:3232449) completed on 172.16.120.11(172.16.120.11:3358). Executed 1 events.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000010</span>:<span class="number">141523</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 11:51:29 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000010, 141523, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20746,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 11:51:29 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 11:51:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 79937. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201010115128.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-20746</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<p>slave-1成了new master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:51:06 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">54</span>:<span class="number">53</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="ping-type-INSERT-10"><a href="#ping-type-INSERT-10" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager后, 关闭slave-1 sql_thread<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:06:09 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>关闭slave-1 sql_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:10:20 [dbms_monitor]&gt; stop slave sql_thread;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:22:34 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">14</span>:<span class="number">22</span>:<span class="number">57</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000016</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">238476</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000004</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">211835</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000016</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: <span class="keyword">No</span></span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">211756</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">14</span>:<span class="number">22</span>:<span class="number">57</span> [dbms_monitor]&gt; pager</span><br><span class="line"><span class="keyword">Default</span> pager wasn<span class="string">&#x27;t set, using stdout.</span></span><br></pre></td></tr></table></figure><br>master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:22:09 [dbms_monitor]&gt; insert into monitor_delay values(90, now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:22:29 [dbms_monitor]&gt;  select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">| 90 | 2020-10-10 14:22:29 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><br>slave-1<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:22:57 [dbms<span class="emphasis">_monitor]&gt; select * from monitor_</span>delay;</span><br><span class="line"><span class="code">+----+</span>---------------------+</span><br><span class="line">| id | ctime               |</span><br><span class="line"><span class="code">+----+</span>---------------------+</span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line"><span class="code">+----+</span>---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><br>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:22:36 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">| 90 | 2020-10-10 14:22:29 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭sql_thread后 manager仍然正常</p>
<p>关闭master<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">root@</span>localhost <span class="number">14</span>:<span class="number">23</span>:<span class="number">38</span> [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-5"><a href="#结论-会failover且成功-5" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:25:05 2020 - [warning] Got error on MySQL <span class="keyword">insert</span> ping: <span class="number">2006</span> (MySQL <span class="keyword">server</span> has gone away)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">06</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">06</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">08</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:08 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:11 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Starting SQL thread on 172.16.120.11(172.16.120.11:3358) ..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">RTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000016:268346</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:21217-22354</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000016:268346</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:21217-22354</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Replicating from the latest slave 172.16.120.12(172.16.120.12:3358) and waiting to apply..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Waiting all logs to be applied on the latest slave.. </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Waiting to execute all relay logs on 172.16.120.11(172.16.120.11:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  master_pos_wait(mysql-bin.000007:3608644) completed on 172.16.120.11(172.16.120.11:3358). Executed 1 events.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">17</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000010</span>:<span class="number">517718</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">17</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 14:25:17 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000010, 517718, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22354,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 14:25:17 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 14:25:17 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 89417. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201010142515.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-22354</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<p>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@localhost 14:23:56 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">| 90 | 2020-10-10 14:22:29 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="用例测试-master挂了-且slave也有问题5-部分slave-sql-thread-error"><a href="#用例测试-master挂了-且slave也有问题5-部分slave-sql-thread-error" class="headerlink" title="[用例测试] master挂了, 且slave也有问题5(部分slave sql_thread error)"></a>[用例测试] master挂了, 且slave也有问题5(部分slave sql_thread error)</h2><blockquote>
<p>master挂了, 在此之前slave-1 sql_thread error了</p>
</blockquote>
<h3 id="ping-type-CONNECT-11"><a href="#ping-type-CONNECT-11" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:34:42 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>制造slave-1 sql_thread error</p>
<ol>
<li>在master创建表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:35:55 [dbms_monitor]&gt; create table make_error(id int not null auto_increment primary key);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure></li>
<li>在slave-1删除make_error表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:38:10 [dbms_monitor]&gt; set global super_read_only=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:38:14 [dbms_monitor]&gt; set sql_log_bin=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:38:17 [dbms_monitor]&gt; drop table make_error;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:38:20 [dbms_monitor]&gt; set sql_log_bin=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></li>
<li>在master删除make_error表(slave-1 sql_thread会报错)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:36:28 [dbms_monitor]&gt; drop table make_error;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure></li>
<li>查看slave-1复制状态<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:38:26 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.10</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000017</span><br><span class="line">          Read_Master_Log_Pos: 620</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 589</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000017</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 1051</span><br><span class="line">                   Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 416</span><br><span class="line">              Relay_Log_Space: 1000</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 1051</span><br><span class="line">               Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120103358</span><br><span class="line">                  Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: 201010 14:39:25</span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:22355-22356</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22355,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
此时manager仍然正常运行</li>
</ol>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:39:25 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会触发failover-但failover失败-2"><a href="#结论-会触发failover-但failover失败-2" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:40:59 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 14:40:59 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">40</span>:<span class="number">59</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">40</span>:<span class="number">59</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">40</span>:<span class="number">59</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:02 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">08</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [error][/usr/local/share/perl5/MHA/Server.pm, ln935] SQL Thread is stopped(error) on 172.16.120.11(172.16.120.11:3358)! Errno:1051, Error:Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;</span><span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">22356</span><span class="string">&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln703] Server 172.16.120.11(172.16.120.11:3358) is alive, but does not work as a slave!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [warning] Got Error:  at /usr/local/share/perl5/MHA/MasterMonitor.pm line 560.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [info] Got exit code 1 (Not master dead).</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-11"><a href="#ping-type-INSERT-11" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 15:54:20 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>准备工作省略, slave-1 sql_thread报错<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:55:13 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.10</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000019</span><br><span class="line">          Read_Master_Log_Pos: 16331</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000007</span><br><span class="line">                Relay_Log_Pos: 14926</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000019</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 1051</span><br><span class="line">                   Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 14713</span><br><span class="line">              Relay_Log_Space: 19342</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 1051</span><br><span class="line">               Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120103358</span><br><span class="line">                  Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: 201010 15:55:16</span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:22356-22425</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22418,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:55:16 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会触发failover-但failover失败-3"><a href="#结论-会触发failover-但failover失败-3" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 15:56:03 2020 - [warning] Got error on MySQL <span class="keyword">insert</span> ping: <span class="number">2006</span> (MySQL <span class="keyword">server</span> has gone away)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">04</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">04</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:06 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [error][/usr/local/share/perl5/MHA/Server.pm, ln935] SQL Thread is stopped(error) on 172.16.120.11(172.16.120.11:3358)! Errno:1051, Error:Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;</span><span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">22419</span><span class="string">&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln703] Server 172.16.120.11(172.16.120.11:3358) is alive, but does not work as a slave!</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [warning] Got Error:  at /usr/local/share/perl5/MHA/MasterMonitor.pm line 560.</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [info] Got exit code 1 (Not master dead).</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>


<script src="/js/vdonate.js"></script>

<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: '打赏支持', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG65.jpeg',
  alipayImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG64.jpeg'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>大范</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2021/02/07/2021-02-07-MHA-Failover测试/" target="_blank" title="MHA Failover测试">http://fuxkdb.com/2021/02/07/2021-02-07-MHA-Failover测试/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MHA/" rel="tag">MHA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/02/12/2021-02-12-DorisDB-vs-ClickHouse-SSB%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          DorisDB vs ClickHouse SSB对比测试
        
      </div>
    </a>
  
  
    <a href="/2020/12/31/2020-12-31-%E4%BD%BF%E7%94%A8Canal-+-ClickHouse%E5%AE%9E%E6%97%B6%E5%88%86%E6%9E%90MySQL%E4%BA%8B%E5%8A%A1%E4%BF%A1%E6%81%AF/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">使用Canal + ClickHouse实时分析MySQL事务信息</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TL-DR"><span class="nav-number">1.</span> <span class="nav-text">TL;DR</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-number">2.</span> <span class="nav-text">环境信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-too-many-connection"><span class="nav-number">2.1.</span> <span class="nav-text">[用例测试] master too many connection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT"><span class="nav-number">2.1.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover"><span class="nav-number">2.1.2.</span> <span class="nav-text">结论: 不会failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT"><span class="nav-number">2.1.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-1"><span class="nav-number">2.1.4.</span> <span class="nav-text">结论: 不会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-hang"><span class="nav-number">2.2.</span> <span class="nav-text">[用例测试] master hang</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-mha-manager%E5%8F%AF%E8%83%BD%E6%8A%A5%E9%94%99%E9%80%80%E5%87%BA"><span class="nav-number">2.2.2.</span> <span class="nav-text">结论: 不会failover, mha manager可能报错退出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-1"><span class="nav-number">2.2.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover"><span class="nav-number">2.2.4.</span> <span class="nav-text">结论: 会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A5%E4%B8%8B%E6%83%85%E5%86%B5%E9%83%BD%E4%B8%8D%E4%BC%9Afailover-%E5%8D%B3%E4%BE%BF%E6%98%AF%E6%89%8B%E5%8A%A8failover%E6%8C%87%E5%AE%9A%E4%BA%86-%E2%80%93master-state-dead-%E4%B9%9F%E4%B8%8D%E8%A1%8C"><span class="nav-number">2.3.</span> <span class="nav-text">以下情况都不会failover, 即便是手动failover指定了 –master_state&#x3D;dead 也不行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-%E4%B8%8E-mha-manager%E9%97%B4%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B81"><span class="nav-number">2.4.</span> <span class="nav-text">[用例测试] master 与 mha manager间网络异常1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-2"><span class="nav-number">2.4.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-2"><span class="nav-number">2.4.2.</span> <span class="nav-text">结论: 不会failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-2"><span class="nav-number">2.4.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-3"><span class="nav-number">2.4.4.</span> <span class="nav-text">结论: 不会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-%E4%B8%8E-mha-manager%E9%97%B4%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B82"><span class="nav-number">2.5.</span> <span class="nav-text">[用例测试] master 与 mha manager间网络异常2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-3"><span class="nav-number">2.5.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-4"><span class="nav-number">2.5.2.</span> <span class="nav-text">结论: 不会failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-3"><span class="nav-number">2.5.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-5"><span class="nav-number">2.5.4.</span> <span class="nav-text">结论: 不会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-%E4%B8%8E-mha-manager%E9%97%B4%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B83"><span class="nav-number">2.6.</span> <span class="nav-text">[用例测试] master 与 mha manager间网络异常3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-4"><span class="nav-number">2.6.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-6"><span class="nav-number">2.6.2.</span> <span class="nav-text">结论: 不会failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-4"><span class="nav-number">2.6.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-7"><span class="nav-number">2.6.4.</span> <span class="nav-text">结论: 不会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-%E4%B8%8E-mha-manager%E9%97%B4%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B84"><span class="nav-number">2.7.</span> <span class="nav-text">[用例测试] master 与 mha manager间网络异常4</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-5"><span class="nav-number">2.7.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-8"><span class="nav-number">2.7.2.</span> <span class="nav-text">结论: 不会failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-5"><span class="nav-number">2.7.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%B8%8D%E4%BC%9Afailover-9"><span class="nav-number">2.7.4.</span> <span class="nav-text">结论: 不会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master-%E4%B8%8E-mha-manager%E9%97%B4%E7%BD%91%E7%BB%9C%E5%BC%82%E5%B8%B85"><span class="nav-number">2.8.</span> <span class="nav-text">[用例测试] master 与 mha manager间网络异常5</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-6"><span class="nav-number">2.8.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover-1"><span class="nav-number">2.8.2.</span> <span class="nav-text">结论: 会failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-6"><span class="nav-number">2.8.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E9%95%BF%E8%BF%9E%E6%8E%A5%E6%96%AD%E5%BC%80%E5%90%8E%E6%89%8D%E4%BC%9Afailover-%E5%90%A6%E5%88%99%E4%B8%8D%E4%BC%9Afailover"><span class="nav-number">2.8.4.</span> <span class="nav-text">结论: 长连接断开后才会failover, 否则不会failover</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master%E6%8C%82%E4%BA%86-%E4%B8%94slave%E4%B9%9F%E6%9C%89%E9%97%AE%E9%A2%981-%E9%83%A8%E5%88%86slave%E5%AE%95%E6%9C%BA"><span class="nav-number">2.9.</span> <span class="nav-text">[用例测试] master挂了, 且slave也有问题1(部分slave宕机)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-7"><span class="nav-number">2.9.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9A%E8%A7%A6%E5%8F%91failover-%E4%BD%86failover%E5%A4%B1%E8%B4%A5"><span class="nav-number">2.9.2.</span> <span class="nav-text">结论: 会触发failover, 但failover失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-7"><span class="nav-number">2.9.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9A%E8%A7%A6%E5%8F%91failover-%E4%BD%86failover%E5%A4%B1%E8%B4%A5-1"><span class="nav-number">2.9.4.</span> <span class="nav-text">结论: 会触发failover, 但failover失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-%E5%A6%82%E4%B8%8D%E5%B8%8C%E6%9C%9Bslave-1%E5%AE%95%E6%9C%BA%E5%BD%B1%E5%93%8Dfailover-%E9%9C%80%E8%A6%81%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AF%B9slave-1%E8%AE%BE%E7%BD%AEignore-fail-1"><span class="nav-number">2.9.5.</span> <span class="nav-text">总结: 如不希望slave-1宕机影响failover, 需要在配置文件中对slave-1设置ignore_fail&#x3D;1</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master%E6%8C%82%E4%BA%86-%E4%B8%94slave%E4%B9%9F%E6%9C%89%E9%97%AE%E9%A2%982-%E9%83%A8%E5%88%86slave-io-thread-stop"><span class="nav-number">2.10.</span> <span class="nav-text">[用例测试] master挂了, 且slave也有问题2(部分slave io_thread stop)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-8"><span class="nav-number">2.10.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover%E4%B8%94%E6%88%90%E5%8A%9F"><span class="nav-number">2.10.2.</span> <span class="nav-text">结论: 会failover且成功</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-8"><span class="nav-number">2.10.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover%E4%B8%94%E6%88%90%E5%8A%9F-1"><span class="nav-number">2.10.4.</span> <span class="nav-text">结论: 会failover且成功</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master%E6%8C%82%E4%BA%86-%E4%B8%94slave%E4%B9%9F%E6%9C%89%E9%97%AE%E9%A2%983-%E9%83%A8%E5%88%86slave-io-thread-error"><span class="nav-number">2.11.</span> <span class="nav-text">[用例测试] master挂了, 且slave也有问题3(部分slave io_thread error)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-9"><span class="nav-number">2.11.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover%E4%B8%94%E6%88%90%E5%8A%9F-2"><span class="nav-number">2.11.2.</span> <span class="nav-text">结论: 会failover且成功</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-9"><span class="nav-number">2.11.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover%E4%B8%94%E6%88%90%E5%8A%9F-3"><span class="nav-number">2.11.4.</span> <span class="nav-text">结论: 会failover且成功</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master%E6%8C%82%E4%BA%86-%E4%B8%94slave%E4%B9%9F%E6%9C%89%E9%97%AE%E9%A2%984-%E9%83%A8%E5%88%86slave-sql-thread-stop"><span class="nav-number">2.12.</span> <span class="nav-text">[用例测试] master挂了, 且slave也有问题4(部分slave sql_thread stop)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-10"><span class="nav-number">2.12.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover%E4%B8%94%E6%88%90%E5%8A%9F-4"><span class="nav-number">2.12.2.</span> <span class="nav-text">结论: 会failover且成功</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-10"><span class="nav-number">2.12.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9Afailover%E4%B8%94%E6%88%90%E5%8A%9F-5"><span class="nav-number">2.12.4.</span> <span class="nav-text">结论: 会failover且成功</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E4%BE%8B%E6%B5%8B%E8%AF%95-master%E6%8C%82%E4%BA%86-%E4%B8%94slave%E4%B9%9F%E6%9C%89%E9%97%AE%E9%A2%985-%E9%83%A8%E5%88%86slave-sql-thread-error"><span class="nav-number">2.13.</span> <span class="nav-text">[用例测试] master挂了, 且slave也有问题5(部分slave sql_thread error)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-CONNECT-11"><span class="nav-number">2.13.1.</span> <span class="nav-text">ping_type&#x3D;CONNECT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9A%E8%A7%A6%E5%8F%91failover-%E4%BD%86failover%E5%A4%B1%E8%B4%A5-2"><span class="nav-number">2.13.2.</span> <span class="nav-text">结论: 会触发failover, 但failover失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ping-type-INSERT-11"><span class="nav-number">2.13.3.</span> <span class="nav-text">ping_type&#x3D;INSERT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA-%E4%BC%9A%E8%A7%A6%E5%8F%91failover-%E4%BD%86failover%E5%A4%B1%E8%B4%A5-3"><span class="nav-number">2.13.4.</span> <span class="nav-text">结论: 会触发failover, 但failover失败</span></a></li></ol></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2022 Fan() All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Fan()
          </div>
          <div class="panel-body">
            Copyright © 2022 大范 All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>