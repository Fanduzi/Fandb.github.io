<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Fan()</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://fuxkdb.com/"/>
  <updated>2021-02-18T05:10:58.351Z</updated>
  <id>http://fuxkdb.com/</id>
  
  <author>
    <name>大范</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>skeema简单使用</title>
    <link href="http://fuxkdb.com/2021/02/18/2021-02-18-skeema%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://fuxkdb.com/2021/02/18/2021-02-18-skeema简单使用/</id>
    <published>2021-02-18T05:08:00.000Z</published>
    <updated>2021-02-18T05:10:58.351Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Skeema is a tool for managing MySQL tables and schema changes in a declarative fashion using pure SQL. It provides a CLI tool allowing you to:</p>
<ul>
<li>Export CREATE TABLE statements to the filesystem, for tracking in a repo (git, hg, svn, etc)</li>
<li>Diff changes in the schema repo against live DBs to automatically generate DDL</li>
<li>Manage multiple environments (e.g. dev, staging, prod) and keep them in sync with ease</li>
<li>Configure use of online schema change tools, such as pt-online-schema-change, for performing ALTERs</li>
<li>Convert non-online migrations from frameworks like Rails or Django into online schema changes in production</li>
</ul>
<p>Skeema supports a pull-request-based workflow for schema change submission, review, and execution. This permits your team to manage schema changes in exactly the same way as you manage code changes. Our new companion <a href="https://www.skeema.io/cloud/">Cloud Linter for GitHub repos</a> provides automatic linting of schema change commits and pull requests.</p>
<p>我这的需求是同步生产环境表结构到演练环境, 以下是针对我这个场景的具体使用方法</p>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>skeema需要的用户权限具体见<a href="https://www.skeema.io/docs/requirements/">https://www.skeema.io/docs/requirements/</a></p>
<p>这里说一下重点, <code>skeema diff</code>时会在目标环境创建一个<code>_skeema_tmp</code>临时数据库, 然后会删除这个库</p>
<a id="more"></a>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装go环境</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="regexp">//</span>dl.google.com<span class="regexp">/go/g</span>o1.<span class="number">16</span>.linux-amd64.tar.gz</span><br><span class="line">tar -C <span class="regexp">/usr/</span>local -xzf go1.<span class="number">16</span>.linux-amd64.tar.gz                 </span><br><span class="line">export PATH=<span class="variable">$PATH</span>:<span class="regexp">/usr/</span>local<span class="regexp">/go/</span>bin</span><br></pre></td></tr></table></figure>
<p>安装skeema</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https:<span class="regexp">//gi</span>thub.com<span class="regexp">/skeema/</span>skeema<span class="regexp">/releases/</span>latest<span class="regexp">/download/</span>skeema_amd64.rpm</span><br><span class="line">rpm -ivh skeema</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p>在演练环境</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skeema init -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -P <span class="number">3358</span> -u fanboshi -p -d <span class="number">3358</span> --schema sss</span><br></pre></td></tr></table></figure>
<blockquote>
<p>-d dump的sql文件存储路径</p>
<p>–schema 只导出sss这个数据库的结构信息</p>
</blockquote>
<p>随后3358目录下回包含一些.sql文件和一个<code>.skeema</code>文件</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">213</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">37</span> .skeema</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root <span class="number">1521</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_instances.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">305</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_vip.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root <span class="number">1122</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_host_host.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">388</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_cluster_domain_name_config.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">369</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_cluster_portrayal_mapping.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">602</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_cluster.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root <span class="number">1148</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_cluster_users.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">304</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_instance_ports.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">756</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_instances_port.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">244</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_productlines.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">595</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_services.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">274</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_dbms_environment.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">815</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_dbms_sql_config.sql</span><br><span class="line">-rw-r--r--   <span class="number">1</span> root root  <span class="number">625</span> Feb <span class="number">18</span> <span class="number">12</span>:<span class="number">33</span> sss_cmdb_environments.sql</span><br></pre></td></tr></table></figure>
<p>编辑.skeema文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat .skeema </span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"><span class="attr">default-collation</span>=utf8_general_ci</span><br><span class="line"><span class="attr">schema</span>=sss</span><br><span class="line"></span><br><span class="line"><span class="section">[production]</span></span><br><span class="line"><span class="attr">flavor</span>=percona:<span class="number">5.7</span></span><br><span class="line"><span class="attr">host</span>=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">user</span>=fanboshi</span><br></pre></td></tr></table></figure>
<p>我们这里修改<code>[production]</code>为<code>[drill]</code>, 并增加一些参数</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alter-wrapper</span>=<span class="string">&quot;gh-ost --allow-on-master --assume-rbr  --initially-drop-ghost-table --initially-drop-old-table -exact-rowcount --approve-renamed-columns --concurrent-rowcount=false --chunk-size=800 --hooks-path=/tmp/hook --user=&#123;USER&#125; --ask-pass --host=&#123;HOST&#125; --port=&#123;PORT&#125; --database=&#123;SCHEMA&#125; --table=&#123;TABLE&#125; --alter=&#123;CLAUSES&#125; --execute&quot;</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"><span class="attr">default-collation</span>=utf8_general_ci</span><br><span class="line"><span class="attr">schema</span>=sss</span><br><span class="line"></span><br><span class="line"><span class="section">[drill]</span></span><br><span class="line"><span class="attr">flavor</span>=percona:<span class="number">5.7</span></span><br><span class="line"><span class="attr">host</span>=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">user</span>=fanboshi</span><br><span class="line"><span class="attr">password</span>=superpass <span class="comment">#可加可不加, 如果没有定义password, 则需要在命令行增加-p参数</span></span><br></pre></td></tr></table></figure>
<p>添加生产环境</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skeema<span class="built_in"> add-environment </span>product -h 172.16.120.11 -P 3358 -u fanboshi </span><br></pre></td></tr></table></figure>
<p>或者直接在<code>.skeema</code>添加如下信息</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[product]</span></span><br><span class="line"><span class="attr">flavor</span>=percona:<span class="number">5.7</span></span><br><span class="line"><span class="attr">host</span>=<span class="number">172.16</span>.<span class="number">120.11</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">user</span>=fanboshi</span><br></pre></td></tr></table></figure>
<p>最终的<code>.skeema</code>文件如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alter-wrapper</span>=<span class="string">&quot;gh-ost --allow-on-master --assume-rbr  --initially-drop-ghost-table --initially-drop-old-table -exact-rowcount --approve-renamed-columns --concurrent-rowcount=false --chunk-size=800 --hooks-path=/tmp/hook --user=&#123;USER&#125; --ask-pass --host=&#123;HOST&#125; --port=&#123;PORT&#125; --database=&#123;SCHEMA&#125; --table=&#123;TABLE&#125; --alter=&#123;CLAUSES&#125; --execute&quot;</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"><span class="attr">default-collation</span>=utf8_general_ci</span><br><span class="line"><span class="attr">schema</span>=sss</span><br><span class="line"></span><br><span class="line"><span class="section">[drill]</span></span><br><span class="line"><span class="attr">flavor</span>=percona:<span class="number">5.7</span></span><br><span class="line"><span class="attr">host</span>=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">user</span>=fanboshi</span><br><span class="line"><span class="comment">#password=superpass #可加可不加, 如果没有定义password, 则需要在命令行增加-p参数</span></span><br><span class="line"></span><br><span class="line"><span class="section">[product]</span></span><br><span class="line"><span class="attr">flavor</span>=percona:<span class="number">5.7</span></span><br><span class="line"><span class="attr">host</span>=<span class="number">172.16</span>.<span class="number">120.11</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">user</span>=fanboshi</span><br></pre></td></tr></table></figure>
<h3 id="拉取生产环境表结构"><a href="#拉取生产环境表结构" class="headerlink" title="拉取生产环境表结构"></a>拉取生产环境表结构</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cd</span> <span class="string">3358</span></span><br><span class="line"><span class="attr">skeema</span> <span class="string">pull product -p</span></span><br></pre></td></tr></table></figure>
<h3 id="生成drill环境与生产环境的差异sql文件"><a href="#生成drill环境与生产环境的差异sql文件" class="headerlink" title="生成drill环境与生产环境的差异sql文件"></a>生成drill环境与生产环境的差异sql文件</h3><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skeema diff drill --allow-unsafe -psuperpass &gt; <span class="regexp">/tmp/</span>diff.sql </span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果没有在<code>.skeema</code>文件中指定password参数, 则要在命令行指定-p参数并填写密码</p>
</blockquote>
<p>查看生产的文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- instance: 127.0.0.1:3358</span></span><br><span class="line"><span class="keyword">USE</span> <span class="string">`sss`</span>;</span><br><span class="line">\! gh-ost <span class="comment">--allow-on-master --assume-rbr  --initially-drop-ghost-table --initially-drop-old-table -exact-rowcount --approve-renamed-columns --concurrent-rowcount=false --chunk-size=800 --hooks-path=/tmp/hook --user=fanboshi --ask-pass --host=127.0.0.1 --port=3358 --database=sss --table=sss_cmdb_service_name --alter=&#x27;DROP COLUMN `environment_name`, DROP COLUMN `productline_name`, DROP COLUMN `cmdb_cluster_name`&#x27; --execute</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`sss_domain_manage`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">...</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`domain_name`</span> (<span class="string">`domain_name`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`sss_iam_role_members`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`sss_iam_role_members_role_id_profile_id_93c492ff_uniq`</span> (<span class="string">`role_id`</span>,<span class="string">`profile_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`ytree_iam_role_members_profile_id_ce949eff_fk_users_profile_uid`</span> (<span class="string">`profile_id`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`sss_iam_role_members_profile_id_ce949eff_fk_users_profile_uid`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`profile_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`sss_users_profile`</span> (<span class="string">`uid`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`sss_iam_role_members_role_id_8a1e407b_fk_ytree_iam_role_id`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`role_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`sss_iam_role`</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
<p>可以看到这就是一个<code>.sql</code>文件, 注意生成的gh-ost语句前有一个<code>\!</code>, 大家应该明白是啥意思吧</p>
<blockquote>
<p>如果是想手动执行gh-ost命令, 记得吧”`”转义掉</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Skeema is a tool for managing MySQL tables and schema changes in a declarative fashion using pure SQL. It provides a CLI tool allowing you to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Export CREATE TABLE statements to the filesystem, for tracking in a repo (git, hg, svn, etc)&lt;/li&gt;
&lt;li&gt;Diff changes in the schema repo against live DBs to automatically generate DDL&lt;/li&gt;
&lt;li&gt;Manage multiple environments (e.g. dev, staging, prod) and keep them in sync with ease&lt;/li&gt;
&lt;li&gt;Configure use of online schema change tools, such as pt-online-schema-change, for performing ALTERs&lt;/li&gt;
&lt;li&gt;Convert non-online migrations from frameworks like Rails or Django into online schema changes in production&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Skeema supports a pull-request-based workflow for schema change submission, review, and execution. This permits your team to manage schema changes in exactly the same way as you manage code changes. Our new companion &lt;a href=&quot;https://www.skeema.io/cloud/&quot;&gt;Cloud Linter for GitHub repos&lt;/a&gt; provides automatic linting of schema change commits and pull requests.&lt;/p&gt;
&lt;p&gt;我这的需求是同步生产环境表结构到演练环境, 以下是针对我这个场景的具体使用方法&lt;/p&gt;
&lt;h2 id=&quot;权限&quot;&gt;&lt;a href=&quot;#权限&quot; class=&quot;headerlink&quot; title=&quot;权限&quot;&gt;&lt;/a&gt;权限&lt;/h2&gt;&lt;p&gt;skeema需要的用户权限具体见&lt;a href=&quot;https://www.skeema.io/docs/requirements/&quot;&gt;https://www.skeema.io/docs/requirements/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这里说一下重点, &lt;code&gt;skeema diff&lt;/code&gt;时会在目标环境创建一个&lt;code&gt;_skeema_tmp&lt;/code&gt;临时数据库, 然后会删除这个库&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>DorisDB vs ClickHouse SSB对比测试</title>
    <link href="http://fuxkdb.com/2021/02/12/2021-02-12-DorisDB-vs-ClickHouse-SSB%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/"/>
    <id>http://fuxkdb.com/2021/02/12/2021-02-12-DorisDB-vs-ClickHouse-SSB对比测试/</id>
    <published>2021-02-12T09:24:00.000Z</published>
    <updated>2021-02-12T09:25:10.704Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DorisDB-vs-ClickHouse-SSB对比测试"><a href="#DorisDB-vs-ClickHouse-SSB对比测试" class="headerlink" title="DorisDB vs ClickHouse SSB对比测试"></a>DorisDB vs ClickHouse SSB对比测试</h1><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ol>
<li>进行本次测试时对DorisDB了解甚微</li>
<li>本次测试由于服务器资源有限, 没有严格遵循单一变量原则进行测试</li>
<li>本次测试有一定参考意义</li>
</ol>
<h3 id="数据导入速度"><a href="#数据导入速度" class="headerlink" title="数据导入速度"></a>数据导入速度</h3><ul>
<li>ClickHouse: 3500s</li>
<li>DorisDB: 5160s</li>
</ul>
<h3 id="数据压缩情况-通过磁盘占用空间比较"><a href="#数据压缩情况-通过磁盘占用空间比较" class="headerlink" title="数据压缩情况(通过磁盘占用空间比较)"></a>数据压缩情况(通过磁盘占用空间比较)</h3><ul>
<li>ClickHouse: 85.2G</li>
<li>DorisDB: 132G</li>
</ul>
<h3 id="查询速度"><a href="#查询速度" class="headerlink" title="查询速度"></a>查询速度</h3><h4 id="单表查询"><a href="#单表查询" class="headerlink" title="单表查询"></a>单表查询</h4><p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/ClickHouse%20vs%20DorisDB/%E5%8D%95%E8%A1%A8.png" alt="单表"></p>
<table>
<thead>
<tr>
<th></th>
<th><strong>DorisDB1</strong></th>
<th><strong>DorisDB2</strong></th>
<th><strong>ClickHouse1</strong></th>
<th><strong>ClickHouse2</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Q1.1</strong></td>
<td>350</td>
<td>290</td>
<td>226</td>
<td>195</td>
</tr>
<tr>
<td><strong>Q1.2</strong></td>
<td>270</td>
<td>190</td>
<td>34</td>
<td>63</td>
</tr>
<tr>
<td><strong>Q1.3</strong></td>
<td>310</td>
<td>240</td>
<td>43</td>
<td>22</td>
</tr>
<tr>
<td><strong>Q2.1</strong></td>
<td>410</td>
<td>370</td>
<td>1,723</td>
<td>1,791</td>
</tr>
<tr>
<td><strong>Q2.2</strong></td>
<td>780</td>
<td>720</td>
<td>1,463</td>
<td>1,470</td>
</tr>
<tr>
<td><strong>Q2.3</strong></td>
<td>340</td>
<td>280</td>
<td>659</td>
<td>1,337</td>
</tr>
<tr>
<td><strong>Q3.1</strong></td>
<td>1,560</td>
<td>860</td>
<td>3,488</td>
<td>1,254</td>
</tr>
<tr>
<td><strong>Q3.2</strong></td>
<td>1,080</td>
<td>790</td>
<td>1,272</td>
<td>966</td>
</tr>
<tr>
<td><strong>Q3.3</strong></td>
<td>250</td>
<td>290</td>
<td>979</td>
<td>889</td>
</tr>
<tr>
<td><strong>Q3.4</strong></td>
<td>230</td>
<td>260</td>
<td>36</td>
<td>20</td>
</tr>
<tr>
<td><strong>Q4.1</strong></td>
<td>870</td>
<td>720</td>
<td>5,067</td>
<td>2,791</td>
</tr>
<tr>
<td><strong>Q4.2</strong></td>
<td>720</td>
<td>490</td>
<td>804</td>
<td>752</td>
</tr>
<tr>
<td><strong>Q4.3</strong></td>
<td>510</td>
<td>380</td>
<td>561</td>
<td>482</td>
</tr>
</tbody>
</table>
<h4 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h4><p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/ClickHouse%20vs%20DorisDB/%E5%A4%9A%E8%A1%A8.png" alt="多表"></p>
<table>
<thead>
<tr>
<th></th>
<th><strong>DorisDB1</strong></th>
<th><strong>DorisDB2</strong></th>
<th><strong>ClickHouse1</strong></th>
<th><strong>ClickHouse2</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Q1.1</strong></td>
<td>450</td>
<td>490</td>
<td>1,496</td>
<td>1,424</td>
</tr>
<tr>
<td><strong>Q1.2</strong></td>
<td>410</td>
<td>450</td>
<td>1,366</td>
<td>659</td>
</tr>
<tr>
<td><strong>Q1.3</strong></td>
<td>510</td>
<td>340</td>
<td>678</td>
<td>1,377</td>
</tr>
<tr>
<td><strong>Q2.1</strong></td>
<td>1,560</td>
<td>1,600</td>
<td>4,360</td>
<td>2,667</td>
</tr>
<tr>
<td><strong>Q2.2</strong></td>
<td>1,690</td>
<td>1,060</td>
<td>4,498</td>
<td>1,554</td>
</tr>
<tr>
<td><strong>Q2.3</strong></td>
<td>780</td>
<td>1,150</td>
<td>2,569</td>
<td>2,577</td>
</tr>
<tr>
<td><strong>Q3.1</strong></td>
<td>3,480</td>
<td>3,700</td>
<td>10,190</td>
<td>12,960</td>
</tr>
<tr>
<td><strong>Q3.2</strong></td>
<td>1,320</td>
<td>1,850</td>
<td>5,926</td>
<td>5,743</td>
</tr>
<tr>
<td><strong>Q3.3</strong></td>
<td>1,030</td>
<td>1,040</td>
<td>3,445</td>
<td>3,300</td>
</tr>
<tr>
<td><strong>Q3.4</strong></td>
<td>1,330</td>
<td>1,170</td>
<td>3,455</td>
<td>3,330</td>
</tr>
<tr>
<td><strong>Q4.1</strong></td>
<td>3,480</td>
<td>3,750</td>
<td>15,560</td>
<td>9,494</td>
</tr>
<tr>
<td><strong>Q4.2</strong></td>
<td>2,830</td>
<td>3,170</td>
<td>16,109</td>
<td>18,048</td>
</tr>
<tr>
<td><strong>Q4.3</strong></td>
<td>1,560</td>
<td>2,140</td>
<td>15,685</td>
<td>14,838</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><p>ClickHouse: 3台 华为云ECS 高性能计算型 | h3.xlarge.2 | 4vCPUs | 8GB | 超高IO SSD</p>
<p>DorisDB: 3台  华为云ECS 高性能计算型 | h3.2xlarge.4 | 8vCPUs | 32GB | 超高IO SSD</p>
<blockquote>
<p>由于资源紧张, DorisDB所在服务器上还部署了rc mysql, 但过年期间无人使用, 实际可用内存16G.</p>
</blockquote>
<p>DorisDB: DorisDB-SE-1.12.1 3Fe 3Be, fe和be部署在一起</p>
<p>ClickHouse: 20.10.3.30, 三分片两副本混合部署, 部署方法详见<a href="https://blog.csdn.net/ashic/article/details/105901792">ClickHouse集群多实例部署</a><br><img src="https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/images/clickhouse/multi_instance_deploy/image-20200502202000580.png" alt="img"></p>
<blockquote>
<p>注意</p>
<p>实际数据导入后DorsiDB和ClickHouse除lineorder_flat外数据无任何差异</p>
<p>lineorder_flat:</p>
<ul>
<li>DorsiDB: 546669614</li>
<li>ClickHouse: 622259902</li>
</ul>
</blockquote>
<h2 id="DorisDB"><a href="#DorisDB" class="headerlink" title="DorisDB"></a>DorisDB</h2><p>部署略</p>
<h3 id="构建数据"><a href="#构建数据" class="headerlink" title="构建数据"></a>构建数据</h3><p>首先下载ssb-poc工具包并编译</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://dorisdb-public.oss-<span class="keyword">cn</span>-zhangjiakou.aliyuncs.<span class="keyword">com</span>/ssb-poc-<span class="number">0.9</span>.zip</span><br><span class="line">unzip ssb-poc-<span class="number">0.9</span>.zip</span><br><span class="line"><span class="keyword">cd</span> ssb-poc</span><br><span class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install  </span><br></pre></td></tr></table></figure>
<p>所有相关工具安装到output目录。</p>
<p>进入output目录，生成数据</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> output</span><br><span class="line">bin/<span class="keyword">gen</span>-ssb.<span class="keyword">sh</span> 100 data_dir</span><br></pre></td></tr></table></figure>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><p>修改配置文件conf/doris.conf，指定脚本操作的Doris集群地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># for mysql cmd</span></span><br><span class="line"> <span class="attr">mysql_host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line"> <span class="attr">mysql_port:</span> <span class="number">9030</span></span><br><span class="line"> <span class="attr">mysql_user:</span> <span class="string">root</span></span><br><span class="line"> <span class="attr">mysql_password:</span></span><br><span class="line"> <span class="attr">doris_db:</span> <span class="string">ssb</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># cluster ports</span></span><br><span class="line">  <span class="attr">http_port:</span> <span class="number">8030</span></span><br><span class="line">  <span class="attr">be_heartbeat_port:</span> <span class="number">9050</span></span><br><span class="line">  <span class="attr">broker_port:</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"> <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>执行脚本建表</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bin</span>/create_db_table.sh ddl_<span class="number">100</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>我这里建表跑建表脚本报错了, 改为手动建表, 参考<a href="http://doc.dorisdb.com/2146807">http://doc.dorisdb.com/2146807</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`lineorder`</span> (</span><br><span class="line">  <span class="string">`lo_orderkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_linenumber`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_custkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_partkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_suppkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_orderdate`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_orderpriority`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_shippriority`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_quantity`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_extendedprice`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_ordtotalprice`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_discount`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_revenue`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_supplycost`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_tax`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_commitdate`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`lo_shipmode`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=OLAP</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(<span class="string">`lo_orderkey`</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&quot;OLAP&quot;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(<span class="string">`lo_orderkey`</span>) BUCKETS <span class="number">96</span></span><br><span class="line">PROPERTIES (</span><br><span class="line"><span class="string">&quot;replication_num&quot;</span> = <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;colocate_with&quot;</span> = <span class="string">&quot;group1&quot;</span>,</span><br><span class="line"><span class="string">&quot;in_memory&quot;</span> = <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage_format&quot;</span> = <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`customer`</span> (</span><br><span class="line">  <span class="string">`c_custkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_name`</span> <span class="built_in">varchar</span>(<span class="number">26</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_address`</span> <span class="built_in">varchar</span>(<span class="number">41</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_city`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_nation`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_region`</span> <span class="built_in">varchar</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_phone`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`c_mktsegment`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=OLAP</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(<span class="string">`c_custkey`</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&quot;OLAP&quot;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(<span class="string">`c_custkey`</span>) BUCKETS <span class="number">12</span></span><br><span class="line">PROPERTIES (</span><br><span class="line"><span class="string">&quot;replication_num&quot;</span> = <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;colocate_with&quot;</span> = <span class="string">&quot;groupa2&quot;</span>,</span><br><span class="line"><span class="string">&quot;in_memory&quot;</span> = <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage_format&quot;</span> = <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`dates`</span> (</span><br><span class="line">  <span class="string">`d_datekey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_date`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_dayofweek`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_month`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_year`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_yearmonthnum`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_yearmonth`</span> <span class="built_in">varchar</span>(<span class="number">9</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_daynuminweek`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_daynuminmonth`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_daynuminyear`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_monthnuminyear`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_weeknuminyear`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_sellingseason`</span> <span class="built_in">varchar</span>(<span class="number">14</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_lastdayinweekfl`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_lastdayinmonthfl`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_holidayfl`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`d_weekdayfl`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=OLAP</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(<span class="string">`d_datekey`</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&quot;OLAP&quot;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(<span class="string">`d_datekey`</span>) BUCKETS <span class="number">1</span></span><br><span class="line">PROPERTIES (</span><br><span class="line"><span class="string">&quot;replication_num&quot;</span> = <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;in_memory&quot;</span> = <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;colocate_with&quot;</span> = <span class="string">&quot;groupa3&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage_format&quot;</span> = <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`supplier`</span> (</span><br><span class="line">  <span class="string">`s_suppkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`s_name`</span> <span class="built_in">varchar</span>(<span class="number">26</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`s_address`</span> <span class="built_in">varchar</span>(<span class="number">26</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`s_city`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`s_nation`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`s_region`</span> <span class="built_in">varchar</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`s_phone`</span> <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=OLAP</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(<span class="string">`s_suppkey`</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&quot;OLAP&quot;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(<span class="string">`s_suppkey`</span>) BUCKETS <span class="number">12</span></span><br><span class="line">PROPERTIES (</span><br><span class="line"><span class="string">&quot;replication_num&quot;</span> = <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;colocate_with&quot;</span> = <span class="string">&quot;groupa4&quot;</span>,</span><br><span class="line"><span class="string">&quot;in_memory&quot;</span> = <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage_format&quot;</span> = <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`part`</span> (</span><br><span class="line">  <span class="string">`p_partkey`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_name`</span> <span class="built_in">varchar</span>(<span class="number">23</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_mfgr`</span> <span class="built_in">varchar</span>(<span class="number">7</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_category`</span> <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_brand`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_color`</span> <span class="built_in">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_type`</span> <span class="built_in">varchar</span>(<span class="number">26</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_size`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`p_container`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=OLAP</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(<span class="string">`p_partkey`</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&quot;OLAP&quot;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(<span class="string">`p_partkey`</span>) BUCKETS <span class="number">12</span></span><br><span class="line">PROPERTIES (</span><br><span class="line"><span class="string">&quot;replication_num&quot;</span> = <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;colocate_with&quot;</span> = <span class="string">&quot;groupa5&quot;</span>,</span><br><span class="line"><span class="string">&quot;in_memory&quot;</span> = <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage_format&quot;</span> = <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`lineorder_flat`</span> (</span><br><span class="line">  <span class="string">`LO_ORDERKEY`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_ORDERDATE`</span> <span class="built_in">date</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_LINENUMBER`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_CUSTKEY`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_PARTKEY`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_SUPPKEY`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_ORDERPRIORITY`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_SHIPPRIORITY`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_QUANTITY`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_EXTENDEDPRICE`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_ORDTOTALPRICE`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_DISCOUNT`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_REVENUE`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_SUPPLYCOST`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_TAX`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_COMMITDATE`</span> <span class="built_in">date</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`LO_SHIPMODE`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_NAME`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_ADDRESS`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_CITY`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_NATION`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_REGION`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_PHONE`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`C_MKTSEGMENT`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`S_NAME`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`S_ADDRESS`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`S_CITY`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`S_NATION`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`S_REGION`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`S_PHONE`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_NAME`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_MFGR`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_CATEGORY`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_BRAND`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_COLOR`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_TYPE`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_SIZE`</span> <span class="built_in">tinyint</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">`P_CONTAINER`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&quot;&quot;</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=OLAP</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(<span class="string">`LO_ORDERKEY`</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&quot;OLAP&quot;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(<span class="string">`LO_ORDERKEY`</span>) BUCKETS <span class="number">192</span></span><br><span class="line">PROPERTIES (</span><br><span class="line"><span class="string">&quot;replication_num&quot;</span> = <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;colocate_with&quot;</span> = <span class="string">&quot;groupxx1&quot;</span>,</span><br><span class="line"><span class="string">&quot;in_memory&quot;</span> = <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;storage_format&quot;</span> = <span class="string">&quot;DEFAULT&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>连接一个fe执行以上sql即可</p>
</blockquote>
<h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><blockquote>
<p>DorisDB测试中使用python脚本导入数据, 需要安装pymysql库</p>
</blockquote>
<p>使用Stream load导入单表数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">(myrecover) [root@bj2-mysql-rc-drill-02 output]<span class="comment"># time bin/stream_load.sh data_dir</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.1</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.2</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.3</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.4</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.5</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.6</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.7</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.8</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.9</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.10</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.100</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.97</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.99</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.93</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.98</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.94</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.92</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.95</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.91</span></span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: lineorder, <span class="keyword">path</span>: data_dir/lineorder.tbl<span class="number">.96</span></span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: customer, <span class="keyword">path</span>: data_dir/customer.tbl</span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: customer, <span class="keyword">path</span>: data_dir/customer.tbl</span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: dates, <span class="keyword">path</span>: data_dir/dates.tbl</span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: dates, <span class="keyword">path</span>: data_dir/dates.tbl</span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: part, <span class="keyword">path</span>: data_dir/part.tbl</span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: part, <span class="keyword">path</span>: data_dir/part.tbl</span><br><span class="line">stream <span class="keyword">load</span> start. <span class="keyword">table</span>: supplier, <span class="keyword">path</span>: data_dir/supplier.tbl</span><br><span class="line">stream <span class="keyword">load</span> success. <span class="keyword">table</span>: supplier, <span class="keyword">path</span>: data_dir/supplier.tbl</span><br><span class="line"></span><br><span class="line"><span class="built_in">real</span>    <span class="number">82</span>m31<span class="number">.323</span>s</span><br><span class="line"><span class="keyword">user</span>    <span class="number">0</span>m6<span class="number">.385</span>s</span><br><span class="line"><span class="keyword">sys</span>     <span class="number">0</span>m36<span class="number">.761</span>s</span><br><span class="line"></span><br><span class="line">(myrecover) [root@bj2-mysql-rc-drill<span class="number">-02</span> <span class="keyword">output</span>]<span class="comment"># time bin/flat_insert.sh </span></span><br><span class="line"><span class="keyword">sql</span>: ssb_flat_insert <span class="keyword">start</span></span><br><span class="line"><span class="keyword">sql</span>: ssb_flat_insert <span class="keyword">success</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">real</span>    <span class="number">1</span>m36<span class="number">.697</span>s</span><br><span class="line"><span class="keyword">user</span>    <span class="number">0</span>m0<span class="number">.078</span>s</span><br><span class="line"><span class="keyword">sys</span>     <span class="number">0</span>m0<span class="number">.022</span>s</span><br></pre></td></tr></table></figure>
<p>插入数据到宽表lineorder_flat</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(myrecover) [root@bj2-mysql-rc-drill-02 output]# time bin/flat_insert.sh</span><br><span class="line">sql: ssb_flat_insert start</span><br><span class="line">sql: ssb_flat_insert success</span><br><span class="line"></span><br><span class="line">real    2m37.530s</span><br><span class="line">user    0m0.063s</span><br><span class="line">sys     0m0.023s</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有一个不理解的现象是, flat_insert.sh已经执行完毕, 但是查看lineorder_flat表行数时, 发现其值是在不断增大</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select count(<span class="strong">*) from lineorder_flat;</span></span><br><span class="line"><span class="strong">+-----------+</span></span><br><span class="line"><span class="strong">| count(*</span>)  |</span><br><span class="line"><span class="code">+-----------+</span></span><br><span class="line">| 182256332 |</span><br><span class="line"><span class="code">+-----------+</span></span><br><span class="line">1 row in set (0.10 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(<span class="strong">*) from lineorder_flat;</span></span><br><span class="line"><span class="strong">+-----------+</span></span><br><span class="line"><span class="strong">| count(*</span>)  |</span><br><span class="line"><span class="code">+-----------+</span></span><br><span class="line">| 364316982 |</span><br><span class="line"><span class="code">+-----------+</span></span><br><span class="line">1 row in set (0.16 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(<span class="strong">*) from lineorder_flat;</span></span><br><span class="line"><span class="strong">+-----------+</span></span><br><span class="line"><span class="strong">| count(*</span>)  |</span><br><span class="line"><span class="code">+-----------+</span></span><br><span class="line">| 546669614 |</span><br><span class="line"><span class="code">+-----------+</span></span><br><span class="line">1 row in set (0.41 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>可以看到DorisDB数据导入耗时约86分钟</p>
<p>最终数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select count(*) from customer       ;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|  3000000 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> dates          ;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|     2556 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> lineorder      ;</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| count(*)  |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 600037902 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.53</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> lineorder_flat ;</span><br><span class="line"></span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| count(*)  |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 546669614 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.40</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> part           ;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|  1400000 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> supplier       ;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|   200000 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="数据占用空间"><a href="#数据占用空间" class="headerlink" title="数据占用空间"></a>数据占用空间</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">du -sh <span class="regexp">/data/</span>DorisDB-SE-<span class="number">1.12</span>.<span class="number">1</span><span class="regexp">/be/</span>storage<span class="regexp">/data/</span></span><br><span class="line"><span class="number">44</span>G     <span class="regexp">/data/</span>DorisDB-SE-<span class="number">1.12</span>.<span class="number">1</span><span class="regexp">/be/</span>storage<span class="regexp">/data/</span></span><br><span class="line"></span><br><span class="line"><span class="number">44</span>*<span class="number">3</span> = <span class="number">132</span>G</span><br></pre></td></tr></table></figure>
<h3 id="单表查询测试"><a href="#单表查询测试" class="headerlink" title="单表查询测试"></a>单表查询测试</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span>  parallel_fragment_exec_instance_num  = <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<h4 id="Q1-1"><a href="#Q1-1" class="headerlink" title="Q1.1"></a>Q1.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(lo_extendedprice * lo_discount) <span class="keyword">AS</span> <span class="string">`revenue`</span> </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> lo_orderdate &gt;= <span class="string">&#x27;1993-01-01&#x27;</span> <span class="keyword">and</span> lo_orderdate &lt;= <span class="string">&#x27;1993-12-31&#x27;</span> <span class="keyword">AND</span> lo_discount <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">3</span> <span class="keyword">AND</span> lo_quantity &lt; <span class="number">25</span>; </span><br><span class="line">+<span class="comment">----------------+</span></span><br><span class="line">| revenue        |</span><br><span class="line">+<span class="comment">----------------+</span></span><br><span class="line">| 44652567249651 |</span><br><span class="line">+<span class="comment">----------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.35</span> sec)</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.29</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q1-2"><a href="#Q1-2" class="headerlink" title="Q1.2"></a>Q1.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(lo_extendedprice * lo_discount) <span class="keyword">AS</span> revenue <span class="keyword">FROM</span> lineorder_flat  </span><br><span class="line"><span class="keyword">WHERE</span> lo_orderdate &gt;= <span class="string">&#x27;1994-01-01&#x27;</span> <span class="keyword">and</span> lo_orderdate &lt;= <span class="string">&#x27;1994-01-31&#x27;</span> <span class="keyword">AND</span> lo_discount <span class="keyword">BETWEEN</span> <span class="number">4</span> <span class="keyword">AND</span> <span class="number">6</span> <span class="keyword">AND</span> lo_quantity <span class="keyword">BETWEEN</span> <span class="number">26</span> <span class="keyword">AND</span> <span class="number">35</span>; </span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| revenue       |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| 9624332170119 |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.27</span> sec)</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.19</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q1-3"><a href="#Q1-3" class="headerlink" title="Q1.3"></a>Q1.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(lo_extendedprice * lo_discount) <span class="keyword">AS</span> revenue </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">weekofyear</span>(lo_orderdate) = <span class="number">6</span> <span class="keyword">AND</span> lo_orderdate &gt;= <span class="string">&#x27;1994-01-01&#x27;</span> <span class="keyword">and</span> lo_orderdate &lt;= <span class="string">&#x27;1994-12-31&#x27;</span> </span><br><span class="line"> <span class="keyword">AND</span> lo_discount <span class="keyword">BETWEEN</span> <span class="number">5</span> <span class="keyword">AND</span> <span class="number">7</span> <span class="keyword">AND</span> lo_quantity <span class="keyword">BETWEEN</span> <span class="number">26</span> <span class="keyword">AND</span> <span class="number">35</span>;</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| revenue       |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| 2611093671163 |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.31</span> sec)</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.24</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q2-1"><a href="#Q2-1" class="headerlink" title="Q2.1"></a>Q2.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(lo_revenue), <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>,  p_brand </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> p_category = <span class="string">&#x27;MFGR#12&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span>,  p_brand </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, p_brand; </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">240 rows in <span class="keyword">set</span> (<span class="number">0.41</span> sec)</span><br><span class="line"><span class="number">240</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.37</span>  sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q2-2"><a href="#Q2-2" class="headerlink" title="Q2.2"></a>Q2.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"><span class="keyword">sum</span>(lo_revenue), <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, p_brand </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> p_brand &gt;= <span class="string">&#x27;MFGR#2221&#x27;</span> <span class="keyword">AND</span> p_brand &lt;= <span class="string">&#x27;MFGR#2228&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;ASIA&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span>,  p_brand </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, p_brand; </span><br><span class="line"></span><br><span class="line">48 rows in <span class="keyword">set</span> (<span class="number">0.78</span> sec)</span><br><span class="line"><span class="number">48</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.72</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q2-3"><a href="#Q2-3" class="headerlink" title="Q2.3"></a>Q2.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(lo_revenue),  <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, p_brand </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> p_brand = <span class="string">&#x27;MFGR#2239&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;EUROPE&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span>  <span class="keyword">year</span>,  p_brand </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span>, p_brand; </span><br><span class="line"></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.34</span> sec)</span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.28</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-1"><a href="#Q3-1" class="headerlink" title="Q3.1"></a>Q3.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c_nation, s_nation,  <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">AS</span> revenue <span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_region = <span class="string">&#x27;ASIA&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;ASIA&#x27;</span> <span class="keyword">AND</span> lo_orderdate  &gt;= <span class="string">&#x27;1992-01-01&#x27;</span> <span class="keyword">AND</span> lo_orderdate   &lt;= <span class="string">&#x27;1997-12-31&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c_nation, s_nation, <span class="keyword">year</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>  <span class="keyword">year</span> <span class="keyword">ASC</span>, revenue <span class="keyword">DESC</span>; </span><br><span class="line"></span><br><span class="line">150 rows in <span class="keyword">set</span> (<span class="number">1.56</span> sec)</span><br><span class="line"><span class="number">150</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.86</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-2"><a href="#Q3-2" class="headerlink" title="Q3.2"></a>Q3.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  c_city, s_city, <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_nation = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> s_nation = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> lo_orderdate  &gt;= <span class="string">&#x27;1992-01-01&#x27;</span> <span class="keyword">AND</span> lo_orderdate &lt;= <span class="string">&#x27;1997-12-31&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c_city, s_city, <span class="keyword">year</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ASC</span>, revenue <span class="keyword">DESC</span>; </span><br><span class="line"></span><br><span class="line">600 rows in <span class="keyword">set</span> (<span class="number">1.08</span> sec)</span><br><span class="line"><span class="number">600</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.79</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-3"><a href="#Q3-3" class="headerlink" title="Q3.3"></a>Q3.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c_city, s_city, <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">AS</span> revenue </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_city <span class="keyword">in</span> ( <span class="string">&#x27;UNITED KI1&#x27;</span> ,<span class="string">&#x27;UNITED KI5&#x27;</span>) <span class="keyword">AND</span> s_city <span class="keyword">in</span> ( <span class="string">&#x27;UNITED KI1&#x27;</span> ,<span class="string">&#x27;UNITED KI5&#x27;</span>) <span class="keyword">AND</span> lo_orderdate  &gt;= <span class="string">&#x27;1992-01-01&#x27;</span> <span class="keyword">AND</span> lo_orderdate &lt;= <span class="string">&#x27;1997-12-31&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c_city, s_city, <span class="keyword">year</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ASC</span>, revenue <span class="keyword">DESC</span>; </span><br><span class="line"></span><br><span class="line">24 rows in <span class="keyword">set</span> (<span class="number">0.25</span> sec)</span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.29</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-4"><a href="#Q3-4" class="headerlink" title="Q3.4"></a>Q3.4</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c_city, s_city, <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">AS</span> revenue </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_city <span class="keyword">in</span> (<span class="string">&#x27;UNITED KI1&#x27;</span>, <span class="string">&#x27;UNITED KI5&#x27;</span>) <span class="keyword">AND</span> s_city <span class="keyword">in</span> ( <span class="string">&#x27;UNITED KI1&#x27;</span>,  <span class="string">&#x27;UNITED KI5&#x27;</span>) <span class="keyword">AND</span>  lo_orderdate  &gt;= <span class="string">&#x27;1997-12-01&#x27;</span> <span class="keyword">AND</span> lo_orderdate &lt;= <span class="string">&#x27;1997-12-31&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> c_city,  s_city, <span class="keyword">year</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ASC</span>, revenue <span class="keyword">DESC</span>; </span><br><span class="line"></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.23</span> sec)</span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.26</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q4-1"><a href="#Q4-1" class="headerlink" title="Q4.1"></a>Q4.1</h4><p>在<a href="https://www.dorisdb.com/zh-CN/blog/1.8">DorisDB测试文档</a>中对该SQL执行前执行了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> vectorized_engine_enable = <span class="literal">FALSE</span>; </span><br></pre></td></tr></table></figure>
<p>但实际发现执行上面语句后反而会慢很多</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, c_nation,  <span class="keyword">sum</span>(lo_revenue - lo_supplycost) <span class="keyword">AS</span> profit <span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> p_mfgr <span class="keyword">in</span> ( <span class="string">&#x27;MFGR#1&#x27;</span> , <span class="string">&#x27;MFGR#2&#x27;</span>) </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span>, c_nation </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ASC</span>, c_nation <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line">30 rows in <span class="keyword">set</span> (<span class="number">1</span> <span class="keyword">min</span> <span class="number">24.46</span> sec)</span><br><span class="line"><span class="number">30</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1</span> <span class="keyword">min</span> <span class="number">25.10</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> vectorized_engine_enable = <span class="literal">TRUE</span>; </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, c_nation,  <span class="keyword">sum</span>(lo_revenue - lo_supplycost) <span class="keyword">AS</span> profit <span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> p_mfgr <span class="keyword">in</span> ( <span class="string">&#x27;MFGR#1&#x27;</span> , <span class="string">&#x27;MFGR#2&#x27;</span>) </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span>, c_nation </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ASC</span>, c_nation <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line">30 rows in <span class="keyword">set</span> (<span class="number">0.87</span> sec)</span><br><span class="line"><span class="number">30</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.72</span> sec)</span><br></pre></td></tr></table></figure>
<p>我比对了开启和关闭<code>vectorized_engine_enable</code>后的查询结果, 发现是一样的, 这里我就不明白为啥要设置<code>vectorized_engine_enable</code>为<code>False</code>了</p>
<h4 id="Q4-2"><a href="#Q4-2" class="headerlink" title="Q4.2"></a>Q4.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, </span><br><span class="line">    s_nation, p_category, <span class="keyword">sum</span>(lo_revenue - lo_supplycost) <span class="keyword">AS</span> profit </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> c_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> lo_orderdate &gt;= <span class="string">&#x27;1997-01-01&#x27;</span> <span class="keyword">and</span> lo_orderdate &lt;= <span class="string">&#x27;1998-12-31&#x27;</span> <span class="keyword">AND</span>  p_mfgr <span class="keyword">in</span> ( <span class="string">&#x27;MFGR#1&#x27;</span> , <span class="string">&#x27;MFGR#2&#x27;</span>) </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">year</span>, s_nation,  p_category </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>  <span class="keyword">year</span> <span class="keyword">ASC</span>, s_nation <span class="keyword">ASC</span>, p_category <span class="keyword">ASC</span>; </span><br><span class="line"></span><br><span class="line">30 rows in <span class="keyword">set</span> (<span class="number">0.72</span> sec)</span><br><span class="line"><span class="number">50</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.49</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q4-3"><a href="#Q4-3" class="headerlink" title="Q4.3"></a>Q4.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>(lo_orderdate) <span class="keyword">AS</span> <span class="keyword">year</span>, s_city, p_brand, </span><br><span class="line">    <span class="keyword">sum</span>(lo_revenue - lo_supplycost) <span class="keyword">AS</span> profit </span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat </span><br><span class="line"><span class="keyword">WHERE</span> s_nation = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> lo_orderdate &gt;= <span class="string">&#x27;1997-01-01&#x27;</span> <span class="keyword">and</span> lo_orderdate &lt;= <span class="string">&#x27;1998-12-31&#x27;</span> <span class="keyword">AND</span> p_category = <span class="string">&#x27;MFGR#14&#x27;</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span>  <span class="keyword">year</span>,  s_city, p_brand </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ASC</span>,  s_city <span class="keyword">ASC</span>,  p_brand <span class="keyword">ASC</span>; </span><br><span class="line"></span><br><span class="line">400 rows in <span class="keyword">set</span> (<span class="number">0.51</span> sec)</span><br><span class="line"><span class="number">400</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.38</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="多表关联测试"><a href="#多表关联测试" class="headerlink" title="多表关联测试"></a>多表关联测试</h3><p>执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span>  parallel_fragment_exec_instance_num  = <span class="number">8</span>;</span><br></pre></td></tr></table></figure>
<h4 id="Q1-1-1"><a href="#Q1-1-1" class="headerlink" title="Q1.1"></a>Q1.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> revenue</span><br><span class="line"><span class="keyword">from</span> lineorder <span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">where</span> d_year = <span class="number">1993</span> <span class="keyword">and</span> lo_discount <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">and</span> <span class="number">3</span> <span class="keyword">and</span> lo_quantity &lt; <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.45</span> sec)</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.49</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q1-2-1"><a href="#Q1-2-1" class="headerlink" title="Q1.2"></a>Q1.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> revenue</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">where</span> d_yearmonthnum = <span class="number">199401</span></span><br><span class="line"><span class="keyword">and</span> lo_discount <span class="keyword">between</span> <span class="number">4</span> <span class="keyword">and</span> <span class="number">6</span></span><br><span class="line"><span class="keyword">and</span> lo_quantity <span class="keyword">between</span> <span class="number">26</span> <span class="keyword">and</span> <span class="number">35</span>;</span><br><span class="line"></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.41</span> sec)</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.45</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q1-3-1"><a href="#Q1-3-1" class="headerlink" title="Q1.3"></a>Q1.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> revenue</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">where</span> d_weeknuminyear = <span class="number">6</span> <span class="keyword">and</span> d_year = <span class="number">1994</span></span><br><span class="line"><span class="keyword">and</span> lo_discount <span class="keyword">between</span> <span class="number">5</span> <span class="keyword">and</span> <span class="number">7</span></span><br><span class="line"><span class="keyword">and</span> lo_quantity <span class="keyword">between</span> <span class="number">26</span> <span class="keyword">and</span> <span class="number">35</span>;</span><br><span class="line"></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.51</span> sec)</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.34</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q2-1-1"><a href="#Q2-1-1" class="headerlink" title="Q2.1"></a>Q2.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue, d_year, p_brand</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> part <span class="keyword">on</span> lo_partkey = p_partkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> p_category = <span class="string">&#x27;MFGR#12&#x27;</span> <span class="keyword">and</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d_year, p_brand</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year, p_brand;</span><br><span class="line"></span><br><span class="line">280 rows in <span class="keyword">set</span> (<span class="number">1.56</span> sec)</span><br><span class="line"><span class="number">280</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.60</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q2-2-1"><a href="#Q2-2-1" class="headerlink" title="Q2.2"></a>Q2.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue, d_year, p_brand</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> part <span class="keyword">on</span> lo_partkey = p_partkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> p_brand <span class="keyword">between</span> <span class="string">&#x27;MFGR#2221&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;MFGR#2228&#x27;</span> <span class="keyword">and</span> s_region = <span class="string">&#x27;ASIA&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d_year, p_brand</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year, p_brand;</span><br><span class="line"></span><br><span class="line">56 rows in <span class="keyword">set</span> (<span class="number">1.69</span> sec)</span><br><span class="line"><span class="number">56</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.06</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q2-3-1"><a href="#Q2-3-1" class="headerlink" title="Q2.3"></a>Q2.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue, d_year, p_brand</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> part <span class="keyword">on</span> lo_partkey = p_partkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> p_brand = <span class="string">&#x27;MFGR#2239&#x27;</span> <span class="keyword">and</span> s_region = <span class="string">&#x27;EUROPE&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d_year, p_brand</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year, p_brand;</span><br><span class="line"></span><br><span class="line">7 rows in <span class="keyword">set</span> (<span class="number">0.78</span> sec)</span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.15</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-1-1"><a href="#Q3-1-1" class="headerlink" title="Q3.1"></a>Q3.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_nation, s_nation, d_year, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> c_region = <span class="string">&#x27;ASIA&#x27;</span> <span class="keyword">and</span> s_region = <span class="string">&#x27;ASIA&#x27;</span><span class="keyword">and</span> d_year &gt;= <span class="number">1992</span> <span class="keyword">and</span> d_year &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_nation, s_nation, d_year</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year <span class="keyword">asc</span>, lo_revenue <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">150 rows in <span class="keyword">set</span> (<span class="number">3.48</span> sec)</span><br><span class="line"><span class="number">150</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">3.70</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-2-1"><a href="#Q3-2-1" class="headerlink" title="Q3.2"></a>Q3.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_city, s_city, d_year, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> c_nation = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">and</span> s_nation = <span class="string">&#x27;UNITED STATES&#x27;</span></span><br><span class="line"><span class="keyword">and</span> d_year &gt;= <span class="number">1992</span> <span class="keyword">and</span> d_year &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_city, s_city, d_year</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year <span class="keyword">asc</span>, lo_revenue <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">600 rows in <span class="keyword">set</span> (<span class="number">1.32</span> sec)</span><br><span class="line"><span class="number">600</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.85</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-3-1"><a href="#Q3-3-1" class="headerlink" title="Q3.3"></a>Q3.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_city, s_city, d_year, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> (c_city=<span class="string">&#x27;UNITED KI1&#x27;</span> <span class="keyword">or</span> c_city=<span class="string">&#x27;UNITED KI5&#x27;</span>)</span><br><span class="line"><span class="keyword">and</span> (s_city=<span class="string">&#x27;UNITED KI1&#x27;</span> <span class="keyword">or</span> s_city=<span class="string">&#x27;UNITED KI5&#x27;</span>)</span><br><span class="line"><span class="keyword">and</span> d_year &gt;= <span class="number">1992</span> <span class="keyword">and</span> d_year &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_city, s_city, d_year</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year <span class="keyword">asc</span>, lo_revenue <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">24 rows in <span class="keyword">set</span> (<span class="number">1.03</span> sec)</span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.04</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q3-4-1"><a href="#Q3-4-1" class="headerlink" title="Q3.4"></a>Q3.4</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> c_city, s_city, d_year, <span class="keyword">sum</span>(lo_revenue) <span class="keyword">as</span> lo_revenue</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">where</span> (c_city=<span class="string">&#x27;UNITED KI1&#x27;</span> <span class="keyword">or</span> c_city=<span class="string">&#x27;UNITED KI5&#x27;</span>) <span class="keyword">and</span> (s_city=<span class="string">&#x27;UNITED KI1&#x27;</span> <span class="keyword">or</span> s_city=<span class="string">&#x27;UNITED KI5&#x27;</span>) <span class="keyword">and</span> d_yearmonth</span><br><span class="line"> = <span class="string">&#x27;Dec1997&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> c_city, s_city, d_year</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year <span class="keyword">asc</span>, lo_revenue <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">1.33</span> sec)</span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.17</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q4-1-1"><a href="#Q4-1-1" class="headerlink" title="Q4.1"></a>Q4.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> d_year, c_nation, <span class="keyword">sum</span>(lo_revenue) - <span class="keyword">sum</span>(lo_supplycost) <span class="keyword">as</span> profit</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">join</span> part <span class="keyword">on</span> lo_partkey = p_partkey</span><br><span class="line"><span class="keyword">where</span> c_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">and</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">and</span> (p_mfgr = <span class="string">&#x27;MFGR#1&#x27;</span> <span class="keyword">or</span> p_mfgr = <span class="string">&#x27;MFGR#2&#x27;</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d_year, c_nation</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year, c_nation;</span><br><span class="line"></span><br><span class="line">35 rows in <span class="keyword">set</span> (<span class="number">3.48</span> sec)</span><br><span class="line"><span class="number">35</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">3.75</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q4-2-1"><a href="#Q4-2-1" class="headerlink" title="Q4.2"></a>Q4.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> d_year, s_nation, p_category, <span class="keyword">sum</span>(lo_revenue) - <span class="keyword">sum</span>(lo_supplycost) <span class="keyword">as</span> profit</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">join</span> part <span class="keyword">on</span> lo_partkey = p_partkey</span><br><span class="line"><span class="keyword">where</span> c_region = <span class="string">&#x27;AMERICA&#x27;</span><span class="keyword">and</span> s_region = <span class="string">&#x27;AMERICA&#x27;</span></span><br><span class="line"><span class="keyword">and</span> (d_year = <span class="number">1997</span> <span class="keyword">or</span> d_year = <span class="number">1998</span>)</span><br><span class="line"><span class="keyword">and</span> (p_mfgr = <span class="string">&#x27;MFGR#1&#x27;</span> <span class="keyword">or</span> p_mfgr = <span class="string">&#x27;MFGR#2&#x27;</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d_year, s_nation, p_category</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year, s_nation, p_category;</span><br><span class="line"></span><br><span class="line">100 rows in <span class="keyword">set</span> (<span class="number">2.83</span> sec)</span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">3.17</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="Q4-3-1"><a href="#Q4-3-1" class="headerlink" title="Q4.3"></a>Q4.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> d_year, s_city, p_brand, <span class="keyword">sum</span>(lo_revenue) - <span class="keyword">sum</span>(lo_supplycost) <span class="keyword">as</span> profit</span><br><span class="line"><span class="keyword">from</span> lineorder</span><br><span class="line"><span class="keyword">join</span> dates <span class="keyword">on</span> lo_orderdate = d_datekey</span><br><span class="line"><span class="keyword">join</span> customer <span class="keyword">on</span> lo_custkey = c_custkey</span><br><span class="line"><span class="keyword">join</span> supplier <span class="keyword">on</span> lo_suppkey = s_suppkey</span><br><span class="line"><span class="keyword">join</span> part <span class="keyword">on</span> lo_partkey = p_partkey</span><br><span class="line"><span class="keyword">where</span> c_region = <span class="string">&#x27;AMERICA&#x27;</span><span class="keyword">and</span> s_nation = <span class="string">&#x27;UNITED STATES&#x27;</span></span><br><span class="line"><span class="keyword">and</span> (d_year = <span class="number">1997</span> <span class="keyword">or</span> d_year = <span class="number">1998</span>)</span><br><span class="line"><span class="keyword">and</span> p_category = <span class="string">&#x27;MFGR#14&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d_year, s_city, p_brand</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d_year, s_city, p_brand;</span><br><span class="line"></span><br><span class="line">800 rows in <span class="keyword">set</span> (<span class="number">1.56</span> sec)</span><br><span class="line"><span class="number">800</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">2.14</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="ClickHouse"><a href="#ClickHouse" class="headerlink" title="ClickHouse"></a>ClickHouse</h2><h3 id="构建数据-1"><a href="#构建数据-1" class="headerlink" title="构建数据"></a>构建数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/vadimtk/ssb-dbgen.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ssb-dbgen</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./dbgen -s 100 -T c</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./dbgen -s 100 -T l</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./dbgen -s 100 -T p</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./dbgen -s 100 -T s</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./dbgen -s 100 -T d</span></span><br></pre></td></tr></table></figure>
<h3 id="建表-1"><a href="#建表-1" class="headerlink" title="建表"></a>建表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> ssb <span class="keyword">on</span> cluster ck_cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.customer_local <span class="keyword">on</span> cluster ck_cluster</span><br><span class="line">(</span><br><span class="line">        C_CUSTKEY       UInt32,</span><br><span class="line">        C_NAME          <span class="keyword">String</span>,</span><br><span class="line">        C_ADDRESS       <span class="keyword">String</span>,</span><br><span class="line">        C_CITY          LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        C_NATION        LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        C_REGION        LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        C_PHONE         <span class="keyword">String</span>,</span><br><span class="line">        C_MKTSEGMENT    LowCardinality(<span class="keyword">String</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">  <span class="string">&#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/customer&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#123;replica&#125;&#x27;</span></span><br><span class="line">) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (C_CUSTKEY) <span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.customer <span class="keyword">on</span> cluster ck_cluster <span class="keyword">AS</span> ssb.customer_local  <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(</span><br><span class="line">    ck_cluster,</span><br><span class="line">    ssb,</span><br><span class="line">    customer_local,</span><br><span class="line">    <span class="keyword">rand</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.lineorder_local <span class="keyword">on</span> cluster ck_cluster</span><br><span class="line">(</span><br><span class="line">    LO_ORDERKEY             UInt32,</span><br><span class="line">    LO_LINENUMBER           UInt8,</span><br><span class="line">    LO_CUSTKEY              UInt32,</span><br><span class="line">    LO_PARTKEY              UInt32,</span><br><span class="line">    LO_SUPPKEY              UInt32,</span><br><span class="line">    LO_ORDERDATE            <span class="built_in">Date</span>,</span><br><span class="line">    LO_ORDERPRIORITY        LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">    LO_SHIPPRIORITY         UInt8,</span><br><span class="line">    LO_QUANTITY             UInt8,</span><br><span class="line">    LO_EXTENDEDPRICE        UInt32,</span><br><span class="line">    LO_ORDTOTALPRICE        UInt32,</span><br><span class="line">    LO_DISCOUNT             UInt8,</span><br><span class="line">    LO_REVENUE              UInt32,</span><br><span class="line">    LO_SUPPLYCOST           UInt32,</span><br><span class="line">    LO_TAX                  UInt8,</span><br><span class="line">    LO_COMMITDATE           <span class="built_in">Date</span>,</span><br><span class="line">    LO_SHIPMODE             LowCardinality(<span class="keyword">String</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">  <span class="string">&#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/lineorder&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#123;replica&#125;&#x27;</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYear(LO_ORDERDATE) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (LO_ORDERDATE, LO_ORDERKEY)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.lineorder <span class="keyword">on</span> cluster ck_cluster <span class="keyword">AS</span> ssb.lineorder_local  <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(</span><br><span class="line">    ck_cluster,</span><br><span class="line">    ssb,</span><br><span class="line">    lineorder_local,</span><br><span class="line">    <span class="keyword">rand</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.part_local <span class="keyword">on</span> cluster ck_cluster</span><br><span class="line">(</span><br><span class="line">        P_PARTKEY       UInt32,</span><br><span class="line">        P_NAME          <span class="keyword">String</span>,</span><br><span class="line">        P_MFGR          LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        P_CATEGORY      LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        P_BRAND         LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        P_COLOR         LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        P_TYPE          LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        P_SIZE          UInt8,</span><br><span class="line">        P_CONTAINER     LowCardinality(<span class="keyword">String</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">  <span class="string">&#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/part&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#123;replica&#125;&#x27;</span></span><br><span class="line">) <span class="keyword">ORDER</span> <span class="keyword">BY</span> P_PARTKEY <span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.part <span class="keyword">on</span> cluster ck_cluster <span class="keyword">AS</span> ssb.part_local  <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(</span><br><span class="line">    ck_cluster,</span><br><span class="line">    ssb,</span><br><span class="line">    part_local,</span><br><span class="line">    <span class="keyword">rand</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.supplier_local <span class="keyword">on</span> cluster ck_cluster</span><br><span class="line">(</span><br><span class="line">        S_SUPPKEY       UInt32,</span><br><span class="line">        S_NAME          <span class="keyword">String</span>,</span><br><span class="line">        S_ADDRESS       <span class="keyword">String</span>,</span><br><span class="line">        S_CITY          LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        S_NATION        LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        S_REGION        LowCardinality(<span class="keyword">String</span>),</span><br><span class="line">        S_PHONE         <span class="keyword">String</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">  <span class="string">&#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/supplier&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#123;replica&#125;&#x27;</span></span><br><span class="line">) <span class="keyword">ORDER</span> <span class="keyword">BY</span> S_SUPPKEY <span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.supplier <span class="keyword">on</span> cluster ck_cluster <span class="keyword">AS</span> ssb.supplier_local  <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(</span><br><span class="line">    ck_cluster,</span><br><span class="line">    ssb,</span><br><span class="line">    supplier_local,</span><br><span class="line">    <span class="keyword">rand</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.dates_local <span class="keyword">on</span> cluster ck_cluster</span><br><span class="line">(</span><br><span class="line">        D_DATEKEY          UInt32,</span><br><span class="line">        D_DATE             <span class="keyword">String</span>,</span><br><span class="line">        D_DAYOFWEEK        <span class="keyword">String</span>,</span><br><span class="line">        D_MONTH            <span class="keyword">String</span>,</span><br><span class="line">        D_YEAR             UInt32,</span><br><span class="line">        D_YEARMONTHNUM     UInt32,</span><br><span class="line">        D_YEARMONTH        <span class="keyword">String</span>,</span><br><span class="line">        D_DAYNUMINWEEK     UInt32,</span><br><span class="line">        D_DAYNUMINMONTH    UInt32,</span><br><span class="line">        D_DAYNUMINYEAR     UInt32,</span><br><span class="line">        D_MONTHNUMINYEAR   UInt32,</span><br><span class="line">        D_WEEKNUMINYEAR    UInt32,</span><br><span class="line">        D_SELLINGSEASON    <span class="keyword">String</span>,</span><br><span class="line">        D_LASTDAYINWEEKFL  UInt32,</span><br><span class="line">        D_LASTDAYINMONTHFL UInt32,</span><br><span class="line">        D_HOLIDAYFL        UInt32,</span><br><span class="line">        D_WEEKDAYFL        UInt32</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">  <span class="string">&#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/dates&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#123;replica&#125;&#x27;</span></span><br><span class="line">) <span class="keyword">ORDER</span> <span class="keyword">BY</span> D_DATEKEY <span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.dates <span class="keyword">on</span> cluster ck_cluster <span class="keyword">AS</span> ssb.dates_local  <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(</span><br><span class="line">    ck_cluster,</span><br><span class="line">    ssb,</span><br><span class="line">    dates_local,</span><br><span class="line">    <span class="keyword">rand</span>()</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<h3 id="导入数据-1"><a href="#导入数据-1" class="headerlink" title="导入数据"></a>导入数据</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> ssb-dbgen</span><br><span class="line">clickhouse-client <span class="params">--database=ssb</span> <span class="params">--query</span> <span class="string">&quot;INSERT INTO customer FORMAT CSV&quot;</span> &lt; customer.tbl</span><br><span class="line">clickhouse-client <span class="params">--database=ssb</span> <span class="params">--query</span> <span class="string">&quot;INSERT INTO part FORMAT CSV&quot;</span> &lt; part.tbl</span><br><span class="line">clickhouse-client <span class="params">--database=ssb</span> <span class="params">--query</span>  <span class="string">&quot;INSERT INTO supplier FORMAT CSV&quot;</span> &lt; supplier.tbl</span><br><span class="line">clickhouse-client <span class="params">--database=ssb</span> <span class="params">--query</span>  <span class="string">&quot;INSERT INTO lineorder FORMAT CSV&quot;</span> &lt; lineorder.tbl</span><br><span class="line">clickhouse-client <span class="params">--database=ssb</span> <span class="params">--query</span>  <span class="string">&quot;INSERT INTO dates FORMAT CSV&quot;</span> &lt; date.tbl</span><br><span class="line"></span><br><span class="line">以上用时不到600s</span><br></pre></td></tr></table></figure>
<p>Converting “star schema” to denormalized “flat schema”:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">在一个节点执行</span><br><span class="line"><span class="keyword">set</span> max_bytes_before_external_group_by=<span class="number">2000000000</span>;</span><br><span class="line"><span class="keyword">set</span> max_memory_usage=<span class="number">4000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> lineorder_flat_tmp</span><br><span class="line"><span class="keyword">ENGINE</span> = MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYear(LO_ORDERDATE)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (LO_ORDERDATE, LO_ORDERKEY) <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    l.LO_ORDERKEY <span class="keyword">AS</span> LO_ORDERKEY,</span><br><span class="line">    l.LO_LINENUMBER <span class="keyword">AS</span> LO_LINENUMBER,</span><br><span class="line">    l.LO_CUSTKEY <span class="keyword">AS</span> LO_CUSTKEY,</span><br><span class="line">    l.LO_PARTKEY <span class="keyword">AS</span> LO_PARTKEY,</span><br><span class="line">    l.LO_SUPPKEY <span class="keyword">AS</span> LO_SUPPKEY,</span><br><span class="line">    l.LO_ORDERDATE <span class="keyword">AS</span> LO_ORDERDATE,</span><br><span class="line">    l.LO_ORDERPRIORITY <span class="keyword">AS</span> LO_ORDERPRIORITY,</span><br><span class="line">    l.LO_SHIPPRIORITY <span class="keyword">AS</span> LO_SHIPPRIORITY,</span><br><span class="line">    l.LO_QUANTITY <span class="keyword">AS</span> LO_QUANTITY,</span><br><span class="line">    l.LO_EXTENDEDPRICE <span class="keyword">AS</span> LO_EXTENDEDPRICE,</span><br><span class="line">    l.LO_ORDTOTALPRICE <span class="keyword">AS</span> LO_ORDTOTALPRICE,</span><br><span class="line">    l.LO_DISCOUNT <span class="keyword">AS</span> LO_DISCOUNT,</span><br><span class="line">    l.LO_REVENUE <span class="keyword">AS</span> LO_REVENUE,</span><br><span class="line">    l.LO_SUPPLYCOST <span class="keyword">AS</span> LO_SUPPLYCOST,</span><br><span class="line">    l.LO_TAX <span class="keyword">AS</span> LO_TAX,</span><br><span class="line">    l.LO_COMMITDATE <span class="keyword">AS</span> LO_COMMITDATE,</span><br><span class="line">    l.LO_SHIPMODE <span class="keyword">AS</span> LO_SHIPMODE,</span><br><span class="line">    c.C_NAME <span class="keyword">AS</span> C_NAME,</span><br><span class="line">    c.C_ADDRESS <span class="keyword">AS</span> C_ADDRESS,</span><br><span class="line">    c.C_CITY <span class="keyword">AS</span> C_CITY,</span><br><span class="line">    c.C_NATION <span class="keyword">AS</span> C_NATION,</span><br><span class="line">    c.C_REGION <span class="keyword">AS</span> C_REGION,</span><br><span class="line">    c.C_PHONE <span class="keyword">AS</span> C_PHONE,</span><br><span class="line">    c.C_MKTSEGMENT <span class="keyword">AS</span> C_MKTSEGMENT,</span><br><span class="line">    s.S_NAME <span class="keyword">AS</span> S_NAME,</span><br><span class="line">    s.S_ADDRESS <span class="keyword">AS</span> S_ADDRESS,</span><br><span class="line">    s.S_CITY <span class="keyword">AS</span> S_CITY,</span><br><span class="line">    s.S_NATION <span class="keyword">AS</span> S_NATION,</span><br><span class="line">    s.S_REGION <span class="keyword">AS</span> S_REGION,</span><br><span class="line">    s.S_PHONE <span class="keyword">AS</span> S_PHONE,</span><br><span class="line">    p.P_NAME <span class="keyword">AS</span> P_NAME,</span><br><span class="line">    p.P_MFGR <span class="keyword">AS</span> P_MFGR,</span><br><span class="line">    p.P_CATEGORY <span class="keyword">AS</span> P_CATEGORY,</span><br><span class="line">    p.P_BRAND <span class="keyword">AS</span> P_BRAND,</span><br><span class="line">    p.P_COLOR <span class="keyword">AS</span> P_COLOR,</span><br><span class="line">    p.P_TYPE <span class="keyword">AS</span> P_TYPE,</span><br><span class="line">    p.P_SIZE <span class="keyword">AS</span> P_SIZE,</span><br><span class="line">    p.P_CONTAINER <span class="keyword">AS</span> P_CONTAINER</span><br><span class="line"><span class="keyword">FROM</span> lineorder <span class="keyword">AS</span> l</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> customer <span class="keyword">AS</span> c <span class="keyword">ON</span> c.C_CUSTKEY = l.LO_CUSTKEY</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">AS</span> s <span class="keyword">ON</span> s.S_SUPPKEY = l.LO_SUPPKEY</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> part <span class="keyword">AS</span> p <span class="keyword">ON</span> p.P_PARTKEY = l.LO_PARTKEY;</span><br><span class="line"></span><br><span class="line">0 rows in set. Elapsed: 2086.025 sec. Processed 604.64 million rows, 26.12 GB (289.85 thousand rows/s., 12.52 MB/s.) </span><br><span class="line"></span><br><span class="line">bj2-all-clickhouse-test-01 :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> lineorder_flat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"></span><br><span class="line">┌───<span class="keyword">count</span>()─┐</span><br><span class="line">│ <span class="number">600037902</span> │</span><br><span class="line">└───────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.006</span> sec. </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.lineorder_flat_local <span class="keyword">on</span> cluster ck_cluster</span><br><span class="line"><span class="keyword">AS</span> ssb.lineorder_flat_tmp</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(</span><br><span class="line">  <span class="string">&#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/lineorder_flat&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;&#123;replica&#125;&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYear(LO_ORDERDATE)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (LO_ORDERDATE, LO_ORDERKEY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ssb.lineorder_flat <span class="keyword">on</span> cluster ck_cluster <span class="keyword">AS</span> ssb.lineorder_flat_local <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(</span><br><span class="line">    ck_cluster,</span><br><span class="line">    ssb,</span><br><span class="line">    lineorder_flat_local,</span><br><span class="line">    <span class="keyword">rand</span>()</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">在三个分片执行:</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ssb.lineorder_flat <span class="keyword">SELECT</span> * <span class="keyword">from</span> ssb_local.lineorder_flat_tmp;</span><br><span class="line">  </span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line">0 rows in set. Elapsed: 747.548 sec. Processed 600.04 million rows, 140.40 GB (802.67 thousand rows/s., 187.82 MB/s.) </span><br></pre></td></tr></table></figure></p>
<p>clickhouse数据导入用时总计约3500秒</p>
<p>最终数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">bj2-all-clickhouse-test-01 :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> customer       ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> customer</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">count</span>()─┐</span><br><span class="line">│ <span class="number">3000000</span> │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.004</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-<span class="keyword">all</span>-clickhouse-<span class="keyword">test</span><span class="number">-01</span> :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> dates          ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> dates</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">count</span>()─┐</span><br><span class="line">│    <span class="number">2556</span> │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.004</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-<span class="keyword">all</span>-clickhouse-<span class="keyword">test</span><span class="number">-01</span> :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> lineorder      ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"></span><br><span class="line">┌───<span class="keyword">count</span>()─┐</span><br><span class="line">│ <span class="number">600037902</span> │</span><br><span class="line">└───────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.003</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-<span class="keyword">all</span>-clickhouse-<span class="keyword">test</span><span class="number">-01</span> :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> lineorder_flat ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"></span><br><span class="line">┌───<span class="keyword">count</span>()─┐</span><br><span class="line">│ <span class="number">622259902</span> │</span><br><span class="line">└───────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.003</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-<span class="keyword">all</span>-clickhouse-<span class="keyword">test</span><span class="number">-01</span> :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> part           ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> part</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">count</span>()─┐</span><br><span class="line">│ <span class="number">1400000</span> │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.003</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-<span class="keyword">all</span>-clickhouse-<span class="keyword">test</span><span class="number">-01</span> :) <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> supplier       ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> supplier</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">count</span>()─┐</span><br><span class="line">│  <span class="number">200000</span> │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.004</span> sec. </span><br></pre></td></tr></table></figure>
<h4 id="数据占用空间-1"><a href="#数据占用空间-1" class="headerlink" title="数据占用空间"></a>数据占用空间</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-01</span> ssb]# ll</span><br><span class="line">total <span class="number">48</span></span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">10</span>:<span class="number">51</span> customer -&gt; /data/clickhouse/node1/store/a61/a61a9f88<span class="number">-8</span>bbb<span class="number">-4864</span>-bd0a<span class="number">-1001f</span>5ffcc1c</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">10</span>:<span class="number">51</span> customer_local -&gt; /data/clickhouse/node1/store/c86/c86c8026-f804<span class="number">-4f</span>93<span class="number">-9</span>a2b<span class="number">-051</span>d0fbc1cc9</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">12</span>:<span class="number">55</span> dates -&gt; /data/clickhouse/node1/store/<span class="number">95</span>d/<span class="number">95</span>db2800<span class="number">-91</span>b5<span class="number">-44f</span>3-b378<span class="number">-727</span>bc80d25bc</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">12</span>:<span class="number">55</span> dates_local -&gt; /data/clickhouse/node1/store/<span class="number">137</span>/<span class="number">1371f</span>45a<span class="number">-88</span>bc<span class="number">-4</span>d14<span class="number">-9f</span>04<span class="number">-07895f</span>d561ba</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">11</span>:<span class="number">33</span> lineorder -&gt; /data/clickhouse/node1/store/<span class="number">8f</span>4/<span class="number">8f</span>40504f<span class="number">-4e94</span><span class="number">-4</span>d70-a1de-dbcb6d25d616</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span> lineorder_flat -&gt; /data/clickhouse/node1/store/<span class="number">9f</span>d/<span class="number">9f</span>db7d2c-d2c2<span class="number">-49</span>a0-ad7e<span class="number">-380f</span>c76dff73</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span> lineorder_flat_local -&gt; /data/clickhouse/node1/store/<span class="number">883</span>/<span class="number">883</span>a4a97-f34b<span class="number">-491</span>b-a305<span class="number">-398</span>bd717cfb9</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">10</span>:<span class="number">52</span> lineorder_local -&gt; /data/clickhouse/node1/store/<span class="number">2</span>d6/<span class="number">2</span>d67810e-dfbc<span class="number">-438</span>d-b7aa<span class="number">-6</span>cbfee4c391f</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">11</span>:<span class="number">36</span> part -&gt; /data/clickhouse/node1/store/<span class="number">45</span>b/<span class="number">45</span>b4a779-a2df<span class="number">-4048</span>-a266-efc1481fce68</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">10</span>:<span class="number">53</span> part_local -&gt; /data/clickhouse/node1/store/<span class="number">83f</span>/<span class="number">83f</span>3ac5d<span class="number">-296</span>b<span class="number">-424f</span><span class="number">-900</span>e-f13d67d044ae</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">11</span>:<span class="number">36</span> supplier -&gt; /data/clickhouse/node1/store/<span class="number">6</span>a0/<span class="number">6</span>a0b538a<span class="number">-8f</span>79<span class="number">-4</span>d24-bae0<span class="number">-82792fe8</span>af19</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">69</span> Feb  <span class="number">9</span> <span class="number">10</span>:<span class="number">54</span> supplier_local -&gt; /data/clickhouse/node1/store/<span class="number">5e2</span>/<span class="number">5e29</span>e02d-e35b<span class="number">-4660</span>-a5b9<span class="number">-1</span>bfa1d9fb97d</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-01</span> ssb]# ll |awk -F<span class="string">&#x27;-&gt;&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargs du -sh</span><br><span class="line"><span class="number">20</span>K     /data/clickhouse/node1/store/a61/a61a9f88<span class="number">-8</span>bbb<span class="number">-4864</span>-bd0a<span class="number">-1001f</span>5ffcc1c</span><br><span class="line"><span class="number">39</span>M     /data/clickhouse/node1/store/c86/c86c8026-f804<span class="number">-4f</span>93<span class="number">-9</span>a2b<span class="number">-051</span>d0fbc1cc9</span><br><span class="line"><span class="number">20</span>K     /data/clickhouse/node1/store/<span class="number">95</span>d/<span class="number">95</span>db2800<span class="number">-91</span>b5<span class="number">-44f</span>3-b378<span class="number">-727</span>bc80d25bc</span><br><span class="line"><span class="number">64</span>K     /data/clickhouse/node1/store/<span class="number">137</span>/<span class="number">1371f</span>45a<span class="number">-88</span>bc<span class="number">-4</span>d14<span class="number">-9f</span>04<span class="number">-07895f</span>d561ba</span><br><span class="line"><span class="number">20</span>K     /data/clickhouse/node1/store/<span class="number">8f</span>4/<span class="number">8f</span>40504f<span class="number">-4e94</span><span class="number">-4</span>d70-a1de-dbcb6d25d616</span><br><span class="line"><span class="number">20</span>K     /data/clickhouse/node1/store/<span class="number">9f</span>d/<span class="number">9f</span>db7d2c-d2c2<span class="number">-49</span>a0-ad7e<span class="number">-380f</span>c76dff73</span><br><span class="line"><span class="number">22</span>G     /data/clickhouse/node1/store/<span class="number">883</span>/<span class="number">883</span>a4a97-f34b<span class="number">-491</span>b-a305<span class="number">-398</span>bd717cfb9</span><br><span class="line"><span class="number">6.4</span>G    /data/clickhouse/node1/store/<span class="number">2</span>d6/<span class="number">2</span>d67810e-dfbc<span class="number">-438</span>d-b7aa<span class="number">-6</span>cbfee4c391f</span><br><span class="line"><span class="number">20</span>K     /data/clickhouse/node1/store/<span class="number">45</span>b/<span class="number">45</span>b4a779-a2df<span class="number">-4048</span>-a266-efc1481fce68</span><br><span class="line"><span class="number">8.3</span>M    /data/clickhouse/node1/store/<span class="number">83f</span>/<span class="number">83f</span>3ac5d<span class="number">-296</span>b<span class="number">-424f</span><span class="number">-900</span>e-f13d67d044ae</span><br><span class="line"><span class="number">20</span>K     /data/clickhouse/node1/store/<span class="number">6</span>a0/<span class="number">6</span>a0b538a<span class="number">-8f</span>79<span class="number">-4</span>d24-bae0<span class="number">-82792fe8</span>af19</span><br><span class="line"><span class="number">2.6</span>M    /data/clickhouse/node1/store/<span class="number">5e2</span>/<span class="number">5e29</span>e02d-e35b<span class="number">-4660</span>-a5b9<span class="number">-1</span>bfa1d9fb97d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">约 <span class="number">28.4</span>G*<span class="number">3</span>=<span class="number">85.2</span>G</span><br></pre></td></tr></table></figure>
<h3 id="单表查询测试-1"><a href="#单表查询测试-1" class="headerlink" title="单表查询测试"></a>单表查询测试</h3><p>执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> max_threads=<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> system.settings</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">&#x27;max_threads&#x27;</span></span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">name</span>────────┬─<span class="keyword">value</span>─┬─<span class="keyword">changed</span>─┬─description───────────────────────────────────────────────────────────────────────────────────────┬─<span class="keyword">min</span>──┬─<span class="keyword">max</span>──┬─readonly─┬─<span class="keyword">type</span>───────┐</span><br><span class="line">│ max_threads │ <span class="number">4</span>     │       <span class="number">1</span> │ The maximum <span class="built_in">number</span> <span class="keyword">of</span> threads <span class="keyword">to</span> <span class="keyword">execute</span> the request. <span class="keyword">By</span> <span class="keyword">default</span>, it <span class="keyword">is</span> determined automatically. │ ᴺᵁᴸᴸ │ ᴺᵁᴸᴸ │        <span class="number">0</span> │ MaxThreads │</span><br><span class="line">└─────────────┴───────┴─────────┴───────────────────────────────────────────────────────────────────────────────────────────────────┴──────┴──────┴──────────┴────────────┘</span><br></pre></td></tr></table></figure>
<h4 id="Q1-1-2"><a href="#Q1-1-2" class="headerlink" title="Q1.1"></a>Q1.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(LO_EXTENDEDPRICE * LO_DISCOUNT) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> (toYear(LO_ORDERDATE) = <span class="number">1993</span>) <span class="keyword">AND</span> ((LO_DISCOUNT &gt;= <span class="number">1</span>) <span class="keyword">AND</span> (LO_DISCOUNT &lt;= <span class="number">3</span>)) <span class="keyword">AND</span> (LO_QUANTITY &lt; <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">┌────────revenue─┐</span><br><span class="line">│ <span class="number">46310268722641</span> │</span><br><span class="line">└────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.226</span> sec. Processed <span class="number">94.38</span> million <span class="keyword">rows</span>, <span class="number">755.01</span> MB (<span class="number">417.85</span> million <span class="keyword">rows</span>/s., <span class="number">3.34</span> GB/s.) </span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.195</span> sec. Processed <span class="number">94.38</span> million <span class="keyword">rows</span>, <span class="number">755.01</span> MB (<span class="number">484.98</span> million <span class="keyword">rows</span>/s., <span class="number">3.88</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q1-2-2"><a href="#Q1-2-2" class="headerlink" title="Q1.2"></a>Q1.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(LO_EXTENDEDPRICE * LO_DISCOUNT) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> (toYYYYMM(LO_ORDERDATE) = <span class="number">199401</span>) <span class="keyword">AND</span> ((LO_DISCOUNT &gt;= <span class="number">4</span>) <span class="keyword">AND</span> (LO_DISCOUNT &lt;= <span class="number">6</span>)) <span class="keyword">AND</span> ((LO_QUANTITY &gt;= <span class="number">26</span>) <span class="keyword">AND</span> (LO_QUANTITY &lt;= <span class="number">35</span>))</span><br><span class="line"></span><br><span class="line">┌───────revenue─┐</span><br><span class="line">│ <span class="number">9979491062883</span> │</span><br><span class="line">└───────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.034</span> sec. Processed <span class="number">8.07</span> million <span class="keyword">rows</span>, <span class="number">64.55</span> MB (<span class="number">239.67</span> million <span class="keyword">rows</span>/s., <span class="number">1.92</span> GB/s.) </span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.063</span> sec. Processed <span class="number">8.07</span> million <span class="keyword">rows</span>, <span class="number">64.55</span> MB (<span class="number">127.89</span> million <span class="keyword">rows</span>/s., <span class="number">1.02</span> GB/s.) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="Q1-3-2"><a href="#Q1-3-2" class="headerlink" title="Q1.3"></a>Q1.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">sum</span>(LO_EXTENDEDPRICE * LO_DISCOUNT) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> (toISOWeek(LO_ORDERDATE) = <span class="number">6</span>) <span class="keyword">AND</span> (toYear(LO_ORDERDATE) = <span class="number">1994</span>) <span class="keyword">AND</span> ((LO_DISCOUNT &gt;= <span class="number">5</span>) <span class="keyword">AND</span> (LO_DISCOUNT &lt;= <span class="number">7</span>)) <span class="keyword">AND</span> ((LO_QUANTITY &gt;= <span class="number">26</span>) <span class="keyword">AND</span> (LO_QUANTITY &lt;= <span class="number">35</span>))</span><br><span class="line"></span><br><span class="line">┌───────revenue─┐</span><br><span class="line">│ <span class="number">2709633167278</span> │</span><br><span class="line">└───────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.043</span> sec. Processed <span class="number">2.03</span> million <span class="keyword">rows</span>, <span class="number">16.23</span> MB (<span class="number">46.78</span> million <span class="keyword">rows</span>/s., <span class="number">374.26</span> MB/s.) </span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.022</span> sec. Processed <span class="number">2.03</span> million <span class="keyword">rows</span>, <span class="number">16.23</span> MB (<span class="number">91.09</span> million <span class="keyword">rows</span>/s., <span class="number">728.68</span> MB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q2-1-2"><a href="#Q2-1-2" class="headerlink" title="Q2.1"></a>Q2.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE),</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> P_CATEGORY = <span class="string">&#x27;MFGR#12&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;AMERICA&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">280 rows in set. Elapsed: 1.723 sec. Processed 622.26 million rows, 6.42 GB (361.17 million rows/s., 3.73 GB/s.) </span><br><span class="line">280 rows in set. Elapsed: 1.791 sec. Processed 622.26 million rows, 6.42 GB (347.43 million rows/s., 3.59 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q2-2-2"><a href="#Q2-2-2" class="headerlink" title="Q2.2"></a>Q2.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE),</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> P_BRAND &gt;= <span class="string">&#x27;MFGR#2221&#x27;</span> <span class="keyword">AND</span> P_BRAND &lt;= <span class="string">&#x27;MFGR#2228&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;ASIA&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">56 rows in set. Elapsed: 1.463 sec. Processed 622.26 million rows, 5.80 GB (425.29 million rows/s., 3.96 GB/s.) </span><br><span class="line">56 rows in set. Elapsed: 1.470 sec. Processed 622.26 million rows, 5.80 GB (423.20 million rows/s., 3.94 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q2-3-2"><a href="#Q2-3-2" class="headerlink" title="Q2.3"></a>Q2.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE),</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> (P_BRAND = <span class="string">&#x27;MFGR#2239&#x27;</span>) <span class="keyword">AND</span> (S_REGION = <span class="string">&#x27;EUROPE&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    P_BRAND <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">sum</span>(LO_REVENUE)─┬─<span class="keyword">year</span>─┬─P_BRAND───┐</span><br><span class="line">│     <span class="number">68153063027</span> │ <span class="number">1992</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│     <span class="number">67009399598</span> │ <span class="number">1993</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│     <span class="number">67185675813</span> │ <span class="number">1994</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│     <span class="number">67988181065</span> │ <span class="number">1995</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│     <span class="number">67265572303</span> │ <span class="number">1996</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│     <span class="number">66922128523</span> │ <span class="number">1997</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│     <span class="number">38630664245</span> │ <span class="number">1998</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">└─────────────────┴──────┴───────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.659</span> sec. Processed <span class="number">622.26</span> million <span class="keyword">rows</span>, <span class="number">5.80</span> GB (<span class="number">943.74</span> million <span class="keyword">rows</span>/s., <span class="number">8.79</span> GB/s.) </span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">1.337</span> sec. Processed <span class="number">622.26</span> million <span class="keyword">rows</span>, <span class="number">5.80</span> GB (<span class="number">465.51</span> million <span class="keyword">rows</span>/s., <span class="number">4.34</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-1-2"><a href="#Q3-1-2" class="headerlink" title="Q3.1"></a>Q3.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    C_NATION,</span><br><span class="line">    S_NATION,</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> C_REGION = <span class="string">&#x27;ASIA&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;ASIA&#x27;</span> <span class="keyword">AND</span> <span class="keyword">year</span> &gt;= <span class="number">1992</span> <span class="keyword">AND</span> <span class="keyword">year</span> &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    C_NATION,</span><br><span class="line">    S_NATION,</span><br><span class="line">    <span class="keyword">year</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    revenue <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">150 rows in set. Elapsed: 2.488 sec. Processed 566.91 million rows, 5.68 GB (227.84 million rows/s., 2.28 GB/s.) </span><br><span class="line">150 rows in set. Elapsed: 1.254 sec. Processed 566.91 million rows, 5.68 GB (452.10 million rows/s., 4.53 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-2-2"><a href="#Q3-2-2" class="headerlink" title="Q3.2"></a>Q3.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> C_NATION = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> S_NATION = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> <span class="keyword">year</span> &gt;= <span class="number">1992</span> <span class="keyword">AND</span> <span class="keyword">year</span> &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    <span class="keyword">year</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    revenue <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">600 rows in set. Elapsed: 1.272 sec. Processed 566.91 million rows, 5.77 GB (445.80 million rows/s., 4.54 GB/s.) </span><br><span class="line">600 rows in set. Elapsed: 0.966 sec. Processed 566.91 million rows, 5.77 GB (587.07 million rows/s., 5.98 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-3-2"><a href="#Q3-3-2" class="headerlink" title="Q3.3"></a>Q3.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> ((C_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (C_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> ((S_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (S_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> (<span class="keyword">year</span> &gt;= <span class="number">1992</span>) <span class="keyword">AND</span> (<span class="keyword">year</span> &lt;= <span class="number">1997</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    <span class="keyword">year</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    revenue <span class="keyword">DESC</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.979</span> sec. Processed <span class="number">566.91</span> million <span class="keyword">rows</span>, <span class="number">4.63</span> GB (<span class="number">579.03</span> million <span class="keyword">rows</span>/s., <span class="number">4.73</span> GB/s.)</span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.889</span> sec. Processed <span class="number">566.91</span> million <span class="keyword">rows</span>, <span class="number">4.63</span> GB (<span class="number">637.83</span> million <span class="keyword">rows</span>/s., <span class="number">5.21</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-4-2"><a href="#Q3-4-2" class="headerlink" title="Q3.4"></a>Q3.4</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE) <span class="keyword">AS</span> revenue</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> ((C_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (C_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> ((S_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (S_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> (toYYYYMM(LO_ORDERDATE) = <span class="number">199712</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    <span class="keyword">year</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    revenue <span class="keyword">DESC</span></span><br><span class="line"></span><br><span class="line">┌─C_CITY─────┬─S_CITY─────┬─<span class="keyword">year</span>─┬───revenue─┐</span><br><span class="line">│ UNITED KI1 │ UNITED KI1 │ <span class="number">1997</span> │ <span class="number">495955110</span> │</span><br><span class="line">│ UNITED KI5 │ UNITED KI5 │ <span class="number">1997</span> │ <span class="number">421714882</span> │</span><br><span class="line">│ UNITED KI5 │ UNITED KI1 │ <span class="number">1997</span> │ <span class="number">387387637</span> │</span><br><span class="line">│ UNITED KI1 │ UNITED KI5 │ <span class="number">1997</span> │ <span class="number">380708672</span> │</span><br><span class="line">└────────────┴────────────┴──────┴───────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.036</span> sec. Processed <span class="number">8.09</span> million <span class="keyword">rows</span>, <span class="number">66.07</span> MB (<span class="number">221.65</span> million <span class="keyword">rows</span>/s., <span class="number">1.81</span> GB/s.) </span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.020</span> sec. Processed <span class="number">8.09</span> million <span class="keyword">rows</span>, <span class="number">66.07</span> MB (<span class="number">402.92</span> million <span class="keyword">rows</span>/s., <span class="number">3.29</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q4-1-2"><a href="#Q4-1-2" class="headerlink" title="Q4.1"></a>Q4.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    C_NATION,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE - LO_SUPPLYCOST) <span class="keyword">AS</span> profit</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> (C_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> (S_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> ((P_MFGR = <span class="string">&#x27;MFGR#1&#x27;</span>) <span class="keyword">OR</span> (P_MFGR = <span class="string">&#x27;MFGR#2&#x27;</span>))</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    C_NATION</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    C_NATION <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">35</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">5.067</span> sec. Processed <span class="number">622.26</span> million <span class="keyword">rows</span>, <span class="number">8.72</span> GB (<span class="number">122.80</span> million <span class="keyword">rows</span>/s., <span class="number">1.72</span> GB/s.) </span><br><span class="line"><span class="number">35</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">2.791</span> sec. Processed <span class="number">622.26</span> million <span class="keyword">rows</span>, <span class="number">8.72</span> GB (<span class="number">222.97</span> million <span class="keyword">rows</span>/s., <span class="number">3.12</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q4-2-2"><a href="#Q4-2-2" class="headerlink" title="Q4.2"></a>Q4.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    S_NATION,</span><br><span class="line">    P_CATEGORY,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE - LO_SUPPLYCOST) <span class="keyword">AS</span> profit</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> C_REGION = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;AMERICA&#x27;</span> <span class="keyword">AND</span> (<span class="keyword">year</span> = <span class="number">1997</span> <span class="keyword">OR</span> <span class="keyword">year</span> = <span class="number">1998</span>) <span class="keyword">AND</span> (P_MFGR = <span class="string">&#x27;MFGR#1&#x27;</span> <span class="keyword">OR</span> P_MFGR = <span class="string">&#x27;MFGR#2&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    S_NATION,</span><br><span class="line">    P_CATEGORY</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    S_NATION <span class="keyword">ASC</span>,</span><br><span class="line">    P_CATEGORY <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">100 rows in set. Elapsed: 0.804 sec. Processed 149.77 million rows, 2.25 GB (186.21 million rows/s., 2.80 GB/s.) </span><br><span class="line">100 rows in set. Elapsed: 0.752 sec. Processed 149.77 million rows, 2.25 GB (199.13 million rows/s., 2.99 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q4-3-2"><a href="#Q4-3-2" class="headerlink" title="Q4.3"></a>Q4.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toYear(LO_ORDERDATE) <span class="keyword">AS</span> <span class="keyword">year</span>,</span><br><span class="line">    S_CITY,</span><br><span class="line">    P_BRAND,</span><br><span class="line">    <span class="keyword">sum</span>(LO_REVENUE - LO_SUPPLYCOST) <span class="keyword">AS</span> profit</span><br><span class="line"><span class="keyword">FROM</span> lineorder_flat</span><br><span class="line"><span class="keyword">WHERE</span> S_NATION = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> (<span class="keyword">year</span> = <span class="number">1997</span> <span class="keyword">OR</span> <span class="keyword">year</span> = <span class="number">1998</span>) <span class="keyword">AND</span> P_CATEGORY = <span class="string">&#x27;MFGR#14&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span>,</span><br><span class="line">    S_CITY,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">year</span> <span class="keyword">ASC</span>,</span><br><span class="line">    S_CITY <span class="keyword">ASC</span>,</span><br><span class="line">    P_BRAND <span class="keyword">ASC</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">800 rows in set. Elapsed: 0.561 sec. Processed 149.77 million rows, 2.32 GB (266.84 million rows/s., 4.13 GB/s.) </span><br><span class="line">800 rows in set. Elapsed: 0.483 sec. Processed 149.77 million rows, 2.32 GB (309.80 million rows/s., 4.80 GB/s.) </span><br></pre></td></tr></table></figure>
<h3 id="多表关联测试-1"><a href="#多表关联测试-1" class="headerlink" title="多表关联测试"></a>多表关联测试</h3><p>在<a href="https://www.dorisdb.com/zh-CN/blog/1.8">DorisDB vs Clickhouse SSB性能测试对比报告</a>, 不知道是不是疏漏了, Doris在测试时设置了<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> global  <span class="comment">parallel_fragment_exec_instance_num  = 8</span>;</span><br></pre></td></tr></table></figure><br>但没有写有没有在clickhouse测试时设置SETTINGS max_threads=8;<br>由于我的环境只有四个4 cpu, 所以我这里设置为4.<br>通过以下命令可知, lineorder每个分片数据文件大概6.4G(压缩后), 我的环境内存只有8G, 不确定能否都缓存了</p>
<p>这里还需要注意两个问题:</p>
<ol>
<li>clickhouse分布式表相比单表关联更加不友好, JOIN要改为GLOBAL JOIN</li>
<li>JOIN操作时一定要把数据量小的表放在右边(这会导致SQL改写更加麻烦)<blockquote>
<p>详见<a href="https://fuxkdb.com/2020/08/28/2020-08-28-ClickHouse%E6%9F%A5%E8%AF%A2%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8LEFT-JOIN%E6%94%B9RIGHT-JOIN%E7%9A%84%E5%A4%A7%E5%9D%91/">ClickHouse查询分布式表LEFT JOIN改RIGHT JOIN的大坑</a></p>
</blockquote>
</li>
</ol>
<p>所以我对<a href="https://www.dorisdb.com/zh-CN/blog/1.8">DorisDB vs Clickhouse SSB性能测试对比报告</a>中的多表关联测试SQL进行了<code>微调</code></p>
<h4 id="Q1-1-3"><a href="#Q1-1-3" class="headerlink" title="Q1.1"></a>Q1.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (D_YEAR = <span class="number">1993</span>) <span class="keyword">AND</span> ((LO_DISCOUNT &gt;= <span class="number">1</span>) <span class="keyword">AND</span> (LO_DISCOUNT &lt;= <span class="number">3</span>)) <span class="keyword">AND</span> (LO_QUANTITY &lt; <span class="number">25</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">┌────────REVENUE─┐</span><br><span class="line">│ <span class="number">21881848590256</span> │</span><br><span class="line">└────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">1.496</span> sec. Processed <span class="number">600.04</span> million <span class="keyword">rows</span>, <span class="number">4.80</span> GB (<span class="number">401.10</span> million <span class="keyword">rows</span>/s., <span class="number">3.21</span> GB/s.) </span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">1.424</span> sec. Processed <span class="number">600.04</span> million <span class="keyword">rows</span>, <span class="number">4.80</span> GB (<span class="number">421.33</span> million <span class="keyword">rows</span>/s., <span class="number">3.37</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q1-2-3"><a href="#Q1-2-3" class="headerlink" title="Q1.2"></a>Q1.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (D_YEARMONTHNUM = <span class="number">199401</span>) <span class="keyword">AND</span> ((LO_DISCOUNT &gt;= <span class="number">4</span>) <span class="keyword">AND</span> (LO_DISCOUNT &lt;= <span class="number">6</span>)) <span class="keyword">AND</span> ((LO_QUANTITY &gt;= <span class="number">26</span>) <span class="keyword">AND</span> (LO_QUANTITY &lt;= <span class="number">35</span>))</span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">┌───────REVENUE─┐</span><br><span class="line">│ <span class="number">1829705342413</span> │</span><br><span class="line">└───────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">1.366</span> sec. Processed <span class="number">600.04</span> million <span class="keyword">rows</span>, <span class="number">4.80</span> GB (<span class="number">439.39</span> million <span class="keyword">rows</span>/s., <span class="number">3.52</span> GB/s.) </span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.659</span> sec. Processed <span class="number">600.04</span> million <span class="keyword">rows</span>, <span class="number">4.80</span> GB (<span class="number">910.87</span> million <span class="keyword">rows</span>/s., <span class="number">7.29</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q1-3-3"><a href="#Q1-3-3" class="headerlink" title="Q1.3"></a>Q1.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (D_WEEKNUMINYEAR = <span class="number">6</span>) <span class="keyword">AND</span> (D_YEAR = <span class="number">1994</span>) <span class="keyword">AND</span> ((LO_DISCOUNT &gt;= <span class="number">5</span>) <span class="keyword">AND</span> (LO_DISCOUNT &lt;= <span class="number">7</span>)) <span class="keyword">AND</span> ((LO_QUANTITY &gt;= <span class="number">26</span>) <span class="keyword">AND</span> (LO_QUANTITY &lt;= <span class="number">35</span>))</span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">┌──────REVENUE─┐</span><br><span class="line">│ <span class="number">407995993835</span> │</span><br><span class="line">└──────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.678</span> sec. Processed <span class="number">600.04</span> million <span class="keyword">rows</span>, <span class="number">4.80</span> GB (<span class="number">885.40</span> million <span class="keyword">rows</span>/s., <span class="number">7.08</span> GB/s.) </span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">1.377</span> sec. Processed <span class="number">600.04</span> million <span class="keyword">rows</span>, <span class="number">4.80</span> GB (<span class="number">435.84</span> million <span class="keyword">rows</span>/s., <span class="number">3.49</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q2-1-3"><a href="#Q2-1-3" class="headerlink" title="Q2.1"></a>Q2.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE, D_YEAR, P_BRAND</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> part <span class="keyword">ON</span> LO_PARTKEY = P_PARTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),<span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> P_CATEGORY = <span class="string">&#x27;MFGR#12&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;AMERICA&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> D_YEAR, P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> D_YEAR, P_BRAND</span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">280 rows in set. Elapsed: 4.367 sec. Processed 601.81 million rows, 8.45 GB (137.81 million rows/s., 1.94 GB/s.) </span><br><span class="line">280 rows in set. Elapsed: 2.667 sec. Processed 601.81 million rows, 8.45 GB (225.69 million rows/s., 3.17 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q2-2-3"><a href="#Q2-2-3" class="headerlink" title="Q2.2"></a>Q2.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE, D_YEAR, P_BRAND</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> part <span class="keyword">ON</span> LO_PARTKEY = P_PARTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),<span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> P_BRAND <span class="keyword">BETWEEN</span> <span class="string">&#x27;MFGR#2221&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;MFGR#2228&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;ASIA&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> D_YEAR, P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> D_YEAR, P_BRAND</span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">56 rows in set. Elapsed: 4.498 sec. Processed 601.67 million rows, 8.45 GB (133.78 million rows/s., 1.88 GB/s.) </span><br><span class="line">56 rows in set. Elapsed: 1.554 sec. Processed 601.67 million rows, 8.45 GB (387.23 million rows/s., 5.44 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q2-3-3"><a href="#Q2-3-3" class="headerlink" title="Q2.3"></a>Q2.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE,</span><br><span class="line">    D_YEAR,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> part <span class="keyword">ON</span> LO_PARTKEY = P_PARTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (P_BRAND = <span class="string">&#x27;MFGR#2239&#x27;</span>) <span class="keyword">AND</span> (S_REGION = <span class="string">&#x27;EUROPE&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR <span class="keyword">ASC</span>,</span><br><span class="line">    P_BRAND <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">┌──LO_REVENUE─┬─D_YEAR─┬─P_BRAND───┐</span><br><span class="line">│ <span class="number">65751589723</span> │   <span class="number">1992</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│ <span class="number">64532844801</span> │   <span class="number">1993</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│ <span class="number">64722599002</span> │   <span class="number">1994</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│ <span class="number">65616432683</span> │   <span class="number">1995</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│ <span class="number">64802884686</span> │   <span class="number">1996</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│ <span class="number">64485541165</span> │   <span class="number">1997</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">│ <span class="number">37276536361</span> │   <span class="number">1998</span> │ MFGR<span class="comment">#2239 │</span></span><br><span class="line">└─────────────┴────────┴───────────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">2.569</span> sec. Processed <span class="number">601.64</span> million <span class="keyword">rows</span>, <span class="number">8.45</span> GB (<span class="number">234.18</span> million <span class="keyword">rows</span>/s., <span class="number">3.29</span> GB/s.) </span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">2.577</span> sec. Processed <span class="number">601.64</span> million <span class="keyword">rows</span>, <span class="number">8.45</span> GB (<span class="number">233.47</span> million <span class="keyword">rows</span>/s., <span class="number">3.28</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-1-3"><a href="#Q3-1-3" class="headerlink" title="Q3.1"></a>Q3.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> C_NATION, S_NATION, D_YEAR, <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),<span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> C_REGION = <span class="string">&#x27;ASIA&#x27;</span> <span class="keyword">AND</span> S_REGION = <span class="string">&#x27;ASIA&#x27;</span><span class="keyword">AND</span> D_YEAR &gt;= <span class="number">1992</span> <span class="keyword">AND</span> D_YEAR &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> C_NATION, S_NATION, D_YEAR</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> D_YEAR <span class="keyword">ASC</span>, LO_REVENUE <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">150 rows in set. Elapsed: 10.190 sec. Processed 605.04 million rows, 8.66 GB (59.38 million rows/s., 850.20 MB/s.) </span><br><span class="line"></span><br><span class="line">150 rows in set. Elapsed: 12.960 sec. Processed 605.04 million rows, 8.66 GB (46.69 million rows/s., 668.51 MB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-2-3"><a href="#Q3-2-3" class="headerlink" title="Q3.2"></a>Q3.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> C_CITY, S_CITY, D_YEAR, <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),<span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> C_NATION = <span class="string">&#x27;UNITED STATES&#x27;</span> <span class="keyword">AND</span> S_NATION = <span class="string">&#x27;UNITED STATES&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> D_YEAR &gt;= <span class="number">1992</span> <span class="keyword">AND</span> D_YEAR &lt;= <span class="number">1997</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> C_CITY, S_CITY, D_YEAR</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> D_YEAR <span class="keyword">ASC</span>, LO_REVENUE <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">600 rows in set. Elapsed: 5.926 sec. Processed 603.60 million rows, 8.66 GB (101.85 million rows/s., 1.46 GB/s.) </span><br><span class="line">600 rows in set. Elapsed: 5.743 sec. Processed 603.60 million rows, 8.66 GB (105.10 million rows/s., 1.51 GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-3-3"><a href="#Q3-3-3" class="headerlink" title="Q3.3"></a>Q3.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    D_YEAR,</span><br><span class="line">    <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> ((C_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (C_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> ((S_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (S_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> (D_YEAR &gt;= <span class="number">1992</span>) <span class="keyword">AND</span> (D_YEAR &lt;= <span class="number">1997</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    D_YEAR</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR <span class="keyword">ASC</span>,</span><br><span class="line">    LO_REVENUE <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">3.445</span> sec. Processed <span class="number">603.31</span> million <span class="keyword">rows</span>, <span class="number">8.65</span> GB (<span class="number">175.11</span> million <span class="keyword">rows</span>/s., <span class="number">2.51</span> GB/s.) </span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">3.300</span> sec. Processed <span class="number">603.31</span> million <span class="keyword">rows</span>, <span class="number">8.65</span> GB (<span class="number">182.79</span> million <span class="keyword">rows</span>/s., <span class="number">2.62</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q3-4-3"><a href="#Q3-4-3" class="headerlink" title="Q3.4"></a>Q3.4</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    D_YEAR,</span><br><span class="line">    <span class="keyword">SUM</span>(LO_REVENUE) <span class="keyword">AS</span> LO_REVENUE</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> ((C_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (C_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> ((S_CITY = <span class="string">&#x27;UNITED KI1&#x27;</span>) <span class="keyword">OR</span> (S_CITY = <span class="string">&#x27;UNITED KI5&#x27;</span>)) <span class="keyword">AND</span> (D_YEARMONTH = <span class="string">&#x27;Dec1997&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    C_CITY,</span><br><span class="line">    S_CITY,</span><br><span class="line">    D_YEAR</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR <span class="keyword">ASC</span>,</span><br><span class="line">    LO_REVENUE <span class="keyword">DESC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">┌─C_CITY─────┬─S_CITY─────┬─D_YEAR─┬─LO_REVENUE─┐</span><br><span class="line">│ UNITED KI1 │ UNITED KI1 │   <span class="number">1997</span> │  <span class="number">481119563</span> │</span><br><span class="line">│ UNITED KI5 │ UNITED KI5 │   <span class="number">1997</span> │  <span class="number">386477033</span> │</span><br><span class="line">│ UNITED KI5 │ UNITED KI1 │   <span class="number">1997</span> │  <span class="number">378048353</span> │</span><br><span class="line">│ UNITED KI1 │ UNITED KI5 │   <span class="number">1997</span> │  <span class="number">366630529</span> │</span><br><span class="line">└────────────┴────────────┴────────┴────────────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">3.455</span> sec. Processed <span class="number">603.31</span> million <span class="keyword">rows</span>, <span class="number">8.65</span> GB (<span class="number">174.63</span> million <span class="keyword">rows</span>/s., <span class="number">2.50</span> GB/s.) </span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">3.330</span> sec. Processed <span class="number">603.31</span> million <span class="keyword">rows</span>, <span class="number">8.65</span> GB (<span class="number">181.19</span> million <span class="keyword">rows</span>/s., <span class="number">2.60</span> GB/s.</span><br></pre></td></tr></table></figure>
<h4 id="Q4-1-3"><a href="#Q4-1-3" class="headerlink" title="Q4.1"></a>Q4.1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    C_NATION,</span><br><span class="line">    <span class="keyword">SUM</span>(LO_REVENUE) - <span class="keyword">SUM</span>(LO_SUPPLYCOST) <span class="keyword">AS</span> PROFIT</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> part <span class="keyword">ON</span> LO_PARTKEY = P_PARTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (C_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> (S_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> ((P_MFGR = <span class="string">&#x27;MFGR#1&#x27;</span>) <span class="keyword">OR</span> (P_MFGR = <span class="string">&#x27;MFGR#2&#x27;</span>))</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    C_NATION</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR <span class="keyword">ASC</span>,</span><br><span class="line">    C_NATION <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">35</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">15.560</span> sec. Processed <span class="number">606.44</span> million <span class="keyword">rows</span>, <span class="number">13.47</span> GB (<span class="number">38.97</span> million <span class="keyword">rows</span>/s., <span class="number">865.71</span> MB/s.) </span><br><span class="line"><span class="number">35</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">9.494</span> sec. Processed <span class="number">606.44</span> million <span class="keyword">rows</span>, <span class="number">13.47</span> GB (<span class="number">63.88</span> million <span class="keyword">rows</span>/s., <span class="number">1.42</span> GB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q4-2-3"><a href="#Q4-2-3" class="headerlink" title="Q4.2"></a>Q4.2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    S_NATION,</span><br><span class="line">    P_CATEGORY,</span><br><span class="line">    <span class="keyword">SUM</span>(LO_REVENUE) - <span class="keyword">SUM</span>(LO_SUPPLYCOST) <span class="keyword">AS</span> PROFIT</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> part <span class="keyword">ON</span> LO_PARTKEY = P_PARTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (C_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> (S_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> ((D_YEAR = <span class="number">1997</span>) <span class="keyword">OR</span> (D_YEAR = <span class="number">1998</span>)) <span class="keyword">AND</span> ((P_MFGR = <span class="string">&#x27;MFGR#1&#x27;</span>) <span class="keyword">OR</span> (P_MFGR = <span class="string">&#x27;MFGR#2&#x27;</span>))</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    S_NATION,</span><br><span class="line">    P_CATEGORY</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR <span class="keyword">ASC</span>,</span><br><span class="line">    S_NATION <span class="keyword">ASC</span>,</span><br><span class="line">    P_CATEGORY <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">16.109</span> sec. Processed <span class="number">606.44</span> million <span class="keyword">rows</span>, <span class="number">13.47</span> GB (<span class="number">37.64</span> million <span class="keyword">rows</span>/s., <span class="number">836.01</span> MB/s.) </span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">18.048</span> sec. Processed <span class="number">606.44</span> million <span class="keyword">rows</span>, <span class="number">13.47</span> GB (<span class="number">33.60</span> million <span class="keyword">rows</span>/s., <span class="number">746.35</span> MB/s.) </span><br></pre></td></tr></table></figure>
<h4 id="Q4-3-3"><a href="#Q4-3-3" class="headerlink" title="Q4.3"></a>Q4.3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    S_CITY,</span><br><span class="line">    P_BRAND,</span><br><span class="line">    <span class="keyword">SUM</span>(LO_REVENUE) - <span class="keyword">SUM</span>(LO_SUPPLYCOST) <span class="keyword">AS</span> PROFIT</span><br><span class="line"><span class="keyword">FROM</span> lineorder</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> customer <span class="keyword">ON</span> LO_CUSTKEY = C_CUSTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> supplier <span class="keyword">ON</span> LO_SUPPKEY = S_SUPPKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> part <span class="keyword">ON</span> LO_PARTKEY = P_PARTKEY</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dates <span class="keyword">ON</span> LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), <span class="string">&#x27;(\\d&#123;4&#125;)(\\d&#123;2&#125;)(\\d&#123;2&#125;)&#x27;</span>, <span class="string">&#x27;\\1-\\2-\\3&#x27;</span>))</span><br><span class="line"><span class="keyword">WHERE</span> (C_REGION = <span class="string">&#x27;AMERICA&#x27;</span>) <span class="keyword">AND</span> (S_NATION = <span class="string">&#x27;UNITED STATES&#x27;</span>) <span class="keyword">AND</span> ((D_YEAR = <span class="number">1997</span>) <span class="keyword">OR</span> (D_YEAR = <span class="number">1998</span>)) <span class="keyword">AND</span> (P_CATEGORY = <span class="string">&#x27;MFGR#14&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR,</span><br><span class="line">    S_CITY,</span><br><span class="line">    P_BRAND</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    D_YEAR <span class="keyword">ASC</span>,</span><br><span class="line">    S_CITY <span class="keyword">ASC</span>,</span><br><span class="line">    P_BRAND <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">SETTINGS</span> max_threads = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">800</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">15.685</span> sec. Processed <span class="number">606.44</span> million <span class="keyword">rows</span>, <span class="number">13.47</span> GB (<span class="number">38.66</span> million <span class="keyword">rows</span>/s., <span class="number">858.94</span> MB/s.) </span><br><span class="line"><span class="number">800</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">14.838</span> sec. Processed <span class="number">606.44</span> million <span class="keyword">rows</span>, <span class="number">13.47</span> GB (<span class="number">40.87</span> million <span class="keyword">rows</span>/s., <span class="number">907.94</span> MB/s.) </span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;DorisDB-vs-ClickHouse-SSB对比测试&quot;&gt;&lt;a href=&quot;#DorisDB-vs-ClickHouse-SSB对比测试&quot; class=&quot;headerlink&quot; title=&quot;DorisDB vs ClickHouse SSB对比测试&quot;&gt;&lt;/a&gt;DorisDB vs ClickHouse SSB对比测试&lt;/h1&gt;&lt;h2 id=&quot;TL-DR&quot;&gt;&lt;a href=&quot;#TL-DR&quot; class=&quot;headerlink&quot; title=&quot;TL;DR&quot;&gt;&lt;/a&gt;TL;DR&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;进行本次测试时对DorisDB了解甚微&lt;/li&gt;
&lt;li&gt;本次测试由于服务器资源有限, 没有严格遵循单一变量原则进行测试&lt;/li&gt;
&lt;li&gt;本次测试有一定参考意义&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;数据导入速度&quot;&gt;&lt;a href=&quot;#数据导入速度&quot; class=&quot;headerlink&quot; title=&quot;数据导入速度&quot;&gt;&lt;/a&gt;数据导入速度&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ClickHouse: 3500s&lt;/li&gt;
&lt;li&gt;DorisDB: 5160s&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;数据压缩情况-通过磁盘占用空间比较&quot;&gt;&lt;a href=&quot;#数据压缩情况-通过磁盘占用空间比较&quot; class=&quot;headerlink&quot; title=&quot;数据压缩情况(通过磁盘占用空间比较)&quot;&gt;&lt;/a&gt;数据压缩情况(通过磁盘占用空间比较)&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ClickHouse: 85.2G&lt;/li&gt;
&lt;li&gt;DorisDB: 132G&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;查询速度&quot;&gt;&lt;a href=&quot;#查询速度&quot; class=&quot;headerlink&quot; title=&quot;查询速度&quot;&gt;&lt;/a&gt;查询速度&lt;/h3&gt;&lt;h4 id=&quot;单表查询&quot;&gt;&lt;a href=&quot;#单表查询&quot; class=&quot;headerlink&quot; title=&quot;单表查询&quot;&gt;&lt;/a&gt;单表查询&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/ClickHouse%20vs%20DorisDB/%E5%8D%95%E8%A1%A8.png&quot; alt=&quot;单表&quot;&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;DorisDB1&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;DorisDB2&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;ClickHouse1&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;ClickHouse2&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q1.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;350&lt;/td&gt;
&lt;td&gt;290&lt;/td&gt;
&lt;td&gt;226&lt;/td&gt;
&lt;td&gt;195&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q1.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;270&lt;/td&gt;
&lt;td&gt;190&lt;/td&gt;
&lt;td&gt;34&lt;/td&gt;
&lt;td&gt;63&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q1.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;310&lt;/td&gt;
&lt;td&gt;240&lt;/td&gt;
&lt;td&gt;43&lt;/td&gt;
&lt;td&gt;22&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q2.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;410&lt;/td&gt;
&lt;td&gt;370&lt;/td&gt;
&lt;td&gt;1,723&lt;/td&gt;
&lt;td&gt;1,791&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q2.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;780&lt;/td&gt;
&lt;td&gt;720&lt;/td&gt;
&lt;td&gt;1,463&lt;/td&gt;
&lt;td&gt;1,470&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q2.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;340&lt;/td&gt;
&lt;td&gt;280&lt;/td&gt;
&lt;td&gt;659&lt;/td&gt;
&lt;td&gt;1,337&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,560&lt;/td&gt;
&lt;td&gt;860&lt;/td&gt;
&lt;td&gt;3,488&lt;/td&gt;
&lt;td&gt;1,254&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,080&lt;/td&gt;
&lt;td&gt;790&lt;/td&gt;
&lt;td&gt;1,272&lt;/td&gt;
&lt;td&gt;966&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;250&lt;/td&gt;
&lt;td&gt;290&lt;/td&gt;
&lt;td&gt;979&lt;/td&gt;
&lt;td&gt;889&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.4&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;230&lt;/td&gt;
&lt;td&gt;260&lt;/td&gt;
&lt;td&gt;36&lt;/td&gt;
&lt;td&gt;20&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q4.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;870&lt;/td&gt;
&lt;td&gt;720&lt;/td&gt;
&lt;td&gt;5,067&lt;/td&gt;
&lt;td&gt;2,791&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q4.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;720&lt;/td&gt;
&lt;td&gt;490&lt;/td&gt;
&lt;td&gt;804&lt;/td&gt;
&lt;td&gt;752&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q4.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;510&lt;/td&gt;
&lt;td&gt;380&lt;/td&gt;
&lt;td&gt;561&lt;/td&gt;
&lt;td&gt;482&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&quot;多表查询&quot;&gt;&lt;a href=&quot;#多表查询&quot; class=&quot;headerlink&quot; title=&quot;多表查询&quot;&gt;&lt;/a&gt;多表查询&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/ClickHouse%20vs%20DorisDB/%E5%A4%9A%E8%A1%A8.png&quot; alt=&quot;多表&quot;&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;DorisDB1&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;DorisDB2&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;ClickHouse1&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;ClickHouse2&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q1.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;450&lt;/td&gt;
&lt;td&gt;490&lt;/td&gt;
&lt;td&gt;1,496&lt;/td&gt;
&lt;td&gt;1,424&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q1.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;410&lt;/td&gt;
&lt;td&gt;450&lt;/td&gt;
&lt;td&gt;1,366&lt;/td&gt;
&lt;td&gt;659&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q1.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;510&lt;/td&gt;
&lt;td&gt;340&lt;/td&gt;
&lt;td&gt;678&lt;/td&gt;
&lt;td&gt;1,377&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q2.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,560&lt;/td&gt;
&lt;td&gt;1,600&lt;/td&gt;
&lt;td&gt;4,360&lt;/td&gt;
&lt;td&gt;2,667&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q2.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,690&lt;/td&gt;
&lt;td&gt;1,060&lt;/td&gt;
&lt;td&gt;4,498&lt;/td&gt;
&lt;td&gt;1,554&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q2.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;780&lt;/td&gt;
&lt;td&gt;1,150&lt;/td&gt;
&lt;td&gt;2,569&lt;/td&gt;
&lt;td&gt;2,577&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;3,480&lt;/td&gt;
&lt;td&gt;3,700&lt;/td&gt;
&lt;td&gt;10,190&lt;/td&gt;
&lt;td&gt;12,960&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,320&lt;/td&gt;
&lt;td&gt;1,850&lt;/td&gt;
&lt;td&gt;5,926&lt;/td&gt;
&lt;td&gt;5,743&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,030&lt;/td&gt;
&lt;td&gt;1,040&lt;/td&gt;
&lt;td&gt;3,445&lt;/td&gt;
&lt;td&gt;3,300&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q3.4&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,330&lt;/td&gt;
&lt;td&gt;1,170&lt;/td&gt;
&lt;td&gt;3,455&lt;/td&gt;
&lt;td&gt;3,330&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q4.1&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;3,480&lt;/td&gt;
&lt;td&gt;3,750&lt;/td&gt;
&lt;td&gt;15,560&lt;/td&gt;
&lt;td&gt;9,494&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q4.2&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;2,830&lt;/td&gt;
&lt;td&gt;3,170&lt;/td&gt;
&lt;td&gt;16,109&lt;/td&gt;
&lt;td&gt;18,048&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Q4.3&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;1,560&lt;/td&gt;
&lt;td&gt;2,140&lt;/td&gt;
&lt;td&gt;15,685&lt;/td&gt;
&lt;td&gt;14,838&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
    
      <category term="ClickHouse" scheme="http://fuxkdb.com/tags/ClickHouse/"/>
    
      <category term="DorisDB" scheme="http://fuxkdb.com/tags/DorisDB/"/>
    
  </entry>
  
  <entry>
    <title>MHA Failover测试</title>
    <link href="http://fuxkdb.com/2021/02/07/2021-02-07-MHA-Failover%E6%B5%8B%E8%AF%95/"/>
    <id>http://fuxkdb.com/2021/02/07/2021-02-07-MHA-Failover测试/</id>
    <published>2021-02-07T14:16:00.000Z</published>
    <updated>2021-02-07T14:18:21.289Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><table>
<thead>
<tr>
<th>用例</th>
<th>ping_type=CONNECT</th>
<th>ping_type=INSERT</th>
</tr>
</thead>
<tbody>
<tr>
<td>master too many connection</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>master hang</td>
<td>不会触发failover</td>
<td>会触发failover且成功</td>
</tr>
<tr>
<td>仅manager无法连通master</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, 且无法ssh slave1</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, 且无法ssh slave1和slave2</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, ssh到slave1后无法连通master</td>
<td>不会触发failover</td>
<td>不会触发failover</td>
</tr>
<tr>
<td>manager无法连通master, ssh到slave1和slave2后均无法连通master</td>
<td>会触发failover且成功</td>
<td>会触发failover且成功(长连接断开后才会)</td>
</tr>
<tr>
<td>master宕机前slave1也宕机了</td>
<td>会触发failover, 但failover失败</td>
<td>会触发failover, 但failover失败</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 io_thread stop了</td>
<td>会failover且成功</td>
<td>会failover且成功</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 io_thread error了</td>
<td>会failover且成功</td>
<td>会failover且成功</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 sql_thread stop了</td>
<td>会failover且成功</td>
<td>会failover且成功</td>
</tr>
<tr>
<td>master挂了, 在此之前slave-1 sql_thread error了</td>
<td>会触发failover, 但failover失败</td>
<td>会触发failover, 但failover失败</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master: 172.16.120.10 centos-1 主 + proxysql</span><br><span class="line">slave1: 172.16.120.11 centos-2 从 + proxysql</span><br><span class="line">slave2: 172.16.120.12 centos-3 从 + proxysql</span><br><span class="line">172.16.120.13 centos-4 mha manager</span><br></pre></td></tr></table></figure>
<p>MHA配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat /etc/masterha/conf/masterha_default.cnf </span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="comment"># mysql user and password，此处的密码不能加引号</span></span><br><span class="line"><span class="attr">user</span>=mha</span><br><span class="line"><span class="attr">password</span>=xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#replication_user</span></span><br><span class="line"><span class="attr">repl_user</span>=repler</span><br><span class="line"><span class="attr">repl_password</span>=xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment">#checking master every 3 second </span></span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用短连接检测，默认是长连接</span></span><br><span class="line"><span class="attr">ping_type</span>=INSERT</span><br><span class="line"><span class="comment">#ping_type=CONNECT</span></span><br><span class="line"><span class="comment">#下面会测试两种type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ssh user</span></span><br><span class="line"><span class="attr">ssh_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="comment">#发送邮件脚本</span></span><br><span class="line"><span class="attr">report_script</span>=/etc/masterha/scripts/send_report</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点工作目录</span></span><br><span class="line"><span class="attr">remote_workdir</span>=/masterha/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#cat /etc/masterha/conf/cls_new.cnf</span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="comment">#workdir on the management server</span></span><br><span class="line"><span class="attr">manager_workdir</span>=/masterha/cls_new/</span><br><span class="line"><span class="attr">manager_log</span>=/masterha/cls_new/manager.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#workdir on the node for mysql server</span></span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql_3358/data/</span><br><span class="line"></span><br><span class="line"><span class="comment">#自动故障VIP切换调用脚本</span></span><br><span class="line"><span class="attr">master_ip_failover_script</span>=/etc/masterha/scripts/master_ip_failover_vip --vip=<span class="number">172.16</span>.<span class="number">120.128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#手动故障切换调用脚本</span></span><br><span class="line"><span class="attr">master_ip_online_change_script</span>=/etc/masterha/scripts/master_ip_online_change_vip --vip=<span class="number">172.16</span>.<span class="number">120.128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检测master的可用性</span></span><br><span class="line"><span class="attr">secondary_check_script</span>=masterha_secondary_check -s <span class="number">172.16</span>.<span class="number">120.11</span> -s <span class="number">172.16</span>.<span class="number">120.12</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.10</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.11</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.12</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-too-many-connection"><a href="#用例测试-master-too-many-connection" class="headerlink" title="[用例测试] master too many connection"></a>[用例测试] master too many connection</h2><h3 id="ping-type-CONNECT"><a href="#ping-type-CONNECT" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:43:29 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      7 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |      2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |     14 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 952922 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 952902 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |      2 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    120 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     58 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     17 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |      0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">43</span>:<span class="number">30</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%max_connec%&#x27;</span>;</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| Variable_name         | Value   |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| extra_max_connections | 1       |</span><br><span class="line">| max_connect_errors    | 1000000 |</span><br><span class="line">| max_connections       | 1024    |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">49</span>:<span class="number">34</span> [dbms_monitor]&gt; <span class="keyword">set</span> <span class="keyword">global</span> max_connections=<span class="number">5</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec);</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover"><a href="#结论-不会failover" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 11:42:57 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Oct  9 11:42:57 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri Oct  9 11:42:57 2020 - [info]  OK.</span><br><span class="line">Fri Oct  9 11:42:57 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Oct  9 11:42:57 2020 - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:49:51 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Too many connections at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">1040 (Too many connections)</span><br><span class="line">Fri Oct  9 11:49:51 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">51</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">54</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">1040</span> (Too many connections)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">54</span> <span class="number">2020</span> - [info] Got MySQL <span class="keyword">error</span> <span class="number">1040</span>, but this <span class="keyword">is</span> <span class="keyword">not</span> a MySQL crash. Continue health check..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">1040</span> (Too many connections)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">49</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Got MySQL <span class="keyword">error</span> <span class="number">1040</span>, but this <span class="keyword">is</span> <span class="keyword">not</span> a MySQL crash. Continue health check..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">1040</span> (Too many connections)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">50</span>:<span class="number">00</span> <span class="number">2020</span> - [info] Got MySQL <span class="keyword">error</span> <span class="number">1040</span>, but this <span class="keyword">is</span> <span class="keyword">not</span> a MySQL crash. Continue health check..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT"><a href="#ping-type-INSERT" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:55:13 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      1 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |     18 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     16 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      8 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 953626 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 953606 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |      6 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    103 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     41 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |      1 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |      0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2160</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34660</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |      <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">55</span>:<span class="number">14</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%max_connec%&#x27;</span>;</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| Variable_name         | Value   |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">| extra_max_connections | 1       |</span><br><span class="line">| max_connect_errors    | 1000000 |</span><br><span class="line">| max_connections       | 1024    |</span><br><span class="line">+<span class="comment">-----------------------+---------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">55</span>:<span class="number">19</span> [dbms_monitor]&gt; <span class="keyword">set</span> <span class="keyword">global</span> max_connections=<span class="number">5</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:55:25 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      6 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      3 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     31 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      3 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 953641 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 953621 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |      0 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    118 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     56 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |      6 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |      0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2160</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34660</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |      <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>ping_type=INSERT是长连接, 不会感知<code>too many connection</code>.</p>
<p>手动kill掉mha连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:55:29 [dbms_monitor]&gt; kill 2160;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-1"><a href="#结论-不会failover-1" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 11:54:48 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Oct  9 11:54:48 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri Oct  9 11:54:48 2020 - [info]  OK.</span><br><span class="line">Fri Oct  9 11:54:48 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Oct  9 11:54:48 2020 - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">48</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">48</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">48</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:42 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:42 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:42 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">ERROR 1040 (HY000): Too many connections</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not writable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">ERROR 1040 (HY000): Too many connections</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not writable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:43 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:45 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:45 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:48 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:48 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:51 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:51 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:54 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:54 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:57 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br><span class="line"><span class="string">Fri Oct  9 11:56:57 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..</span></span><br><span class="line"><span class="string">Fri Oct  9 11:57:00 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-hang"><a href="#用例测试-master-hang" class="headerlink" title="[用例测试] master hang"></a>[用例测试] master hang</h2><h3 id="ping-type-CONNECT-1"><a href="#ping-type-CONNECT-1" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>master hang不好模拟, 这里间接模拟. 需要将ping_select的执行的<code>select 1</code>改为<code>select innodb_table</code>查询一个innodb表</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">ping_select</span>($) </span>&#123;</span><br><span class="line">  <span class="keyword">my</span> $self = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">my</span> $log  = $self-&gt;&#123;logger&#125;;</span><br><span class="line">  <span class="keyword">my</span> $dbh  = $self-&gt;&#123;dbh&#125;;</span><br><span class="line">  <span class="keyword">my</span> ( $query, $sth, $href );</span><br><span class="line">  <span class="keyword">eval</span> &#123;</span><br><span class="line">    $dbh-&gt;&#123;RaiseError&#125; = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">#$sth = $dbh-&gt;prepare(&quot;SELECT 1 As Value&quot;);</span></span><br><span class="line">    $sth = $dbh-&gt;prepare(<span class="string">&quot;SELECT 1 As Value from infra.chk_masterha limit 1&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>然后修改<code>innodb_thread_concurrency</code>值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:25:34 [dbms_monitor]&gt; set global innodb_thread_concurrency=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>手动执行一个查询, 查询innodb表, 这样mha的select会被阻塞</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:25:45 [dbms_monitor]&gt; select sleep(600) from infra.chk_masterha limit 1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@localhost 12:29:09 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info                                              | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |     16 |                                                               | NULL                                              |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      4 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |      1 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      4 |                                                               | NULL                                              |         1 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 955662 | Master has sent all binlog to slave; waiting for more updates | NULL                                              |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 955642 | Master has sent all binlog to slave; waiting for more updates | NULL                                              |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     11 |                                                               | NULL                                              |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |     96 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     34 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |      6 |                                                               | NULL                                              |         0 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |     21 | User sleep                                                    | <span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">600</span>) <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2260</span> | root     | localhost           | dbms_monitor       | <span class="keyword">Query</span>            |      <span class="number">0</span> | <span class="keyword">starting</span>                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span>                                  |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2303</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34982</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">20</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2305</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34988</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">17</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2308</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34994</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">14</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2310</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">34998</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">11</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2312</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35002</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">8</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2314</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35006</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">5</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2317</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35010</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">2</span> | Sending <span class="keyword">data</span>                                                  | <span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">As</span> <span class="keyword">Value</span> <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">19</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-mha-manager可能报错退出"><a href="#结论-不会failover-mha-manager可能报错退出" class="headerlink" title="结论: 不会failover, mha manager可能报错退出"></a>结论: 不会failover, mha manager可能报错退出</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 12:28:44 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Fri Oct  9 12:28:44 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri Oct  9 12:28:44 2020 - [info]  OK.</span><br><span class="line">Fri Oct  9 12:28:44 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Fri Oct  9 12:28:44 2020 - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">44</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">44</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:53 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">53</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">timeout</span> <span class="keyword">on</span> MySQL Ping(<span class="keyword">CONNECT</span>) <span class="keyword">child</span> process <span class="keyword">and</span> killed it! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">435.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">28</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:59 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:28:59 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">timeout</span> <span class="keyword">on</span> MySQL Ping(<span class="keyword">CONNECT</span>) <span class="keyword">child</span> process <span class="keyword">and</span> killed it! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">435.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">47</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">手动ctrl+c终止select sleep(600) from infra.chk_masterha limit 1后, mha manager报错退出了</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Fri Oct  9 12:30:49 2020 - [warning] Got error when monitoring master:  at /usr/local/share/perl5/MHA/MasterMonitor.pm line 489.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:30:49 2020 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln491] Target master&#x27;</span>s advisory <span class="keyword">lock</span> <span class="keyword">is</span> already held <span class="keyword">by</span> someone. Please <span class="keyword">check</span> whether you monitor the same <span class="keyword">master</span> <span class="keyword">from</span> multiple <span class="keyword">monitoring</span> processes.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">error</span>][/usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/MasterMonitor.pm, ln511] <span class="keyword">Error</span> happened <span class="keyword">on</span> health checking.  <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/masterha_manager line <span class="number">50.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">error</span>][/usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/MasterMonitor.pm, ln525] <span class="keyword">Error</span> happened <span class="keyword">on</span> <span class="keyword">monitoring</span> servers.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">30</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Got <span class="keyword">exit</span> code <span class="number">1</span> (<span class="keyword">Not</span> <span class="keyword">master</span> dead).</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-1"><a href="#ping-type-INSERT-1" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>master hang不好模拟, 这里间接模拟. 修改<code>innodb_thread_concurrency</code>值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:25:34 [dbms_monitor]&gt; set global innodb_thread_concurrency=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>手动执行一个查询, 查询innodb表, 这样mha的insert会被阻塞</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:35:21 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time   | State                                                         | Info                                                                                                 | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |      3 |                                                               | NULL                                                                                                 |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |      1 |                                                               | NULL                                                                                                 |         1 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |      8 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |      1 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1256 | repler   | 172.16.120.11:59594 | NULL               | Binlog Dump GTID | 956039 | Master has sent all binlog to slave; waiting for more updates | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1257 | repler   | 172.16.120.12:56540 | NULL               | Binlog Dump GTID | 956019 | Master has sent all binlog to slave; waiting for more updates | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     28 |                                                               | NULL                                                                                                 |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    113 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |     51 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     13 |                                                               | NULL                                                                                                 |         0 |             0 |</span><br><span class="line">| 1943 | root     | localhost           | dbms_monitor       | Query            |     15 | User sleep                                                    | <span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">600</span>) <span class="keyword">from</span> infra.chk_masterha <span class="keyword">limit</span> <span class="number">1</span>                                                    |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2260</span> | root     | localhost           | dbms_monitor       | <span class="keyword">Query</span>            |      <span class="number">0</span> | <span class="keyword">starting</span>                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span>                                                                                     |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2395</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35206</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">13</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2398</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35208</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">11</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2400</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">32908</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |     <span class="number">10</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2401</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35216</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">8</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2403</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">58066</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">7</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2404</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35222</span> | <span class="literal">NULL</span>               | <span class="keyword">Query</span>            |      <span class="number">5</span> | <span class="keyword">update</span>                                                        | <span class="keyword">INSERT</span> <span class="keyword">INTO</span> infra.chk_masterha <span class="keyword">values</span> (<span class="number">1</span>,<span class="keyword">unix_timestamp</span>()) <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> val=unix_timestam |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">18</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover"><a href="#结论-会failover" class="headerlink" title="结论: 会failover"></a>结论: 会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 12:35:00 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 12:35:01 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">01</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:16 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:16 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:16 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:17 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:19 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:19 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not writable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:22 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:22 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not writable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:23 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:25 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:27 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">start down vipRTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:827239</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:8822-10390</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:827239</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:8822-10390</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Fri Oct  9 12:35:28 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000008</span>:<span class="number">811243</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Fri Oct  9 12:35:28 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 811243, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-10390,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Fri Oct  9 12:35:28 2020 - [info] Executing master IP activate script:</span><br><span class="line">Fri Oct  9 12:35:28 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 44798. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009123527.log if it takes time..</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">28</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-10390</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">29</span> <span class="number">2020</span> - [info] Sending mail..</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="以下情况都不会failover-即便是手动failover指定了-–master-state-dead-也不行"><a href="#以下情况都不会failover-即便是手动failover指定了-–master-state-dead-也不行" class="headerlink" title="以下情况都不会failover, 即便是手动failover指定了 –master_state=dead 也不行"></a>以下情况都不会failover, 即便是手动failover指定了 –master_state=dead 也不行</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">our</span> @ALIVE_ERROR_CODES = (</span><br><span class="line">  <span class="number">1040</span>,    <span class="comment"># ER_CON_COUNT_ERROR                  -- too many connection</span></span><br><span class="line">  <span class="number">1042</span>,    <span class="comment"># ER_BAD_HOST_ERROR                   -- Can&#x27;t get hostname for your address</span></span><br><span class="line">  <span class="number">1043</span>,    <span class="comment"># ER_HANDSHAKE_ERROR                  -- Bad handshake</span></span><br><span class="line">  <span class="number">1044</span>,    <span class="comment"># ER_DBACCESS_DENIED_ERROR            -- Access denied for user &#x27;%s&#x27;@&#x27;%s&#x27; to database &#x27;%s&#x27;</span></span><br><span class="line">  <span class="number">1045</span>,    <span class="comment"># ER_ACCESS_DENIED_ERROR              -- Access denied for user &#x27;%s&#x27;@&#x27;%s&#x27; (using password: %s)</span></span><br><span class="line">  <span class="number">1129</span>,    <span class="comment"># ER_HOST_IS_BLOCKED                  -- Host &#x27;%s&#x27; is blocked because of many connection errors; unblock with &#x27;mysqladmin flush-hosts&#x27;</span></span><br><span class="line">  <span class="number">1130</span>,    <span class="comment"># ER_HOST_NOT_PRIVILEGED              -- Host &#x27;%s&#x27; is not allowed to connect to this MySQL server</span></span><br><span class="line">  <span class="number">1203</span>,    <span class="comment"># ER_TOO_MANY_USER_CONNECTIONS        -- User %s already has more than &#x27;max_user_connections&#x27; active connections</span></span><br><span class="line">  <span class="number">1226</span>,    <span class="comment"># ER_USER_LIMIT_REACHED               -- User &#x27;%s&#x27; has exceeded the &#x27;%s&#x27; resource (current value: %ld)</span></span><br><span class="line">  <span class="number">1251</span>,    <span class="comment"># ER_NOT_SUPPORTED_AUTH_MODE          -- Client does not support authentication protocol requested by server; consider upgrading MySQL client</span></span><br><span class="line">  <span class="number">1275</span>,    <span class="comment"># ER_SERVER_IS_IN_SECURE_AUTH_MODE    -- Server is running in --secure-auth mode, but &#x27;%s&#x27;@&#x27;%s&#x27; has a password in the old format; please change the password to the new format</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>详见<a href="https://yunwiki.new.net/pages/viewpage.action?pageId=60342333">MHA-为什么too many connection不会failover?</a></p>
<h2 id="用例测试-master-与-mha-manager间网络异常1"><a href="#用例测试-master-与-mha-manager间网络异常1" class="headerlink" title="[用例测试] master 与 mha manager间网络异常1"></a>[用例测试] master 与 mha manager间网络异常1</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 正常 –&gt; S1 &lt;– 正常 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-2"><a href="#ping-type-CONNECT-2" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-2"><a href="#结论-不会failover-2" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:29:50 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:29:51 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:32:56 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 15:32:56 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:00 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:01 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:06 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:06 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:12 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:14 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">18</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:18 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:18 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">24</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:24 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:26 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:27 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">27</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:30 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:30 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:33:33 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">34</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-2"><a href="#ping-type-INSERT-2" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>此时manager工作正常, 因为ping_type=INSERT是长连接.</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:39:31 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |    22 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     9 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |     2 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |    19 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |   111 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    49 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 10898 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 10873 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2627 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2836</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">35810</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">15</span>:<span class="number">39</span>:<span class="number">39</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">2836</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-3"><a href="#结论-不会failover-3" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:37:54 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:37:55 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">37</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:46 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:46 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:46 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:47 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:51 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:52 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:55 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:39:58 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">01</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:01 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:04 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">04</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">07</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:07 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:10 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">10</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">10</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">13</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:13 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:40:14 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">14</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常2"><a href="#用例测试-master-与-mha-manager间网络异常2" class="headerlink" title="[用例测试] master 与 mha manager间网络异常2"></a>[用例测试] master 与 mha manager间网络异常2</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 不通 –&gt; S1 &lt;– 正常 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-3"><a href="#ping-type-CONNECT-3" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>此时manager已经无法连通slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.349 ms</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.651 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.349/0.500/0.651/0.151 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 15:48:55 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-4"><a href="#结论-不会failover-4" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:48:03 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:48:05 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:40 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 15:50:40 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">40</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:44 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:45 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:45 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:47 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">50</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:50 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:50 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:53 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">53</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">53</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:56 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:58 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:58 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:50:59 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">59</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:02 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:02 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">51</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:05 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:51:09 2020 - [warning] Got timeout on Secondary Check child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-3"><a href="#ping-type-INSERT-3" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>此时manager已经无法连通slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.349 ms</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.651 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.349/0.500/0.651/0.151 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 15:48:55 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>因为ping_type=INSERT是长连接,1 所以此时无异常.</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:39:45 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |     3 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |     1 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     8 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |    11 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     8 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |    89 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    26 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     3 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 11837 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 11812 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2627 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">2953</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">36174</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">0</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">15</span>:<span class="number">55</span>:<span class="number">18</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">2953</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-5"><a href="#结论-不会failover-5" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 15:52:43 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 15:52:44 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">44</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">45</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:24 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:24 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:24 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:29 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:29 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:30 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">33</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:33 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:36 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">36</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">36</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">39</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:39 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:39 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:39 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:42 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">42</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">45</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:45 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:48 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">48</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">48</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">51</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:51 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:51 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:54 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">54</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">57</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:55:57 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:00 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 15:56:03 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常3"><a href="#用例测试-master-与-mha-manager间网络异常3" class="headerlink" title="[用例测试] master 与 mha manager间网络异常3"></a>[用例测试] master 与 mha manager间网络异常3</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 不通 –&gt; S1 &lt;– 正常 –&gt; master<br>Manager &lt;– 不通 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-4"><a href="#ping-type-CONNECT-4" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>slave-1, slave-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.442 ms</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.441 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.441/0.441/0.442/0.021 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 16:44:27 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2 </span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">[root@centos-4 16:44:30 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ping centos-3</span></span><br><span class="line">PING centos-3 (172.16.120.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-3 (172.16.120.12): icmp_seq=1 ttl=64 time=0.335 ms</span><br><span class="line">64 bytes from centos-3 (172.16.120.12): icmp_seq=2 ttl=64 time=0.575 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-3 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.335/0.455/0.575/0.120 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 16:44:34 /usr/local/share/perl5/MHA]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-3</span></span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-6"><a href="#结论-不会failover-6" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 16:43:25 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:43:26 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">26</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:45:55 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 16:45:55 2020 - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">59</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:45:59 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:00 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:00 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:05 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:05 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:08 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">08</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">08</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">08</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:11 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:13 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:13 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:46:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">15</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-4"><a href="#ping-type-INSERT-4" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>slave-1,slave-2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ping centos-2</span></span><br><span class="line">PING centos-2 (172.16.120.11) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.352 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.352/0.352/0.352/0.000 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 17:52:38 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">ping centos-3</span></span><br><span class="line">PING centos-3 (172.16.120.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from centos-3 (172.16.120.12): icmp_seq=1 ttl=64 time=0.221 ms</span><br><span class="line">^C</span><br><span class="line">--- centos-3 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.221/0.221/0.221/0.000 ms</span><br><span class="line"></span><br><span class="line">[root@centos-4 17:52:41 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-2 </span></span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">[root@centos-4 17:52:44 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">ssh centos-3</span></span><br></pre></td></tr></table></figure>
<p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>由于ping_type=INSERT是长连接, 所以无异常</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 17:48:11 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |    14 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    32 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 18936 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 18911 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 3192 | proxysql | 172.16.120.11:33786 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 3238 | proxysql | 172.16.120.12:59006 | NULL               | Sleep            |     4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3245 | proxysql | 172.16.120.11:33888 | NULL               | Sleep            |    14 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 3262 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">3268</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">36868</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">17</span>:<span class="number">53</span>:<span class="number">37</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">3268</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-7"><a href="#结论-不会failover-7" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 17:50:48 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 17:50:49 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">50</span>:<span class="number">49</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:43 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:43 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:43 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:48 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">ssh: connect to host 172.16.120.11 port 22: Connection timed out</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is NOT reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:48 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:49 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:52 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:55 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">55</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:58 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:58 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 17:53:58 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:01 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">01</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">04</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:04 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:07 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">07</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">07</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">10</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:10 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:10 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:10 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:13 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">13</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line">ssh: <span class="keyword">connect</span> <span class="keyword">to</span> host <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> port <span class="number">22</span>: <span class="keyword">Connection</span> timed <span class="keyword">out</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> <span class="keyword">NOT</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">At</span> <span class="keyword">least</span> one <span class="keyword">of</span> <span class="keyword">monitoring</span> servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this script. This <span class="keyword">is</span> likely a network problem. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">17</span>:<span class="number">54</span>:<span class="number">16</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:16 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 17:54:16 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常4"><a href="#用例测试-master-与-mha-manager间网络异常4" class="headerlink" title="[用例测试] master 与 mha manager间网络异常4"></a>[用例测试] master 与 mha manager间网络异常4</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 正常 –&gt; S1 &lt;– 不通 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 正常 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-5"><a href="#ping-type-CONNECT-5" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-8"><a href="#结论-不会failover-8" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 16:05:55 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:05:56 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">05</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:43 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 16:06:43 2020 - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">43</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:47 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:48 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.12!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:48 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">50</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:53 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:53 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">1</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">59</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:06:59 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:01 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.12!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:01 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:05 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:05 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:07:05 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;</span>t respond..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-5"><a href="#ping-type-INSERT-5" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<p>由于ping_type=INSERT是长连接, 所以无异常</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:55:23 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time  | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |    19 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1249 | proxysql | 172.16.120.11:59582 | NULL               | Sleep            |     7 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1250 | proxysql | 172.16.120.12:56530 | NULL               | Sleep            |     4 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1254 | proxysql | 172.16.120.11:59592 | NULL               | Sleep            |    27 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |    14 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 1341 | mha      | 172.16.120.12:56698 | information_schema | Sleep            |   114 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |    51 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |     9 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 2409 | repler   | 172.16.120.11:32918 | NULL               | Binlog Dump GTID | 12703 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2411 | repler   | 172.16.120.12:58084 | NULL               | Binlog Dump GTID | 12678 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 2627 | root     | localhost           | dbms_monitor       | Query            |     0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">3022</span> | mha      | <span class="number">172.16</span><span class="number">.120</span><span class="number">.13</span>:<span class="number">36466</span> | <span class="literal">NULL</span>               | <span class="keyword">Sleep</span>            |     <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">16</span>:<span class="number">09</span>:<span class="number">44</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">3022</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-不会failover-9"><a href="#结论-不会failover-9" class="headerlink" title="结论: 不会failover"></a>结论: 不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 16:08:29 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 16:08:30 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:51 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:51 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:56 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.12!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:57 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br><span class="line"><span class="string">Fri Oct  9 16:09:57 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">09</span>:<span class="number">57</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">00</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:00 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">03</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:06 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:06 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:06 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] HealthCheck: Got <span class="keyword">timeout</span> <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>! <span class="keyword">at</span> /usr/<span class="keyword">local</span>/<span class="keyword">share</span>/perl5/MHA/HealthCheck.pm line <span class="number">344.</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">of</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should <span class="keyword">not</span> happen.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:12 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Secondary network <span class="keyword">check</span> script returned errors. <span class="keyword">Failover</span> should <span class="keyword">not</span> <span class="keyword">start</span> so checking <span class="keyword">server</span> <span class="keyword">status</span> again. <span class="keyword">Check</span> network <span class="keyword">settings</span> <span class="keyword">for</span> details.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">18</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:18 2020 - [warning] Connection failed 1 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:18 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:18 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">21</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:21 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span></span><br><span class="line"><span class="string">Master is reachable from 172.16.120.11!</span></span><br><span class="line"><span class="string">Fri Oct  9 16:10:21 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master-与-mha-manager间网络异常5"><a href="#用例测试-master-与-mha-manager间网络异常5" class="headerlink" title="[用例测试] master 与 mha manager间网络异常5"></a>[用例测试] master 与 mha manager间网络异常5</h2><blockquote>
<p>Manager &lt;– 不通 –&gt; Master<br>Manager &lt;– 正常 –&gt; S1 &lt;– 不通 –&gt; master<br>Manager &lt;– 正常 –&gt; S2 &lt;– 不通 –&gt; master</p>
</blockquote>
<h3 id="ping-type-CONNECT-6"><a href="#ping-type-CONNECT-6" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover-1"><a href="#结论-会failover-1" class="headerlink" title="结论: 会failover"></a>结论: 会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 18:21:13 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:21:14 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">14</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:07 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;</span>;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))</span><br><span class="line">Fri Oct  9 18:22:07 2020 - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">07</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:11 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:12 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">17</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:17 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [warning] SSH is NOT reachable.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:18 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:19 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:20 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stop </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:3084318</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:10391-19970</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:3084318</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:10391-19970</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:22:21 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000008</span>:<span class="number">3052407</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Fri Oct  9 18:22:21 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 3052407, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-19970,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Fri Oct  9 18:22:21 2020 - [info] Executing master IP activate script:</span><br><span class="line">Fri Oct  9 18:22:21 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 68999. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009182219.log if it takes time..</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-19970</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">22</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-6"><a href="#ping-type-INSERT-6" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>由于ping_type=INSERT是长连接, 所以无异常</p>
<p>kill连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 18:24:52 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id   | User     | Host                | db                 | Command          | Time | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| 1248 | proxysql | 172.16.120.10:58672 | NULL               | Sleep            |    1 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1264 | proxysql | 172.16.120.12:56552 | NULL               | Sleep            |    2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1343 | mha      | 172.16.120.11:59758 | information_schema | Sleep            |   74 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 1452 | proxysql | 172.16.120.10:59046 | NULL               | Sleep            |    2 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3192 | proxysql | 172.16.120.11:33786 | NULL               | Sleep            |    3 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3238 | proxysql | 172.16.120.12:59006 | NULL               | Sleep            |    1 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">| 3245 | proxysql | 172.16.120.11:33888 | NULL               | Sleep            |    2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 3262 | root     | localhost           | dbms_monitor       | Query            |    0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="number">3357</span> | repler   | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">34036</span> | <span class="literal">NULL</span>               | <span class="keyword">Binlog</span> Dump GTID |  <span class="number">142</span> | <span class="keyword">Master</span> has sent <span class="keyword">all</span> <span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">slave</span>; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 3359 | repler   | 172.16.120.12:59166 | NULL               | Binlog Dump GTID |  123 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 3364 | mha      | 172.16.120.13:37512 | NULL               | Sleep            |    2 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">+<span class="comment">------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">11 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">18</span>:<span class="number">26</span>:<span class="number">25</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">3364</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-长连接断开后才会failover-否则不会failover"><a href="#结论-长连接断开后才会failover-否则不会failover" class="headerlink" title="结论: 长连接断开后才会failover, 否则不会failover"></a>结论: 长连接断开后才会failover, 否则不会failover</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">Fri Oct  9 18:25:33 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] GTID failover mode = 1</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] Dead Servers:</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] Alive Servers:</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info] Alive Slaves:</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]     GTID ON</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Fri Oct  9 18:25:34 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">34</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">25</span>:<span class="number">35</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:44 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:44 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:44 2020 - [info] Executing SSH check script: exit 0</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:49 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">50</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">53</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (4))</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:53 2020 - [warning] Connection failed 3 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:54 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">4</span>))</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] SSH <span class="keyword">is</span> <span class="keyword">NOT</span> reachable.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Connecting <span class="keyword">to</span> a <span class="keyword">master</span> <span class="keyword">server</span> failed. Reading configuration <span class="keyword">file</span> /etc/masterha/conf/masterha_default.cnf <span class="keyword">and</span> /etc/masterha/conf/cls_new.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">all</span> servers <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">server</span> status..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/masterha_default.cnf..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2020</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> down!</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Terminating <span class="keyword">monitoring</span> script.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (<span class="keyword">Master</span> dead).</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] MHA::MasterFailover <span class="keyword">version</span> <span class="number">0.58</span>.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> GTID based failover.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Forcing <span class="keyword">shutdown</span> so that applications <span class="keyword">never</span> <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> master..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stop </span></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> <span class="keyword">old</span> <span class="keyword">master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> </span><br><span class="line">Fake!!! 原主库 rpl_semi_sync_master_enabled=<span class="number">0</span> rpl_semi_sync_slave_enabled=<span class="number">1</span> </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  done.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> set. Skipping explicit shutting down <span class="keyword">of</span> the dead master.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase completed.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000009</span>:<span class="number">3101017</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">19971</span><span class="number">-20041</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000009</span>:<span class="number">3101017</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">19971</span><span class="number">-20041</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Oldest slaves:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> <span class="keyword">Master</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Searching <span class="keyword">new</span> <span class="keyword">master</span> <span class="keyword">from</span> slaves..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration <span class="keyword">file</span>:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Non-candidate masters:</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> events..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">is</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="keyword">From</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) (<span class="keyword">new</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied.. </span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info]   done.</span><br><span class="line">Fri <span class="keyword">Oct</span>  <span class="number">9</span> <span class="number">18</span>:<span class="number">26</span>:<span class="number">58</span> <span class="number">2020</span> - [info] Getting <span class="keyword">new</span> <span class="keyword">master</span><span class="string">&#x27;s binlog name and position..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  mysql-bin.000008:3068991</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span><span class="string">&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;</span>repler<span class="string">&#x27;, MASTER_PASSWORD=&#x27;</span>xxx<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 3068991, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20041,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] Executing master IP activate script:</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;</span>mha<span class="string">&#x27;   --new_master_password=xxx</span></span><br><span class="line"><span class="string">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span></span><br><span class="line"><span class="string">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span></span><br><span class="line"><span class="string">Set read_only=0 on the new master.</span></span><br><span class="line"><span class="string">Creating app user on the new master..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  OK.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] ** Finished master recovery successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] * Phase 3: Master Recovery Phase completed.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] * Phase 4: Slaves Recovery Phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] * Phase 4.1: Starting Slaves in parallel..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 69850. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009182657.log if it takes time..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Log messages from 172.16.120.12 ...</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:58 2020 - [info]  gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20041,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] End of log messages from 172.16.120.12.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] All new slave servers recovered successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] * Phase 5: New master cleanup phase..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Resetting slave info on the new master..</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info]  172.16.120.11: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----- Failover Report -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeeded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Master 172.16.120.10(172.16.120.10:3358) is down!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Started automated(non-interactive) failover.</span></span><br><span class="line"><span class="string">Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Selected 172.16.120.11(172.16.120.11:3358) as a new master.</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.</span></span><br><span class="line"><span class="string">Fri Oct  9 18:26:59 2020 - [info] Sending mail..</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题1-部分slave宕机"><a href="#用例测试-master挂了-且slave也有问题1-部分slave宕机" class="headerlink" title="[用例测试] master挂了, 且slave也有问题1(部分slave宕机)"></a>[用例测试] master挂了, 且slave也有问题1(部分slave宕机)</h2><blockquote>
<p>master挂了, 在此之前slave-1宕机了</p>
</blockquote>
<h3 id="ping-type-CONNECT-7"><a href="#ping-type-CONNECT-7" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 关闭slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 10:28:35 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:28:37 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">37</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">CONNECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>
<p>关闭slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-2 10:19:38 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor       </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2118</span><br><span class="line">Server version: 5.7.31-34-log Percona Server (GPL), Release 34, Revision 2e68637</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2020 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@localhost 10:20:52 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<p>关闭后, mha manager仍然是正常的</p>
<p>关闭master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-1 10:20:35 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor                                              </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3413</span><br><span class="line">Server version: 5.7.31-34-log Percona Server (GPL), Release 34, Revision 2e68637</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2020 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@localhost 10:20:47 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会触发failover-但failover失败"><a href="#结论-会触发failover-但failover失败" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 10:50:38 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 10:50:38 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">38</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">38</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">38</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">41</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:41 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:44 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">44</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">47</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:47 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:48 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln492]  Server 172.16.120.11(172.16.120.11:3358) is dead, but must be alive! Check server settings.</span></span><br><span class="line"><span class="string">Sat Oct 10 10:50:49 2020 - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177] Got ERROR:  at /usr/local/share/perl5/MHA/MasterFailover.pm line 269.</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-7"><a href="#ping-type-INSERT-7" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>其实和connect应该是一样的, 不过还是走一遍流程</p>
<p>启动manager后, 关闭slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 10:59:07 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 10:59:09 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure>
<p>关闭slave-1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-2 10:56:24 /usr/local/Percona-Server-5.7.29-32-Linux.x86_64.ssl101]</span><br><span class="line"><span class="meta">#</span><span class="bash">2020-10-10T03:00:49.502943Z mysqld_safe mysqld from pid file /data/mysql_3358/run/mysql.pid ended</span></span><br></pre></td></tr></table></figure>
<p>关闭master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-1 11:07:08 ~]</span><br><span class="line"><span class="meta">#</span><span class="bash">mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor    </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 35</span><br><span class="line">Server version: 5.7.29-32-log Percona Server (GPL), Release 32, Revision 56bce88</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2020 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">root@localhost 11:07:09 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会触发failover-但failover失败-1"><a href="#结论-会触发failover-但failover失败-1" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:07:15 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)</span><br><span class="line">Sat Oct 10 11:07:15 2020 - [info] Executing SSH check script: exit 0</span><br><span class="line">Sat Oct 10 11:07:15 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12  --user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span><br><span class="line">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span><br><span class="line">Sat Oct 10 11:07:16 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span><br><span class="line">Sat Oct 10 11:07:16 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Sat Oct 10 11:07:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:07:18 2020 - [warning] Connection failed 2 time(s)..</span><br><span class="line">Sat Oct 10 11:07:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:07:21 2020 - [warning] Connection failed 3 time(s)..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Connection failed 4 time(s)..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Master is not reachable from health checker!</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [warning] SSH is reachable.</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat Oct 10 11:07:24 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Master is down!</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Terminating monitoring script.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Got exit code 20 (Master dead).</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] MHA::MasterFailover version 0.58.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] Starting master failover.</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] </span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Sat Oct 10 11:07:25 2020 - [info] </span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln492]  Server 172.16.120.11(172.16.120.11:3358) is dead, but must be alive! Check server settings.</span><br><span class="line">Sat Oct 10 11:07:26 2020 - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177] Got ERROR:  at /usr/local/share/perl5/MHA/MasterFailover.pm line 269.</span><br></pre></td></tr></table></figure>
<h3 id="总结-如不希望slave-1宕机影响failover-需要在配置文件中对slave-1设置ignore-fail-1"><a href="#总结-如不希望slave-1宕机影响failover-需要在配置文件中对slave-1设置ignore-fail-1" class="headerlink" title="总结: 如不希望slave-1宕机影响failover, 需要在配置文件中对slave-1设置ignore_fail=1"></a>总结: 如不希望slave-1宕机影响failover, 需要在配置文件中对slave-1设置ignore_fail=1</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">172.16</span>.<span class="number">120.11</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3358</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">ignore_fail</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题2-部分slave-io-thread-stop"><a href="#用例测试-master挂了-且slave也有问题2-部分slave-io-thread-stop" class="headerlink" title="[用例测试] master挂了, 且slave也有问题2(部分slave io_thread stop)"></a>[用例测试] master挂了, 且slave也有问题2(部分slave io_thread stop)</h2><blockquote>
<p>master挂了, 在此之前slave-1 io_thread stop了</p>
</blockquote>
<h3 id="ping-type-CONNECT-8"><a href="#ping-type-CONNECT-8" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 关闭slave-1 io_thread</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:13:58 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 11:13:59 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 11:14:00 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure>
<p>关闭slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:17:29 [dbms_monitor]&gt; stop slave io_thread;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:17:33 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">17</span>:<span class="number">49</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000011</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000009</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">407</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000011</span></span><br><span class="line">             Slave_IO_Running: <span class="keyword">No</span></span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates</span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>关闭io_thread后 manager仍然正常</p>
<p>关闭master</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:21:18 [dbms_monitor]&gt; insert into monitor_delay values(1,now());</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:21:39 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">21</span>:<span class="number">54</span> [dbms_monitor]&gt; <span class="keyword">shutdown</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:17:49 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 10:20:54 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover且成功"><a href="#结论-会failover且成功" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:22:12 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:22:12 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">12</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">15</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:15 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">18</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:21 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:22 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000011:486</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20042-20531</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000011:194</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20143-20530</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:22:23 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">23</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000007</span>:<span class="number">3182161</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">23</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.12&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 11:22:23 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3182161, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 11:22:23 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 11:22:23 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 77208. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010112222.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">24</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-20531</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>). Executed <span class="number">2</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">25</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<p>slave-1正常change到new master slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:21:44 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.12</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Master_Log_Pos: 3182161</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 681</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000007</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 3182161</span><br><span class="line">              Relay_Log_Space: 888</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120123358</span><br><span class="line">                  Master_UUID: 45e70f96-fcad-11ea-a2f0-0050563108d2</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20531</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">24</span>:<span class="number">39</span> [dbms_monitor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-8"><a href="#ping-type-INSERT-8" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager后, 关闭slave-1 io_thread</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:29:28 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:29:30 2020 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> supported. Skipping <span class="keyword">all</span> SSH <span class="keyword">and</span> Node <span class="keyword">package</span> checking.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Checking master_ip_failover_script <span class="keyword">status</span>:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Set</span> secondary <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Ping(<span class="keyword">INSERT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>
<p>关闭slave-1 io_thread</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:30:30 [dbms_monitor]&gt; stop slave io_thread;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:30:43 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">30</span>:<span class="number">45</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000012</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">18307</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">18480</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000012</span></span><br><span class="line">             Slave_IO_Running: <span class="keyword">No</span></span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">18307</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates</span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>关闭io_thread后 manager仍然正常</p>
<p>关闭master</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:31:40 [dbms_monitor]&gt; insert into monitor_delay values(2,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:31:45 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">31</span>:<span class="number">51</span> [dbms_monitor]&gt; <span class="keyword">shutdown</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>slave-1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:30:45 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:27:07 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="结论-会failover且成功-1"><a href="#结论-会failover且成功-1" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:33:09 2020 - [warning] SSH is reachable.</span><br><span class="line">Sat Oct 10 11:33:09 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to <span class="keyword">check</span> <span class="keyword">server</span> status..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/masterha_default.cnf..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">09</span> <span class="number">2020</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/masterha/conf/cls_new.cnf..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Checking <span class="keyword">slave</span> configurations..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> down!</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Terminating <span class="keyword">monitoring</span> script.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (<span class="keyword">Master</span> dead).</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] MHA::MasterFailover <span class="keyword">version</span> <span class="number">0.58</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">10</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] GTID <span class="keyword">failover</span> <span class="keyword">mode</span> = <span class="number">1</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Dead Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Alive Servers:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Alive Slaves:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> GTID based failover.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Forcing <span class="keyword">shutdown</span> so that applications <span class="keyword">never</span> <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> <span class="keyword">old</span> <span class="keyword">master</span>: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> </span><br><span class="line">RTNETLINK answers: Cannot assign requested address</span><br><span class="line">Fake!!! 原主库 rpl_semi_sync_master_enabled=<span class="number">0</span> rpl_semi_sync_slave_enabled=<span class="number">1</span> </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  done.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> set. Skipping explicit shutting down <span class="keyword">of</span> the dead master.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> <span class="keyword">Shutdown</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000012</span>:<span class="number">50590</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">20532</span><span class="number">-20745</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">file</span>/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> mysql-<span class="keyword">bin</span><span class="number">.000012</span>:<span class="number">18307</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">20532</span><span class="number">-20608</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Oldest slaves:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> <span class="keyword">Master</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Searching <span class="keyword">new</span> <span class="keyword">master</span> <span class="keyword">from</span> slaves..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration <span class="keyword">file</span>:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.29</span><span class="number">-32</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.31</span><span class="number">-34</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Non-candidate masters:</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> events..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">is</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line"><span class="keyword">From</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"> +<span class="comment">--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) (<span class="keyword">new</span> <span class="keyword">master</span>)</span><br><span class="line"> +<span class="comment">--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied.. </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info]   done.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">33</span>:<span class="number">11</span> <span class="number">2020</span> - [info] Getting <span class="keyword">new</span> <span class="keyword">master</span><span class="string">&#x27;s binlog name and position..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  mysql-bin.000007:3232182</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span><span class="string">&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;</span>repler<span class="string">&#x27;, MASTER_PASSWORD=&#x27;</span>xxx<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3232182, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] Executing master IP activate script:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;</span>mha<span class="string">&#x27;   --new_master_password=xxx</span></span><br><span class="line"><span class="string">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span></span><br><span class="line"><span class="string">RTNETLINK answers: File exists</span></span><br><span class="line"><span class="string">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span></span><br><span class="line"><span class="string">Set read_only=0 on the new master.</span></span><br><span class="line"><span class="string">Creating app user on the new master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  OK.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] ** Finished master recovery successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] * Phase 3: Master Recovery Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] * Phase 4: Slaves Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] * Phase 4.1: Starting Slaves in parallel..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info] -- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 78319. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010113310.log if it takes time..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] Log messages from 172.16.120.11 ...</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:11 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info]  gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,</span></span><br><span class="line"><span class="string">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.11(172.16.120.11:3358). Executed 2 events.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] End of log messages from 172.16.120.11.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] -- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] All new slave servers recovered successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] * Phase 5: New master cleanup phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:12 2020 - [info] Resetting slave info on the new master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info]  172.16.120.12: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info] Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----- Failover Report -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.12(172.16.120.12:3358) succeeded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Master 172.16.120.10(172.16.120.10:3358) is down!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Started automated(non-interactive) failover.</span></span><br><span class="line"><span class="string">Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Selected 172.16.120.12(172.16.120.12:3358) as a new master.</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): OK: Applying all logs succeeded.</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): OK: Activated master IP address.</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358): OK: Slave started, replicating from 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358): Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:33:13 2020 - [info] Sending mail..</span></span><br></pre></td></tr></table></figure>
<p>slave-1已经change到了slave-2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:32:04 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.12</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Master_Log_Pos: 3232182</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 32447</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000007</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 3232182</span><br><span class="line">              Relay_Log_Space: 32654</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120123358</span><br><span class="line">                  Master_UUID: 45e70f96-fcad-11ea-a2f0-0050563108d2</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20609-20745</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">34</span>:<span class="number">29</span> [dbms_monitor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题3-部分slave-io-thread-error"><a href="#用例测试-master挂了-且slave也有问题3-部分slave-io-thread-error" class="headerlink" title="[用例测试] master挂了, 且slave也有问题3(部分slave io_thread error)"></a>[用例测试] master挂了, 且slave也有问题3(部分slave io_thread error)</h2><blockquote>
<p>master挂了, 在此之前slave-1 io_thread error了</p>
</blockquote>
<h3 id="ping-type-CONNECT-9"><a href="#ping-type-CONNECT-9" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:58:40 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 11:58:41 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.13 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure><br>kill slave-1 io_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:04:35 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id  | User     | Host                | db           | Command          | Time | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">|   2 | proxysql | 172.16.120.12:33384 | NULL         | Sleep            |    9 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">|   3 | root     | localhost           | dbms_monitor | Query            |    0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|   <span class="number">4</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">34072</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">4</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|   <span class="number">6</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35090</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|   <span class="number">7</span> | repler   | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35092</span> | <span class="literal">NULL</span>         | <span class="keyword">Binlog</span> Dump GTID |  <span class="number">485</span> | <span class="keyword">Master</span> has sent <span class="keyword">all</span> <span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">slave</span>; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">|   8 | repler   | 172.16.120.12:33392 | NULL         | Binlog Dump GTID |  472 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 110 | proxysql | 172.16.120.10:34094 | NULL         | Sleep            |    4 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">+<span class="comment">-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">7 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">04</span>:<span class="number">46</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">7</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:05:20 [dbms_monitor]&gt; insert into monitor_delay values(6,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:05:02 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">|  4 | 2020-10-10 11:59:15 |</span><br><span class="line">|  5 | 2020-10-10 12:04:35 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">07</span>:<span class="number">32</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">               Slave_IO_State: Reconnecting <span class="keyword">after</span> a <span class="keyword">failed</span> <span class="keyword">master</span> <span class="keyword">event</span> <span class="keyword">read</span></span><br><span class="line">                  Master_Host: <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span></span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: <span class="number">3358</span></span><br><span class="line">                Connect_Retry: <span class="number">1</span></span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000014</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">778</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000003</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">605</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000014</span></span><br><span class="line">             Slave_IO_Running: Connecting</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">778</span></span><br><span class="line">              Relay_Log_Space: <span class="number">1317</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: <span class="literal">NULL</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">2003</span></span><br><span class="line">                Last_IO_Error: <span class="keyword">error</span> reconnecting <span class="keyword">to</span> <span class="keyword">master</span> <span class="string">&#x27;repler@172.16.120.10:3358&#x27;</span> - retry-<span class="built_in">time</span>: <span class="number">1</span>  retries: <span class="number">2</span></span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: <span class="number">120103358</span></span><br><span class="line">                  Master_UUID: <span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: <span class="number">0</span></span><br><span class="line">          SQL_Remaining_Delay: <span class="literal">NULL</span></span><br><span class="line">      Slave_SQL_Running_State: <span class="keyword">Slave</span> has <span class="keyword">read</span> <span class="keyword">all</span> relay <span class="keyword">log</span>; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: 201010 12:06:57</span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20748</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20748,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:04:42 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">|  4 | 2020-10-10 11:59:15 |</span><br><span class="line">|  5 | 2020-10-10 12:04:35 |</span><br><span class="line">|  6 | 2020-10-10 12:05:30 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:24 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-2"><a href="#结论-会failover且成功-2" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 12:11:18 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 12:11:18 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">18</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">19</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:21 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:24 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">24</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">27</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:27 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000014:1070</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20749</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000014:778</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20748</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:11:29 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000007</span>:<span class="number">3233250</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.12&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 12:11:29 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3233250, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20749,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 12:11:29 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 12:11:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span><br><span class="line">RTNETLINK answers: File exists</span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 81557. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010121128.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-20749</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>). Executed <span class="number">2</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-9"><a href="#ping-type-INSERT-9" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager后, 调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 12:14:59 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 12:15:00 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 12:15:01 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure></p>
<p>调整master防火墙, 禁止slave-1访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IPTABLES=&quot;/sbin/iptables&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.13 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT</span></span><br><span class="line"><span class="meta">$</span><span class="bash">IPTABLES -A INPUT -p tcp --syn -j DROP</span></span><br></pre></td></tr></table></figure></p>
<p>在master kill slave-1 io_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:13:11 [dbms_monitor]&gt; show processlist;</span><br><span class="line">+<span class="comment">----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">| Id | User     | Host                | db           | Command          | Time | State                                                         | Info             | Rows_sent | Rows_examined |</span><br><span class="line">+<span class="comment">----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">|  2 | proxysql | 172.16.120.12:33486 | NULL         | Sleep            |    9 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">|  3 | root     | localhost           | dbms_monitor | Query            |    0 | starting                                                      | <span class="keyword">show</span> <span class="keyword">processlist</span> |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|  <span class="number">4</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">34148</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">4</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|  <span class="number">5</span> | proxysql | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35190</span> | <span class="literal">NULL</span>         | <span class="keyword">Sleep</span>            |    <span class="number">2</span> |                                                               | <span class="literal">NULL</span>             |         <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">|  <span class="number">8</span> | repler   | <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">35200</span> | <span class="literal">NULL</span>         | <span class="keyword">Binlog</span> Dump GTID |  <span class="number">428</span> | <span class="keyword">Master</span> has sent <span class="keyword">all</span> <span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">slave</span>; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">|  9 | repler   | 172.16.120.12:33490 | NULL         | Binlog Dump GTID |  379 | Master has sent all binlog to slave; waiting for more updates | NULL             |         0 |             0 |</span><br><span class="line">| 13 | mha      | 172.16.120.13:40526 | NULL         | Sleep            |    0 |                                                               | NULL             |         0 |             0 |</span><br><span class="line">| 17 | proxysql | 172.16.120.10:34164 | NULL         | Sleep            |   14 |                                                               | NULL             |         1 |             0 |</span><br><span class="line">+<span class="comment">----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">20</span>:<span class="number">46</span> [dbms_monitor]&gt; <span class="keyword">kill</span> <span class="number">8</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:20:59 [dbms_monitor]&gt; truncate table monitor_delay;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:21:10 [dbms_monitor]&gt; insert into monitor_delay values(88,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 12:21:17 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:29 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Reconnecting after a failed master event read</span><br><span class="line">                  Master_Host: 172.16.120.10</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000015</span><br><span class="line">          Read_Master_Log_Pos: 85472</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 85645</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000015</span><br><span class="line">             Slave_IO_Running: Connecting</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 85472</span><br><span class="line">              Relay_Log_Space: 85852</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 2003</span><br><span class="line">                Last_IO_Error: error reconnecting to master &#x27;repler@172.16.120.10:3358&#x27; - retry-time: 1  retries: 1</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120103358</span><br><span class="line">                  Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: 201010 12:21:59</span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21111</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21111,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">12</span>:<span class="number">22</span>:<span class="number">03</span> [dbms_monitor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">|  4 | 2020-10-10 11:59:15 |</span><br><span class="line">|  5 | 2020-10-10 12:04:35 |</span><br><span class="line">|  6 | 2020-10-10 12:05:30 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:32 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 12:21:24 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-3"><a href="#结论-会failover且成功-3" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 12:22:43 2020 - [warning] Got error on MySQL <span class="keyword">insert</span> ping: <span class="number">2006</span> (MySQL <span class="keyword">server</span> has gone away)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">43</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">43</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">43</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">46</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:46 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.</span></span><br><span class="line"><span class="string">Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:48 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:49 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">49</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">52</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:52 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:53 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">RTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000015:110146</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21216</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000015:85472</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21111</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.12(172.16.120.12:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 12:22:54 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000007</span>:<span class="number">3342407</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.12&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 12:22:54 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3342407, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21216,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 12:22:54 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 12:22:54 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 </span><br><span class="line">RTNETLINK answers: File exists</span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 82756. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010122253.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-21216</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>). Executed <span class="number">2</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.11(172.16.120.11:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">12</span>:<span class="number">22</span>:<span class="number">55</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<h2 id="用例测试-master挂了-且slave也有问题4-部分slave-sql-thread-stop"><a href="#用例测试-master挂了-且slave也有问题4-部分slave-sql-thread-stop" class="headerlink" title="[用例测试] master挂了, 且slave也有问题4(部分slave sql_thread stop)"></a>[用例测试] master挂了, 且slave也有问题4(部分slave sql_thread stop)</h2><blockquote>
<p>master挂了, 在此之前slave-1 sql_thread stop了</p>
</blockquote>
<h3 id="ping-type-CONNECT-10"><a href="#ping-type-CONNECT-10" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager后, 关闭slave-1 sql_thread<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:43:34 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 11:43:35 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>关闭slave-1 sql_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:44:26 [dbms_monitor]&gt; stop slave sql_thread;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:50:00 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">50</span>:<span class="number">04</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000013</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">367</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000013</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: <span class="keyword">No</span></span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><br>关闭sql_thread后 manager仍然正常</p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:40:00 [dbms_monitor]&gt; insert into monitor_delay values(3,now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 11:51:01 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><br>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:50:04 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><br>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:36:17 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-4"><a href="#结论-会failover且成功-4" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 11:51:18 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 11:51:18 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">18</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">18</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">18</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">21</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:21 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">24</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">27</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:27 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:28 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Checking master reachability via MySQL(double check)...</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Starting SQL thread on 172.16.120.11(172.16.120.11:3358) ..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">RTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000013:486</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20746</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000013:486</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20746</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Replicating from the latest slave 172.16.120.12(172.16.120.12:3358) and waiting to apply..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Waiting all logs to be applied on the latest slave.. </span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  Waiting to execute all relay logs on 172.16.120.11(172.16.120.11:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]  master_pos_wait(mysql-bin.000007:3232449) completed on 172.16.120.11(172.16.120.11:3358). Executed 1 events.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 11:51:29 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000010</span>:<span class="number">141523</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 11:51:29 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000010, 141523, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20746,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 11:51:29 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 11:51:29 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 79937. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201010115128.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">29</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-20746</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">51</span>:<span class="number">30</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<p>slave-1成了new master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 11:51:06 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-10-10 11:21:39 |</span><br><span class="line">|  2 | 2020-10-10 11:31:45 |</span><br><span class="line">|  3 | 2020-10-10 11:51:01 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">11</span>:<span class="number">54</span>:<span class="number">53</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>;</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="ping-type-INSERT-10"><a href="#ping-type-INSERT-10" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager后, 关闭slave-1 sql_thread<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:06:09 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 14:06:10 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>关闭slave-1 sql_thread<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:10:20 [dbms_monitor]&gt; stop slave sql_thread;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:22:34 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;</span><br><span class="line">PAGER <span class="keyword">set</span> <span class="keyword">to</span> <span class="string">&#x27;cat - | grep -E &#x27;</span>Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|<span class="keyword">Last</span>|Relay_Log_File|Relay_Log_Pos<span class="string">&#x27;&#x27;</span></span><br><span class="line">root@localhost <span class="number">14</span>:<span class="number">22</span>:<span class="number">57</span> [dbms_monitor]&gt; <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line">              Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000016</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">238476</span></span><br><span class="line">               Relay_Log_File: mysql-relay-<span class="keyword">bin</span><span class="number">.000004</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">211835</span></span><br><span class="line">        Relay_Master_Log_File: mysql-<span class="keyword">bin</span><span class="number">.000016</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: <span class="keyword">No</span></span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error: </span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">211756</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">14</span>:<span class="number">22</span>:<span class="number">57</span> [dbms_monitor]&gt; pager</span><br><span class="line"><span class="keyword">Default</span> pager wasn<span class="string">&#x27;t set, using stdout.</span></span><br></pre></td></tr></table></figure><br>master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:22:09 [dbms_monitor]&gt; insert into monitor_delay values(90, now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:22:29 [dbms_monitor]&gt;  select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">| 90 | 2020-10-10 14:22:29 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><br>slave-1<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:22:57 [dbms<span class="emphasis">_monitor]&gt; select * from monitor_</span>delay;</span><br><span class="line"><span class="code">+----+</span>---------------------+</span><br><span class="line">| id | ctime               |</span><br><span class="line"><span class="code">+----+</span>---------------------+</span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line"><span class="code">+----+</span>---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><br>slave-2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:22:36 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">| 90 | 2020-10-10 14:22:29 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭sql_thread后 manager仍然正常</p>
<p>关闭master<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">root@</span>localhost <span class="number">14</span>:<span class="number">23</span>:<span class="number">38</span> [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会failover且成功-5"><a href="#结论-会failover且成功-5" class="headerlink" title="结论: 会failover且成功"></a>结论: 会failover且成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:25:05 2020 - [warning] Got error on MySQL <span class="keyword">insert</span> ping: <span class="number">2006</span> (MySQL <span class="keyword">server</span> has gone away)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">05</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">06</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">06</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">08</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:08 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:11 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">11</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">14</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:14 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Checking slave configurations..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Checking replication filtering settings..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info]  Replication filtering check ok.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Master is down!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Terminating monitoring script.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Got exit code 20 (Master dead).</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] MHA::MasterFailover version 0.58.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] Starting master failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] * Phase 1: Configuration Check Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:15 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] GTID failover mode = 1</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Dead Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Alive Servers:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Alive Slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Starting SQL thread on 172.16.120.11(172.16.120.11:3358) ..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Starting GTID based failover.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] ** Phase 1: Configuration Check Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 2: Dead Master Shutdown Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Forcing shutdown so that applications never connect to the current master..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Executing master IP deactivation script:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root  </span></span><br><span class="line"><span class="string">Disabling the VIP on old master: 172.16.120.10 </span></span><br><span class="line"><span class="string">RTNETLINK answers: Cannot assign requested address</span></span><br><span class="line"><span class="string">Fake!!! 原主库 rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3: Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000016:268346</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:21217-22354</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000016:268346</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:21217-22354</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Oldest slaves:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3.3: Determining New Master Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Searching new master from slaves..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Candidate masters from the configuration file:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     GTID ON</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Non-candidate masters:</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] Starting master failover..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">From:</span></span><br><span class="line"><span class="string">172.16.120.10(172.16.120.10:3358) (current master)</span></span><br><span class="line"><span class="string"> +--172.16.120.11(172.16.120.11:3358)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To:</span></span><br><span class="line"><span class="string">172.16.120.11(172.16.120.11:3358) (new master)</span></span><br><span class="line"><span class="string"> +--172.16.120.12(172.16.120.12:3358)</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] * Phase 3.3: New Master Recovery Phase..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info] </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:16 2020 - [info]  Waiting all logs to be applied.. </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Replicating from the latest slave 172.16.120.12(172.16.120.12:3358) and waiting to apply..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Waiting all logs to be applied on the latest slave.. </span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  Waiting to execute all relay logs on 172.16.120.11(172.16.120.11:3358)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]  master_pos_wait(mysql-bin.000007:3608644) completed on 172.16.120.11(172.16.120.11:3358). Executed 1 events.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info]   done.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:25:17 2020 - [info] Getting new master&#x27;</span>s <span class="keyword">binlog</span> <span class="keyword">name</span> <span class="keyword">and</span> position..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">17</span> <span class="number">2020</span> - [info]  mysql-<span class="keyword">bin</span><span class="number">.000010</span>:<span class="number">517718</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">17</span> <span class="number">2020</span> - [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> <span class="keyword">replication</span> <span class="keyword">from</span> here. <span class="keyword">Statement</span> should be: <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">&#x27;172.16.120.11&#x27;</span>, MASTER_PORT=<span class="number">3358</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER=<span class="string">&#x27;repler&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">Sat Oct 10 14:25:17 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000010, 517718, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22354,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">Sat Oct 10 14:25:17 2020 - [info] Executing master IP activate script:</span><br><span class="line">Sat Oct 10 14:25:17 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip <span class="comment">--vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27;   --new_master_password=xxx</span></span><br><span class="line">Enabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 </span><br><span class="line">Fake!!! 新主库 rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 </span><br><span class="line"><span class="keyword">Set</span> read_only=<span class="number">0</span> <span class="keyword">on</span> the <span class="keyword">new</span> master.</span><br><span class="line">Creating app <span class="keyword">user</span> <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] ** Finished <span class="keyword">master</span> <span class="keyword">recovery</span> successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> <span class="keyword">Recovery</span> Phase completed.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] * Phase <span class="number">4</span>: Slaves <span class="keyword">Recovery</span> Phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] * Phase <span class="number">4.1</span>: <span class="keyword">Starting</span> Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 89417. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201010142515.log if it takes time..</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> ...</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  Resetting <span class="keyword">slave</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>) <span class="keyword">and</span> <span class="keyword">starting</span> <span class="keyword">replication</span> <span class="keyword">from</span> the <span class="keyword">new</span> <span class="keyword">master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  Executed <span class="keyword">CHANGE</span> MASTER.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  <span class="keyword">Slave</span> started.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">18</span> <span class="number">2020</span> - [info]  gtid_wait(<span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">1</span><span class="number">-22354</span>,</span><br><span class="line"><span class="number">45</span>d1f02a-fcad<span class="number">-11</span>ea<span class="number">-8</span>a44<span class="number">-0050562</span>f2198:<span class="number">1</span><span class="number">-27</span>) completed <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>). Executed <span class="number">0</span> events.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="comment">-- Slave on host 172.16.120.12(172.16.120.12:3358) started.</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> <span class="keyword">slave</span> servers recovered successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> <span class="keyword">master</span> <span class="keyword">cleanup</span> phase..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info]  <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>: Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] </span><br><span class="line"></span><br><span class="line"><span class="comment">----- Failover Report -----</span></span><br><span class="line"></span><br><span class="line">cls_new: MySQL <span class="keyword">Master</span> <span class="keyword">failover</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) succeeded</span><br><span class="line"></span><br><span class="line"><span class="keyword">Master</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> centos<span class="number">-4</span>:/masterha/cls_new/manager.log <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span>:<span class="number">3358</span>)</span><br><span class="line">Selected <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) <span class="keyword">as</span> a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): OK: Activated <span class="keyword">master</span> IP address.</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>:<span class="number">3358</span>): OK: <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>)</span><br><span class="line"><span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>): Resetting <span class="keyword">slave</span> info succeeded.</span><br><span class="line"><span class="keyword">Master</span> <span class="keyword">failover</span> <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>(<span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>:<span class="number">3358</span>) completed successfully.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">25</span>:<span class="number">19</span> <span class="number">2020</span> - [info] Sending mail..</span><br></pre></td></tr></table></figure>
<p>slave-1<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@localhost 14:23:56 [dbms_monitor]&gt; select * from monitor_delay;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| 88 | 2020-10-10 12:21:17 |</span><br><span class="line">| 90 | 2020-10-10 14:22:29 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="用例测试-master挂了-且slave也有问题5-部分slave-sql-thread-error"><a href="#用例测试-master挂了-且slave也有问题5-部分slave-sql-thread-error" class="headerlink" title="[用例测试] master挂了, 且slave也有问题5(部分slave sql_thread error)"></a>[用例测试] master挂了, 且slave也有问题5(部分slave sql_thread error)</h2><blockquote>
<p>master挂了, 在此之前slave-1 sql_thread error了</p>
</blockquote>
<h3 id="ping-type-CONNECT-11"><a href="#ping-type-CONNECT-11" class="headerlink" title="ping_type=CONNECT"></a>ping_type=CONNECT</h3><p>启动manager<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:34:42 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 14:34:43 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>制造slave-1 sql_thread error</p>
<ol>
<li>在master创建表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:35:55 [dbms_monitor]&gt; create table make_error(id int not null auto_increment primary key);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure></li>
<li>在slave-1删除make_error表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:38:10 [dbms_monitor]&gt; set global super_read_only=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:38:14 [dbms_monitor]&gt; set sql_log_bin=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:38:17 [dbms_monitor]&gt; drop table make_error;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 14:38:20 [dbms_monitor]&gt; set sql_log_bin=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></li>
<li>在master删除make_error表(slave-1 sql_thread会报错)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:36:28 [dbms_monitor]&gt; drop table make_error;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure></li>
<li>查看slave-1复制状态<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:38:26 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.10</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000017</span><br><span class="line">          Read_Master_Log_Pos: 620</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 589</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000017</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 1051</span><br><span class="line">                   Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 416</span><br><span class="line">              Relay_Log_Space: 1000</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 1051</span><br><span class="line">               Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120103358</span><br><span class="line">                  Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: 201010 14:39:25</span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:22355-22356</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22355,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
此时manager仍然正常运行</li>
</ol>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 14:39:25 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会触发failover-但failover失败-2"><a href="#结论-会触发failover-但failover失败-2" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 14:40:59 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.</span><br><span class="line">2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))</span><br><span class="line">Sat Oct 10 14:40:59 2020 - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">40</span>:<span class="number">59</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">40</span>:<span class="number">59</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">40</span>:<span class="number">59</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">02</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:02 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">05</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">08</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:08 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [error][/usr/local/share/perl5/MHA/Server.pm, ln935] SQL Thread is stopped(error) on 172.16.120.11(172.16.120.11:3358)! Errno:1051, Error:Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;</span><span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">22356</span><span class="string">&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln703] Server 172.16.120.11(172.16.120.11:3358) is alive, but does not work as a slave!</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [warning] Got Error:  at /usr/local/share/perl5/MHA/MasterMonitor.pm line 560.</span></span><br><span class="line"><span class="string">Sat Oct 10 14:41:09 2020 - [info] Got exit code 1 (Not master dead).</span></span><br></pre></td></tr></table></figure>
<h3 id="ping-type-INSERT-11"><a href="#ping-type-INSERT-11" class="headerlink" title="ping_type=INSERT"></a>ping_type=INSERT</h3><p>启动manager<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 15:54:20 2020 - [info] MHA::MasterMonitor version 0.58.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] GTID failover mode = 1</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Dead Servers:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Alive Servers:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Alive Slaves:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.11(172.16.120.11:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   172.16.120.12(172.16.120.12:3358)  Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     GTID ON</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Replicating from 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking slave configurations..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking replication filtering settings..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]  Replication filtering check ok.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] </span><br><span class="line">172.16.120.10(172.16.120.10:3358) (current master)</span><br><span class="line"> +--172.16.120.11(172.16.120.11:3358)</span><br><span class="line"> +--172.16.120.12(172.16.120.12:3358)</span><br><span class="line"></span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]   /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 </span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info]  OK.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [warning] shutdown_script is not defined.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Set master ping interval 3 seconds.</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..</span><br><span class="line">Sat Oct 10 15:54:21 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..</span><br></pre></td></tr></table></figure><br>准备工作省略, slave-1 sql_thread报错<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:55:13 [dbms_monitor]&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.120.10</span><br><span class="line">                  Master_User: repler</span><br><span class="line">                  Master_Port: 3358</span><br><span class="line">                Connect_Retry: 1</span><br><span class="line">              Master_Log_File: mysql-bin.000019</span><br><span class="line">          Read_Master_Log_Pos: 16331</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000007</span><br><span class="line">                Relay_Log_Pos: 14926</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000019</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 1051</span><br><span class="line">                   Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 14713</span><br><span class="line">              Relay_Log_Space: 19342</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 1051</span><br><span class="line">               Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 120103358</span><br><span class="line">                  Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: </span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: 201010 15:55:16</span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:22356-22425</span><br><span class="line">            Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22418,</span><br><span class="line">45d1f02a-fcad-11ea-8a44-0050562f2198:1-27</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>关闭master<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 15:55:16 [dbms_monitor]&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="结论-会触发failover-但failover失败-3"><a href="#结论-会触发failover-但failover失败-3" class="headerlink" title="结论: 会触发failover, 但failover失败"></a>结论: 会触发failover, 但failover失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Sat Oct 10 15:56:03 2020 - [warning] Got error on MySQL <span class="keyword">insert</span> ping: <span class="number">2006</span> (MySQL <span class="keyword">server</span> has gone away)</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [info] Executing secondary network <span class="keyword">check</span> script: masterha_secondary_check -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> -s <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>  <span class="comment">--user=root  --master_host=172.16.120.10  --master_ip=172.16.120.10  --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERT</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">03</span> <span class="number">2020</span> - [info] Executing SSH <span class="keyword">check</span> script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">04</span> <span class="number">2020</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span> <span class="keyword">is</span> reachable.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.11</span>. OK.</span><br><span class="line"><span class="keyword">Monitoring</span> <span class="keyword">server</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span> <span class="keyword">is</span> reachable, <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="number">172.16</span><span class="number">.120</span><span class="number">.12</span>. OK.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">04</span> <span class="number">2020</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> <span class="keyword">all</span> other <span class="keyword">monitoring</span> servers. <span class="keyword">Failover</span> should start.</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">06</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:06 2020 - [warning] Connection failed 2 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;</span>t <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">&#x27;172.16.120.10&#x27;</span> (<span class="number">111</span>))</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">09</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] <span class="keyword">Connection</span> <span class="keyword">failed</span> <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Sat <span class="keyword">Oct</span> <span class="number">10</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">12</span> <span class="number">2020</span> - [<span class="keyword">warning</span>] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">&#x27;t connect to MySQL server on &#x27;</span><span class="number">172.16</span><span class="number">.120</span><span class="number">.10</span><span class="string">&#x27; (111))</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] Connection failed 4 time(s)..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] Master is not reachable from health checker!</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [warning] SSH is reachable.</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:12 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [error][/usr/local/share/perl5/MHA/Server.pm, ln935] SQL Thread is stopped(error) on 172.16.120.11(172.16.120.11:3358)! Errno:1051, Error:Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;</span><span class="number">44</span>a4ea53-fcad<span class="number">-11</span>ea-bd16<span class="number">-0050563</span>b7b42:<span class="number">22419</span><span class="string">&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln703] Server 172.16.120.11(172.16.120.11:3358) is alive, but does not work as a slave!</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [warning] Got Error:  at /usr/local/share/perl5/MHA/MasterMonitor.pm line 560.</span></span><br><span class="line"><span class="string">Sat Oct 10 15:56:13 2020 - [info] Got exit code 1 (Not master dead).</span></span><br></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;TL-DR&quot;&gt;&lt;a href=&quot;#TL-DR&quot; class=&quot;headerlink&quot; title=&quot;TL;DR&quot;&gt;&lt;/a&gt;TL;DR&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;用例&lt;/th&gt;
&lt;th&gt;ping_type=CONNECT&lt;/th&gt;
&lt;th&gt;ping_type=INSERT&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;master too many connection&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master hang&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;td&gt;会触发failover且成功&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;仅manager无法连通master&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;manager无法连通master, 且无法ssh slave1&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;manager无法连通master, 且无法ssh slave1和slave2&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;manager无法连通master, ssh到slave1后无法连通master&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;td&gt;不会触发failover&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;manager无法连通master, ssh到slave1和slave2后均无法连通master&lt;/td&gt;
&lt;td&gt;会触发failover且成功&lt;/td&gt;
&lt;td&gt;会触发failover且成功(长连接断开后才会)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master宕机前slave1也宕机了&lt;/td&gt;
&lt;td&gt;会触发failover, 但failover失败&lt;/td&gt;
&lt;td&gt;会触发failover, 但failover失败&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master挂了, 在此之前slave-1 io_thread stop了&lt;/td&gt;
&lt;td&gt;会failover且成功&lt;/td&gt;
&lt;td&gt;会failover且成功&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master挂了, 在此之前slave-1 io_thread error了&lt;/td&gt;
&lt;td&gt;会failover且成功&lt;/td&gt;
&lt;td&gt;会failover且成功&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master挂了, 在此之前slave-1 sql_thread stop了&lt;/td&gt;
&lt;td&gt;会failover且成功&lt;/td&gt;
&lt;td&gt;会failover且成功&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;master挂了, 在此之前slave-1 sql_thread error了&lt;/td&gt;
&lt;td&gt;会触发failover, 但failover失败&lt;/td&gt;
&lt;td&gt;会触发failover, 但failover失败&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="MHA" scheme="http://fuxkdb.com/tags/MHA/"/>
    
  </entry>
  
  <entry>
    <title>2020年的一点点总结和感悟</title>
    <link href="http://fuxkdb.com/2021/02/06/2021-02-06-2020%E5%B9%B4%E7%9A%84%E4%B8%80%E7%82%B9%E7%82%B9%E6%80%BB%E7%BB%93%E5%92%8C%E6%84%9F%E6%82%9F/"/>
    <id>http://fuxkdb.com/2021/02/06/2021-02-06-2020年的一点点总结和感悟/</id>
    <published>2021-02-06T03:52:00.000Z</published>
    <updated>2021-02-08T05:50:42.214Z</updated>
    
    <content type="html"><![CDATA[<p>2020年总的来说生活过得还不错, 但是工作和学习属实拉胯, 自己有很大原因.</p>
<h2 id="工作变动"><a href="#工作变动" class="headerlink" title="工作变动"></a>工作变动</h2><p>2020年底, 前公司发生很大变动, 很多同事相继离职, 但这其实并不是我离职的导火索, 导火索是和新来的直属上级无法合作, 这里不谈具体事原因和对错, 现在回过头来看, 对这个离职的决定也谈不上后悔, 只是唏嘘, 马蜂窝的工作环境和氛围确实是我工作以来最好的, 可现在已物是人非…<br>新工作不算满意, 工作所能提供的学习场景极其有限, 团队氛围大不如前, 已经没有在马蜂窝时那种几个人在会议室白板上写写画画讨论技术问题的氛围了(一部分客观原因是根本就没有白板..). 团队对技术的选型有很多时候并非理性而是主观意向(未经实际测试)或者面向绩效的(向上管理味道太浓), 感觉自己的所做的工作也没有那么被认可(也确实没做啥说的上让自己满意的工作), 另外, 现在DBA只要不写web平台就感觉没干活的氛围在整个市场也越来越浓郁了. </p>
<p>确实, 自己在web开发方面是个小白, 菜就是菜, 落后就要挨打! 但这一年在数据库方面的成长速度也实在大不如前, 这可能是我专职MySQL DBA三年多里成长最慢的一年, 这里客观上也有自己的原因.</p>
<p>总之, 今年的教训是工作不开心不要冲动离职, 换工作也不要朝钱看, 成长才是最重要的.</p>
<h2 id="学习状态"><a href="#学习状态" class="headerlink" title="学习状态"></a>学习状态</h2><p>今年学习上投入的时间和效率大不如前, 有工作的原因, 更多的可能还是个人原因. </p>
<p>虽然自己明知道应该完善自己的开发能力, 但就是提不起劲头, 始终是没有去学习数据库时那种可以不吃饭不睡觉的状态. 我想如果可以抛开生活的压力, 可能每个人都会去选择学习自己感兴趣的东西, 但是作为一个社畜(今年我有点理解了社畜定义)必须要满足市场的需求, 才能在竞争中不被淘汰.</p>
<p>绩效, 职级, 薪水都只是你在当前公司暂时的状态, 最终评价个人的是市场, 所以不要太在意这些, 2021年要多花时间私下学习, 哪怕所学的东西不是当前工作需要的, 工作上不必太较真. 优秀的人都是自驱的, 还是多从自身找原因吧.</p>
<h2 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h2><p>明年会很忙, 装修, 搬家..</p>
<p>键盘打算放一放了, switch也尽量少玩了(其实现在也基本不玩..)</p>
<p>加油吧, 2021得对得起自己.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2020年总的来说生活过得还不错, 但是工作和学习属实拉胯, 自己有很大原因.&lt;/p&gt;
&lt;h2 id=&quot;工作变动&quot;&gt;&lt;a href=&quot;#工作变动&quot; class=&quot;headerlink&quot; title=&quot;工作变动&quot;&gt;&lt;/a&gt;工作变动&lt;/h2&gt;&lt;p&gt;2020年底, 前公司发生很大
    
    </summary>
    
    
      <category term="生活" scheme="http://fuxkdb.com/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>使用Canal + ClickHouse实时分析MySQL事务信息</title>
    <link href="http://fuxkdb.com/2020/12/31/2020-12-31-%E4%BD%BF%E7%94%A8Canal-+-ClickHouse%E5%AE%9E%E6%97%B6%E5%88%86%E6%9E%90MySQL%E4%BA%8B%E5%8A%A1%E4%BF%A1%E6%81%AF/"/>
    <id>http://fuxkdb.com/2020/12/31/2020-12-31-使用Canal-+-ClickHouse实时分析MySQL事务信息/</id>
    <published>2020-12-31T05:54:00.000Z</published>
    <updated>2020-12-31T05:56:19.701Z</updated>
    
    <content type="html"><![CDATA[<h1 id="使用Canal-ClickHouse实时分析MySQL事务信息"><a href="#使用Canal-ClickHouse实时分析MySQL事务信息" class="headerlink" title="使用Canal + ClickHouse实时分析MySQL事务信息"></a>使用Canal + ClickHouse实时分析MySQL事务信息</h1><p>作为DBA, 有时候我们会希望能够了解线上核心库更具体的”样貌”, 如:</p>
<ul>
<li>这个库主要的DML类型是什么?</li>
<li>这个库的事务大小, 执行时间, 影响行数大概是什么样的?</li>
</ul>
<p>以上信息也许没什么价值, 但大事务对复制的影响不用多说, 并且当我们希望升级当前主从架构到MGR/PXC等高可用方案的场景时以上信息就比较重要了(毕竟用数据说话更有力度).</p>
<blockquote>
<p>大事务对MGR和PXC都是不友好的, 尤其是MGR(起码在5.7版本)严重时会导致整个集群hang死</p>
<p>在Galera 4.0中新特性<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>对大事务有了更好的支持</p>
</blockquote>
<p>当然, 有人可能会说, 通过分析binlog就可以完成这样的工作, 最简单的方法写个shell脚本就可以, 比如这篇文章中介绍的方法<a href="https://www.percona.com/blog/2015/01/20/identifying-useful-information-mysql-row-based-binary-logs/">Identifying Useful Info from MySQL Row-Based Binary Logs</a>(这篇文章介绍的方法比较简单, 分析速度也较慢, 可以试试<a href="https://gitee.com/mo-shan/analysis_binlog.git">analysis_binlog</a>). 当然还有很多其他工具, 比如infobin. </p>
<p>但个人认为上面的方法从某种角度来看还是比较麻烦, 而且现在ClickHouse越来越流行, 使用ClickHouse去完成这个工作也能帮助我们更好的学习ClickHouse</p>
<p>先看一下最终的成果</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/overview.png" alt="overview"></p>
<a id="more"></a>
<h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><ol>
<li><p>canal + kafka</p>
<p>部署<a href="https://github.com/alibaba/canal">canal</a>, 订阅线上库的binlog, 写入到kafka 我这里没有使用flatMessage(canal.mq.flatMessage = false), 写入到kafka的消息是二进制的protobuf格式的, 当然也可以开启flatMessage, 那么写到kafka的消息就是json格式的.</p>
</li>
<li><p>消费binlog, 持久化到clickhouse</p>
<p>具体代码详见 <a href="https://github.com/Fanduzi/Use_clickhouse_2_analyze_mysql_binlog">https://github.com/Fanduzi/Use_clickhouse_2_analyze_mysql_binlog</a></p>
</li>
<li><p>clickhouse表</p>
<h3 id="基础表"><a href="#基础表" class="headerlink" title="基础表"></a>基础表</h3><p>canal消费后直接写入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 本地表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_binlog_local</span><br><span class="line">(</span><br><span class="line">    <span class="string">`schema`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;数据库名&#x27;</span>,</span><br><span class="line">    <span class="string">`table`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;语句类型&#x27;</span>,</span><br><span class="line">    <span class="string">`is_ddl`</span> UInt8 <span class="keyword">COMMENT</span> <span class="string">&#x27;DDL 1 else 0&#x27;</span>,</span><br><span class="line">    <span class="string">`binlog_file`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;binlog文件名&#x27;</span>,</span><br><span class="line">    <span class="string">`binlog_pos`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;binlog pos&#x27;</span>,</span><br><span class="line">    <span class="string">`characterset`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;字符集&#x27;</span>,</span><br><span class="line">    <span class="string">`execute_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;执行的时间&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt32 <span class="keyword">COMMENT</span> <span class="string">&#x27;此语句影响行数&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_size`</span> <span class="keyword">String</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;此语句size,单位bytes&#x27;</span>,</span><br><span class="line">    <span class="string">`ctime`</span> DateTime <span class="keyword">DEFAULT</span> <span class="keyword">now</span>() <span class="keyword">COMMENT</span> <span class="string">&#x27;写入clickhouse时间&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedMergeTree(<span class="string">&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_binlog&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toDate(execute_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (execute_time, gtid, <span class="keyword">table</span>, <span class="keyword">schema</span>)</span><br><span class="line">TTL execute_time + toIntervalMonth(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分布式表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_binlog</span><br><span class="line">(</span><br><span class="line">    <span class="string">`schema`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;数据库名&#x27;</span>,</span><br><span class="line">    <span class="string">`table`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;表名&#x27;</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;语句类型&#x27;</span>,</span><br><span class="line">    <span class="string">`is_ddl`</span> UInt8 <span class="keyword">COMMENT</span> <span class="string">&#x27;DDL 1 else 0&#x27;</span>,</span><br><span class="line">    <span class="string">`binlog_file`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;binlog文件名&#x27;</span>,</span><br><span class="line">    <span class="string">`binlog_pos`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;binlog pos&#x27;</span>,</span><br><span class="line">    <span class="string">`characterset`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;字符集&#x27;</span>,</span><br><span class="line">    <span class="string">`execute_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;执行的时间&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt32 <span class="keyword">COMMENT</span> <span class="string">&#x27;此语句影响行数&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_size`</span> <span class="keyword">String</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;此语句size,单位bytes&#x27;</span>,</span><br><span class="line">    <span class="string">`ctime`</span> DateTime <span class="keyword">DEFAULT</span> <span class="keyword">now</span>() <span class="keyword">COMMENT</span> <span class="string">&#x27;写入clickhouse时间&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;mysql_monitor&#x27;</span>, <span class="string">&#x27;broker_binlog_local&#x27;</span>, <span class="keyword">rand</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="统计用表"><a href="#统计用表" class="headerlink" title="统计用表"></a>统计用表</h3><blockquote>
<p>SummingMergeTree</p>
<p>ClickHouse会将所有具有相同主键（或更准确地说, 具有相同sorting key）的行替换为包含具有数字数据类型的列的汇总值的一行</p>
</blockquote>
<h3 id="每天binlog-各个event-type数量"><a href="#每天binlog-各个event-type数量" class="headerlink" title="每天binlog 各个event_type数量"></a>每天binlog 各个event_type数量</h3><p>用于统计每日整体binlog event类型占比</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/%E6%AF%8F%E6%97%A5binlog%20event%E7%B1%BB%E5%9E%8B%E7%BB%9F%E8%AE%A1.png" alt=""></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 物化视图基表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_daily_binlog_event_count_local <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`day`</span> <span class="built_in">Date</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_count`</span> UInt64</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedSummingMergeTree(<span class="string">&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_daily_binlog_event_count&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (<span class="keyword">day</span>, event_type)</span><br><span class="line">TTL <span class="keyword">day</span> + toIntervalMonth(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 本地物化视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> mysql_monitor.broker_daily_binlog_event_count_mv_local <span class="keyword">ON</span> CLUSTER ch_cluster_all <span class="keyword">TO</span> mysql_monitor.broker_daily_binlog_event_count_local</span><br><span class="line">(</span><br><span class="line">    <span class="string">`day`</span> <span class="built_in">Date</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_count`</span> UInt64</span><br><span class="line">) <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toDate(execute_time) <span class="keyword">AS</span> <span class="keyword">day</span>,</span><br><span class="line">    event_type,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">AS</span> event_count</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.broker_binlog_local</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    event_type</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span> <span class="keyword">ASC</span>,</span><br><span class="line">    event_type <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分布式物化视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_daily_binlog_event_count_mv <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`day`</span> <span class="built_in">Date</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_count`</span> UInt64</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;mysql_monitor&#x27;</span>, <span class="string">&#x27;broker_daily_binlog_event_count_mv_local&#x27;</span>, <span class="keyword">rand</span>())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>grafana中查询语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">day</span> <span class="keyword">as</span> t,</span><br><span class="line">    event_type,</span><br><span class="line">    <span class="keyword">sum</span>(event_count)</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_mv</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">day</span> = yesterday() <span class="keyword">and</span> event_type!=<span class="string">&#x27;QUERY&#x27;</span> <span class="keyword">and</span> event_type!=<span class="string">&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span>, event_type</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="每日TOP-DML表统计"><a href="#每日TOP-DML表统计" class="headerlink" title="每日TOP DML表统计"></a>每日TOP DML表统计</h4><p>   <img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/%E6%AF%8F%E6%97%A5TOP%2010DML%E8%A1%A8%E7%BB%9F%E8%AE%A1.png" alt=""></p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 物化视图基表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_daily_binlog_event_count_by_table_local <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`day`</span> <span class="built_in">Date</span>,</span><br><span class="line">    <span class="string">`schema`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`table`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_count`</span> UInt64</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedSummingMergeTree(<span class="string">&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_daily_binlog_event_count_by_table&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (<span class="keyword">day</span>, <span class="keyword">table</span>, <span class="keyword">schema</span>, event_type)</span><br><span class="line">TTL <span class="keyword">day</span> + toIntervalMonth(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 本地物化视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> mysql_monitor.broker_daily_binlog_event_count_by_table_mv_local <span class="keyword">ON</span> CLUSTER ch_cluster_all <span class="keyword">TO</span> mysql_monitor.broker_daily_binlog_event_count_by_table_local</span><br><span class="line">(</span><br><span class="line">    <span class="string">`day`</span> <span class="built_in">Date</span>,</span><br><span class="line">    <span class="string">`schema`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`table`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_count`</span> UInt64</span><br><span class="line">) <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toDate(execute_time) <span class="keyword">AS</span> <span class="keyword">day</span>,</span><br><span class="line">    <span class="keyword">schema</span>,</span><br><span class="line">    <span class="keyword">table</span>,</span><br><span class="line">    event_type,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">AS</span> event_count</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.broker_binlog_local</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="keyword">schema</span>,</span><br><span class="line">    <span class="keyword">table</span>,</span><br><span class="line">    event_type</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span> <span class="keyword">ASC</span>,</span><br><span class="line">    <span class="keyword">schema</span> <span class="keyword">ASC</span>,</span><br><span class="line">    <span class="keyword">table</span> <span class="keyword">ASC</span>,</span><br><span class="line">    event_type <span class="keyword">DESC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分布式物化视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_daily_binlog_event_count_by_table_mv <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`day`</span> <span class="built_in">Date</span>,</span><br><span class="line">    <span class="string">`schema`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`table`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_type`</span> <span class="keyword">String</span>,</span><br><span class="line">    <span class="string">`event_count`</span> UInt64</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;mysql_monitor&#x27;</span>, <span class="string">&#x27;broker_daily_binlog_event_count_by_table_mv_local&#x27;</span>, <span class="keyword">rand</span>())</span><br></pre></td></tr></table></figure>
<p>   grafana中查询语句</p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">day</span> <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">table</span>,</span><br><span class="line">    <span class="keyword">sum</span>(event_count) <span class="keyword">count</span></span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_by_table_mv</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">day</span> = yesterday() <span class="keyword">and</span> event_type!=<span class="string">&#x27;QUERY&#x27;</span> <span class="keyword">and</span> event_type!=<span class="string">&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="keyword">table</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">count</span> <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>   <img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/%E6%AF%8F%E6%97%A5TOP%E8%A1%A8%E8%AF%AD%E5%8F%A5%E7%B1%BB%E5%9E%8B.png" alt=""></p>
<p>   grafana中查询语句</p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">day</span> <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">table</span>,</span><br><span class="line">    event_type,</span><br><span class="line">    <span class="keyword">sum</span>(event_count) <span class="keyword">count</span></span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_by_table_mv</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    <span class="keyword">day</span> = yesterday() <span class="keyword">and</span> event_type!=<span class="string">&#x27;QUERY&#x27;</span> <span class="keyword">and</span> event_type!=<span class="string">&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">table</span> <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">table</span> <span class="keyword">from</span> (</span><br><span class="line">      <span class="keyword">select</span> <span class="keyword">table</span>, <span class="keyword">sum</span>(event_count) <span class="keyword">count</span> <span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_by_table_mv <span class="keyword">WHERE</span> <span class="keyword">day</span> = yesterday() <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">table</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span> <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">3</span> </span><br><span class="line">      ))</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="keyword">table</span>,</span><br><span class="line">    event_type</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">count</span> <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<h4 id="一周执行DML总量情况"><a href="#一周执行DML总量情况" class="headerlink" title="一周执行DML总量情况"></a>一周执行DML总量情况</h4><p>   <img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/%E4%B8%80%E5%91%A8%E6%89%A7%E8%A1%8CDML%E6%80%BB%E9%87%8F.png" alt=""></p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> </span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">sum</span>(event_count)</span><br><span class="line">        <span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_mv</span><br><span class="line">        <span class="keyword">WHERE</span> (<span class="keyword">day</span> &gt;= (today() - <span class="number">6</span>)) <span class="keyword">AND</span> (event_type != <span class="string">&#x27;QUERY&#x27;</span>) <span class="keyword">AND</span> (event_type != <span class="string">&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;</span>)</span><br><span class="line">    ) <span class="keyword">AS</span> total_statement_count</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    multiIf(toDayOfWeek(<span class="keyword">day</span>) = <span class="number">1</span>, <span class="string">&#x27;星期一&#x27;</span>, toDayOfWeek(<span class="keyword">day</span>) = <span class="number">2</span>, <span class="string">&#x27;星期二&#x27;</span>, toDayOfWeek(<span class="keyword">day</span>) = <span class="number">3</span>, <span class="string">&#x27;星期三&#x27;</span>, toDayOfWeek(<span class="keyword">day</span>) = <span class="number">4</span>, <span class="string">&#x27;星期四&#x27;</span>, toDayOfWeek(<span class="keyword">day</span>) = <span class="number">5</span>, <span class="string">&#x27;星期五&#x27;</span>, toDayOfWeek(<span class="keyword">day</span>) = <span class="number">6</span>, <span class="string">&#x27;星期六&#x27;</span>, toDayOfWeek(<span class="keyword">day</span>) = <span class="number">7</span>, <span class="string">&#x27;星期日&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>) <span class="keyword">AS</span> w,</span><br><span class="line">    <span class="keyword">day</span> <span class="keyword">AS</span> t, </span><br><span class="line">    <span class="keyword">sum</span>(event_count) <span class="keyword">AS</span> statement_count, </span><br><span class="line">    bar(statement_count, <span class="number">0</span>, total_statement_count, <span class="number">500</span>) <span class="keyword">AS</span> bar</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_mv</span><br><span class="line"><span class="keyword">WHERE</span> (<span class="keyword">day</span> &gt;= (today() - <span class="number">6</span>)) <span class="keyword">AND</span> (event_type != <span class="string">&#x27;QUERY&#x27;</span>) <span class="keyword">AND</span> (event_type != <span class="string">&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> toDate(t) <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<h4 id="事务情况统计"><a href="#事务情况统计" class="headerlink" title="事务情况统计"></a>事务情况统计</h4><p>   <img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/%E4%BA%8B%E5%8A%A1%E6%83%85%E5%86%B5.png" alt=""></p>
<p>   统计影响行数对多的事务, 产生binlog最大的事务, 执行时间最长的事务</p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_largest_transaction_local <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`end_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;采集语句中的end_time&#x27;</span>,</span><br><span class="line">    <span class="string">`invertal`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;采集周期,单位秒&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_spend_time`</span> Int32 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务用时&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_size`</span> Int64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务size&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务影响行数&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedSummingMergeTree(<span class="string">&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_largest_transaction&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toDate(end_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> gtid</span><br><span class="line">TTL toDate(end_time) + toIntervalMonth(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_largest_transaction <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`end_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;采集语句中的end_time&#x27;</span>,</span><br><span class="line">    <span class="string">`invertal`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;采集周期,单位秒&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_spend_time`</span> Int32 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务用时&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_size`</span> Int64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务size&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务影响行数&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;mysql_monitor&#x27;</span>, <span class="string">&#x27;broker_largest_transaction_local&#x27;</span>, <span class="keyword">rand</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_most_time_consuming_transaction_local <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`end_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;采集语句中的end_time&#x27;</span>,</span><br><span class="line">    <span class="string">`invertal`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;采集周期,单位秒&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_spend_time`</span> Int32 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务用时&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_size`</span> Int64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务size&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务影响行数&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedSummingMergeTree(<span class="string">&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_most_time_consuming_transaction&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toDate(end_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> gtid</span><br><span class="line">TTL toDate(end_time) + toIntervalMonth(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_most_time_consuming_transaction <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`end_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;采集语句中的end_time&#x27;</span>,</span><br><span class="line">    <span class="string">`invertal`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;采集周期,单位秒&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_spend_time`</span> Int32 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务用时&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_size`</span> Int64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务size&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务影响行数&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;mysql_monitor&#x27;</span>, <span class="string">&#x27;broker_most_time_consuming_transaction_local&#x27;</span>, <span class="keyword">rand</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_most_affected_rows_transaction_local <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`end_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;采集语句中的end_time&#x27;</span>,</span><br><span class="line">    <span class="string">`invertal`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;采集周期,单位秒&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_spend_time`</span> Int32 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务用时&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_size`</span> Int64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务size&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务影响行数&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = ReplicatedSummingMergeTree(<span class="string">&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_most_affected_rows_transaction&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toDate(end_time)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> gtid</span><br><span class="line">TTL toDate(end_time) + toIntervalMonth(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_monitor.broker_most_affected_rows_transaction <span class="keyword">ON</span> CLUSTER ch_cluster_all</span><br><span class="line">(</span><br><span class="line">    <span class="string">`end_time`</span> DateTime <span class="keyword">COMMENT</span> <span class="string">&#x27;采集语句中的end_time&#x27;</span>,</span><br><span class="line">    <span class="string">`invertal`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;采集周期,单位秒&#x27;</span>,</span><br><span class="line">    <span class="string">`gtid`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;gtid&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_spend_time`</span> Int32 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务用时&#x27;</span>,</span><br><span class="line">    <span class="string">`transaction_size`</span> Int64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务size&#x27;</span>,</span><br><span class="line">    <span class="string">`single_statement_affected_rows`</span> UInt64 <span class="keyword">COMMENT</span> <span class="string">&#x27;事务影响行数&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;mysql_monitor&#x27;</span>, <span class="string">&#x27;broker_most_affected_rows_transaction_local&#x27;</span>, <span class="keyword">rand</span>())</span><br></pre></td></tr></table></figure>
<p>   想了想只能建三张表, 写脚本自己周期性查询size,耗时, 影响行数最多的在插入这些表中</p>
<p>   查询语句大致如下, 由于grafana必须需要一个DateTime列, 所以加了一个<code>toDateTime(&#39;&#123;end&#125;&#39;)</code> 取每次采集窗口的高水位. 三个查询只是order by不同</p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">昨日最大事物size</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_size) sum_transaction_size</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_largest_transaction</span><br><span class="line"><span class="keyword">WHERE</span> end_time&gt;=toDateTime(yesterday()) <span class="keyword">and</span> end_time&lt;toDateTime(today())</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t,gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_transaction_size <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">昨日事务最大执行时间</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_spend_time) sum_transaction_spend_time</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transaction</span><br><span class="line"><span class="keyword">WHERE</span> end_time&gt;=toDateTime(yesterday()) <span class="keyword">and</span> end_time&lt;toDateTime(today())</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t,gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_transaction_spend_time <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">昨日事务影响最大行数</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(single_statement_affected_rows) transaction_affected_rows</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_affected_rows_transaction</span><br><span class="line"><span class="keyword">WHERE</span> end_time&gt;=toDateTime(yesterday()) <span class="keyword">and</span> end_time&lt;toDateTime(today())</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t,gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> transaction_affected_rows <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">上周最大事物概览</span><br><span class="line"><span class="keyword">select</span> t,<span class="keyword">max</span>(sum_transaction_size) max_transaction_size <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toDate(end_time) <span class="keyword">as</span> t,</span><br><span class="line">    gtid,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_size) sum_transaction_size</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_largest_transaction</span><br><span class="line"><span class="keyword">WHERE</span> end_time &gt;= (today() - <span class="number">6</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t,gtid) <span class="keyword">group</span> <span class="keyword">by</span> t <span class="keyword">order</span> <span class="keyword">by</span> t <span class="keyword">desc</span> </span><br><span class="line"></span><br><span class="line">上周事务最大执行时间概览</span><br><span class="line"><span class="keyword">select</span> t,<span class="keyword">max</span>(sum_transaction_spend_time) max_transaction_spend_time <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toDate(end_time) <span class="keyword">as</span> t,</span><br><span class="line">    gtid,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_spend_time) sum_transaction_spend_time</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transaction</span><br><span class="line"><span class="keyword">WHERE</span> end_time &gt;= (today() - <span class="number">6</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t,gtid) <span class="keyword">group</span> <span class="keyword">by</span> t <span class="keyword">order</span> <span class="keyword">by</span> t <span class="keyword">desc</span> </span><br><span class="line"></span><br><span class="line">上周事务影响最大行数概览</span><br><span class="line"><span class="keyword">select</span> t,<span class="keyword">max</span>(transaction_affected_rows) max_transaction_affected_rows <span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    toDate(end_time) <span class="keyword">as</span> t,</span><br><span class="line">    gtid,</span><br><span class="line">    <span class="keyword">sum</span>(single_statement_affected_rows) transaction_affected_rows</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_affected_rows_transaction</span><br><span class="line"><span class="keyword">WHERE</span> end_time &gt;= (today() - <span class="number">6</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t,gtid) <span class="keyword">group</span> <span class="keyword">by</span> t <span class="keyword">order</span> <span class="keyword">by</span> t <span class="keyword">desc</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">近实时事务<span class="keyword">size</span>图</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_size) transaction_size</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_largest_transaction</span><br><span class="line"><span class="keyword">WHERE</span> $timeFilter</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t, gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_spend_time) transaction_spend_time</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transaction</span><br><span class="line"><span class="keyword">WHERE</span> $timeFilter</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t, gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t</span><br><span class="line"></span><br><span class="line">近实时事务影响行数图</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(single_statement_affected_rows) transaction_affected_rows</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_affected_rows_transaction</span><br><span class="line"><span class="keyword">WHERE</span> $timeFilter</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t, gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    $timeSeries <span class="keyword">as</span> t,</span><br><span class="line">    <span class="keyword">sum</span>(transaction_spend_time) transaction_spend_time</span><br><span class="line"><span class="keyword">FROM</span> mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transaction</span><br><span class="line"><span class="keyword">WHERE</span> $timeFilter</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> t, gtid</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实际干下来发现一些查询确实可以通过物化视图优化, 但是grafana每次都要带一个DateTime比较烦, 可能物化视图还有优化空间. 对于如下图所示的实时统计的需求<code>daily_binlog</code>这种天级物化视图就无法实现细粒度的查询了(查询速度太慢, 必须借助物化视图)</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/%E7%94%BB%E5%83%8F%E5%AE%9E%E6%97%B6%E7%BB%9F%E8%AE%A1%E9%9C%80%E6%B1%82.png" alt=""></p>
<p>那么如何实现更细粒度的物化视图呢? 得看下如何按周期聚合, 比如5分钟一个聚合. 目前clickhouse没有oracle那样的开窗函数</p>
<blockquote>
<p>oracle可以</p>
<p>sum over(partition by gtid order by execute_time range between interval ‘1’ day preceding and interval ‘1’ day following)</p>
</blockquote>
<p>对于一些不好优化的查询, 如果换马蜂窝那些一天上百G binlog的库可能真的跑不动了. 也许只能多搞几个分片, 不过不知道最后聚合会不会很耗内存, 感觉最主要是这套系统是否值得付出加节点的金钱成本.</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;使用Canal-ClickHouse实时分析MySQL事务信息&quot;&gt;&lt;a href=&quot;#使用Canal-ClickHouse实时分析MySQL事务信息&quot; class=&quot;headerlink&quot; title=&quot;使用Canal + ClickHouse实时分析MySQL事务信息&quot;&gt;&lt;/a&gt;使用Canal + ClickHouse实时分析MySQL事务信息&lt;/h1&gt;&lt;p&gt;作为DBA, 有时候我们会希望能够了解线上核心库更具体的”样貌”, 如:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;这个库主要的DML类型是什么?&lt;/li&gt;
&lt;li&gt;这个库的事务大小, 执行时间, 影响行数大概是什么样的?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上信息也许没什么价值, 但大事务对复制的影响不用多说, 并且当我们希望升级当前主从架构到MGR/PXC等高可用方案的场景时以上信息就比较重要了(毕竟用数据说话更有力度).&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;大事务对MGR和PXC都是不友好的, 尤其是MGR(起码在5.7版本)严重时会导致整个集群hang死&lt;/p&gt;
&lt;p&gt;在Galera 4.0中新特性&lt;a href=&quot;https://galeracluster.com/library/documentation/streaming-replication.html&quot;&gt;Streaming Replication&lt;/a&gt;对大事务有了更好的支持&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;当然, 有人可能会说, 通过分析binlog就可以完成这样的工作, 最简单的方法写个shell脚本就可以, 比如这篇文章中介绍的方法&lt;a href=&quot;https://www.percona.com/blog/2015/01/20/identifying-useful-information-mysql-row-based-binary-logs/&quot;&gt;Identifying Useful Info from MySQL Row-Based Binary Logs&lt;/a&gt;(这篇文章介绍的方法比较简单, 分析速度也较慢, 可以试试&lt;a href=&quot;https://gitee.com/mo-shan/analysis_binlog.git&quot;&gt;analysis_binlog&lt;/a&gt;). 当然还有很多其他工具, 比如infobin. &lt;/p&gt;
&lt;p&gt;但个人认为上面的方法从某种角度来看还是比较麻烦, 而且现在ClickHouse越来越流行, 使用ClickHouse去完成这个工作也能帮助我们更好的学习ClickHouse&lt;/p&gt;
&lt;p&gt;先看一下最终的成果&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/DB%E7%94%BB%E5%83%8F/overview.png&quot; alt=&quot;overview&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="Canal" scheme="http://fuxkdb.com/tags/Canal/"/>
    
      <category term="ClickHouse" scheme="http://fuxkdb.com/tags/ClickHouse/"/>
    
  </entry>
  
  <entry>
    <title>类MHA高可用方案存在的问题</title>
    <link href="http://fuxkdb.com/2020/09/24/2020-09-24-%E7%B1%BBMHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>http://fuxkdb.com/2020/09/24/2020-09-24-类MHA高可用方案存在的问题/</id>
    <published>2020-09-24T11:00:00.000Z</published>
    <updated>2021-01-15T02:13:19.524Z</updated>
    
    <content type="html"><![CDATA[<h2 id="类MHA高可用方案存在的问题"><a href="#类MHA高可用方案存在的问题" class="headerlink" title="类MHA高可用方案存在的问题"></a>类MHA高可用方案存在的问题</h2><p>MHA Generaly Available since 2011?</p>
<p>MHA在当时主要解决两个问题:</p>
<ol>
<li>自动的数据补偿</li>
<li>自动的主从切换</li>
</ol>
<p>还有两个重要的背景需要交代:</p>
<ol>
<li>当时主要使用异步复制</li>
<li>当时还没有ProxySQL</li>
</ol>
<p>所以当时基本使用MHA+VIP作为MySQL复制集的高可用方案.</p>
<p>不谈vip的脑裂问题, 这种架构的一个关键点在于, MHA是作为一个外部机制检测MySQL复制集状态, 并变更复制集拓扑, 变更后漂移vip, 也就是说MHA既控制了集群拓扑的变化, 又控制了app的访问路径(写通过vip)</p>
<a id="more"></a>
<h3 id="脑裂"><a href="#脑裂" class="headerlink" title="脑裂"></a>脑裂</h3><p>MHA+ProxySQL架构有一个问题:</p>
<p>MHA对MySQL复制级的监控检测逻辑中不包含ProxySQL, 因为MHA不知道用户在MySQL上层会构建什么样的中间件, 同时MHA变更集群拓扑后也并不会通知ProxySQL. 也就是说MHA和ProxySQL有可能会产生不同的”观点”</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/%E7%B1%BBMHA%E9%97%AE%E9%A2%98/%E5%9B%BE-1.png" alt="图-1"></p>
<p>如上图场景</p>
<ul>
<li>APP-1, ProxySQL-1和主库在一个网络分区, 正在写入数据(异步复制, 或半同步超时不是无限大)</li>
<li>APP-2, ProxySQL-2, 从库和MHA manager在一个网路分区, 无法连通主库</li>
</ul>
<p>这种情况, MHA会Failover. Failover后变成如下拓扑</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/%E7%B1%BBMHA%E9%97%AE%E9%A2%98/%E5%9B%BE-2.png" alt="图-2"></p>
<p>这就导致了脑裂(如果是半同步且超时无限大, 那么不会脑裂, 因为数据无法写入Master). 实际上如果在<code>secondary_check_script</code>中配置了ProxySQL地址</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secondary_check_script=masterha_secondary_check -s ProxySQL<span class="number">-1</span> -s ProxySQL<span class="number">-2</span> -s Slave<span class="number">-1</span> -s Slave<span class="number">-2</span> -s Slave<span class="number">-3</span></span><br></pre></td></tr></table></figure>
<p>这样配置后, 在图-1的场景中, manager二次检测时无法ssh到ProxySQL-1, 二次检测脚本会以exit_code=2退出, 不会发生Failover, 就不会脑裂(如果是半同步且超时无限大, 那么不会脑裂, 因为数据无法写入Master).</p>
<blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在masterha_secondary_check脚本中有如下注释, 这是<span class="keyword">exit</span> code的含义, 只有<span class="number">0</span>会触发Failover</span><br><span class="line"><span class="comment"># 0: master is not reachable from all monotoring servers</span></span><br><span class="line"><span class="comment"># 1: unknown errors</span></span><br><span class="line"><span class="comment"># 2: at least one of monitoring servers is not reachable from this script</span></span><br><span class="line"><span class="comment"># 3: master is reachable from at least one of monitoring servers</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="极端场景无法完成Failover"><a href="#极端场景无法完成Failover" class="headerlink" title="极端场景无法完成Failover"></a>极端场景无法完成Failover</h3><p>上文的场景就是一种极端场景. 在这种场景(图-1)下, 正确的做法是切断Master流量(关闭APP-1并不太现实, 因为实际可能不只一个应用, 关闭ProxySQL或Master都是可以的), 然后进行切换. 但这正是MHA无法做到的.</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/%E7%B1%BBMHA%E9%97%AE%E9%A2%98/%E5%9B%BE-3.png" alt="图-3"></p>
<p>想象图-3场景, 使用半同步复制<code>rpl_semi_sync_master_wait_for_slave_count=1</code></p>
<p>这种情况下, MHA仍然不会Failover(二次检测脚本-s中指定了slave-4), 那么按照正常逻辑, 应该Failover吗? </p>
<p>个人认为要看情况:</p>
<ul>
<li>如果添加从库的速度很慢, 一旦Slave-4出现问题无法返回ack, Master将不能提供写入, 那么应该Failover, 将Slave1-3组成一个新的复制集, 一主两从, 两个从库出现异常的概率显然要小很多</li>
<li>如果添加从库的速度很快(备份集小, 自动化完善), 并且当时的场景不允许哪怕3-5秒的不可用(切换用时), 那么可以快速为Master添加一个从库Slave-5</li>
</ul>
<h3 id="为什么类MHA的高可用方案在这种情况下无法完成Failover"><a href="#为什么类MHA的高可用方案在这种情况下无法完成Failover" class="headerlink" title="为什么类MHA的高可用方案在这种情况下无法完成Failover?"></a>为什么类MHA的高可用方案在这种情况下无法完成Failover?</h3><ol>
<li><p>ProxySQL是一个”伪集群”</p>
<p>ProxySQL集群目前只做到了配置同步,  成员之间并没有使用共识算法实现选举机制, 在图-1的场景中检查ProxySQL-1和ProxySQL-2的<code>runtime_mysql_servers</code>, 你会看到这样的结果</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ProxySQL-1</span><br><span class="line">admin<span class="meta">@127.0.0.1</span> 15:10:50 [(none)]&gt; select <span class="symbol">*</span> from runtime_mysql_servers;</span><br><span class="line">+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+</span><br><span class="line">|<span class="string"> hostgroup_id </span>|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> gtid_port </span>|<span class="string"> status  </span>|<span class="string"> weight </span>|<span class="string"> compression </span>|<span class="string"> max_connections </span>|<span class="string"> max_replication_lag </span>|<span class="string"> use_ssl </span>|<span class="string"> max_latency_ms </span>|<span class="string"> comment                </span>|</span><br><span class="line">+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+</span><br><span class="line">|<span class="string"> 10           </span>|<span class="string"> 172.16.120.10 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE  </span>|<span class="string"> 1      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> master for backup read </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 172.16.120.10 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE  </span>|<span class="string"> 1      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> master for backup read </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 172.16.120.12 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> SHUNNED </span>|<span class="string"> 1000   </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 120                 </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> slave                  </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 172.16.120.11 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> SHUNNED </span>|<span class="string"> 1000   </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 120                 </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> slave                  </span>|</span><br><span class="line">+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+</span><br><span class="line"></span><br><span class="line">ProxySQL-2</span><br><span class="line">admin<span class="meta">@127.0.0.1</span> 15:10:14 [(none)]&gt; select <span class="symbol">*</span> from runtime_mysql_servers;    </span><br><span class="line">+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+</span><br><span class="line">|<span class="string"> hostgroup_id </span>|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> gtid_port </span>|<span class="string"> status  </span>|<span class="string"> weight </span>|<span class="string"> compression </span>|<span class="string"> max_connections </span>|<span class="string"> max_replication_lag </span>|<span class="string"> use_ssl </span>|<span class="string"> max_latency_ms </span>|<span class="string"> comment                </span>|</span><br><span class="line">+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 172.16.120.11 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE  </span>|<span class="string"> 1000   </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 120                 </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> slave                  </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 172.16.120.10 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> SHUNNED </span>|<span class="string"> 1      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> master for backup read </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 172.16.120.12 </span>|<span class="string"> 3358 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE  </span>|<span class="string"> 1000   </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 120                 </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string"> slave                  </span>|</span><br><span class="line">+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>如果ProxySQL集群有选举机制, 那么一个集群至少需要三个节点, 当一个节点意识到自己无法与大多数成员通信时, 它应当将自己置为不可用状态.</p>
</li>
<li><p>MHA manager单点</p>
<p>这和ProxySQL有一些类似的情况. 如果MHA也是一个集群, 并在MySQL复制集的每个节点部署一个node, 那么在图-1的场景中, Master节点上的MHA node应当意识到自己已经脱离了大多数成员, 它无法发起MySQL拓扑变更, 它要做应当是关闭Master(或打开read_only)</p>
<blockquote>
<p>青云开源的Xenon<del>好像</del>实现了类似的功能<del>, 但我也不确定, 这个项目使用人数太少</del></p>
<p>​     <a href="https://github.com/radondb/xenon/issues/107">https://github.com/radondb/xenon/issues/107</a></p>
<p>​     不过同样, xenon是使用vip为应用提供写入通道, 也就是说xenon控制了访问路径</p>
<p>Orchestrator不知道是否实现了这样的功能, 需要调研</p>
</blockquote>
</li>
<li><p>MHA的检测逻辑不包含ProxySQL, 变更拓扑后也没有通知ProxySQL</p>
<ol>
<li><p>MHA的检测机制和ProxySQL并不相同, 两者可能对拓扑情况有不同的判断. 应当改造二次检测脚本, 通过连接ProxySQL判断主库状态, 但即使这样做, 在图-1的场景中, manager会发现自己无法连接ProxySQL-1, 那么二次检测脚本应当以exit_code=2退出, 不会发生Failover, 所以这仍然无法解决极端场景不能Failover的问题.</p>
</li>
<li><p>Failover后, MHA应当主动变更ProxySQL中的配置</p>
<p><a href="https://mp.weixin.qq.com/s/9MFp9fpY8Seydwm7XGly-Q">携程数据库高可用架构实践</a>有类似描述</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/%E7%B1%BBMHA%E9%97%AE%E9%A2%98/%E5%9B%BE-4.png" alt="图-4"></p>
<p> 正确的做法与图-4类似, 在Failover后MHA应当将新的拓扑配置推送给”配置中心”, 保证应用使用新的配置连接数据库</p>
<blockquote>
<p>美团也实现了类似的功能<a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1600939410&amp;ver=2604&amp;signature=FtjBxs1ZJtv8bSxEWRbFLiUhMfMvF*lQeewvVkpI0HfPoTgPcT6AKh6a3gMay1zqVOvUGqPhu4VyQ2uHraOcACdr1-WtDyHmwECm-6RlzJQSZPZeQP9t8efva1M1Kt90&amp;new=1">踩坑无数，美团点评高可用数据库架构演进</a></p>
</blockquote>
</li>
<li><p>主从复制集并不是集群</p>
<p>即便从库都判定主库不可用, 也无能为力. 而假设是一个PXC或MGR集群(我们先不讨论这两者的问题), 图-1的场景会变成这样(以PXC为例):</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/%E7%B1%BBMHA%E9%97%AE%E9%A2%98/%E5%9B%BE-5.png" alt="图-5"></p>
<blockquote>
<p>实际上图中PXC节点数量为偶数并不合理, 只是为了迎合图-1场景作对比</p>
<p>在PXC中, 所有节点都是主节点, 都可以写入, 只要提交成功就不会丢失数据</p>
<p>MGR也有多主模式, 如果是单主模式, 脱离集群的节点会将自己设为read_only</p>
</blockquote>
<p>在图-5的情况下, Master会被踢出集群, 也就是说选举和拓扑变更是MySQL自己控制的, ProxySQL只需要被动接受就好了. (如果无法踢出Master呢? 那只能说遇到了内部bug, 任何软件都可能有bug, 包括MHA ProxySQL, Orchestrator等)</p>
<p>即便是下图的场景, PXC和MGR也能很好地完成选举, 剔除Master和Slave-4</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/%E7%B1%BBMHA%E9%97%AE%E9%A2%98/%E5%9B%BE-6.png" alt="图-6"></p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对于类MHA高可用方案, 需要进行改造以适应中间件.</p>
<blockquote>
<p>对于MHA来说:</p>
<ol>
<li>要改造masterha_secondary_check脚本, 在二次检测时连接ProxySQL进行主库探活. master_ip_failover也需要改造, 要在failover后删除ProxySQL runtime_mysql_server中原主信息并load</li>
<li>一定要将半同步超时设置无限大, 避免脑裂</li>
</ol>
</blockquote>
<p>如果放弃MHA, 无论选择Orchestrator, PXC亦或是MGR, 都是MySQL架构上的大变动, 需要长时间的技术调研和测试以及业务方的配合, 这三者任何一个都需要DBA花时间学习, 是否升级架构取决于我们面临的问题是不是最迫切需要解决的, 以及风险可控性(扎实的理论基础和完善的测试可以提高可控性). </p>
<p>那么选择其实就两种:</p>
<ul>
<li>继续使用MHA或类MHA架构, 需要做二次开发适应ProxySQL</li>
<li>使用PXC或MGR这类”原生”集群方案, 需要实际数据论证当前业务是否可以做这样的架构调整. </li>
</ul>
<p>个人认为两种都可以, 不过MGR必将是未来金融级高可用方案的事实标准(个人拙见, 据我所知网易,腾讯金融目前就是使用MGR,不过它们对源码做了修改, 这并非中小企业所具备的能力), 但目前仍需等待(发展只有4年), 而PXC已经发展8年了, 目前来看相比MGR更可靠(去哪儿网, 马蜂窝和之前的一些p2p企业都是用PXC), 但任何能保证强一致性的集群都必然会有性能损耗, 还要看业务是否可以接受. </p>
<p>如果用长远的眼光看, 调研并在一些边缘系统实践MGR是需要做的.</p>
<blockquote>
<p>如CMDB, 明显的读多写少的系统, <a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1600940214&amp;ver=2604&amp;signature=XWQUxh5Ls1-5ltVRN4onwF*INLHJERC1PGSjWxmdsUb*fqQZT7oJDntIvdObPVsdmE0emLPZ4bgaKY7hpMJ709mtr43KsFkI0WuTcZLihxbIaaLzZnvMDx7SpOnCegxr&amp;new=1">美团点评基于MGR的CMDB高可用架构搭建之路</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;类MHA高可用方案存在的问题&quot;&gt;&lt;a href=&quot;#类MHA高可用方案存在的问题&quot; class=&quot;headerlink&quot; title=&quot;类MHA高可用方案存在的问题&quot;&gt;&lt;/a&gt;类MHA高可用方案存在的问题&lt;/h2&gt;&lt;p&gt;MHA Generaly Available since 2011?&lt;/p&gt;
&lt;p&gt;MHA在当时主要解决两个问题:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;自动的数据补偿&lt;/li&gt;
&lt;li&gt;自动的主从切换&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;还有两个重要的背景需要交代:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;当时主要使用异步复制&lt;/li&gt;
&lt;li&gt;当时还没有ProxySQL&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;所以当时基本使用MHA+VIP作为MySQL复制集的高可用方案.&lt;/p&gt;
&lt;p&gt;不谈vip的脑裂问题, 这种架构的一个关键点在于, MHA是作为一个外部机制检测MySQL复制集状态, 并变更复制集拓扑, 变更后漂移vip, 也就是说MHA既控制了集群拓扑的变化, 又控制了app的访问路径(写通过vip)&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="MHA" scheme="http://fuxkdb.com/tags/MHA/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouse到底改写本地表还是分布式表</title>
    <link href="http://fuxkdb.com/2020/09/22/2020-09-22-ClickHouse%E5%88%B0%E5%BA%95%E6%94%B9%E5%86%99%E6%9C%AC%E5%9C%B0%E8%A1%A8%E8%BF%98%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8/"/>
    <id>http://fuxkdb.com/2020/09/22/2020-09-22-ClickHouse到底改写本地表还是分布式表/</id>
    <published>2020-09-22T02:30:00.000Z</published>
    <updated>2020-09-22T02:31:06.713Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>如果预估自己的业务数据量不大(日增不到百万行), 那么写分布式表和本地表都可以, 但要注意如果选择写本地表, 请保证每次写入数据都建立新的连接, 且每个连接写入的数据量基本相同</p>
<p>如果预估自己的业务数据量大(日增百万以上, 并发插入大于10), 那么请写本地表</p>
<p>建议每次插入50W行左右数据, 最多不可超过100W行. 总之CH不像MySQL要小事务. 比如1000W行数据, MySQL建议一次插入1W左右, 使用小事务, 执行1000次. CH建议20次,每次50W. 这是MergeTree引擎原理决定的, 频繁少量插入会导致data part过多, 合并不过来.</p>
<p>再有, AP不像TP, TP为了避免建立新连接产生的损耗影响性能, 通常会使用长连接, 连接池等技术做优化. 但AP业务不需要, 因为AP的属性就不会有高并发, 小SQL.<br><a id="more"></a></p>
<h2 id="原因请继续看"><a href="#原因请继续看" class="headerlink" title="原因请继续看"></a>原因请继续看</h2><p>看了一些文档都建议写分布式表, 虽说别人没必要骗我们, 但是搞技术的不能人云亦云, 还是要明白为啥, 说实话我想了很久没想出直接写分布式表有什么致命缺陷, 于是在ClickHouse中文社区提了问题, 内容如下</p>
<p>看了sina高鹏大佬的分享，看了 <a href="https://github.com/ClickHouse/ClickHouse/issues/1854">https://github.com/ClickHouse/ClickHouse/issues/1854</a> ，还看了一些文章都是建议写本地表而不是分布式表<br>如果我设置 internal_replication=true , 使用 ReplicatedMergeTree 引擎, 除了写本地表更灵活可控外, 写分布式表到底有什么致命缺陷吗?<br>因为要给同事解释, 只说一个大家说最佳实践是这样是不行的.. 我自己也没理解到底写分布式表有啥大缺陷<br>如果说造成数据分布不均匀,  sharding key 我设为 rand() 还会有很大不均匀吗? 如果说扩容, 我也可以通过调整 weight 控制数据尽量写入新 shared 啊?</p>
<p>难道是因为：</p>
<blockquote>
<p>Data is written asynchronously. When inserted in the table, the data block is just written to the local file system. The data is sent to the remote servers in the background as soon as possible. The period for sending data is managed by the distributed_directory_monitor_sleep_time_ms and distributed_directory_monitor_max_sleep_time_ms settings. The Distributed engine sends each file with inserted data separately, but you can enable batch sending of files with the distributed_directory_monitor_batch_inserts setting. This setting improves cluster performance by better utilizing local server and network resources. You should check whether data is sent successfully by checking the list of files (data waiting to be sent) in the table directory: /var/lib/clickhouse/data/database/table/.</p>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>If the server ceased to exist or had a rough restart (for example, after a device failure) after an INSERT to a Distributed table, the inserted data might be lost. If a damaged data part is detected in the table directory, it is transferred to the ‘broken’ subdirectory and no longer used.</p>
</blockquote>
<p>上面文档内容我理解意思是说假如我有S1 S2 S3 三个节点,每个节点都有local表和分布式表. 我向S1的分布式表写数据1, 2, 3，<br>1写入S1, 2,3先写到S1本地文件系统, 然后异步发送到S2 S3 , 比如2发给S2, 3发给S3, 如果此时S3宕机了, 则3发到S3失败, 但是1,2还是成功写到S1,S2了? 所以整个过程不能保证原子性? <del>出现问题还要人为修数据?</del></p>
<p><a href="https://github.com/ClickHouse/ClickHouse/issues/1343">https://github.com/ClickHouse/ClickHouse/issues/1343</a> 这个issue说S3 come back后S1会尝试重新发送数据给S3.</p>
<blockquote>
<p>Data blocks are written in /var/lib/clickhouse/data/database/table/ folder. Special thread checks directory periodically and tries to send data. If it can’t, it will try next time.</p>
</blockquote>
<p>那么只剩文档最后一句意思是如果S1过程中宕机, 会丢数据?<br>自问自答一下吧,  weight 是分片级别的, 不是表级别的, 灵活性差</p>
<p>问了下新浪的高鹏<br><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/clickhouse-write_local_or_distribute_1.png" alt=""><br><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/clickhouse-write_local_or_distribute_2.png" alt=""><br>高鹏的回答总结一下就是:</p>
<ol>
<li>新浪每天增量是千亿级的, INSERT并发和节点数应该比较高, 直接写某个节点的分布式表, 这个节点还需要建立N-1个连接(N是集群节点数)分发数据, 再有就是他说的第3点</li>
<li>通过负载均衡向本地表插入数据要控制尽量每次插入数据建立一次连接, 每个链接插入的数据量要差不多, batch size不能太小, 否则data part过多, merge不过来clickhouse会报错</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;TL-DR&quot;&gt;&lt;a href=&quot;#TL-DR&quot; class=&quot;headerlink&quot; title=&quot;TL;DR&quot;&gt;&lt;/a&gt;TL;DR&lt;/h2&gt;&lt;p&gt;如果预估自己的业务数据量不大(日增不到百万行), 那么写分布式表和本地表都可以, 但要注意如果选择写本地表, 请保证每次写入数据都建立新的连接, 且每个连接写入的数据量基本相同&lt;/p&gt;
&lt;p&gt;如果预估自己的业务数据量大(日增百万以上, 并发插入大于10), 那么请写本地表&lt;/p&gt;
&lt;p&gt;建议每次插入50W行左右数据, 最多不可超过100W行. 总之CH不像MySQL要小事务. 比如1000W行数据, MySQL建议一次插入1W左右, 使用小事务, 执行1000次. CH建议20次,每次50W. 这是MergeTree引擎原理决定的, 频繁少量插入会导致data part过多, 合并不过来.&lt;/p&gt;
&lt;p&gt;再有, AP不像TP, TP为了避免建立新连接产生的损耗影响性能, 通常会使用长连接, 连接池等技术做优化. 但AP业务不需要, 因为AP的属性就不会有高并发, 小SQL.&lt;br&gt;
    
    </summary>
    
    
      <category term="ClickHouse" scheme="http://fuxkdb.com/tags/ClickHouse/"/>
    
  </entry>
  
  <entry>
    <title>增强半同步会不会丢数据</title>
    <link href="http://fuxkdb.com/2020/09/20/2020-09-20-%E5%A2%9E%E5%BC%BA%E5%8D%8A%E5%90%8C%E6%AD%A5%E4%BC%9A%E4%B8%8D%E4%BC%9A%E4%B8%A2%E6%95%B0%E6%8D%AE/"/>
    <id>http://fuxkdb.com/2020/09/20/2020-09-20-增强半同步会不会丢数据/</id>
    <published>2020-09-20T14:46:00.000Z</published>
    <updated>2020-09-20T14:47:09.090Z</updated>
    
    <content type="html"><![CDATA[<p>只讨论5.7增强半同步和双1的情况</p>
<h1 id="增强半同步会不会丢数据"><a href="#增强半同步会不会丢数据" class="headerlink" title="增强半同步会不会丢数据?"></a>增强半同步会不会丢数据?</h1><p>这里涉及两个过程:</p>
<ul>
<li>主库 Innodb与Binlog日志的2PC</li>
<li>增强半同步</li>
</ul>
<h2 id="Innodb与Binlog日志的2PC"><a href="#Innodb与Binlog日志的2PC" class="headerlink" title="Innodb与Binlog日志的2PC"></a>Innodb与Binlog日志的2PC</h2><p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/%E4%B8%A4%E9%98%B6%E6%AE%B5%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A42PC.png" alt="image-20200920221245427"></p>
<p>在开启Binlog后, MySQL内部会自动将普通事务当做一个XA事务来处理：</p>
<ul>
<li>自动为每个事务分配一个唯一的ID</li>
<li>COMMIT会被自动的分成Prepare和Commit两个阶段</li>
<li>Binlog会被当做事务协调者(Transaction Coordinator), Binlog Event会被当做协调者日志<a id="more"></a>
<h3 id="分布式事务ID-XID"><a href="#分布式事务ID-XID" class="headerlink" title="分布式事务ID(XID)"></a>分布式事务ID(XID)</h3></li>
</ul>
<p>使用2PC时, MySQL会自动的为每一个事务分配一个ID, 叫XID. XID是唯一的, 每个事务的XID都不相同. XID会分别被Binlog和InnoDB记入日志中, 供恢复时使用. MySQ内部的XID由三部分组成:</p>
<ul>
<li>前缀部分<br>前缀部分是字符串”MySQLXid”</li>
<li>Server ID部分<br>当前MySQL的server_id</li>
<li>query_id部分<br>为了保证XID的的唯一性, 数字部分使用了query_id. MySQL内部会自动的为每一个语句分配一个query_id, 全局唯一. </li>
</ul>
<h3 id="事务的协调者Binlog"><a href="#事务的协调者Binlog" class="headerlink" title="事务的协调者Binlog"></a>事务的协调者Binlog</h3><p>Binlog在2PC中充当了事务的协调者（Transaction Coordinator）. 由Binlog来通知InnoDB引擎来执行prepare, commit或者rollback的步骤. 事务提交的整个过程如下：</p>
<ol>
<li><p>协调者准备阶段(Prepare Phase)<br>告诉引擎做Prepare, InnoDB更改事务状态, 并将Redo Log刷入磁盘. </p>
<blockquote>
<p>个人理解: innodb写prepare log, 事务标记为prepare状态, 并写入xid</p>
</blockquote>
</li>
<li><p>协调者提交阶段(Commit Phase)<br>2.1 记录协调者日志, 即Binlog日志.<br>2.2 告诉引擎做commit. </p>
<blockquote>
<p>个人理解: 写Binlog event和xid, 写完后通知innodb commit, innodb写commit log, 事务标记为commit状态 (记得姜成尧说要写binlog file pos到redo)</p>
</blockquote>
</li>
</ol>
<p>注意：记录Binlog是在InnoDB引擎Prepare(即Redo Log写入磁盘)之后, 这点至关重要. </p>
<h3 id="协调者日志Xid-log-event"><a href="#协调者日志Xid-log-event" class="headerlink" title="协调者日志Xid_log_event"></a>协调者日志Xid_log_event</h3><p>作为协调者, Binlog需要将事务的XID记入日志, 供恢复时使用. Xid_log_event有以下几个特点：</p>
<ul>
<li><p>仅记录query_id<br>因为前缀部分不变, server_id已经记录在Event Header中, Xid_log_event中只记录query_id部分. </p>
</li>
<li><p>标志事务的结束<br>在Binlog中相当于一个事务的COMMIT语句.<br>一个事务在Binlog中看起来时这样的:</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Query_log_event(<span class="string">&quot;BEGIN&quot;</span>)<span class="comment">;</span></span><br><span class="line">DML产生的events<span class="comment">;              </span></span><br><span class="line">Xid_log_event<span class="comment">;  </span></span><br></pre></td></tr></table></figure>
</li>
<li><p>DDL没有BEGIN, 也没有Xid_log_event.</p>
</li>
<li><p>仅InnoDB的DML会产生Xid_log_event</p>
<p>因为MyISAM不支持2PC所以不能用Xid_log_event, 但会有COMMIT Event. </p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Query_log_event(<span class="string">&quot;BEGIN&quot;</span>)<span class="comment">;</span></span><br><span class="line">DML产生的events<span class="comment">;</span></span><br><span class="line">Query_log_event(<span class="string">&quot;COMMIT&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="恢复-Recovery"><a href="#恢复-Recovery" class="headerlink" title="恢复(Recovery)"></a>恢复(Recovery)</h3><p>这个机制是如何保证MySQL的CrashSafe的呢, 我们来分析一下. 这里我们假设用户设置了以下参数来保证可靠性:<br>sync_binlog=1<br>innodb_flush_log_at_trx_commit=1</p>
<h4 id="恢复前事务的状态"><a href="#恢复前事务的状态" class="headerlink" title="恢复前事务的状态"></a>恢复前事务的状态</h4><p>在恢复开始前事务有以下几种状态: </p>
<ul>
<li>InnoDB中已经提交<br>根据前面2PC的过程, 可知Binlog中也一定记录了该事务的的Events(我感觉说的应该是Xid_log_event). 所以这种事务是一致的不需要处理. </li>
<li>InnoDB中是prepared状态, Binlog中有该事务的Events(我感觉说的应该是Xid_log_event).<br>需要通知InnoDB提交这些事务. </li>
<li>InnoDB中是prepared状态, Binlog中没有该事务的Events(我感觉说的应该是Xid_log_event).<br>因为Binlog还没记录, 需要通知InnoDB回滚这些事务. </li>
<li>Before InnoDB Prepare<br>事务可能还没执行完, 因此InnoDB中的状态还没有prepare. 根据2PC的过程, Binlog中也没有该事务的events(我感觉说的应该是Xid_log_event).  需要通知InnoDB回滚这些事务. </li>
</ul>
<h4 id="恢复过程"><a href="#恢复过程" class="headerlink" title="恢复过程"></a>恢复过程</h4><p>从上面的事务状态可以看出: 恢复时事务要提交还是回滚, 是由Binlog来决定的. </p>
<ul>
<li>事务的Xid_log_event存在, 就要提交. </li>
<li>事务的Xid_log_event不存在, 就要回滚. </li>
</ul>
<p>恢复的过程非常简单: </p>
<ul>
<li>从Binlog中读出所有的Xid_log_event</li>
<li>告诉InnoDB提交这些XID的事务</li>
<li>InnoDB回滚其它的事务</li>
</ul>
<blockquote>
<p>了解了MySQL关于Innodb与Binlog的两阶段提交机制后，就可以更深入去探究MySQL在故障恢复时的处理过程。 在MySQL启动时，首先会初始化存储引擎，如本例中的InnoDB引擎，然后InnoDB引擎层会读取redolog进行InnoDB层的故障恢复，回滚未prepared和commit的事务，但对于已经prepared，但未commit的事务，暂时挂起，保存到一个链表中，等待后续读取binlog日志，然后根据binlog日志再对这部分prepared的事务进行处理。 接下来，MySQL会读取最后一个binlog文件。binlog文件通常是以固定的文件名加一组连续的编号来命名的，并且将其记录到一个binlog索引文件中，因此索引文件中的最后一个binlog文件即是MySQL将要读取的最后一个binlog文件。 读取这个binlog文件时，通过文件头上是否存在标记LOG_EVENT_BINLOG_IN_USE_F，通过这个标记可以知道上次MySQL是正常关闭还是异常关闭，如果是异常关闭，则会进入故障恢复过程。 进入故障恢复过程后，会依次读取最后一个binlog文件中的所有log event，并将所有已提交事务的binlog日志中记录的xid提取出来添加到hash表中，以备后续对前述InnoDB故障恢复后遗留的Prepared事务继续处理。另外此处还要定位最后一个完整事务的位置，防止在上次系统异常关闭时有部分binlog日志未刷到磁盘上，即存在写了一半的binlog事务日志，这部分写了一半binlog日志的事务在MySQL中会按事务未提交来处理，后续会将其在存储引擎层回滚。当此文件中的内容全部读出之后，一是得到一个已提交事务的列表，另一个是最后一个完整事务的位置。 然后检查由InnoDB层得到的Prepared事务列表，若Prepared事务在从Binlog中得到的提交事务列表中，则在InnoDB层提交此事务，否则回滚此事务。</p>
<p>出自<a href="http://mysql.taobao.org/monthly/2018/12/04/">MySQL · 原理介绍 · 再议MySQL的故障恢复</a></p>
</blockquote>
<p>疑问1：如果事务的Binlog Event只记录了一部分怎么办？<br>只有最后一个事务的Event会发生这样的情况。在恢复时，binlog会自动的将这个不完整的事务Events从Binlog文件中给清除掉。</p>
<p>疑问2：随着长时间的运行，Binlog中会积累了很多Xid_log_event，读取所有的Xid_log_event会不会效率很低？</p>
<p>当然很低，所以Binlog中有一个机制来保证恢复时只用读取最后一个Binlog文件中的Xid_log_event。这种机制很像一个简单的Xid_log_event的checkpoint机制。</p>
<h3 id="CrashSafe的写盘次数"><a href="#CrashSafe的写盘次数" class="headerlink" title="CrashSafe的写盘次数"></a>CrashSafe的写盘次数</h3><p>前面说道要想保证CrashSafe就要设置下面两个参数为1:<br>sync_binlog=1<br>innodb_flush_log_at_trx_commit=1<br>下面我们来看看这两个参数的作用. </p>
<ul>
<li>sync_binlog<br>sync_binlog是控制Binlog写盘的, 1表示每次都写. 由于Binlog使用了组提交(Group Commit)的机制, 它代表一组事务提交时必须要将Binlog文件写入硬件存储1次. </li>
<li>innodb_flush_log_at_trx_commit的写盘次数<br>这个变量是用来控制InnoDB commit时写盘的方法的. 现在commit被分成了两个阶段, 到底在哪个阶段写盘, 还是两个阶段都要写盘呢？</li>
<li>Prepare阶段时需要写盘<br>2PC要求在Prepare时就要将数据持久化, 只有这样, 恢复时才能提交已经记录了Xid_log_event的事务. </li>
<li>Commit阶段时不需要写盘<br>如果Commit阶段不写盘, 会造成什么结果呢？已经Cmmit了的事务, 在恢复时的状态可能是Prepared. 由于恢复时, Prepared的事务可以通过Xid_log_event来提交事务, 所以在恢复后事务的状态就是正确的. 因此在Commit阶段不需要写盘. </li>
</ul>
<p>总的来说保证MySQL服务的CrashSafe需要写两次盘. 在2PC的过程中, InnoDB只在prepare阶段时, 写一次盘. Binlog在commit阶段, 会设置一个参数告诉InnoDB不要写盘. 这个参数是thd-&gt;durability_property= HA_IGNORE_DURABILITY;代码在sql/binlog.cc的MYSQL_BIN_LOG::ordered_commit()中. </p>
<blockquote>
<p>以上出自<a href="https://mp.weixin.qq.com/s?src=3&amp;timestamp=1600608182&amp;ver=1&amp;signature=7PcxRxHo*jSo46v0Kshb3IIjH9Lh4pCYNeYXo5BGiJiV0l2b2h4DWBZ7YUzeN5YVvd0M4f46kIDePrZBrrmYMUtT4vRFlTikTdd4MtMQr5ICc0pkdb05YZ0DLGljcSJTVavt4DVznIeh9dp5aZUVbFpKrHVM1x*eBslTBbqg4VQ=">MySQL的CrashSafe和Binlog的关系</a></p>
</blockquote>
<h2 id="增强半同步"><a href="#增强半同步" class="headerlink" title="增强半同步"></a>增强半同步</h2><p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/%E5%A2%9E%E5%BC%BA%E5%8D%8A%E5%90%8C%E6%AD%A5.png" alt="image-20200920204457490"><br>对于增强半同步, 主要有两种情况:</p>
<ul>
<li>主库写binlog落盘后, Binlog dump线程发送binlog给从库, 从库IO thread接收写入relay log, 但是没有写入完, 主库挂了</li>
<li>从库IO thread成功写入relay log后, 还没发送ACK或ACK发送了但是主库收到前, 主库挂了</li>
</ul>
<h3 id="第一种情况"><a href="#第一种情况" class="headerlink" title="第一种情况"></a>第一种情况</h3><p>对应用来说, 并没有收到commit ok的信息, 应当认为事务提交失败.</p>
<p>对于主库, 因为已经写了Binlog(写了Xid_log_event), 只是还没有写commit log, crash recover后, 这部分事务又会提交掉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">假设一主一从半同步</span><br><span class="line"></span><br><span class="line">root@localhost 19:23:00 [dbms_monitor]&gt; show global variables like &#x27;%semi%&#x27;;</span><br><span class="line">+<span class="comment">-------------------------------------------+------------+</span></span><br><span class="line">| Variable_name                             | Value      |</span><br><span class="line">+<span class="comment">-------------------------------------------+------------+</span></span><br><span class="line">| rpl_semi_sync_master_enabled              | OFF        |</span><br><span class="line">| rpl_semi_sync_master_timeout              | 10000      |</span><br><span class="line">| rpl_semi_sync_master_trace_level          | 32         |</span><br><span class="line">| rpl_semi_sync_master_wait_for_slave_count | 1          |</span><br><span class="line">| rpl_semi_sync_master_wait_no_slave        | ON         |</span><br><span class="line">| rpl_semi_sync_master_wait_point           | AFTER_SYNC |</span><br><span class="line">| rpl_semi_sync_slave_enabled               | OFF        |</span><br><span class="line">| rpl_semi_sync_slave_trace_level           | 32         |</span><br><span class="line">+<span class="comment">-------------------------------------------+------------+</span></span><br><span class="line">8 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">19</span>:<span class="number">23</span>:<span class="number">02</span> [dbms_monitor]&gt; <span class="keyword">truncate</span> <span class="keyword">table</span> semi_sync;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 19:23:15 [dbms_monitor]&gt;  show global status like &#x27;%semi%&#x27;;   </span><br><span class="line">+<span class="comment">--------------------------------------------+-------+</span></span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+<span class="comment">--------------------------------------------+-------+</span></span><br><span class="line">| Rpl_semi_sync_master_clients               | 1     |</span><br><span class="line">| Rpl_semi_sync_master_net_avg_wait_time     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_wait_time         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_net_waits             | 18    |</span><br><span class="line">| Rpl_semi_sync_master_no_times              | 1     |</span><br><span class="line">| Rpl_semi_sync_master_no_tx                 | 2     |</span><br><span class="line">| Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">| Rpl_semi_sync_master_timefunc_failures     | 0     |</span><br><span class="line">| Rpl_semi_sync_master_tx_avg_wait_time      | 555   |</span><br><span class="line">| Rpl_semi_sync_master_tx_wait_time          | 5000  |</span><br><span class="line">| Rpl_semi_sync_master_tx_waits              | 9     |</span><br><span class="line">| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |</span><br><span class="line">| Rpl_semi_sync_master_wait_sessions         | 0     |</span><br><span class="line">| Rpl_semi_sync_master_yes_tx                | 9     |</span><br><span class="line">| Rpl_semi_sync_slave_status                 | OFF   |</span><br><span class="line">+<span class="comment">--------------------------------------------+-------+</span></span><br><span class="line">15 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">19</span>:<span class="number">23</span>:<span class="number">44</span> [dbms_monitor]&gt; <span class="keyword">set</span> <span class="keyword">global</span> rpl_semi_sync_master_timeout=<span class="number">999999</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost 19:23:52 [dbms_monitor]&gt;  insert into semi_sync values(1, now());</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">slave:</span><br><span class="line">root@localhost 19:24:10 [(none)]&gt; select * from dbms_monitor.semi_sync;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-09-20 19:24:01 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>可以看到当前是半同步状态, 主库rpl_semi_sync_master_timeout=999999, 写入了一条数据.</p>
<p>我们关闭从库, 之后开三个窗口执行三个insert</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 19:24:50 [dbms_monitor]&gt; insert into semi_sync values(2, now());</span><br><span class="line"></span><br><span class="line">root@localhost 17:41:52 [dbms_monitor]&gt; insert into semi_sync values(3, now());</span><br><span class="line"></span><br><span class="line">root@localhost 17:41:52 [dbms_monitor]&gt; insert into semi_sync values(4, now());</span><br></pre></td></tr></table></figure>
<p>由于rpl_semi_sync_master_wait_for_slave_count=1, 所以三个insert都在等待.</p>
<p>此时kill主库, 然后重启主库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos-1 mysql5731]<span class="comment"># ps -ef| grep mysqld</span></span><br><span class="line">root      29734  29681  0 17:33 pts/5    00:00:00 tail -f /data/mysql_3358/logs/mysqld.log</span><br><span class="line">root      29743  29626  0 17:33 pts/4    00:00:00 /bin/sh ./bin/mysqld_safe --defaults-file=/data/mysql_3358/my_3358.cnf --user=mysql</span><br><span class="line">mysql     31479  29743  0 17:33 pts/4    00:00:32 /usr/<span class="built_in">local</span>/mysql5731/bin/mysqld --defaults-file=/data/mysql_3358/my_3358.cnf --basedir=/usr/<span class="built_in">local</span>/mysql5731 --datadir=/data/mysql_3358/data --plugin-dir=/usr/<span class="built_in">local</span>/mysql5731/lib/mysql/plugin --user=mysql --<span class="built_in">log</span>-error=/data/mysql_3358/logs/mysqld.log --open-files-limit=65535 --pid-file=/data/mysql_3358/run/mysql.pid --socket=/data/mysql_3358/run/mysql.sock --port=3358</span><br><span class="line">root      32730  29626  0 19:25 pts/4    00:00:00 grep --color=auto mysqld</span><br><span class="line">[root@centos-1 mysql5731]<span class="comment"># kill -9 29743 31479</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos-1 mysql5731]<span class="comment"># ./bin/mysqld_safe --defaults-file=/data/mysql_3358/my_3358.cnf --user=mysql &amp;</span></span><br><span class="line">[2] 32735</span><br><span class="line">[root@centos-1 mysql5731]<span class="comment">#  mysqld_safe Adding &#x27;/usr/local/mysql5731/lib/mysql/libjemalloc.so.1&#x27; to LD_PRELOAD for mysqld</span></span><br><span class="line">2020-09-20T11:26:12.801721Z mysqld_safe Logging to <span class="string">&#x27;/data/mysql_3358/logs/mysqld.log&#x27;</span>.</span><br><span class="line">2020-09-20T11:26:12.824485Z mysqld_safe Starting mysqld daemon with databases from /data/mysql_3358/data</span><br></pre></td></tr></table></figure>
<p>查看数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 19:26:44 [dbms_monitor]&gt; select * from semi_sync;</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">| id | ctime               |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">|  1 | 2020-09-20 19:24:01 |</span><br><span class="line">|  2 | 2020-09-20 19:25:08 |</span><br><span class="line">|  3 | 2020-09-20 19:25:10 |</span><br><span class="line">|  4 | 2020-09-20 19:25:11 |</span><br><span class="line">+<span class="comment">----+---------------------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>可以看到, 三个insert在crash recover后成功提交了</p>
<p>由此可以看出, 主库宕机恢复后是不能作为从库加入原集群的, 需要重做, 否则数据不一致.</p>
<h3 id="第二种情况"><a href="#第二种情况" class="headerlink" title="第二种情况"></a>第二种情况</h3><p>对应用来说, 并没有收到commit ok的信息, 应当认为事务提交失败.</p>
<p>但是由于这部分事务已经写入了relay log, 从库sql thread应用完relay log中所有binlog event后提升为主库, 此时应用连接到新主库, 准备重试, 那么可能会出现问题:</p>
<ul>
<li><p>对于INSERT: </p>
<p>如果INSERT语句中没有显式指定主键或任何唯一键, 那么应用重试插入后, 会出现重复数据.</p>
</li>
<li><p>对于UPDATE</p>
<p>如果采用update set amount=amount-1000 where id的方式重试, 会出现重复扣款, 所以即便重试, where条件中也应当带上要更新列的原值</p>
</li>
<li><p>对于DELETE</p>
<p>没什么影响, 只是影响行数为0</p>
</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>不会丢数据.</p>
<p>对于MHA+增强半同步, 主从切换后, 业务不能盲目重试, 而应当做事务执行失败, 按照正常逻辑重新执行完整的事务.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;只讨论5.7增强半同步和双1的情况&lt;/p&gt;
&lt;h1 id=&quot;增强半同步会不会丢数据&quot;&gt;&lt;a href=&quot;#增强半同步会不会丢数据&quot; class=&quot;headerlink&quot; title=&quot;增强半同步会不会丢数据?&quot;&gt;&lt;/a&gt;增强半同步会不会丢数据?&lt;/h1&gt;&lt;p&gt;这里涉及两个过程:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;主库 Innodb与Binlog日志的2PC&lt;/li&gt;
&lt;li&gt;增强半同步&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Innodb与Binlog日志的2PC&quot;&gt;&lt;a href=&quot;#Innodb与Binlog日志的2PC&quot; class=&quot;headerlink&quot; title=&quot;Innodb与Binlog日志的2PC&quot;&gt;&lt;/a&gt;Innodb与Binlog日志的2PC&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/%E4%B8%A4%E9%98%B6%E6%AE%B5%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A42PC.png&quot; alt=&quot;image-20200920221245427&quot;&gt;&lt;/p&gt;
&lt;p&gt;在开启Binlog后, MySQL内部会自动将普通事务当做一个XA事务来处理：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;自动为每个事务分配一个唯一的ID&lt;/li&gt;
&lt;li&gt;COMMIT会被自动的分成Prepare和Commit两个阶段&lt;/li&gt;
&lt;li&gt;Binlog会被当做事务协调者(Transaction Coordinator), Binlog Event会被当做协调者日志
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="半同步" scheme="http://fuxkdb.com/tags/%E5%8D%8A%E5%90%8C%E6%AD%A5/"/>
    
  </entry>
  
  <entry>
    <title>innodb_status_file innodb_status_output innodb_status_output_locks和innodb_show_verbose_locks</title>
    <link href="http://fuxkdb.com/2020/09/13/2020-09-13-innodb_status_file-innodb_status_output-innodb_status_output_locks%E5%92%8Cinnodb_show_verbose_locks/"/>
    <id>http://fuxkdb.com/2020/09/13/2020-09-13-innodb_status_file-innodb_status_output-innodb_status_output_locks和innodb_show_verbose_locks/</id>
    <published>2020-09-13T02:33:00.000Z</published>
    <updated>2020-09-13T02:34:06.383Z</updated>
    
    <content type="html"><![CDATA[<h1 id="innodb-status-file"><a href="#innodb-status-file" class="headerlink" title="innodb_status_file"></a>innodb_status_file</h1><p>这个参数官方文档<a href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variable-reference.html">https://dev.mysql.com/doc/refman/5.7/en/server-system-variable-reference.html</a> 中没有</p>
<p>在<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html</a> 中有</p>
<p><code>--innodb-status-file</code></p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Command-Line Format</td>
<td>`–innodb-status-file[={OFF</td>
<td>ON}]`</td>
</tr>
<tr>
<td>Type</td>
<td>Boolean</td>
</tr>
<tr>
<td>Default Value</td>
<td><code>OFF</code></td>
</tr>
</tbody>
</table>
<p>The <code>--innodb-status-file</code> startup option controls whether <code>InnoDB</code> creates a file named <code>innodb_status.*</code>pid<code>*</code> in the data directory and writes <a href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> output to it every 15 seconds, approximately.</p>
<p>The <code>innodb_status.*</code>pid<code>*</code> file is not created by default. To create it, start <a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld.html"><strong>mysqld</strong></a> with the <code>--innodb-status-file</code> option. <code>InnoDB</code> removes the file when the server is shut down normally. If an abnormal shutdown occurs, the status file may have to be removed manually.</p>
<p>The <code>--innodb-status-file</code> option is intended for temporary use, as <a href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> output generation can affect performance, and the <code>innodb_status.*</code>pid<code>*</code> file can become quite large over time.</p>
<p>For related information, see <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-enabling-monitors.html">Section 14.18.2, “Enabling InnoDB Monitors”</a>.</p>
<a id="more"></a>
<blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-enabling-monitors.html">Section 14.18.2, “Enabling InnoDB Monitors”</a>.</p>
<h4 id="Directing-Standard-InnoDB-Monitor-Output-to-a-Status-File"><a href="#Directing-Standard-InnoDB-Monitor-Output-to-a-Status-File" class="headerlink" title="Directing Standard InnoDB Monitor Output to a Status File"></a>Directing Standard InnoDB Monitor Output to a Status File</h4><p>Standard <code>InnoDB</code> Monitor output can be enabled and directed to a status file by specifying the <code>--innodb-status-file</code> option at startup. When this option is used, <code>InnoDB</code> creates a file named <code>innodb_status.*</code>pid<code>*</code> in the data directory and writes output to it every 15 seconds, approximately.</p>
<p><code>InnoDB</code> removes the status file when the server is shut down normally. If an abnormal shutdown occurs, the status file may have to be removed manually.</p>
<p>The <code>--innodb-status-file</code> option is intended for temporary use, as output generation can affect performance, and the <code>innodb_status.*</code>pid<code>*</code> file can become quite large over time.</p>
</blockquote>
<p>非动态参数, 可以再my.cnf中添加<code>innodb_status_file=1</code>启用</p>
<p>开启后会在datadir下生成一个innodb_status.pid文件, 周期性15秒向这个文件输出<code>show engine innodb status</code>. 如果异常关闭数据库, 这个文件不会被删除</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/innodb_status_file.png" alt=""></p>
<p>看文档意思<code>the</code>innodb_status.<em><code>pid</code></em><code>file can become quite large over time.</code>, 但我看不会表达, 他不是追加写入, 起码percona分支是这样, 上面的图是官方分支, 也没有追加</p>
<h1 id="innodb-status-output"><a href="#innodb-status-output" class="headerlink" title="innodb_status_output"></a>innodb_status_output</h1><p>开启后会周期性向error log输出<code>show engine innodb status</code></p>
<h1 id="innodb-status-output-locks"><a href="#innodb-status-output-locks" class="headerlink" title="innodb_status_output_locks"></a>innodb_status_output_locks</h1><p>单独开这个影响<code>show engine innodb status</code>. 这个参数参数配合<code>innodb_status_file</code>或<code>innodb_status_output</code>使用时, 当前两者开启, 则会向前两者输出位置输出锁信息</p>
<p><code>innodb_status_output_locks=off</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5781</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">5776 </span><span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">33</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761960688</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761961816</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5780</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">36</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">13</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140502089910016</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">257</span> <span class="string">localhost</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<p><code>innodb_status_output_locks=on</code>, <code>innodb_show_verbose_locks=0</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5781</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">5776 </span><span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">33</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761960688</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761961816</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5780</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">185</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">13</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140502089910016</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">257</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"><span class="string">TABLE</span> <span class="string">LOCK</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5780 </span><span class="string">lock</span> <span class="string">mode</span> <span class="string">IX</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">133</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">4</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">DealerAndBrokerAndDropped</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5780 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">133</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">3</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">PRIMARY</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5780 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br></pre></td></tr></table></figure>
<p><code>innodb_status_output_locks=on</code>, <code>innodb_show_verbose_locks=1</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5781</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">5776 </span><span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">33</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761960688</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761961816</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5780</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">48</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">13</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140502089910016</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">257</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"><span class="string">TABLE</span> <span class="string">LOCK</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5780 </span><span class="string">lock</span> <span class="string">mode</span> <span class="string">IX</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">133</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">4</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">DealerAndBrokerAndDropped</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5780 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">Record</span> <span class="string">lock,</span> <span class="attr">heap no 2 PHYSICAL RECORD:</span> <span class="string">n_fields</span> <span class="number">4</span><span class="string">;</span> <span class="string">compact</span> <span class="string">format;</span> <span class="string">info</span> <span class="string">bits</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">1:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">2:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">80</span><span class="string">;</span> <span class="string">asc</span>  <span class="string">;;</span></span><br><span class="line"> <span class="attr">3:</span> <span class="string">len</span> <span class="number">8</span><span class="string">;</span> <span class="string">hex</span> <span class="number">8000000000000001</span><span class="string">;</span> <span class="string">asc</span>         <span class="string">;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">133</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">3</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">PRIMARY</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5780 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">Record</span> <span class="string">lock,</span> <span class="attr">heap no 2 PHYSICAL RECORD:</span> <span class="string">n_fields</span> <span class="number">7</span><span class="string">;</span> <span class="string">compact</span> <span class="string">format;</span> <span class="string">info</span> <span class="string">bits</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0:</span> <span class="string">len</span> <span class="number">8</span><span class="string">;</span> <span class="string">hex</span> <span class="number">8000000000000001</span><span class="string">;</span> <span class="string">asc</span>         <span class="string">;;</span></span><br><span class="line"> <span class="attr">1:</span> <span class="string">len</span> <span class="number">6</span><span class="string">;</span> <span class="string">hex</span> <span class="number">000000001647</span><span class="string">;</span> <span class="string">asc</span>      <span class="string">G;;</span></span><br><span class="line"> <span class="attr">2:</span> <span class="string">len</span> <span class="number">7</span><span class="string">;</span> <span class="string">hex</span> <span class="string">b6000000040110;</span> <span class="string">asc</span>        <span class="string">;;</span></span><br><span class="line"> <span class="attr">3:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">4:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">5:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">80</span><span class="string">;</span> <span class="string">asc</span>  <span class="string">;;</span></span><br><span class="line"> <span class="attr">6:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">61</span><span class="string">;</span> <span class="string">asc</span> <span class="string">a;;</span></span><br></pre></td></tr></table></figure>
<h1 id="innodb-show-verbose-locks"><a href="#innodb-show-verbose-locks" class="headerlink" title="innodb_show_verbose_locks"></a>innodb_show_verbose_locks</h1><p>percona分支参数</p>
<ul>
<li><p><em>variable</em> <code>innodb_show_verbose_locks</code></p>
<p>Command Line:YesConfig File:YesScope:GlobalDynamic:YesVariable Type:ULONGDefault Value:0Range:0 - 1</p>
</li>
</ul>
<p>Specifies to show records locked in <code>SHOW ENGINE INNODB STATUS</code>. The default is <code>0</code>, which means only the higher-level information about the lock (which table and index is locked, etc.) is printed. If set to <code>1</code>, then traditional <em>InnoDB</em> behavior is enabled: the records that are locked are dumped to the output.</p>
<p>官方分支没这个参数, 这个参数影响<code>innodb_print_all_deadlocks</code>和前面三个参数. </p>
<p>例如<code>innodb_show_verbose_locks=0</code>, <code>innodb_print_all_deadlocks=1</code>, 则error log中死锁信息为</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.703878</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: Transactions deadlock detected, dumping detailed information.</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.703949</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: </span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">5127</span>, ACTIVE <span class="number">5</span> sec starting index read</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">2</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">1</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">3</span>, OS thread handle <span class="number">140073055278848</span>, query id <span class="number">26</span> localhost root statistics</span><br><span class="line">select u_c <span class="keyword">from</span> t8 where d_id=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> b_id=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> is_dropped=<span class="number">0</span> <span class="keyword">for</span> update</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.703987</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">128</span> page no <span class="number">4</span> n bits <span class="number">80</span> index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id <span class="number">5127</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.704003</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">5126</span>, ACTIVE <span class="number">9</span> sec starting index read</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">4</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">3</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">4</span>, OS thread handle <span class="number">140073055008512</span>, query id <span class="number">27</span> localhost root updating</span><br><span class="line">update t8 <span class="keyword">set</span> u_c=<span class="string">&#x27;b&#x27;</span> where d_id=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> b_id=<span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.704016</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">128</span> page no <span class="number">4</span> n bits <span class="number">80</span> index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id <span class="number">5126</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.704025</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">128</span> page no <span class="number">4</span> n bits <span class="number">80</span> index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id <span class="number">5126</span> lock_mode X waiting</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">24</span>:<span class="number">29.704034</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** WE ROLL BACK TRANSACTION (<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><code>innodb_show_verbose_locks=1</code>, <code>innodb_print_all_deadlocks=1</code>, 则error log中死锁信息为</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.575868</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: Transactions deadlock detected, dumping detailed information.</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.575923</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: </span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">5130</span>, ACTIVE <span class="number">6</span> sec starting index read</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">2</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">1</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">3</span>, OS thread handle <span class="number">140073055278848</span>, query id <span class="number">38</span> localhost root statistics</span><br><span class="line">select u_c <span class="keyword">from</span> t8 where d_id=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> b_id=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> is_dropped=<span class="number">0</span> <span class="keyword">for</span> update</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.575945</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">128</span> page no <span class="number">4</span> n bits <span class="number">80</span> index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id <span class="number">5130</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br><span class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">1</span>; hex <span class="number">31</span>; asc <span class="number">1</span>;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">31</span>; asc <span class="number">1</span>;;</span><br><span class="line"> <span class="number">2</span>: len <span class="number">1</span>; hex <span class="number">80</span>; asc  ;;</span><br><span class="line"> <span class="number">3</span>: len <span class="number">8</span>; hex <span class="number">8000000000000001</span>; asc         ;;</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.576779</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">5129</span>, ACTIVE <span class="number">8</span> sec starting index read</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">4</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">3</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">4</span>, OS thread handle <span class="number">140073055008512</span>, query id <span class="number">39</span> localhost root updating</span><br><span class="line">update t8 <span class="keyword">set</span> u_c=<span class="string">&#x27;b&#x27;</span> where d_id=<span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> b_id=<span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.576798</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">128</span> page no <span class="number">4</span> n bits <span class="number">80</span> index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id <span class="number">5129</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">1</span>; hex <span class="number">31</span>; asc <span class="number">1</span>;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">31</span>; asc <span class="number">1</span>;;</span><br><span class="line"> <span class="number">2</span>: len <span class="number">1</span>; hex <span class="number">80</span>; asc  ;;</span><br><span class="line"> <span class="number">3</span>: len <span class="number">8</span>; hex <span class="number">8000000000000001</span>; asc         ;;</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.576847</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">128</span> page no <span class="number">4</span> n bits <span class="number">80</span> index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id <span class="number">5129</span> lock_mode X waiting</span><br><span class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">1</span>; hex <span class="number">31</span>; asc <span class="number">1</span>;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">31</span>; asc <span class="number">1</span>;;</span><br><span class="line"> <span class="number">2</span>: len <span class="number">1</span>; hex <span class="number">80</span>; asc  ;;</span><br><span class="line"> <span class="number">3</span>: len <span class="number">8</span>; hex <span class="number">8000000000000001</span>; asc         ;;</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-15</span>T10:<span class="number">54</span>:<span class="number">23.576896</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">4</span> [Note] InnoDB: *** WE ROLL BACK TRANSACTION (<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><code>innodb_status_output=1</code>,<code>innodb_show_verbose_locks=0或1</code>, <code>innodb_status_output_locks=off</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5134</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">5132 </span><span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">2</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421547726605656</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421547726604528</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5132</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">93</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">6</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140073054738176</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">60</span> <span class="string">localhost</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<p><code>innodb_status_output=1</code>,<code>innodb_show_verbose_locks=0</code>, <code>innodb_status_output_locks=on</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5134</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">5132 </span><span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">2</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421547726605656</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421547726604528</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5132</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">287</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">6</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140073054738176</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">60</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"><span class="string">TABLE</span> <span class="string">LOCK</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5132 </span><span class="string">lock</span> <span class="string">mode</span> <span class="string">IX</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">4</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">DealerAndBrokerAndDropped</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5132 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">3</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">PRIMARY</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5132 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br></pre></td></tr></table></figure>
<p><code>innodb_status_output=1</code>,<code>innodb_show_verbose_locks=1</code>, <code>innodb_status_output_locks=on</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5134</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">5132 </span><span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">2</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421547726605656</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421547726604528</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5132</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">132</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">6</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140073054738176</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">60</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"><span class="string">TABLE</span> <span class="string">LOCK</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5132 </span><span class="string">lock</span> <span class="string">mode</span> <span class="string">IX</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">4</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">DealerAndBrokerAndDropped</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5132 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">Record</span> <span class="string">lock,</span> <span class="attr">heap no 2 PHYSICAL RECORD:</span> <span class="string">n_fields</span> <span class="number">4</span><span class="string">;</span> <span class="string">compact</span> <span class="string">format;</span> <span class="string">info</span> <span class="string">bits</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">1:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">2:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">80</span><span class="string">;</span> <span class="string">asc</span>  <span class="string">;;</span></span><br><span class="line"> <span class="attr">3:</span> <span class="string">len</span> <span class="number">8</span><span class="string">;</span> <span class="string">hex</span> <span class="number">8000000000000001</span><span class="string">;</span> <span class="string">asc</span>         <span class="string">;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">3</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">PRIMARY</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5132 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">Record</span> <span class="string">lock,</span> <span class="attr">heap no 2 PHYSICAL RECORD:</span> <span class="string">n_fields</span> <span class="number">7</span><span class="string">;</span> <span class="string">compact</span> <span class="string">format;</span> <span class="string">info</span> <span class="string">bits</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0:</span> <span class="string">len</span> <span class="number">8</span><span class="string">;</span> <span class="string">hex</span> <span class="number">8000000000000001</span><span class="string">;</span> <span class="string">asc</span>         <span class="string">;;</span></span><br><span class="line"> <span class="attr">1:</span> <span class="string">len</span> <span class="number">6</span><span class="string">;</span> <span class="string">hex</span> <span class="string">00000000103f;</span> <span class="string">asc</span>      <span class="string">?;;</span></span><br><span class="line"> <span class="attr">2:</span> <span class="string">len</span> <span class="number">7</span><span class="string">;</span> <span class="string">hex</span> <span class="string">b0000000040110;</span> <span class="string">asc</span>        <span class="string">;;</span></span><br><span class="line"> <span class="attr">3:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">4:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">5:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">80</span><span class="string">;</span> <span class="string">asc</span>  <span class="string">;;</span></span><br><span class="line"> <span class="attr">6:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">61</span><span class="string">;</span> <span class="string">asc</span> <span class="string">a;;</span></span><br></pre></td></tr></table></figure>
<p>对于status_file一样</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">status_file</span> <span class="string">v0</span> <span class="string">v1</span> <span class="string">off</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5640</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">0</span> <span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">0</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761961816</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5639</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">301</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">3</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140502089639680</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">23</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="string">status_file</span> <span class="string">v0</span> <span class="string">on</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5640</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">0</span> <span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">0</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761961816</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5639</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">901</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">3</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140502089639680</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">23</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"><span class="string">TABLE</span> <span class="string">LOCK</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5639 </span><span class="string">lock</span> <span class="string">mode</span> <span class="string">IX</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">4</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">DealerAndBrokerAndDropped</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5639 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">3</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">PRIMARY</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5639 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"></span><br><span class="line"><span class="string">status_file</span>  <span class="string">v1</span> <span class="string">on</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">TRANSACTIONS</span></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="string">Trx</span> <span class="string">id</span> <span class="string">counter</span> <span class="number">5640</span></span><br><span class="line"><span class="string">Purge</span> <span class="string">done</span> <span class="string">for</span> <span class="string">trx&#x27;s</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="number">0</span> <span class="string">undo</span> <span class="string">n:o</span> <span class="string">&lt;</span> <span class="attr">0 state:</span> <span class="string">running</span> <span class="string">but</span> <span class="string">idle</span></span><br><span class="line"><span class="string">History</span> <span class="string">list</span> <span class="string">length</span> <span class="number">0</span></span><br><span class="line"><span class="attr">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">421976761961816</span><span class="string">,</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="number">0</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">0</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">---TRANSACTION</span> <span class="number">5639</span><span class="string">,</span> <span class="string">ACTIVE</span> <span class="number">561</span> <span class="string">sec</span></span><br><span class="line"><span class="number">3</span> <span class="string">lock</span> <span class="string">struct(s),</span> <span class="string">heap</span> <span class="string">size</span> <span class="number">1136</span><span class="string">,</span> <span class="number">2</span> <span class="string">row</span> <span class="string">lock(s)</span></span><br><span class="line"><span class="string">MySQL</span> <span class="string">thread</span> <span class="string">id</span> <span class="number">3</span><span class="string">,</span> <span class="string">OS</span> <span class="string">thread</span> <span class="string">handle</span> <span class="number">140502089639680</span><span class="string">,</span> <span class="string">query</span> <span class="string">id</span> <span class="number">23</span> <span class="string">localhost</span> <span class="string">root</span></span><br><span class="line"><span class="string">TABLE</span> <span class="string">LOCK</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5639 </span><span class="string">lock</span> <span class="string">mode</span> <span class="string">IX</span></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">4</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">DealerAndBrokerAndDropped</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5639 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">Record</span> <span class="string">lock,</span> <span class="attr">heap no 2 PHYSICAL RECORD:</span> <span class="string">n_fields</span> <span class="number">4</span><span class="string">;</span> <span class="string">compact</span> <span class="string">format;</span> <span class="string">info</span> <span class="string">bits</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">1:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">2:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">80</span><span class="string">;</span> <span class="string">asc</span>  <span class="string">;;</span></span><br><span class="line"> <span class="attr">3:</span> <span class="string">len</span> <span class="number">8</span><span class="string">;</span> <span class="string">hex</span> <span class="number">8000000000000001</span><span class="string">;</span> <span class="string">asc</span>         <span class="string">;;</span></span><br><span class="line"></span><br><span class="line"><span class="string">RECORD</span> <span class="string">LOCKS</span> <span class="string">space</span> <span class="string">id</span> <span class="number">128</span> <span class="string">page</span> <span class="literal">no</span> <span class="number">3</span> <span class="string">n</span> <span class="string">bits</span> <span class="number">80</span> <span class="string">index</span> <span class="string">PRIMARY</span> <span class="string">of</span> <span class="string">table</span> <span class="string">`fanboshi`.`t8`</span> <span class="string">trx</span> <span class="string">id</span> <span class="number">5639 </span><span class="string">lock_mode</span> <span class="string">X</span> <span class="string">locks</span> <span class="string">rec</span> <span class="string">but</span> <span class="string">not</span> <span class="string">gap</span></span><br><span class="line"><span class="string">Record</span> <span class="string">lock,</span> <span class="attr">heap no 2 PHYSICAL RECORD:</span> <span class="string">n_fields</span> <span class="number">7</span><span class="string">;</span> <span class="string">compact</span> <span class="string">format;</span> <span class="string">info</span> <span class="string">bits</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">0:</span> <span class="string">len</span> <span class="number">8</span><span class="string">;</span> <span class="string">hex</span> <span class="number">8000000000000001</span><span class="string">;</span> <span class="string">asc</span>         <span class="string">;;</span></span><br><span class="line"> <span class="attr">1:</span> <span class="string">len</span> <span class="number">6</span><span class="string">;</span> <span class="string">hex</span> <span class="string">00000000103f;</span> <span class="string">asc</span>      <span class="string">?;;</span></span><br><span class="line"> <span class="attr">2:</span> <span class="string">len</span> <span class="number">7</span><span class="string">;</span> <span class="string">hex</span> <span class="string">b0000000040110;</span> <span class="string">asc</span>        <span class="string">;;</span></span><br><span class="line"> <span class="attr">3:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">4:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">31</span><span class="string">;</span> <span class="string">asc</span> <span class="number">1</span><span class="string">;;</span></span><br><span class="line"> <span class="attr">5:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">80</span><span class="string">;</span> <span class="string">asc</span>  <span class="string">;;</span></span><br><span class="line"> <span class="attr">6:</span> <span class="string">len</span> <span class="number">1</span><span class="string">;</span> <span class="string">hex</span> <span class="number">61</span><span class="string">;</span> <span class="string">asc</span> <span class="string">a;;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;innodb-status-file&quot;&gt;&lt;a href=&quot;#innodb-status-file&quot; class=&quot;headerlink&quot; title=&quot;innodb_status_file&quot;&gt;&lt;/a&gt;innodb_status_file&lt;/h1&gt;&lt;p&gt;这个参数官方文档&lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/server-system-variable-reference.html&quot;&gt;https://dev.mysql.com/doc/refman/5.7/en/server-system-variable-reference.html&lt;/a&gt; 中没有&lt;/p&gt;
&lt;p&gt;在&lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html&quot;&gt;https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html&lt;/a&gt; 中有&lt;/p&gt;
&lt;p&gt;&lt;code&gt;--innodb-status-file&lt;/code&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Property&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Command-Line Format&lt;/td&gt;
&lt;td&gt;`–innodb-status-file[={OFF&lt;/td&gt;
&lt;td&gt;ON}]`&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Type&lt;/td&gt;
&lt;td&gt;Boolean&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Default Value&lt;/td&gt;
&lt;td&gt;&lt;code&gt;OFF&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The &lt;code&gt;--innodb-status-file&lt;/code&gt; startup option controls whether &lt;code&gt;InnoDB&lt;/code&gt; creates a file named &lt;code&gt;innodb_status.*&lt;/code&gt;pid&lt;code&gt;*&lt;/code&gt; in the data directory and writes &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/show-engine.html&quot;&gt;&lt;code&gt;SHOW ENGINE INNODB STATUS&lt;/code&gt;&lt;/a&gt; output to it every 15 seconds, approximately.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;innodb_status.*&lt;/code&gt;pid&lt;code&gt;*&lt;/code&gt; file is not created by default. To create it, start &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/mysqld.html&quot;&gt;&lt;strong&gt;mysqld&lt;/strong&gt;&lt;/a&gt; with the &lt;code&gt;--innodb-status-file&lt;/code&gt; option. &lt;code&gt;InnoDB&lt;/code&gt; removes the file when the server is shut down normally. If an abnormal shutdown occurs, the status file may have to be removed manually.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;--innodb-status-file&lt;/code&gt; option is intended for temporary use, as &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/show-engine.html&quot;&gt;&lt;code&gt;SHOW ENGINE INNODB STATUS&lt;/code&gt;&lt;/a&gt; output generation can affect performance, and the &lt;code&gt;innodb_status.*&lt;/code&gt;pid&lt;code&gt;*&lt;/code&gt; file can become quite large over time.&lt;/p&gt;
&lt;p&gt;For related information, see &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/innodb-enabling-monitors.html&quot;&gt;Section 14.18.2, “Enabling InnoDB Monitors”&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>ClickHouse查询分布式表LEFT JOIN改RIGHT JOIN的大坑</title>
    <link href="http://fuxkdb.com/2020/08/28/2020-08-28-ClickHouse%E6%9F%A5%E8%AF%A2%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8LEFT-JOIN%E6%94%B9RIGHT-JOIN%E7%9A%84%E5%A4%A7%E5%9D%91/"/>
    <id>http://fuxkdb.com/2020/08/28/2020-08-28-ClickHouse查询分布式表LEFT-JOIN改RIGHT-JOIN的大坑/</id>
    <published>2020-08-28T09:06:00.000Z</published>
    <updated>2020-08-28T09:17:43.113Z</updated>
    
    <content type="html"><![CDATA[<h1 id="由一个慢查询衍生出的问题"><a href="#由一个慢查询衍生出的问题" class="headerlink" title="由一个慢查询衍生出的问题"></a>由一个慢查询衍生出的问题</h1><p>我们线上有一个ClickHouse集群, 总共6个服务器, 配置均为16C 64G SSD, 集群配置为三分片两副本</p>
<p>有两个表这里称为<code>small_table</code>和<code>big_table</code>. 都是<code>ReplicatedMergeTree</code>引擎(三个分片两个副本).</p>
<p><code>small_table</code>有79w数据, <code>big_table</code>有5亿数据(数据在之后的示例中没有任何变化), 在下文中<code>small_table</code>和<code>big_table</code>都为分布式表, 可以获取全量数据, <code>small_table_local</code>和<code>big_table_local</code>为各节点上的本地表名称</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">table</span>, </span><br><span class="line">    formatReadableSize(sum(data_compressed_bytes)) <span class="keyword">AS</span> tc, </span><br><span class="line">    formatReadableSize(sum(data_uncompressed_bytes)) <span class="keyword">AS</span> tu, </span><br><span class="line">    sum(data_compressed_bytes) / sum(data_uncompressed_bytes) <span class="keyword">AS</span> ratio</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">system</span>.<span class="keyword">columns</span></span><br><span class="line"><span class="keyword">WHERE</span> (<span class="keyword">database</span> = currentDatabase()) <span class="keyword">AND</span> (<span class="keyword">table</span> <span class="keyword">IN</span> (<span class="string">&#x27;small_table_local&#x27;</span>, <span class="string">&#x27;big_table_local&#x27;</span>))</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">table</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">table</span> <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">table</span>─────────────────────────┬─tc────────┬─tu────────┬──────────────ratio─┐</span><br><span class="line">│ small_table_local             │ <span class="number">12.87</span> MiB │ <span class="number">14.91</span> MiB │ <span class="number">0.8633041477100831</span> │</span><br><span class="line">│ big_table_local               │ <span class="number">15.46</span> GiB │ <span class="number">57.31</span> GiB │ <span class="number">0.2697742507036428</span> │</span><br><span class="line">└───────────────────────────────┴───────────┴───────────┴────────────────────┘</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> small_table</span><br><span class="line"></span><br><span class="line">┌─<span class="built_in">count</span>()─┐</span><br><span class="line">│  <span class="number">794469</span> │</span><br><span class="line">└─────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> big_table</span><br><span class="line"></span><br><span class="line">┌───<span class="built_in">count</span>()─┐</span><br><span class="line">│ <span class="number">519898780</span> │</span><br><span class="line">└───────────┘</span><br></pre></td></tr></table></figure>
<p>有如下查询</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="selector-tag">a</span><span class="selector-class">.UID</span>,B<span class="selector-class">.UID</span> from dwh<span class="selector-class">.small_table</span> <span class="selector-tag">a</span> LEFT JOIN dwh<span class="selector-class">.big_table</span> <span class="selector-tag">b</span> on <span class="selector-tag">a</span><span class="selector-class">.UID</span> = <span class="selector-tag">b</span>.UID</span><br></pre></td></tr></table></figure>
<p>这个查询在ClickHouse中要跑近300秒</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#time clickhouse-client --time --progress --query=<span class="string">&quot;</span></span><br><span class="line"><span class="string">SELECT </span></span><br><span class="line"><span class="string">    a.UID, B.UID</span></span><br><span class="line"><span class="string">FROM</span></span><br><span class="line"><span class="string">    dwh.small_table a</span></span><br><span class="line"><span class="string">        LEFT JOIN</span></span><br><span class="line"><span class="string">    dwh.big_table b ON a.UID = b.UID</span></span><br><span class="line"><span class="string">&quot;</span> &gt; /dev/null</span><br><span class="line"><span class="number">293.769</span></span><br><span class="line"></span><br><span class="line">real    <span class="number">4</span>m53<span class="number">.798</span>s</span><br><span class="line">user    <span class="number">0</span>m0<span class="number">.574</span>s</span><br><span class="line">sys     <span class="number">0</span>m0<span class="number">.225</span>s</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/%E6%9F%A5%E8%AF%A2%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98.png" alt="单个节点"></p>
<p>而在TIDB只需要20秒(节点数和配置比CH略好, 数据略多于CH, 未使用TIFlash)</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># time mysql -uroot -hxx.xx.xx -P4000 -p dwh -e &quot;</span></span><br><span class="line"><span class="attr">SELECT</span> <span class="string"></span></span><br><span class="line">    <span class="meta">a.UID,</span> <span class="string">B.UID</span></span><br><span class="line"><span class="attr">FROM</span></span><br><span class="line">    <span class="meta">dwh.small_table</span> <span class="string">a</span></span><br><span class="line">        <span class="attr">LEFT</span> <span class="string">JOIN</span></span><br><span class="line">    <span class="meta">dwh.big_table</span> <span class="string">b ON a.UID = b.UID;</span></span><br><span class="line"><span class="meta">&quot;</span> <span class="string">&gt; /dev/null</span></span><br><span class="line"><span class="attr">Enter</span> <span class="string">password:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">real</span>    <span class="string">0m20.955s</span></span><br><span class="line"><span class="attr">user</span>    <span class="string">0m11.292s</span></span><br><span class="line"><span class="attr">sys</span>     <span class="string">0m2.321s</span></span><br></pre></td></tr></table></figure>
<p>本人接触ClickHouse不久, 没什么实战经验, 看到这结果就感觉肯定是自己使用姿势不对</p>
<h2 id="JOIN操作时一定要把数据量小的表放在右边"><a href="#JOIN操作时一定要把数据量小的表放在右边" class="headerlink" title="JOIN操作时一定要把数据量小的表放在右边"></a>JOIN操作时一定要把数据量小的表放在右边</h2><p>一通百度Google, 看到一篇来自携程的文章<a href="https://zhuanlan.zhihu.com/p/71014268">每天十亿级数据更新，秒出查询结果，ClickHouse在携程酒店的应用</a>, 其中有一段话:</p>
<blockquote>
<p>JOIN操作时一定要把数据量小的表放在右边，ClickHouse中无论是Left Join 、Right Join还是Inner Join永远都是拿着右表中的每一条记录到左表中查找该记录是否存在，所以右表必须是小表。</p>
</blockquote>
<p>有点神奇..</p>
<p>我们知道在常见的关系型数据库如Oralce、MySQL中, LEFT JOIN和RIGTH JOIN是可以等价改写的, 那么我改成RIGHT JOIN不就”把小表放在右边”了吗, 于是SQL改写为</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="selector-tag">a</span><span class="selector-class">.UID</span>,B<span class="selector-class">.UID</span> from dwh<span class="selector-class">.big_table</span> <span class="selector-tag">b</span> RIGHT JOIN dwh<span class="selector-class">.small_table</span> <span class="selector-tag">a</span> on <span class="selector-tag">a</span><span class="selector-class">.UID</span> = <span class="selector-tag">b</span>.UID</span><br></pre></td></tr></table></figure>
<p>实测</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#time clickhouse-client --time --progress --query=<span class="string">&quot;</span></span><br><span class="line"><span class="string">SELECT </span></span><br><span class="line"><span class="string">    a.UID, B.UID</span></span><br><span class="line"><span class="string">FROM</span></span><br><span class="line"><span class="string">    dwh.big_table b</span></span><br><span class="line"><span class="string">        RIGHT JOIN</span></span><br><span class="line"><span class="string">    dwh.small_table a ON a.UID = b.UIDT</span></span><br><span class="line"><span class="string">&quot;</span> &gt; /dev/null</span><br><span class="line"><span class="number">19.588</span></span><br><span class="line"></span><br><span class="line">real    <span class="number">0</span>m19<span class="number">.609</span>s</span><br><span class="line">user    <span class="number">0</span>m0<span class="number">.742</span>s</span><br><span class="line">sys     <span class="number">0</span>m0<span class="number">.293</span>s</span><br></pre></td></tr></table></figure>
<p>没想到还真好使… 难道CH优化器这么弱?</p>
<p>谨慎起见, 我比对了一下结果, 简单count一下吧</p>
<p>LEFT JOIN</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#time clickhouse-client --time --progress --query=<span class="string">&quot;</span></span><br><span class="line"><span class="string">SELECT </span></span><br><span class="line"><span class="string">    COUNT(*)</span></span><br><span class="line"><span class="string">FROM</span></span><br><span class="line"><span class="string">    dwh.small_table a</span></span><br><span class="line"><span class="string">        LEFT JOIN</span></span><br><span class="line"><span class="string">    dwh.big_table b ON a.UID = b.UID</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="number">6042735</span> --count</span><br><span class="line"><span class="number">917.560</span> --时间</span><br><span class="line"></span><br><span class="line">real    <span class="number">15</span>m17<span class="number">.580</span>s</span><br><span class="line">user    <span class="number">0</span>m0<span class="number">.253</span>s</span><br><span class="line">sys     <span class="number">0</span>m0<span class="number">.489</span>s</span><br></pre></td></tr></table></figure>
<p>RIGHT JOIN</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#time clickhouse-client --time --progress --query=<span class="string">&quot;</span></span><br><span class="line"><span class="string">SELECT </span></span><br><span class="line"><span class="string">    COUNT(*)</span></span><br><span class="line"><span class="string">FROM</span></span><br><span class="line"><span class="string">    dwh.big_table b</span></span><br><span class="line"><span class="string">        RIGHT JOIN</span></span><br><span class="line"><span class="string">    dwh.small_table a ON a.UID = b.UID</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="number">6897617</span> --count</span><br><span class="line"><span class="number">11.655</span> --时间</span><br><span class="line"></span><br><span class="line">real    <span class="number">0</span>m11<span class="number">.675</span>s</span><br><span class="line">user    <span class="number">0</span>m0<span class="number">.014</span>s</span><br><span class="line">sys     <span class="number">0</span>m0<span class="number">.017</span>s</span><br></pre></td></tr></table></figure>
<p>RIGHT JOIN数据不对啊</p>
<h2 id="ClickHouse分布式表A-LEFT-JOIN-B-B-RIGHT-JOIN-A"><a href="#ClickHouse分布式表A-LEFT-JOIN-B-B-RIGHT-JOIN-A" class="headerlink" title="ClickHouse分布式表A LEFT JOIN B != B RIGHT JOIN A"></a>ClickHouse分布式表A LEFT JOIN B != B RIGHT JOIN A</h2><h3 id="创建测试表"><a href="#创建测试表" class="headerlink" title="创建测试表"></a>创建测试表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">ch-node-05 default@localhost:9000 [dwh]</span><br><span class="line">:) <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">statement</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwh.t1 (<span class="string">`I_ID`</span> <span class="keyword">String</span>, <span class="string">`CTIME`</span> DateTime) <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;dwh&#x27;</span>, <span class="string">&#x27;t1_local&#x27;</span>, <span class="keyword">rand</span>()) │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="keyword">default</span>@localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t2</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">statement</span>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwh.t2 (<span class="string">`I_ID`</span> <span class="keyword">String</span>, <span class="string">`CTIME`</span> DateTime) <span class="keyword">ENGINE</span> = <span class="keyword">Distributed</span>(<span class="string">&#x27;ch_cluster_all&#x27;</span>, <span class="string">&#x27;dwh&#x27;</span>, <span class="string">&#x27;t2_local&#x27;</span>, <span class="keyword">rand</span>()) │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="keyword">default</span>@localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1_local;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1_local</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">statement</span>──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwh.t1_local (<span class="string">`I_ID`</span> <span class="keyword">String</span>, <span class="string">`CTIME`</span> DateTime) <span class="keyword">ENGINE</span> = ReplicatedReplacingMergeTree(<span class="string">&#x27;/clickhouse/dwh/tables/&#123;layer&#125;-&#123;shard&#125;/t1&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> toDate(CTIME) <span class="keyword">ORDER</span> <span class="keyword">BY</span> I_ID <span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span> │</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="keyword">default</span>@localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t2_local;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t2_local</span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">statement</span>──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwh.t2_local (<span class="string">`I_ID`</span> <span class="keyword">String</span>, <span class="string">`CTIME`</span> DateTime) <span class="keyword">ENGINE</span> = ReplicatedReplacingMergeTree(<span class="string">&#x27;/clickhouse/dwh/tables/&#123;layer&#125;-&#123;shard&#125;/t2&#x27;</span>, <span class="string">&#x27;&#123;replica&#125;&#x27;</span>) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> toDate(CTIME) <span class="keyword">ORDER</span> <span class="keyword">BY</span> I_ID <span class="keyword">SETTINGS</span> index_granularity = <span class="number">8192</span> │</span><br><span class="line">└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.001</span> sec. </span><br></pre></td></tr></table></figure>
<h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">ch-node<span class="number">-05</span> <span class="symbol">default@</span>localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) select * <span class="keyword">from</span> t1;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM t1</span><br><span class="line"></span><br><span class="line">┌─I_ID─┬───────────────CTIME─┐</span><br><span class="line">│ <span class="number">1</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">05</span> │</span><br><span class="line">│ <span class="number">2</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">│ <span class="number">8</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">└──────┴─────────────────────┘</span><br><span class="line">┌─I_ID─┬───────────────CTIME─┐</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">│ <span class="number">5</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">│ <span class="number">9</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">└──────┴─────────────────────┘</span><br><span class="line">┌─I_ID─┬───────────────CTIME─┐</span><br><span class="line">│ <span class="number">10</span>   │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">│ <span class="number">6</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">│ <span class="number">7</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">24</span>:<span class="number">50</span> │</span><br><span class="line">└──────┴─────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.003</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="symbol">default@</span>localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) select * <span class="keyword">from</span> t2;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM t2</span><br><span class="line"></span><br><span class="line">┌─I_ID─┬───────────────CTIME─┐</span><br><span class="line">│ <span class="number">1</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">25</span>:<span class="number">14</span> │</span><br><span class="line">└──────┴─────────────────────┘</span><br><span class="line">┌─I_ID─┬───────────────CTIME─┐</span><br><span class="line">│ <span class="number">2</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">25</span>:<span class="number">33</span> │</span><br><span class="line">│ <span class="number">5</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">25</span>:<span class="number">33</span> │</span><br><span class="line">└──────┴─────────────────────┘</span><br><span class="line">┌─I_ID─┬───────────────CTIME─┐</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">25</span>:<span class="number">33</span> │</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">2020</span><span class="number">-08</span><span class="number">-27</span> <span class="number">15</span>:<span class="number">25</span>:<span class="number">33</span> │</span><br><span class="line">└──────┴─────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.003</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="symbol">default@</span>localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) SELECT </span><br><span class="line">:-]     _shard_num, </span><br><span class="line">:-]     count(*)</span><br><span class="line">:-] FROM </span><br><span class="line">:-] (</span><br><span class="line">:-]     SELECT </span><br><span class="line">:-]         _shard_num, </span><br><span class="line">:-]         a.*</span><br><span class="line">:-]     FROM dwh.t1 AS a</span><br><span class="line">:-] )</span><br><span class="line">:-] GROUP BY _shard_num</span><br><span class="line">:-]     WITH ROLLUP;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    _shard_num, </span><br><span class="line">    count(*)</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">        _shard_num, </span><br><span class="line">        a.*</span><br><span class="line">    FROM dwh.t1 AS a</span><br><span class="line">)</span><br><span class="line">GROUP BY _shard_num</span><br><span class="line">    WITH ROLLUP</span><br><span class="line"></span><br><span class="line">┌─_shard_num─┬─count()─┐</span><br><span class="line">│          <span class="number">3</span> │       <span class="number">3</span> │</span><br><span class="line">│          <span class="number">2</span> │       <span class="number">3</span> │</span><br><span class="line">│          <span class="number">1</span> │       <span class="number">4</span> │</span><br><span class="line">└────────────┴─────────┘</span><br><span class="line">┌─_shard_num─┬─count()─┐</span><br><span class="line">│          <span class="number">0</span> │      <span class="number">10</span> │</span><br><span class="line">└────────────┴─────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.004</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="symbol">default@</span>localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) SELECT </span><br><span class="line">:-]     _shard_num, </span><br><span class="line">:-]     count(*)</span><br><span class="line">:-] FROM </span><br><span class="line">:-] (</span><br><span class="line">:-]     SELECT </span><br><span class="line">:-]         _shard_num, </span><br><span class="line">:-]         a.*</span><br><span class="line">:-]     FROM dwh.t2 AS a</span><br><span class="line">:-] )</span><br><span class="line">:-] GROUP BY _shard_num</span><br><span class="line">:-]     WITH ROLLUP;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    _shard_num, </span><br><span class="line">    count(*)</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">        _shard_num, </span><br><span class="line">        a.*</span><br><span class="line">    FROM dwh.t2 AS a</span><br><span class="line">)</span><br><span class="line">GROUP BY _shard_num</span><br><span class="line">    WITH ROLLUP</span><br><span class="line"></span><br><span class="line">┌─_shard_num─┬─count()─┐</span><br><span class="line">│          <span class="number">3</span> │       <span class="number">2</span> │</span><br><span class="line">│          <span class="number">2</span> │       <span class="number">1</span> │</span><br><span class="line">│          <span class="number">1</span> │       <span class="number">2</span> │</span><br><span class="line">└────────────┴─────────┘</span><br><span class="line">┌─_shard_num─┬─count()─┐</span><br><span class="line">│          <span class="number">0</span> │       <span class="number">5</span> │</span><br><span class="line">└────────────┴─────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.005</span> sec. </span><br></pre></td></tr></table></figure>
<h3 id="测试LEFT-JOIN-RIGHT-JOIN"><a href="#测试LEFT-JOIN-RIGHT-JOIN" class="headerlink" title="测试LEFT JOIN RIGHT JOIN"></a>测试LEFT JOIN RIGHT JOIN</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">ch-node<span class="number">-05</span> <span class="symbol">default@</span>localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) SELECT </span><br><span class="line">:-]     a.I_ID, </span><br><span class="line">:-]     b.I_ID</span><br><span class="line">:-] FROM dwh.t2 AS a</span><br><span class="line">:-] LEFT JOIN dwh.t1 AS b ON a.I_ID = b.I_ID</span><br><span class="line">:-] ORDER BY a.I_ID ASC;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    a.I_ID, </span><br><span class="line">    b.I_ID</span><br><span class="line">FROM dwh.t2 AS a</span><br><span class="line">LEFT JOIN dwh.t1 AS b ON a.I_ID = b.I_ID</span><br><span class="line">ORDER BY a.I_ID ASC</span><br><span class="line"></span><br><span class="line">┌─I_ID─┬─b.I_ID─┐</span><br><span class="line">│ <span class="number">1</span>    │ <span class="number">1</span>      │</span><br><span class="line">└──────┴────────┘</span><br><span class="line">┌─I_ID─┬─b.I_ID─┐</span><br><span class="line">│ <span class="number">2</span>    │ <span class="number">2</span>      │</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">3</span>      │</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">3</span>      │</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">3</span>      │</span><br><span class="line">│ <span class="number">3</span>    │ <span class="number">3</span>      │</span><br><span class="line">└──────┴────────┘</span><br><span class="line">┌─I_ID─┬─b.I_ID─┐</span><br><span class="line">│ <span class="number">5</span>    │ <span class="number">5</span>      │</span><br><span class="line">└──────┴────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">7</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.006</span> sec. </span><br><span class="line"></span><br><span class="line">ch-node<span class="number">-05</span> <span class="symbol">default@</span>localhost:<span class="number">9000</span> [dwh]</span><br><span class="line">:) SELECT </span><br><span class="line">:-]     a.I_ID, </span><br><span class="line">:-]     b.I_ID</span><br><span class="line">:-] FROM dwh.t1 AS b</span><br><span class="line">:-] RIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_ID</span><br><span class="line">:-] ORDER BY a.I_ID ASC;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    a.I_ID, </span><br><span class="line">    b.I_ID</span><br><span class="line">FROM dwh.t1 AS b</span><br><span class="line">RIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_ID</span><br><span class="line">ORDER BY toUInt32(a.I_ID) ASC</span><br><span class="line"></span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">1</span>      │      │</span><br><span class="line">│ <span class="number">1</span>      │ <span class="number">1</span>    │</span><br><span class="line">│ <span class="number">1</span>      │      │</span><br><span class="line">│ <span class="number">2</span>      │      │</span><br><span class="line">│ <span class="number">2</span>      │ <span class="number">2</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">2</span>      │      │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">3</span>      │      │</span><br><span class="line">│ <span class="number">3</span>      │      │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">5</span>      │      │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">5</span>      │      │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">5</span>      │ <span class="number">5</span>    │</span><br><span class="line">└────────┴──────┘</span><br></pre></td></tr></table></figure>
<p>可以看到RIGHT JOIN返回了一些错误的数据</p>
<p>难道想要对于这个SQL, 就不能用分布式表了吗? 如果我想用RIGHT JOIN就只能用单机? 说好的水平扩展呢? </p>
<p>那看一下单机查询速度吧..</p>
<p>为此我在一个CH节点创建两个表<code>small_table_total</code>和<code>big_table_toal</code> 他们都不是分布式表, 都拥有全量数据</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> <span class="symbol">`big_table_toal`</span></span><br><span class="line"></span><br><span class="line">┌───<span class="built_in">count</span>()─┐</span><br><span class="line">│ <span class="number">519898780</span> │</span><br><span class="line">└───────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.001</span> sec. </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> <span class="symbol">`small_table_total`</span></span><br><span class="line"></span><br><span class="line">┌─<span class="built_in">count</span>()─┐</span><br><span class="line">│  <span class="number">794469</span> │</span><br><span class="line">└─────────┘</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分布式表只能和分布式表关联, 分布式表无法和本地表关联</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#clickhouse-client --time --progress --query=&quot;SELECT count(*) from dwh.big_table b RIGHT JOIN dwh.small_table_total a on a.UID = b.UID&quot;      </span></span><br><span class="line">→ Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) Received exception <span class="keyword">from</span><span class="built_in"> server </span>(version 20.3.5):</span><br><span class="line">Code: 60. DB::Exception: Received <span class="keyword">from</span> localhost:9000. DB::Exception: Received <span class="keyword">from</span> bj2-ch-node-04:9000. DB::Exception: Table dwh.small_table_total doesn<span class="string">&#x27;t exist.. </span></span><br><span class="line"><span class="string">0.107</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>测试查询速度</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#clickhouse-client --time --progress --query=&quot;</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">COUNT</span>(*)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    dwh.big_table_total b</span><br><span class="line">        <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span></span><br><span class="line">    dwh.small_table_total a <span class="keyword">ON</span> a.UID = b.UID</span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">6042735 --count</span></span><br><span class="line"><span class="string">7.262  --用时</span></span><br></pre></td></tr></table></figure>
<p>好家伙, 数据准确, 而且比分片了还快</p>
<h2 id="难道只能用本地表"><a href="#难道只能用本地表" class="headerlink" title="难道只能用本地表?"></a>难道只能用本地表?</h2><p>分布式表要想RIGHT JOIN返回正确结果, 只能改写SQL</p>
<h3 id="原始语句"><a href="#原始语句" class="headerlink" title="原始语句"></a>原始语句</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    <span class="selector-tag">a</span><span class="selector-class">.UID</span>, <span class="selector-tag">b</span>.UID</span><br><span class="line">FROM</span><br><span class="line">    dwh<span class="selector-class">.small_table</span> a</span><br><span class="line">        LEFT JOIN</span><br><span class="line">    dwh<span class="selector-class">.big_table</span> <span class="selector-tag">b</span> ON <span class="selector-tag">a</span><span class="selector-class">.UID</span> = <span class="selector-tag">b</span>.UID</span><br></pre></td></tr></table></figure>
<h3 id="改写为INNER-JOIN-但是没有改表顺序-性能差"><a href="#改写为INNER-JOIN-但是没有改表顺序-性能差" class="headerlink" title="改写为INNER JOIN, 但是没有改表顺序(性能差)"></a>改写为INNER JOIN, 但是没有改表顺序(性能差)</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    <span class="selector-tag">a</span><span class="selector-class">.id</span>, <span class="selector-tag">b</span>.uid</span><br><span class="line">FROM</span><br><span class="line">    dwh<span class="selector-class">.small_table</span> a</span><br><span class="line">        GLOBAL INNER JOIN</span><br><span class="line">    dwh<span class="selector-class">.big_table</span> <span class="selector-tag">b</span> ON <span class="selector-tag">a</span><span class="selector-class">.UID</span> = <span class="selector-tag">b</span><span class="selector-class">.UID</span> </span><br><span class="line">UNION ALL SELECT </span><br><span class="line">    <span class="selector-tag">a</span><span class="selector-class">.UID</span>, NULL</span><br><span class="line">FROM</span><br><span class="line">    dwh<span class="selector-class">.small_table</span> a</span><br><span class="line">WHERE</span><br><span class="line">    <span class="selector-tag">a</span><span class="selector-class">.UID</span> GLOBAL NOT IN (SELECT </span><br><span class="line">            UID</span><br><span class="line">        FROM</span><br><span class="line">            dwh.big_table)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里我还没理解为什么要用GLOBAL JOIN</p>
</blockquote>
<p>在我的例子中 ,这个语句根本跑不成功, GLOBAL太耗费内存了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    a.UID, </span><br><span class="line">    b.UID</span><br><span class="line"><span class="keyword">FROM</span> dwh.small_table <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dwh.big_table <span class="keyword">AS</span> b <span class="keyword">ON</span> a.UID = b.UID</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    a.UID, </span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line"><span class="keyword">FROM</span> dwh.small_table <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">WHERE</span> a.UID <span class="keyword">GLOBAL</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> UID</span><br><span class="line">    <span class="keyword">FROM</span> dwh.big_table</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">↑ Progress: <span class="number">220.53</span> million <span class="keyword">rows</span>, <span class="number">29.82</span> GB (<span class="number">51.24</span> million <span class="keyword">rows</span>/s., <span class="number">6.93</span> GB/s.) ████████████████████████████████████▋                                                                                                                                          <span class="number">20</span>%Received <span class="keyword">exception</span> <span class="keyword">from</span> <span class="keyword">server</span> (<span class="keyword">version</span> <span class="number">20.3</span><span class="number">.5</span>):</span><br><span class="line">Code: <span class="number">241.</span> DB::<span class="keyword">Exception</span>: Received <span class="keyword">from</span> localhost:<span class="number">9000.</span> DB::<span class="keyword">Exception</span>: <span class="keyword">Memory</span> <span class="keyword">limit</span> (<span class="keyword">for</span> <span class="keyword">query</span>) exceeded: would <span class="keyword">use</span> <span class="number">50.00</span> GiB (attempt <span class="keyword">to</span> <span class="keyword">allocate</span> <span class="keyword">chunk</span> <span class="keyword">of</span> <span class="number">4249200</span> <span class="keyword">bytes</span>), maximum: <span class="number">50.00</span> GiB: (<span class="keyword">while</span> reading <span class="keyword">column</span> CH_BILL_USER_TELEPHONE): (<span class="keyword">while</span> reading <span class="keyword">from</span> part /<span class="keyword">data</span>/clickhouse/ch_9000/<span class="keyword">data</span>/dwh/big_table_local/<span class="number">201910</span>_0_5_1/ <span class="keyword">from</span> mark <span class="number">216</span> <span class="keyword">with</span> max_rows_to_read = <span class="number">8192</span>): </span><br><span class="line">Code: <span class="number">241</span>, e.displayText() = DB::<span class="keyword">Exception</span>: <span class="keyword">Memory</span> <span class="keyword">limit</span> (<span class="keyword">for</span> <span class="keyword">query</span>) exceeded: would <span class="keyword">use</span> <span class="number">50.00</span> GiB (attempt <span class="keyword">to</span> <span class="keyword">allocate</span> <span class="keyword">chunk</span> <span class="keyword">of</span> <span class="number">4227680</span> <span class="keyword">bytes</span>), maximum: <span class="number">50.00</span> GiB: (<span class="keyword">while</span> reading <span class="keyword">column</span> CH_XXX_NAME): (<span class="keyword">while</span> reading <span class="keyword">from</span> part /<span class="keyword">data</span>/clickhouse/ch_9000/<span class="keyword">data</span>/dwh/big_table_local/<span class="number">202001</span>_6_11_1/ <span class="keyword">from</span> mark <span class="number">240</span> <span class="keyword">with</span> max_rows_to_read = <span class="number">8192</span>) (<span class="keyword">version</span> <span class="number">20.3</span><span class="number">.5</span><span class="number">.21</span> (official <span class="keyword">build</span>)): </span><br><span class="line">Code: <span class="number">241</span>, e.displayText() = DB::<span class="keyword">Exception</span>: <span class="keyword">Memory</span> <span class="keyword">limit</span> (<span class="keyword">for</span> <span class="keyword">query</span>) exceeded: would <span class="keyword">use</span> <span class="number">50.00</span> GiB (attempt <span class="keyword">to</span> <span class="keyword">allocate</span> <span class="keyword">chunk</span> <span class="keyword">of</span> <span class="number">5211280</span> <span class="keyword">bytes</span>), maximum: <span class="number">50.00</span> GiB: (avg_value_size_hint = <span class="number">66</span>, avg_chars_size = <span class="number">69.6</span>, <span class="keyword">limit</span> = <span class="number">8192</span>): (<span class="keyword">while</span> reading <span class="keyword">column</span> CH_BROKER_NAME): (<span class="keyword">while</span> reading <span class="keyword">from</span> part /<span class="keyword">data</span>/clickhouse/ch_9000/<span class="keyword">data</span>/dwh/big_table_local/<span class="number">202007</span>_6_11_1/ <span class="keyword">from</span> mark <span class="number">24</span> <span class="keyword">with</span> max_rows_to_read = <span class="number">8192</span>) (<span class="keyword">version</span> <span class="number">20.3</span><span class="number">.5</span><span class="number">.21</span> (official <span class="keyword">build</span>)): </span><br><span class="line">Code: <span class="number">241</span>, e.displayText() = DB::<span class="keyword">Exception</span>: <span class="keyword">Memory</span> <span class="keyword">limit</span> (<span class="keyword">for</span> <span class="keyword">query</span>) exceeded: would <span class="keyword">use</span> <span class="number">50.00</span> GiB (attempt <span class="keyword">to</span> <span class="keyword">allocate</span> <span class="keyword">chunk</span> <span class="keyword">of</span> <span class="number">4572064</span> <span class="keyword">bytes</span>), maximum: <span class="number">50.00</span> GiB: (avg_value_size_hint = <span class="number">66.00048828125</span>, avg_chars_size = <span class="number">69.6005859375</span>, <span class="keyword">limit</span> = <span class="number">8192</span>): (<span class="keyword">while</span> reading <span class="keyword">column</span> CH_XX_NAME): (<span class="keyword">while</span> reading <span class="keyword">from</span> part /<span class="keyword">data</span>/clickhouse/ch_9000/<span class="keyword">data</span>/dwh/big_table_local/<span class="number">201805</span>_2_2_0/ <span class="keyword">from</span> mark <span class="number">24</span> <span class="keyword">with</span> max_rows_to_read = <span class="number">8192</span>) (<span class="keyword">version</span> <span class="number">20.3</span><span class="number">.5</span><span class="number">.21</span> (official <span class="keyword">build</span>)): <span class="keyword">While</span> executing CreatingSetsTransform. </span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">4.404</span> sec. Processed <span class="number">220.53</span> million <span class="keyword">rows</span>, <span class="number">29.82</span> GB (<span class="number">50.07</span> million <span class="keyword">rows</span>/s., <span class="number">6.77</span> GB/s.) </span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/GLOBAL_JOIN_memory.png" alt=""></p>
<p>如果去掉GLOBAL JOIN, 也不行(GLOBAL IN不能去)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    a.UID, </span><br><span class="line">    b.UID</span><br><span class="line"><span class="keyword">FROM</span> dwh.small_table <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> dwh.big_table <span class="keyword">AS</span> b <span class="keyword">ON</span> a.UID = b.UID</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    a.UID, </span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line"><span class="keyword">FROM</span> dwh.small_table <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">WHERE</span> a.UID <span class="keyword">GLOBAL</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> UID</span><br><span class="line">    <span class="keyword">FROM</span> dwh.big_table</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">↑ Progress: <span class="number">1.91</span> billion <span class="keyword">rows</span>, <span class="number">105.59</span> GB (<span class="number">6.36</span> million <span class="keyword">rows</span>/s., <span class="number">352.30</span> MB/s.) ██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊                <span class="number">90</span>%Received <span class="keyword">exception</span> <span class="keyword">from</span> <span class="keyword">server</span> (<span class="keyword">version</span> <span class="number">20.3</span><span class="number">.5</span>):</span><br><span class="line">Code: <span class="number">241.</span> DB::<span class="keyword">Exception</span>: Received <span class="keyword">from</span> localhost:<span class="number">9000.</span> DB::<span class="keyword">Exception</span>: Received <span class="keyword">from</span> clickhouse-node<span class="number">-01</span>:<span class="number">9000.</span> DB::<span class="keyword">Exception</span>: <span class="keyword">Memory</span> <span class="keyword">limit</span> (total) exceeded: would <span class="keyword">use</span> <span class="number">50.10</span> GiB (attempt <span class="keyword">to</span> <span class="keyword">allocate</span> <span class="keyword">chunk</span> <span class="keyword">of</span> <span class="number">133829856</span> <span class="keyword">bytes</span>), maximum: <span class="number">50.00</span> GiB: <span class="keyword">While</span> executing CreatingSetsTransform. </span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">299.809</span> sec. Processed <span class="number">1.91</span> billion <span class="keyword">rows</span>, <span class="number">105.59</span> GB (<span class="number">6.35</span> million <span class="keyword">rows</span>/s., <span class="number">352.18</span> MB/s.) </span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/JOIN_memory.png" alt=""></p>
<h3 id="改写表顺序-让小表在”右边”"><a href="#改写表顺序-让小表在”右边”" class="headerlink" title="改写表顺序, 让小表在”右边”"></a>改写表顺序, 让小表在”右边”</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.UID <span class="keyword">FROM</span> dwh.big_table b</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dwh.small_table a</span><br><span class="line"><span class="keyword">ON</span> a.UID = b.UID</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> a.UID,<span class="literal">null</span> <span class="keyword">FROM</span> dwh.small_table a</span><br><span class="line"><span class="keyword">WHERE</span> a.UID <span class="keyword">GLOBAL</span> <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> UID <span class="keyword">FROM</span> dwh.big_table</span><br><span class="line">    <span class="keyword">WHERE</span> UID <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> dwh.small_table)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>实测</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">time</span> clickhouse-client <span class="comment">--time --progress --query=&quot;</span></span><br><span class="line"><span class="keyword">SELECT</span> a.UID,b.UID <span class="keyword">FROM</span> dwh.big_table b</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dwh.small_table a</span><br><span class="line"><span class="keyword">on</span> a.UID = b.UID</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> a.UID,<span class="keyword">null</span> <span class="keyword">FROM</span> dwh.small_table a</span><br><span class="line"><span class="keyword">WHERE</span> a.UID <span class="keyword">GLOBAL</span> <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> UID <span class="keyword">FROM</span> dwh.big_table</span><br><span class="line">    <span class="keyword">WHERE</span> UID <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> UID <span class="keyword">FROM</span> dwh.small_table)</span><br><span class="line">)&quot; &gt;/dev/null</span><br><span class="line">21.142</span><br><span class="line"></span><br><span class="line">real    0m21.164s</span><br><span class="line">user    0m1.133s</span><br><span class="line">sys     0m0.378s</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/rewrite_sql_memory.png" alt=""></p>
<p>看一下行数对不对</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">time</span> clickhouse-client <span class="comment">--time --progress --query=&quot;</span></span><br><span class="line"><span class="keyword">SELECT</span> sum(cnt) <span class="keyword">FROM</span> (</span><br><span class="line"><span class="keyword">SELECT</span> count(*)  cnt <span class="keyword">FROM</span> dwh.big_table b</span><br><span class="line"><span class="keyword">GLOBAL</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dwh.small_table a</span><br><span class="line"><span class="keyword">on</span> a.UID = b.UID</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> count(*) cnt <span class="keyword">FROM</span> dwh.small_table a</span><br><span class="line"><span class="keyword">WHERE</span> a.UID <span class="keyword">GLOBAL</span> <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">SELECT</span> UID <span class="keyword">FROM</span> dwh.big_table</span><br><span class="line">    <span class="keyword">WHERE</span> UID <span class="keyword">GLOBAL</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> UID <span class="keyword">FROM</span> dwh.small_table)</span><br><span class="line">))&quot;</span><br><span class="line">6042735 --count</span><br><span class="line">12.525  --用时</span><br><span class="line"></span><br><span class="line">real    0m12.545s</span><br><span class="line">user    0m0.018s</span><br><span class="line">sys     0m0.012s</span><br></pre></td></tr></table></figure>
<h2 id="最后一个问题"><a href="#最后一个问题" class="headerlink" title="最后一个问题"></a>最后一个问题</h2><p>不知道你们是否注意到了</p>
<p>ClickHouse</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    a.I_ID, </span><br><span class="line">    b.I_ID</span><br><span class="line">FROM dwh.t1 AS b</span><br><span class="line">RIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_ID</span><br><span class="line">ORDER BY a.I_ID ASC</span><br><span class="line"></span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">1</span>      │      │</span><br><span class="line">│ <span class="number">1</span>      │ <span class="number">1</span>    │</span><br><span class="line">│ <span class="number">1</span>      │      │</span><br><span class="line">│ <span class="number">2</span>      │      │</span><br><span class="line">│ <span class="number">2</span>      │ <span class="number">2</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">2</span>      │      │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">3</span>      │      │</span><br><span class="line">│ <span class="number">3</span>      │      │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">5</span>      │      │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">5</span>      │      │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">5</span>      │ <span class="number">5</span>    │</span><br><span class="line">└────────┴──────┘</span><br></pre></td></tr></table></figure>
<p>MySQL(例子无关)</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@localhost</span> 15:15:26 [fanboshi]&gt; select a.id,b.id from t1 a left join t3 b on a.id=b.id; </span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> id   </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string">    1 </span>|</span><br><span class="line">|<span class="string">  2 </span>|<span class="string">    2 </span>|</span><br><span class="line">|<span class="string">  3 </span>|<span class="string">    3 </span>|</span><br><span class="line">|<span class="string">  4 </span>|<span class="string">    4 </span>|</span><br><span class="line">|<span class="string">  5 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string">  6 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string">  7 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string">  8 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string">  9 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 11 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 13 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 15 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 17 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 19 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 21 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 23 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 25 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 27 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 29 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 30 </span>|<span class="string"> NULL </span>|</span><br><span class="line">|<span class="string"> 31 </span>|<span class="string"> NULL </span>|</span><br><span class="line">+----+------+</span><br><span class="line">21 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>在CH里外链接不想MySQL那样”用null补未匹配的数据”而是用该列数据类型的默认值填充</p>
<p><a href="https://github.com/ClickHouse/ClickHouse/blob/master/src/Core/Settings.h#L189">https://github.com/ClickHouse/ClickHouse/blob/master/src/Core/Settings.h#L189</a></p>
<p><code>join_use_nulls</code>可以在语句,用户profile添加</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    a.I_ID, </span><br><span class="line">    b.I_ID</span><br><span class="line">FROM dwh.t1 AS b</span><br><span class="line">RIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_ID</span><br><span class="line">ORDER BY toUInt32(a.I_ID) ASC</span><br><span class="line">SETTINGS join_use_nulls = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">1</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">│ <span class="number">1</span>      │ <span class="number">1</span>    │</span><br><span class="line">│ <span class="number">1</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">│ <span class="number">2</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">│ <span class="number">2</span>      │ <span class="number">2</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">2</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">3</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">│ <span class="number">3</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">3</span>      │ <span class="number">3</span>    │</span><br><span class="line">│ <span class="number">5</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">5</span>      │ ᴺᵁᴸᴸ │</span><br><span class="line">└────────┴──────┘</span><br><span class="line">┌─a.I_ID─┬─I_ID─┐</span><br><span class="line">│ <span class="number">5</span>      │ <span class="number">5</span>    │</span><br><span class="line">└────────┴──────┘</span><br><span class="line"></span><br><span class="line"><span class="number">15</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.015</span> sec. </span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>我提了issue, 详细原因请看<a href="https://github.com/ClickHouse/ClickHouse/issues/14160">https://github.com/ClickHouse/ClickHouse/issues/14160</a></p>
<p>总之除了LEFT JOIN 外 <code>For other OUTER JOINs there&#39;s no general solution to return expected result yet</code></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;由一个慢查询衍生出的问题&quot;&gt;&lt;a href=&quot;#由一个慢查询衍生出的问题&quot; class=&quot;headerlink&quot; title=&quot;由一个慢查询衍生出的问题&quot;&gt;&lt;/a&gt;由一个慢查询衍生出的问题&lt;/h1&gt;&lt;p&gt;我们线上有一个ClickHouse集群, 总共6个服务器, 配置均为16C 64G SSD, 集群配置为三分片两副本&lt;/p&gt;
&lt;p&gt;有两个表这里称为&lt;code&gt;small_table&lt;/code&gt;和&lt;code&gt;big_table&lt;/code&gt;. 都是&lt;code&gt;ReplicatedMergeTree&lt;/code&gt;引擎(三个分片两个副本).&lt;/p&gt;
&lt;p&gt;&lt;code&gt;small_table&lt;/code&gt;有79w数据, &lt;code&gt;big_table&lt;/code&gt;有5亿数据(数据在之后的示例中没有任何变化), 在下文中&lt;code&gt;small_table&lt;/code&gt;和&lt;code&gt;big_table&lt;/code&gt;都为分布式表, 可以获取全量数据, &lt;code&gt;small_table_local&lt;/code&gt;和&lt;code&gt;big_table_local&lt;/code&gt;为各节点上的本地表名称&lt;/p&gt;
&lt;figure class=&quot;highlight pgsql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;SELECT&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;table&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    formatReadableSize(sum(data_compressed_bytes)) &lt;span class=&quot;keyword&quot;&gt;AS&lt;/span&gt; tc, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    formatReadableSize(sum(data_uncompressed_bytes)) &lt;span class=&quot;keyword&quot;&gt;AS&lt;/span&gt; tu, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    sum(data_compressed_bytes) / sum(data_uncompressed_bytes) &lt;span class=&quot;keyword&quot;&gt;AS&lt;/span&gt; ratio&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;system&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;columns&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;WHERE&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;database&lt;/span&gt; = currentDatabase()) &lt;span class=&quot;keyword&quot;&gt;AND&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;IN&lt;/span&gt; (&lt;span class=&quot;string&quot;&gt;&amp;#x27;small_table_local&amp;#x27;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;#x27;big_table_local&amp;#x27;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;GROUP&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;table&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;ASC&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;┌─&lt;span class=&quot;keyword&quot;&gt;table&lt;/span&gt;─────────────────────────┬─tc────────┬─tu────────┬──────────────ratio─┐&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│ small_table_local             │ &lt;span class=&quot;number&quot;&gt;12.87&lt;/span&gt; MiB │ &lt;span class=&quot;number&quot;&gt;14.91&lt;/span&gt; MiB │ &lt;span class=&quot;number&quot;&gt;0.8633041477100831&lt;/span&gt; │&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;│ big_table_local               │ &lt;span class=&quot;number&quot;&gt;15.46&lt;/span&gt; GiB │ &lt;span class=&quot;number&quot;&gt;57.31&lt;/span&gt; GiB │ &lt;span class=&quot;number&quot;&gt;0.2697742507036428&lt;/span&gt; │&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;└───────────────────────────────┴───────────┴───────────┴────────────────────┘&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="ClickHouse" scheme="http://fuxkdb.com/tags/ClickHouse/"/>
    
  </entry>
  
  <entry>
    <title>译文 ClickHouse Materialized Views Illuminated, Part 2</title>
    <link href="http://fuxkdb.com/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-2/"/>
    <id>http://fuxkdb.com/2020/08/23/2020-08-23-译文-ClickHouse-Materialized-Views-Illuminated,-Part-2/</id>
    <published>2020-08-23T11:05:00.000Z</published>
    <updated>2020-08-24T07:44:14.541Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ClickHouse-Materialized-Views-Illuminated-Part-2"><a href="#ClickHouse-Materialized-Views-Illuminated-Part-2" class="headerlink" title="ClickHouse Materialized Views Illuminated, Part 2"></a><a href="https://altinity.com/blog/clickhouse-materialized-views-illuminated-part-2">ClickHouse Materialized Views Illuminated, Part 2</a></h1><p><img src="https://altinity.com/wp-content/uploads/2020/02/d1a1c-stockvault-abstract-glowing-multicolor-wireframe-background268674_small.png" alt="header"></p>
<p><strong><a href="https://www.altinity.com/blog/clickhouse-materialized-views-illuminated-part-1">Read part 1</a></strong></p>
<a id="more"></a>
<p>在上一篇关于物化视图的博文中, 我们介绍了一种构造ClickHouse物化视图的方法, 该视图使用<a href="https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/summingmergetree/">SummingMergeTree</a>引擎计算总和和计数. SummingMergeTree可以为这两种类型的聚合使用普通的SQL语法. 我们还让物化视图定义自动为数据创建基础表(.inner表).  这两种技术都很快速, 但对生产系统有限制(都不太适用于生产环境). </p>
<p>在本篇文章中, 我们将展示如何在现有的表上创建一个具有一系列聚合类型的物化视图. 当您需要计算的不仅仅是简单的总和时, 此方法非常适合. 对于表中有大量正在插入的数据(针对Part 1)中的 <code>POPULATE</code>, 使用POPULATE会填充历史数据, 但这期间向原表中新插入数据会被忽略掉而不会写入物化视图中)或必须处理表结构变更的情况, 这也非常方便.</p>
<h2 id="使用State函数和To-Tables创建更灵活的物化视图"><a href="#使用State函数和To-Tables创建更灵活的物化视图" class="headerlink" title="使用State函数和To Tables创建更灵活的物化视图"></a>使用State函数和To Tables创建更灵活的物化视图</h2><p>在线面的例子中, 我们将测量设备的读数. 让我们从表定义开始.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> counter (</span><br><span class="line">  <span class="keyword">when</span> DateTime <span class="keyword">DEFAULT</span> <span class="keyword">now</span>(),</span><br><span class="line">  device UInt32,</span><br><span class="line">  <span class="keyword">value</span> Float32</span><br><span class="line">) <span class="keyword">ENGINE</span>=MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(<span class="keyword">when</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (device, <span class="keyword">when</span>)</span><br></pre></td></tr></table></figure>
<p>接下来, 我们添加足够的数据, 以使查询速度变得足够慢: 10个设备的10亿行合成数据. 注意: 如果您要尝试这些操作, 只需输入100万行即可. 无论数据量如何, 示例都可以工作.</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO counter SELECT </span><br><span class="line">    toDateTime(<span class="string">&#x27;2015-01-01 00:00:00&#x27;</span>) + toInt64(number / <span class="number">10</span>) AS when, </span><br><span class="line">    (number % <span class="number">10</span>) + <span class="number">1</span> AS device, </span><br><span class="line">    ((device * <span class="number">3</span>) + (number / <span class="number">10000</span>)) + ((rand() % <span class="number">53</span>) * <span class="number">0.1</span>) AS value</span><br><span class="line">FROM system.numbers</span><br><span class="line">LIMIT <span class="number">1000000000</span></span><br><span class="line"></span><br><span class="line">↓ Progress: <span class="number">1.00</span> billion rows, <span class="number">8.00</span> GB (<span class="number">5.13</span> million rows/s., <span class="number">41.07</span> MB/s.) Ok.</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">194.814</span> sec. Processed <span class="number">1.00</span> billion rows, <span class="number">8.00</span> GB (<span class="number">5.13</span> million rows/s., <span class="number">41.07</span> MB/s.) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT count(*)</span><br><span class="line">FROM counter</span><br><span class="line"></span><br><span class="line">┌────count()─┐</span><br><span class="line">│ <span class="number">1000000000</span> │</span><br><span class="line">└────────────┘</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM counter</span><br><span class="line">LIMIT <span class="number">1</span></span><br><span class="line"></span><br><span class="line">┌────────────────when─┬─device─┬─value─┐</span><br><span class="line">│ <span class="number">2015</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │      <span class="number">1</span> │   <span class="number">3.6</span> │</span><br><span class="line">└─────────────────────┴────────┴───────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-02</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">30</span> /data/clickhouse/node2/data/duyalan]</span><br><span class="line">#du -sh counter/</span><br><span class="line"><span class="number">13</span>G     counter/</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-02</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">35</span> /data/clickhouse/node2/data/duyalan]</span><br><span class="line">#du -sh counter/</span><br><span class="line"><span class="number">12</span>G     counter/</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-02</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">04</span> /data/clickhouse/node2/data/duyalan]</span><br><span class="line">#du -sh counter/</span><br><span class="line"><span class="number">6.5</span>G    counter/</span><br><span class="line">数据慢慢被压实</span><br></pre></td></tr></table></figure>
<p>现在, 让我们看一下我们希望定期运行的示例查询.  它汇总了整个采样期间所有设备的所有数据. 在这种情况下, 这意味着表中3.25年的数据, 都是在2019年之前. </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    count(*) AS count, </span><br><span class="line">    max(value) AS max, </span><br><span class="line">    min(value) AS min, </span><br><span class="line">    avg(value) AS avg</span><br><span class="line">FROM counter</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">100000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.077</span> │ <span class="number">50005.599374785554</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">100000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0761</span> │  <span class="number">50008.59962170133</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">100000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │ <span class="number">50011.599634214646</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">100000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">50014.59989124005</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">100000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0384</span> │  <span class="number">50017.59997032414</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">100000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.1045</span> │  <span class="number">50020.60019940771</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">100000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │  <span class="number">50023.60046194672</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">100000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0477</span> │  <span class="number">50026.60002471252</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">100000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">50029.60008679837</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">100000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0629</span> │  <span class="number">50032.60051765903</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">12.036</span> sec. Processed <span class="number">1.00</span> billion rows, <span class="number">8.00</span> GB (<span class="number">83.08</span> million rows/s., <span class="number">664.67</span> MB/s.) </span><br><span class="line"></span><br><span class="line">bj2-all-clickhouse-test<span class="number">-02</span> :) select min(when),max(when) <span class="keyword">from</span> counter;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    min(when), </span><br><span class="line">    max(when)</span><br><span class="line">FROM counter</span><br><span class="line"></span><br><span class="line">┌───────────min(when)─┬───────────max(when)─┐</span><br><span class="line">│ <span class="number">2015</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │ <span class="number">2018</span><span class="number">-03</span><span class="number">-03</span> <span class="number">09</span>:<span class="number">46</span>:<span class="number">39</span> │</span><br><span class="line">└─────────────────────┴─────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">9.941</span> sec. Processed <span class="number">1.00</span> billion rows, <span class="number">4.00</span> GB (<span class="number">100.59</span> million rows/s., <span class="number">402.36</span> MB/s.) </span><br></pre></td></tr></table></figure>
<p>前面的查询很慢, 因为它必须读取表中的所有数据才能获得答案.  我们想要设计一个物化视图, 该视图读取的数据要少得多.  事实证明, 如果我们定义了一个每天汇总数据的视图, 则ClickHouse将正确地在整个时间间隔内汇总每天的数据. </p>
<p>与前面的简单示例(Part 1)不同, 我们将自己定义目标(.inner表)表.  这样做的好处是, 该表现在可见, 这使得加载数据以及进行模式迁移(表结构变更)更加容易.  下面是目标表的定义. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> counter_daily (</span><br><span class="line">  <span class="keyword">day</span> DateTime,</span><br><span class="line">  device UInt32,</span><br><span class="line">  <span class="keyword">count</span> UInt64,</span><br><span class="line">  max_value_state AggregateFunction(<span class="keyword">max</span>, Float32),</span><br><span class="line">  min_value_state AggregateFunction(<span class="keyword">min</span>, Float32),</span><br><span class="line">  avg_value_state AggregateFunction(<span class="keyword">avg</span>, Float32)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = SummingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> tuple()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (device, <span class="keyword">day</span>)</span><br></pre></td></tr></table></figure>
<p>该表定义引入了一种新的数据类型, 称为<a href="https://clickhouse.tech/docs/en/sql-reference/data-types/aggregatefunction/">AggregateFunction</a>, 该数据类型保存部分聚合的数据(which holds partially aggregated data). 这个数据类型用于sum和count以外的聚合需求. 接下来, 我们创建相应的物化视图. 它从counter(源表)中选择数据, 并使用CREATE语句中的特殊TO语法将数据发送到counter_daily(目标表). 该表有聚合函数, SELECT语句有与之相匹配的函数, 如’ maxState ‘. 我们将在详细讨论聚合函数时讨论它们之间的关系. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> counter_daily_mv</span><br><span class="line"><span class="keyword">TO</span> counter_daily</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    toStartOfDay(<span class="keyword">when</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">    device,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span>,</span><br><span class="line">    maxState(<span class="keyword">value</span>) <span class="keyword">AS</span> max_value_state,</span><br><span class="line">    minState(<span class="keyword">value</span>) <span class="keyword">AS</span> min_value_state,</span><br><span class="line">    avgState(<span class="keyword">value</span>) <span class="keyword">AS</span> avg_value_state</span><br><span class="line"><span class="keyword">FROM</span> counter</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">when</span> &gt;= toDate(<span class="string">&#x27;2019-01-01 00:00:00&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>TO关键字使我们可以指向目标表(存储物化视图数据的表, 在本例中即是counter_daily表), 但有一个缺点.  ClickHouse不允许在TO中使用POPULATE关键字.  因此, 物化视图创建后没有任何数据.  我们将手动加载数据.  但是, 我们还将使用一个不错的技巧, 使我们可以避免在同时进行活动数据加载的情况下出现问题. </p>
<p>注意, 视图定义有一个WHERE子句. 这意味着2019年之前的任何数据都应该被忽略. 我们现在有了一种不丢失数据的方法来处理数据加载. 该视图将处理2019年到达的新数据. 同时, 我们可以通过插入加载2018年及之前的旧数据. </p>
<p>让我们通过将新数据加载到counter表中来演示它是如何工作的. 新数据将于2019年开始, 并将自动加载到视图中. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> counter</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    toDateTime(<span class="string">&#x27;2019-01-01 00:00:00&#x27;</span>) + toInt64(<span class="built_in">number</span>/<span class="number">10</span>) <span class="keyword">AS</span> <span class="keyword">when</span>,</span><br><span class="line">    (<span class="built_in">number</span> % <span class="number">10</span>) + <span class="number">1</span> <span class="keyword">AS</span> device,</span><br><span class="line">    (device * <span class="number">3</span>) +  (<span class="built_in">number</span> / <span class="number">10000</span>) + (<span class="keyword">rand</span>() % <span class="number">53</span>) * <span class="number">0.1</span> <span class="keyword">AS</span> <span class="keyword">value</span></span><br><span class="line">  <span class="keyword">FROM</span> system.numbers <span class="keyword">LIMIT</span> <span class="number">100000000</span></span><br></pre></td></tr></table></figure>
<p>现在, 使用以下INSERT手动加载旧数据.  它会加载2018年及之前的所有数据. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> counter_daily</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  toStartOfDay(<span class="keyword">when</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">  device,</span><br><span class="line">  <span class="keyword">count</span>(*) <span class="keyword">AS</span> <span class="keyword">count</span>,</span><br><span class="line">  maxState(<span class="keyword">value</span>) <span class="keyword">AS</span> max_value_state,</span><br><span class="line">  minState(<span class="keyword">value</span>) <span class="keyword">AS</span> min_value_state,</span><br><span class="line">  avgState(<span class="keyword">value</span>) <span class="keyword">AS</span> avg_value_state</span><br><span class="line"><span class="keyword">FROM</span> counter</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">when</span> &lt; toDateTime(<span class="string">&#x27;2019-01-01 00:00:00&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>我们终于可以从视图中查询数据了.  与目标表和物化化视图一样, ClickHouse使用专用语法从视图中进行选择. </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">物化视图目标表</span><br><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    sum(count) AS count, </span><br><span class="line">    maxMerge(max_value_state) AS max, </span><br><span class="line">    minMerge(min_value_state) AS min, </span><br><span class="line">    avgMerge(avg_value_state) AS avg</span><br><span class="line">FROM counter_daily</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">110000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.051</span> │  <span class="number">45914.69035234097</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">110000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0291</span> │  <span class="number">45917.69056040798</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">110000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │ <span class="number">45920.690478928045</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">110000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">45923.69086044358</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">110000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0114</span> │  <span class="number">45926.69083122718</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">110000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.0475</span> │ <span class="number">45929.691088042426</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">110000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │  <span class="number">45932.69135215635</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">110000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0107</span> │ <span class="number">45935.690912335944</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">110000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">45938.69098338585</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">110000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0429</span> │  <span class="number">45941.69140548378</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.019</span> sec. Processed <span class="number">13.69</span> thousand rows, <span class="number">1.12</span> MB (<span class="number">729.14</span> thousand rows/s., <span class="number">59.84</span> MB/s.) </span><br><span class="line"></span><br><span class="line">物化视图</span><br><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    sum(count) AS count, </span><br><span class="line">    maxMerge(max_value_state) AS max, </span><br><span class="line">    minMerge(min_value_state) AS min, </span><br><span class="line">    avgMerge(avg_value_state) AS avg</span><br><span class="line">FROM counter_daily_mv</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">110000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.051</span> │  <span class="number">45914.69035234097</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">110000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0291</span> │  <span class="number">45917.69056040798</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">110000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │ <span class="number">45920.690478928045</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">110000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">45923.69086044358</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">110000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0114</span> │  <span class="number">45926.69083122718</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">110000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.0475</span> │ <span class="number">45929.691088042426</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">110000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │  <span class="number">45932.69135215635</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">110000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0107</span> │ <span class="number">45935.690912335944</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">110000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">45938.69098338585</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">110000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0429</span> │  <span class="number">45941.69140548378</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.003</span> sec. Processed <span class="number">13.69</span> thousand rows, <span class="number">1.12</span> MB (<span class="number">3.99</span> million rows/s., <span class="number">327.87</span> MB/s.) </span><br><span class="line"></span><br><span class="line">源表</span><br><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    count(*) AS count, </span><br><span class="line">    max(value) AS max, </span><br><span class="line">    min(value) AS min, </span><br><span class="line">    avg(value) AS avg</span><br><span class="line">FROM counter</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">110000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.051</span> │  <span class="number">45914.69035234098</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">110000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0291</span> │  <span class="number">45917.69056040798</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">110000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │  <span class="number">45920.69047892806</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">110000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">45923.69086044358</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">110000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0114</span> │ <span class="number">45926.690831227155</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">110000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.0475</span> │  <span class="number">45929.69108804243</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">110000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │ <span class="number">45932.691352156355</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">110000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0107</span> │ <span class="number">45935.690912335944</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">110000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">45938.69098338586</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">110000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0429</span> │  <span class="number">45941.69140548378</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">14.041</span> sec. Processed <span class="number">1.10</span> billion rows, <span class="number">8.80</span> GB (<span class="number">78.34</span> million rows/s., <span class="number">626.72</span> MB/s.) </span><br></pre></td></tr></table></figure>
<p>该查询正确总结了包括新插入数据在内的所有数据. 您可以通过在counter表上重新运行原始选择来检查计算结果是否一致. 不同之处在于, 物化视图返回数据的速度要快900倍(在我的测试中为4680倍). 由此可见, 学习一些新语法是值得的!!</p>
<p>此时, 我们可以回过头来解释一下在这一切的幕后发生了什么. </p>
<h2 id="Aggregate-Functions"><a href="#Aggregate-Functions" class="headerlink" title="Aggregate Functions"></a>Aggregate Functions</h2><p>Aggregate functions类似于收集器(collectors), 允许ClickHouse从分布在多个parts上的数据构建聚合. 下面的图表显示了如何计算平均值. 我们从源表中的一个可选值开始. 物化视图使用avgState函数将数据转换为<code>partial aggregate</code>, avgState函数是一个内部结构. 最后, 在查询数据时, 应用avgMerge将partial aggregates的数据累加为最终的数字. </p>
<p><img src="https://altinity.com/wp-content/uploads/2019/09/6c5f0-aggregate-functions-2.png" alt="af"></p>
<p><code>partial aggregate</code>使物化视图能够处理分布在多个节点上的多个parts上的数据. 即使您更改了group by列, merge函数也可以正确地组装聚合. 仅仅结合简单的平均值是行不通的, 因为它们在将每个部分平均值加到总数时缺乏必要的权重. 这种行为有一个重要的后果(这段不会翻译, 原文: It would not work just to combine simple average values, because they would be lacking the weights necessary to scale each partial average as it added to the total. This behavior has an important consequence.). </p>
<p>还记得上面我们提到过, ClickHouse可以使用带有汇总的每日数据的物化视图来回答我们的示例查询吗?这是聚合函数工作的结果. 这意味着我们的daily视图还可以回答关于周、月、年或整个间隔的问题. </p>
<p>ClickHouse有点不寻常, 它直接以SQL语法公开了partial aggregates, 但是它们解决问题的方式非常强大.  当您设计实例化视图时, 请尝试使用每日汇总之类的技巧来解决单个视图中的多个问题.  单个视图可以回答很多问题. </p>
<h2 id="Table-Engines-for-Materialized-Views"><a href="#Table-Engines-for-Materialized-Views" class="headerlink" title="Table Engines for Materialized Views"></a>Table Engines for Materialized Views</h2><p>ClickHouse有多个对物化视图有用的引擎. AggregatingMergeTree引擎只使用聚合函数. 如果您想做计数或求和, 您需要使用目标表中的AggregateFunction数据类型来定义它们. 您还需要在视图和select语句中使用state和merge函数. 例如, 要处理计数(count), 您需要在上面的示例中使用countState(count)和countMerge(count). </p>
<p>我们建议使用SummingMergeTree引擎在物化视图中进行聚合. 它可以很好地处理聚合函数. 它可以很好地处理聚合函数.  但是, 它会将它们隐藏起来以进行总数和计数, 这对于简单的案例来说非常方便. 在这种情况下, 它不会阻止您使用state和merge函数; 只是你没必要这么做. 同时, 它完成了AggregatingMergeTree的所有工作. </p>
<h2 id="Schema-Migration"><a href="#Schema-Migration" class="headerlink" title="Schema Migration"></a>Schema Migration</h2><p>在生产系统中, 数据库模式往往会发生变化, 特别是那些正在积极开发的系统. 当使用带有显式目标表的物化视图时, 可以相对容易地管理这些更改. </p>
<p>让我们举一个简单的例子. 假设counter表的名称更改为counter_replicated. 一旦应用了此更改, 物化视图将无法工作. 更糟糕的是, 这个错误将阻止对counter表的插入. 您可以按照以下方式处理更改. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Delete view prior to schema change.</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> counter_daily_mv</span><br><span class="line"><span class="comment">-- Rename source table.</span></span><br><span class="line"><span class="keyword">RENAME</span> <span class="keyword">TABLE</span> counter <span class="keyword">TO</span> counter_replicated</span><br><span class="line"><span class="comment">-- Recreate view with correct source table name.</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> counter_daily_mv</span><br><span class="line"><span class="keyword">TO</span> counter_daily</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">  toStartOfDay(<span class="keyword">when</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">  device,</span><br><span class="line">  <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span>,</span><br><span class="line">  maxState(<span class="keyword">value</span>) <span class="keyword">AS</span> max_value_state,</span><br><span class="line">  minState(<span class="keyword">value</span>) <span class="keyword">AS</span> min_value_state,</span><br><span class="line">  avgState(<span class="keyword">value</span>) <span class="keyword">AS</span> avg_value_state</span><br><span class="line"><span class="keyword">FROM</span> counter_replicated</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>根据架构迁移中的实际步骤, 您可能必须处理更改物化视图定义时插入到源表的数据(这些数据未插入到物化视图中).  您可以使用过滤条件和手动加载来处理该问题, 如我们在主要示例中所示. </p>
<h2 id="Materialized-View-Plumbing-and-Data-Sizes"><a href="#Materialized-View-Plumbing-and-Data-Sizes" class="headerlink" title="Materialized View Plumbing and Data Sizes"></a>Materialized View Plumbing and Data Sizes</h2><p>最后, 让我们再看看数据表和物化视图之间的关系. 目标表是一个普通表. 您可以从目标表或物化视图中选择数据. 没有区别. 此外, 如果您删除物化视图, 目标表扔将保留. 正如我们刚才所展示的, 您可以通过简单地删除和重新创建视图来对其进行模式更改. 如果需要更改目标表本身, 可以像对任何其他表一样运行ALTER table命令. </p>
<p><img src="https://altinity.com/wp-content/uploads/2019/09/71938-mat-view-plumbing-with-target-table.png" alt="img"></p>
<p>该图还显示了源表和目标表的数据大小.  物化视图通常远小于其汇总数据的表.  我们的示例就是这样的结果.  以下查询显示了此示例的大小差异. </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">table</span>, </span><br><span class="line">    formatReadableSize(sum(data_compressed_bytes)) <span class="keyword">AS</span> tc, </span><br><span class="line">    formatReadableSize(sum(data_uncompressed_bytes)) <span class="keyword">AS</span> tu, </span><br><span class="line">    sum(data_compressed_bytes) / sum(data_uncompressed_bytes) <span class="keyword">AS</span> ratio</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">system</span>.<span class="keyword">columns</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">database</span> = currentDatabase()</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">table</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">table</span> <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">table</span>────────────────────────────────┬─tc─────────┬─tu─────────┬──────────────ratio─┐</span><br><span class="line">│ counter                              │ <span class="number">7.14</span> GiB   │ <span class="number">12.29</span> GiB  │ <span class="number">0.5805970993939394</span> │</span><br><span class="line">│ counter_daily                        │ <span class="number">248.77</span> KiB │ <span class="number">494.31</span> KiB │  <span class="number">0.503261750004939</span> │</span><br><span class="line">│ counter_daily_mv                     │ <span class="number">0.00</span> B     │ <span class="number">0.00</span> B     │                <span class="keyword">nan</span> │</span><br><span class="line">└──────────────────────────────────────┴────────────┴────────────┴────────────────────┘</span><br></pre></td></tr></table></figure>
<p>如计算所示, 物化视图目标表大约比物化视图派生的源数据小3万倍. 这种差异极大地加快了查询速度. 如前面所示, 在使用来自物化视图的数据时, 测试查询的运行速度大约快了900x(我这里测试为4680x). </p>
<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap-up"></a>Wrap-up</h2><p>ClickHouse物化视图非常灵活, 这得益于强大的聚合功能以及源表、物化视图和目标表之间的简单关系. 物化视图允许显式目标表, 这是一个有用的特性, 可以简化模式迁移. 您还可以通过向视图选择定义添加筛选条件并手动加载丢失的数据来减少可能丢失的视图更新. </p>
<p>物化视图还有许多其他方法可以帮助转换数据. 我们已经描述了其中的一些问题, 比如 <a href="https://www.altinity.com/blog/clickhouse-continues-to-crush-time-series">last point queries</a>, 并且计划将来在这个博客上写一些其他的问题. 欲了解更多信息, 请查看我们最近的网络研讨会<a href="https://www.altinity.com/events/2019/6/26/clickhouse-and-the-magic-of-materialized-views">ClickHouse and the Magic of Materialized Views</a>. 我们在这里介绍了几个用例示例. </p>
<p>最后, 如果你正在以你认为其他用户会感兴趣的方式使用物化视图, 写一篇文章或者在当地的ClickHouse会议上发言. 我们很乐意在Altinity的博客上发布社区用户的内容, 并在未来的聚会上寻找演讲者. 如果你有什么想与社区分享的, 请让我们知道. </p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ClickHouse-Materialized-Views-Illuminated-Part-2&quot;&gt;&lt;a href=&quot;#ClickHouse-Materialized-Views-Illuminated-Part-2&quot; class=&quot;headerlink&quot; title=&quot;ClickHouse Materialized Views Illuminated, Part 2&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://altinity.com/blog/clickhouse-materialized-views-illuminated-part-2&quot;&gt;ClickHouse Materialized Views Illuminated, Part 2&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://altinity.com/wp-content/uploads/2020/02/d1a1c-stockvault-abstract-glowing-multicolor-wireframe-background268674_small.png&quot; alt=&quot;header&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&quot;https://www.altinity.com/blog/clickhouse-materialized-views-illuminated-part-1&quot;&gt;Read part 1&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="ClickHouse" scheme="http://fuxkdb.com/tags/ClickHouse/"/>
    
      <category term="物化视图" scheme="http://fuxkdb.com/tags/%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>译文 ClickHouse Materialized Views Illuminated, Part 1</title>
    <link href="http://fuxkdb.com/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-1/"/>
    <id>http://fuxkdb.com/2020/08/23/2020-08-23-译文-ClickHouse-Materialized-Views-Illuminated,-Part-1/</id>
    <published>2020-08-23T11:04:00.000Z</published>
    <updated>2020-08-23T11:04:57.497Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ClickHouse-Materialized-Views-Illuminated-Part-1"><a href="#ClickHouse-Materialized-Views-Illuminated-Part-1" class="headerlink" title="ClickHouse Materialized Views Illuminated, Part 1"></a><a href="https://altinity.com/blog/clickhouse-materialized-views-illuminated-part-1">ClickHouse Materialized Views Illuminated, Part 1</a></h1><p><img src="https://altinity.com/wp-content/uploads/2020/02/4c9e8-stockvault-abstract-background-big-data-concept264047.jpg" alt="header"></p>
<p><a href="https://altinity.com/blog/">Altinity blog</a>的读者们知道我们喜欢ClickHouse的<a href="https://clickhouse.tech/docs/en/sql-reference/statements/create/view/#materialized">物化视图</a>. 物化视图可以实现聚合计算, 从Kafka读取数据, 实现最后点查询(last point queries)以及重组表主键索引和排序顺序. 除了这些功能之外, 物化视图可以在大量节点上很好地扩缩, 并可以处理大型数据集. 它们是ClickHouse的独特功能之一.</p>
<p>在计算领域, 强大的功能至少意味着一点点复杂性. 这篇由两部分组成的文章通过解释物化视图的工作原理来填补空白, 从而使初学者也可以有效地使用它们. 我们将通过几个详细的示例, 您可以根据自己的使用进行调整. 在此过程中, 我们将探索用于创建视图的语法的确切含义, 并让您深入了解ClickHouse在做什么.  示例是完全自包含的, 因此您可以将它们复制/粘贴到clickhouse-client中并自己运行它们.<br><a id="more"></a></p>
<h2 id="How-Materialized-Views-Work-Computing-Sums"><a href="#How-Materialized-Views-Work-Computing-Sums" class="headerlink" title="How Materialized Views Work: Computing Sums"></a>How Materialized Views Work: Computing Sums</h2><p>ClickHouse物化视图自动在表之间转换数据. 它们类似于触发器, 对插入的行运行查询并将结果存入第二个表. 让我们看一个基本的例子. 假设我们有一个记录用户下载的表, 如下所示.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> download (</span><br><span class="line">  <span class="keyword">when</span> DateTime,</span><br><span class="line">  userid UInt32,</span><br><span class="line">  <span class="keyword">bytes</span> Float32</span><br><span class="line">) <span class="keyword">ENGINE</span>=MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(<span class="keyword">when</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (userid, <span class="keyword">when</span>)</span><br></pre></td></tr></table></figure>
<p>我们希望跟踪每个用户的每日下载. 让我们看看如何用一个查询来做到这一点. 首先, 我们需要为单个用户向表中添加一些数据.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> download</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">now</span>() + <span class="built_in">number</span> * <span class="number">60</span> <span class="keyword">as</span> <span class="keyword">when</span>,</span><br><span class="line">    <span class="number">25</span>,</span><br><span class="line">    <span class="keyword">rand</span>() % <span class="number">100000000</span></span><br><span class="line">  <span class="keyword">FROM</span> system.numbers</span><br><span class="line">  <span class="keyword">LIMIT</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<p>接下来, 让我们运行一个查询来显示该用户的每日下载. 当添加新用户时, 这也将正常工作. </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    toStartOfDay(when) AS day, </span><br><span class="line">    userid, </span><br><span class="line">    count() AS downloads, </span><br><span class="line">    sum(bytes) AS bytes</span><br><span class="line">FROM download</span><br><span class="line">GROUP BY </span><br><span class="line">    userid, </span><br><span class="line">    day</span><br><span class="line">ORDER BY </span><br><span class="line">    userid ASC, </span><br><span class="line">    day ASC</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">736</span> │ <span class="number">36722522631</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73305428060</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73183910537</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1384</span> │ <span class="number">70059352697</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br></pre></td></tr></table></figure>
<p>我们可以通过每次运行查询以交互方式为应用程序计算这些每日总数, 但是对于大型表, 提前计算它们将更快, 更节省资源.  因此, 最好将结果放在单独的表格中, 该表格可以连续跟踪每天每个用户的下载总数.  我们可以使用以下物化视图来做到这一点. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> download_daily_mv</span><br><span class="line"><span class="keyword">ENGINE</span> = SummingMergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(<span class="keyword">day</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (userid, <span class="keyword">day</span>)</span><br><span class="line">POPULATE</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">  toStartOfDay(<span class="keyword">when</span>) <span class="keyword">AS</span> <span class="keyword">day</span>,</span><br><span class="line">  userid,</span><br><span class="line">  <span class="keyword">count</span>() <span class="keyword">as</span> downloads,</span><br><span class="line">  <span class="keyword">sum</span>(<span class="keyword">bytes</span>) <span class="keyword">AS</span> <span class="keyword">bytes</span></span><br><span class="line"><span class="keyword">FROM</span> download</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> userid, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>这里有三件重要的事情需要注意. 首先, 物化视图定义允许类似于CREATE TABLE的语法, 这是有意义的, 因为这个命令将实际创建一个隐藏的目标表(.inner表)来保存视图数据. 我们使用的ClickHouse引擎旨在使计算和计数变得简单:<a href="https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/summingmergetree/">SummingMergeTree</a>. 它是用于计算聚合的物化视图的推荐引擎. </p>
<p>其次, 视图定义包含关键字POPULATE. 这告诉ClickHouse将<code>download</code>表中的现有数据插入物化视图. 我们稍后会更多地讨论automatic population. </p>
<blockquote>
<p>需要注意, 在<code>POPULATE</code>填充历史数据的期间, 新进入的这部分数据会被忽略掉, 所以如果对准确性要求非常高, 应慎用</p>
</blockquote>
<p>第三, 视图定义包含一个SELECT语句, 该语句定义在加载视图时如何转换数据. 这个查询在表中的新数据上运行, 以计算每天每个用户id的下载数量和总字节数. 它本质上与我们以交互方式运行的查询相同, 只是在本例中, 结果将放在隐藏的目标表(.inner表)中. 我们可以跳过排序, 因为视图定义已经确保了排序顺序. </p>
<p>现在, 我们从物化视图中查询数据</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM download_daily_mv</span><br><span class="line">ORDER BY day, userid </span><br><span class="line">LIMIT <span class="number">5</span></span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">736</span> │ <span class="number">36722522631</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73305428060</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73183910537</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1384</span> │ <span class="number">70059352697</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br></pre></td></tr></table></figure>
<p>这为我们提供了与先前查询完全相同的答案.  原因是上面介绍的POPULATE关键字.  它确保源表中的现有数据自动加载到视图中.  不过, 有一个重要警告：如果在填充视图时插入了新数据, ClickHouse将会丢失它们.  在本系列的第二部分中, 我们将展示如何手动插入数据并避免数据遗漏的问题. </p>
<p>现在, 尝试使用其他用户向表中添加更多数据. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> download</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">now</span>() + <span class="built_in">number</span> * <span class="number">60</span> <span class="keyword">as</span> <span class="keyword">when</span>,</span><br><span class="line">    <span class="number">22</span>,</span><br><span class="line">    <span class="keyword">rand</span>() % <span class="number">100000000</span></span><br><span class="line">  <span class="keyword">FROM</span> system.numbers</span><br><span class="line">  <span class="keyword">LIMIT</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<p>如果您从实例化视图中进行选择, 您将看到它现在具有用户ID 22和25的总数. 请注意, 一旦INSERT完成, 将立即填充新数据.  这是ClickHouse实例化视图的重要功能, 这使其对于实时分析非常有用. </p>
<p>下面是查询和新结果. </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM download_daily_mv</span><br><span class="line">ORDER BY </span><br><span class="line">    userid ASC, </span><br><span class="line">    day ASC</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │       <span class="number">416</span> │ <span class="number">21063519801</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │      <span class="number">1440</span> │ <span class="number">71523929305</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │      <span class="number">1440</span> │ <span class="number">70435459582</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │      <span class="number">1440</span> │ <span class="number">70725673036</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │       <span class="number">264</span> │ <span class="number">13826466067</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬────────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1467</span> │  <span class="number">75441118166</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">144811386193</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">145138479865</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2773</span> │ <span class="number">138488485955</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴──────────────┘</span><br></pre></td></tr></table></figure>
<p>作为练习, 您可以对源表运行原始查询, 以确认它与物化视图中的总数相匹配. </p>
<p>作为最后一个示例, 让我们使用物化视图按月汇总. 在本例中, 我们将物化视图视为一个普通表, 按月分组, 如下所示. 我们添加了WITH TOTALS子句, 它打印一个方便的聚合的总和. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    toStartOfMonth(<span class="keyword">day</span>) <span class="keyword">AS</span> <span class="keyword">month</span>, </span><br><span class="line">    userid, </span><br><span class="line">    <span class="keyword">sum</span>(downloads), </span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">bytes</span>)</span><br><span class="line"><span class="keyword">FROM</span> download_daily_mv</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    userid, </span><br><span class="line">    <span class="keyword">month</span></span><br><span class="line">    <span class="keyword">WITH</span> TOTALS</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">    userid <span class="keyword">ASC</span>, </span><br><span class="line">    <span class="keyword">month</span> <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line">┌──────<span class="keyword">month</span>─┬─userid─┬─<span class="keyword">sum</span>(downloads)─┬───<span class="keyword">sum</span>(<span class="keyword">bytes</span>)─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-01</span> │     <span class="number">22</span> │           <span class="number">5000</span> │ <span class="number">247575047791</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-01</span> │     <span class="number">25</span> │          <span class="number">10000</span> │ <span class="number">503879470179</span> │</span><br><span class="line">└────────────┴────────┴────────────────┴──────────────┘</span><br><span class="line"></span><br><span class="line">Extremes:</span><br><span class="line">┌──────<span class="keyword">month</span>─┬─userid─┬─<span class="keyword">sum</span>(downloads)─┬───<span class="keyword">sum</span>(<span class="keyword">bytes</span>)─┐</span><br><span class="line">│ <span class="number">0000</span><span class="number">-00</span><span class="number">-00</span> │      <span class="number">0</span> │          <span class="number">15000</span> │ <span class="number">751454517970</span> │</span><br><span class="line">└────────────┴────────┴────────────────┴──────────────┘</span><br></pre></td></tr></table></figure>
<p>从前面的示例中, 我们可以清楚地看到实例化视图如何正确地汇总源数据中的数据(how the materialized view correctly summarizes data from the source data).  如上例所示, 我们甚至可以“summarize the summaries”.  那么幕后到底发生了什么？ 下图说明了数据的逻辑流. </p>
<p><img src="https://altinity.com/wp-content/uploads/2019/09/9a01c-summingmergetree-diagram.png" alt="logical"></p>
<p>如图所示, 原表上INSERT的值被转换并应用于隐藏的目标表(.inner表). 要填充视图(To populate the view), 您要做的就是在源表中插入数据.</p>
<p>您可以从隐藏的目标表(.inner表)和物化视图中进行查询. 实际上ClickHouse就是将查询路由到创建物化视图时自动创建的internel表中的.</p>
<p>图中还有另外一件重要的事情需要注意. 物化视图创建一个具有特殊名称私有表来保存数据. 如果您通过输入<code>DROP TABLE download_daily_mv</code>删除物化视图, 则私有表也会被删除. 如果需要更改视图, 则需要将其删除并使用新数据重新创建</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">SHOW TABLES</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">┌─name─────────────────────┐</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">│ .inner.download_daily_mv │</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">│ download                 │</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">│ download_daily_mv        │</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">└──────────────────────────┘</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>.inner.download_daily_mv就是 internel表或叫私有表</p>
</blockquote>
<h2 id="Wrap-up-总结"><a href="#Wrap-up-总结" class="headerlink" title="Wrap-up - 总结"></a>Wrap-up - 总结</h2><p>我们刚刚审阅的示例使用SummingMergeTree创建一个视图以累加每日用户下载量.  我们从物化视图对SELECT使用了标准SQL语法.  这是SummingMergeTree引擎的特殊功能, 仅适用于总和和计数.  对于其他类型的聚合, 我们需要使用其他方法. </p>
<p>另外, 我们的示例使用POPULATE关键字将现有表数据发布到视图创建的私有目标表(.inner表)中.  如果在填充视图时到达新的INSERT行, ClickHouse将错过它们.  当您是唯一使用数据集的人时, 此限制很容易解决, 但对于不断加载数据的生产系统来说是个问题.  此外, 删除视图后, 专用表也会消失.  这使得很难更改视图以适应源表中的架构更改. </p>
<p>在下一篇文章中, 我们将展示如何创建物化视图来计算其他类型的聚合, 比如平均值或最大值/最小值. 我们还将展示如何显式定义目标表(.inner表), 并使用我们自己的SQL语句手动将数据加载到其中. 我们还将简要介绍模式迁移(schema migration). 同时, 我们希望您喜欢这一简要介绍, 并发现示例有用. </p>
<h1 id="实测及问题"><a href="#实测及问题" class="headerlink" title="实测及问题"></a>实测及问题</h1><h2 id="删除基表-物化视图仍然可以查询"><a href="#删除基表-物化视图仍然可以查询" class="headerlink" title="删除基表, 物化视图仍然可以查询"></a>删除基表, 物化视图仍然可以查询</h2><p>这是符合预期的, 因为物化视图是存储了数据的</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">bj2-all-clickhouse-test<span class="number">-02</span> :) drop table download;</span><br><span class="line"></span><br><span class="line">DROP TABLE download</span><br><span class="line"></span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.016</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-all-clickhouse-test<span class="number">-02</span> :) show tables;</span><br><span class="line"></span><br><span class="line">SHOW TABLES</span><br><span class="line"></span><br><span class="line">┌─name─────────────────────┐</span><br><span class="line">│ .inner.download_daily_mv │</span><br><span class="line">│ download_daily_mv        │</span><br><span class="line">│ sbtest                   │</span><br><span class="line">│ sbtest_local             │</span><br><span class="line">└──────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.001</span> sec. </span><br><span class="line"></span><br><span class="line">bj2-all-clickhouse-test<span class="number">-02</span> :) select * <span class="keyword">from</span> download_daily_mv;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM download_daily_mv</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬────────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1467</span> │  <span class="number">75441118166</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">144811386193</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">145138479865</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2773</span> │ <span class="number">138488485955</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴──────────────┘</span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │       <span class="number">416</span> │ <span class="number">21063519801</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │      <span class="number">1440</span> │ <span class="number">71523929305</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │      <span class="number">1440</span> │ <span class="number">70435459582</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │      <span class="number">1440</span> │ <span class="number">70725673036</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">22</span> │       <span class="number">264</span> │ <span class="number">13826466067</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">9</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.008</span> sec. </span><br></pre></td></tr></table></figure>
<h2 id="数据在分区合并时聚合"><a href="#数据在分区合并时聚合" class="headerlink" title="数据在分区合并时聚合"></a>数据在分区合并时聚合</h2><p>重新创建download表和物化视图</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    toStartOfDay(when) AS day, </span><br><span class="line">    userid, </span><br><span class="line">    count() AS downloads, </span><br><span class="line">    sum(bytes) AS bytes</span><br><span class="line">FROM download</span><br><span class="line">GROUP BY </span><br><span class="line">    userid, </span><br><span class="line">    day</span><br><span class="line">ORDER BY </span><br><span class="line">    userid ASC, </span><br><span class="line">    day ASC</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">387</span> │ <span class="number">19855551536</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73316885071</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">72322018002</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">71675677053</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">293</span> │ <span class="number">14125612942</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM download_daily_mv</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">387</span> │ <span class="number">19855551536</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73316885071</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">72322018002</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">71675677053</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">293</span> │ <span class="number">14125612942</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再次向基表中插入数据, 然后查看物化视图中的数据</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO download SELECT </span><br><span class="line">    now() + (number * <span class="number">60</span>) AS when, </span><br><span class="line">    <span class="number">25</span>, </span><br><span class="line">    rand() % <span class="number">100000000</span></span><br><span class="line">FROM system.numbers</span><br><span class="line">LIMIT <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM download_daily_mv</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">387</span> │ <span class="number">19855551536</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73316885071</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">72322018002</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">71675677053</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">293</span> │ <span class="number">14125612942</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬───────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">385</span> │ <span class="number">18771807859</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">73675739078</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">70555293899</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">1440</span> │ <span class="number">70773685728</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">295</span> │ <span class="number">14750186600</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴─────────────┘</span><br></pre></td></tr></table></figure>
<p>可以看到物化视图中的数据并没有”全部聚合完整”</p>
<p>查看物化视图private表分区情况</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">bj2-all-clickhouse-test-02</span> <span class="string">:)</span> <span class="string">select</span> <span class="string">*</span> <span class="string">from</span> <span class="string">system.parts</span> <span class="string">where</span> <span class="string">table=&#x27;.inner.download_daily_mv&#x27;\G</span></span><br><span class="line"></span><br><span class="line"><span class="string">SELECT</span> <span class="string">*</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">system.parts</span></span><br><span class="line"><span class="string">WHERE</span> <span class="string">table</span> <span class="string">=</span> <span class="string">&#x27;.inner.download_daily_mv&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Row 1:</span></span><br><span class="line"><span class="string">──────</span></span><br><span class="line"><span class="attr">partition:</span>                             <span class="number">202008</span></span><br><span class="line"><span class="attr">name:</span>                                  <span class="string">202008_1_1_0</span></span><br><span class="line"><span class="attr">part_type:</span>                             <span class="string">Wide</span></span><br><span class="line"><span class="attr">active:</span>                                <span class="number">1</span></span><br><span class="line"><span class="attr">marks:</span>                                 <span class="number">2</span></span><br><span class="line"><span class="attr">rows:</span>                                  <span class="number">5</span></span><br><span class="line"><span class="attr">bytes_on_disk:</span>                         <span class="number">421</span></span><br><span class="line"><span class="attr">data_compressed_bytes:</span>                 <span class="number">200</span></span><br><span class="line"><span class="attr">data_uncompressed_bytes:</span>               <span class="number">120</span></span><br><span class="line"><span class="attr">marks_bytes:</span>                           <span class="number">192</span></span><br><span class="line"><span class="attr">modification_time:</span>                     <span class="number">2020-08-18 17:33:51</span></span><br><span class="line"><span class="attr">remove_time:</span>                           <span class="number">0000-00-00 00:00:00</span></span><br><span class="line"><span class="attr">refcount:</span>                              <span class="number">1</span></span><br><span class="line"><span class="attr">min_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">max_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">min_time:</span>                              <span class="number">2020-08-18 00:00:00</span></span><br><span class="line"><span class="attr">max_time:</span>                              <span class="number">2020-08-22 00:00:00</span></span><br><span class="line"><span class="attr">partition_id:</span>                          <span class="number">202008</span></span><br><span class="line"><span class="attr">min_block_number:</span>                      <span class="number">1</span></span><br><span class="line"><span class="attr">max_block_number:</span>                      <span class="number">1</span></span><br><span class="line"><span class="attr">level:</span>                                 <span class="number">0</span></span><br><span class="line"><span class="attr">data_version:</span>                          <span class="number">1</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory:</span>           <span class="number">16</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory_allocated:</span> <span class="number">8192</span></span><br><span class="line"><span class="attr">is_frozen:</span>                             <span class="number">0</span></span><br><span class="line"><span class="attr">database:</span>                              <span class="string">duyalan</span></span><br><span class="line"><span class="attr">table:</span>                                 <span class="string">.inner.download_daily_mv</span></span><br><span class="line"><span class="attr">engine:</span>                                <span class="string">SummingMergeTree</span></span><br><span class="line"><span class="attr">disk_name:</span>                             <span class="string">default</span></span><br><span class="line"><span class="attr">path:</span>                                  <span class="string">/data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_1_1_0/</span></span><br><span class="line"><span class="attr">hash_of_all_files:</span>                     <span class="string">f4b55a88dac393d25ffe1c703cca4f6d</span></span><br><span class="line"><span class="attr">hash_of_uncompressed_files:</span>            <span class="string">58a4ab29ef36c22884ee7accd528b590</span></span><br><span class="line"><span class="attr">uncompressed_hash_of_compressed_files:</span> <span class="string">e18b006f608580db132ed90adb46902f</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Row 2:</span></span><br><span class="line"><span class="string">──────</span></span><br><span class="line"><span class="attr">partition:</span>                             <span class="number">202008</span></span><br><span class="line"><span class="attr">name:</span>                                  <span class="string">202008_2_2_0</span></span><br><span class="line"><span class="attr">part_type:</span>                             <span class="string">Wide</span></span><br><span class="line"><span class="attr">active:</span>                                <span class="number">1</span></span><br><span class="line"><span class="attr">marks:</span>                                 <span class="number">2</span></span><br><span class="line"><span class="attr">rows:</span>                                  <span class="number">5</span></span><br><span class="line"><span class="attr">bytes_on_disk:</span>                         <span class="number">421</span></span><br><span class="line"><span class="attr">data_compressed_bytes:</span>                 <span class="number">200</span></span><br><span class="line"><span class="attr">data_uncompressed_bytes:</span>               <span class="number">120</span></span><br><span class="line"><span class="attr">marks_bytes:</span>                           <span class="number">192</span></span><br><span class="line"><span class="attr">modification_time:</span>                     <span class="number">2020-08-18 17:35:13</span></span><br><span class="line"><span class="attr">remove_time:</span>                           <span class="number">0000-00-00 00:00:00</span></span><br><span class="line"><span class="attr">refcount:</span>                              <span class="number">1</span></span><br><span class="line"><span class="attr">min_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">max_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">min_time:</span>                              <span class="number">2020-08-18 00:00:00</span></span><br><span class="line"><span class="attr">max_time:</span>                              <span class="number">2020-08-22 00:00:00</span></span><br><span class="line"><span class="attr">partition_id:</span>                          <span class="number">202008</span></span><br><span class="line"><span class="attr">min_block_number:</span>                      <span class="number">2</span></span><br><span class="line"><span class="attr">max_block_number:</span>                      <span class="number">2</span></span><br><span class="line"><span class="attr">level:</span>                                 <span class="number">0</span></span><br><span class="line"><span class="attr">data_version:</span>                          <span class="number">2</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory:</span>           <span class="number">16</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory_allocated:</span> <span class="number">8192</span></span><br><span class="line"><span class="attr">is_frozen:</span>                             <span class="number">0</span></span><br><span class="line"><span class="attr">database:</span>                              <span class="string">duyalan</span></span><br><span class="line"><span class="attr">table:</span>                                 <span class="string">.inner.download_daily_mv</span></span><br><span class="line"><span class="attr">engine:</span>                                <span class="string">SummingMergeTree</span></span><br><span class="line"><span class="attr">disk_name:</span>                             <span class="string">default</span></span><br><span class="line"><span class="attr">path:</span>                                  <span class="string">/data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_2_2_0/</span></span><br><span class="line"><span class="attr">hash_of_all_files:</span>                     <span class="string">049d090ea65c24be8544ab86846ea9fa</span></span><br><span class="line"><span class="attr">hash_of_uncompressed_files:</span>            <span class="string">58a4ab29ef36c22884ee7accd528b590</span></span><br><span class="line"><span class="attr">uncompressed_hash_of_compressed_files:</span> <span class="string">9ffea93e6b9bc375c7f04374b4a4a6a9</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2 rows in set. Elapsed:</span> <span class="number">0.002</span> <span class="string">sec.</span> </span><br></pre></td></tr></table></figure>
<p>可以看到, 有两个active分区<code>202008_1_1_0</code>, <code>202008_2_2_0</code></p>
<p>我们手动<code>OPTIMIZE</code>尝试合并分区</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bj2-all-clickhouse-test-02 :) <span class="keyword">optimize</span> <span class="keyword">table</span> download_daily_mv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">OPTIMIZE</span> <span class="keyword">TABLE</span> download_daily_mv</span><br><span class="line"></span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.004</span> sec. </span><br></pre></td></tr></table></figure>
<p>再次查询物化视图数据</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bj2-all-clickhouse-test<span class="number">-02</span> :) select * <span class="keyword">from</span> download_daily_mv;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM download_daily_mv</span><br><span class="line"></span><br><span class="line">┌─────────────────day─┬─userid─┬─downloads─┬────────bytes─┐</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-18</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">772</span> │  <span class="number">38627359395</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">146992624149</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-20</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">142877311901</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-21</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │      <span class="number">2880</span> │ <span class="number">142449362781</span> │</span><br><span class="line">│ <span class="number">2020</span><span class="number">-08</span><span class="number">-22</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │     <span class="number">25</span> │       <span class="number">588</span> │  <span class="number">28875799542</span> │</span><br><span class="line">└─────────────────────┴────────┴───────────┴──────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.001</span> sec. </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看private表分区情况</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">bj2-all-clickhouse-test-02</span> <span class="string">:)</span> <span class="string">select</span> <span class="string">*</span> <span class="string">from</span> <span class="string">system.parts</span> <span class="string">where</span> <span class="string">table=&#x27;.inner.download_daily_mv&#x27;\G</span></span><br><span class="line"></span><br><span class="line"><span class="string">SELECT</span> <span class="string">*</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">system.parts</span></span><br><span class="line"><span class="string">WHERE</span> <span class="string">table</span> <span class="string">=</span> <span class="string">&#x27;.inner.download_daily_mv&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Row 1:</span></span><br><span class="line"><span class="string">──────</span></span><br><span class="line"><span class="attr">partition:</span>                             <span class="number">202008</span></span><br><span class="line"><span class="attr">name:</span>                                  <span class="string">202008_1_1_0</span></span><br><span class="line"><span class="attr">part_type:</span>                             <span class="string">Wide</span></span><br><span class="line"><span class="attr">active:</span>                                <span class="number">0</span></span><br><span class="line"><span class="attr">marks:</span>                                 <span class="number">2</span></span><br><span class="line"><span class="attr">rows:</span>                                  <span class="number">5</span></span><br><span class="line"><span class="attr">bytes_on_disk:</span>                         <span class="number">421</span></span><br><span class="line"><span class="attr">data_compressed_bytes:</span>                 <span class="number">200</span></span><br><span class="line"><span class="attr">data_uncompressed_bytes:</span>               <span class="number">120</span></span><br><span class="line"><span class="attr">marks_bytes:</span>                           <span class="number">192</span></span><br><span class="line"><span class="attr">modification_time:</span>                     <span class="number">2020-08-18 17:33:51</span></span><br><span class="line"><span class="attr">remove_time:</span>                           <span class="number">2020-08-18 17:38:24</span></span><br><span class="line"><span class="attr">refcount:</span>                              <span class="number">1</span></span><br><span class="line"><span class="attr">min_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">max_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">min_time:</span>                              <span class="number">2020-08-18 00:00:00</span></span><br><span class="line"><span class="attr">max_time:</span>                              <span class="number">2020-08-22 00:00:00</span></span><br><span class="line"><span class="attr">partition_id:</span>                          <span class="number">202008</span></span><br><span class="line"><span class="attr">min_block_number:</span>                      <span class="number">1</span></span><br><span class="line"><span class="attr">max_block_number:</span>                      <span class="number">1</span></span><br><span class="line"><span class="attr">level:</span>                                 <span class="number">0</span></span><br><span class="line"><span class="attr">data_version:</span>                          <span class="number">1</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory:</span>           <span class="number">16</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory_allocated:</span> <span class="number">8192</span></span><br><span class="line"><span class="attr">is_frozen:</span>                             <span class="number">0</span></span><br><span class="line"><span class="attr">database:</span>                              <span class="string">duyalan</span></span><br><span class="line"><span class="attr">table:</span>                                 <span class="string">.inner.download_daily_mv</span></span><br><span class="line"><span class="attr">engine:</span>                                <span class="string">SummingMergeTree</span></span><br><span class="line"><span class="attr">disk_name:</span>                             <span class="string">default</span></span><br><span class="line"><span class="attr">path:</span>                                  <span class="string">/data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_1_1_0/</span></span><br><span class="line"><span class="attr">hash_of_all_files:</span>                     <span class="string">f4b55a88dac393d25ffe1c703cca4f6d</span></span><br><span class="line"><span class="attr">hash_of_uncompressed_files:</span>            <span class="string">58a4ab29ef36c22884ee7accd528b590</span></span><br><span class="line"><span class="attr">uncompressed_hash_of_compressed_files:</span> <span class="string">e18b006f608580db132ed90adb46902f</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Row 2:</span></span><br><span class="line"><span class="string">──────</span></span><br><span class="line"><span class="attr">partition:</span>                             <span class="number">202008</span></span><br><span class="line"><span class="attr">name:</span>                                  <span class="string">202008_1_2_1</span></span><br><span class="line"><span class="attr">part_type:</span>                             <span class="string">Wide</span></span><br><span class="line"><span class="attr">active:</span>                                <span class="number">1</span></span><br><span class="line"><span class="attr">marks:</span>                                 <span class="number">2</span></span><br><span class="line"><span class="attr">rows:</span>                                  <span class="number">5</span></span><br><span class="line"><span class="attr">bytes_on_disk:</span>                         <span class="number">421</span></span><br><span class="line"><span class="attr">data_compressed_bytes:</span>                 <span class="number">200</span></span><br><span class="line"><span class="attr">data_uncompressed_bytes:</span>               <span class="number">120</span></span><br><span class="line"><span class="attr">marks_bytes:</span>                           <span class="number">192</span></span><br><span class="line"><span class="attr">modification_time:</span>                     <span class="number">2020-08-18 17:38:24</span></span><br><span class="line"><span class="attr">remove_time:</span>                           <span class="number">0000-00-00 00:00:00</span></span><br><span class="line"><span class="attr">refcount:</span>                              <span class="number">1</span></span><br><span class="line"><span class="attr">min_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">max_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">min_time:</span>                              <span class="number">2020-08-18 00:00:00</span></span><br><span class="line"><span class="attr">max_time:</span>                              <span class="number">2020-08-22 00:00:00</span></span><br><span class="line"><span class="attr">partition_id:</span>                          <span class="number">202008</span></span><br><span class="line"><span class="attr">min_block_number:</span>                      <span class="number">1</span></span><br><span class="line"><span class="attr">max_block_number:</span>                      <span class="number">2</span></span><br><span class="line"><span class="attr">level:</span>                                 <span class="number">1</span></span><br><span class="line"><span class="attr">data_version:</span>                          <span class="number">1</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory:</span>           <span class="number">16</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory_allocated:</span> <span class="number">8192</span></span><br><span class="line"><span class="attr">is_frozen:</span>                             <span class="number">0</span></span><br><span class="line"><span class="attr">database:</span>                              <span class="string">duyalan</span></span><br><span class="line"><span class="attr">table:</span>                                 <span class="string">.inner.download_daily_mv</span></span><br><span class="line"><span class="attr">engine:</span>                                <span class="string">SummingMergeTree</span></span><br><span class="line"><span class="attr">disk_name:</span>                             <span class="string">default</span></span><br><span class="line"><span class="attr">path:</span>                                  <span class="string">/data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_1_2_1/</span></span><br><span class="line"><span class="attr">hash_of_all_files:</span>                     <span class="string">fdc534a9b9aa0904cde863ee1deff532</span></span><br><span class="line"><span class="attr">hash_of_uncompressed_files:</span>            <span class="string">58a4ab29ef36c22884ee7accd528b590</span></span><br><span class="line"><span class="attr">uncompressed_hash_of_compressed_files:</span> <span class="string">df972eeaad3304d9a16bfa8cb46861ce</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Row 3:</span></span><br><span class="line"><span class="string">──────</span></span><br><span class="line"><span class="attr">partition:</span>                             <span class="number">202008</span></span><br><span class="line"><span class="attr">name:</span>                                  <span class="string">202008_2_2_0</span></span><br><span class="line"><span class="attr">part_type:</span>                             <span class="string">Wide</span></span><br><span class="line"><span class="attr">active:</span>                                <span class="number">0</span></span><br><span class="line"><span class="attr">marks:</span>                                 <span class="number">2</span></span><br><span class="line"><span class="attr">rows:</span>                                  <span class="number">5</span></span><br><span class="line"><span class="attr">bytes_on_disk:</span>                         <span class="number">421</span></span><br><span class="line"><span class="attr">data_compressed_bytes:</span>                 <span class="number">200</span></span><br><span class="line"><span class="attr">data_uncompressed_bytes:</span>               <span class="number">120</span></span><br><span class="line"><span class="attr">marks_bytes:</span>                           <span class="number">192</span></span><br><span class="line"><span class="attr">modification_time:</span>                     <span class="number">2020-08-18 17:35:13</span></span><br><span class="line"><span class="attr">remove_time:</span>                           <span class="number">2020-08-18 17:38:24</span></span><br><span class="line"><span class="attr">refcount:</span>                              <span class="number">1</span></span><br><span class="line"><span class="attr">min_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">max_date:</span>                              <span class="number">0000-00-00</span></span><br><span class="line"><span class="attr">min_time:</span>                              <span class="number">2020-08-18 00:00:00</span></span><br><span class="line"><span class="attr">max_time:</span>                              <span class="number">2020-08-22 00:00:00</span></span><br><span class="line"><span class="attr">partition_id:</span>                          <span class="number">202008</span></span><br><span class="line"><span class="attr">min_block_number:</span>                      <span class="number">2</span></span><br><span class="line"><span class="attr">max_block_number:</span>                      <span class="number">2</span></span><br><span class="line"><span class="attr">level:</span>                                 <span class="number">0</span></span><br><span class="line"><span class="attr">data_version:</span>                          <span class="number">2</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory:</span>           <span class="number">16</span></span><br><span class="line"><span class="attr">primary_key_bytes_in_memory_allocated:</span> <span class="number">8192</span></span><br><span class="line"><span class="attr">is_frozen:</span>                             <span class="number">0</span></span><br><span class="line"><span class="attr">database:</span>                              <span class="string">duyalan</span></span><br><span class="line"><span class="attr">table:</span>                                 <span class="string">.inner.download_daily_mv</span></span><br><span class="line"><span class="attr">engine:</span>                                <span class="string">SummingMergeTree</span></span><br><span class="line"><span class="attr">disk_name:</span>                             <span class="string">default</span></span><br><span class="line"><span class="attr">path:</span>                                  <span class="string">/data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_2_2_0/</span></span><br><span class="line"><span class="attr">hash_of_all_files:</span>                     <span class="string">049d090ea65c24be8544ab86846ea9fa</span></span><br><span class="line"><span class="attr">hash_of_uncompressed_files:</span>            <span class="string">58a4ab29ef36c22884ee7accd528b590</span></span><br><span class="line"><span class="attr">uncompressed_hash_of_compressed_files:</span> <span class="string">9ffea93e6b9bc375c7f04374b4a4a6a9</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3 rows in set. Elapsed:</span> <span class="number">0.002</span> <span class="string">sec.</span> </span><br></pre></td></tr></table></figure>
<p>可以看到只有一个active分区了<code>202008_1_2_1</code></p>
<p>所以对于本例中的物化视图, 在查询是仍然应该使用聚合函数聚合数据</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    day, </span><br><span class="line">    userid, </span><br><span class="line">    sum(downloads), </span><br><span class="line">    sum(bytes)</span><br><span class="line"><span class="keyword">FROM</span> download_no_populate_daily_mv</span><br><span class="line">GROUP BY </span><br><span class="line">    day, </span><br><span class="line">    userid</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ClickHouse-Materialized-Views-Illuminated-Part-1&quot;&gt;&lt;a href=&quot;#ClickHouse-Materialized-Views-Illuminated-Part-1&quot; class=&quot;headerlink&quot; title=&quot;ClickHouse Materialized Views Illuminated, Part 1&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://altinity.com/blog/clickhouse-materialized-views-illuminated-part-1&quot;&gt;ClickHouse Materialized Views Illuminated, Part 1&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://altinity.com/wp-content/uploads/2020/02/4c9e8-stockvault-abstract-background-big-data-concept264047.jpg&quot; alt=&quot;header&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://altinity.com/blog/&quot;&gt;Altinity blog&lt;/a&gt;的读者们知道我们喜欢ClickHouse的&lt;a href=&quot;https://clickhouse.tech/docs/en/sql-reference/statements/create/view/#materialized&quot;&gt;物化视图&lt;/a&gt;. 物化视图可以实现聚合计算, 从Kafka读取数据, 实现最后点查询(last point queries)以及重组表主键索引和排序顺序. 除了这些功能之外, 物化视图可以在大量节点上很好地扩缩, 并可以处理大型数据集. 它们是ClickHouse的独特功能之一.&lt;/p&gt;
&lt;p&gt;在计算领域, 强大的功能至少意味着一点点复杂性. 这篇由两部分组成的文章通过解释物化视图的工作原理来填补空白, 从而使初学者也可以有效地使用它们. 我们将通过几个详细的示例, 您可以根据自己的使用进行调整. 在此过程中, 我们将探索用于创建视图的语法的确切含义, 并让您深入了解ClickHouse在做什么.  示例是完全自包含的, 因此您可以将它们复制/粘贴到clickhouse-client中并自己运行它们.&lt;br&gt;
    
    </summary>
    
    
      <category term="ClickHouse" scheme="http://fuxkdb.com/tags/ClickHouse/"/>
    
      <category term="物化视图" scheme="http://fuxkdb.com/tags/%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>为什么pt-osc和gh-osc在拷贝源表数据时要使用insert IGNORE into select lock in share mode</title>
    <link href="http://fuxkdb.com/2020/08/23/2020-08-23-%E4%B8%BA%E4%BB%80%E4%B9%88pt-osc%E5%92%8Cgh-osc%E5%9C%A8%E6%8B%B7%E8%B4%9D%E6%BA%90%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%97%B6%E8%A6%81%E4%BD%BF%E7%94%A8insert-IGNORE-into-select-lock-in-share-mode/"/>
    <id>http://fuxkdb.com/2020/08/23/2020-08-23-为什么pt-osc和gh-osc在拷贝源表数据时要使用insert-IGNORE-into-select-lock-in-share-mode/</id>
    <published>2020-08-23T10:58:00.000Z</published>
    <updated>2020-09-06T08:46:55.930Z</updated>
    
    <content type="html"><![CDATA[<h1 id="insert-IGNORE-into-select-lock-in-share-mode-的作用"><a href="#insert-IGNORE-into-select-lock-in-share-mode-的作用" class="headerlink" title="insert IGNORE into select lock in share mode 的作用"></a>insert IGNORE into select lock in share mode 的作用</h1><p>pt-osc和gh-osc在拷贝旧数据时逻辑是一样的, 都是用insert ignore into 影子表 select * from 原表force index (<code>PRIMARY</code>) where chunk范围 lock in share mode<br><a id="more"></a><br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pt-osc</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`sysbench`</span>.<span class="symbol">`_sbtest1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`k`</span>, <span class="symbol">`c`</span>, <span class="symbol">`pad`</span>, <span class="symbol">`snum`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`k`</span>, <span class="symbol">`c`</span>, <span class="symbol">`pad`</span>, <span class="symbol">`snum`</span> <span class="keyword">FROM</span> <span class="symbol">`sysbench`</span>.<span class="symbol">`sbtest1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= <span class="string">&#x27;98802&#x27;</span>)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= <span class="string">&#x27;98901&#x27;</span>)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 6012 copy nibble*/</span></span><br><span class="line"></span><br><span class="line">gh-ost</span><br><span class="line"><span class="keyword">insert</span> <span class="comment">/* gh-ost `sysbench`.`sbtest1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="symbol">`sysbench`</span>.<span class="symbol">`_sbtest1_gho`</span> (<span class="symbol">`id`</span>, <span class="symbol">`k`</span>, <span class="symbol">`c`</span>, <span class="symbol">`pad`</span>, <span class="symbol">`snum`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="symbol">`id`</span>, <span class="symbol">`k`</span>, <span class="symbol">`c`</span>, <span class="symbol">`pad`</span>, <span class="symbol">`snum`</span> <span class="keyword">from</span> <span class="symbol">`sysbench`</span>.<span class="symbol">`sbtest1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="symbol">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="symbol">`id`</span> &gt; _binary<span class="string">&#x27;419601&#x27;</span>)) <span class="keyword">and</span> ((<span class="symbol">`id`</span> &lt; _binary<span class="string">&#x27;419701&#x27;</span>) <span class="keyword">or</span> ((<span class="symbol">`id`</span> = _binary<span class="string">&#x27;419701&#x27;</span>)))) lock <span class="keyword">in</span> share mode</span><br></pre></td></tr></table></figure></p>
<h2 id="为什么需要lock-in-share-mode"><a href="#为什么需要lock-in-share-mode" class="headerlink" title="为什么需要lock in share mode ?"></a>为什么需要lock in share mode ?</h2><p>假设修改表t1, t1有两列 id, sname, id为主键, 数据如下</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">id</span>,sname</span><br><span class="line"><span class="number">1</span>,<span class="string">&#x27;foo&#x27;</span></span><br><span class="line"><span class="number">10</span>,<span class="string">&#x27;foo&#x27;</span></span><br><span class="line"><span class="number">20</span>,<span class="string">&#x27;foo&#x27;</span></span><br><span class="line"><span class="number">30</span>,<span class="string">&#x27;foo&#x27;</span></span><br><span class="line"><span class="number">40</span>,<span class="string">&#x27;foo&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="number">1000</span>万,<span class="string">&#x27;foo&#x27;</span></span><br></pre></td></tr></table></figure>
<p>开始改表, 需要拷贝原始数据<br>拷贝原表数据语句A: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">IGNORE</span> <span class="keyword">into</span> _t1_影子 <span class="keyword">select</span> * <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="keyword">id</span>&gt;<span class="number">1</span> <span class="keyword">and</span> <span class="keyword">id</span>&lt;<span class="number">100</span>万;</span><br></pre></td></tr></table></figure>
<p>我们这个insert正在执行,且执行的很慢, 总是就是放大它的执行时间.  此时另一个会话执行下面的语句B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">11</span>,<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> sname=<span class="string">&#x27;hehe&#x27;</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">30</span>;</span><br></pre></td></tr></table></figure>
<h2 id="如果是pt-osc-走触发器-这些语句会应用到影子表"><a href="#如果是pt-osc-走触发器-这些语句会应用到影子表" class="headerlink" title="如果是pt-osc ,走触发器, 这些语句会应用到影子表"></a>如果是pt-osc ,走触发器, 这些语句会应用到影子表</h2><blockquote>
<p>pt-osc 三个触发器</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest1_del` AFTER DELETE ON `sysbench`.`sbtest1` FOR EACH ROW DELETE IGNORE FROM `sysbench`.`_sbtest1_new` WHERE `sysbench`.`_sbtest1_new`.`id` &lt;=&gt; OLD.`id`</span><br><span class="line"></span><br><span class="line">&gt;CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest1_upd` AFTER UPDATE ON `sysbench`.`sbtest1` FOR EACH ROW BEGIN DELETE IGNORE FROM `sysbench`.`_sbtest1_new` WHERE !(OLD.`id` &lt;=&gt; <span class="keyword">NEW</span>.`id`) <span class="literal">AND</span> `sysbench`.`_sbtest1_new`.`id` &lt;=&gt; OLD.`id`;REPLACE INTO `sysbench`.`_sbtest1_new` (`id`, `k`, `c`, `pad`, `snum`) VALUES (<span class="keyword">NEW</span>.`id`, <span class="keyword">NEW</span>.`k`, <span class="keyword">NEW</span>.`c`, <span class="keyword">NEW</span>.`pad`, <span class="keyword">NEW</span>.`snum`)<span class="comment">;END</span></span><br><span class="line"></span><br><span class="line">&gt;CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest1_del` AFTER DELETE ON `sysbench`.`sbtest1` FOR EACH ROW DELETE IGNORE FROM `sysbench`.`_sbtest1_new` WHERE `sysbench`.`_sbtest1_new`.`id` &lt;=&gt; OLD.`id`</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REPLACE</span> <span class="keyword">INTO</span> _t1_影子 <span class="keyword">values</span>(<span class="number">11</span>,<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"><span class="keyword">REPLACE</span> <span class="keyword">INTO</span> _t1_影子 <span class="keyword">values</span>(<span class="number">20</span>,<span class="string">&#x27;hehe&#x27;</span>); (如果更新了主键值, 则会<span class="keyword">delete</span> <span class="keyword">where</span> <span class="keyword">id</span>=原主键值, <span class="keyword">replace</span> <span class="keyword">into</span> 新主键值)</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">IGNORE</span> <span class="keyword">FROM</span> _t1_影子 <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">30</span>;</span><br></pre></td></tr></table></figure>
<p>此时影子表会有如下数据</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>,&#x27;foo&#x27;</span><br><span class="line"><span class="number">20</span>,&#x27;hehe&#x27;</span><br></pre></td></tr></table></figure>
<p>之后拷贝原表数据语句A执行完毕, 影子表数据如下</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line"><span class="number">10</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line"><span class="number">11</span>,<span class="symbol">&#x27;foo</span>&#x27; <span class="comment">--</span></span><br><span class="line"><span class="number">20</span>,<span class="symbol">&#x27;hehe</span>&#x27; <span class="comment">--</span></span><br><span class="line"><span class="number">30</span>,<span class="symbol">&#x27;foo</span>&#x27; <span class="comment">--30又回来了</span></span><br><span class="line"><span class="number">40</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line">...</span><br><span class="line"><span class="number">100</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br></pre></td></tr></table></figure>
<p>被删除的id=30又会被插入进来</p>
<p>所以数据就出现了问题, 所以需要insert IGNORE into select lock in share mode, 这样语句B就会被阻塞</p>
<p><del>这也是为什么pt-osc对update不能像gh-ost一样使用update, 而是需要replace into</del><br>数据还是有问题，所以需要lock in share mode</p>
<h2 id="如果是gh-ost-走binlog-gh-ost解析binlog应用到影子表"><a href="#如果是gh-ost-走binlog-gh-ost解析binlog应用到影子表" class="headerlink" title="如果是gh-ost, 走binlog, gh-ost解析binlog应用到影子表"></a>如果是gh-ost, 走binlog, gh-ost解析binlog应用到影子表</h2><blockquote>
<p><a href="https://github.com/github/gh-ost/blob/e48844de0bee9a8db611a06cd6080cac4dab25cb/go/sql/builder.go">https://github.com/github/gh-ost/blob/e48844de0bee9a8db611a06cd6080cac4dab25cb/go/sql/builder.go</a><br>insert就是replace into<br>update还是update (如果更新了主键值, 则会delete where id=原主键值, replace into 新主键值)<br>delete还是delete</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REPLACE</span> <span class="keyword">INTO</span> _t1_影子 <span class="keyword">values</span>(<span class="number">11</span>,<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"><span class="keyword">update</span> _t1_影子 <span class="keyword">set</span> sname=<span class="string">&#x27;hehe&#x27;</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">20</span>; <span class="comment">--更新不到</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> _t1_影子 <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">30</span>; <span class="comment">--删除不到</span></span><br></pre></td></tr></table></figure>
<p>此时影子表会有如下数据</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>,&#x27;foo&#x27;</span><br></pre></td></tr></table></figure>
<p>之后拷贝原表数据语句A执行完毕, 影子表数据如下</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line"><span class="number">10</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line"><span class="number">11</span>, <span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line"><span class="number">20</span>,<span class="symbol">&#x27;foo</span>&#x27; <span class="comment">--更新丢了</span></span><br><span class="line"><span class="number">30</span>,<span class="symbol">&#x27;foo</span>&#x27; <span class="comment">--删除也丢了</span></span><br><span class="line"><span class="number">40</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br><span class="line">...</span><br><span class="line"><span class="number">100</span>,<span class="symbol">&#x27;foo</span>&#x27;</span><br></pre></td></tr></table></figure>
<p>数据还是有问题, 所以需要lock in share mode</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;insert-IGNORE-into-select-lock-in-share-mode-的作用&quot;&gt;&lt;a href=&quot;#insert-IGNORE-into-select-lock-in-share-mode-的作用&quot; class=&quot;headerlink&quot; title=&quot;insert IGNORE into select lock in share mode 的作用&quot;&gt;&lt;/a&gt;insert IGNORE into select lock in share mode 的作用&lt;/h1&gt;&lt;p&gt;pt-osc和gh-osc在拷贝旧数据时逻辑是一样的, 都是用insert ignore into 影子表 select * from 原表force index (&lt;code&gt;PRIMARY&lt;/code&gt;) where chunk范围 lock in share mode&lt;br&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="gh-ost" scheme="http://fuxkdb.com/tags/gh-ost/"/>
    
      <category term="pt-osc" scheme="http://fuxkdb.com/tags/pt-osc/"/>
    
  </entry>
  
  <entry>
    <title>ProxySQL升级时对默认部署的实例的影响</title>
    <link href="http://fuxkdb.com/2020/08/23/2020-08-23-ProxySQL%E5%8D%87%E7%BA%A7%E6%97%B6%E5%AF%B9%E9%BB%98%E8%AE%A4%E9%83%A8%E7%BD%B2%E7%9A%84%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%BD%B1%E5%93%8D/"/>
    <id>http://fuxkdb.com/2020/08/23/2020-08-23-ProxySQL升级时对默认部署的实例的影响/</id>
    <published>2020-08-23T10:54:00.000Z</published>
    <updated>2020-08-23T10:55:07.570Z</updated>
    
    <content type="html"><![CDATA[<p>公司有使用默认安装目录的ProxySQL跑业务. 在升级2.0.8 至 2.0.12的时候发现卸载2.0.8后这些使用默认方式安装的ProxySQL实例就会被关闭.</p>
<p>原因是rpm包安装和卸载前后执行了一些动作</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@bj1-mysql-manager-prod-<span class="number">0</span>1 tmp]<span class="comment"># rpm --scripts -qp  /tmp/proxysql-2.0.8-1-centos7.x86_64.rpm </span></span><br><span class="line">preinstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># Cleanup artifacts</span></span><br><span class="line"><span class="keyword">if</span> [ -f /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span> ];</span> <span class="keyword">then</span> </span><br><span class="line">    rm -fr /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span></span></span><br><span class="line">fi</span><br><span class="line">postinstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># Create relevant user, directories and configuration files</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/run/proxysql ]; <span class="keyword">then</span> /bin/mkdir /var/run/proxysql ; fi</span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> ];</span> <span class="keyword">then</span> /bin/mkdir /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> ;</span> fi</span><br><span class="line"><span class="keyword">if</span> ! id -u proxysql &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>; <span class="keyword">then</span> useradd -r -U -s /bin/<span class="literal">false</span> -d /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> -<span class="title">c</span> &quot;<span class="title">ProxySQL</span> <span class="title">Server</span>&quot; <span class="title">proxysql</span>;</span> fi</span><br><span class="line">/bin/chown -R <span class="symbol">proxysql:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> /<span class="title">var</span>/<span class="title">run</span>/<span class="title">proxysql</span></span></span><br><span class="line">/bin/chown <span class="symbol">root:</span>proxysql /etc/proxysql.cnf</span><br><span class="line">/bin/chmod <span class="number">640</span> /etc/proxysql.cnf</span><br><span class="line"><span class="comment"># Configure systemd appropriately.</span></span><br><span class="line">/bin/systemctl daemon-reload</span><br><span class="line">/bin/systemctl enable proxysql.service</span><br><span class="line"><span class="comment"># Notify that a package update is in progress in order to start service.</span></span><br><span class="line"><span class="keyword">if</span> [ $<span class="number">1</span> -eq <span class="number">2</span> ]; <span class="keyword">then</span> /bin/touch /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span> ;</span> fi</span><br><span class="line">preuninstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># When uninstalling always try stop the service, ignore failures</span></span><br><span class="line">/bin/systemctl stop proxysql || <span class="literal">true</span></span><br><span class="line">postuninstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="keyword">if</span> [ $<span class="number">1</span> -eq <span class="number">0</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># This is a pure uninstall, systemd unit file removed</span></span><br><span class="line">    <span class="comment"># only daemon-reload is needed.</span></span><br><span class="line">    /bin/systemctl daemon-reload</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># This is an upgrade, ProxySQL should be started. This</span></span><br><span class="line">    <span class="comment"># logic works for packages newer than 2.0.7 and ensures</span></span><br><span class="line">    <span class="comment"># a faster restart time.</span></span><br><span class="line">    /bin/systemctl start proxysql.service</span><br><span class="line">    /bin/rm -fr /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span></span></span><br><span class="line">fi</span><br><span class="line">posttrans scriptlet (using /bin/sh):</span><br><span class="line"><span class="keyword">if</span> [ -f /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span> ];</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># This is a safeguard to start the service after an update</span></span><br><span class="line">    <span class="comment"># which supports legacy &quot;preun&quot; / &quot;postun&quot; logic and will</span></span><br><span class="line">    <span class="comment"># only execute for packages before 2.0.7.</span></span><br><span class="line">    /bin/systemctl start proxysql.service</span><br><span class="line">    /bin/rm -fr /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span></span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>preinstall</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ -f /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span> ];</span> <span class="keyword">then</span> </span><br><span class="line">    rm -fr /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span></span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>这就是看如果有<code>PROXYSQL_UPGRADE</code>这个文件就删除掉,这个文件主要是rpm -Uvh升级时会用到</p>
<p>postinstall</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create relevant user, directories and configuration files</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/run/proxysql ]; <span class="keyword">then</span> /bin/mkdir /var/run/proxysql ; fi</span><br><span class="line"><span class="keyword">if</span> [ ! -d /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> ];</span> <span class="keyword">then</span> /bin/mkdir /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> ;</span> fi</span><br><span class="line"><span class="keyword">if</span> ! id -u proxysql &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>; <span class="keyword">then</span> useradd -r -U -s /bin/<span class="literal">false</span> -d /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> -<span class="title">c</span> &quot;<span class="title">ProxySQL</span> <span class="title">Server</span>&quot; <span class="title">proxysql</span>;</span> fi</span><br><span class="line">/bin/chown -R <span class="symbol">proxysql:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span> /<span class="title">var</span>/<span class="title">run</span>/<span class="title">proxysql</span></span></span><br><span class="line">/bin/chown <span class="symbol">root:</span>proxysql /etc/proxysql.cnf</span><br><span class="line">/bin/chmod <span class="number">640</span> /etc/proxysql.cnf</span><br><span class="line"><span class="comment"># Configure systemd appropriately.</span></span><br><span class="line">/bin/systemctl daemon-reload</span><br><span class="line">/bin/systemctl enable proxysql.service</span><br><span class="line"><span class="comment"># Notify that a package update is in progress in order to start service.</span></span><br><span class="line"><span class="keyword">if</span> [ $<span class="number">1</span> -eq <span class="number">2</span> ]; <span class="keyword">then</span> /bin/touch /var/<span class="class"><span class="keyword">lib</span>/<span class="title">proxysql</span>/<span class="title">PROXYSQL_UPGRADE</span> ;</span> fi</span><br></pre></td></tr></table></figure>
<p>创建目录, 创建用户, 设置开机启动proxysql.service. </p>
<p>这里主要就是一点, 用systemd管理rpm包安装的proxysql</p>
<h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><p>preuninstall</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># When uninstalling always <span class="keyword">try</span> <span class="built_in">stop</span> the service, ignore failures</span><br><span class="line">/bin/systemctl <span class="built_in">stop</span> proxysql || <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>这里就是把rpm包安装的proxysql实例给关了. 所有如果用默认方式安装的ProxySQL实例, 卸载rpm包的时候这个实例就会被关闭, 所以不建议用这个实例, 应该自己创建, 并且建议把rpm包生成的配置文件, systemd都mv改名, 否则机器重启默认实例启动会占用6032,6033端口</strong></p>
<p>preuninstall</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">preuninstall scriptlet (using <span class="regexp">/bin/</span>sh):</span><br><span class="line"></span><br><span class="line">postuninstall scriptlet (using <span class="regexp">/bin/</span>sh):</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> -eq <span class="number">0</span> ]; then</span><br><span class="line">    <span class="comment"># This is a pure uninstall, systemd unit file removed</span></span><br><span class="line">    <span class="comment"># only daemon-reload is needed.</span></span><br><span class="line">    <span class="regexp">/bin/</span>systemctl daemon-reload</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># This is an upgrade, ProxySQL should be started. This</span></span><br><span class="line">    <span class="comment"># logic works for packages newer than 2.0.7 and ensures</span></span><br><span class="line">    <span class="comment"># a faster restart time.</span></span><br><span class="line">    <span class="regexp">/bin/</span>systemctl start proxysql.service</span><br><span class="line">    <span class="regexp">/bin/</span>rm -fr <span class="regexp">/var/</span>lib<span class="regexp">/proxysql/</span>PROXYSQL_UPGRADE</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><del>这里<code>$1</code>我不知道咋取的</del>, 总之就是如果是写在就删了proxysql.service文件后<code>systemctl daemon-reload</code></p>
<blockquote>
<p>另外，为提供操作中可参考的信息，rpm还提供了一种信号机制：不同的操作会返回不同的信息，并放到默认变量$1中。</p>
<p>0代表卸载、1代表安装、2代表升级</p>
</blockquote>
<p>如果是升级则会再启动</p>
<h2 id="可以使用rpm-Uvh升级吗"><a href="#可以使用rpm-Uvh升级吗" class="headerlink" title="可以使用rpm -Uvh升级吗?"></a>可以使用rpm -Uvh升级吗?</h2><p>ansible yum可以完成升级工作, 但不要使用ansible yum升级, 使用此方式升级2.0.8 - 2.0.12会自动安装并启动一个proxysql<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxysql <span class="number">125223</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">21</span>:<span class="number">17</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/bin/proxysql --idle-threads -c /etc/proxysql.cnf</span><br><span class="line">proxysql <span class="number">125225</span> <span class="number">125223</span>  <span class="number">0</span> <span class="number">21</span>:<span class="number">17</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /usr/bin/proxysql --idle-threads -c /etc/proxysql.cnf</span><br></pre></td></tr></table></figure></p>
<p>这个proxysql会占用6032 和 6033 端口. 这种方式实际上应该是使用rpm -Uvh完成的升级, 我手动使用rpm -Uvh升级效果和ansible yum是一致的</p>
<p>应该通过shell rpm -e 2.0.8 再rpm -ivh 2.0.12进行升级, 这种方式不影响(影响rpm默认安装的proxysql实例,因为会关闭)已经运行的proxysql进程 (文件句柄没有释放)<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>centos<span class="number">-1</span> data]# lsof | grep delete| grep proxysql</span><br><span class="line">proxysql  <span class="number">118312</span>                  root  txt       REG              <span class="number">253</span>,<span class="number">0</span>   <span class="number">36156384</span>  <span class="number">101426928</span> /usr/bin/proxysql (deleted)</span><br><span class="line">proxysql  <span class="number">118313</span>                  root  txt       REG              <span class="number">253</span>,<span class="number">0</span>   <span class="number">36156384</span>  <span class="number">101426928</span> /usr/bin/proxysql (deleted)</span><br><span class="line">proxysql  <span class="number">118313</span> <span class="number">118315</span>           root  txt       REG              <span class="number">253</span>,<span class="number">0</span>   <span class="number">36156384</span>  <span class="number">101426928</span> /usr/bin/proxysql (deleted)</span><br><span class="line">proxysql  <span class="number">118313</span> <span class="number">118316</span>           root  txt       REG              <span class="number">253</span>,<span class="number">0</span>   <span class="number">36156384</span>  <span class="number">101426928</span> /usr/bin/proxysql (deleted)</span><br><span class="line">proxysql  <span class="number">118313</span> <span class="number">118317</span>           root  txt       REG              <span class="number">253</span>,<span class="number">0</span>   <span class="number">36156384</span>  <span class="number">101426928</span> /usr/bin/proxysql (deleted)</span><br><span class="line">proxysql  <span class="number">118313</span> <span class="number">118318</span>           root  txt       REG              <span class="number">253</span>,<span class="number">0</span>   <span class="number">36156384</span>  <span class="number">101426928</span> /usr/bin/proxysql (deleted)</span><br></pre></td></tr></table></figure><br>另外升级后请<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv <span class="regexp">/etc/</span>proxysql.cnf <span class="regexp">/etc/</span>proxysql.cnf.bak</span><br><span class="line">mv <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>proxysql.service <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>proxysql.service.bak</span><br><span class="line">mv <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>proxysql-initial.service <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>proxysql-initial.service.bak</span><br></pre></td></tr></table></figure><br>目前上海的proxysql我都是采用这种方式升级</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>检查是否有rpm默认安装的proxysql实例, 如果有, 请先升级这个proxysql实例!</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;公司有使用默认安装目录的ProxySQL跑业务. 在升级2.0.8 至 2.0.12的时候发现卸载2.0.8后这些使用默认方式安装的ProxySQL实例就会被关闭.&lt;/p&gt;
&lt;p&gt;原因是rpm包安装和卸载前后执行了一些动作&lt;/p&gt;
&lt;figure class=&quot;highlight crystal&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@bj1-mysql-manager-prod-&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;1 tmp]&lt;span class=&quot;comment&quot;&gt;# rpm --scripts -qp  /tmp/proxysql-2.0.8-1-centos7.x86_64.rpm &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;preinstall scriptlet (using /bin/sh):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Cleanup artifacts&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ -f /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;PROXYSQL_UPGRADE&lt;/span&gt; ];&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    rm -fr /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;PROXYSQL_UPGRADE&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;postinstall scriptlet (using /bin/sh):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Create relevant user, directories and configuration files&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ ! -d /var/run/proxysql ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; /bin/mkdir /var/run/proxysql ; fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ ! -d /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt; ];&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; /bin/mkdir /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt; ;&lt;/span&gt; fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ! id -u proxysql &amp;gt; &lt;span class=&quot;regexp&quot;&gt;/dev/null&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&amp;gt;&amp;amp;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; useradd -r -U -s /bin/&lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt; -d /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt; -&lt;span class=&quot;title&quot;&gt;c&lt;/span&gt; &amp;quot;&lt;span class=&quot;title&quot;&gt;ProxySQL&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Server&lt;/span&gt;&amp;quot; &lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;;&lt;/span&gt; fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/chown -R &lt;span class=&quot;symbol&quot;&gt;proxysql:&lt;/span&gt; /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt; /&lt;span class=&quot;title&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/chown &lt;span class=&quot;symbol&quot;&gt;root:&lt;/span&gt;proxysql /etc/proxysql.cnf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/chmod &lt;span class=&quot;number&quot;&gt;640&lt;/span&gt; /etc/proxysql.cnf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Configure systemd appropriately.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/systemctl daemon-reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/systemctl enable proxysql.service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Notify that a package update is in progress in order to start service.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ $&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; -eq &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt; /bin/touch /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;PROXYSQL_UPGRADE&lt;/span&gt; ;&lt;/span&gt; fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;preuninstall scriptlet (using /bin/sh):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# When uninstalling always try stop the service, ignore failures&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/bin/systemctl stop proxysql || &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;postuninstall scriptlet (using /bin/sh):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ $&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; -eq &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; ]; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# This is a pure uninstall, systemd unit file removed&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# only daemon-reload is needed.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /bin/systemctl daemon-reload&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# This is an upgrade, ProxySQL should be started. This&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# logic works for packages newer than 2.0.7 and ensures&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# a faster restart time.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /bin/systemctl start proxysql.service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /bin/rm -fr /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;PROXYSQL_UPGRADE&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;posttrans scriptlet (using /bin/sh):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; [ -f /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;PROXYSQL_UPGRADE&lt;/span&gt; ];&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# This is a safeguard to start the service after an update&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# which supports legacy &amp;quot;preun&amp;quot; / &amp;quot;postun&amp;quot; logic and will&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# only execute for packages before 2.0.7.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /bin/systemctl start proxysql.service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    /bin/rm -fr /var/&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;lib&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;proxysql&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;PROXYSQL_UPGRADE&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="ProxySQL" scheme="http://fuxkdb.com/tags/ProxySQL/"/>
    
      <category term="升级" scheme="http://fuxkdb.com/tags/%E5%8D%87%E7%BA%A7/"/>
    
  </entry>
  
  <entry>
    <title>MySQL动态行转列</title>
    <link href="http://fuxkdb.com/2020/08/23/2020-08-23-MySQL%E5%8A%A8%E6%80%81%E8%A1%8C%E8%BD%AC%E5%88%97/"/>
    <id>http://fuxkdb.com/2020/08/23/2020-08-23-MySQL动态行转列/</id>
    <published>2020-08-23T10:51:00.000Z</published>
    <updated>2020-08-23T10:51:27.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="通过max行转列不是动态的-你还是要知道所有列名才可以"><a href="#通过max行转列不是动态的-你还是要知道所有列名才可以" class="headerlink" title="通过max行转列不是动态的, 你还是要知道所有列名才可以"></a>通过max行转列不是动态的, 你还是要知道所有列名才可以</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@localhost</span> 17:46:56 [fanboshi]&gt; select <span class="symbol">*</span> from t3;</span><br><span class="line">+----+---------+------+-----------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> title   </span>|<span class="string"> env  </span>|<span class="string"> progress  </span>|</span><br><span class="line">+----+---------+------+-----------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 工单1   </span>|<span class="string">    1 </span>|<span class="string"> 完成      </span>|</span><br><span class="line">|<span class="string">  2 </span>|<span class="string"> 工单1   </span>|<span class="string">    2 </span>|<span class="string"> 完成      </span>|</span><br><span class="line">|<span class="string">  3 </span>|<span class="string"> 工单1   </span>|<span class="string">    3 </span>|<span class="string"> 待审核    </span>|</span><br><span class="line">|<span class="string">  4 </span>|<span class="string"> 工单2   </span>|<span class="string">    1 </span>|<span class="string"> 待审核    </span>|</span><br><span class="line">+----+---------+------+-----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root<span class="meta">@localhost</span> 17:48:20 [fanboshi]&gt; select title,max(if(env=1,progress,-1)) &#x27;RC&#x27;,max(if(env=2,progress,-1)) &#x27;Stage&#x27;,max(if(env=3,progress,-1)) &#x27;Prod&#x27; from t3 group by title;</span><br><span class="line">+---------+-----------+--------+-----------+</span><br><span class="line">|<span class="string"> title   </span>|<span class="string"> RC        </span>|<span class="string"> Stage  </span>|<span class="string"> Prod      </span>|</span><br><span class="line">+---------+-----------+--------+-----------+</span><br><span class="line">|<span class="string"> 工单1   </span>|<span class="string"> 完成      </span>|<span class="string"> 完成   </span>|<span class="string"> 待审核    </span>|</span><br><span class="line">|<span class="string"> 工单2   </span>|<span class="string"> 待审核    </span>|<span class="string"> -1     </span>|<span class="string"> -1        </span>|</span><br><span class="line">+---------+-----------+--------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="oracle有pivot函数可以解决这个问题-MySQL并没有这样的函数-一种退而求其次的办法是使用JSON-OBJECTAGG"><a href="#oracle有pivot函数可以解决这个问题-MySQL并没有这样的函数-一种退而求其次的办法是使用JSON-OBJECTAGG" class="headerlink" title="oracle有pivot函数可以解决这个问题,MySQL并没有这样的函数, 一种退而求其次的办法是使用JSON_OBJECTAGG"></a>oracle有pivot函数可以解决这个问题,MySQL并没有这样的函数, 一种退而求其次的办法是使用JSON_OBJECTAGG</h2><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; select title,JSON<span class="emphasis">_OBJECTAGG(env,progress) val from t3 group by title;</span></span><br><span class="line"><span class="emphasis">+---------+--------------------------------------------------+</span></span><br><span class="line"><span class="emphasis">| title   | val                                              |</span></span><br><span class="line"><span class="emphasis">+---------+--------------------------------------------------+</span></span><br><span class="line"><span class="emphasis">| 工单1   | &#123;&quot;1&quot;: &quot;完成&quot;, &quot;2&quot;: &quot;完成&quot;, &quot;3&quot;: &quot;待审核&quot;&#125;        |</span></span><br><span class="line"><span class="emphasis">| 工单2   | &#123;&quot;1&quot;: &quot;待审核&quot;&#125;                                  |</span></span><br><span class="line"><span class="emphasis">+---------+--------------------------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>然后再程序循环val中的key,value自己做处理</p>
<h2 id="使用prepare-statement可以实现-本例需要构造一个env值与env名字的对应表"><a href="#使用prepare-statement可以实现-本例需要构造一个env值与env名字的对应表" class="headerlink" title="使用prepare statement可以实现, 本例需要构造一个env值与env名字的对应表"></a>使用prepare statement可以实现, 本例需要构造一个env值与env名字的对应表</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@localhost</span> 17:42:07 [fanboshi]&gt; select <span class="symbol">*</span> from t_env;</span><br><span class="line">+----+--------+----------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> env_id </span>|<span class="string"> env_name </span>|</span><br><span class="line">+----+--------+----------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string">      1 </span>|<span class="string"> RC       </span>|</span><br><span class="line">|<span class="string">  2 </span>|<span class="string">      2 </span>|<span class="string"> Stage    </span>|</span><br><span class="line">|<span class="string">  3 </span>|<span class="string">      3 </span>|<span class="string"> Prod     </span>|</span><br><span class="line">+----+--------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  GROUP_CONCAT(<span class="keyword">DISTINCT</span></span><br><span class="line">    CONCAT(</span><br><span class="line">      <span class="string">&#x27;MAX(IF(pa.env = &#x27;&#x27;&#x27;</span>,</span><br><span class="line">      env,</span><br><span class="line">      <span class="string">&#x27;&#x27;&#x27;, pa.progress, -1)) AS &#x27;</span>,</span><br><span class="line">      &quot;&#x27;&quot;,e.env_name,&quot;&#x27;&quot;</span><br><span class="line">    )</span><br><span class="line">  ) <span class="keyword">INTO</span> @<span class="keyword">sql</span></span><br><span class="line"><span class="keyword">FROM</span> t3,(<span class="keyword">select</span> @<span class="keyword">sql</span>:= <span class="keyword">NULL</span>) tmp, t_env e <span class="keyword">where</span> env = e.env_id;</span><br><span class="line"></span><br><span class="line">root@localhost <span class="number">17</span>:<span class="number">44</span>:<span class="number">40</span> [fanboshi]&gt; <span class="keyword">select</span> @<span class="keyword">sql</span>;</span><br><span class="line">+<span class="comment">---------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| @<span class="keyword">sql</span>                                                                                                                                                    |</span><br><span class="line">+<span class="comment">---------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| MAX(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;1&#x27;</span>, pa.progress, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> <span class="string">&#x27;RC&#x27;</span>,MAX(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;2&#x27;</span>, pa.progress, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Stage&#x27;</span>,MAX(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;3&#x27;</span>, pa.progress, <span class="keyword">NULL</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Prod&#x27;</span> |</span><br><span class="line">+<span class="comment">---------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @<span class="keyword">sql</span>:=CONCAT(<span class="string">&#x27;SELECT pa.title</span></span><br><span class="line"><span class="string">                    , &#x27;</span>, @<span class="keyword">sql</span>, <span class="string">&#x27; </span></span><br><span class="line"><span class="string">                   FROM t3 pa</span></span><br><span class="line"><span class="string">                   GROUP BY pa.title&#x27;</span>);</span><br><span class="line">                   </span><br><span class="line">+<span class="comment">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| @<span class="keyword">sql</span>:=CONCAT(<span class="string">&#x27;SELECT pa.title</span></span><br><span class="line"><span class="string">                    , &#x27;</span>, @<span class="keyword">sql</span>, <span class="string">&#x27; </span></span><br><span class="line"><span class="string">                   FROM t3 pa</span></span><br><span class="line"><span class="string">                   GROUP BY pa.title&#x27;</span>)                                                                                                                        |</span><br><span class="line">+<span class="comment">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| <span class="keyword">SELECT</span> pa.title</span><br><span class="line">                    , MAX(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;1&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;RC&#x27;</span>,MAX(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;2&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Stage&#x27;</span>,MAX(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;3&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Prod&#x27;</span> </span><br><span class="line">                   <span class="keyword">FROM</span> t3 pa</span><br><span class="line">                   <span class="keyword">GROUP</span> <span class="keyword">BY</span> pa.title |</span><br><span class="line">+<span class="comment">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">其实这里已经把拼接好的<span class="keyword">sql</span>查出来了, 程序直接拿着个结果去执行应该也是可以的, 可能不用后面在使用<span class="keyword">prepare</span> <span class="keyword">statement</span>了</span><br><span class="line"></span><br><span class="line"><span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> @<span class="keyword">sql</span>;</span><br><span class="line"><span class="keyword">EXECUTE</span> stmt;</span><br><span class="line">+<span class="comment">---------+-----------+--------+-----------+</span></span><br><span class="line">| title   | RC        | Stage  | Prod      |</span><br><span class="line">+<span class="comment">---------+-----------+--------+-----------+</span></span><br><span class="line">| 工单<span class="number">1</span>   | 完成      | 完成   | 待审核    |</span><br><span class="line">| 工单<span class="number">2</span>   | 待审核    | <span class="number">-1</span>     | <span class="number">-1</span>        |</span><br><span class="line">+<span class="comment">---------+-----------+--------+-----------+</span></span><br><span class="line"><span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> stmt;</span><br></pre></td></tr></table></figure>
<h2 id="那么基于上面的思路-我寻思还用得着prepare-statement吗-直接拼个sql不就完事了吗-用SQL造SQL"><a href="#那么基于上面的思路-我寻思还用得着prepare-statement吗-直接拼个sql不就完事了吗-用SQL造SQL" class="headerlink" title="那么基于上面的思路, 我寻思还用得着prepare statement吗, 直接拼个sql不就完事了吗, 用SQL造SQL"></a>那么基于上面的思路, 我寻思还用得着prepare statement吗, 直接拼个sql不就完事了吗, 用SQL造SQL</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">CONCAT</span>(<span class="string">&#x27;SELECT pa.title, &#x27;</span>,</span><br><span class="line">            <span class="keyword">GROUP_CONCAT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CONCAT</span>(<span class="string">&#x27;MAX(IF(pa.env = \&#x27;&#x27;,</span></span><br><span class="line"><span class="string">                        env,</span></span><br><span class="line"><span class="string">                        &#x27;</span>\<span class="string">&#x27;, pa.progress, -1)) AS &#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;\&#x27;&#x27;,</span></span><br><span class="line"><span class="string">                        e.env_name,</span></span><br><span class="line"><span class="string">                        &#x27;</span>\<span class="string">&#x27;&#x27;</span>)),</span><br><span class="line">            <span class="string">&#x27; FROM t3 pa group by pa.title&#x27;</span>) final_sql</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    t3,</span><br><span class="line">    t_env e</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    env = e.env_id;</span><br><span class="line"></span><br><span class="line">+<span class="comment">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| final_sql                                                                                                                                                                                       |</span><br><span class="line">+<span class="comment">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| <span class="keyword">SELECT</span> pa.title, <span class="keyword">MAX</span>(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;1&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;RC&#x27;</span>,<span class="keyword">MAX</span>(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;2&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Stage&#x27;</span>,<span class="keyword">MAX</span>(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;3&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Prod&#x27;</span> <span class="keyword">FROM</span> t3 pa <span class="keyword">group</span> <span class="keyword">by</span> pa.title |</span><br><span class="line">+<span class="comment">-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">SELECT</span> pa.title, <span class="keyword">MAX</span>(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;1&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;RC&#x27;</span>,<span class="keyword">MAX</span>(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;2&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Stage&#x27;</span>,<span class="keyword">MAX</span>(<span class="keyword">IF</span>(pa.env = <span class="string">&#x27;3&#x27;</span>, pa.progress, <span class="number">-1</span>)) <span class="keyword">AS</span> <span class="string">&#x27;Prod&#x27;</span> <span class="keyword">FROM</span> t3 pa <span class="keyword">group</span> <span class="keyword">by</span> pa.title;</span><br><span class="line">+<span class="comment">---------+-----------+--------+-----------+</span></span><br><span class="line">| title   | RC        | Stage  | Prod      |</span><br><span class="line">+<span class="comment">---------+-----------+--------+-----------+</span></span><br><span class="line">| 工单1   | 完成      | 完成   | 待审核    |</span><br><span class="line">| 工单2   | 待审核    | -1     | -1        |</span><br><span class="line">+<span class="comment">---------+-----------+--------+-----------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><p><a href="https://stackoverflow.com/questions/12598120/mysql-pivot-table-query-with-dynamic-columns">https://stackoverflow.com/questions/12598120/mysql-pivot-table-query-with-dynamic-columns</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;通过max行转列不是动态的-你还是要知道所有列名才可以&quot;&gt;&lt;a href=&quot;#通过max行转列不是动态的-你还是要知道所有列名才可以&quot; class=&quot;headerlink&quot; title=&quot;通过max行转列不是动态的, 你还是要知道所有列名才可以&quot;&gt;&lt;/a&gt;通过max行转列不是动态的, 你还是要知道所有列名才可以&lt;/h2&gt;&lt;figure class=&quot;highlight gherkin&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root&lt;span class=&quot;meta&quot;&gt;@localhost&lt;/span&gt; 17:46:56 [fanboshi]&amp;gt; select &lt;span class=&quot;symbol&quot;&gt;*&lt;/span&gt; from t3;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+----+---------+------+-----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt; id &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; title   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; env  &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; progress  &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+----+---------+------+-----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt;  1 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 工单1   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt;    1 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 完成      &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt;  2 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 工单1   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt;    2 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 完成      &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt;  3 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 工单1   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt;    3 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 待审核    &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt;  4 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 工单2   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt;    1 &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 待审核    &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+----+---------+------+-----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4 rows in set (0.00 sec)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root&lt;span class=&quot;meta&quot;&gt;@localhost&lt;/span&gt; 17:48:20 [fanboshi]&amp;gt; select title,max(if(env=1,progress,-1)) &amp;#x27;RC&amp;#x27;,max(if(env=2,progress,-1)) &amp;#x27;Stage&amp;#x27;,max(if(env=3,progress,-1)) &amp;#x27;Prod&amp;#x27; from t3 group by title;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------+-----------+--------+-----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt; title   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; RC        &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; Stage  &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; Prod      &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------+-----------+--------+-----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt; 工单1   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 完成      &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 完成   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 待审核    &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|&lt;span class=&quot;string&quot;&gt; 工单2   &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; 待审核    &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; -1     &lt;/span&gt;|&lt;span class=&quot;string&quot;&gt; -1        &lt;/span&gt;|&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------+-----------+--------+-----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2 rows in set (0.00 sec)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>死锁案例2 两个UPDATE死锁</title>
    <link href="http://fuxkdb.com/2020/08/23/2020-08-23-%E6%AD%BB%E9%94%81%E6%A1%88%E4%BE%8B2-%E4%B8%A4%E4%B8%AAUPDATE%E6%AD%BB%E9%94%81/"/>
    <id>http://fuxkdb.com/2020/08/23/2020-08-23-死锁案例2-两个UPDATE死锁/</id>
    <published>2020-08-23T10:44:00.000Z</published>
    <updated>2020-08-23T10:45:15.485Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>2020.05.18 16:12 收到报警</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/image-20200519140217826.png" alt=""></p>
<p>登录主机, 查看error log( 开启了innodb_print_all_deadlocks参数)</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">1261729280</span>, ACTIVE <span class="number">0</span> sec starting index read</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">3</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">2</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">3645828</span>, OS thread handle <span class="number">139681739994880</span>, query id <span class="number">1522438991</span> <span class="number">172.16</span><span class="number">.23</span><span class="number">.82</span> yos_rw Searching rows <span class="keyword">for</span> update</span><br><span class="line">UPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = <span class="number">17</span> WHERE I_STATUS = <span class="number">1</span> AND I_TYPE = <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-18</span>T16:<span class="number">11</span>:<span class="number">11.696061</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">3056367</span> [Note] InnoDB: *** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">1208</span> page no <span class="number">29439</span> n bits <span class="number">160</span> index PRIMARY of table `yos`.`f_log` trx id <span class="number">1261729280</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-18</span>T16:<span class="number">11</span>:<span class="number">11.696079</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">3056367</span> [Note] InnoDB: *** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">1261729278</span>, ACTIVE <span class="number">0</span> sec updating <span class="keyword">or</span> deleting</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">10</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">7</span> row lock(s), undo log entries <span class="number">3</span></span><br><span class="line">MySQL thread id <span class="number">3056367</span>, OS thread handle <span class="number">139682403342080</span>, query id <span class="number">1522438990</span> <span class="number">172.16</span><span class="number">.23</span><span class="number">.82</span> yos_rw updating</span><br><span class="line">UPDATE f_log SET D_UPDATED_AT=<span class="string">&#x27;2020-05-18 16:11:11.693998&#x27;</span>,I_STATUS=<span class="number">3</span> WHERE (I_FILE_ID=<span class="string">&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;</span>)</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-18</span>T16:<span class="number">11</span>:<span class="number">11.696099</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">3056367</span> [Note] InnoDB: *** (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">1208</span> page no <span class="number">29439</span> n bits <span class="number">160</span> index PRIMARY of table `yos`.`f_log` trx id <span class="number">1261729278</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-18</span>T16:<span class="number">11</span>:<span class="number">11.696112</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">3056367</span> [Note] InnoDB: *** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">1208</span> page no <span class="number">17</span> n bits <span class="number">1120</span> index idx_status_type of table `yos`.`f_log` trx id <span class="number">1261729278</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-18</span>T16:<span class="number">11</span>:<span class="number">11.696223</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">3056367</span> [Note] InnoDB: *** WE ROLL BACK TRANSACTION (<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>简单解释一下上面的死锁日志</p>
<a id="more"></a>
<p>TRANSACTION 1261729280, MySQL thread id 3645828, 最后一条执行的sql为</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE f_log SET <span class="attr">D_UPDATED_AT</span> = NOW() , <span class="attr">I_STATUS</span> = <span class="number">17</span> WHERE <span class="attr">I_STATUS</span> = <span class="number">1</span> AND <span class="attr">I_TYPE</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>它在等待获取主键上的记录锁</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS <span class="keyword">index</span> <span class="keyword">PRIMARY</span> of table <span class="symbol">`yos`</span>.<span class="symbol">`f_log`</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br></pre></td></tr></table></figure>
<p>TRANSACTION 1261729278, MySQL thread id 3056367, 最后一条执行的sql为</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">UPDATE</span> f_log SET D_UPDATED_AT=&#x27;<span class="number">2020</span>-<span class="number">05</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">11</span>.<span class="number">693998</span>&#x27;,I_STATUS=<span class="number">3</span> WHERE (I_FILE_ID=&#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27;)</span><br></pre></td></tr></table></figure>
<p>持有主键记录锁</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS <span class="keyword">index</span> <span class="keyword">PRIMARY</span> of table <span class="symbol">`yos`</span>.<span class="symbol">`f_log`</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br></pre></td></tr></table></figure>
<p>等待在二级索引<code>idx_status_type</code>上加记录锁</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS <span class="keyword">index</span> idx_status_type of table <span class="symbol">`yos`</span>.<span class="symbol">`f_log`</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br></pre></td></tr></table></figure>
<p>表结构</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 16:18:24 [yos]&gt; show create table f_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: f_log</span><br><span class="line">Create Table: CREATE TABLE `f_log` (</span><br><span class="line">  `I_ID` bigint(20) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;自增主键&#x27;</span>,</span><br><span class="line">  `I_CHANNEL_ID` bigint(20) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">&#x27;通道ID&#x27;</span>,</span><br><span class="line">  `I_FILE_ID` varchar(100) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span><span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;文件ID&#x27;</span>,</span><br><span class="line">  `I_TYPE` tinyint(4) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">&#x27;日志类型1 同步 2 删除&#x27;</span>,</span><br><span class="line">  `I_STATUS` tinyint(1) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">&#x27;同步标志 0 未同步 1 同步中 2 已同步 3&#x27;</span>,</span><br><span class="line">  `D_CREATED_AT` datetime<span class="built_in"> DEFAULT </span><span class="literal">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `D_UPDATED_AT` datetime<span class="built_in"> DEFAULT </span><span class="literal">NULL</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`I_ID`),</span><br><span class="line">  KEY `idx_updatedat_status_type` (`D_UPDATED_AT`,`I_STATUS`,`I_TYPE`),</span><br><span class="line">  KEY `idx_status_type` (`I_STATUS`,`I_TYPE`),</span><br><span class="line">  KEY `idx_file_id` (`I_FILE_ID`)</span><br><span class="line">) <span class="attribute">ENGINE</span>=InnoDB <span class="attribute">AUTO_INCREMENT</span>=2011346<span class="built_in"> DEFAULT </span><span class="attribute">CHARSET</span>=utf8 <span class="attribute">COMMENT</span>=<span class="string">&#x27;文件日志表&#x27;</span></span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>事务隔离级别为<code>READ-COMMITTED</code></p>
<p>死锁这块我比较弱, 其实厉害的话根据上面的信息已经可以看出原因了.</p>
<h1 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h1><p>我当时去翻审计日志, 通过语句中的一些关键信息, 如 `thread id 3645828/3056367’ 时间范围, 找出了如下信息</p>
<p>TRANSACTION (2) 也就是</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">TRANSACTION</span> <span class="number">1261729278</span>, ACTIVE <span class="number">0</span> sec updating or deleting</span><br><span class="line"><span class="attribute">mysql</span> tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="attribute">10</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">7</span> row lock(s), undo log entries <span class="number">3</span></span><br><span class="line"><span class="attribute">MySQL</span> thread id <span class="number">3056367</span>, OS thread handle <span class="number">139682403342080</span>, query id <span class="number">1522438990</span> <span class="number">172.16.23.82</span> yos_rw updating</span><br><span class="line"><span class="attribute">UPDATE</span> f_log SET D_UPDATED_AT=&#x27;<span class="number">2020</span>-<span class="number">05</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">11</span>.<span class="number">693998</span>&#x27;,I_STATUS=<span class="number">3</span> WHERE (I_FILE_ID=&#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27;)</span><br></pre></td></tr></table></figure>
<p>执行语句如下:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">START</span> TRANSACTION</span><br><span class="line"><span class="attribute">SELECT</span> I_FILE_ID,I_FILE_COUNT,I_FILE_STATUS,I_IS_EXPIRED,I_FILE_VALIDDAY,I_FILE_ACCESS,CH_FILE_NAME,CH_FILE_TYPE,I_BUSINESS_ID,D_CREATED_AT,D_UPDATED_AT,I_YOS_VERSION,D_EXPIRED_AT FROM f_file_info WHERE I_FILE_ID = &#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27; FOR UPDATE</span><br><span class="line"><span class="attribute">SELECT</span> i_channel_id FROM f_file_storage WHERE i_file_id = &#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27; AND i_storage_status = <span class="number">1</span></span><br><span class="line"><span class="attribute">UPDATE</span> f_file_info SET i_file_count = <span class="number">2</span>, d_updated_at = &#x27;<span class="number">2020</span>-<span class="number">05</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">11</span>.<span class="number">687696</span>&#x27; WHERE i_file_id = &#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27;</span><br><span class="line"><span class="attribute">SELECT</span> I_ID,I_FILE_ID,I_STORAGE_STATUS,I_CHANNEL_ID,D_CREATED_AT,D_UPDATED_AT FROM f_file_storage WHERE i_file_id = &#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27; AND i_channel_id = <span class="number">1</span> FOR UPDATE</span><br><span class="line"><span class="attribute">UPDATE</span> f_file_storage SET i_storage_status = <span class="number">1</span> , d_updated_at = &#x27;<span class="number">2020</span>-<span class="number">05</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">11</span>.<span class="number">690879</span>&#x27; WHERE i_file_id = &#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27; AND i_channel_id = <span class="number">1</span></span><br><span class="line"><span class="attribute">SELECT</span> count(*) FROM f_file_storage WHERE (I_FILE_ID=&#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27; AND I_STORAGE_STATUS=<span class="number">1</span>)</span><br><span class="line"><span class="attribute">UPDATE</span> f_log SET D_UPDATED_AT=&#x27;<span class="number">2020</span>-<span class="number">05</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">11</span>.<span class="number">693998</span>&#x27;,I_STATUS=<span class="number">3</span> WHERE (I_FILE_ID=&#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27;)</span><br><span class="line"><span class="attribute">COMMIT</span></span><br></pre></td></tr></table></figure>
<p>TRANSACTION (1) 也就是</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TRANSACTION 1261729280, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, <span class="keyword">locked</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">LOCK</span> <span class="keyword">WAIT</span> <span class="number">3</span> <span class="keyword">lock</span> <span class="keyword">struct</span>(s), <span class="keyword">heap</span> <span class="keyword">size</span> <span class="number">1136</span>, <span class="number">2</span> <span class="keyword">row</span> <span class="keyword">lock</span>(s)</span><br><span class="line">MySQL <span class="keyword">thread</span> <span class="keyword">id</span> <span class="number">3645828</span>, OS <span class="keyword">thread</span> handle <span class="number">139681739994880</span>, <span class="keyword">query</span> <span class="keyword">id</span> <span class="number">1522438991</span> <span class="number">172.16</span><span class="number">.23</span><span class="number">.82</span> yos_rw Searching <span class="keyword">rows</span> <span class="keyword">for</span> <span class="keyword">update</span></span><br><span class="line"><span class="keyword">UPDATE</span> f_log <span class="keyword">SET</span> D_UPDATED_AT = <span class="keyword">NOW</span>() , I_STATUS = <span class="number">17</span> <span class="keyword">WHERE</span> I_STATUS = <span class="number">1</span> <span class="keyword">AND</span> I_TYPE = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>执行语句如下:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Prepare</span></span><br><span class="line"><span class="keyword">UPDATE</span> f_log <span class="keyword">SET</span> D_UPDATED_AT = NOW() , I_STATUS = <span class="number">17</span> <span class="keyword">WHERE</span> I_STATUS = <span class="number">1</span> <span class="keyword">AND</span> I_TYPE = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>到这里想不出原因了, 因为两个会话实际上就是update语句死锁了. 我但是没想明白为啥<code>UPDATE f_log SET D_UPDATED_AT=&#39;2020-05-18 16:11:11.693998&#39;,I_STATUS=3 WHERE (I_FILE_ID=&#39;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#39;)</code> 要请求在二级索引<code>idx_status_type</code>上加记录锁</p>
<p>后来还是和研发讨论, 研发提醒了我update要锁被修改列二级索引. 我一开始还说不对… 后来想想有道理</p>
<blockquote>
<p><a href="https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html">https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html</a></p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/image-20200519150604900.png" alt=""></p>
</blockquote>
<p>那么到这里就说通了, 这就是为啥<code>UPDATE f_log SET D_UPDATED_AT=&#39;2020-05-18 16:11:11.693998&#39;,I_STATUS=3 WHERE (I_FILE_ID=&#39;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#39;)</code> 要请求在二级索引<code>idx_status_type</code>上加记录锁</p>
<p>那么实际这个死锁是这样产生的</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/image-20200519214833746.png" alt=""></p>
<p>事务1,2 开始时  I_FILE_ID=’92b52d6589ce11a9a3c985e7c5f37462efb66ac7’ 对应记录的 I_STATUS = 1 , I_TYPE = 1</p>
<p>事务2执行语句</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">UPDATE</span> f_log SET D_UPDATED_AT=&#x27;<span class="number">2020</span>-<span class="number">05</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">11</span>.<span class="number">693998</span>&#x27;,I_STATUS=<span class="number">3</span> WHERE (I_FILE_ID=&#x27;<span class="number">92</span>b<span class="number">52</span>d<span class="number">6589</span>ce<span class="number">11</span>a<span class="number">9</span>a<span class="number">3</span>c<span class="number">985</span>e<span class="number">7</span>c<span class="number">5</span>f<span class="number">37462</span>efb<span class="number">66</span>ac<span class="number">7</span>&#x27;)</span><br></pre></td></tr></table></figure>
<p>走<code>I_FILE_ID</code>列二级索引<code>idx_file_id</code>, 根据二级索引中的主键值找到主键索引对应记录加记录锁, 因为是update语句更新了<code>I_STATUS</code>列, 且<code>I_STATUS</code>列有二级索引<code>idx_status_type</code>所以还要去修改二级索引中对应记录, 于是也要锁<code>idx_status_type</code>中的记录<code>I_STATUS = 1 , I_TYPE = 1, I_ID=2010712</code>(原值)和<code>I_STATUS = 3 , I_TYPE = 1, I_ID=2010712</code>(新值). </p>
<p>但此时事务2还未在<code>idx_status_type</code>对应记录加上锁, 事务1执行了语句</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE f_log SET <span class="attr">D_UPDATED_AT</span> = NOW() , <span class="attr">I_STATUS</span> = <span class="number">17</span> WHERE <span class="attr">I_STATUS</span> = <span class="number">1</span> AND <span class="attr">I_TYPE</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>这个sql走二级索引<code>idx_status_type</code>, 于是先对二级索引<code>idx_status_type</code>对应记录<code>I_STATUS = 1 , I_TYPE = 1, I_ID=2010712</code>加锁, 加锁成功, 然后需要根据二级索引<code>idx_status_type</code>中记录的主键值<code>I_ID=2010712</code>去主键加锁, 但此锁已经被事务2持有</p>
<p>事务2持有主键锁, 等待在二级索引<code>idx_status_type</code>加记录锁</p>
<p>事务1持有<code>idx_status_type</code>记录锁, 等待在主键加记录锁</p>
<p>至此陷入死锁.</p>
<h1 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h1><p>这个死锁可以说是很巧合了, 手工无法模拟</p>
<p>我是这样的模拟的, 开三个窗口, 分别执行</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">true</span>;<span class="keyword">do</span> mysql -uroot -p<span class="string">&#x27;123.com&#x27;</span> -S <span class="regexp">/data/my</span>sql_3306<span class="regexp">/run/my</span>sql.sock fanboshi -e<span class="string">&quot;begin;UPDATE f_log_2 SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;250181420422912&#x27;);commit;&quot;</span>;done</span><br></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">true</span>;<span class="keyword">do</span> mysql -uroot -p<span class="string">&#x27;123.com&#x27;</span> -S <span class="regexp">/data/my</span>sql_3306<span class="regexp">/run/my</span>sql.sock fanboshi -e<span class="string">&quot;UPDATE f_log_2 SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 1&quot;</span>;done</span><br></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="keyword">true</span>;<span class="keyword">do</span> mysql -uroot -p<span class="string">&#x27;123.com&#x27;</span> -S <span class="regexp">/data/my</span>sql_3306<span class="regexp">/run/my</span>sql.sock fanboshi -e<span class="string">&quot;UPDATE f_log_2 SET I_STATUS = 1, I_TYPE=1 WHERE I_ID=9656 &quot;</span>;done</span><br></pre></td></tr></table></figure>
<p>第三个窗口目的只是将<code>I_STATUS</code>和<code>I_TYPE</code>列值更新回去, 制造条件, 不然前两个窗口语句不满足条件更新不到记录</p>
<p>复现出的死锁日志如下, 开起了<code>innodb_show_verbose_locks</code>参数:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.074829</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: Transactions deadlock detected, dumping detailed information.</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.074841</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: </span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">19924</span>, ACTIVE <span class="number">0</span> sec starting index read</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">3</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">2</span> row lock(s)</span><br><span class="line">MySQL thread id <span class="number">11643</span>, OS thread handle <span class="number">140502089639680</span>, query id <span class="number">40057</span> localhost root Searching rows <span class="keyword">for</span> update</span><br><span class="line">UPDATE f_log_2 SET D_UPDATED_AT = NOW() , I_STATUS = <span class="number">17</span> WHERE I_STATUS = <span class="number">1</span> AND I_TYPE = <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.074858</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: *** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED: --等待获取如下锁</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">137</span> page no <span class="number">136</span> n bits <span class="number">312</span> index PRIMARY of table `fanboshi`.`f_log_2` trx id <span class="number">19924</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting --主键记录锁</span><br><span class="line">Record lock, heap no <span class="number">217</span> PHYSICAL RECORD: n_fields <span class="number">9</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">80000000000025</span>b8; asc       % ;;                       第一列, 根据表结构知道这列是主键, <span class="number">16</span>进制转<span class="number">10</span>进制 <span class="number">9656</span></span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000004</span>dd5; asc     M ;;                             --该字段为<span class="number">6</span>个字节的事务id，这个id表示最近一次被更新的事务id <span class="number">000000004</span>dd5 <span class="number">16</span>进制转<span class="number">10</span>进制结果为<span class="number">19925</span>正是下面事务<span class="number">2</span>的的事务号<span class="string">&quot;TRANSACTION 19925&quot;</span></span><br><span class="line"> <span class="number">2</span>: len <span class="number">7</span>; hex <span class="number">34000000051016</span>; asc <span class="number">4</span>      ;;                          --该字段为<span class="number">7</span>个字节的回滚指针，用于mvcc </span><br><span class="line"> <span class="number">3</span>: len <span class="number">8</span>; hex <span class="number">8000000000000001</span>; asc         ;;                       I_CHANNEL_ID = <span class="number">1</span></span><br><span class="line"> <span class="number">4</span>: len <span class="number">15</span>; hex <span class="number">323530313831343230343232393132</span>; asc <span class="number">250181420422912</span>;; I_FILE_ID 这一列是varchar类型. <span class="number">0x32</span> <span class="number">0x35</span> <span class="number">0x30</span> <span class="number">0x31</span> <span class="number">0x38</span> <span class="number">0x31</span> <span class="number">0x34</span> <span class="number">0x32</span> <span class="number">0x30</span> <span class="number">0x34</span> <span class="number">0x32</span> <span class="number">0x32</span> <span class="number">0x39</span> <span class="number">0x31</span> <span class="number">0x32</span> 转过来就是<span class="number">250181420422912</span></span><br><span class="line"> <span class="number">5</span>: len <span class="number">1</span>; hex <span class="number">81</span>; asc  ;;                                            I_TYPE=<span class="number">1</span></span><br><span class="line"> <span class="number">6</span>: len <span class="number">1</span>; hex <span class="number">83</span>; asc  ;;                                            I_STATUS=<span class="number">3</span></span><br><span class="line"> <span class="number">7</span>: len <span class="number">5</span>; hex <span class="number">99</span>a2d8fd14; asc      ;;                                D_CREATED_AT 不知道怎么转换</span><br><span class="line"> <span class="number">8</span>: len <span class="number">5</span>; hex <span class="number">99</span>a66502cc; asc   e  ;;                                D_UPDATED_AT 不知道怎么转换</span><br><span class="line">到这里已经能定位是哪一行了</span><br><span class="line">mysql&gt; select * <span class="keyword">from</span> f_log_2 WHERE I_ID=<span class="number">9656</span>;</span><br><span class="line">+------+--------------+-----------------+--------+----------+---------------------+---------------------+</span><br><span class="line">| I_ID | I_CHANNEL_ID | I_FILE_ID       | I_TYPE | I_STATUS | D_CREATED_AT        | D_UPDATED_AT        |</span><br><span class="line">+------+--------------+-----------------+--------+----------+---------------------+---------------------+</span><br><span class="line">| <span class="number">9656</span> |            <span class="number">1</span> | <span class="number">250181420422912</span> |      <span class="number">1</span> |        <span class="number">1</span> | <span class="number">2019</span><span class="number">-04</span><span class="number">-12</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">20</span> | <span class="number">2020</span><span class="number">-05</span><span class="number">-18</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">12</span> |</span><br><span class="line">+------+--------------+-----------------+--------+----------+---------------------+---------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.074996</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: *** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line"></span><br><span class="line">TRANSACTION <span class="number">19925</span>, ACTIVE <span class="number">0</span> sec updating <span class="keyword">or</span> deleting</span><br><span class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"><span class="number">4</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">3</span> row lock(s), undo log entries <span class="number">1</span></span><br><span class="line">MySQL thread id <span class="number">11644</span>, OS thread handle <span class="number">140502025062144</span>, query id <span class="number">40060</span> localhost root updating</span><br><span class="line">UPDATE f_log_2 SET D_UPDATED_AT=<span class="string">&#x27;2020-05-18 16:11:11.693998&#x27;</span>,I_STATUS=<span class="number">3</span> WHERE (I_FILE_ID=<span class="string">&#x27;250181420422912&#x27;</span>)</span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.075010</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: *** (<span class="number">2</span>) HOLDS THE LOCK(S):</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">137</span> page no <span class="number">136</span> n bits <span class="number">312</span> index PRIMARY of table `fanboshi`.`f_log_2` trx id <span class="number">19925</span> lock_mode X locks rec but <span class="keyword">not</span> gap --持有主键记录锁</span><br><span class="line">Record lock, heap no <span class="number">217</span> PHYSICAL RECORD: n_fields <span class="number">9</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">80000000000025</span>b8; asc       % ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000004</span>dd5; asc     M ;;</span><br><span class="line"> <span class="number">2</span>: len <span class="number">7</span>; hex <span class="number">34000000051016</span>; asc <span class="number">4</span>      ;;</span><br><span class="line"> <span class="number">3</span>: len <span class="number">8</span>; hex <span class="number">8000000000000001</span>; asc         ;;</span><br><span class="line"> <span class="number">4</span>: len <span class="number">15</span>; hex <span class="number">323530313831343230343232393132</span>; asc <span class="number">250181420422912</span>;; </span><br><span class="line"> <span class="number">5</span>: len <span class="number">1</span>; hex <span class="number">81</span>; asc  ;;                  </span><br><span class="line"> <span class="number">6</span>: len <span class="number">1</span>; hex <span class="number">83</span>; asc  ;;</span><br><span class="line"> <span class="number">7</span>: len <span class="number">5</span>; hex <span class="number">99</span>a2d8fd14; asc      ;;</span><br><span class="line"> <span class="number">8</span>: len <span class="number">5</span>; hex <span class="number">99</span>a66502cc; asc   e  ;;</span><br><span class="line">持有TRANSACTION (<span class="number">1</span>)等待获取的哪一行主键锁</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.075141</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: *** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"></span><br><span class="line">RECORD LOCKS space id <span class="number">137</span> page no <span class="number">17</span> n bits <span class="number">1120</span> index idx_status_type of table `fanboshi`.`f_log_2` trx id <span class="number">19925</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting --等待二级索引列加锁</span><br><span class="line">Record lock, heap no <span class="number">526</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">1</span>; hex <span class="number">81</span>; asc  ;;                              I_STATUS = <span class="number">1</span></span><br><span class="line"> <span class="number">1</span>: len <span class="number">1</span>; hex <span class="number">81</span>; asc  ;;                              I_TYPE = <span class="number">1</span></span><br><span class="line"> <span class="number">2</span>: len <span class="number">8</span>; hex <span class="number">80000000000025</span>b8; asc       % ;;         这是主键值 <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="number">-05</span><span class="number">-19</span>T14:<span class="number">15</span>:<span class="number">29.075197</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">11644</span> [Note] InnoDB: *** WE ROLL BACK TRANSACTION (<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到和线上出现的死锁日志是吻合的</p>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>将事务1语句改为先根据条件查询出主键值, 然后根据主键值更新.</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;2020.05.18 16:12 收到报警&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/Fanduzi/Figure_bed/master/img/image-20200519140217826.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;登录主机, 查看error log( 开启了innodb_print_all_deadlocks参数)&lt;/p&gt;
&lt;figure class=&quot;highlight angelscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;*** (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) TRANSACTION:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TRANSACTION &lt;span class=&quot;number&quot;&gt;1261729280&lt;/span&gt;, ACTIVE &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; sec starting index read&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mysql tables &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; use &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, locked &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOCK WAIT &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; lock struct(s), heap size &lt;span class=&quot;number&quot;&gt;1136&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; row lock(s)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MySQL thread id &lt;span class=&quot;number&quot;&gt;3645828&lt;/span&gt;, OS thread handle &lt;span class=&quot;number&quot;&gt;139681739994880&lt;/span&gt;, query id &lt;span class=&quot;number&quot;&gt;1522438991&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.16&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.23&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.82&lt;/span&gt; yos_rw Searching rows &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;UPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = &lt;span class=&quot;number&quot;&gt;17&lt;/span&gt; WHERE I_STATUS = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; AND I_TYPE = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-05&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-18&lt;/span&gt;T16:&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;11.696061&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;08&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3056367&lt;/span&gt; [Note] InnoDB: *** (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) WAITING FOR THIS LOCK TO BE GRANTED:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RECORD LOCKS space id &lt;span class=&quot;number&quot;&gt;1208&lt;/span&gt; page no &lt;span class=&quot;number&quot;&gt;29439&lt;/span&gt; n bits &lt;span class=&quot;number&quot;&gt;160&lt;/span&gt; index PRIMARY of table `yos`.`f_log` trx id &lt;span class=&quot;number&quot;&gt;1261729280&lt;/span&gt; lock_mode X locks rec but &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; gap waiting&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-05&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-18&lt;/span&gt;T16:&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;11.696079&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;08&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3056367&lt;/span&gt; [Note] InnoDB: *** (&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) TRANSACTION:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;TRANSACTION &lt;span class=&quot;number&quot;&gt;1261729278&lt;/span&gt;, ACTIVE &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; sec updating &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; deleting&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mysql tables &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; use &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, locked &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt; lock struct(s), heap size &lt;span class=&quot;number&quot;&gt;1136&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;7&lt;/span&gt; row lock(s), undo log entries &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MySQL thread id &lt;span class=&quot;number&quot;&gt;3056367&lt;/span&gt;, OS thread handle &lt;span class=&quot;number&quot;&gt;139682403342080&lt;/span&gt;, query id &lt;span class=&quot;number&quot;&gt;1522438990&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.16&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.23&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.82&lt;/span&gt; yos_rw updating&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;UPDATE f_log SET D_UPDATED_AT=&lt;span class=&quot;string&quot;&gt;&amp;#x27;2020-05-18 16:11:11.693998&amp;#x27;&lt;/span&gt;,I_STATUS=&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; WHERE (I_FILE_ID=&lt;span class=&quot;string&quot;&gt;&amp;#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-05&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-18&lt;/span&gt;T16:&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;11.696099&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;08&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3056367&lt;/span&gt; [Note] InnoDB: *** (&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) HOLDS THE LOCK(S):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RECORD LOCKS space id &lt;span class=&quot;number&quot;&gt;1208&lt;/span&gt; page no &lt;span class=&quot;number&quot;&gt;29439&lt;/span&gt; n bits &lt;span class=&quot;number&quot;&gt;160&lt;/span&gt; index PRIMARY of table `yos`.`f_log` trx id &lt;span class=&quot;number&quot;&gt;1261729278&lt;/span&gt; lock_mode X locks rec but &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; gap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-05&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-18&lt;/span&gt;T16:&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;11.696112&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;08&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3056367&lt;/span&gt; [Note] InnoDB: *** (&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) WAITING FOR THIS LOCK TO BE GRANTED:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;RECORD LOCKS space id &lt;span class=&quot;number&quot;&gt;1208&lt;/span&gt; page no &lt;span class=&quot;number&quot;&gt;17&lt;/span&gt; n bits &lt;span class=&quot;number&quot;&gt;1120&lt;/span&gt; index idx_status_type of table `yos`.`f_log` trx id &lt;span class=&quot;number&quot;&gt;1261729278&lt;/span&gt; lock_mode X locks rec but &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; gap waiting&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2020&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-05&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-18&lt;/span&gt;T16:&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;11.696223&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;08&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3056367&lt;/span&gt; [Note] InnoDB: *** WE ROLL BACK TRANSACTION (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;简单解释一下上面的死锁日志&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="死锁" scheme="http://fuxkdb.com/tags/%E6%AD%BB%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>MGR单主到底做不做冲突检测?</title>
    <link href="http://fuxkdb.com/2020/06/18/2020-06-18-MGR%E5%8D%95%E4%B8%BB%E5%88%B0%E5%BA%95%E5%81%9A%E4%B8%8D%E5%81%9A%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B/"/>
    <id>http://fuxkdb.com/2020/06/18/2020-06-18-MGR单主到底做不做冲突检测/</id>
    <published>2020-06-18T14:23:00.000Z</published>
    <updated>2020-06-18T14:34:48.314Z</updated>
    
    <content type="html"><![CDATA[<p>和同事探讨一个问题, MGR单主做不做冲突检测.</p>
<p>我理解是不需要做的, 因为已经明确只有主节点才能写入数据了, 那么必然不会有数据冲突的可能, 没必要再做冲突检测浪费性能了.</p>
<p>看了下<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html">官方文档</a></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">In</span> single-primary mode,<span class="built_in"> Group </span>Replication enforces that only a single<span class="built_in"> server </span>writes <span class="keyword">to</span> the group, so compared <span class="keyword">to</span> multi-primary mode, consistency checking can be less strict <span class="keyword">and</span> DDL statements <span class="keyword">do</span> <span class="keyword">not</span> need <span class="keyword">to</span> be handled with any extra care</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>这里<code>less strict</code>让人很迷惑, 意思是还有冲突检测呗, 但是和多主区别是啥没说</p>
<p>之前看MGR的时候看过网易温正湖的文章, 路上搜了下, 发现两个文章:</p>
<p><a href="https://zhuanlan.zhihu.com/p/41175310">MySQL MGR事务认证机制优化</a></p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/images/MGR%E5%8D%95%E4%B8%BB%E5%88%B0%E5%BA%95%E5%81%9A%E4%B8%8D%E5%81%9A%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B/1.jpg" alt="img"></p>
<p><a href="https://zhuanlan.zhihu.com/p/38456119">MySQL事务在MGR中的漫游记 - 事务认证</a></p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/images/MGR%E5%8D%95%E4%B8%BB%E5%88%B0%E5%BA%95%E5%81%9A%E4%B8%8D%E5%81%9A%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B/2.jpg" alt="img"></p>
<p>其实他文章哪些源码我也看不懂. 我是不想别人说啥我就信啥, 所以想找到知识源头</p>
<p>到家我搜了下conflict_detection_enable</p>
<p>搜到这个网站<a href="https://s0dev0mysql0com.icopy.site/doc/dev/mysql-server/latest/classCertifier.html">https://s0dev0mysql0com.icopy.site/doc/dev/mysql-server/latest/classCertifier.html</a></p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/images/MGR%E5%8D%95%E4%B8%BB%E5%88%B0%E5%BA%95%E5%81%9A%E4%B8%8D%E5%81%9A%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B/3.jpg" alt="img"></p>
<p>那么这个网站<code>源头</code>又是啥呢, 又搜了下</p>
<p><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/classCertifier.html">https://dev.mysql.com/doc/dev/mysql-server/latest/classCertifier.html</a><br>这里面说的就很清楚了</p>
<p><img src="https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/images/MGR%E5%8D%95%E4%B8%BB%E5%88%B0%E5%BA%95%E5%81%9A%E4%B8%8D%E5%81%9A%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B/4.jpg" alt="img"></p>
<p>就是说单主, 主库挂了, 新主库应用原主库事务的时候才做冲突检测</p>
<p>想起以前做过实验<a href="https://b2daf797.wiz03.com/wapp/pages/view/share/s/2OSLun3V44CI2LVCy70ROCI30eXwXS0taAga2v9Z5M21jUO6">压测2 5.7MGR是否要应用完所有binlog才会选举出新主</a></p>
<p>实际上5.7官方文档有描述</p>
<p>单主模式下:</p>
<p>当选择一个新的主数据库时，它只有在处理完所有来自旧主数据库的事务后才可写。 这样可以避免旧的主事务中的旧事务与在该成员上执行的新事务之间可能发生的并发问题。 在新的主数据库重新路由客户端应用程序之前，最好等待新的主数据库应用其复制相关的中继日志。</p>
<blockquote>
<p>When a new primary is elected, it is only writable once it has processed all of the transactions that came from the old primary. This avoids possible concurrency issues between old transactions from the old primary and the new ones being executed on this member. It is a good practice to wait for the new primary to apply its replication related relay-log before re-routing client applications to it.</p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-single-primary-mode.html">https://dev.mysql.com/doc/refman/5.7/en/group-replication-single-primary-mode.html</a></p>
</blockquote>
<p>在8.0文档中是这样写的</p>
<p>选举或任命新的主库时，可能会积压已应用于旧的主库但尚未在此服务器上应用的更改。 在这种情况下，直到新的主数据库赶上旧的主数据库，读写事务可能会导致冲突并回滚，而只读事务可能会导致陈旧的读取。</p>
<blockquote>
<p>When a new primary is elected or appointed, it might have a backlog of changes that had been applied on the old primary but have not yet been applied on this server. In this situation, until the new primary catches up with the old primary, read-write transactions might result in conflicts and be rolled back, and read-only transactions might result in stale reads.</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html">https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html</a></p>
</blockquote>
<p>这其实很合理, 假设一个单主模式MGR集群 三个节点A, B, C</p>
<p>A是主库, app向T1表插入三条数据, 主键值分别为 1,2,3</p>
<p>B,C收到binlog event, 但还未应用, 此时A宕机, B当选为新主库, 那么B需要应用在A产生的三个插入1,2,3. 如果没有冲突检测, 在B应用1,2,3前,业务有插入了新数据1,2,3, 那么就明显有问题, 所以此阶段一定要做冲突检测.</p>
<p>仔细看感觉5.7和8.0的描述有了”很大区别” 5.7说</p>
<p><code>When a new primary is elected, it is only writable once it has processed all of the transactions that came from the old primary.</code> 新主必须应用完原主所有事物才可写</p>
<p>8.0说<code>In this situation, until the new primary catches up with the old primary, read-write transactions might result in conflicts and be rolled back, and read-only transactions might result in stale reads.</code></p>
<p>在新主应用完原主所有事物前, 写可能会冲突回滚, 而读可能会读到旧数据</p>
<p>我猜测这是说5.7单主是彻底关闭了冲突检测, 新主应用原主完原主事务前是不可写的, 通过不可写避免了冲突, 还需要继续做实验测试, 新主应用原主完原主事务前, 是否可以执行不冲突的事务(比如我们像T1表写大量数据制造<code>transactions_behind</code>, 新主当选后, 我们想T2表写数据, 这明显是不冲突的.)</p>
<p>那么看来8.0比5.7有了改进, 在新主应用原主完原主事务期间开启冲突检测, 那么按照上面的实验例子, 业务就可以执行”不冲突的事务了”</p>
<p>但是是否这样对业务来说是可接受的呢? 也许业务希望<code>新主应用原主完原主事务后</code>才可写是合理的, 所以有了下面的参数</p>
<p>8.0.14后增加了参数<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-options.html#sysvar_group_replication_consistency">group_replication_consistency</a>, 从根本上解决了读旧数据的问题(写操作无需设置参数也会等待应用完所有backlog才可以执行)</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEFORE_ON_PRIMARY_FAILOVER</span><br><span class="line"></span><br><span class="line">New RO <span class="keyword">or</span> RW transactions <span class="keyword">with</span> a newly elected primary <span class="keyword">that</span> <span class="keyword">is</span> applying backlog <span class="keyword">from</span> <span class="keyword">the</span> old primary are held (<span class="keyword">not</span> applied) <span class="keyword">until</span> any backlog has been applied. This ensures <span class="keyword">that</span> when a primary failover happens, intentionally <span class="keyword">or</span> <span class="keyword">not</span>, clients always see <span class="keyword">the</span> latest value <span class="keyword">on</span> <span class="keyword">the</span> primary. This guarantees consistency, <span class="keyword">but</span> means <span class="keyword">that</span> clients must be able <span class="keyword">to</span> handle <span class="keyword">the</span> <span class="built_in">delay</span> <span class="keyword">in</span> <span class="keyword">the</span> event <span class="keyword">that</span> a backlog <span class="keyword">is</span> being applied. Usually this <span class="built_in">delay</span> should be minimal, <span class="keyword">but</span> <span class="keyword">does</span> depend <span class="keyword">on</span> <span class="keyword">the</span> size <span class="keyword">of</span> <span class="keyword">the</span> backlog.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在发生切换时，连到新主的事务会被阻塞，等待先序提交的事务回放完成；这样确保在故障切换时客户端都能读取到主服务器上的最新数据，保证了一致性</p>
</blockquote>
<p>上面的描述不严谨, 出自知数堂田鹏的文章<a href="https://blog.csdn.net/n88Lpo/article/details/102927003">MySQL MGR”一致性读写”特性解读</a>. 事实上只读事务也会等待, 除了以下只读事务(参考此译文<a href="https://cloud.tencent.com/developer/article/1478455">https://cloud.tencent.com/developer/article/1478455</a>)</p>
<ul>
<li>SHOW commands</li>
<li>SET option</li>
<li>DO</li>
<li>EMPTY</li>
<li>USE</li>
<li>SELECTing from performance_schema database</li>
<li>SELECTing from table PROCESSLIST on database infoschema</li>
<li>SELECTing from sys database</li>
<li>SELECT command that don’t use tables</li>
<li>SELECT command that don’t execute user defined functions</li>
<li>STOP GROUP_REPLICATION command</li>
<li>SHUTDOWN command</li>
<li>RESET PERSIST</li>
</ul>
<p>个人理解如果设置<code>BEFORE_ON_PRIMARY_FAILOVER</code>虽然会保证一致性, 如果节点新主与原主延迟过大, 新主应用差异日志时间过长, 那么会导致大量连接进来处于等待状态, 导致<code>Threads_running</code>暴涨, 甚至连接数打满新主崩溃</p>
<p>至8.0.18MGR选主算法是</p>
<p>1.选版本最小的</p>
<p>2.选权重最大的</p>
<p>3.选uuid排序最小的</p>
<p>所以并没有判断哪个节点延迟最小</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html">https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html</a></p>
<p>那么多主如何处理?</p>
<p>从参数说明上来看<code>BEFORE_ON_PRIMARY_FAILOVER</code>应该只是针对单主, 所以除非应用显示指定了<a href="https://dev.mysql.com/doc/refman/8.0/en/group-replication-options.html#sysvar_group_replication_consistency">group_replication_consistency</a>, 否则多主还是会读到旧数据. </p>
<p>对于写入, 因为多主是要做冲突检测的, 所以我们假设一个场景</p>
<p>多主MGR, N1,N2,N3, 单写N1, T1(id int primary key, sname varchar(10))表插入</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>,fan GTID: GROUP_UUID:<span class="number">1</span></span><br><span class="line"><span class="number">2</span>,bo GTID: GROUP_UUID:<span class="number">2</span></span><br><span class="line"><span class="number">3</span>,shi GTID: GROUP_UUID:<span class="number">3</span></span><br><span class="line"></span><br><span class="line">目前GTID: GROUP_UUID:<span class="number">1</span><span class="number">-3</span></span><br></pre></td></tr></table></figure>
<p>N1宕机, N2应用到1, 未执行2,3. 此时client像N2插入(2,hehe) 那么此时N2这个插入版本是<code>GROUP_UUID:1</code></p>
<p>而冲突检测数据库中id=2这一行的版本是<code>GROUP_UUID:1-2</code>, 所以这条插入会冲突检测失败回滚掉</p>
<p>以上是我的理解, 目前没有测试</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;和同事探讨一个问题, MGR单主做不做冲突检测.&lt;/p&gt;
&lt;p&gt;我理解是不需要做的, 因为已经明确只有主节点才能写入数据了, 那么必然不会有数据冲突的可能, 没必要再做冲突检测浪费性能了.&lt;/p&gt;
&lt;p&gt;看了下&lt;a href=&quot;https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight routeros&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;In&lt;/span&gt; single-primary mode,&lt;span class=&quot;built_in&quot;&gt; Group &lt;/span&gt;Replication enforces that only a single&lt;span class=&quot;built_in&quot;&gt; server &lt;/span&gt;writes &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; the group, so compared &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; multi-primary mode, consistency checking can be less strict &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; DDL statements &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; need &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; be handled with any extra care&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="MGR" scheme="http://fuxkdb.com/tags/MGR/"/>
    
  </entry>
  
  <entry>
    <title>译文 New Feature in Percona XtraDB Cluster 8.0 – Streaming Replication</title>
    <link href="http://fuxkdb.com/2020/05/16/2020-05-16-%E8%AF%91%E6%96%87-New-Feature-in-Percona-XtraDB-Cluster-8.0-%E2%80%93-Streaming-Replication/"/>
    <id>http://fuxkdb.com/2020/05/16/2020-05-16-译文-New-Feature-in-Percona-XtraDB-Cluster-8.0-–-Streaming-Replication/</id>
    <published>2020-05-16T14:56:00.000Z</published>
    <updated>2020-05-17T03:10:38.334Z</updated>
    
    <content type="html"><![CDATA[<h1 id="New-Feature-in-Percona-XtraDB-Cluster-8-0-–-Streaming-Replication"><a href="#New-Feature-in-Percona-XtraDB-Cluster-8-0-–-Streaming-Replication" class="headerlink" title="New Feature in Percona XtraDB Cluster 8.0 – Streaming Replication"></a><a href="https://www.percona.com/blog/2020/05/15/new-feature-in-percona-xtradb-cluster-8-0-streaming-replication/?utm_campaign=Blog%202016%3A%20Subscribers%20To%20Blog%20Weekly%20Recap%20Email%20--%202.15.16&amp;utm_source=hs_email&amp;utm_medium=email&amp;utm_content=88003187&amp;_hsenc=p2ANqtz-8AwEjtYpEuWSlNMk6OX4QGFsnPUWMEcW9o9FWOjQI_UGqkjKzcXPvfKm7evqRE0EuwXnrLs-tTDdcMby4ADbQWg5nLqw&amp;_hsmi=88003187">New Feature in Percona XtraDB Cluster 8.0 – Streaming Replication</a></h1><p>Percona XtraDB Cluster 8.0附带了一个升级的Galera 4.0库, 它提供了一个新特性—<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>.让我们回顾一下它是什么, 什么时候可能有用</p>
<p>以前版本的Percona XtraDB集群和Galera 3.x在处理大事务方面有限制.</p>
<p>让我们看一下sysbench-tpcc工作负载下的性能, 与此同时, 我们对一个表执行了一个大的更新语句, 该更新甚至与主工作负载中的表都不相关.<br><a id="more"></a></p>
<h2 id="Without-Streaming-Replication"><a href="#Without-Streaming-Replication" class="headerlink" title="Without Streaming Replication"></a>Without Streaming Replication</h2><p>Let’s run two workloads.</p>
<ol>
<li>sysbench-tpcc workload with 1 sec resolution</li>
<li>In parallel run UPDATE oltp.sbtest SET k=k+1 LIMIT 1000000</li>
</ol>
<p>Running update:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql</span>&gt; update sbtest<span class="number">1</span> set k=k+<span class="number">1</span> limit <span class="number">1000000</span>;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">1000000</span> rows affected (<span class="number">34</span>.<span class="number">48</span> sec)</span><br><span class="line"><span class="attribute">Rows</span> matched: <span class="number">1000000</span>  Changed: <span class="number">1000000</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>Check what is happening in sysbench-tpcc:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="number">77</span>s ] thds: <span class="number">100</span> tps: <span class="number">7011.97</span> qps: <span class="number">198248.21</span> (r/w/o: <span class="number">90469.64</span>/<span class="number">93758.63</span>/<span class="number">14019.94</span>) lat (ms,<span class="number">95</span>%): <span class="number">25.28</span> err/s <span class="number">31.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">78</span>s ] thds: <span class="number">100</span> tps: <span class="number">6779.94</span> qps: <span class="number">196129.34</span> (r/w/o: <span class="number">89462.24</span>/<span class="number">93103.21</span>/<span class="number">13563.88</span>) lat (ms,<span class="number">95</span>%): <span class="number">26.20</span> err/s <span class="number">30.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">79</span>s ] thds: <span class="number">100</span> tps: <span class="number">6948.01</span> qps: <span class="number">199157.35</span> (r/w/o: <span class="number">90878.16</span>/<span class="number">94383.16</span>/<span class="number">13896.02</span>) lat (ms,<span class="number">95</span>%): <span class="number">26.20</span> err/s <span class="number">28.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">80</span>s ] thds: <span class="number">100</span> tps: <span class="number">3920.09</span> qps: <span class="number">113882.48</span> (r/w/o: <span class="number">51940.13</span>/<span class="number">54102.18</span>/<span class="number">7840.17</span>) lat (ms,<span class="number">95</span>%): <span class="number">27.17</span> err/s <span class="number">15.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">81</span>s ] thds: <span class="number">100</span> tps: <span class="number">67.00</span> qps: <span class="number">1956.02</span> (r/w/o: <span class="number">899.01</span>/<span class="number">923.01</span>/<span class="number">134.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">623.33</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">82</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">83</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">84</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">85</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">86</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">87</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">88</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">89</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">90</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">91</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">92</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">93</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">94</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">95</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">96</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">97</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">98</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">99</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">100</span>s ] thds: <span class="number">100</span> tps: <span class="number">0.00</span> qps: <span class="number">0.00</span> (r/w/o: <span class="number">0.00</span>/<span class="number">0.00</span>/<span class="number">0.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0.00</span> err/s <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">101</span>s ] thds: <span class="number">100</span> tps: <span class="number">3501.85</span> qps: <span class="number">99695.66</span> (r/w/o: <span class="number">45473.02</span>/<span class="number">47218.94</span>/<span class="number">7003.70</span>) lat (ms,<span class="number">95</span>%): <span class="number">257.95</span> err/s <span class="number">14.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">102</span>s ] thds: <span class="number">100</span> tps: <span class="number">6980.06</span> qps: <span class="number">197777.73</span> (r/w/o: <span class="number">90228.79</span>/<span class="number">93588.82</span>/<span class="number">13960.12</span>) lat (ms,<span class="number">95</span>%): <span class="number">25.74</span> err/s <span class="number">33.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">103</span>s ] thds: <span class="number">100</span> tps: <span class="number">6745.15</span> qps: <span class="number">196518.25</span> (r/w/o: <span class="number">89717.94</span>/<span class="number">93310.02</span>/<span class="number">13490.29</span>) lat (ms,<span class="number">95</span>%): <span class="number">26.68</span> err/s <span class="number">46.00</span> reconn/s: <span class="number">0.00</span></span><br></pre></td></tr></table></figure>
<p>更新本身花了<em>34秒</em>.</p>
<p>在这种情况下, 主工作负载停止了<code>22秒</code>. 基本上所有语句在这段时间都被暂停/阻塞了</p>
<h2 id="With-Streaming-Replication"><a href="#With-Streaming-Replication" class="headerlink" title="With Streaming Replication"></a>With Streaming Replication</h2><p>如何通过streaming replication改进这一点?</p>
<ol>
<li>让我们在执行更新语句的会话中启用streaming replication</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">SET</span> SESSION <span class="attribute">wsrep_trx_fragment_unit</span>=<span class="string">&#x27;rows&#x27;</span>;</span><br><span class="line"><span class="builtin-name">SET</span> SESSION <span class="attribute">wsrep_trx_fragment_size</span>=1000;</span><br></pre></td></tr></table></figure>
<p>基本上, 我们说集群应该将大事务分割成多个块, 每个块1000行, 然后在这些较小的块中进行复制.<code>wsrep_trx_fragment_unit</code>还可以设置为 ‘rows’ , ‘bytes’ 或 ‘statements’, 就是可以按行数, binlog字节数, 语句数量进行控制</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">wsrep_trx_fragment_unit</span></span><br></pre></td></tr></table></figure>
<p>Defines the replication unit type to use in Streaming Replication.</p>
<table>
<thead>
<tr>
<th>Command-line Format</th>
<th><code>--wsrep-trx-fragment-unit</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>System Variable</td>
<td><code>wsrep_trx_fragment_unit</code></td>
</tr>
<tr>
<td>Variable Scope</td>
<td>Session</td>
</tr>
<tr>
<td>Dynamic Variable</td>
<td>Yes</td>
</tr>
<tr>
<td>Permitted Values</td>
<td>String</td>
</tr>
<tr>
<td>Default Value</td>
<td><code>bytes</code></td>
</tr>
<tr>
<td>Valid Values</td>
<td><code>bytes</code>, <code>events</code>, <code>rows</code>, <code>statements</code></td>
</tr>
<tr>
<td>Initial Version</td>
<td>Version 4.0</td>
</tr>
</tbody>
</table>
<p>In <a href="https://galeracluster.com/library/documentation/glossary.html#term-streaming-replication">Streaming Replication</a>, the node breaks transactions down into fragments, then replicates and certifies them while the transaction is in progress. Once certified, a fragment can no longer be aborted due to conflicting transactions. This parameter determines the unit to use in determining the size of the fragment. To define the number of replication units to use in the fragment, use <a href="https://galeracluster.com/library/documentation/mysql-wsrep-options.html#wsrep-trx-fragment-size">wsrep_trx_fragment_size</a>.</p>
<p>Supported replication units are:</p>
<ul>
<li><strong>bytes</strong>: Refers to the fragment size in bytes.</li>
<li><strong>events</strong>: Refers to the number of binary log events in the fragment.</li>
<li><strong>rows</strong>: Refers to the number of rows updated in the fragment.</li>
<li><strong>statements</strong>: Refers to the number of SQL statements in the fragment.</li>
</ul>
</blockquote>
<p>And run the query:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql</span>&gt; update sbtest<span class="number">1</span> set k=k+<span class="number">1</span> limit <span class="number">1000000</span>;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">1000000</span> rows affected (<span class="number">39</span>.<span class="number">76</span> sec)</span><br><span class="line"><span class="attribute">Rows</span> matched: <span class="number">1000000</span>  Changed: <span class="number">1000000</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>In sysbench-tpcc:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="number">81</span>s ] thds: <span class="number">100</span> tps: <span class="number">6682.94</span> qps: <span class="number">188552.70</span> (r/w/o: <span class="number">85967.65</span>/<span class="number">89221.16</span>/<span class="number">13363.88</span>) lat (ms,<span class="number">95</span>%): <span class="number">26.68</span> err/s <span class="number">32.98</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">82</span>s ] thds: <span class="number">100</span> tps: <span class="number">6700.92</span> qps: <span class="number">192216.77</span> (r/w/o: <span class="number">87715.23</span>/<span class="number">91103.70</span>/<span class="number">13397.84</span>) lat (ms,<span class="number">95</span>%): <span class="number">27.17</span> err/s <span class="number">27.01</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">83</span>s ] thds: <span class="number">100</span> tps: <span class="number">3835.05</span> qps: <span class="number">108387.43</span> (r/w/o: <span class="number">49408.65</span>/<span class="number">51302.68</span>/<span class="number">7676.10</span>) lat (ms,<span class="number">95</span>%): <span class="number">82.96</span> err/s <span class="number">15.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">84</span>s ] thds: <span class="number">100</span> tps: <span class="number">2210.13</span> qps: <span class="number">63161.58</span> (r/w/o: <span class="number">28852.64</span>/<span class="number">29888.70</span>/<span class="number">4420.25</span>) lat (ms,<span class="number">95</span>%): <span class="number">95.81</span> err/s <span class="number">9.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">85</span>s ] thds: <span class="number">100</span> tps: <span class="number">2558.00</span> qps: <span class="number">72592.08</span> (r/w/o: <span class="number">33093.04</span>/<span class="number">34383.04</span>/<span class="number">5116.01</span>) lat (ms,<span class="number">95</span>%): <span class="number">87.56</span> err/s <span class="number">9.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">86</span>s ] thds: <span class="number">100</span> tps: <span class="number">2617.99</span> qps: <span class="number">75127.81</span> (r/w/o: <span class="number">34299.91</span>/<span class="number">35591.91</span>/<span class="number">5235.99</span>) lat (ms,<span class="number">95</span>%): <span class="number">78.60</span> err/s <span class="number">9.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">87</span>s ] thds: <span class="number">100</span> tps: <span class="number">2887.75</span> qps: <span class="number">81760.97</span> (r/w/o: <span class="number">37312.79</span>/<span class="number">38672.68</span>/<span class="number">5775.50</span>) lat (ms,<span class="number">95</span>%): <span class="number">73.13</span> err/s <span class="number">15.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">88</span>s ] thds: <span class="number">100</span> tps: <span class="number">3024.00</span> qps: <span class="number">84461.96</span> (r/w/o: <span class="number">38606.98</span>/<span class="number">39806.98</span>/<span class="number">6048.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">69.29</span> err/s <span class="number">15.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">89</span>s ] thds: <span class="number">100</span> tps: <span class="number">3119.27</span> qps: <span class="number">91128.99</span> (r/w/o: <span class="number">41566.65</span>/<span class="number">43323.80</span>/<span class="number">6238.55</span>) lat (ms,<span class="number">95</span>%): <span class="number">63.32</span> err/s <span class="number">9.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">90</span>s ] thds: <span class="number">100</span> tps: <span class="number">3385.74</span> qps: <span class="number">98314.42</span> (r/w/o: <span class="number">44883.54</span>/<span class="number">46659.40</span>/<span class="number">6771.48</span>) lat (ms,<span class="number">95</span>%): <span class="number">56.84</span> err/s <span class="number">14.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">91</span>s ] thds: <span class="number">100</span> tps: <span class="number">3641.08</span> qps: <span class="number">103916.20</span> (r/w/o: <span class="number">47422.00</span>/<span class="number">49212.04</span>/<span class="number">7282.15</span>) lat (ms,<span class="number">95</span>%): <span class="number">54.83</span> err/s <span class="number">21.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">92</span>s ] thds: <span class="number">100</span> tps: <span class="number">3850.12</span> qps: <span class="number">106013.43</span> (r/w/o: <span class="number">48296.56</span>/<span class="number">50021.62</span>/<span class="number">7695.25</span>) lat (ms,<span class="number">95</span>%): <span class="number">57.87</span> err/s <span class="number">23.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">93</span>s ] thds: <span class="number">100</span> tps: <span class="number">3828.07</span> qps: <span class="number">111682.90</span> (r/w/o: <span class="number">51005.87</span>/<span class="number">53015.90</span>/<span class="number">7661.13</span>) lat (ms,<span class="number">95</span>%): <span class="number">54.83</span> err/s <span class="number">22.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">94</span>s ] thds: <span class="number">100</span> tps: <span class="number">4358.95</span> qps: <span class="number">122173.63</span> (r/w/o: <span class="number">55746.37</span>/<span class="number">57709.35</span>/<span class="number">8717.90</span>) lat (ms,<span class="number">95</span>%): <span class="number">42.61</span> err/s <span class="number">14.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">95</span>s ] thds: <span class="number">100</span> tps: <span class="number">4367.09</span> qps: <span class="number">123297.63</span> (r/w/o: <span class="number">56193.20</span>/<span class="number">58370.24</span>/<span class="number">8734.19</span>) lat (ms,<span class="number">95</span>%): <span class="number">44.98</span> err/s <span class="number">16.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">96</span>s ] thds: <span class="number">100</span> tps: <span class="number">4272.92</span> qps: <span class="number">118822.67</span> (r/w/o: <span class="number">54076.94</span>/<span class="number">56201.90</span>/<span class="number">8543.83</span>) lat (ms,<span class="number">95</span>%): <span class="number">46.63</span> err/s <span class="number">24.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">97</span>s ] thds: <span class="number">100</span> tps: <span class="number">4697.88</span> qps: <span class="number">133071.68</span> (r/w/o: <span class="number">60676.49</span>/<span class="number">62997.43</span>/<span class="number">9397.77</span>) lat (ms,<span class="number">95</span>%): <span class="number">38.25</span> err/s <span class="number">17.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">98</span>s ] thds: <span class="number">100</span> tps: <span class="number">4742.21</span> qps: <span class="number">135167.87</span> (r/w/o: <span class="number">61693.68</span>/<span class="number">63989.78</span>/<span class="number">9484.41</span>) lat (ms,<span class="number">95</span>%): <span class="number">37.56</span> err/s <span class="number">21.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">99</span>s ] thds: <span class="number">100</span> tps: <span class="number">4949.89</span> qps: <span class="number">139343.00</span> (r/w/o: <span class="number">63616.63</span>/<span class="number">65826.58</span>/<span class="number">9899.79</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.24</span> err/s <span class="number">21.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">100</span>s ] thds: <span class="number">100</span> tps: <span class="number">4766.10</span> qps: <span class="number">139554.99</span> (r/w/o: <span class="number">63695.37</span>/<span class="number">66327.42</span>/<span class="number">9532.20</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.89</span> err/s <span class="number">18.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">101</span>s ] thds: <span class="number">100</span> tps: <span class="number">5069.91</span> qps: <span class="number">143318.44</span> (r/w/o: <span class="number">65310.83</span>/<span class="number">67867.79</span>/<span class="number">10139.82</span>) lat (ms,<span class="number">95</span>%): <span class="number">35.59</span> err/s <span class="number">13.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">102</span>s ] thds: <span class="number">100</span> tps: <span class="number">4947.06</span> qps: <span class="number">140053.63</span> (r/w/o: <span class="number">63820.74</span>/<span class="number">66338.77</span>/<span class="number">9894.12</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.24</span> err/s <span class="number">23.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">103</span>s ] thds: <span class="number">100</span> tps: <span class="number">5045.00</span> qps: <span class="number">145397.93</span> (r/w/o: <span class="number">66328.97</span>/<span class="number">68978.97</span>/<span class="number">10090.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.33</span> err/s <span class="number">18.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">104</span>s ] thds: <span class="number">100</span> tps: <span class="number">5139.02</span> qps: <span class="number">141954.54</span> (r/w/o: <span class="number">64723.25</span>/<span class="number">66953.25</span>/<span class="number">10278.04</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.24</span> err/s <span class="number">28.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">105</span>s ] thds: <span class="number">100</span> tps: <span class="number">5214.90</span> qps: <span class="number">147582.10</span> (r/w/o: <span class="number">67371.68</span>/<span class="number">69780.63</span>/<span class="number">10429.80</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.33</span> err/s <span class="number">25.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">106</span>s ] thds: <span class="number">100</span> tps: <span class="number">4924.08</span> qps: <span class="number">139603.33</span> (r/w/o: <span class="number">63673.06</span>/<span class="number">66082.10</span>/<span class="number">9848.16</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.24</span> err/s <span class="number">23.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">107</span>s ] thds: <span class="number">100</span> tps: <span class="number">5202.97</span> qps: <span class="number">147199.09</span> (r/w/o: <span class="number">67176.58</span>/<span class="number">69616.57</span>/<span class="number">10405.94</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.33</span> err/s <span class="number">30.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">108</span>s ] thds: <span class="number">100</span> tps: <span class="number">5219.91</span> qps: <span class="number">147677.47</span> (r/w/o: <span class="number">67416.84</span>/<span class="number">69820.80</span>/<span class="number">10439.82</span>) lat (ms,<span class="number">95</span>%): <span class="number">33.72</span> err/s <span class="number">28.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">109</span>s ] thds: <span class="number">100</span> tps: <span class="number">5018.99</span> qps: <span class="number">143211.61</span> (r/w/o: <span class="number">65365.82</span>/<span class="number">67808.81</span>/<span class="number">10036.97</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.24</span> err/s <span class="number">23.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">110</span>s ] thds: <span class="number">100</span> tps: <span class="number">5070.16</span> qps: <span class="number">142049.54</span> (r/w/o: <span class="number">64817.07</span>/<span class="number">67091.15</span>/<span class="number">10141.32</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.95</span> err/s <span class="number">17.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">111</span>s ] thds: <span class="number">100</span> tps: <span class="number">4954.87</span> qps: <span class="number">141476.26</span> (r/w/o: <span class="number">64529.29</span>/<span class="number">67037.23</span>/<span class="number">9909.74</span>) lat (ms,<span class="number">95</span>%): <span class="number">35.59</span> err/s <span class="number">25.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">112</span>s ] thds: <span class="number">100</span> tps: <span class="number">4827.12</span> qps: <span class="number">140426.46</span> (r/w/o: <span class="number">64103.58</span>/<span class="number">66668.64</span>/<span class="number">9654.24</span>) lat (ms,<span class="number">95</span>%): <span class="number">35.59</span> err/s <span class="number">19.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">113</span>s ] thds: <span class="number">100</span> tps: <span class="number">5027.00</span> qps: <span class="number">145229.08</span> (r/w/o: <span class="number">66179.04</span>/<span class="number">68996.04</span>/<span class="number">10054.01</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.33</span> err/s <span class="number">26.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">114</span>s ] thds: <span class="number">100</span> tps: <span class="number">5099.87</span> qps: <span class="number">144585.36</span> (r/w/o: <span class="number">65976.34</span>/<span class="number">68409.28</span>/<span class="number">10199.74</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.33</span> err/s <span class="number">26.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">115</span>s ] thds: <span class="number">100</span> tps: <span class="number">5010.11</span> qps: <span class="number">143316.08</span> (r/w/o: <span class="number">65356.40</span>/<span class="number">67939.46</span>/<span class="number">10020.22</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.95</span> err/s <span class="number">26.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">116</span>s ] thds: <span class="number">100</span> tps: <span class="number">5056.00</span> qps: <span class="number">143686.98</span> (r/w/o: <span class="number">65621.99</span>/<span class="number">67952.99</span>/<span class="number">10112.00</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.95</span> err/s <span class="number">31.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">117</span>s ] thds: <span class="number">100</span> tps: <span class="number">4908.95</span> qps: <span class="number">141669.49</span> (r/w/o: <span class="number">64653.31</span>/<span class="number">67198.28</span>/<span class="number">9817.90</span>) lat (ms,<span class="number">95</span>%): <span class="number">36.24</span> err/s <span class="number">21.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">118</span>s ] thds: <span class="number">100</span> tps: <span class="number">5039.07</span> qps: <span class="number">142667.01</span> (r/w/o: <span class="number">65056.92</span>/<span class="number">67531.95</span>/<span class="number">10078.14</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.33</span> err/s <span class="number">24.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">119</span>s ] thds: <span class="number">100</span> tps: <span class="number">5076.89</span> qps: <span class="number">143205.79</span> (r/w/o: <span class="number">65195.54</span>/<span class="number">67856.48</span>/<span class="number">10153.77</span>) lat (ms,<span class="number">95</span>%): <span class="number">35.59</span> err/s <span class="number">18.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">120</span>s ] thds: <span class="number">100</span> tps: <span class="number">4909.09</span> qps: <span class="number">137380.48</span> (r/w/o: <span class="number">62539.13</span>/<span class="number">65024.17</span>/<span class="number">9817.18</span>) lat (ms,<span class="number">95</span>%): <span class="number">34.95</span> err/s <span class="number">13.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">121</span>s ] thds: <span class="number">100</span> tps: <span class="number">5024.93</span> qps: <span class="number">144610.91</span> (r/w/o: <span class="number">66027.05</span>/<span class="number">68533.01</span>/<span class="number">10050.85</span>) lat (ms,<span class="number">95</span>%): <span class="number">35.59</span> err/s <span class="number">23.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">122</span>s ] thds: <span class="number">100</span> tps: <span class="number">4874.10</span> qps: <span class="number">138066.96</span> (r/w/o: <span class="number">62942.35</span>/<span class="number">65376.40</span>/<span class="number">9748.21</span>) lat (ms,<span class="number">95</span>%): <span class="number">35.59</span> err/s <span class="number">16.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">123</span>s ] thds: <span class="number">100</span> tps: <span class="number">6745.83</span> qps: <span class="number">187288.34</span> (r/w/o: <span class="number">85354.88</span>/<span class="number">88441.80</span>/<span class="number">13491.66</span>) lat (ms,<span class="number">95</span>%): <span class="number">28.67</span> err/s <span class="number">27.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">124</span>s ] thds: <span class="number">100</span> tps: <span class="number">6132.03</span> qps: <span class="number">172854.73</span> (r/w/o: <span class="number">78867.33</span>/<span class="number">81723.34</span>/<span class="number">12264.05</span>) lat (ms,<span class="number">95</span>%): <span class="number">29.19</span> err/s <span class="number">18.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">125</span>s ] thds: <span class="number">100</span> tps: <span class="number">6114.99</span> qps: <span class="number">175777.68</span> (r/w/o: <span class="number">80098.85</span>/<span class="number">83448.85</span>/<span class="number">12229.98</span>) lat (ms,<span class="number">95</span>%): <span class="number">30.26</span> err/s <span class="number">39.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">126</span>s ] thds: <span class="number">100</span> tps: <span class="number">6206.87</span> qps: <span class="number">179830.22</span> (r/w/o: <span class="number">82043.28</span>/<span class="number">85374.21</span>/<span class="number">12412.74</span>) lat (ms,<span class="number">95</span>%): <span class="number">29.72</span> err/s <span class="number">29.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">127</span>s ] thds: <span class="number">100</span> tps: <span class="number">6441.25</span> qps: <span class="number">181759.03</span> (r/w/o: <span class="number">82799.20</span>/<span class="number">86076.33</span>/<span class="number">12883.50</span>) lat (ms,<span class="number">95</span>%): <span class="number">28.67</span> err/s <span class="number">28.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">128</span>s ] thds: <span class="number">100</span> tps: <span class="number">5925.87</span> qps: <span class="number">169978.30</span> (r/w/o: <span class="number">77565.31</span>/<span class="number">80561.24</span>/<span class="number">11851.74</span>) lat (ms,<span class="number">95</span>%): <span class="number">30.81</span> err/s <span class="number">32.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">129</span>s ] thds: <span class="number">100</span> tps: <span class="number">6614.92</span> qps: <span class="number">186834.71</span> (r/w/o: <span class="number">85216.96</span>/<span class="number">88388.92</span>/<span class="number">13228.84</span>) lat (ms,<span class="number">95</span>%): <span class="number">27.66</span> err/s <span class="number">24.00</span> reconn/s: <span class="number">0.00</span></span><br></pre></td></tr></table></figure>
<p>so 这里发生了什么:</p>
<p>更新查询花了更长的时间(<strong>39秒</strong>而不是<strong>34秒</strong>).主要工作负载也受到了一些影响(从6700 tps下降到最坏时期的2210 tps), 但并没有完全停止, 这是一个巨大的改进.</p>
<p>为什么我们不应该默认为所有事务启用streaming replication?原因是它可能会对常规的小事务产生负面影响, 所以建议只对大型或长时间运行的事务使用streaming replication.</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;New-Feature-in-Percona-XtraDB-Cluster-8-0-–-Streaming-Replication&quot;&gt;&lt;a href=&quot;#New-Feature-in-Percona-XtraDB-Cluster-8-0-–-Streaming-Replication&quot; class=&quot;headerlink&quot; title=&quot;New Feature in Percona XtraDB Cluster 8.0 – Streaming Replication&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.percona.com/blog/2020/05/15/new-feature-in-percona-xtradb-cluster-8-0-streaming-replication/?utm_campaign=Blog%202016%3A%20Subscribers%20To%20Blog%20Weekly%20Recap%20Email%20--%202.15.16&amp;amp;utm_source=hs_email&amp;amp;utm_medium=email&amp;amp;utm_content=88003187&amp;amp;_hsenc=p2ANqtz-8AwEjtYpEuWSlNMk6OX4QGFsnPUWMEcW9o9FWOjQI_UGqkjKzcXPvfKm7evqRE0EuwXnrLs-tTDdcMby4ADbQWg5nLqw&amp;amp;_hsmi=88003187&quot;&gt;New Feature in Percona XtraDB Cluster 8.0 – Streaming Replication&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;Percona XtraDB Cluster 8.0附带了一个升级的Galera 4.0库, 它提供了一个新特性—&lt;a href=&quot;https://galeracluster.com/library/documentation/streaming-replication.html&quot;&gt;Streaming Replication&lt;/a&gt;.让我们回顾一下它是什么, 什么时候可能有用&lt;/p&gt;
&lt;p&gt;以前版本的Percona XtraDB集群和Galera 3.x在处理大事务方面有限制.&lt;/p&gt;
&lt;p&gt;让我们看一下sysbench-tpcc工作负载下的性能, 与此同时, 我们对一个表执行了一个大的更新语句, 该更新甚至与主工作负载中的表都不相关.&lt;br&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="PXC" scheme="http://fuxkdb.com/tags/PXC/"/>
    
      <category term="MySQL 8.0" scheme="http://fuxkdb.com/tags/MySQL-8-0/"/>
    
      <category term="Galera 4.0" scheme="http://fuxkdb.com/tags/Galera-4-0/"/>
    
  </entry>
  
  <entry>
    <title>译文 Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0</title>
    <link href="http://fuxkdb.com/2020/05/16/2020-05-16-%5B%E8%AF%91%E6%96%87%5DGalera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8.0/"/>
    <id>http://fuxkdb.com/2020/05/16/2020-05-16-[译文]Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8.0/</id>
    <published>2020-05-16T14:40:00.000Z</published>
    <updated>2020-05-16T15:06:34.937Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8-0"><a href="#Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8-0" class="headerlink" title="Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0"></a><a href="https://www.percona.com/blog/2020/05/13/galera-4-streaming-replication-in-percona-xtradb-cluster-8-0/?utm_campaign=Blog%202016%3A%20Subscribers%20To%20Blog%20Weekly%20Recap%20Email%20--%202.15.16&amp;utm_source=hs_email&amp;utm_medium=email&amp;utm_content=88003187&amp;_hsenc=p2ANqtz-8AwEjtYpEuWSlNMk6OX4QGFsnPUWMEcW9o9FWOjQI_UGqkjKzcXPvfKm7evqRE0EuwXnrLs-tTDdcMby4ADbQWg5nLqw&amp;_hsmi=88003187">Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0</a></h1><p>我正在测试最新的<a href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster">Percona XtraDB Cluster</a> 8.0 (PXC)版本, 其中包含了Galera 4插件, 我想分享一下到目前为止我在<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>特性方面的经验和想法, </p>
<h3 id="What-Is-Streaming-Replication-in-One-Sentence"><a href="#What-Is-Streaming-Replication-in-One-Sentence" class="headerlink" title="What Is Streaming Replication, in One Sentence?"></a>What Is Streaming Replication, in One Sentence?</h3><p>在Galera 4中, 大型事务可以分割成更小的片段, 甚至在提交之前, 这些片段就已经被复制到其他节点, 并且已经开始了认证(certification)和应用(apply)过程.</p>
<p>手册描述了所有的优点和缺点, 但是让我们看看它是如何工作的. 我已经创建了一个包含1千万行的表, 我将在这个表上运行一些大的update语句, </p>
<p>首先, 我在不使用Streaming Replication的情况下运行更新, 由于默认情况下Streaming Replication是disabled, 所以我们不需要做任何事情, 只需运行更新即可. 在<code>node1</code>上, 我记录更新之前和之后的时间, 在<code>node2</code>上, 我每秒钟运行一次select,   以查看这个更新在其他节点上实际提交的时间.<br><a id="more"></a><br>On the writer:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">node1-T1 mysql&gt; select now();update sbtest1 set k=1 where id &lt; 1000000;select now();</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| now()               |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| 2020-03-24 14:25:20 |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 999997 rows affected (34.53 sec)</span><br><span class="line">Rows matched: 999997 Changed: 999997 Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| now()               |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| 2020-03-24 14:25:54 |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>运行和这个update语句花费了大约34秒</p>
<p>Check the other node:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| now()               |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| 2020-03-24 14:26:22 |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line"><span class="code">+---+</span></span><br><span class="line">| k |</span><br><span class="line"><span class="code">+---+</span></span><br><span class="line">| 1 |</span><br><span class="line"><span class="code">+---+</span></span><br></pre></td></tr></table></figure>
<p>正如我所说, 我每秒钟都在运行一个查询, 以查看<code>k</code>何时变为1. <code>node2</code>花了<code>28秒</code>的时间来验证、应用和提交这个更新. 重要的是要理解, 当节点正在验证这个大更新时, 任何其他表上的所有其他更改都将被阻塞, 因此该节点将停滞/冻结近30秒.</p>
<h3 id="Will-Streaming-Replication-Decrease-This-Delay"><a href="#Will-Streaming-Replication-Decrease-This-Delay" class="headerlink" title="Will Streaming Replication Decrease This Delay?"></a>Will Streaming Replication Decrease This Delay?</h3><p>理论上, 其他节点应该可以更快地进行更新, 因为当更新在<code>node1</code>上运行时, 片段(fragments 指事务的部分binlog)已经被复制并应用到其他节点上, </p>
<p>我将把片段大小设置为1MB, </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> session wsrep_trx_fragment_size=<span class="number">1048576</span>;</span><br><span class="line"> </span><br><span class="line">node1-T1 mysql&gt; select now();update sbtest1 <span class="keyword">set</span> k=<span class="number">2</span> where id &lt; <span class="number">1000000</span>;select now();</span><br><span class="line">+---------------------+</span><br><span class="line">| now()               |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="number">2020</span><span class="number">-03</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">44</span>:<span class="number">08</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">Query OK, <span class="number">999997</span> rows affected (<span class="number">40.08</span> sec)</span><br><span class="line">Rows matched: <span class="number">999997</span> Changed: <span class="number">999997</span> Warnings: <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">+---------------------+</span><br><span class="line">| now()               |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="number">2020</span><span class="number">-03</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">44</span>:<span class="number">48</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>现在这个更新要跑40s, 我们看看其他节点.</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| now()               |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line">| 2020-03-24 14:44:48 |</span><br><span class="line"><span class="code">+---------------------+</span></span><br><span class="line"><span class="code">+---+</span></span><br><span class="line">| k |</span><br><span class="line"><span class="code">+---+</span></span><br><span class="line">| 2 |</span><br><span class="line"><span class="code">+---+</span></span><br></pre></td></tr></table></figure>
<p>在同一秒内, <code>k</code>在<code>node2</code>上也已经是<code>2</code>了, 我们不再有<code>28秒</code>的延迟, 这很好, 但是这个uupdate语句本身变慢了一点, 我多次运行这些更新, 在没有Streaming Replication的情况下总是更快, 但是对于大型事务, 我更喜欢流复制, 因为其他节点不会与写节点(执行更新语句的节点)差的太远.</p>
<h3 id="Why-Could-It-Be-Slower-With-Streaming-Replication"><a href="#Why-Could-It-Be-Slower-With-Streaming-Replication" class="headerlink" title="Why Could It Be Slower With Streaming Replication?"></a>Why Could It Be Slower With Streaming Replication?</h3><p>其中一个原因可能是, 使用<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>时, Galera基本上会写两份write-sets.它在mysql.wsrep_streaming_log中记录write-sets, 以确保在发生崩溃的情况下也可以进行Streaming Replication updates.这就是为什么为所有查询启用流复制不是一个好主意的原因.</p>
<h3 id="Does-the-Fragment-Size-Matter"><a href="#Does-the-Fragment-Size-Matter" class="headerlink" title="Does the Fragment Size Matter?"></a>Does the Fragment Size Matter?</h3><p>Let’s change the fragment size to 0.1MB:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">node1-T1 mysql&gt; <span class="keyword">set</span> session wsrep_trx_fragment_size=<span class="number">104857</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"> </span><br><span class="line">node1-T1 mysql&gt; select now();update sbtest1 <span class="keyword">set</span> k=<span class="number">5</span> where id &lt; <span class="number">1000000</span>;select now();</span><br><span class="line">+---------------------+</span><br><span class="line">| now()               |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="number">2020</span><span class="number">-03</span><span class="number">-24</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">30</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">Query OK, <span class="number">999997</span> rows affected (<span class="number">51.21</span> sec)</span><br><span class="line">Rows matched: <span class="number">999997</span> Changed: <span class="number">999997</span> Warnings: <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">+---------------------+</span><br><span class="line">| now()               |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="number">2020</span><span class="number">-03</span><span class="number">-24</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">21</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>现在花了50多秒钟, 因此我们可以看到gragment size很重要. 当我将片段大小增加到100MB时, 我也进行了测试, 在这种情况下, 查询又花了40秒钟左右, 但其他节点需要更多时间才能赶上, 差不多10秒钟左右.</p>
<p>找到正确的片段大小很重要, 在我的测试中1MB是可以接受的, 但是您也可以定义行数, 如每10000行之后创建片段.</p>
<h3 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h3><p>在Galera 4之前, 锁没有传播到其他节点. 如果您在<code>node1</code>上运行查询, 则InnoDB仅在<code>node1</code>上锁定了必要的行, 但是<code>node2</code>和<code>node3</code>不知道哪些行被锁定. 如果有人在写<code>node2</code>和<code>node3</code>, 那么Galera必须处理这些冲突, 基本上是先提交的事务获胜. 如果要在多个节点进行写入, 则可能会有很多冲突.</p>
<p>但随着Streaming Replication的出现, 这种情况也发生了变化.片段被复制到其他节点, 它们也将在那里持有必要的锁.</p>
<p><strong>Let’s see how this works, first without Streaming Replication, step by step.</strong></p>
<p>在<code>node1</code>和<code>node2</code>上启动事务, 在<code>node1</code>上运行大型更新, 在<code>node2</code>上删除单个行, 然后在<code>node2</code>上提交事务.当我在<code>node1</code>上提交时, 我得到一个死锁:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">node1</span>-T<span class="number">1</span> mysql&gt; begin;</span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; begin;</span><br><span class="line"></span><br><span class="line"><span class="attribute">node1</span>-T<span class="number">1</span> mysql&gt; update sbtest<span class="number">1</span> set k=<span class="number">8</span> where id &lt; <span class="number">1000000</span>;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">999997</span> rows affected (<span class="number">27</span>.<span class="number">87</span> sec)</span><br><span class="line"><span class="attribute">Rows</span> matched: <span class="number">999997</span> Changed: <span class="number">999997</span> Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; delete from sbtest<span class="number">1</span> where id=<span class="number">12</span>;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">1</span> row affected (<span class="number">0</span>.<span class="number">01</span> sec)</span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; commit;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="attribute">node1</span>-T<span class="number">1</span> mysql&gt; commit;</span><br><span class="line"><span class="attribute">ERROR</span> <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found when trying to get lock; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>因为没有集群范围的锁定, 所以在本例中, 它将使用乐观锁定, 并在认证过程中获得一个错误.</p>
<p><strong>How Does This Work With Streaming Replication?</strong></p>
<p>Repeat the same steps:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">node1</span>-T<span class="number">1</span> mysql&gt; set session wsrep_trx_fragment_size=<span class="number">1048570</span>;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"><span class="attribute">node1</span>-T<span class="number">1</span> mysql&gt; begin;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; begin;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; update sbtest<span class="number">1</span> set k=<span class="number">9</span> where id &lt; <span class="number">1000000</span>;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">999996</span> rows affected (<span class="number">38</span>.<span class="number">15</span> sec)</span><br><span class="line"><span class="attribute">Rows</span> matched: <span class="number">999996</span> Changed: <span class="number">999996</span> Warnings: <span class="number">0</span></span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; delete from sbtest<span class="number">1</span> where id=<span class="number">13</span>;</span><br><span class="line"><span class="attribute">Waiting</span>.....</span><br><span class="line"></span><br><span class="line"><span class="attribute">node1</span>-T<span class="number">1</span> mysql&gt; commit;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">2</span>.<span class="number">46</span> sec)</span><br><span class="line"><span class="attribute">node2</span>-T<span class="number">1</span> mysql&gt; commit;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">00</span> sec)</span><br></pre></td></tr></table></figure>
<p>同样的步骤, 但是当我们试图在<code>node2</code>上运行delete时, 它只是hang在那里, 等待获取锁, 但是被来自node1的更新语句产生的锁阻塞了, 这正是因为<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>.当我在<code>node1</code>上提交事务时, <code>node2</code>可以继续运行delete语句了.这可以将我们从许多僵局和冲突中解救出来.查询可能必须等待锁, 但最终它们仍然会完成.</p>
<p>这听起来很好, 但我仍然不建议将<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>作为默认设置启用, 因为它会影响性能, 而且它会将所有内容重复写入mysql.wsrep_streaming_log表.此外, 如果您想回滚一个大事务, 那么它必须在所有节点上执行, 而不是只在一个节点上执行.</p>
<h3 id="Metrics-Monitoring"><a href="#Metrics-Monitoring" class="headerlink" title="Metrics/Monitoring"></a>Metrics/Monitoring</h3><p>有一个表叫做<code>mysql.wsrep_streaming_log</code>, 其中包含关于当前正在运行的流的信息.</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node1-T1 mysql&gt; SELECT node<span class="emphasis">_uuid, trx_</span>id, seqno, flags FROM mysql.wsrep<span class="emphasis">_streaming_</span>log;</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------<span class="code">+-------+</span>-------+</span><br><span class="line">| node<span class="emphasis">_uuid                            | trx_</span>id | seqno | flags |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------<span class="code">+-------+</span>-------+</span><br><span class="line">| 9d7f7e09-6d20-11ea-842b-26b6d24e606d |   8571 | 24712 |     1 |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------<span class="code">+-------+</span>-------+</span><br></pre></td></tr></table></figure>
<p>但是要小心, 因为名为<code>frag</code>的列包含整个二进制日志复制事件, 这个事件可能非常大.在我意识到这一点之前, 我得到了以下错误:</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node1-T1 mysql&gt; select * from mysql.wsrep_streaming_log;</span><br><span class="line"><span class="keyword">ERROR </span>2020 (HY000): Got packet bigger than &#x27;max_allowed_packet&#x27; bytes</span><br></pre></td></tr></table></figure>
<p>不幸的是, 据我所知, 没有计数器来监视通过<a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>复制了多少语句.为此, 我创建了一个<a href="https://jira.percona.com/browse/PXC-3099">feature request</a>.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>到目前为止, <a href="https://galeracluster.com/library/documentation/streaming-replication.html">Streaming Replication</a>效果很好, 我认为它具有巨大的潜力. 因为我们可以在会话级启用它, 所以您自己或应用程序可以在需要时轻松打开它, but I am also waiting to see real-life experiences with it.</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8-0&quot;&gt;&lt;a href=&quot;#Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8-0&quot; class=&quot;headerlink&quot; title=&quot;Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.percona.com/blog/2020/05/13/galera-4-streaming-replication-in-percona-xtradb-cluster-8-0/?utm_campaign=Blog%202016%3A%20Subscribers%20To%20Blog%20Weekly%20Recap%20Email%20--%202.15.16&amp;amp;utm_source=hs_email&amp;amp;utm_medium=email&amp;amp;utm_content=88003187&amp;amp;_hsenc=p2ANqtz-8AwEjtYpEuWSlNMk6OX4QGFsnPUWMEcW9o9FWOjQI_UGqkjKzcXPvfKm7evqRE0EuwXnrLs-tTDdcMby4ADbQWg5nLqw&amp;amp;_hsmi=88003187&quot;&gt;Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;我正在测试最新的&lt;a href=&quot;https://www.percona.com/software/mysql-database/percona-xtradb-cluster&quot;&gt;Percona XtraDB Cluster&lt;/a&gt; 8.0 (PXC)版本, 其中包含了Galera 4插件, 我想分享一下到目前为止我在&lt;a href=&quot;https://galeracluster.com/library/documentation/streaming-replication.html&quot;&gt;Streaming Replication&lt;/a&gt;特性方面的经验和想法, &lt;/p&gt;
&lt;h3 id=&quot;What-Is-Streaming-Replication-in-One-Sentence&quot;&gt;&lt;a href=&quot;#What-Is-Streaming-Replication-in-One-Sentence&quot; class=&quot;headerlink&quot; title=&quot;What Is Streaming Replication, in One Sentence?&quot;&gt;&lt;/a&gt;What Is Streaming Replication, in One Sentence?&lt;/h3&gt;&lt;p&gt;在Galera 4中, 大型事务可以分割成更小的片段, 甚至在提交之前, 这些片段就已经被复制到其他节点, 并且已经开始了认证(certification)和应用(apply)过程.&lt;/p&gt;
&lt;p&gt;手册描述了所有的优点和缺点, 但是让我们看看它是如何工作的. 我已经创建了一个包含1千万行的表, 我将在这个表上运行一些大的update语句, &lt;/p&gt;
&lt;p&gt;首先, 我在不使用Streaming Replication的情况下运行更新, 由于默认情况下Streaming Replication是disabled, 所以我们不需要做任何事情, 只需运行更新即可. 在&lt;code&gt;node1&lt;/code&gt;上, 我记录更新之前和之后的时间, 在&lt;code&gt;node2&lt;/code&gt;上, 我每秒钟运行一次select,   以查看这个更新在其他节点上实际提交的时间.&lt;br&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
      <category term="PXC" scheme="http://fuxkdb.com/tags/PXC/"/>
    
      <category term="MySQL 8.0" scheme="http://fuxkdb.com/tags/MySQL-8-0/"/>
    
      <category term="Galera 4.0" scheme="http://fuxkdb.com/tags/Galera-4-0/"/>
    
  </entry>
  
  <entry>
    <title>译文-A Simple Approach to Troubleshooting High CPU in MySQL</title>
    <link href="http://fuxkdb.com/2020/05/03/2020-05-03-A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL/"/>
    <id>http://fuxkdb.com/2020/05/03/2020-05-03-A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL/</id>
    <published>2020-05-03T04:21:00.000Z</published>
    <updated>2020-05-03T04:27:52.057Z</updated>
    
    <content type="html"><![CDATA[<h1 id="A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL-在MySQL中对高CPU进行故障排除的简单方法"><a href="#A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL-在MySQL中对高CPU进行故障排除的简单方法" class="headerlink" title="A Simple Approach to Troubleshooting High CPU in MySQL - 在MySQL中对高CPU进行故障排除的简单方法"></a><a href="https://www.percona.com/blog/2020/04/23/a-simple-approach-to-troubleshooting-high-cpu-in-mysql/?utm_campaign=Blog%202016%3A%20Subscribers%20To%20Blog%20Weekly%20Recap%20Email%20--%202.15.16&amp;utm_source=hs_email&amp;utm_medium=email&amp;utm_content=86927141&amp;_hsenc=p2ANqtz-9FKmIBbxMf6uIKGVu8XOdzrDOdN3z9Pu3rppuxgjHmw0XPCCQ3GMztIb71uO4Zj60pTwMNwr1h6a3GDJQXK4cuZ5Xc3Q&amp;_hsmi=86927141">A Simple Approach to Troubleshooting High CPU in MySQL</a> - 在MySQL中对高CPU进行故障排除的简单方法</h1><p>我们的一位客户最近问，是否有可能从MySQL方面识别导致系统CPU使用率高的查询。 PostgreSQL和Oracle DBA长期以来一直使用简单的OS工具查找罪魁祸首，但是它对MySQL无效，因为历史上我们一直缺乏将OS线程与内部线程进行匹配的工具 - 直到最近。</p>
<p>Percona添加了支持，可从针对MySQL 5.6.27的Percona Server开始，通过information_schema.processlist表的TID列将进程列表ID映射到OS线程ID。 在5.7发行版中，MySQL扩展了PERFORMANCE_SCHEMA.THREADS表并添加了一个名为THREAD_OS_ID的新列，从而实现了自己的实现，Percona Server for MySQL代替了自己的列，因为它通常尽可能地靠近上游。 </p>
<p>对于在其他内核正常运行时查询使一个特定CPU过载的情况，以下方法很有用。 对于一般的CPU使用问题，可以使用不同的方法，例如另一篇博客文章<a href="https://www.percona.com/blog/2019/03/07/reducing-high-cpu-on-mysql-a-case-study/">Reducing High CPU on MySQL: A Case Study</a>的方法.<br><a id="more"></a></p>
<h2 id="我们如何使用这个新列来找出哪个会话使用了数据库中最多的CPU资源"><a href="#我们如何使用这个新列来找出哪个会话使用了数据库中最多的CPU资源" class="headerlink" title="我们如何使用这个新列来找出哪个会话使用了数据库中最多的CPU资源?"></a>我们如何使用这个新列来找出哪个会话使用了数据库中最多的CPU资源?</h2><p>让我们举个例子：</p>
<p>要解决CPU问题，我们可以使用几种工具，例如top或pidstat（需要sysstat程序包）。 在下面的示例中，我们将使用pidstat。 该工具有一个选项（-t），可将其视图从进程（默认值）更改为线程，在其中显示给定进程内的关联线程。 我们可以使用它来找出哪个线程在服务器中消耗了最多的CPU。 将-p参数与mysql进程ID一起添加，以便该工具仅显示MySQL线程，从而使我们更容易进行故障排除。 最后一个参数（1）是每秒显示一个样本：</p>
<p>命令为<code>pidstat -t -p &lt;mysqld_pid&gt; 1</code>：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">shell</span>&gt; pidstat -t -p <span class="number">31258</span> <span class="number">1</span></span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">06</span> PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">[...]</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32039</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">22</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32040</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">23</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32042</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">7</span>.<span class="number">00</span>     <span class="number">8</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32047</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>     <span class="number">6</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32048</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">15</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32049</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">14</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32052</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">14</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32053</span>   <span class="number">94</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">94</span>.<span class="number">00</span>     <span class="number">9</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">32055</span>    <span class="number">4</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">10</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4275</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">10</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4276</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>     <span class="number">7</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4277</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">7</span>.<span class="number">00</span>    <span class="number">15</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4278</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">18</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4279</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">10</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4280</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">12</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4281</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">11</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -      <span class="number">4282</span>    <span class="number">4</span>.<span class="number">00</span>    <span class="number">1</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">5</span>.<span class="number">00</span>     <span class="number">2</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">35261</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>     <span class="number">4</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">31</span>:<span class="number">07</span> PM <span class="number">10014</span>         -     <span class="number">36153</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>     <span class="number">5</span>  |__mysqld</span><br></pre></td></tr></table></figure>
<p>我们可以看到线程32053在很大程度上消耗了最多的CPU，并且我们确保验证了在pidstat的多个样本之间的消耗是否恒定。 利用这些信息，我们可以登录数据库，并使用以下查询来找出哪个MySQL Thread是罪魁祸首：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql</span> <span class="string">&gt;</span> <span class="string">select</span> <span class="string">*</span> <span class="string">from</span> <span class="string">performance_schema.threads</span> <span class="string">where</span> <span class="string">THREAD_OS_ID</span> <span class="string">=</span> <span class="number">32053</span> <span class="string">\G</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1</span><span class="string">.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line">          <span class="attr">THREAD_ID:</span> <span class="number">686</span></span><br><span class="line">               <span class="attr">NAME:</span> <span class="string">thread/sql/one_connection</span></span><br><span class="line">               <span class="attr">TYPE:</span> <span class="string">FOREGROUND</span></span><br><span class="line">     <span class="attr">PROCESSLIST_ID:</span> <span class="number">590</span></span><br><span class="line">   <span class="attr">PROCESSLIST_USER:</span> <span class="string">msandbox</span></span><br><span class="line">   <span class="attr">PROCESSLIST_HOST:</span> <span class="string">localhost</span></span><br><span class="line">     <span class="attr">PROCESSLIST_DB:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">PROCESSLIST_COMMAND:</span> <span class="string">Query</span></span><br><span class="line">   <span class="attr">PROCESSLIST_TIME:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">PROCESSLIST_STATE:</span> <span class="string">Sending</span> <span class="string">data</span></span><br><span class="line">   <span class="attr">PROCESSLIST_INFO:</span> <span class="string">select</span> <span class="string">*</span> <span class="string">from</span> <span class="string">test.joinit</span> <span class="string">where</span> <span class="string">b</span> <span class="string">=</span> <span class="string">&#x27;a a eveniet ut.&#x27;</span></span><br><span class="line">   <span class="attr">PARENT_THREAD_ID:</span> <span class="literal">NULL</span></span><br><span class="line">               <span class="attr">ROLE:</span> <span class="literal">NULL</span></span><br><span class="line">       <span class="attr">INSTRUMENTED:</span> <span class="literal">YES</span></span><br><span class="line">            <span class="attr">HISTORY:</span> <span class="literal">YES</span></span><br><span class="line">    <span class="attr">CONNECTION_TYPE:</span> <span class="string">SSL/TLS</span></span><br><span class="line">       <span class="attr">THREAD_OS_ID:</span> <span class="number">32053</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure>
<p>好了！ 现在我们知道，CPU高消耗来自joinit表中的查询，该查询由数据库测试中来自本地主机的用户msandbox执行。 使用此信息，我们可以对查询进行故障排除，并使用EXPLAIN命令检查执行计划，以查看是否还有任何改进的余地。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql</span> <span class="string">&gt;</span> <span class="string">explain</span> <span class="string">select</span> <span class="string">*</span> <span class="string">from</span> <span class="string">test.joinit</span> <span class="string">where</span> <span class="string">b</span> <span class="string">=</span> <span class="string">&#x27;a a eveniet ut.&#x27;</span> <span class="string">\G</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1</span><span class="string">.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line">           <span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">select_type:</span> <span class="string">SIMPLE</span></span><br><span class="line">        <span class="attr">table:</span> <span class="string">joinit</span></span><br><span class="line">   <span class="attr">partitions:</span> <span class="literal">NULL</span></span><br><span class="line">         <span class="attr">type:</span> <span class="string">ALL</span></span><br><span class="line"><span class="attr">possible_keys:</span> <span class="literal">NULL</span></span><br><span class="line">          <span class="attr">key:</span> <span class="literal">NULL</span></span><br><span class="line">      <span class="attr">key_len:</span> <span class="literal">NULL</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="literal">NULL</span></span><br><span class="line">         <span class="attr">rows:</span> <span class="number">7170836</span></span><br><span class="line">     <span class="attr">filtered:</span> <span class="number">10.00</span></span><br><span class="line">        <span class="attr">Extra:</span> <span class="string">Using</span> <span class="string">where</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set,</span> <span class="number">1</span> <span class="string">warning</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure>
<p>In this case, it was a simple index that was missing!</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql</span> &gt; alter table test.joinit add index (b) ;</span><br><span class="line"><span class="attribute">Query</span> OK, <span class="number">0</span> rows affected (<span class="number">15</span>.<span class="number">18</span> sec)</span><br><span class="line"><span class="attribute">Records</span>: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>After we create the index, we are no longer seeing CPU spikes:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">shell</span>&gt; pidstat -t -p <span class="number">31258</span> <span class="number">1</span></span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">53</span> PM   UID      TGID       TID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">[...]</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32039</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">31</span>.<span class="number">00</span>     <span class="number">0</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32040</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">30</span>.<span class="number">00</span>    <span class="number">21</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32042</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">31</span>.<span class="number">00</span>    <span class="number">20</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32047</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">4</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">29</span>.<span class="number">00</span>    <span class="number">23</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32048</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">7</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">32</span>.<span class="number">00</span>    <span class="number">22</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32049</span>   <span class="number">23</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">29</span>.<span class="number">00</span>     <span class="number">4</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32052</span>   <span class="number">23</span>.<span class="number">00</span>    <span class="number">7</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">30</span>.<span class="number">00</span>    <span class="number">14</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32053</span>   <span class="number">10</span>.<span class="number">00</span>    <span class="number">2</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">12</span>.<span class="number">00</span>    <span class="number">11</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">32055</span>   <span class="number">24</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">30</span>.<span class="number">00</span>     <span class="number">1</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4275</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">31</span>.<span class="number">00</span>     <span class="number">7</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4276</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">31</span>.<span class="number">00</span>     <span class="number">1</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4277</span>   <span class="number">24</span>.<span class="number">00</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">29</span>.<span class="number">00</span>    <span class="number">14</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4278</span>   <span class="number">24</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">30</span>.<span class="number">00</span>     <span class="number">9</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4279</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">30</span>.<span class="number">00</span>     <span class="number">6</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4280</span>   <span class="number">26</span>.<span class="number">00</span>    <span class="number">5</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">31</span>.<span class="number">00</span>    <span class="number">14</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4281</span>   <span class="number">24</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">30</span>.<span class="number">00</span>    <span class="number">10</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -      <span class="number">4282</span>   <span class="number">25</span>.<span class="number">00</span>    <span class="number">6</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>   <span class="number">31</span>.<span class="number">00</span>    <span class="number">10</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">35261</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>     <span class="number">4</span>  |__mysqld</span><br><span class="line"><span class="attribute">03</span>:<span class="number">37</span>:<span class="number">54</span> PM <span class="number">10014</span>         -     <span class="number">36153</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>    <span class="number">0</span>.<span class="number">00</span>     <span class="number">5</span>  |__mysqld</span><br></pre></td></tr></table></figure>
<h2 id="为什么不使用这种方法来解决IO和内存问题"><a href="#为什么不使用这种方法来解决IO和内存问题" class="headerlink" title="为什么不使用这种方法来解决IO和内存问题?"></a>为什么不使用这种方法来解决IO和内存问题?</h2><p>从OS端测量线程IO的问题在于，大多数MySQL IO操作是由后台线程完成的，例如读取，写入和页面清理程序线程。 要测量线程IO，您可以使用带有-d（IO而不是CPU）选项的pidstat或带有-H（每个线程）的iostat之类的工具。 如果您有一个非常消耗IO的线程，您也许可以看到它，但是要警告，由于后台线程操作，结果可能会产生误导。</p>
<p>内存消耗是要从OS端衡量的一个更加棘手的资源，因为所有内存都是在MySQL进程下分配的，并且由于是MySQL管理其内存访问，因此对于OS来说哪个线程消耗最多的内存是透明的。 为此，我们可以使用从5.7开始使用<a href="https://dev.mysql.com/doc/refman/5.7/en/memory-summary-tables.html">perfomance_schema memory instrumentation available starting in 5.7</a>.</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>有很多方法可以解决CPU使用率过高的问题，但是从5.7版开始，我们在Oracle和PostgreSQL数据库上提供了一种简单且广泛使用的方法，该方法可以适应MySQL。 通过从OS线程消耗跟踪到数据库端，我们可以快速检测到影响系统性能的CPU密集型查询。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL-在MySQL中对高CPU进行故障排除的简单方法&quot;&gt;&lt;a href=&quot;#A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL-在MySQL中对高CPU进行故障排除的简单方法&quot; class=&quot;headerlink&quot; title=&quot;A Simple Approach to Troubleshooting High CPU in MySQL - 在MySQL中对高CPU进行故障排除的简单方法&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://www.percona.com/blog/2020/04/23/a-simple-approach-to-troubleshooting-high-cpu-in-mysql/?utm_campaign=Blog%202016%3A%20Subscribers%20To%20Blog%20Weekly%20Recap%20Email%20--%202.15.16&amp;amp;utm_source=hs_email&amp;amp;utm_medium=email&amp;amp;utm_content=86927141&amp;amp;_hsenc=p2ANqtz-9FKmIBbxMf6uIKGVu8XOdzrDOdN3z9Pu3rppuxgjHmw0XPCCQ3GMztIb71uO4Zj60pTwMNwr1h6a3GDJQXK4cuZ5Xc3Q&amp;amp;_hsmi=86927141&quot;&gt;A Simple Approach to Troubleshooting High CPU in MySQL&lt;/a&gt; - 在MySQL中对高CPU进行故障排除的简单方法&lt;/h1&gt;&lt;p&gt;我们的一位客户最近问，是否有可能从MySQL方面识别导致系统CPU使用率高的查询。 PostgreSQL和Oracle DBA长期以来一直使用简单的OS工具查找罪魁祸首，但是它对MySQL无效，因为历史上我们一直缺乏将OS线程与内部线程进行匹配的工具 - 直到最近。&lt;/p&gt;
&lt;p&gt;Percona添加了支持，可从针对MySQL 5.6.27的Percona Server开始，通过information_schema.processlist表的TID列将进程列表ID映射到OS线程ID。 在5.7发行版中，MySQL扩展了PERFORMANCE_SCHEMA.THREADS表并添加了一个名为THREAD_OS_ID的新列，从而实现了自己的实现，Percona Server for MySQL代替了自己的列，因为它通常尽可能地靠近上游。 &lt;/p&gt;
&lt;p&gt;对于在其他内核正常运行时查询使一个特定CPU过载的情况，以下方法很有用。 对于一般的CPU使用问题，可以使用不同的方法，例如另一篇博客文章&lt;a href=&quot;https://www.percona.com/blog/2019/03/07/reducing-high-cpu-on-mysql-a-case-study/&quot;&gt;Reducing High CPU on MySQL: A Case Study&lt;/a&gt;的方法.&lt;br&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://fuxkdb.com/tags/MySQL/"/>
    
  </entry>
  
</feed>
