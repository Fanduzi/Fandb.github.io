<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>proxysql平滑下线节点 | Fan()</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ProxySQL" />
  
  
  
  
  <meta name="description" content="ProxySQL平滑下线节点因为MGR多主DDL和DML不能并发在不同节点执行, 而我们又存在即通过KO又通过ProxySQL访问的数据库的情况, 为了避免在发生故障, 我们决定将ProxySQL中配置的集群真实ip删除, 改为使用KO的vip.本文介绍如何平滑下线ProxySQL节点, 从而做到对业务无感知.  KO我司自研php中间件  环境介绍   10.133.x.59 跑sysbench">
<meta property="og:type" content="article">
<meta property="og:title" content="ProxySQL平滑下线节点">
<meta property="og:url" content="http://fuxkdb.com/2019/11/12/2019-11-12-ProxySQL%E5%B9%B3%E6%BB%91%E4%B8%8B%E7%BA%BF%E8%8A%82%E7%82%B9/index.html">
<meta property="og:site_name" content="Fan()">
<meta property="og:description" content="ProxySQL平滑下线节点因为MGR多主DDL和DML不能并发在不同节点执行, 而我们又存在即通过KO又通过ProxySQL访问的数据库的情况, 为了避免在发生故障, 我们决定将ProxySQL中配置的集群真实ip删除, 改为使用KO的vip.本文介绍如何平滑下线ProxySQL节点, 从而做到对业务无感知.  KO我司自研php中间件  环境介绍   10.133.x.59 跑sysbench">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-12T13:57:00.000Z">
<meta property="article:modified_time" content="2019-11-13T15:19:00.000Z">
<meta property="article:author" content="大范">
<meta property="article:tag" content="ProxySQL">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Fan()" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpeg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpeg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("/css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("/css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("/css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

<meta name="generator" content="Hexo 6.2.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpeg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2019-11-12-ProxySQL平滑下线节点" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ProxySQL平滑下线节点
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/12/2019-11-12-ProxySQL%E5%B9%B3%E6%BB%91%E4%B8%8B%E7%BA%BF%E8%8A%82%E7%82%B9/" class="article-date">
	  <time datetime="2019-11-12T13:57:00.000Z" itemprop="datePublished">2019-11-12</time>
	</a>

      
      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ProxySQL平滑下线节点"><a href="#ProxySQL平滑下线节点" class="headerlink" title="ProxySQL平滑下线节点"></a>ProxySQL平滑下线节点</h1><p>因为MGR多主DDL和DML不能并发在不同节点执行, 而我们又存在即通过KO又通过ProxySQL访问的数据库的情况, 为了避免在发生故障, 我们决定将ProxySQL中配置的集群真实ip删除, 改为使用KO的vip.<br>本文介绍如何平滑下线ProxySQL节点, 从而做到对业务无感知.</p>
<blockquote>
<p>KO我司自研php中间件</p>
</blockquote>
<h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><table>
<thead>
<tr>
<th>10.133.x.59</th>
<th>跑sysbench</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.133.x.52:3307</td>
<td>测试集群节点</td>
</tr>
<tr>
<td>10.133.x.53:3307</td>
<td>测试集群节点</td>
</tr>
<tr>
<td>10.133.x.54:3307</td>
<td>测试集群节点</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>VIP</th>
<th>访问类型</th>
<th>所在服务器</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.133.x.202</td>
<td>KO</td>
<td>10.133.x.202</td>
</tr>
<tr>
<td>10.133.x.203</td>
<td>ProxySQL</td>
<td>10.133.x.203</td>
</tr>
</tbody>
</table>
<p>ProxySQL版本<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">admin@127.0.0.1 23:12:02 [(none)]&gt; select version();</span><br><span class="line"><span class="code">+-------------------+</span></span><br><span class="line">| version() |</span><br><span class="line"><span class="code">+-------------------+</span></span><br><span class="line">| 2.0.8-67-g877cab1 |</span><br><span class="line"><span class="code">+-------------------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><br>MySQL版本<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost 23:17:56 [(none)]&gt; select version();</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">| version() |</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">| 5.7.26-log |</span><br><span class="line"><span class="code">+------------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="错误的下线方式"><a href="#错误的下线方式" class="headerlink" title="错误的下线方式"></a>错误的下线方式</h2><p>1.59跑压测<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># cat sysbench_by_proxysql.sh </span><br><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua  --mysql-user=sysbench_user --mysql-password=superSecret --mysql-port=<span class="number">16034</span> \</span><br><span class="line">--mysql-host=<span class="number">10.133</span>.x<span class="number">.203</span> \</span><br><span class="line">--mysql-db=sysbench  --tables=<span class="number">10</span> --table-size=<span class="number">5000000</span>  --threads=$<span class="number">1</span> \</span><br><span class="line">--events=<span class="number">5000000</span> --report-<span class="built_in">int</span>erval=<span class="number">5</span> --db-driver=mysql --time=$<span class="number">2</span> run</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># sh sysbench_by_proxysql.sh <span class="number">16</span> <span class="number">1800</span></span><br><span class="line"></span><br><span class="line">[ <span class="number">5</span>s ] thds: <span class="number">16</span> tps: <span class="number">1125.70</span> qps: <span class="number">22546.06</span> (r/w/o: <span class="number">15787.64</span>/<span class="number">4503.82</span>/<span class="number">2254.61</span>) lat (ms,<span class="number">95</span>%): <span class="number">15.55</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">10</span>s ] thds: <span class="number">16</span> tps: <span class="number">1125.31</span> qps: <span class="number">22516.34</span> (r/w/o: <span class="number">15762.30</span>/<span class="number">4503.43</span>/<span class="number">2250.61</span>) lat (ms,<span class="number">95</span>%): <span class="number">15.55</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">15</span>s ] thds: <span class="number">16</span> tps: <span class="number">1127.13</span> qps: <span class="number">22542.62</span> (r/w/o: <span class="number">15778.83</span>/<span class="number">4509.72</span>/<span class="number">2254.06</span>) lat (ms,<span class="number">95</span>%): <span class="number">15.55</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[ <span class="number">20</span>s ] thds: <span class="number">16</span> tps: <span class="number">1130.82</span> qps: <span class="number">22613.98</span> (r/w/o: <span class="number">15829.67</span>/<span class="number">4522.48</span>/<span class="number">2261.84</span>) lat (ms,<span class="number">95</span>%): <span class="number">15.55</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>查看ProxySQL vip所在节点的ProxySQL配置<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="meta">@127.0.0.1</span> 17:58:46 [(none)]&gt; select <span class="symbol">*</span> from runtime_mysql_servers;</span><br><span class="line">+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">|<span class="string"> hostgroup_id </span>|<span class="string"> hostname    </span>|<span class="string"> port </span>|<span class="string"> gtid_port </span>|<span class="string"> status </span>|<span class="string"> weight </span>|<span class="string"> compression </span>|<span class="string"> max_connections </span>|<span class="string"> max_replication_lag </span>|<span class="string"> use_ssl </span>|<span class="string"> max_latency_ms </span>|<span class="string"> comment </span>|</span><br><span class="line">+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">|<span class="string"> 10           </span>|<span class="string"> 10.133.x.53 </span>|<span class="string"> 3307 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE </span>|<span class="string"> 3      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 10.133.x.54 </span>|<span class="string"> 3307 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE </span>|<span class="string"> 1      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 10.133.x.52 </span>|<span class="string"> 3307 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE </span>|<span class="string"> 2      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string">         </span>|</span><br><span class="line">+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line"></span><br><span class="line">admin<span class="meta">@127.0.0.1</span> 18:00:31 [(none)]&gt; select <span class="symbol">*</span> from mysql_servers;</span><br><span class="line">+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">|<span class="string"> hostgroup_id </span>|<span class="string"> hostname    </span>|<span class="string"> port </span>|<span class="string"> gtid_port </span>|<span class="string"> status </span>|<span class="string"> weight </span>|<span class="string"> compression </span>|<span class="string"> max_connections </span>|<span class="string"> max_replication_lag </span>|<span class="string"> use_ssl </span>|<span class="string"> max_latency_ms </span>|<span class="string"> comment </span>|</span><br><span class="line">+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">|<span class="string"> 10           </span>|<span class="string"> 10.133.x.53 </span>|<span class="string"> 3307 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE </span>|<span class="string"> 3      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 10.133.x.52 </span>|<span class="string"> 3307 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE </span>|<span class="string"> 2      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string">         </span>|</span><br><span class="line">|<span class="string"> 11           </span>|<span class="string"> 10.133.x.54 </span>|<span class="string"> 3307 </span>|<span class="string"> 0         </span>|<span class="string"> ONLINE </span>|<span class="string"> 1      </span>|<span class="string"> 0           </span>|<span class="string"> 1000            </span>|<span class="string"> 0                   </span>|<span class="string"> 0       </span>|<span class="string"> 0              </span>|<span class="string">         </span>|</span><br><span class="line">+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br></pre></td></tr></table></figure><br>我们打算添加KO vip到mysql server中, 所以一开始我尝试删除mysql servers所有配置, 然后插入10.133.x.202:3307<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">01</span>:<span class="number">37</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">00</span>:<span class="number">49</span> [(none)]&gt; delete <span class="keyword">from</span> mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">01</span>:<span class="number">37</span>]Query OK, <span class="number">3</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">01</span>:<span class="number">37</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">16</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">01</span>:<span class="number">37</span> [(none)]&gt; insert <span class="built_in">int</span>o mysql_servers values(<span class="number">10</span>,<span class="string">&#x27;10.133.x.202&#x27;</span>,<span class="number">3307</span>,<span class="number">0</span>,<span class="string">&#x27;ONLINE&#x27;</span>,<span class="number">10</span>,<span class="number">0</span>,<span class="number">1000</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">16</span>]Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">16</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">16</span> [(none)]&gt; select * <span class="keyword">from</span> mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]| hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">10</span>     | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span>]</span><br></pre></td></tr></table></figure><br>加载配置到runtime, 使配置真正生效<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">43</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">19</span> [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">43</span>]Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">43</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">43</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]| hostgroup_id | hostname     | port | gtid_port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE       | <span class="number">10</span>     | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_HARD | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]<span class="number">2</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">44</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]| hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">10</span>     | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">45</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]| hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">10</span>     | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">46</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>此时查看sysbench, 发现在配置加载后, 连接立马报错.<br>显然, 如果以这种方式在生产环境下线节点, 业务肯定是不可以接受的<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[2019-11-12 18:03:40][ 180s ] thds: 16 tps: 1134.87 qps: 22716.96 (r/w/o: 15904.95/4542.07/2269.94) lat (ms,95%): 15.55 err/s: 0.00 reconn/s: 0.00</span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;SELECT c FROM sbtest7 WHERE id=?&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;</span>COMMIT<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;</span>SELECT DISTINCT c <span class="keyword">FROM</span> sbtest3 WHERE id BETWEEN ? <span class="keyword">AND</span> ? ORDER BY c<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;</span>SELECT c <span class="keyword">FROM</span> sbtest6 WHERE id BETWEEN ? <span class="keyword">AND</span> ?<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: `thread_run&#x27;</span> function failed: /usr/share/sysbench/oltp_common.lua:409: SQL error, errno = 2013, state = <span class="string">&#x27;HY000&#x27;</span>: Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query</span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;SELECT c FROM sbtest8 WHERE id=?&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;SELECT c FROM sbtest6 WHERE id=?&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43](last message repeated 2 times)</span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;UPDATE sbtest8 SET c=? WHERE id=?&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;SELECT c FROM sbtest2 WHERE id=?&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: `thread_run&#x27;</span> function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = <span class="string">&#x27;HY000&#x27;</span>: Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query</span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: `thread_run&#x27;</span> function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = <span class="string">&#x27;HY000&#x27;</span>: Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query</span><br><span class="line">[2019-11-12 18:03:43](last message repeated 3 times)</span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:469: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;</span>SELECT c <span class="keyword">FROM</span> sbtest1 WHERE id BETWEEN ? <span class="keyword">AND</span> ?<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: `thread_run&#x27;</span> function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = <span class="string">&#x27;HY000&#x27;</span>: Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query</span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;COMMIT&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:409: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;</span>SELECT DISTINCT c <span class="keyword">FROM</span> sbtest8 WHERE id BETWEEN ? <span class="keyword">AND</span> ? ORDER BY c<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: `thread_run&#x27;</span> function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = <span class="string">&#x27;HY000&#x27;</span>: Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query</span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;SELECT c FROM sbtest8 WHERE id=?&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;</span>DELETE <span class="keyword">FROM</span> sbtest2 WHERE <span class="attribute">id</span>=?&#x27;</span><br><span class="line">[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned <span class="builtin-name">error</span> 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query) <span class="keyword">for</span> query <span class="string">&#x27;SELECT DISTINCT c FROM sbtest1 WHERE id BETWEEN ? AND ? ORDER BY c&#x27;</span></span><br><span class="line">[2019-11-12 18:03:43]FATAL: `thread_run<span class="string">&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;</span>HY000<span class="string">&#x27;: Lost connection to MySQL server during query</span></span><br><span class="line"><span class="string">[2019-11-12 18:03:43]FATAL: `thread_run&#x27;</span> function failed: /usr/share/sysbench/oltp_common.lua:487: SQL error, errno = 2013, state = <span class="string">&#x27;HY000&#x27;</span>: Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>during query</span><br><span class="line">[2019-11-12 18:03:48]<span class="builtin-name">Error</span> <span class="keyword">in</span> my_thread_global_end(): 16 threads didn<span class="string">&#x27;t exit</span></span><br></pre></td></tr></table></figure></p>
<h2 id="正确的下线方式"><a href="#正确的下线方式" class="headerlink" title="正确的下线方式"></a>正确的下线方式</h2><p>1.59跑sysbench<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>][<span class="symbol">root@</span>node10<span class="number">-133</span><span class="number">-1</span><span class="number">-59</span> fanboshi]# sh sysbench_by_proxysql.sh <span class="number">4</span> <span class="number">1800</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]sysbench <span class="number">1.0</span><span class="number">.18</span> (using bundled LuaJIT <span class="number">2.1</span><span class="number">.0</span>-beta2)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]Running the test with following options:</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]Number of threads: <span class="number">4</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]Report <span class="built_in">int</span>ermediate results every <span class="number">5</span> second(s)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]Initializing random number generator <span class="keyword">from</span> current time</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]Initializing worker threads...</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]Threads started!</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">03</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">08</span>][ <span class="number">5</span>s ] thds: <span class="number">4</span> tps: <span class="number">329.27</span> qps: <span class="number">6592.58</span> (r/w/o: <span class="number">4615.37</span>/<span class="number">1317.88</span>/<span class="number">659.34</span>) lat (ms,<span class="number">95</span>%): <span class="number">13.95</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">13</span>][ <span class="number">10</span>s ] thds: <span class="number">4</span> tps: <span class="number">339.83</span> qps: <span class="number">6799.25</span> (r/w/o: <span class="number">4760.65</span>/<span class="number">1358.93</span>/<span class="number">679.66</span>) lat (ms,<span class="number">95</span>%): <span class="number">12.98</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">18</span>][ <span class="number">15</span>s ] thds: <span class="number">4</span> tps: <span class="number">338.36</span> qps: <span class="number">6768.12</span> (r/w/o: <span class="number">4736.98</span>/<span class="number">1354.42</span>/<span class="number">676.71</span>) lat (ms,<span class="number">95</span>%): <span class="number">13.22</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">23</span>][ <span class="number">20</span>s ] thds: <span class="number">4</span> tps: <span class="number">335.65</span> qps: <span class="number">6714.51</span> (r/w/o: <span class="number">4700.84</span>/<span class="number">1342.38</span>/<span class="number">671.29</span>) lat (ms,<span class="number">95</span>%): <span class="number">13.22</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">28</span>][ <span class="number">25</span>s ] thds: <span class="number">4</span> tps: <span class="number">336.79</span> qps: <span class="number">6734.32</span> (r/w/o: <span class="number">4713.01</span>/<span class="number">1347.94</span>/<span class="number">673.37</span>) lat (ms,<span class="number">95</span>%): <span class="number">13.46</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">33</span>][ <span class="number">30</span>s ] thds: <span class="number">4</span> tps: <span class="number">340.61</span> qps: <span class="number">6812.86</span> (r/w/o: <span class="number">4770.58</span>/<span class="number">1360.85</span>/<span class="number">681.43</span>) lat (ms,<span class="number">95</span>%): <span class="number">12.98</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">38</span>][ <span class="number">35</span>s ] thds: <span class="number">4</span> tps: <span class="number">339.20</span> qps: <span class="number">6779.83</span> (r/w/o: <span class="number">4745.02</span>/<span class="number">1356.41</span>/<span class="number">678.40</span>) lat (ms,<span class="number">95</span>%): <span class="number">13.46</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>1.52插入KO VIP, 修改其他节点状态为<code>OFFLINE_SOFT</code><br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">58</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">28</span> [(none)]&gt; insert <span class="built_in">int</span>o mysql_servers values(<span class="number">10</span>,<span class="string">&#x27;10.133.x.202&#x27;</span>,<span class="number">3307</span>,<span class="number">0</span>,<span class="string">&#x27;ONLINE&#x27;</span>,<span class="number">100</span>,<span class="number">0</span>,<span class="number">1000</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">58</span>]Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">58</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">58</span> [(none)]&gt; select * <span class="keyword">from</span> mysql_servers;       </span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]| hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span>  | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span>  | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]<span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">03</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">04</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]| hostgroup_id | hostname    | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]<span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">14</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">08</span> [(none)]&gt; update mysql_servers <span class="keyword">set</span> status=<span class="string">&#x27;OFFLINE_SOFT&#x27;</span> where hostname!=<span class="string">&#x27;10.133.x.202&#x27;</span>;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">14</span>]Query OK, <span class="number">3</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">14</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">14</span> [(none)]&gt; select * <span class="keyword">from</span> mysql_servers;       </span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]| hostgroup_id | hostname     | port | gtid_port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE       | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]<span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">18</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]| hostgroup_id | hostname    | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">22</span>]<span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><br>加载配置到runtime<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">47</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">28</span> [(none)]&gt; load mysql servers to runtime;  </span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">47</span>]Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">47</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">47</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]| hostgroup_id | hostname     | port | gtid_port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE       | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]<span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span>]</span><br></pre></td></tr></table></figure></p>
<p>查看sysbench, 正常运行连接无异常<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">23</span>][ <span class="number">80</span>s ] thds: <span class="number">4</span> tps: <span class="number">332.59</span> qps: <span class="number">6646.37</span> (r/w/o: <span class="number">4651.64</span>/<span class="number">1329.75</span>/<span class="number">664.98</span>) lat (ms,<span class="number">95</span>%): <span class="number">12.98</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">28</span>][ <span class="number">85</span>s ] thds: <span class="number">4</span> tps: <span class="number">339.42</span> qps: <span class="number">6798.35</span> (r/w/o: <span class="number">4759.64</span>/<span class="number">1359.67</span>/<span class="number">679.03</span>) lat (ms,<span class="number">95</span>%): <span class="number">12.98</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">33</span>][ <span class="number">90</span>s ] thds: <span class="number">4</span> tps: <span class="number">338.40</span> qps: <span class="number">6763.76</span> (r/w/o: <span class="number">4734.57</span>/<span class="number">1352.39</span>/<span class="number">676.80</span>) lat (ms,<span class="number">95</span>%): <span class="number">12.98</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">38</span>][ <span class="number">95</span>s ] thds: <span class="number">4</span> tps: <span class="number">337.20</span> qps: <span class="number">6742.19</span> (r/w/o: <span class="number">4719.79</span>/<span class="number">1348.00</span>/<span class="number">674.40</span>) lat (ms,<span class="number">95</span>%): <span class="number">13.46</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br></pre></td></tr></table></figure></p>
<p>查看proxysql转台信息, 发现status为<code>OFFLINE_SOFT</code>, 连接仍然在<code>10.133.x.53</code>上<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">01</span> [(none)]&gt; SELECT hostgroup hg, srv_host, status, ConnUsed, ConnFree, ConnOK, ConnERR FROM stats_mysql_connection_pool WHERE ConnUsed+ConnFree &gt; <span class="number">0</span> ORDER BY hg, srv_host;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]+----+-------------+--------------+----------+----------+--------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]| hg | srv_host    | status       | ConnUsed | ConnFree | ConnOK | ConnERR |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]+----+-------------+--------------+----------+----------+--------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]| <span class="number">10</span> | <span class="number">10.133</span>.x<span class="number">.53</span> | OFFLINE_SOFT | <span class="number">4</span>        | <span class="number">0</span>        | <span class="number">26</span>     | <span class="number">0</span>       |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]+----+-------------+--------------+----------+----------+--------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">10</span> [(none)]&gt; select * <span class="keyword">from</span> stats_mysql_processlist;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]+----------+-----------+------------+----------+-------------+----------+-----------+-------------+------------+-------------+----------+---------+---------+---------------------------------------------------------------------+--------------+---------------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]| ThreadID | SessionID | user       | db       | cli_host    | cli_port | hostgroup | l_srv_host  | l_srv_port | srv_host    | srv_port | command | time_ms | info                                                                | status_flags | extended_info |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]+----------+-----------+------------+----------+-------------+----------+-----------+-------------+------------+-------------+----------+---------+---------+---------------------------------------------------------------------+--------------+---------------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]| <span class="number">10</span>       | <span class="number">15664</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60008</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.52</span> | <span class="number">60207</span>      | <span class="number">10.133</span>.x<span class="number">.53</span> | <span class="number">3307</span>     | Execute | <span class="number">0</span>       | COMMIT                                                              | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]| <span class="number">5</span>        | <span class="number">15665</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60012</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.52</span> | <span class="number">28221</span>      | <span class="number">10.133</span>.x<span class="number">.53</span> | <span class="number">3307</span>     | Execute | <span class="number">0</span>       | SELECT c FROM sbtest8 WHERE id=?                                    | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]| <span class="number">19</span>       | <span class="number">15666</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60014</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.52</span> | <span class="number">25673</span>      | <span class="number">10.133</span>.x<span class="number">.53</span> | <span class="number">3307</span>     | Execute | <span class="number">0</span>       | SELECT DISTINCT c FROM sbtest10 WHERE id BETWEEN ? AND ? ORDER BY c | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]| <span class="number">4</span>        | <span class="number">15667</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60010</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.52</span> | <span class="number">28223</span>      | <span class="number">10.133</span>.x<span class="number">.53</span> | <span class="number">3307</span>     | Execute | <span class="number">0</span>       | SELECT c FROM sbtest3 WHERE id BETWEEN ? AND ?                      | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">16</span>]+----------+-----------+------------+----------+-------------+----------+-----------+-------------+------------+-------------+----------+---------+---------+---------------------------------------------------------------------+--------------+---------------+</span><br></pre></td></tr></table></figure></p>
<p>我们手动停止sysbench, 重启sysbench<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>][<span class="symbol">root@</span>node10<span class="number">-133</span><span class="number">-1</span><span class="number">-59</span> fanboshi]# sh sysbench_by_proxysql.sh <span class="number">4</span> <span class="number">1800</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]sysbench <span class="number">1.0</span><span class="number">.18</span> (using bundled LuaJIT <span class="number">2.1</span><span class="number">.0</span>-beta2)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]Running the test with following options:</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]Number of threads: <span class="number">4</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]Report <span class="built_in">int</span>ermediate results every <span class="number">5</span> second(s)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]Initializing random number generator <span class="keyword">from</span> current time</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]Initializing worker threads...</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]Threads started!</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">37</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">42</span>][ <span class="number">5</span>s ] thds: <span class="number">4</span> tps: <span class="number">432.41</span> qps: <span class="number">8659.34</span> (r/w/o: <span class="number">6062.50</span>/<span class="number">1731.23</span>/<span class="number">865.61</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.24</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">47</span>][ <span class="number">10</span>s ] thds: <span class="number">4</span> tps: <span class="number">433.20</span> qps: <span class="number">8661.86</span> (r/w/o: <span class="number">6064.24</span>/<span class="number">1731.21</span>/<span class="number">866.41</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.24</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">52</span>][ <span class="number">15</span>s ] thds: <span class="number">4</span> tps: <span class="number">433.79</span> qps: <span class="number">8676.81</span> (r/w/o: <span class="number">6074.06</span>/<span class="number">1735.16</span>/<span class="number">867.58</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.24</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">57</span>][ <span class="number">20</span>s ] thds: <span class="number">4</span> tps: <span class="number">436.80</span> qps: <span class="number">8736.88</span> (r/w/o: <span class="number">6114.46</span>/<span class="number">1748.82</span>/<span class="number">873.61</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.24</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">02</span>][ <span class="number">25</span>s ] thds: <span class="number">4</span> tps: <span class="number">434.99</span> qps: <span class="number">8701.31</span> (r/w/o: <span class="number">6092.20</span>/<span class="number">1739.14</span>/<span class="number">869.97</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.45</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br></pre></td></tr></table></figure></p>
<p>再次查看连接状况<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">25</span> [(none)]&gt; SELECT hostgroup hg, srv_host, status, ConnUsed, ConnFree, ConnOK, ConnERR FROM stats_mysql_connection_pool WHERE ConnUsed+ConnFree &gt; <span class="number">0</span> ORDER BY hg, srv_host;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]+----+--------------+--------+----------+----------+--------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]| hg | srv_host     | status | ConnUsed | ConnFree | ConnOK | ConnERR |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]+----+--------------+--------+----------+----------+--------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]| <span class="number">10</span> | <span class="number">10.133</span>.x<span class="number">.202</span> | ONLINE | <span class="number">4</span>        | <span class="number">0</span>        | <span class="number">4</span>      | <span class="number">0</span>       |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]+----+--------------+--------+----------+----------+--------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">41</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">42</span> [(none)]&gt; select * <span class="keyword">from</span> stats_mysql_processlist;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]+----------+-----------+------------+----------+-------------+----------+-----------+--------------+------------+--------------+----------+---------+---------+--------------------------------------------------------------------+--------------+---------------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]| ThreadID | SessionID | user       | db       | cli_host    | cli_port | hostgroup | l_srv_host   | l_srv_port | srv_host     | srv_port | command | time_ms | info                                                               | status_flags | extended_info |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]+----------+-----------+------------+----------+-------------+----------+-----------+--------------+------------+--------------+----------+---------+---------+--------------------------------------------------------------------+--------------+---------------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]| <span class="number">2</span>        | <span class="number">15731</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60330</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">15300</span>      | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span>     | Sleep   | <span class="number">0</span>       | NULL                                                               | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]| <span class="number">4</span>        | <span class="number">15732</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60334</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">15304</span>      | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span>     | Sleep   | <span class="number">0</span>       | NULL                                                               | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]| <span class="number">7</span>        | <span class="number">15733</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60336</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">15302</span>      | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span>     | Execute | <span class="number">0</span>       | COMMIT                                                             | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]| <span class="number">6</span>        | <span class="number">15734</span>     | sysbench_user | sysbench | <span class="number">10.133</span>.x<span class="number">.59</span> | <span class="number">60332</span>    | <span class="number">10</span>        | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">15306</span>      | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span>     | Execute | <span class="number">0</span>       | SELECT DISTINCT c FROM sbtest9 WHERE id BETWEEN ? AND ? ORDER BY c | <span class="number">0</span>            | NULL          |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]+----------+-----------+------------+----------+-------------+----------+-----------+--------------+------------+--------------+----------+---------+---------+--------------------------------------------------------------------+--------------+---------------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span>]<span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><br>可以看到连接已经转发到了<code>10.133.x.202</code>上</p>
<p>删除无用配置<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">35</span>:<span class="number">50</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]| hostgroup_id | hostname     | port | gtid_port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE       | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]<span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">18</span> [(none)]&gt; select * <span class="keyword">from</span> mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]| hostgroup_id | hostname     | port | gtid_port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.53</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">3</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.52</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">2</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_SOFT | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE       | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]<span class="number">4</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">29</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">23</span> [(none)]&gt; delete <span class="keyword">from</span> mysql_servers where hostname!=<span class="string">&#x27;10.133.x.202&#x27;</span>;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">29</span>]Query OK, <span class="number">3</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">29</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">29</span> [(none)]&gt; select * <span class="keyword">from</span> mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]| hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">42</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">31</span> [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">42</span>]Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">42</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">42</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]| hostgroup_id | hostname     | port | gtid_port | status       | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE       | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]| <span class="number">11</span>           | <span class="number">10.133</span>.x<span class="number">.54</span>  | <span class="number">3307</span> | <span class="number">0</span>         | OFFLINE_HARD | <span class="number">1</span>      | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]<span class="number">2</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span>]</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]<span class="symbol">admin@</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">49</span> [(none)]&gt; select * <span class="keyword">from</span> runtime_mysql_servers;</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]| hostgroup_id | hostname     | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]| <span class="number">10</span>           | <span class="number">10.133</span>.x<span class="number">.202</span> | <span class="number">3307</span> | <span class="number">0</span>         | ONLINE | <span class="number">100</span>    | <span class="number">0</span>           | <span class="number">1000</span>            | <span class="number">0</span>                   | <span class="number">0</span>       | <span class="number">0</span>              |         |</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">55</span>]<span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>连接无异常<br><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">37</span>][ <span class="number">60</span>s ] thds: <span class="number">4</span> tps: <span class="number">418.79</span> qps: <span class="number">8379.26</span> (r/w/o: <span class="number">5866.30</span>/<span class="number">1675.37</span>/<span class="number">837.59</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.45</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">42</span>][ <span class="number">65</span>s ] thds: <span class="number">4</span> tps: <span class="number">421.60</span> qps: <span class="number">8433.50</span> (r/w/o: <span class="number">5904.67</span>/<span class="number">1685.62</span>/<span class="number">843.21</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.45</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">47</span>][ <span class="number">70</span>s ] thds: <span class="number">4</span> tps: <span class="number">416.80</span> qps: <span class="number">8334.11</span> (r/w/o: <span class="number">5832.93</span>/<span class="number">1667.58</span>/<span class="number">833.59</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.45</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br><span class="line">[<span class="number">2019</span><span class="number">-11</span><span class="number">-12</span> <span class="number">21</span>:<span class="number">36</span>:<span class="number">52</span>][ <span class="number">75</span>s ] thds: <span class="number">4</span> tps: <span class="number">413.81</span> qps: <span class="number">8273.84</span> (r/w/o: <span class="number">5790.77</span>/<span class="number">1655.45</span>/<span class="number">827.62</span>) lat (ms,<span class="number">95</span>%): <span class="number">11.65</span> err/s: <span class="number">0.00</span> reconn/s: <span class="number">0.00</span></span><br></pre></td></tr></table></figure></p>
<h2 id="关于OFFLINE-SOFT"><a href="#关于OFFLINE-SOFT" class="headerlink" title="关于OFFLINE_SOFT"></a>关于OFFLINE_SOFT</h2><p>详见<a target="_blank" rel="noopener" href="https://github.com/sysown/proxysql/wiki/Main-(runtime)#mysql_servers">https://github.com/sysown/proxysql/wiki/Main-(runtime)#mysql_servers</a></p>
<ul>
<li><code>status</code>:<ul>
<li><em>ONLINE</em> - backend server is fully operational</li>
<li><em>SHUNNED</em> - backend sever is temporarily taken out of use because of either too many connection errors in a time that was too short, or replication lag exceeded the allowed threshold</li>
<li><em>OFFLINE_SOFT</em> - when a server is put into OFFLINE_SOFT mode, new incoming connections aren’t accepted anymore, while the existing connections are kept until they became inactive. In other words, connections are kept in use until the current transaction is completed. This allows to gracefully detach a backend</li>
<li><em>OFFLINE_HARD</em> - when a server is put into OFFLINE_HARD mode, the existing connections are dropped, while new incoming connections aren’t accepted either. This is equivalent to deleting the server from a hostgroup, or temporarily taking it out of the hostgroup for maintenance work</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>


<script src="/js/vdonate.js"></script>

<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: '打赏支持', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG65.jpeg',
  alipayImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG64.jpeg'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>大范</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2019/11/12/2019-11-12-ProxySQL平滑下线节点/" target="_blank" title="ProxySQL平滑下线节点">http://fuxkdb.com/2019/11/12/2019-11-12-ProxySQL平滑下线节点/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ProxySQL/" rel="tag">ProxySQL</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/12/02/2019-12-02-TiDB-Binlog%E9%83%A8%E7%BD%B2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          TiDB Binlog部署
        
      </div>
    </a>
  
  
    <a href="/2019/10/21/2019-10-21-%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E5%88%B6%E4%BD%9C%E6%9C%BA%E6%A2%B0%E9%94%AE%E7%9B%98/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">如何自己制作机械键盘</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ProxySQL%E5%B9%B3%E6%BB%91%E4%B8%8B%E7%BA%BF%E8%8A%82%E7%82%B9"><span class="nav-number">1.</span> <span class="nav-text">ProxySQL平滑下线节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">环境介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E7%9A%84%E4%B8%8B%E7%BA%BF%E6%96%B9%E5%BC%8F"><span class="nav-number">1.2.</span> <span class="nav-text">错误的下线方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%B8%8B%E7%BA%BF%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.</span> <span class="nav-text">正确的下线方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EOFFLINE-SOFT"><span class="nav-number">1.4.</span> <span class="nav-text">关于OFFLINE_SOFT</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2022 Fan() All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Fan()
          </div>
          <div class="panel-body">
            Copyright © 2022 大范 All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>