<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>auto-inc锁和auto_increment在innodb中处理方式 | Fan()</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="MySQL" />
  
  
  
  
  <meta name="description" content="AUTO-INC Locks An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into">
<meta property="og:type" content="article">
<meta property="og:title" content="AUTO-INC锁和AUTO_INCREMENT在InnoDB中处理方式">
<meta property="og:url" content="http://fuxkdb.com/2016/12/15/AUTO-INC%E9%94%81%E5%92%8CAUTO_INCREMENT%E5%9C%A8InnoDB%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F/index.html">
<meta property="og:site_name" content="Fan()">
<meta property="og:description" content="AUTO-INC Locks An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-12-15T14:00:00.000Z">
<meta property="article:modified_time" content="2017-08-05T16:01:10.000Z">
<meta property="article:author" content="大范">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Fan()" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpeg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpeg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("/css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("/css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("/css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

<meta name="generator" content="Hexo 6.2.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpeg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-AUTO-INC锁和AUTO_INCREMENT在InnoDB中处理方式" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      AUTO-INC锁和AUTO_INCREMENT在InnoDB中处理方式
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2016/12/15/AUTO-INC%E9%94%81%E5%92%8CAUTO_INCREMENT%E5%9C%A8InnoDB%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F/" class="article-date">
	  <time datetime="2016-12-15T14:00:00.000Z" itemprop="datePublished">2016-12-15</time>
	</a>

      
      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="AUTO-INC-Locks"><a href="#AUTO-INC-Locks" class="headerlink" title="AUTO-INC Locks"></a>AUTO-INC Locks</h2><blockquote>
<p>An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into the table, any other transactions must wait to do their own inserts into that table, so that rows inserted by the first transaction receive consecutive primary key values.</p>
</blockquote>
<p>The innodb_autoinc_lock_mode configuration option controls the algorithm used for auto-increment locking. It allows you to choose how to trade off between predictable sequences of auto-increment values and maximum concurrency for insert operations.</p>
<p>AUTO-INC锁是当向使用含有AUTO_INCREMENT列的表中插入数据时需要获取的一种特殊的表级锁<br>在最简单的情况下，如果一个事务正在向表中插入值，则任何其他事务必须等待对该表执行自己的插入操作，以便第一个事务插入的行的值是连续的。<br>innodb_autoinc_lock_mode配置选项控制用于自动增量锁定的算法。 它允许您选择如何在可预测的自动递增值序列和插入操作的最大并发性之间进行权衡。</p>
<h2 id="AUTO-INCREMENT-Handling-in-InnoDB"><a href="#AUTO-INCREMENT-Handling-in-InnoDB" class="headerlink" title="AUTO_INCREMENT Handling in InnoDB"></a>AUTO_INCREMENT Handling in InnoDB</h2><p>InnoDB提供了一个可配置的锁定机制，可以显着提高使用AUTO_INCREMENT列向表中添加行的SQL语句的可伸缩性和性能。 要对InnoDB表使用AUTO_INCREMENT机制，必须将AUTO_INCREMENT列定义为索引的一部分，以便可以对表执行相当于索引的<code>SELECT MAX（ai_col）</code>查找以获取最大列值。 通常，这是通过使列成为某些表索引的第一列来实现的。</p>
<p>本节介绍AUTO_INCREMENT锁定模式的行为，对不同AUTO_INCREMENT锁定模式设置的使用含义，以及InnoDB如何初始化AUTO_INCREMENT计数器。</p>
<ul>
<li><p>InnoDB AUTO_INCREMENT锁定模式</p>
</li>
<li><p>InnoDB AUTO_INCREMENT锁定模式使用含义</p>
</li>
<li><p>InnoDB AUTO_INCREMENT计数器初始化</p>
</li>
</ul>
<a id="more"></a>
<h3 id="InnoDB-AUTO-INCREMENT锁定模式"><a href="#InnoDB-AUTO-INCREMENT锁定模式" class="headerlink" title="InnoDB AUTO_INCREMENT锁定模式"></a>InnoDB AUTO_INCREMENT锁定模式</h3><p>本节介绍用于生成自动递增值的AUTO_INCREMENT锁定模式的行为，以及每种锁定模式如何影响复制。 自动递增锁定模式在启动时使用innodb_autoinc_lock_mode配置参数进行配置。</p>
<p>以下术语用于描述innodb_autoinc_lock_mode设置:</p>
<ul>
<li><p>“INSERT-like” statements(类INSERT语句)<br>所有可以向表中增加行的语句,包括<code>INSERT</code>, <code>INSERT ... SELECT</code>, <code>REPLACE</code>, <code>REPLACE ... SELECT</code>, and <code>LOAD DATA</code>.包括“simple-inserts”, “bulk-inserts”, and “mixed-mode” inserts.</p>
</li>
<li><p>“Simple inserts”<br>可以预先确定要插入的行数（当语句被初始处理时）的语句。 这包括没有嵌套子查询的单行和多行INSERT和REPLACE语句，但不包括<code>INSERT ... ON DUPLICATE KEY UPDATE</code>。</p>
</li>
<li><p>“Bulk inserts”<br>事先不知道要插入的行数（和所需自动递增值的数量）的语句。 这包括<code>INSERT ... SELECT</code>，<code>REPLACE ... SELECT</code>和<code>LOAD DATA</code>语句，但不包括纯INSERT。 InnoDB在处理每行时一次为AUTO_INCREMENT列分配一个新值。</p>
</li>
<li><p>“Mixed-mode inserts”<br>这些是“Simple inserts”语句但是指定一些（但不是全部）新行的自动递增值。 示例如下，其中c1是表t1的AUTO_INCREMENT列：<br><code>INSERT INTO t1 (c1,c2) VALUES (1,&#39;a&#39;), (NULL,&#39;b&#39;), (5,&#39;c&#39;), (NULL,&#39;d&#39;);</code></p>
</li>
</ul>
<p>另一种类型的“Mixed-mode inserts”是<code>INSERT ... ON DUPLICATE KEY UPDATE</code>，其在最坏的情况下实际上是INSERT语句随后又跟了一个UPDATE，其中AUTO_INCREMENT列的分配值不一定会在 UPDATE 阶段使用</p>
<ul>
<li><h4 id="innodb-autoinc-lock-mode-0-“traditional”-lock-mode"><a href="#innodb-autoinc-lock-mode-0-“traditional”-lock-mode" class="headerlink" title="innodb_autoinc_lock_mode = 0 (“traditional” lock mode)"></a>innodb_autoinc_lock_mode = 0 (“traditional” lock mode)</h4>传统的锁定模式提供了在MySQL 5.1中引入innodb_autoinc_lock_mode配置参数之前存在的相同行为。传统的锁定模式选项用于向后兼容性，性能测试以及解决“Mixed-mode inserts”的问题，因为语义上可能存在差异。</li>
</ul>
<p>在此锁定模式下，所有“INSERT-like”语句获得一个特殊的表级AUTO-INC锁，用于插入具有AUTO_INCREMENT列的表。此锁定通常保持到语句结束（不是事务结束），以确保为给定的INSERT语句序列以可预测和可重复的顺序分配自动递增值，并确保自动递增由任何给定语句分配的值是连续的。<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">SESSION<span class="emphasis">_A&gt;DROP TABLE IF EXISTS t;</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">SESSION_</span>A&gt;CREATE TABLE t (a bigint unsigned auto<span class="emphasis">_increment primary key) ENGINE=InnoDB;</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.01 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">SESSION_</span>A&gt;insert into t values(1),(3),(4),(5),(6),(7);</span><br><span class="line">Query OK, 6 rows affected (0.01 sec)</span><br><span class="line">Records: 6  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">SESSION<span class="emphasis">_A&gt;select * from t;</span></span><br><span class="line"><span class="emphasis">+---+</span></span><br><span class="line"><span class="emphasis">| a |</span></span><br><span class="line"><span class="emphasis">+---+</span></span><br><span class="line"><span class="emphasis">| 1 |</span></span><br><span class="line"><span class="emphasis">| 3 |</span></span><br><span class="line"><span class="emphasis">| 4 |</span></span><br><span class="line"><span class="emphasis">| 5 |</span></span><br><span class="line"><span class="emphasis">| 6 |</span></span><br><span class="line"><span class="emphasis">| 7 |</span></span><br><span class="line"><span class="emphasis">+---+</span></span><br><span class="line"><span class="emphasis">6 rows in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">SESSION_</span>A&gt;select @@innodb<span class="emphasis">_autoinc_</span>lock<span class="emphasis">_mode;</span></span><br><span class="line"><span class="emphasis">+----------------------------+</span></span><br><span class="line"><span class="emphasis">| @@innodb_</span>autoinc<span class="emphasis">_lock_</span>mode |</span><br><span class="line"><span class="code">+----------------------------+</span></span><br><span class="line">|                          0 |</span><br><span class="line"><span class="code">+----------------------------+</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">A B C 三个会话事务隔离级别都是 RR</span><br><span class="line">SESSION<span class="emphasis">_A&gt;select @@global.tx_</span>isolation,@@session.tx<span class="emphasis">_isolation;</span></span><br><span class="line"><span class="emphasis">+-----------------------+------------------------+</span></span><br><span class="line"><span class="emphasis">| @@global.tx_</span>isolation | @@session.tx<span class="emphasis">_isolation |</span></span><br><span class="line"><span class="emphasis">+-----------------------+------------------------+</span></span><br><span class="line"><span class="emphasis">| REPEATABLE-READ       | REPEATABLE-READ        |</span></span><br><span class="line"><span class="emphasis">+-----------------------+------------------------+</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">SESSION_</span>A&gt;begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">SESSION<span class="emphasis">_A&gt;delete from t where a&gt;4;</span></span><br><span class="line"><span class="emphasis">Query OK, 3 rows affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">B会话被锁,这是由于会话 A 产生的 gap lock</span></span><br><span class="line"><span class="emphasis">SESSION_</span>B&gt;begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">SESSION<span class="emphasis">_B&gt;insert into t values(null); --注意这里因为是 null, 锁需要在内存中分配 AUTO-INCREMENT 值</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">C 会话被阻塞</span></span><br><span class="line"><span class="emphasis">SESSION_</span>C&gt;begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">SESSION<span class="emphasis">_C&gt;insert into t values(2);  --这里插入2,没有 gap lock 也被锁了</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">(mysql@localhost) [fandb]&gt; (mysql@localhost) [fandb]&gt; select trx_</span>id,trx<span class="emphasis">_state,trx_</span>requested<span class="emphasis">_lock_</span>id,trx<span class="emphasis">_weight,trx_</span>mysql<span class="emphasis">_thread_</span>id,trx<span class="emphasis">_query, trx_</span>operation<span class="emphasis">_state from information_</span>schema.INNODB<span class="emphasis">_TRX;</span></span><br><span class="line"><span class="emphasis">+--------+-----------+-----------------------+------------+---------------------+----------------------------+-----------------------+</span></span><br><span class="line"><span class="emphasis">| trx_</span>id | trx<span class="emphasis">_state | trx_</span>requested<span class="emphasis">_lock_</span>id | trx<span class="emphasis">_weight | trx_</span>mysql<span class="emphasis">_thread_</span>id | trx<span class="emphasis">_query                  | trx_</span>operation<span class="emphasis">_state   |</span></span><br><span class="line"><span class="emphasis">+--------+-----------+-----------------------+------------+---------------------+----------------------------+-----------------------+</span></span><br><span class="line"><span class="emphasis">| 321912 | LOCK WAIT | 321912:701            |          3 |                   7 | insert into t values(2)    | setting auto-inc lock |</span></span><br><span class="line"><span class="emphasis">| 321911 | LOCK WAIT | 321911:690:3:1        |          3 |                   2 | insert into t values(null) | inserting             |</span></span><br><span class="line"><span class="emphasis">| 321906 | RUNNING   | NULL                  |          5 |                   1 | NULL                       | NULL                  |</span></span><br><span class="line"><span class="emphasis">+--------+-----------+-----------------------+------------+---------------------+----------------------------+-----------------------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis">可以看到,SESSION_</span>C是等待自增锁，一直处于setting auto-inc lock状态</span><br><span class="line"></span><br><span class="line">(mysql@localhost) [fandb]&gt; select * from information<span class="emphasis">_schema.INNODB_</span>LOCKS;</span><br><span class="line"><span class="code">+----------------+</span>-------------<span class="code">+-----------+</span>-----------<span class="code">+-------------+</span>------------<span class="code">+------------+</span>-----------<span class="code">+----------+</span>------------------------+</span><br><span class="line">| lock<span class="emphasis">_id        | lock_</span>trx<span class="emphasis">_id | lock_</span>mode | lock<span class="emphasis">_type | lock_</span>table  | lock<span class="emphasis">_index | lock_</span>space | lock<span class="emphasis">_page | lock_</span>rec | lock<span class="emphasis">_data              |</span></span><br><span class="line"><span class="emphasis">+----------------+-------------+-----------+-----------+-------------+------------+------------+-----------+----------+------------------------+</span></span><br><span class="line"><span class="emphasis">| 321912:701     | 321912      | AUTO_</span>INC  | TABLE     | <span class="code">`fandb`</span>.<span class="code">`t`</span> | NULL       |       NULL |      NULL |     NULL | NULL                   |</span><br><span class="line">| 321911:701     | 321911      | AUTO<span class="emphasis">_INC  | TABLE     | `fandb`.`t` | NULL       |       NULL |      NULL |     NULL | NULL                   |</span></span><br><span class="line"><span class="emphasis">| 321911:690:3:1 | 321911      | X         | RECORD    | `fandb`.`t` | PRIMARY    |        690 |         3 |        1 | supremum pseudo-record |</span></span><br><span class="line"><span class="emphasis">| 321906:690:3:1 | 321906      | X         | RECORD    | `fandb`.`t` | PRIMARY    |        690 |         3 |        1 | supremum pseudo-record |</span></span><br><span class="line"><span class="emphasis">+----------------+-------------+-----------+-----------+-------------+------------+------------+-----------+----------+------------------------+</span></span><br><span class="line"><span class="emphasis">4 rows in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p>
<p>在statement-based replication的情况下，这意味着当在从服务器上复制SQL语句时，自动增量列使用与主服务器上相同的值。多个INSERT语句的执行结果是确定性的，SLAVE再现与MASTER相同的数据。如果由多个INSERT语句生成的自动递增值交错，则两个并发INSERT语句的结果将是不确定的，并且不能使用基于语句的复制可靠地传播到从属服务器。</p>
<p>为了解释清楚,查看下面的例子:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t1 (</span><br><span class="line">  c1 INT(11) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  c2 VARCHAR(10)<span class="built_in"> DEFAULT </span><span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY KEY (c1)</span><br><span class="line">) <span class="attribute">ENGINE</span>=InnoDB;</span><br></pre></td></tr></table></figure><br>假设有两个事务正在运行，每个事务都将行插入到具有AUTO_INCREMENT列的表中。 一个事务正在使用插入1000行的INSERT … SELECT语句，另一个事务正在使用插入一行的“Simple inserts”语句:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tx1: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 (c2) <span class="keyword">SELECT</span> <span class="number">1000</span> <span class="keyword">rows</span> <span class="keyword">from</span> another <span class="keyword">table</span> ...</span><br><span class="line">Tx2: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 (c2) <span class="keyword">VALUES</span> (<span class="string">&#x27;xxx&#x27;</span>);</span><br></pre></td></tr></table></figure><br>InnoDB不能预先得知有多少行会从TX1的select部分获取到,所以在事务进行过程中,InnoDB一次只会为AUTO_INCREMENT列分配一个值.<br>通过一个表级锁的控制,保证了在同一时刻只有一个引用表t1的INSERT语句可以执行,直到整个INSERT语句结束,并且由不同语句生成自动递增数不会交错<br>由Tx1 <code>INSERT ... SELECT</code>语句生成的自动递增值将是连续的，并且Tx2中的INSERT语句使用的（单个）自动递增值将小于或大于用于Tx1的所有那些值，具体取决于 那个语句先执行。</p>
<p>只要SQL语句在从二进制日志（当使用基于语句的复制或在恢复方案中）重放时以相同的顺序执行，结果将与Tx1和Tx2首次运行时的结果相同。 因此，持续至语句结束的表级锁定( table-level locks)保证了在statement-based replication中对auto-increment列的插入数据的安全性. 但是，当多个事务同时执行insert语句时，这些表级锁定会限制并发性和可伸缩性。</p>
<p>在前面的示例中，如果没有表级锁，则Tx2中用于INSERT的自动递增列的值取决于语句执行的确切时间。 如果Tx2的INSERT在Tx1的INSERT正在运行时（而不是在它开始之前或完成之后）执行，则由两个INSERT语句分配的特定自动递增值将是不确定的，并且可能每次运行都会得到不同的值</p>
<p>在连续锁定模式下，InnoDB可以避免为“Simple inserts”语句使用表级AUTO-INC锁，其中行数是预先已知的，并且仍然保留基于语句的复制的确定性执行和安全性。</p>
<p>如果不使用二进制日志作为恢复或复制的一部分来重放SQL语句，则可以使用interleaved lock模式来消除所有使用表级AUTO-INC锁，以实现更大的并发性和性能,其代价是由于并发的语句交错执行,同一语句生成的AUTO-INCREMENT值可能会产生GAP</p>
<ul>
<li><h4 id="innodb-autoinc-lock-mode-1-“consecutive”-lock-mode"><a href="#innodb-autoinc-lock-mode-1-“consecutive”-lock-mode" class="headerlink" title="innodb_autoinc_lock_mode = 1 (“consecutive” lock mode)"></a>innodb_autoinc_lock_mode = 1 (“consecutive” lock mode)</h4>这是默认的锁定模式.在这个模式下,“bulk inserts”仍然使用AUTO-INC表级锁,并保持到语句结束.这适用于所有<code>INSERT ... SELECT</code>，<code>REPLACE ... SELECT</code>和<code>LOAD DATA</code>语句。同一时刻只有一个语句可以持有AUTO-INC锁.</li>
</ul>
<p>“Simple inserts”（要插入的行数事先已知）通过在mutex（轻量锁）的控制下获得所需数量的自动递增值来避免表级AUTO-INC锁， 它只在分配过程的持续时间内保持，而不是直到语句完成。 不使用表级AUTO-INC锁，除非AUTO-INC锁由另一个事务保持。 如果另一个事务保持AUTO-INC锁，则“简单插入”等待AUTO-INC锁，如同它是一个“批量插入”。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">SESSION_A&gt;<span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> t;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_A&gt;<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t (a <span class="type">bigint</span> unsigned auto_increment <span class="keyword">primary key</span>) ENGINE=InnoDB;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_A&gt;<span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">3</span>),(<span class="number">4</span>),(<span class="number">5</span>),(<span class="number">6</span>),(<span class="number">7</span>);</span><br><span class="line">Query OK, <span class="number">6</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">6</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">SESSION_A&gt;<span class="keyword">select</span> @@innodb_autoinc_lock_mode;</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| @@innodb_autoinc_lock_mode |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">|                          <span class="number">1</span> |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_A&gt;<span class="keyword">select</span> * <span class="keyword">from</span> t;</span><br><span class="line">+<span class="comment">---+</span></span><br><span class="line">| a |</span><br><span class="line">+<span class="comment">---+</span></span><br><span class="line">| <span class="number">1</span> |</span><br><span class="line">| <span class="number">3</span> |</span><br><span class="line">| <span class="number">4</span> |</span><br><span class="line">| <span class="number">5</span> |</span><br><span class="line">| <span class="number">6</span> |</span><br><span class="line">| <span class="number">7</span> |</span><br><span class="line">+<span class="comment">---+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_A&gt;<span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_A&gt;<span class="keyword">delete</span> <span class="keyword">from</span> t <span class="keyword">where</span> a&gt;<span class="number">4</span>;</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">会话 B, 被 GAP <span class="keyword">LOCK</span> 阻塞</span><br><span class="line">SESSION_B&gt;<span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_B&gt;<span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="keyword">null</span>); <span class="comment">--由于是`simple-insert`且`innodb_autoinc_lock_mode=1`,所以并不需要AUTO-INC表级锁</span></span><br><span class="line"></span><br><span class="line">会话 C 成功插入没有阻塞</span><br><span class="line">SESSION_C&gt;<span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_C&gt;<span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">2</span>); <span class="comment">--由于它也是`simple-insert`且`innodb_autoinc_lock_mode=1`所以不需要获取AUTO-INC表级锁,没有阻塞成功插入</span></span><br><span class="line">Query OK, <span class="number">1</span> <span class="keyword">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">C会话<span class="keyword">rollback</span>,B会话改为使用“Bulk inserts”</span><br><span class="line">SESSION_C&gt;<span class="keyword">rollback</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_B&gt;<span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">select</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">此时 C 会话又被阻塞了</span><br><span class="line">SESSION_C&gt;<span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">SESSION_C&gt;<span class="keyword">insert</span> <span class="keyword">into</span> t <span class="keyword">values</span>(<span class="number">2</span>); <span class="comment">--这验证了官方文档中的说法`If another transaction holds an AUTO-INC lock, a “simple insert” waits for the AUTO-INC lock, as if it were a “bulk insert”.`</span></span><br><span class="line">Query OK, <span class="number">1</span> <span class="keyword">row</span> affected (<span class="number">41.17</span> sec)</span><br></pre></td></tr></table></figure>
<p>此锁定模式确保,当行数不预先知道的INSERT存在时(并且自动递增值在语句过程执行中分配)由任何“类INSERT”语句分配的所有自动递增值是连续的，并且对于基于语句的复制(statement-based replication)操作是安全的。</p>
<p>这种锁定模式显著地提高了可扩展性,并且保证了对于基于语句的复制(statement-based replication)的安全性.此外，与“传统”锁定模式一样，由任何给定语句分配的自动递增数字是连续的。 与使用自动递增的任何语句的“传统”模式相比，语义没有变化.<br>但有一个特例:</p>
<blockquote>
<p>The exception is for “mixed-mode inserts”, where the user provides explicit values for an AUTO_INCREMENT column for some, but not all, rows in a multiple-row “simple insert”. For such inserts, InnoDB allocates more auto-increment values than the number of rows to be inserted. However, all values automatically assigned are consecutively generated (and thus higher than) the auto-increment value generated by the most recently executed previous statement. “Excess” numbers are lost.</p>
</blockquote>
<ul>
<li><h3 id="innodb-autoinc-lock-mode-2-“interleaved”-lock-mode"><a href="#innodb-autoinc-lock-mode-2-“interleaved”-lock-mode" class="headerlink" title="innodb_autoinc_lock_mode = 2 (“interleaved” lock mode)"></a>innodb_autoinc_lock_mode = 2 (“interleaved” lock mode)</h3>在这种锁定模式下,所有类INSERT(“INSERT-like” )语句都不会使用表级<code>AUTO-INC lock</code>,并且可以同时执行多个语句。这是最快和最可扩展的锁定模式，但是当使用基于语句的复制或恢复方案时，从二进制日志重播SQL语句时，这是不安全的。</li>
</ul>
<p>在此锁定模式下，自动递增值保证在所有并发执行的“类INSERT”语句中是唯一且单调递增的。但是，由于多个语句可以同时生成数字（即，跨语句交叉编号），为任何给定语句插入的行生成的值可能不是连续的。</p>
<p>如果执行的语句是“simple inserts”，其中要插入的行数已提前知道，则除了“混合模式插入”之外，为单个语句生成的数字不会有间隙。然而，当执行“批量插入”时，在由任何给定语句分配的自动递增值中可能存在间隙。</p>
<h3 id="InnoDB-AUTO-INCREMENT锁定模式使用含义"><a href="#InnoDB-AUTO-INCREMENT锁定模式使用含义" class="headerlink" title="InnoDB AUTO_INCREMENT锁定模式使用含义"></a>InnoDB AUTO_INCREMENT锁定模式使用含义</h3><ul>
<li>在复制环节中使用自增列<br>如果你在使用基于语句的复制(statement-based replication)请将innodb_autoinc_lock_mode设置为0或1，并在主从上使用相同的值。 如果使用innodb_autoinc_lock_mode = 2（“interleaved”）或主从不使用相同的锁定模式的配置，自动递增值不能保证在从机上与主机上相同。</li>
</ul>
<p>如果使用基于行的或混合模式的复制，则所有自动增量锁定模式都是安全的，因为基于行的复制对SQL语句的执行顺序不敏感（混合模式会在遇到不安全的语句是使用基于行的复制模式）。</p>
<ul>
<li><p>“Lost” auto-increment values and sequence gaps<br>在所有锁定模式（0,1和2）中，如果生成自动递增值的事务回滚，那些自动递增值将“丢失”。 一旦为自动增量列生成了值，无论是否完成“类似INSERT”语句以及包含事务是否回滚，都不能回滚。 这种丢失的值不被重用。 因此，存储在表的AUTO_INCREMENT列中的值可能存在间隙。</p>
</li>
<li><p>Specifying NULL or 0 for the AUTO_INCREMENT column<br>在所有锁定模式（0,1和2）中，如果用户在INSERT中为AUTO_INCREMENT列指定NULL或0，InnoDB会将该行视为未指定值，并为其生成新值。</p>
</li>
<li><p>为AUTO_INCREMENT列分配一个负值<br>在所有锁定模式（0,1和2）中，如果您为AUTO_INCREMENT列分配了一个负值，则不会定义自动增量机制的行为。</p>
</li>
<li><p>如果AUTO_INCREMENT值大于指定整数类型的最大整数<br>在所有锁定模式（0,1和2）中，如果值大于可以存储在指定整数类型中的最大整数，则不定义自动递增机制的行为。</p>
</li>
<li><p>Gaps in auto-increment values for “bulk inserts”<br>当innodb_autoinc_lock_mode设置为0（“traditional”）或1（“consecutive”）时,任何给定语句生成的自动递增值是连续的，没有间隙，因为表级AUTO-INC锁会持续到 语句结束,并且一次只能执行一个这样的语句。</p>
</li>
</ul>
<p>当innodb_autoinc_lock_mode设置为2（“interleaved”）时，在“bulk inserts”生成的自动递增值中可能存在间隙，但只有在并发执行“INSERT-Like”语句时才会产生这种情况。</p>
<p>对于锁定模式1或2，在连续语句之间可能出现间隙，因为对于批量插入，每个语句所需的自动递增值的确切数目可能不为人所知，并且可能进行过度估计。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @@innodb_autoinc_lock_mode;</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| @@innodb_autoinc_lock_mode |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">|                          0 |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> t;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t (a <span class="built_in">bigint</span> <span class="keyword">unsigned</span> auto_increment primary <span class="keyword">key</span>) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">AS</span> a;</span><br><span class="line"><span class="comment">/* #1 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"><span class="comment">/* #2 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"><span class="comment">/* #3 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"><span class="comment">/* #4 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t;</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">| a  |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">|  6 |</span><br><span class="line">|  7 |</span><br><span class="line">|  8 |</span><br><span class="line">|  9 |</span><br><span class="line">| 10 |</span><br><span class="line">| 11 |</span><br><span class="line">| 12 |</span><br><span class="line">| 13 |</span><br><span class="line">| 14 |</span><br><span class="line">| 15 |</span><br><span class="line">| 16 |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">当innodb_autoinc_lock_mode=0 类<span class="keyword">INSERT</span>语句产生的自动递增值都是连续的</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @@innodb_autoinc_lock_mode;</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| @@innodb_autoinc_lock_mode |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">|                          1 |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> t;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t (a <span class="built_in">bigint</span> <span class="keyword">unsigned</span> auto_increment primary <span class="keyword">key</span>) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">AS</span> a;</span><br><span class="line"><span class="comment">/* #1 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"><span class="comment">/* #2 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"><span class="comment">/* #3 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"><span class="comment">/* #4 */</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">SELECT</span> <span class="literal">NULL</span> <span class="keyword">FROM</span> t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t;</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">| a  |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  6 |</span><br><span class="line">|  7 |</span><br><span class="line">|  8 |</span><br><span class="line">|  9 |</span><br><span class="line">| 13 |</span><br><span class="line">| 14 |</span><br><span class="line">| 15 |</span><br><span class="line">| 16 |</span><br><span class="line">| 17 |</span><br><span class="line">| 18 |</span><br><span class="line">| 19 |</span><br><span class="line">| 20 |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">出现了间隙gap, 5和10-12都没了,下面来解释产生这种情况的原因:</span><br><span class="line"><span class="comment">/* #1 */</span> 这是第一次<span class="keyword">INSERT</span>,此时表中只有一行(创建表时的那一行),但是MySQL不知道有多少行.</span><br><span class="line">然后MySQL Grab a <span class="keyword">chunk</span> <span class="keyword">of</span> auto_increment <span class="keyword">values</span> 在<span class="keyword">chunk</span>中有多少？ 一 只有一个,即<span class="string">&#x27;2&#x27;</span>,将其插入表中.</span><br><span class="line">没有更多的行插入，所以一切完成。</span><br><span class="line"></span><br><span class="line"><span class="comment">/* #2 */</span> 这是第二次<span class="keyword">INSERT</span>,此时表中有两行(<span class="number">1</span>,<span class="number">2</span>),但是MySQL不知道有多少行.</span><br><span class="line">MySQL Grab a <span class="keyword">chunk</span> <span class="keyword">of</span> auto_increment <span class="keyword">values</span> 在<span class="keyword">chunk</span>中有多少？ 一 只有一个,即<span class="string">&#x27;3&#x27;</span>,将其插入表中.</span><br><span class="line">还有需要插入的行,所以Grab another <span class="keyword">chunk</span>,这次是前一次的两倍大小 在<span class="keyword">chunk</span>中有多少？ 一 两个,<span class="string">&#x27;4&#x27;</span>和<span class="string">&#x27;5&#x27;</span>. 插入<span class="string">&#x27;4&#x27;</span>.</span><br><span class="line">没有更多的行插入，所以一切完成,<span class="string">&#x27;5&#x27;</span>被舍弃,但是此时 AUTO_INCREMENT的下一个值是<span class="number">6</span>了</span><br><span class="line"></span><br><span class="line"><span class="comment">/* #3 */</span>这是第三次<span class="keyword">INSERT</span>,此时表中有四行(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>),但是MySQL不知道有多少行.</span><br><span class="line">- Grab a <span class="keyword">chunk</span> <span class="keyword">of</span> auto_increment values. How many <span class="keyword">in</span> the <span class="keyword">chunk</span>? One - the <span class="keyword">value</span> <span class="string">&#x27;6&#x27;</span>. <span class="keyword">Insert</span> it (one <span class="keyword">row</span> inserted).</span><br><span class="line">- Still more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Grab another <span class="keyword">chunk</span>, twice <span class="keyword">as</span> <span class="keyword">big</span> <span class="keyword">as</span> <span class="keyword">before</span> - two <span class="keyword">values</span>, <span class="string">&#x27;7&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;8&#x27;</span>. <span class="keyword">Insert</span> them (three <span class="keyword">rows</span> inserted).</span><br><span class="line">- Still more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Grab another <span class="keyword">chunk</span>, twice <span class="keyword">as</span> <span class="keyword">big</span> <span class="keyword">as</span> <span class="keyword">before</span> - four <span class="keyword">values</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;12&#x27;</span>. <span class="keyword">Insert</span> the <span class="string">&#x27;9&#x27;</span> (four <span class="keyword">rows</span> inserted).</span><br><span class="line">- <span class="keyword">No</span> more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Discard the <span class="keyword">left</span> <span class="keyword">over</span> <span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;11&#x27;</span>, <span class="keyword">and</span> <span class="string">&#x27;12&#x27;</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#4: Insert as many rows as there are in the table (it&#x27;s eight rows, but MySQL doesn&#x27;t know that.)</span></span><br><span class="line">- Grab a <span class="keyword">chunk</span> <span class="keyword">of</span> auto_increment values. How many <span class="keyword">in</span> the <span class="keyword">chunk</span>? One - the <span class="keyword">value</span> <span class="string">&#x27;13&#x27;</span>. <span class="keyword">Insert</span> it (one <span class="keyword">row</span> inserted).</span><br><span class="line">- Still more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Grab another <span class="keyword">chunk</span>, twice <span class="keyword">as</span> <span class="keyword">big</span> <span class="keyword">as</span> <span class="keyword">before</span> - two <span class="keyword">values</span>, <span class="string">&#x27;14&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;15&#x27;</span>. <span class="keyword">Insert</span> them (three <span class="keyword">rows</span> inserted).</span><br><span class="line">- Still more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Grab another <span class="keyword">chunk</span>, twice <span class="keyword">as</span> <span class="keyword">big</span> <span class="keyword">as</span> <span class="keyword">before</span> - four <span class="keyword">values</span>, <span class="string">&#x27;16&#x27;</span>, <span class="string">&#x27;17&#x27;</span>, <span class="string">&#x27;18&#x27;</span>, <span class="string">&#x27;19&#x27;</span>. <span class="keyword">Insert</span> them (seven <span class="keyword">rows</span> inserted).</span><br><span class="line">- Still more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Grab another <span class="keyword">chunk</span>, twice <span class="keyword">as</span> <span class="keyword">big</span> <span class="keyword">as</span> <span class="keyword">before</span> - eight <span class="keyword">values</span>, <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, ..., <span class="string">&#x27;27&#x27;</span>. <span class="keyword">Insert</span> the <span class="string">&#x27;20&#x27;</span> (eight <span class="keyword">rows</span> inserted).</span><br><span class="line">- <span class="keyword">No</span> more <span class="keyword">rows</span> <span class="keyword">to</span> insert. Discard the <span class="keyword">left</span> <span class="keyword">over</span> <span class="string">&#x27;21&#x27;</span>, <span class="string">&#x27;22&#x27;</span>, etc.</span><br><span class="line"></span><br><span class="line">所以这就是 gap 产生的原因</span><br></pre></td></tr></table></figure></p>
<ul>
<li>由“mixed-mode inserts”分配的自动递增值<br>考虑一下场景,在“mixed-mode insert”中,其中一个“simple insert”语句指定了一些（但不是全部）行的AUTO-INCREMENT值。 这样的语句在锁模式0,1和2中表现不同。例如，假设c1是表t1的AUTO_INCREMENT列，并且最近自动生成的序列号是100。<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (</span><br><span class="line">    -&gt; c1 <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>, </span><br><span class="line">    -&gt; c2 <span class="type">CHAR</span>(<span class="number">1</span>)</span><br><span class="line">    -&gt; ) ENGINE = INNODB;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
Now, consider the following “mixed-mode insert” statement:<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span>&gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">t1</span> (c1,c2) <span class="selector-tag">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>), (NULL,<span class="string">&#x27;b&#x27;</span>), (<span class="number">5</span>,<span class="string">&#x27;c&#x27;</span>), (NULL,<span class="string">&#x27;d&#x27;</span>);</span><br></pre></td></tr></table></figure>
当innodb_autoinc_lock_mode=0时:<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT c1, c2 FROM t1 ORDER BY c2;</span><br><span class="line"><span class="code">+-----+</span>------+</span><br><span class="line">| c1  | c2   |</span><br><span class="line"><span class="code">+-----+</span>------+</span><br><span class="line">|   1 | a    |</span><br><span class="line">| 101 | b    |</span><br><span class="line">|   5 | c    |</span><br><span class="line">| 102 | d    |</span><br><span class="line"><span class="code">+-----+</span>------+</span><br></pre></td></tr></table></figure>
下一个可用的auto-increment值103.因为innodb_autoinc_lock_mode=0时,auto-increment值一次只分配一个,而不是在开始时全部分配.不论是否有并发的其他类INSERT语句同时执行,都会是这样的结果</li>
</ul>
<p>当innodb_autoinc_lock_mode=1时:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT c1, c2 FROM t1 ORDER BY c2;</span><br><span class="line"><span class="code">+-----+</span>------+</span><br><span class="line">| c1  | c2   |</span><br><span class="line"><span class="code">+-----+</span>------+</span><br><span class="line">|   1 | a    |</span><br><span class="line">| 101 | b    |</span><br><span class="line">|   5 | c    |</span><br><span class="line">| 102 | d    |</span><br><span class="line"><span class="code">+-----+</span>------+</span><br></pre></td></tr></table></figure><br>不同于innodb_autoinc_lock_mode=0时的情况,此时下一个可用的auto-increment值105,因为auto-increment值在语句一开始就分配了,分配了四个,但是只用了俩.不论是否有并发的其他类INSERT语句同时执行,都会是这样的结果</p>
<p>当innodb_autoinc_lock_mode=2时:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT c1, c2 FROM t1 ORDER BY c2;</span><br><span class="line"><span class="code">+-----+</span>------+</span><br><span class="line">| c1  | c2   |</span><br><span class="line"><span class="code">+-----+</span>------+</span><br><span class="line">|   1 | a    |</span><br><span class="line">|   x | b    |</span><br><span class="line">|   5 | c    |</span><br><span class="line">|   y | d    |</span><br><span class="line"><span class="code">+-----+</span>------+</span><br></pre></td></tr></table></figure><br>x和y的值是唯一的，并大于任何先前生成的行。 然而，x和y的具体值取决于通过并发执行语句生成的自动增量值的数量。</p>
<p>最后考虑下面的情况,当最近的 AUTO-INCREMENT 值为4时,执行下面的语句:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span>&gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">t1</span> (c1,c2) <span class="selector-tag">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>), (NULL,<span class="string">&#x27;b&#x27;</span>), (<span class="number">5</span>,<span class="string">&#x27;c&#x27;</span>), (NULL,<span class="string">&#x27;d&#x27;</span>);</span><br></pre></td></tr></table></figure><br>无论innodb_autoinc_lock_mode如何设置,都会报错duplicate-key error 23000 (Can’t write; duplicate key in table)<br>因为5已经分配给了(NULL, ‘b’),所以导致插入(5, ‘C’)时报错</p>
<ul>
<li>在INSERT语句序列的中间修改AUTO_INCREMENT列值<br>在所有锁定模式（0,1和2）中，在INSERT语句序列中间修改AUTO_INCREMENT列值可能会导致<code>duplicate key</code>错误。 <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE t1 (</span><br><span class="line"><span class="code">    -&gt; c1 INT NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="code">    -&gt; PRIMARY KEY (c1)</span></span><br><span class="line"><span class="code">    -&gt;  ) ENGINE = InnoDB;</span></span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO t1 VALUES(0), (0), (3); -- 0 0分配两个值1,2. 手动指定3,则此时AUTO<span class="emphasis">_INCREMENT为3,下一个值为4</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; SELECT c1 FROM t1;</span></span><br><span class="line"><span class="emphasis">+----+</span></span><br><span class="line"><span class="emphasis">| c1 |</span></span><br><span class="line"><span class="emphasis">+----+</span></span><br><span class="line"><span class="emphasis">|  1 |</span></span><br><span class="line"><span class="emphasis">|  2 |</span></span><br><span class="line"><span class="emphasis">|  3 |</span></span><br><span class="line"><span class="emphasis">+----+</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; UPDATE t1 SET c1 = 4 WHERE c1 = 1;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; SELECT c1 FROM t1;</span></span><br><span class="line"><span class="emphasis">+----+</span></span><br><span class="line"><span class="emphasis">| c1 |</span></span><br><span class="line"><span class="emphasis">+----+</span></span><br><span class="line"><span class="emphasis">|  2 |</span></span><br><span class="line"><span class="emphasis">|  3 |</span></span><br><span class="line"><span class="emphasis">|  4 |</span></span><br><span class="line"><span class="emphasis">+----+</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; INSERT INTO t1 VALUES(0); --由于分配值为4,所以报错duplicate key</span></span><br><span class="line"><span class="emphasis">ERROR 1062 (23000): Duplicate entry &#x27;4&#x27; for key &#x27;PRIMARY&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="InnoDB-AUTO-INCREMENT计数器初始化"><a href="#InnoDB-AUTO-INCREMENT计数器初始化" class="headerlink" title="InnoDB AUTO_INCREMENT计数器初始化"></a>InnoDB AUTO_INCREMENT计数器初始化</h3><p>本章节讨论 InnoDB如何初始化AUTO_INCREMENT计数器<br>如果你为一个Innodb表创建了一个AUTO_INCREMENT列,则InnoDB数据字典中的表句柄包含一个称为自动递增计数器的特殊计数器，用于为列分配新值。 此计数器仅存在于内存中，而不存储在磁盘上。</p>
<p>要在服务器重新启动后初始化自动递增计数器，InnoDB将在首次插入行到包含AUTO_INCREMENT列的表时执行以下语句的等效语句。<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(ai_col) <span class="keyword">FROM</span> table_name <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><br>InnoDB增加语句检索的值，并将其分配给表和表的自动递增计数器。 默认情况下，值增加1.此默认值可以由auto_increment_increment配置设置覆盖。</p>
<p>如果表为空，InnoDB使用值1.此默认值可以由auto_increment_offset配置设置覆盖。</p>
<p>如果在自动递增计数器初始化前使用<code>SHOW TABLE STATUS</code>语句查看表, InnoDB将初始化计数器值,但不会递增该值.这个值会储存起来以备之后的插入语句使用.这个初始化过程使用了一个普通的排它锁来读取表中自增列的最大值. InnoDB遵循相同的过程来初始化新创建的表的自动递增计数器。</p>
<p>在自动递增计数器初始化之后，如果您未明确指定AUTO_INCREMENT列的值，InnoDB会递增计数器并将新值分配给该列。如果插入显式指定列值的行，并且该值大于当前计数器值，则将计数器设置为指定的列值。</p>
<p>只要服务器运行，InnoDB就使用内存中自动递增计数器。当服务器停止并重新启动时，InnoDB会重新初始化每个表的计数器，以便对表进行第一次INSERT，如前所述。</p>
<p>服务器重新启动还会取消CREATE TABLE和ALTER TABLE语句中的AUTO_INCREMENT = N表选项的效果</p>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>


<script src="/js/vdonate.js"></script>

<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: '打赏支持', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG65.jpeg',
  alipayImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG64.jpeg'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>大范</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2016/12/15/AUTO-INC锁和AUTO_INCREMENT在InnoDB中处理方式/" target="_blank" title="AUTO-INC锁和AUTO_INCREMENT在InnoDB中处理方式">http://fuxkdb.com/2016/12/15/AUTO-INC锁和AUTO_INCREMENT在InnoDB中处理方式/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/12/20/Auto_increment-%E4%BA%A7%E7%94%9F-GAP%E7%9A%84%E5%8E%9F%E5%9B%A0/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Auto_increment 产生 GAP的原因
        
      </div>
    </a>
  
  
    <a href="/2016/12/13/Innodb%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Innodb事务隔离级别</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#AUTO-INC-Locks"><span class="nav-number">1.</span> <span class="nav-text">AUTO-INC Locks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AUTO-INCREMENT-Handling-in-InnoDB"><span class="nav-number">2.</span> <span class="nav-text">AUTO_INCREMENT Handling in InnoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-AUTO-INCREMENT%E9%94%81%E5%AE%9A%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.</span> <span class="nav-text">InnoDB AUTO_INCREMENT锁定模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#innodb-autoinc-lock-mode-0-%E2%80%9Ctraditional%E2%80%9D-lock-mode"><span class="nav-number">2.1.1.</span> <span class="nav-text">innodb_autoinc_lock_mode &#x3D; 0 (“traditional” lock mode)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#innodb-autoinc-lock-mode-1-%E2%80%9Cconsecutive%E2%80%9D-lock-mode"><span class="nav-number">2.1.2.</span> <span class="nav-text">innodb_autoinc_lock_mode &#x3D; 1 (“consecutive” lock mode)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#innodb-autoinc-lock-mode-2-%E2%80%9Cinterleaved%E2%80%9D-lock-mode"><span class="nav-number">2.2.</span> <span class="nav-text">innodb_autoinc_lock_mode &#x3D; 2 (“interleaved” lock mode)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-AUTO-INCREMENT%E9%94%81%E5%AE%9A%E6%A8%A1%E5%BC%8F%E4%BD%BF%E7%94%A8%E5%90%AB%E4%B9%89"><span class="nav-number">2.3.</span> <span class="nav-text">InnoDB AUTO_INCREMENT锁定模式使用含义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB-AUTO-INCREMENT%E8%AE%A1%E6%95%B0%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.4.</span> <span class="nav-text">InnoDB AUTO_INCREMENT计数器初始化</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2022 Fan() All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Fan()
          </div>
          <div class="panel-body">
            Copyright © 2022 大范 All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>