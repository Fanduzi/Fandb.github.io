{"meta":{"title":"Fan()","subtitle":null,"description":null,"author":"å¤§èŒƒ","url":"http://fuxkdb.com"},"pages":[{"title":"tags","date":"2018-06-15T09:34:58.000Z","updated":"2018-06-15T09:35:25.000Z","comments":true,"path":"tags/index.html","permalink":"http://fuxkdb.com/tags/index.html","excerpt":"","text":""},{"title":"About","date":"2017-08-04T14:40:02.000Z","updated":"2019-06-22T17:07:58.000Z","comments":true,"path":"about/index.html","permalink":"http://fuxkdb.com/about/index.html","excerpt":"","text":"About Meä¸€ä¸ªèœğŸ“dba, ç›®å‰å°±èŒäºé©¬èœ‚çªCSDNåšå®¢MY BADGES"},{"title":"categories","date":"2018-06-15T09:29:28.000Z","updated":"2018-06-15T09:30:12.000Z","comments":true,"path":"categories/index.html","permalink":"http://fuxkdb.com/categories/index.html","excerpt":"","text":""}],"posts":[{"title":"Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-II","slug":"2022-05-06-Orchestrator-Failoverè¿‡ç¨‹æºç åˆ†æ-II","date":"2022-04-30T10:06:00.000Z","updated":"2022-05-15T08:47:00.066Z","comments":true,"path":"2022/04/30/2022-05-06-Orchestrator-Failoverè¿‡ç¨‹æºç åˆ†æ-II/","link":"","permalink":"http://fuxkdb.com/2022/04/30/2022-05-06-Orchestrator-Failover%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-II/","excerpt":"Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-IIä¹¦æ¥ä¸Šæ–‡Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-I DeadMasteræ¢å¤æµç¨‹é¦–å…ˆé€šè¿‡getCheckAndRecoverFunctionè·å–â€checkAndRecoverFunctionâ€123456789101112func getCheckAndRecoverFunction(analysisCode inst.AnalysisCode, analyzedInstanceKey *inst.InstanceKey) ( checkAndRecoverFunction func(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error), isActionableRecovery bool,) &#123; switch analysisCode &#123; // master case inst.DeadMaster, inst.DeadMasterAndSomeReplicas: // å¦‚æœanalysisCodeæ˜¯DeadMaster æˆ– DeadMasterAndSomeReplicas if isInEmergencyOperationGracefulPeriod(analyzedInstanceKey) &#123; // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¤„äº EmergencyOperationGracefulPeriod return checkAndRecoverGenericProblem, false // å¦‚æœå¤„äºEmergencyOperationGracefulPeriod, åˆ™åˆç›¸å½“äºå•¥ä¹Ÿæ²¡å¹², ç­‰ä¸‹ä¸€è½®recoverTick &#125; else &#123; return checkAndRecoverDeadMaster, true &#125;è¿™é‡Œå…ˆåˆ¤æ–­isInEmergencyOperationGracefulPeriod1234func isInEmergencyOperationGracefulPeriod(instanceKey *inst.InstanceKey) bool &#123; _, found := emergencyOperationGracefulPeriodMap.Get(instanceKey.StringCode()) // emergencyOperationGracefulPeriodMap æ˜¯ä¸€ä¸ªcache, æœ‰è¿‡æœŸæ—¶é—´çš„&quot;ç¼“å­˜&quot; return found&#125;å®é™…æ˜¯å°è¯•å»emergencyOperationGracefulPeriodMapè¿™ä¸ªcacheæ‰¾æœ‰æ²¡æœ‰è¿™ä¸ªinstance. é‚£ä¹ˆé—®é¢˜æ¥äº†, æ˜¯è°åœ¨ä»€ä¹ˆæ—¶å€™å‘è¿™ä¸ªcacheæ”¾è¿™ä¸ªinstanceå‘¢?å…¶å®æ˜¯åœ¨ä¸»åº“å¤„äºUnreachableMasterçŠ¶æ€ä¸‹, executeCheckAndRecoverFunctionä¸­è°ƒç”¨runEmergentOperationsæ—¶","text":"Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-IIä¹¦æ¥ä¸Šæ–‡Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-I DeadMasteræ¢å¤æµç¨‹é¦–å…ˆé€šè¿‡getCheckAndRecoverFunctionè·å–â€checkAndRecoverFunctionâ€123456789101112func getCheckAndRecoverFunction(analysisCode inst.AnalysisCode, analyzedInstanceKey *inst.InstanceKey) ( checkAndRecoverFunction func(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error), isActionableRecovery bool,) &#123; switch analysisCode &#123; // master case inst.DeadMaster, inst.DeadMasterAndSomeReplicas: // å¦‚æœanalysisCodeæ˜¯DeadMaster æˆ– DeadMasterAndSomeReplicas if isInEmergencyOperationGracefulPeriod(analyzedInstanceKey) &#123; // é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¤„äº EmergencyOperationGracefulPeriod return checkAndRecoverGenericProblem, false // å¦‚æœå¤„äºEmergencyOperationGracefulPeriod, åˆ™åˆç›¸å½“äºå•¥ä¹Ÿæ²¡å¹², ç­‰ä¸‹ä¸€è½®recoverTick &#125; else &#123; return checkAndRecoverDeadMaster, true &#125;è¿™é‡Œå…ˆåˆ¤æ–­isInEmergencyOperationGracefulPeriod1234func isInEmergencyOperationGracefulPeriod(instanceKey *inst.InstanceKey) bool &#123; _, found := emergencyOperationGracefulPeriodMap.Get(instanceKey.StringCode()) // emergencyOperationGracefulPeriodMap æ˜¯ä¸€ä¸ªcache, æœ‰è¿‡æœŸæ—¶é—´çš„&quot;ç¼“å­˜&quot; return found&#125;å®é™…æ˜¯å°è¯•å»emergencyOperationGracefulPeriodMapè¿™ä¸ªcacheæ‰¾æœ‰æ²¡æœ‰è¿™ä¸ªinstance. é‚£ä¹ˆé—®é¢˜æ¥äº†, æ˜¯è°åœ¨ä»€ä¹ˆæ—¶å€™å‘è¿™ä¸ªcacheæ”¾è¿™ä¸ªinstanceå‘¢?å…¶å®æ˜¯åœ¨ä¸»åº“å¤„äºUnreachableMasterçŠ¶æ€ä¸‹, executeCheckAndRecoverFunctionä¸­è°ƒç”¨runEmergentOperationsæ—¶ 123456789// executeCheckAndRecoverFunction will choose the correct check &amp; recovery function based on analysis.// It executes the function synchronuouslyfunc executeCheckAndRecoverFunction(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error) &#123; atomic.AddInt64(&amp;countPendingRecoveries, 1) defer atomic.AddInt64(&amp;countPendingRecoveries, -1) checkAndRecoverFunction, isActionableRecovery := getCheckAndRecoverFunction(analysisEntry.Analysis, &amp;analysisEntry.AnalyzedInstanceKey) // æœ€åˆå¤„äºUnreachableMasteræ—¶, è¿™é‡Œæ‹¿åˆ°çš„æ˜¯checkAndRecoverGenericProblem analysisEntry.IsActionableRecovery = isActionableRecovery runEmergentOperations(&amp;analysisEntry) å¯ä»¥çœ‹åˆ°, UnreachableMasteræ—¶, ä¼šè¿è¡ŒemergentlyReadTopologyInstance123456func runEmergentOperations(analysisEntry *inst.ReplicationAnalysis) &#123; switch analysisEntry.Analysis &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case inst.UnreachableMaster: // å®é™…ç›®çš„æ˜¯å¼ºåˆ¶é‡æ–°è¯»ä¸€ä¸‹è¯¥å®ä¾‹å’Œå…¶æ‰€æœ‰ä»åº“çš„&quot;ä¿¡æ¯&quot; go emergentlyReadTopologyInstance(&amp;analysisEntry.AnalyzedInstanceKey, analysisEntry.Analysis) go emergentlyReadTopologyInstanceReplicas(&amp;analysisEntry.AnalyzedInstanceKey, analysisEntry.Analysis)è€Œåœ¨emergentlyReadTopologyInstanceä¸­ä¼šå…ˆå°è¯•å‘emergencyReadTopologyInstanceMapä¸­Add1234567891011// Force a re-read of a topology instance; this is done because we need to substantiate a suspicion// that we may have a failover scenario. we want to speed up reading the complete picture.func emergentlyReadTopologyInstance(instanceKey *inst.InstanceKey, analysisCode inst.AnalysisCode) (instance *inst.Instance, err error) &#123; if existsInCacheError := emergencyReadTopologyInstanceMap.Add(instanceKey.StringCode(), true, cache.DefaultExpiration); existsInCacheError != nil &#123; // Just recently attempted return nil, nil &#125; instance, err = inst.ReadTopologyInstance(instanceKey) // ä¼šè°ƒç”¨ ReadTopologyInstanceBufferable inst.AuditOperation(&quot;emergently-read-topology-instance&quot;, instanceKey, string(analysisCode)) return instance, err&#125; ReadTopologyInstance å®é™…è°ƒç”¨ ReadTopologyInstanceBufferable è¿™ä¸ªcacheæ˜¯åœ¨logicåŒ…initæ—¶åˆ›å»ºçš„1emergencyOperationGracefulPeriodMap = cache.New(time.Second*5, time.Millisecond*500) // è¿‡æœŸæ—¶é—´5s isInEmergencyOperationGracefulPeriod å¦‚æœè¿”å›true, è¡¨ç¤ºå°šå¤„äºEmergentOperationsè¿è¡Œçª—å£æœŸå†…, æ‰€ä»¥éœ€è¦ç­‰è‹¥è¿”å›false, è¡¨ç¤ºå·²ç»å¯ä»¥å¼€å§‹â€æ¢å¤â€äº†, å°±ä¼šè¿”å›checkAndRecoverDeadMaster, å¹¶ä¸”isActionableRecoveryä¹Ÿä¸ºtrue executeCheckAndRecoverFunction12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879// It executes the function synchronuouslyfunc executeCheckAndRecoverFunction(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error) &#123; atomic.AddInt64(&amp;countPendingRecoveries, 1) defer atomic.AddInt64(&amp;countPendingRecoveries, -1) checkAndRecoverFunction, isActionableRecovery := getCheckAndRecoverFunction(analysisEntry.Analysis, &amp;analysisEntry.AnalyzedInstanceKey) analysisEntry.IsActionableRecovery = isActionableRecovery runEmergentOperations(&amp;analysisEntry) ...çœç•¥éƒ¨åˆ†ä»£ç  // Initiate detection: // å‘backend db topology_failure_detectionè¡¨insert ignore intoä¸€æ¡æ•°æ® // è¿™é‡Œ skipProcesses = false, æ‰€ä»¥ä¼šè°ƒç”¨ OnFailureDetectionProcesses é’©å­ // åˆ°è¿™é‡Œæˆ‘æ‰æ˜ç™½, åŸæ¥ skipProcesses æ„æ€æ˜¯ æ˜¯å¦è·³è¿‡ é’©å­çš„æ‰§è¡Œ registrationSuccess, _, err := checkAndExecuteFailureDetectionProcesses(analysisEntry, skipProcesses) if registrationSuccess &#123; if orcraft.IsRaftEnabled() &#123; _, err := orcraft.PublishCommand(&quot;register-failure-detection&quot;, analysisEntry) log.Errore(err) &#125; &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  // We don&#x27;t mind whether detection really executed the processes or not // (it may have been silenced due to previous detection). We only care there&#x27;s no error. // We&#x27;re about to embark on recovery shortly... // Check for recovery being disabled globally // çœ‹æ˜¯å¦å…¨å±€ç¦ç”¨äº†æ¢å¤, å¦‚é€šè¿‡API disable-global-recoveries å»ç¦ç”¨å…¨å±€æ¢å¤ if recoveryDisabledGlobally, err := IsRecoveryDisabled(); err != nil &#123; // Unexpected. Shouldn&#x27;t get this log.Errorf(&quot;Unable to determine if recovery is disabled globally: %v&quot;, err) &#125; else if recoveryDisabledGlobally &#123; // è¿™é‡ŒcheckAndRecoverä¼ çš„æ˜¯false if !forceInstanceRecovery &#123; // æ‰€ä»¥å¦‚æœå…¨å±€ç¦ç”¨äº†recover, recoverTickæ˜¯ä¸ä¼šè¿›è¡Œæ¢å¤çš„, å› ä¸ºforceInstanceRecoveryä¹Ÿæ˜¯false. è‡³æ­¤é€€å‡º log.Infof(&quot;CheckAndRecover: Analysis: %+v, InstanceKey: %+v, candidateInstanceKey: %+v, &quot;+ &quot;skipProcesses: %v: NOT Recovering host (disabled globally)&quot;, analysisEntry.Analysis, analysisEntry.AnalyzedInstanceKey, candidateInstanceKey, skipProcesses) return false, nil, err &#125; log.Infof(&quot;CheckAndRecover: Analysis: %+v, InstanceKey: %+v, candidateInstanceKey: %+v, &quot;+ &quot;skipProcesses: %v: recoveries disabled globally but forcing this recovery&quot;, analysisEntry.Analysis, analysisEntry.AnalyzedInstanceKey, candidateInstanceKey, skipProcesses) &#125; // å¼€å§‹è¿è¡ŒcheckAndRecoverFunction. æœ¬ä¾‹ä¸­æ˜¯è¿è¡ŒcheckAndRecoverDeadMaster // æˆ‘ä»¬å…ˆä¸çœ‹checkAndRecoverDeadMasterå…·ä½“å¹²äº†å•¥, å…ˆå¾€ä¸‹çœ‹ recoveryAttempted, topologyRecovery, err = checkAndRecoverFunction(analysisEntry, candidateInstanceKey, forceInstanceRecovery, skipProcesses) // å®å‚ä¸ºanalysisEntry, nil, false, false if !recoveryAttempted &#123; return recoveryAttempted, topologyRecovery, err &#125; if topologyRecovery == nil &#123; return recoveryAttempted, topologyRecovery, err &#125; if b, err := json.Marshal(topologyRecovery); err == nil &#123; log.Infof(&quot;Topology recovery: %+v&quot;, string(b)) &#125; else &#123; log.Infof(&quot;Topology recovery: %+v&quot;, *topologyRecovery) &#125; // skipProcesses=false if !skipProcesses &#123; // æ²¡æ¢å¤æˆåŠŸ, è°ƒç”¨ PostUnsuccessfulFailoverProcesses if topologyRecovery.SuccessorKey == nil &#123; // Execute general unsuccessful post failover processes executeProcesses(config.Config.PostUnsuccessfulFailoverProcesses, &quot;PostUnsuccessfulFailoverProcesses&quot;, topologyRecovery, false) &#125; else &#123; // å¦åˆ™è°ƒç”¨ PostFailoverProcesses // Execute general post failover processes inst.EndDowntime(topologyRecovery.SuccessorKey) executeProcesses(config.Config.PostFailoverProcesses, &quot;PostFailoverProcesses&quot;, topologyRecovery, false) &#125; &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  // ä»£ç åªè¦èƒ½èµ°åˆ°è¿™é‡Œ, å°±å¸¦è¡¨æ¢å¤æˆåŠŸäº†? recoveryAttemptedè‚¯å®šæ˜¯true // å…·ä½“çš„æ¢å¤æ“ä½œ, éƒ½åœ¨checkAndRecoverFunctioné‡Œ return recoveryAttempted, topologyRecovery, err&#125; å¯¹äºæœ¬æ–‡åœºæ™¯, å½“ä¸»åº“è¢«è®¤å®šå¤„äºDeadMasterçŠ¶æ€å:executeCheckAndRecoverFunctionä¼šå…ˆè°ƒç”¨getCheckAndRecoverFunctionè·å–: checkAndRecoverFunction: checkAndRecoverDeadMaster isActionableRecovery: true ç„¶åæ£€æŸ¥æ˜¯å¦â€ç¦ç”¨â€äº†å…¨å±€æ•…éšœæ¢å¤åŠŸèƒ½(å¦‚é€šè¿‡API disable-global-recoveries), å¦‚æœæ˜¯, åˆ™ç›´æ¥return æ¥ä¸‹æ¥, å¼€å§‹æ‰§è¡ŒcheckAndRecoverFunction, å³checkAndRecoverDeadMaster æˆ‘ä»¬å…ˆä¸çœ‹checkAndRecoverDeadMasterå…·ä½“é€»è¾‘, ç»§ç»­å¾€ä¸‹çœ‹. ä¸‹é¢çš„ä»£ç å°±æ˜¯æ ¹æ®checkAndRecoverFunctionçš„æ‰§è¡Œæƒ…å†µ(æ˜¯å¦æˆåŠŸæ¢å¤), è°ƒç”¨å¯¹åº”çš„é’©å­, æœ€åå°†æ¢å¤ç»“æœreturnå›å», å…¶å®åˆ°è¿™é‡Œ, æœ¬è½®æ¢å¤å°±ç®—åšå®Œäº†. å…·ä½“æ¢å¤æ˜¯å¦æˆåŠŸ, recoverTickä¹Ÿä¸å…³å¿ƒ. å…·ä½“å¦‚ä½•æ¢å¤çš„, è¿˜æ˜¯è¦çœ‹checkAndRecoverFunction(æœ¬ä¾‹ä¸­æ˜¯checkAndRecoverDeadMaster) å…³äºé’©å­, è§:OnFailureDetectionProcessesPostUnsuccessfulFailoverProcessesPostFailoverProcesses checkAndRecoverDeadMaster123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153// checkAndRecoverDeadMaster checks a given analysis, decides whether to take action, and possibly takes action// Returns true when action was taken.func checkAndRecoverDeadMaster(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error) &#123; // forceInstanceRecovery=false // HasAutomatedMasterRecovery æ˜¯åœ¨GetReplicationAnalysisä¸­ä¼šè¿è¡Œ a.ClusterDetails.ReadRecoveryInfo() // ReadRecoveryInfoä¸­ä¼šæ‰§è¡Œ this.HasAutomatedMasterRecovery = this.filtersMatchCluster(config.Config.RecoverMasterClusterFilters) // RecoverMasterClusterFilters æˆ‘ä»¬é…ç½®çš„æ˜¯ .* æ‰€ä»¥è¿™é‡Œä¸ºtrue // false || true = true // æ‰€ä»¥è¿™å¯¹äºrecoverTickæ¥è¯´, ç›®çš„æ˜¯æ£€æŸ¥ä¸€ä¸‹RecoverMasterClusterFiltersé…ç½®, çœ‹è¿™ä¸ªé›†ç¾¤åˆ°åº•é…æ²¡é…è‡ªåŠ¨æ•…éšœæ¢å¤ if !(forceInstanceRecovery || analysisEntry.ClusterDetails.HasAutomatedMasterRecovery) &#123; return false, nil, nil &#125; // å®å‚ &amp;analysisEntry, true, true // å°è¯•æ³¨å†Œä¸€ä¸ªæ¢å¤æ¡ç›®, å¦‚æœå¤±è´¥, æ„å‘³ç€ recovery is already in place. // è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªå®ä¾‹æ˜¯å¦æœ€è¿‘åˆšåˆšè¢«æå‡æˆ–é›†ç¾¤åˆšåˆšç»å†failoverï¼Œå¹¶ä¸”ä»ç„¶å¤„äºæ´»åŠ¨æœŸã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ‹’ç»æ¢å¤æ³¨å†Œï¼Œto avoid flapping. // å°±æ˜¯è¯´åˆšFailoveræ²¡å¤šä¹…åˆFailoverä¸è¡Œ, ç±»ä¼¼MHA 8å°æ—¶é™åˆ¶ // æ—¶é—´ç”±RecoveryPeriodBlockMinutesæ§åˆ¶, é»˜è®¤1å°æ—¶. ä¹Ÿæ˜¯åœ¨recoveryTickå¯åŠ¨åç¨‹æ˜¯ä¼šå»æ¸…ç†in_active_periodæ ‡è®°(updateä¸º0) // å¦‚æœä¸€åˆ‡æ²¡é—®é¢˜, ä¼šå‘æ•°æ®åº“topology_recoveryæ’å…¥ä¸€æ¡è®°å½•, å¹¶newä¸€ä¸ªtopologyRecoveryç»“æ„ä½“è¿”å›. // å¦åˆ™ topologyRecovery æ˜¯ nil topologyRecovery, err = AttemptRecoveryRegistration(&amp;analysisEntry, !forceInstanceRecovery, !forceInstanceRecovery) if topologyRecovery == nil &#123; // å¦‚æœ topologyRecovery = nil, è¯´æ˜æœ€è¿‘åˆšæ¢å¤å®Œ, æˆ–è€…æ­£åœ¨æ¢å¤, ç›´æ¥return AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;found an active or recent recovery on %+v. Will not issue another RecoverDeadMaster.&quot;, analysisEntry.AnalyzedInstanceKey)) return false, nil, err &#125; // That&#x27;s it! We must do recovery! AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;will handle DeadMaster event on %+v&quot;, analysisEntry.ClusterDetails.ClusterName)) recoverDeadMasterCounter.Inc(1) // æ­£å¼å¼€å§‹æ¢å¤ // å®å‚ä¸º topologyRecovery, nil, false recoveryAttempted, promotedReplica, lostReplicas, err := recoverDeadMaster(topologyRecovery, candidateInstanceKey, skipProcesses) ...çœç•¥éƒ¨åˆ†ä»£ç  topologyRecovery.LostReplicas.AddInstances(lostReplicas) // lostReplicas ç”±äºç§ç§åŸå› , æ²¡æœ‰æˆåŠŸchangeåˆ°new masterçš„ä»åº“ if !recoveryAttempted &#123; return false, topologyRecovery, err &#125; // ä»£ç è¿è¡Œåˆ°è¿™é‡Œæ—¶, å¯èƒ½å·²ç»é€‰ä¸¾å‡ºäº†new master, å³promotedReplica // è¿™ä¸ªå‡½æ•°è¡¥å……äº†ä¸€äº›åˆ¤æ–­æ¡ä»¶, åˆ¤æ–­è¿™ä¸ªpromotedReplicaæ˜¯ä¸æ˜¯å¯ä»¥åšnew master // ä¸»è¦å°±æ˜¯è¿™å‡ ä¸ªå‚æ•°: // - PreventCrossDataCenterMasterFailover // - PreventCrossRegionMasterFailover // - FailMasterPromotionOnLagMinutes // - FailMasterPromotionIfSQLThreadNotUpToDate // - DelayMasterPromotionIfSQLThreadNotUpToDate overrideMasterPromotion := func() (*inst.Instance, error) &#123; if promotedReplica == nil &#123; // No promotion; nothing to override. return promotedReplica, err &#125; // Scenarios where we might cancel the promotion. // è¿™ä¸ªå‡½æ•°å°±æ˜¯é€šè¿‡ä»¥ä¸‹å‚æ•°: // - PreventCrossDataCenterMasterFailover // - PreventCrossRegionMasterFailover // åˆ¤æ–­ promotedReplica æ˜¯å¦å¯ä»¥åš new master // PreventCrossDataCenterMasterFailover: // é»˜è®¤false . å½“ä¸ºtrue æ—¶, orchestratorå°†åªç”¨ä¸æ•…éšœé›†ç¾¤ä¸»åº“ä½äºåŒä¸€DCçš„ä»åº“æ›¿æ¢æ•…éšœçš„ä¸»åº“. å®ƒå°†å°½æœ€å¤§åŠªåŠ›ä»åŒä¸€DCä¸­æ‰¾åˆ°ä¸€ä¸ªæ›¿ä»£è€…, å¦‚æœæ‰¾ä¸åˆ°, å°†ä¸­æ­¢ï¼ˆå¤±è´¥ï¼‰æ•…éšœè½¬ç§». // PreventCrossRegionMasterFailover: // é»˜è®¤false . å½“ä¸ºtrue æ—¶, orchestratorå°†åªç”¨ä¸æ•…éšœé›†ç¾¤ä¸»åº“ä½äºåŒä¸€regionçš„ä»åº“æ›¿æ¢æ•…éšœçš„ä¸»åº“. å®ƒå°†å°½æœ€å¤§åŠªåŠ›æ‰¾åˆ°åŒä¸€regionçš„æ›¿ä»£è€…, å¦‚æœæ‰¾ä¸åˆ°, å°†ä¸­æ­¢ï¼ˆå¤±è´¥ï¼‰æ•…éšœè½¬ç§». if satisfied, reason := MasterFailoverGeographicConstraintSatisfied(&amp;analysisEntry, promotedReplica); !satisfied &#123; return nil, fmt.Errorf(&quot;RecoverDeadMaster: failed %+v promotion; %s&quot;, promotedReplica.Key, reason) &#125; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: promoted replica lag seconds: %+v&quot;, promotedReplica.ReplicationLagSeconds.Int64)) if config.Config.FailMasterPromotionOnLagMinutes &gt; 0 &amp;&amp; time.Duration(promotedReplica.ReplicationLagSeconds.Int64)*time.Second &gt;= time.Duration(config.Config.FailMasterPromotionOnLagMinutes)*time.Minute &#123; // candidate replica lags too much return nil, fmt.Errorf(&quot;RecoverDeadMaster: failed promotion. FailMasterPromotionOnLagMinutes is set to %d (minutes) and promoted replica %+v &#x27;s lag is %d (seconds)&quot;, config.Config.FailMasterPromotionOnLagMinutes, promotedReplica.Key, promotedReplica.ReplicationLagSeconds.Int64) &#125; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: promoted replica sql thread up-to-date: %+v&quot;, promotedReplica.SQLThreadUpToDate())) if config.Config.FailMasterPromotionIfSQLThreadNotUpToDate &amp;&amp; !promotedReplica.SQLThreadUpToDate() &#123; return nil, fmt.Errorf(&quot;RecoverDeadMaster: failed promotion. FailMasterPromotionIfSQLThreadNotUpToDate is set and promoted replica %+v &#x27;s sql thread is not up to date (relay logs still unapplied). Aborting promotion&quot;, promotedReplica.Key) &#125; if config.Config.DelayMasterPromotionIfSQLThreadNotUpToDate &amp;&amp; !promotedReplica.SQLThreadUpToDate() &#123; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;DelayMasterPromotionIfSQLThreadNotUpToDate: waiting for SQL thread on %+v&quot;, promotedReplica.Key)) if _, err := inst.WaitForSQLThreadUpToDate(&amp;promotedReplica.Key, 0, 0); err != nil &#123; return nil, fmt.Errorf(&quot;DelayMasterPromotionIfSQLThreadNotUpToDate error: %+v&quot;, err) &#125; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;DelayMasterPromotionIfSQLThreadNotUpToDate: SQL thread caught up on %+v&quot;, promotedReplica.Key)) &#125; // All seems well. No override done. AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: found no reason to override promotion of %+v&quot;, promotedReplica.Key)) return promotedReplica, err &#125; // è¿è¡Œ overrideMasterPromotion if promotedReplica, err = overrideMasterPromotion(); err != nil &#123; AuditTopologyRecovery(topologyRecovery, err.Error()) &#125; // And this is the end; whether successful or not, we&#x27;re done. resolveRecovery(topologyRecovery, promotedReplica) // Now, see whether we are successful or not. From this point there&#x27;s no going back. if promotedReplica != nil &#123; // æˆåŠŸé€‰ä¸¾é™¤äº†æ–°ä¸»åº“ // Success! recoverDeadMasterSuccessCounter.Inc(1) AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: successfully promoted %+v&quot;, promotedReplica.Key)) AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: promoted server coordinates: %+v&quot;, promotedReplica.SelfBinlogCoordinates)) // å½“ä¸ºtrue æ—¶, orchestrator å°†åœ¨é€‰ä¸¾å‡ºçš„æ–°ä¸»åº“ä¸Šæ‰§è¡Œreset slave all å’Œset read_only=0 . é»˜è®¤: true . å½“è¯¥å‚æ•°ä¸ºtrue æ—¶, å°†è¦†ç›–MasterFailoverDetachSlaveMasterHost . // æ‰€ä»¥è¿™ä¸ªifåˆ—æ“ä½œå°±æ˜¯æ‰§è¡Œåœ¨æ–°ä¸»åº“æ‰§è¡Œ reset slave all å’Œset read_only=0 if config.Config.ApplyMySQLPromotionAfterMasterFailover || analysisEntry.CommandHint == inst.GracefulMasterTakeoverCommandHint &#123; // on GracefulMasterTakeoverCommandHint it makes utter sense to RESET SLAVE ALL and read_only=0, and there is no sense in not doing so. AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: will apply MySQL changes to promoted master&quot;)) &#123; _, err := inst.ResetReplicationOperation(&amp;promotedReplica.Key) if err != nil &#123; // Ugly, but this is important. Let&#x27;s give it another try _, err = inst.ResetReplicationOperation(&amp;promotedReplica.Key) &#125; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: applying RESET SLAVE ALL on promoted master: success=%t&quot;, (err == nil))) if err != nil &#123; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: NOTE that %+v is promoted even though SHOW SLAVE STATUS may still show it has a master&quot;, promotedReplica.Key)) &#125; &#125; &#123; _, err := inst.SetReadOnly(&amp;promotedReplica.Key, false) AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: applying read-only=0 on promoted master: success=%t&quot;, (err == nil))) &#125; // Let&#x27;s attempt, though we won&#x27;t necessarily succeed, to set old master as read-only go func() &#123; // å¹¶ä¸”å°è¯•ç»™æ—§ä¸»åº“æ‰“å¼€åªè¯», æˆåŠŸä¸å¦æ— æ‰€ _, err := inst.SetReadOnly(&amp;analysisEntry.AnalyzedInstanceKey, true) AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: applying read-only=1 on demoted master: success=%t&quot;, (err == nil))) &#125;() &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  // å½“è¯¥å‚æ•°ä¸ºtrue æ—¶, orchestratorå°†å¯¹è¢«é€‰ä¸¾ä¸ºæ–°ä¸»åº“çš„èŠ‚ç‚¹æ‰§è¡Œdetach-replica-master-hostï¼ˆè¿™ç¡®ä¿äº†å³ä½¿æ—§ä¸»åº“&quot;å¤æ´»äº†&quot;, æ–°ä¸»åº“ä¹Ÿä¸ä¼šè¯•å›¾ä»æ—§ä¸»åº“å¤åˆ¶æ•°æ®ï¼‰. é»˜è®¤å€¼: false. å¦‚æœApplyMySQLPromotionAfterMasterFailoverä¸ºçœŸï¼Œè¿™ä¸ªå‚æ•°å°†å¤±å»æ„ä¹‰. if config.Config.MasterFailoverDetachReplicaMasterHost &#123; postponedFunction := func() error &#123; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;- RecoverDeadMaster: detaching master host on promoted master&quot;)) // æ‰€ä»¥è¯´ å¦‚æœ ApplyMySQLPromotionAfterMasterFailover=true, å°±å·²ç»å®Œæˆäº†reset slave alläº†. // é‚£ä¹ˆDetachReplicaMasterHostä¹Ÿå°±å¤±å»æ„ä¹‰äº† inst.DetachReplicaMasterHost(&amp;promotedReplica.Key) return nil &#125; topologyRecovery.AddPostponedFunction(postponedFunction, fmt.Sprintf(&quot;RecoverDeadMaster, detaching promoted master host %+v&quot;, promotedReplica.Key)) &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  if !skipProcesses &#123; // Execute post master-failover processes // æ‰§è¡Œé’©å­ PostMasterFailoverProcesses executeProcesses(config.Config.PostMasterFailoverProcesses, &quot;PostMasterFailoverProcesses&quot;, topologyRecovery, false) &#125; &#125; else &#123; // å¦åˆ™, è¯´æ˜æ¢å¤å¤±è´¥äº† recoverDeadMasterFailureCounter.Inc(1) &#125; return true, topologyRecovery, err&#125; checkAndRecoverDeadMaster é¦–å…ˆé€šè¿‡RecoverMasterClusterFilterså†æ¬¡åˆ¤æ–­è¿™ä¸ªå®ä¾‹æ˜¯å¦å¯ä»¥è¿›è¡Œè‡ªåŠ¨æ•…éšœæ¢å¤.æ¥ç€, è°ƒç”¨AttemptRecoveryRegistrationæ£€æŸ¥è¿™ä¸ªå®ä¾‹æ˜¯å¦æœ€è¿‘åˆšåˆšè¢«æå‡æˆ–è¯¥å®ä¾‹æ‰€å¤„é›†ç¾¤åˆšåˆšç»å†failover, å¹¶ä¸”ä»ç„¶å¤„äºæ´»åŠ¨æœŸ. å°±æ˜¯è¯´åˆšFailoveræ²¡å¤šä¹…åˆFailoverä¸è¡Œ, ç±»ä¼¼MHA 8å°æ—¶é™åˆ¶ æ´»åŠ¨æœŸçš„æ—¶é—´ç”±RecoveryPeriodBlockMinutesæ§åˆ¶, é»˜è®¤1å°æ—¶. ä¹Ÿæ˜¯åœ¨recoveryTickå¯åŠ¨åç¨‹æ—¶ä¼šå»æ¸…ç†in_active_periodæ ‡è®°(updateä¸º0)å¦‚æœä¸€åˆ‡æ²¡é—®é¢˜, ä¼šå‘æ•°æ®åº“topology_recoveryæ’å…¥ä¸€æ¡è®°å½•, å¹¶newä¸€ä¸ªtopologyRecoveryç»“æ„ä½“è¿”å›. å¦åˆ™ topologyRecovery æ˜¯ nil ä»¥ä¸Šæ£€æŸ¥éƒ½æ²¡é—®é¢˜çš„è¯, å°±æ­£å¼å¼€å§‹æ‰§è¡Œæ¢å¤, è°ƒç”¨recoverDeadMaster. æˆ‘ä»¬å…ˆä¸çœ‹recoverDeadMasterä»£ç , ç»§ç»­å¾€åçœ‹. recoverDeadMasteræœ€é‡è¦çš„æ˜¯ä¼šè¿”å›promotedReplica, å³é€‰ä¸¾å‡ºæ¥çš„æ–°ä¸»åº“ä»£ç è¿è¡Œåˆ°è¿™é‡Œæ—¶, å¯èƒ½å·²ç»é€‰ä¸¾å‡ºäº†new master, å³promotedReplica. éšåä¼šè¿è¡ŒoverrideMasterPromotionå‡½æ•°è¿™ä¸ªå‡½æ•°è¡¥å……äº†ä¸€äº›åˆ¤æ–­æ¡ä»¶, åˆ¤æ–­è¿™ä¸ªpromotedReplicaæ˜¯ä¸æ˜¯å¯ä»¥åšnew masterä¸»è¦å°±æ˜¯è¿™å‡ ä¸ªå‚æ•°: PreventCrossDataCenterMasterFailover PreventCrossRegionMasterFailover FailMasterPromotionOnLagMinutes FailMasterPromotionIfSQLThreadNotUpToDate DelayMasterPromotionIfSQLThreadNotUpToDate ä»¥ä¸Šä»»æ„ä¸€ä¸ªåˆ¤æ–­æœ‰é—®é¢˜, éƒ½ä¼šç»ˆæ­¢åç»­æ¢å¤åŠ¨ä½œ, ç›´æ¥return æœ€å, checkAndRecoverDeadMasterä¼šå¯¹new masterå’Œold masteråšä¸€äº›æ”¶å°¾å·¥ä½œ, å¦‚: å¦‚æœApplyMySQLPromotionAfterMasterFailoverä¸ºtrue, åˆ™ä¼šåœ¨æ–°ä¸»åº“æ‰§è¡Œ reset slave all å’Œset read_only=0, å¦åˆ™èµ°MasterFailoverDetachReplicaMasterHosté€»è¾‘ å°è¯•è¿æ¥æ—§ä¸»åº“æ‰“å¼€åªè¯» è‡³æ­¤, æ¢å¤æˆåŠŸå®Œæˆ.å…·ä½“çš„æ¢å¤é€»è¾‘, è¿˜è¦çœ‹recoverDeadMaster recoverDeadMaster12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697// recoverDeadMaster recovers a dead master, complete logic insidefunc recoverDeadMaster(topologyRecovery *TopologyRecovery, candidateInstanceKey *inst.InstanceKey, skipProcesses bool) (recoveryAttempted bool, promotedReplica *inst.Instance, lostReplicas [](*inst.Instance), err error) &#123; // ä¼ è¿›æ¥çš„å®å‚, topologyRecovery, nil, false topologyRecovery.Type = MasterRecovery analysisEntry := &amp;topologyRecovery.AnalysisEntry failedInstanceKey := &amp;analysisEntry.AnalyzedInstanceKey var cannotReplicateReplicas [](*inst.Instance) postponedAll := false inst.AuditOperation(&quot;recover-dead-master&quot;, failedInstanceKey, &quot;problem found; will recover&quot;) if !skipProcesses &#123; // æ‰§è¡Œé’©å­ if err := executeProcesses(config.Config.PreFailoverProcesses, &quot;PreFailoverProcesses&quot;, topologyRecovery, true); err != nil &#123; return false, nil, lostReplicas, topologyRecovery.AddError(err) &#125; &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  // topologyRecovery.RecoveryType = MasterRecoveryGTID topologyRecovery.RecoveryType = GetMasterRecoveryType(analysisEntry) ...çœç•¥éƒ¨åˆ†ä»£ç  // è¿™ä¸ªå‡½æ•°åˆ¤æ–­GetCandidateReplicaè¿”å›çš„candidateæ˜¯ä¸æ˜¯&quot;ç†æƒ³çš„&quot; // å¦‚æœæ˜¯&quot;ç†æƒ³çš„&quot; ä¸€äº›ä»åº“çš„æ¢å¤æ“ä½œå¯ä»¥å¼‚æ­¥æ¨è¿Ÿæ‰§è¡Œ // å¦åˆ™è¦åŒæ­¥æ‰§è¡Œ promotedReplicaIsIdeal := func(promoted *inst.Instance, hasBestPromotionRule bool) bool &#123; if promoted == nil &#123; return false &#125; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: promotedReplicaIsIdeal(%+v)&quot;, promoted.Key)) // candidateInstanceKeyå®å‚æ˜¯nil, æ‰€ä»¥èµ°ä¸åˆ°è¿™ä¸ªif if candidateInstanceKey != nil &#123; //explicit request to promote a specific server return promoted.Key.Equals(candidateInstanceKey) &#125; if promoted.DataCenter == topologyRecovery.AnalysisEntry.AnalyzedInstanceDataCenter &amp;&amp; promoted.PhysicalEnvironment == topologyRecovery.AnalysisEntry.AnalyzedInstancePhysicalEnvironment &#123; if promoted.PromotionRule == inst.MustPromoteRule || promoted.PromotionRule == inst.PreferPromoteRule || (hasBestPromotionRule &amp;&amp; promoted.PromotionRule != inst.MustNotPromoteRule) &#123; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: found %+v to be ideal candidate; will optimize recovery&quot;, promoted.Key)) postponedAll = true return true &#125; &#125; return false &#125; switch topologyRecovery.RecoveryType &#123; case MasterRecoveryGTID: &#123; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: regrouping replicas via GTID&quot;)) // promotedReplica æœ‰å¯èƒ½==nil lostReplicas, _, cannotReplicateReplicas, promotedReplica, err = inst.RegroupReplicasGTID(failedInstanceKey, true, false, nil, &amp;topologyRecovery.PostponedFunctionsContainer, promotedReplicaIsIdeal) &#125; // case MasterRecoveryPseudoGTID: // ...çœç•¥éƒ¨åˆ†ä»£ç  // case MasterRecoveryBinlogServer: // ...çœç•¥éƒ¨åˆ†ä»£ç  &#125; topologyRecovery.AddError(err) lostReplicas = append(lostReplicas, cannotReplicateReplicas...) ...çœç•¥éƒ¨åˆ†ä»£ç  if promotedReplica != nil &amp;&amp; len(lostReplicas) &gt; 0 &amp;&amp; config.Config.DetachLostReplicasAfterMasterFailover &#123; postponedFunction := func() error &#123; AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: lost %+v replicas during recovery process; detaching them&quot;, len(lostReplicas))) for _, replica := range lostReplicas &#123; replica := replica inst.DetachReplicaMasterHost(&amp;replica.Key) &#125; return nil &#125; // å¯¹lostReplicaså¹¶å‘æ‰§è¡Œ DetachReplicaMasterHost topologyRecovery.AddPostponedFunction(postponedFunction, fmt.Sprintf(&quot;RecoverDeadMaster, detach %+v lost replicas&quot;, len(lostReplicas))) &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  AuditTopologyRecovery(topologyRecovery, fmt.Sprintf(&quot;RecoverDeadMaster: %d postponed functions&quot;, topologyRecovery.PostponedFunctionsContainer.Len())) if promotedReplica != nil &amp;&amp; !postponedAll &#123; // æœ‰å€™é€‰äºº, å¹¶ä¸”ä¸æ˜¯ç†æƒ³çš„å€™é€‰äºº // è¿™é‡Œçš„æ„æ€æ˜¯, æˆ‘ä»¬ä¸€å¼€å§‹é€‰äº†ä¸€ä¸ªnew master, å¯èƒ½å› ä¸ºä»–æœ‰æœ€å…¨çš„æ—¥å¿—, ä½†æ˜¯, ä»–ä¸æ˜¯æˆ‘ä»¬è®¾ç½®çš„preferçš„å®ä¾‹, é‚£ä¹ˆæˆ‘ä»¬å°±é‡æ–°ç»„ç»‡ä¸€ä¸‹æ‹“æ‰‘, æŠŠpreferçš„å†å˜æˆnew master promotedReplica, err = replacePromotedReplicaWithCandidate(topologyRecovery, &amp;analysisEntry.AnalyzedInstanceKey, promotedReplica, candidateInstanceKey) topologyRecovery.AddError(err) &#125; if promotedReplica == nil &#123; message := &quot;Failure: no replica promoted.&quot; AuditTopologyRecovery(topologyRecovery, message) inst.AuditOperation(&quot;recover-dead-master&quot;, failedInstanceKey, message) &#125; else &#123; message := fmt.Sprintf(&quot;promoted replica: %+v&quot;, promotedReplica.Key) AuditTopologyRecovery(topologyRecovery, message) inst.AuditOperation(&quot;recover-dead-master&quot;, failedInstanceKey, message) &#125; return true, promotedReplica, lostReplicas, err&#125; recoverDeadMaster ä¸»è¦åšäº†å‡ ä»¶äº‹ ^a0c808 GetMasterRecoveryType, ç¡®å®šåˆ°åº•ç”¨ä»€ä¹ˆæ–¹å¼æ¢å¤, æ˜¯åŸºäºGTID? PseudoGTID? è¿˜æ˜¯BinlogServer? é‡ç»„æ‹“æ‰‘, æˆ‘ä»¬çš„æ¡ˆä¾‹æ˜¯ä½¿ç”¨RegroupReplicasGTID. ä½†è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜, å¯èƒ½ç°åœ¨æˆ‘ä»¬çš„æ–°ä¸»åº“å¹¶ä¸æ˜¯æˆ‘ä»¬â€æœŸæœ›â€çš„å®ä¾‹, å°±æ˜¯è¯´ä¹‹æ‰€ä»¥é€‰ä»–åšä¸»åº“å¯èƒ½æ˜¯å› ä¸ºä»–æœ‰æœ€å…¨çš„æ—¥å¿—. ä½†ä¸æ˜¯æˆ‘ä»¬è®¾ç½®çš„preferçš„ æ‰€ä»¥é€šè¿‡ä¸€ä¸ªé—­åŒ…promotedReplicaIsIdealå»åšäº†åˆ¤æ–­å’Œæ ‡è®°(é€šè¿‡postponedAll) å¦‚æœpostponedAll=false, åˆ™éœ€è¦é‡ç»„æ‹“æ‰‘, é€‰æ‹©preferçš„replicaä½œä¸ºæ–°ä¸»åº“ postponedAll=trueè¡¨æ˜¯candidateå°±æ˜¯â€ç†æƒ³å‹â€, æ‰€æœ‰replicaæ¢å¤å¯ä»¥å¹¶è¡Œå¼‚æ­¥æ‰§è¡Œ å¦‚æœå­˜åœ¨lostReplicas, å¹¶ä¸”å¼€å¯äº†DetachLostReplicasAfterMasterFailover, é‚£ä¹ˆä¼šå¹¶è¡Œçš„å¯¹æ‰€æœ‰lostReplicasæ‰§è¡ŒDetachReplicaMasterHost å…¶å®å°±æ˜¯æ‰§è¡Œchange master to master_host=â€™// {host}â€™ å¦‚æœå½“å‰é€‰ä¸¾çš„new masterä¸æ˜¯æˆ‘ä»¬preferçš„å®ä¾‹, é‡ç»„æ‹“æ‰‘, ç”¨preferåšæ–°ä¸»åº“ recoverDeadMasterè¿˜æ˜¯å¹²äº†æŒºå¤šäº‹å„¿çš„, å°¤å…¶æ˜¯RegroupReplicasGTIDä¸­çš„é€»è¾‘è¿˜æ˜¯å¾ˆå¤æ‚çš„. æœ¬æ–‡å°±å…ˆä¸ç»§ç»­å±•å¼€äº†, è¦çŸ¥åäº‹å¦‚ä½•, è¯·çœ‹Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-III åˆæ­¥æµç¨‹æ€»ç»“","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Orchestrator","slug":"Orchestrator","permalink":"http://fuxkdb.com/tags/Orchestrator/"}]},{"title":"Orchestrator Failoverè¿‡ç¨‹æºç åˆ†æ-I","slug":"2022-05-11-Orchestrator-Failoverè¿‡ç¨‹æºç åˆ†æ-I","date":"2022-04-28T07:08:00.000Z","updated":"2022-05-15T08:46:18.773Z","comments":true,"path":"2022/04/28/2022-05-11-Orchestrator-Failoverè¿‡ç¨‹æºç åˆ†æ-I/","link":"","permalink":"http://fuxkdb.com/2022/04/28/2022-05-11-Orchestrator-Failover%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-I/","excerpt":"æ¨¡æ‹Ÿæ•…éšœä½¿ç”¨æµ‹è¯•ç¯å¢ƒ, æ¨¡æ‹Ÿ3307é›†ç¾¤æ•…éšœ è§’è‰² IP ç«¯å£ ä¸»æœºå ä¸»åº“ 172.16.120.10 3307 centos-1 ä»åº“ 172.16.120.11 3307 centos-2 ä»åº“ 172.16.120.12 3307 centos-3 å…³é—­3307ä¸»åº“172.16.120.10:3307123456[2022-04-25 13:10:56][root@centos-1 13:10:56 ~][2022-04-25 13:11:22]#systemctl stop mysql3307mysqlæ—¥å¿—2022-04-25T13:11:35.959667+08:00 0 [Note] /usr/local/mysql5732/bin/mysqld: Shutdown complete","text":"æ¨¡æ‹Ÿæ•…éšœä½¿ç”¨æµ‹è¯•ç¯å¢ƒ, æ¨¡æ‹Ÿ3307é›†ç¾¤æ•…éšœ è§’è‰² IP ç«¯å£ ä¸»æœºå ä¸»åº“ 172.16.120.10 3307 centos-1 ä»åº“ 172.16.120.11 3307 centos-2 ä»åº“ 172.16.120.12 3307 centos-3 å…³é—­3307ä¸»åº“172.16.120.10:3307123456[2022-04-25 13:10:56][root@centos-1 13:10:56 ~][2022-04-25 13:11:22]#systemctl stop mysql3307mysqlæ—¥å¿—2022-04-25T13:11:35.959667+08:00 0 [Note] /usr/local/mysql5732/bin/mysqld: Shutdown complete æºç åˆ†ææˆ‘çš„æ€è·¯æ˜¯é€šè¿‡æ—¥å¿—æ‰¾å…¥å£.åœ¨ä¸‹æ–‡ä¸­: å¯¹ä¸»åº“ç®€ç§°ä¸ºcentos-1 å¯¹ä¸¤ä¸ªä»åº“åˆ†åˆ«ç®€ç§°ä¸º: centos-2 centos-3123456789101112131415[mysql] 2022/04/25 13:11:27 packets.go:37: unexpected EOF2022-04-25 13:11:27 ERROR invalid connection2022-04-25 13:11:27 ERROR ReadTopologyInstance(172.16.120.10:3307) show global status like &#x27;Uptime&#x27;: Error 1053: Server shutdown in progress[mysql] 2022/04/25 13:11:27 packets.go:37: unexpected EOF2022-04-25 13:11:27 ERROR invalid connection[mysql] 2022/04/25 13:11:27 packets.go:37: unexpected EOF2022-04-25 13:11:27 ERROR invalid connection2022-04-25 13:11:27 ERROR dial tcp 172.16.120.10:3307: connect: connection refused2022-04-25 13:11:28 ERROR dial tcp 172.16.120.10:3307: connect: connection refused2022-04-25 13:11:28 DEBUG writeInstance: will not update database_instance due to error: invalid connection2022-04-25 13:11:32 WARNING DiscoverInstance(172.16.120.10:3307) instance is nil in 0.104s (Backend: 0.001s, Instance: 0.103s), error=dial tcp 172.16.120.10:3307: connect: connection refused2022-04-25 13:11:33 DEBUG analysis: ClusterName: 172.16.120.10:3307, IsMaster: true, LastCheckValid: false, LastCheckPartialSuccess: false, CountReplicas: 2, CountValidReplicas: 2, CountValidReplicatingReplicas: 2, CountLaggingReplicas: 0, CountDelayedReplicas: 0, CountReplicasFailingToConnectToMaster: 02022-04-25 13:11:33 INFO executeCheckAndRecoverFunction: proceeding with UnreachableMaster detection on 172.16.120.10:3307; isActionable?: false; skipProcesses: false2022-04-25 13:11:33 INFO topology_recovery: detected UnreachableMaster failure on 172.16.120.10:33072022-04-25 13:11:33 INFO topology_recovery: Running 1 OnFailureDetectionProcesses hooks å…³é—­centos-1å, ä»æ—¥å¿—å¯ä»¥çœ‹å‡º: orchestratorå¯¹centos-1çš„ä¸€äº›æ¢æµ‹æ“ä½œå¤±è´¥äº† executeCheckAndRecoverFunction: proceeding with UnreachableMaster é€šè¿‡ç¬¬äºŒæ¡ä¿¡æ¯æ‰¾â€å…¥å£â€å…¨å±€æœç´¢executeCheckAndRecoverFunction: proceeding with æœç´¢åˆ°å‡½æ•°executeCheckAndRecoverFunction è¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿, å…ˆä¸çœ‹. å…ˆçœ‹ä¸€ä¸‹æ˜¯è°è°ƒç”¨ executeCheckAndRecoverFunction . æœç´¢executeCheckAndRecoverFunction(, æœåˆ°CheckAndRecover ç»§ç»­æœç´¢CheckAndRecover, æŸ¥åˆ°æ˜¯ContinuousDiscoveryåœ¨è°ƒç”¨å®ƒ ContinuousDiscovery åœ¨logicåŒ…ä¸­, è¢«http.standardHttpè°ƒç”¨, è€Œhttp.standardHttpåˆè¢«http.Httpè°ƒç”¨, http.Httpæ˜¯åœ¨å¯åŠ¨orchestratoræ—¶è¢«è°ƒç”¨çš„123456789101112131415161718go/cmd/orchestrator/main.go// æˆªå–éƒ¨åˆ†ä»£ç  switch &#123; case helpTopic != &quot;&quot;: app.HelpCommand(helpTopic) case len(flag.Args()) == 0 || flag.Arg(0) == &quot;cli&quot;: app.CliWrapper(*command, *strict, *instance, *destination, *owner, *reason, *duration, *pattern, *clusterAlias, *pool, *hostnameFlag) case flag.Arg(0) == &quot;http&quot;: app.Http(*discovery) default: fmt.Fprintln(os.Stderr, `Usage: orchestrator --options... [cli|http]See complete list of commands: orchestrator -c helpFull blown documentation: orchestrator`) os.Exit(1) &#125;&#125; ä¹Ÿå°±æ˜¯è¯´, å½“æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨orchestratorå1orchestrator -config orchestrator.conf.json -debug http å°±ä¼š http.Http -&gt; http.standardHttp -&gt; go logic.ContinuousDiscovery() ContinuousDiscoveryéƒ½å¹²äº†å•¥æŒç»­å‘ç°1234// ContinuousDiscovery starts an asynchronuous infinite discovery process where instances are// periodically investigated and their status captured, and long since unseen instances are // purged and forgotten.ContinuousDiscoveryå¯åŠ¨ä¸€ä¸ªæ°¸ä¸åœæ­¢çš„å¼‚æ­¥&quot;å‘ç°&quot;è¿‡ç¨‹, åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­, å®ä¾‹è¢«å‘¨æœŸæ€§åœ°è°ƒæŸ¥å¹¶æ•è·å®ƒä»¬çš„çŠ¶æ€, é•¿æœŸä»¥æ¥ä¸å¯è§çš„å®ä¾‹è¢«æ¸…é™¤å’Œé—å¿˜. è¿™æ®µæ³¨é‡Šä¸­ asynchronuous è¿˜æ‹¼å†™é”™äº†, åº”è¯¥æ˜¯ asynchronous ContinuousDiscovery å…ˆå¯åŠ¨ä¸€ä¸ªåç¨‹123func ContinuousDiscovery() &#123; ... go handleDiscoveryRequests() handleDiscoveryRequests åœ¨Orchestrator Discoveræºç åˆ†æä¸­ä»‹ç»è¿‡handleDiscoveryRequestsè¿­ä»£discoveryQueue channel å¹¶åœ¨æ¯ä¸ªæ¡ç›®ä¸Šè°ƒç”¨DiscoverInstance, è€ŒDiscoverInstanceåˆä¼šè°ƒç”¨ReadTopologyInstanceBufferable, åè€…ä¼šå®é™…è¿æ¥MySQLå®ä¾‹, è·å–å„ç§æŒ‡æ ‡/å‚æ•°ä¿¡æ¯, æœ€ç»ˆå°†ç»“æœå†™å…¥database_instance database_instance è¡¨ é‚£ä¹ˆdiscoveryQueueé‡Œçš„â€æ•°æ®â€åˆæ˜¯è°æ”¾è¿›æ¥çš„å‘¢?, æœ‰ä¸¤ä¸ªåœ°æ–¹ é€šè¿‡å‘½ä»¤è¡Œæˆ–å‰ç«¯é¡µé¢æ‰‹åŠ¨è§¦å‘â€å‘ç°â€æ—¶(æœ¬è´¨æ˜¯è°ƒç”¨orchestrator discoveræ¥å£), ä¼šå°†æŒ‡å®šinstanceçš„ReplicaKeyå’ŒMasterKeyæ”¾å…¥discoveryQueue ContinuousDiscovery è¿˜ä¼šåˆ›å»ºä¸€ä¸ªhealthTickå®šæ—¶å™¨, å‘¨æœŸæ€§(æ¯ç§’)è°ƒç”¨onHealthTick, onHealthTickä¼šå–å‡ºæ‰€æœ‰â€è¿‡æœŸâ€çš„instance, æ”¾åˆ°discoverQueueä¸­123456789101112131415const HealthPollSeconds = 1func ContinuousDiscovery() &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  healthTick := time.Tick(config.HealthPollSeconds * time.Second) ...çœç•¥éƒ¨åˆ†ä»£ç  for &#123; select &#123; case &lt;-healthTick: go func() &#123; onHealthTick() &#125;() ...çœç•¥éƒ¨åˆ†ä»£ç &#125; 1234567891011121314// onHealthTick handles the actions to take to discover/poll instancesfunc onHealthTick() &#123;...çœç•¥éƒ¨åˆ†ä»£ç  instanceKeys, err := inst.ReadOutdatedInstanceKeys() // è¯»å‡ºè¿‡æœŸçš„å®ä¾‹. è¿‡æœŸçš„å®šä¹‰æ˜¯: InstancePollSecondsç§’æœªæ¢æµ‹çš„connectableå®ä¾‹ æˆ– 2*InstancePollSecondsç§’æœªæ¢æµ‹çš„è¿æ¥å‡ºç°å¼‚å¸¸(hang)çš„å®ä¾‹ // avoid any logging unless there&#x27;s something to be done if len(instanceKeys) &gt; 0 &#123; for _, instanceKey := range instanceKeys &#123; if instanceKey.IsValid() &#123; discoveryQueue.Push(instanceKey) &#125; &#125;&#125; é‚£ä¹ˆå°±æ˜¯è¯´, æ¯ç§’é’Ÿ(HealthPollSeconds=1), onHealthTickä¼šæŠŠæ‰€æœ‰â€è¿‡æœŸâ€çš„å®ä¾‹æ”¾åˆ°discoveryQueue æµç¨‹å›¾ éœ€è¦ä¸å®ä¾‹è½®è¯¢(æˆ–å¤§è‡´)ç›¸åŒé¢‘ç‡çš„å¸¸è§„æ“ä½œ123456789101112131415161718192021func ContinuousDiscovery() &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  instancePollTick := time.Tick(instancePollSecondsDuration()) // InstancePollSeconds é»˜è®¤5ç§’ ...çœç•¥éƒ¨åˆ†ä»£ç  for &#123; select &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case &lt;-instancePollTick: // 5ç§’ä¸€æ¬¡ go func() &#123; // This tick does NOT do instance poll (these are handled by the oversampling discoveryTick) // But rather should invoke such routinely operations that need to be as (or roughly as) frequent // as instance poll if IsLeaderOrActive() &#123; go inst.UpdateClusterAliases() go inst.ExpireDowntime() go injectSeeds(&amp;seedOnce) &#125; &#125;() ...çœç•¥éƒ¨åˆ†ä»£ç &#125; çœ‹èµ·æ¥éƒ½æ˜¯äº›ä¸å¤ªé‡è¦çš„æ“ä½œ å®šæ—¶æ³¨å…¥ä¼ªGTID1234567891011121314151617const PseudoGTIDIntervalSeconds = 5func ContinuousDiscovery() &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  autoPseudoGTIDTick := time.Tick(time.Duration(config.PseudoGTIDIntervalSeconds) * time.Second) ...çœç•¥éƒ¨åˆ†ä»£ç  for &#123; select &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case &lt;-autoPseudoGTIDTick: go func() &#123; if config.Config.AutoPseudoGTID &amp;&amp; IsLeader() &#123; go InjectPseudoGTIDOnWriters() &#125; &#125;() ...çœç•¥éƒ¨åˆ†ä»£ç &#125; Pseudo GTID , ä¸å¤ªé‡è¦, ç°åœ¨è¿˜ä¼šæœ‰äººä¸å¼€GTIDå—? æŠ¤ç†å·¥ä½œ12345678910111213141516171819202122232425262728293031323334353637383940414243444546func ContinuousDiscovery() &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  caretakingTick := time.Tick(time.Minute) ...çœç•¥éƒ¨åˆ†ä»£ç  for &#123; select &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case &lt;-caretakingTick: // Various periodic internal maintenance tasks go func() &#123; if IsLeaderOrActive() &#123; go inst.RecordInstanceCoordinatesHistory() go inst.ReviewUnseenInstances() go inst.InjectUnseenMasters() go inst.ForgetLongUnseenInstances() go inst.ForgetLongUnseenClusterAliases() go inst.ForgetUnseenInstancesDifferentlyResolved() go inst.ForgetExpiredHostnameResolves() go inst.DeleteInvalidHostnameResolves() go inst.ResolveUnknownMasterHostnameResolves() go inst.ExpireMaintenance() go inst.ExpireCandidateInstances() go inst.ExpireHostnameUnresolve() go inst.ExpireClusterDomainName() go inst.ExpireAudit() go inst.ExpireMasterPositionEquivalence() go inst.ExpirePoolInstances() go inst.FlushNontrivialResolveCacheToDatabase() go inst.ExpireInjectedPseudoGTID() go inst.ExpireStaleInstanceBinlogCoordinates() go process.ExpireNodesHistory() go process.ExpireAccessTokens() go process.ExpireAvailableNodes() go ExpireFailureDetectionHistory() go ExpireTopologyRecoveryHistory() go ExpireTopologyRecoveryStepsHistory() if runCheckAndRecoverOperationsTimeRipe() &amp;&amp; IsLeader() &#123; go SubmitMastersToKvStores(&quot;&quot;, false) &#125; &#125; else &#123; // Take this opportunity to refresh yourself go inst.LoadHostnameResolveCache() &#125; &#125;() ä»æ–¹æ³•åå­—å¯ä»¥çœ‹å‡ºæ¥, å°±æ˜¯åšä¸€äº›â€æŠ¤ç†â€å·¥ä½œ, å¦‚: æ¸…ç†unseened instance, è¯¦è§å‚æ•°: UnseenInstanceForgetHours æ¸…ç†è¿‡æœŸå®¡è®¡æ—¥å¿— raftæŠ¤ç†å·¥ä½œ12345678910111213func ContinuousDiscovery() &#123; raftCaretakingTick := time.Tick(10 * time.Minute) ...çœç•¥éƒ¨åˆ†ä»£ç  for &#123; select &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case &lt;-raftCaretakingTick: if orcraft.IsRaftEnabled() &amp;&amp; orcraft.IsLeader() &#123; // publishDiscoverMasters will publish to raft a discovery request for all known masters. // This makes for a best-effort keep-in-sync between raft nodes, where some may have // inconsistent data due to hosts being forgotten, for example. go publishDiscoverMasters() &#125; å¦‚æœorchestratoræ˜¯[[raftæ¨¡å¼éƒ¨ç½²]]çš„, å¹¶ä¸”æœ¬èŠ‚ç‚¹æ˜¯leader, é‚£ä¹ˆleaderä¼šå‘å¸ƒä¸€ä¸ªdiscovery requestç»™æ¯ä¸ªraftèŠ‚ç‚¹, è¿™äº›èŠ‚ç‚¹ä¼šå¯¹æ‰€æœ‰MySQLä¸»åº“è¿›è¡Œdiscover. è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¿æŒæ‰€æœ‰raft nodesçš„æ•°æ®â€åŒæ­¥â€ A visual example å¦‚ä¸Šå›¾æ‰€ç¤º, ä¸‰ä¸ªorchestrator ç»„æˆä¸€ä¸ªraft cluster, æ¯ä¸ªorchestrator èŠ‚ç‚¹ä½¿ç”¨è‡ªå·±çš„ä¸“ç”¨æ•°æ®åº“(MySQLæˆ–SQLite) orchestrator èŠ‚ç‚¹ä¹‹é—´ä¼šè¿›è¡Œé€šä¿¡. åªæœ‰ä¸€ä¸ªorchestrator èŠ‚ç‚¹ä¼šæˆä¸ºleader. æ‰€æœ‰orchestratorèŠ‚ç‚¹æ¢æµ‹æ•´ä¸ªMySQLèˆ°é˜Ÿ. æ¯ä¸ªMySQL serveréƒ½è¢«æ¯ä¸ªraftæˆå‘˜æ¢æµ‹. ä¿å­˜æ‹“æ‰‘å¿«ç…§å¦‚æœSnapshotTopologiesIntervalHourså€¼å¤§äº0, é‚£ä¹ˆä¼šæ¯SnapshotTopologiesIntervalHourså°æ—¶ä¿å­˜database_instanceåˆ°database_instance_topology_history1234567891011121314151617func ContinuousDiscovery() &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  var snapshotTopologiesTick &lt;-chan time.Time if config.Config.SnapshotTopologiesIntervalHours &gt; 0 &#123; snapshotTopologiesTick = time.Tick(time.Duration(config.Config.SnapshotTopologiesIntervalHours) * time.Hour) &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  for &#123; select &#123; ..çœç•¥éƒ¨åˆ†ä»£ç  case &lt;-snapshotTopologiesTick: go func() &#123; if IsLeaderOrActive() &#123; go inst.SnapshotTopologies() &#125; &#125;() &#125;å°±æ˜¯æ‰§è¡Œinsert ignore into database_instance_topology_history select x from database_instance12345678910111213141516171819202122// SnapshotTopologies records topology graph for all existing topologiesfunc SnapshotTopologies() error &#123; writeFunc := func() error &#123; _, err := db.ExecOrchestrator(` insert ignore into database_instance_topology_history (snapshot_unix_timestamp, hostname, port, master_host, master_port, cluster_name, version) select UNIX_TIMESTAMP(NOW()), hostname, port, master_host, master_port, cluster_name, version from database_instance `, ) if err != nil &#123; return log.Errore(err) &#125; return nil &#125; return ExecDBWriteFunc(writeFunc)&#125; recoverå·¥ä½œ123456789101112131415161718192021222324252627282930313233343536373839const RecoveryPollSeconds = 1func ContinuousDiscovery() &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  continuousDiscoveryStartTime := time.Now() checkAndRecoverWaitPeriod := 3 * instancePollSecondsDuration() ...çœç•¥éƒ¨åˆ†ä»£ç  runCheckAndRecoverOperationsTimeRipe := func() bool &#123; return time.Since(continuousDiscoveryStartTime) &gt;= checkAndRecoverWaitPeriod &#125; ...çœç•¥éƒ¨åˆ†ä»£ç  recoveryTick := time.Tick(time.Duration(config.RecoveryPollSeconds) * time.Second) for &#123; select &#123; case &lt;-recoveryTick: go func() &#123; if IsLeaderOrActive() &#123; go ClearActiveFailureDetections() go ClearActiveRecoveries() go ExpireBlockedRecoveries() go AcknowledgeCrashedRecoveries() go inst.ExpireInstanceAnalysisChangelog() go func() &#123; // This function is non re-entrant (it can only be running once at any point in time) if atomic.CompareAndSwapInt64(&amp;recoveryEntrance, 0, 1) &#123; // å¦‚æœè¿”å›true, è¯´æ˜å½“æ—¶æ²¡æœ‰è¿è¡Œä¸­çš„æ¢å¤ä»»åŠ¡ defer atomic.StoreInt64(&amp;recoveryEntrance, 0) &#125; else &#123; // å¦åˆ™ç›´æ¥return return &#125; if runCheckAndRecoverOperationsTimeRipe() &#123; // ä»å¼€å§‹è¿è¡ŒContinuousDiscoveryè‡³ä»Šçš„æ—¶é—´ &gt; (3 * InstancePollSeconds = 15ç§’) æ‰å¯ä»¥è¿è¡Œrecover CheckAndRecover(nil, nil, false) &#125; else &#123; log.Debugf(&quot;Waiting for %+v seconds to pass before running failure detection/recovery&quot;, checkAndRecoverWaitPeriod.Seconds()) &#125; &#125;() &#125; &#125;() ä»æ³¨é‡Š// This function is non re-entrant (it can only be running once at any point in time) å¯ä»¥çœ‹å‡º, åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ¢å¤ä»»åŠ¡è¿è¡Œ atomic.CompareAndSwapInt64åœ¨Goè¯­è¨€ä¸­ï¼ŒåŸå­åŒ…æä¾›lower-levelåŸå­å†…å­˜ï¼Œè¿™å¯¹å®ç°åŒæ­¥ç®—æ³•å¾ˆæœ‰å¸®åŠ©ã€‚ Goè¯­è¨€ä¸­çš„CompareAndSwapInt64()å‡½æ•°ç”¨äºå¯¹int64å€¼æ‰§è¡Œæ¯”è¾ƒå’Œäº¤æ¢æ“ä½œã€‚æ­¤å‡½æ•°åœ¨åŸå­åŒ…ä¸‹å®šä¹‰ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦å¯¼å…¥â€œsync/atomicâ€è½¯ä»¶åŒ…æ‰èƒ½ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚ç”¨æ³•:1&gt;func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool)åœ¨è¿™é‡Œï¼Œaddrè¡¨ç¤ºåœ°å€ï¼Œoldè¡¨ç¤ºint64å€¼ï¼Œå®ƒæ˜¯ä»äº¤æ¢æ“ä½œè¿”å›çš„æ—§äº¤æ¢å€¼ï¼Œè€Œnewåˆ™æ˜¯int64æ–°å€¼ï¼Œå®ƒå°†ä¸æ—§äº¤æ¢å€¼è¿›è¡Œäº¤æ¢ã€‚è¿”å›å€¼ï¼šå¦‚æœäº¤æ¢å®Œæˆï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ æ¢å¤æœºåˆ¶çš„å…¥å£åœ¨CheckAndRecover CheckAndRecoverCheckAndRecover(nil, nil, false) CheckAndRecover é¦–å…ˆè°ƒç”¨GetReplicationAnalysis è·å–åˆ†æç»“æœreplicationAnalysis(æ˜¯ä¸€ä¸ªåˆ‡ç‰‡). åè€…å®é™…æ˜¯é€šè¿‡æŸ¥è¯¢database_instanceè¡¨, æŸ¥å‡ºæ‰€æœ‰æœ‰é—®é¢˜çš„å®ä¾‹ä¿¡æ¯, å°è£…æˆReplicationAnalysisç»“æ„ä½“, è¿™ä¸ªç»“æ„ä½“ä¸­åŒ…å«å®ä¾‹åŸºç¡€ä¿¡æ¯(å¦‚æ˜¯å¦æ˜¯ä¸»åº“, æ˜¯å¦å¼€å¯GTIDç­‰), Analysis(å³orcå®šä¹‰æ•…éšœåç§°, è¯¦è§Failure detection scenarios æ•…éšœæ£€æµ‹åœºæ™¯)å’ŒStructureAnalysis(å³æ‹“æ‰‘ç»“æ„çš„æ•…éšœåˆ—è¡¨, å¦‚NotEnoughValidSemiSyncReplicasStructureWarningç­‰) å½“ç„¶, GetReplicationAnalysisæœ‰å¯èƒ½è¿”å›ä¸€ä¸ªç©ºåˆ‡ç‰‡, å³ä»£è¡¨å½“å‰æ— ä»»ä½•æ•…éšœå¦‚æœGetReplicationAnalysisè¿”å›err!=nil, é‚£ä¹ˆæ•´ä¸ªCheckAndRecoverä¹Ÿä¼šå°±æ­¤é€€å‡ºreturn error æ¥ç€, CheckAndRecover æŒ‰éšæœºé¡ºåºè¿­ä»£replicationAnalysis, å¯¹æ¯ä¸€ä¸ªanalysisEntryå¼€å¯åç¨‹è°ƒç”¨executeCheckAndRecoverFunction1234go func() &#123; _, _, err := executeCheckAndRecoverFunction(analysisEntry, candidateInstanceKey, false, skipProcesses) // å®é™…å‚æ•°æ˜¯ analysisEntry, nil, false, false log.Errore(err) &#125;() executeCheckAndRecoverFunction å‡½æ•°æ³¨é‡Š// executeCheckAndRecoverFunction will choose the correct check &amp; recovery function based on analysis.// It executes the function synchronuously synchronuouslyæ‹¼å†™é”™è¯¯, åº”ä¸ºsynchronously ç›´è¯‘: executeCheckAndRecoverFunctionå°†æ ¹æ®åˆ†æé€‰æ‹©æ­£ç¡®çš„æ£€æŸ¥å’Œæ¢å¤å‡½æ•°ã€‚å®ƒåŒæ­¥åœ°æ‰§è¡Œè¯¥åŠŸèƒ½ executeCheckAndRecoverFunctionexecuteCheckAndRecoverFunction é¦–å…ˆè°ƒç”¨getCheckAndRecoverFunction, åè€…æ ¹æ®analysisEntry.Analysis(å³orcå®šä¹‰æ•…éšœåç§°, è¯¦è§Failure detection scenarios æ•…éšœæ£€æµ‹åœºæ™¯)è¿”å›å¯¹åº”çš„checkAndRecoverFunction, ä»¥åŠä¸€ä¸ªå¸ƒå°”å€¼isActionableRecovery, è¿™ä¸ªå€¼ä¼šèµ‹å€¼ç»™analysisEntry.IsActionableRecovery1checkAndRecoverFunction, isActionableRecovery := getCheckAndRecoverFunction(analysisEntry.Analysis, &amp;analysisEntry.AnalyzedInstanceKey)ä»¥æœ¬æ¬¡å®éªŒæ¨¡æ‹Ÿçš„ä¸»åº“å®•æœºä¸ºä¾‹, æˆ‘ä»¬å…³é—­ä¸»åº“å, ä¸»åº“ä¼šå…ˆè¢«è®¤ä¸ºå¤„äºUnreachableMasterçŠ¶æ€1234567891011121314151617func getCheckAndRecoverFunction(analysisCode inst.AnalysisCode, analyzedInstanceKey *inst.InstanceKey) ( checkAndRecoverFunction func(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (recoveryAttempted bool, topologyRecovery *TopologyRecovery, err error), isActionableRecovery bool,) &#123; switch analysisCode &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case inst.UnreachableMaster: return checkAndRecoverGenericProblem, false ...çœç•¥éƒ¨åˆ†ä»£ç  &#125; // Right now this is mostly causing noise with no clear action. // Will revisit this in the future. // case inst.AllMasterReplicasStale: // return checkAndRecoverGenericProblem, false return nil, false&#125;äºæ˜¯ç¬¬ä¸€æ¬¡, æ‹¿åˆ°çš„checkAndRecoverFunctionæ˜¯checkAndRecoverGenericProblem, è¿™ä¸ªå‡½æ•°å•¥ä¹Ÿæ²¡å¹², å°±æ˜¯è¿”å›fale, nil, nil1234// checkAndRecoverGenericProblem is a general-purpose recovery functionfunc checkAndRecoverGenericProblem(analysisEntry inst.ReplicationAnalysis, candidateInstanceKey *inst.InstanceKey, forceInstanceRecovery bool, skipProcesses bool) (bool, *TopologyRecovery, error) &#123; return false, nil, nil &#125; éšåä¼šè¿è¡ŒrunEmergentOperations1runEmergentOperations(&amp;analysisEntry)ä»¥æœ¬æ¬¡å®éªŒæ¨¡æ‹Ÿçš„ä¸»åº“å®•æœºä¸ºä¾‹, æˆ‘ä»¬å…³é—­ä¸»åº“å, ä¸»åº“ä¼šå…ˆè¢«è®¤ä¸ºå¤„äºUnreachableMasterçŠ¶æ€123456func runEmergentOperations(analysisEntry *inst.ReplicationAnalysis) &#123; switch analysisEntry.Analysis &#123; ...çœç•¥éƒ¨åˆ†ä»£ç  case inst.UnreachableMaster: go emergentlyReadTopologyInstance(&amp;analysisEntry.AnalyzedInstanceKey, analysisEntry.Analysis) go emergentlyReadTopologyInstanceReplicas(&amp;analysisEntry.AnalyzedInstanceKey, analysisEntry.Analysis) é‚£ä¹ˆæŒ‰ç…§ä»£ç é€»è¾‘, ä¼šè¿è¡Œ: emergentlyReadTopologyInstance emergentlyReadTopologyInstanceReplicasè¿™ä¸¤æ­¥å®é™…æ˜¯å»è¿æ¥æ•°æ®åº“å®ä¾‹(ä¸»åº“, å’Œå…¶æ‰€æœ‰çš„ä»åº“), è·å–å®ä¾‹çš„å„é¡¹ä¿¡æ¯(å¦‚ä»åº“çš„å¤åˆ¶å»¶è¿Ÿ, IO_THREADçŠ¶æ€ç­‰) ä¸‹é¢åˆ†åˆ«å±•ç¤ºäº†ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°çš„æ³¨é‡Š:12345678// Force a re-read of a topology instance; this is done because we need to substantiate a suspicion// that we may have a failover scenario. we want to speed up reading the complete picture.å¼ºåˆ¶é‡æ–°è¯»å–ä¸€ä¸ªæ‹“æ‰‘å®ä¾‹ï¼›è¿™æ ·åšæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦è¯å®ä¸€ä¸ªæ€€ç–‘ï¼Œå³æˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ªæ•…éšœè½¬ç§»çš„æƒ…å†µã€‚æˆ‘ä»¬å¸Œæœ›åŠ å¿«è¯»å–å®Œæ•´çš„å›¾ç‰‡ã€‚// Force reading of replicas of given instance. This is because we suspect the instance is dead, and want to speed up// detection of replication failure from its replicas.å¼ºåˆ¶è¯»å–ç»™å®šå®ä¾‹çš„å‰¯æœ¬ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ€€ç–‘è¯¥å®ä¾‹å·²ç»æ­»äº¡ï¼Œå¹¶å¸Œæœ›åŠ å¿«ä»å…¶å‰¯æœ¬ä¸­æ£€æµ‹å¤åˆ¶å¤±è´¥ã€‚ä»è¿™æ˜¯å¯ä»¥çœ‹å‡º, UnreachableMasteræ—¶, orcä¼šç«‹å³è§¦å‘å¯¹ä¸»ä»çš„æ¢æµ‹, ç›®çš„æ˜¯åŠ é€Ÿæ•´ä¸ªFailoveré€Ÿåº¦, è€Œä¸ä¾èµ–ä¸å‘¨æœŸæ€§æŒç»­æ¢æµ‹ æ¥ç€, executeCheckAndRecoverFunctionè¿è¡ŒcheckAndRecoverFunction(å³checkAndRecoverGenericProblem)12recoveryAttempted, topologyRecovery, err = checkAndRecoverFunction(analysisEntry, candidateInstanceKey, forceInstanceRecovery, skipProcesses)// å®å‚ä¸º analysisEntry, nil, false, falseæ‰€ä»¥è¿™é‡Œæ˜¯recoveryAttempted, topologyRecovery, errå°±æ˜¯false, nil .ç„¶åä»£ç åˆ¤æ–­recoveryAttemptedä¸ºfalseæ—¶, ç›´æ¥returnäº†123if !recoveryAttempted &#123; return recoveryAttempted, topologyRecovery, err &#125;äºæ˜¯è‡³æ­¤æµç¨‹å°±æ˜¯ é‚£ä¹ˆé—®é¢˜æ¥äº†, åªè¦GetReplicationAnalysisåˆ†æåä¸€ç›´è®¤ä¸ºæ•…éšœå¤„äºUnreachableMasterçŠ¶æ€, å°±ä¼šä¸€ç›´å¤„äºè¿™ä¸ªå¾ªç¯. æ‰€ä»¥è¦çœ‹ä¸€ä¸‹DeadMasterçš„åˆ¤æ–­é€»è¾‘æ˜¯ä»€ä¹ˆ.åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯è¿™æ ·å®šä¹‰çš„: ä¸»åº“è®¿é—®å¤±è´¥ æ‰€æœ‰ä¸»åº“çš„å‰¯æœ¬å¤åˆ¶å¤±è´¥ è¿™é‡Œåˆ—å‡ºåˆ†åˆ«åˆ—å‡º UnreachableMaster å’Œ DeadMaster ä»£ç åˆ¤æ–­é€»è¾‘123456789101112131415&#125; else if a.IsMaster &amp;&amp; !a.LastCheckValid &amp;&amp; a.CountValidReplicas == a.CountReplicas &amp;&amp; a.CountValidReplicatingReplicas == 0 &#123; a.Analysis = DeadMaster a.Description = &quot;Master cannot be reached by orchestrator and none of its replicas is replicating&quot; //&#125; else if a.IsMaster &amp;&amp; !a.LastCheckValid &amp;&amp; !a.LastCheckPartialSuccess &amp;&amp; a.CountValidReplicas &gt; 0 &amp;&amp; a.CountValidReplicatingReplicas &gt; 0 &#123; // partial success is here to reduce noise a.Analysis = UnreachableMaster a.Description = &quot;Master cannot be reached by orchestrator but it has replicating replicas; possibly a network/host issue&quot; // &#125; else if a.IsMaster &amp;&amp; !a.LastCheckValid &amp;&amp; a.LastCheckPartialSuccess &amp;&amp; a.CountReplicasFailingToConnectToMaster &gt; 0 &amp;&amp; a.CountValidReplicas &gt; 0 &amp;&amp; a.CountValidReplicatingReplicas &gt; 0 &#123; // there&#x27;s partial success, but also at least one replica is failing to connect to master a.Analysis = UnreachableMaster a.Description = &quot;Master cannot be reached by orchestrator but it has replicating replicas; possibly a network/host issue&quot; // database_instanceé‡è¦åˆ—å«ä¹‰è§£è¯»é¦–å…ˆ, ä¸Šé¢çš„a.IsMaster, a.LastCheckValidç­‰å±æ€§æ˜¯GetReplicationAnalysisé€šè¿‡SQLæŸ¥è¯¢backend dbçš„database_instanceç­‰è¡¨è·å–çš„. æ‰€ä»¥è¦è¯´æ¸…æ¥šè¿™äº›åˆ¤æ–­æ¡ä»¶, å°±è¦ç†è§£SQLå«ä¹‰, è¦ç†è§£SQLå«ä¹‰, å°±åˆè¦å…ˆäº†è§£database_instanceè¡¨ä¸­å‡ ä¸ªåˆ—çš„å«ä¹‰: last_checked æ— è®ºè¢«æ¢æµ‹çš„å®ä¾‹æ˜¯å¦å¯ä»¥è¿æ¥, éƒ½ä¼šæ›´æ–°æ­¤åˆ—å€¼ä¸ºNow() last_seen åªæœ‰å®ä¾‹æ¢æµ‹æ­£å¸¸, æ‰ä¼šæ›´æ–°æ­¤åˆ—å€¼ä¸ºNow() last_check_partial_success å¦‚æœè¢«æ¢æµ‹å®ä¾‹è‡³å°‘å¯ä»¥è¿æ¥å¹¶æ‰§è¡Œselect @@global.hostname.. åˆ™æ­¤åˆ—å€¼ä¸º1 last_attempted_check è¿™ä¸ªåˆ—å«ä¹‰æ¯”è¾ƒå¤æ‚. ç®€å•æ¥è¯´, å¦‚æœ last_attempted_check &lt;= last_checked é‚£ä¹ˆè¿™ç›®æ ‡å®ä¾‹æ˜¯æ­£å¸¸çš„, æ²¡æœ‰é‡åˆ°è¿æ¥hangä½çš„é—®é¢˜ ReplicationAnalysis å±æ€§å«ä¹‰è§£è¯»IsMaster ä¸»åº“(æœ¬èº«æ²¡æœ‰ä¸»åº“, ä¹Ÿä¸æ˜¯MGRæˆå‘˜)1234567891011121314/* To be considered a master, traditional async replication must not be present/valid AND the host should either *//* not be a replication group member OR be the primary of the replication group */MIN(master_instance.last_check_partial_success) as last_check_partial_success,MIN( ( master_instance.master_host IN (&#x27;&#x27;, &#x27;_&#x27;) OR master_instance.master_port = 0 OR substr(master_instance.master_host, 1, 2) = &#x27;//&#x27; ) AND ( master_instance.replication_group_name = &#x27;&#x27; OR master_instance.replication_group_member_role = &#x27;PRIMARY&#x27; )) AS is_master, substr(master_instance.master_host, 1, 2) = â€˜//â€˜çš„å«ä¹‰è¯¦è§DetachLostReplicasAfterMasterFailover LastCheckValid æœ¬å®ä¾‹æœ€è¿‘ä¸€æ¬¡æ¢æµ‹æ­£å¸¸1234567891011121314151617181920212223 MIN( master_instance.last_checked &lt;= master_instance.last_seen and master_instance.last_attempted_check &lt;= master_instance.last_seen + interval ? second ) = 1 AS is_last_check_validinterval ? çš„å®é™…å€¼æ˜¯// ValidSecondsFromSeenToLastAttemptedCheck returns the maximum allowed elapsed time// between last_attempted_check to last_checked before we consider the instance as invalid. func ValidSecondsFromSeenToLastAttemptedCheck() uint &#123; return config.Config.InstancePollSeconds + config.Config.ReasonableInstanceCheckSeconds &#125;5 + 1 = 6smaster_instance.last_checked &lt;= master_instance.last_seen è¡¨ç¤ºä¸»åº“æ¢æµ‹ä¸€åˆ‡æ­£å¸¸, å¦åˆ™è¡¨æ˜¯æ¢æµ‹æ˜¯æ— æ³•è”æœºæ•°æ®åº“æˆ–æŸ¥è¯¢å‡ºç°é”™è¯¯ç­‰master_instance.last_attempted_check &lt;= master_instance.last_seen + 6s å‡è®¾ last_attempted_check = 10:10 last_seen = 10:00é‚£ä¹ˆè¿™ç§æƒ…å†µè¡¨ç¤ºä¸»åº“æ¢æµ‹æœ‰é—®é¢˜, å¯èƒ½è¿æ¥hangä½äº†ä¸¤ä¸ªéƒ½ä¸ºtrue, true and trueå°±æ˜¯ 1. ç„¶åå†å’Œ1æ¯”è¾ƒ. LastCheckPartialSuccess æœ¬å®ä¾‹è‡³å°‘å¯ä»¥è¿æ¥å¹¶æ‰§è¡Œselect @@global.hostname..1MIN(master_instance.last_check_partial_success) as last_check_partial_success, CountReplicas æœ¬å®ä¾‹çš„ä»åº“æ•°é‡(æ— è®ºæ­»æ´»)1COUNT(replica_instance.server_id) AS count_replicas, CountValidReplicas æœ¬å®ä¾‹æ­£å¸¸çš„ä»åº“æ•°é‡(åªè¡¨ç¤ºå®ä¾‹æ­£å¸¸, èƒ½è¿æ¥èƒ½æŸ¥è¯¢, ä½†ä¸ä¸€å®šå¤åˆ¶æ­£å¸¸)123456IFNULL( SUM( replica_instance.last_checked &lt;= replica_instance.last_seen ), 0) AS count_valid_replicas, CountValidReplicatingReplicas æœ¬å®ä¾‹æ­£å¸¸ä¸”å¤åˆ¶çŠ¶æ€æ­£å¸¸çš„ä»åº“æ•°é‡12345678IFNULL( SUM( replica_instance.last_checked &lt;= replica_instance.last_seen AND replica_instance.slave_io_running != 0 AND replica_instance.slave_sql_running != 0 ), 0) AS count_valid_replicating_replicas, CountReplicasFailingToConnectToMaster æœ¬å®ä¾‹çš„, è‡ªèº«æ­£å¸¸(å¯è¿æ¥å¯æŸ¥è¯¢), IOçº¿ç¨‹å¤„äºè¿æ¥å¼‚å¸¸, SQLçº¿ç¨‹æ­£å¸¸çš„ä»åº“æ•°é‡12345678910IFNULL( SUM( replica_instance.last_checked &lt;= replica_instance.last_seen AND replica_instance.slave_io_running = 0 AND replica_instance.last_io_error like &#x27;%%error %%connecting to master%%&#x27; AND replica_instance.slave_sql_running = 1 ), 0) AS count_replicas_failing_to_connect_to_master, å†çœ‹ UnreachableMaster å’Œ DeadMaster123456789101112131415161718192021&#125; else if a.IsMaster &amp;&amp; !a.LastCheckValid &amp;&amp; a.CountValidReplicas == a.CountReplicas &amp;&amp; a.CountValidReplicatingReplicas == 0 &#123; a.Analysis = DeadMaster a.Description = &quot;Master cannot be reached by orchestrator and none of its replicas is replicating&quot; //æœ¬å®ä¾‹æ˜¯ä¸»åº“(æœ¬èº«æ²¡æœ‰ä¸»åº“, ä¹Ÿä¸æ˜¯MGRæˆå‘˜) &amp;&amp; æœ¬å®ä¾‹æœ€è¿‘ä¸€æ¬¡æ¢æµ‹å¼‚å¸¸ &amp;&amp; æœ¬å®ä¾‹æ­£å¸¸çš„ä»åº“æ•°é‡(åªè¡¨ç¤ºå®ä¾‹æ­£å¸¸, èƒ½è¿æ¥èƒ½æŸ¥è¯¢, ä½†ä¸ä¸€å®šå¤åˆ¶æ­£å¸¸) == æœ¬å®ä¾‹çš„ä»åº“æ•°é‡(æ— è®ºæ­»æ´») &amp;&amp; æœ¬å®ä¾‹æ­£å¸¸ä¸”å¤åˆ¶çŠ¶æ€æ­£å¸¸çš„ä»åº“æ•°é‡ä¸º0&#125; else if a.IsMaster &amp;&amp; !a.LastCheckValid &amp;&amp; !a.LastCheckPartialSuccess &amp;&amp; a.CountValidReplicas &gt; 0 &amp;&amp; a.CountValidReplicatingReplicas &gt; 0 &#123; // partial success is here to reduce noise a.Analysis = UnreachableMaster a.Description = &quot;Master cannot be reached by orchestrator but it has replicating replicas; possibly a network/host issue&quot; // æœ¬å®ä¾‹æ˜¯ä¸»åº“(æœ¬èº«æ²¡æœ‰ä¸»åº“, ä¹Ÿä¸æ˜¯MGRæˆå‘˜) &amp;&amp; æœ¬å®ä¾‹æœ€è¿‘ä¸€æ¬¡æ¢æµ‹å¼‚å¸¸ &amp;&amp; æœ¬å®ä¾‹æ— æ³•è¿æ¥ &amp;&amp; æœ¬å®ä¾‹æ­£å¸¸çš„ä»åº“æ•°é‡(åªè¡¨ç¤ºå®ä¾‹æ­£å¸¸, èƒ½è¿æ¥èƒ½æŸ¥è¯¢, ä½†ä¸ä¸€å®šå¤åˆ¶æ­£å¸¸) &gt; 0 &amp;&amp; æœ¬å®ä¾‹æ­£å¸¸ä¸”å¤åˆ¶çŠ¶æ€æ­£å¸¸çš„ä»åº“æ•°é‡ &gt; 0&#125; else if a.IsMaster &amp;&amp; !a.LastCheckValid &amp;&amp; a.LastCheckPartialSuccess &amp;&amp; a.CountReplicasFailingToConnectToMaster &gt; 0 &amp;&amp; a.CountValidReplicas &gt; 0 &amp;&amp; a.CountValidReplicatingReplicas &gt; 0 &#123; // there&#x27;s partial success, but also at least one replica is failing to connect to master a.Analysis = UnreachableMaster a.Description = &quot;Master cannot be reached by orchestrator but it has replicating replicas; possibly a network/host issue&quot; //æœ¬å®ä¾‹æ˜¯ä¸»åº“(æœ¬èº«æ²¡æœ‰ä¸»åº“, ä¹Ÿä¸æ˜¯MGRæˆå‘˜) &amp;&amp; æœ¬å®ä¾‹æœ€è¿‘ä¸€æ¬¡æ¢æµ‹å¼‚å¸¸ &amp;&amp; æœ¬å®ä¾‹æ— æ³•è¿æ¥ &amp;&amp; æœ¬å®ä¾‹çš„, è‡ªèº«æ­£å¸¸(å¯è¿æ¥å¯æŸ¥è¯¢), IOçº¿ç¨‹å¤„äºè¿æ¥å¼‚å¸¸, SQLçº¿ç¨‹æ­£å¸¸çš„ä»åº“æ•°é‡ &gt; 0 &amp;&amp; æœ¬å®ä¾‹æ­£å¸¸ä¸”å¤åˆ¶çŠ¶æ€æ­£å¸¸çš„ä»åº“æ•°é‡ &gt; 0 ç”±æ­¤å¯ä»¥çœ‹å‡º, Masterå®•æœºåçš„æœ€åˆä¸€æ®µæ—¶é—´å†…, orchestratorå·²ç»æ— æ³•è¿æ¥Master, ä½†æ˜¯å¹¶éæ‰€æœ‰ä»åº“éƒ½æ„è¯†åˆ°ä¸»åº“å·²ç»å®•æœº, IOçº¿ç¨‹å¯èƒ½è¿˜æ˜¯å¤„äºRUNNINGçŠ¶æ€(è¿™ä¸slave_net_timeoutæœ‰å…³, Orchestratorå®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰æè¿°) . æ‰€ä»¥åœ¨è¿™æ®µæ—¶é—´å†…, orchestratorè®¤ä¸ºMasterå¤„äºUnreachableMaster çŠ¶æ€, é€šè¿‡getCheckAndRecoverFunctionè·å–çš„å°±æ°¸è¿œæ˜¯checkAndRecoverGenericProblem(ä¹Ÿå°±æ˜¯å•¥éƒ½ä¸å¹², ç›´æ¥return) ç›´åˆ°æ‰€æœ‰ä»åº“å¤åˆ¶çŠ¶æ€éƒ½å‡ºç°å¼‚å¸¸, orchestratoræ‰ä¼šè®¤ä¸ºMasterå¤„äºDeadMasterçŠ¶æ€. é‚£ä¹ˆæ­¤ågetCheckAndRecoverFunctionä¼šè¿”å›checkAndRecoverDeadMaster, è€Œè¿™æ‰æ˜¯Failoverçš„çœŸæ­£å¼€å§‹ åˆæ­¥æµç¨‹æ€»ç»“","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Orchestrator","slug":"Orchestrator","permalink":"http://fuxkdb.com/tags/Orchestrator/"}]},{"title":"Orchestrator Discoveræºç åˆ†æ","slug":"2022-04-26-Orchestrator-Discoveræºç åˆ†æ","date":"2022-04-26T15:04:00.000Z","updated":"2022-05-14T13:05:42.985Z","comments":true,"path":"2022/04/26/2022-04-26-Orchestrator-Discoveræºç åˆ†æ/","link":"","permalink":"http://fuxkdb.com/2022/04/26/2022-04-26-Orchestrator-Discover%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","excerpt":"Orchestrator Discoveræºç åˆ†æåœ¨æ¢³ç†HostnameResolveMethodå’Œ MySQLHostnameResolveMethod ä¸¤ä¸ªå‚æ•°æ—¶æˆ‘äº§ç”Ÿäº†ä¸€äº›è¿·æƒ‘. æ‰€ä»¥æ·±å…¥çœ‹äº†ä¸‹orchestratoræºç , å†æ­¤è®°å½•ä¸‹. orchestrator-clienté˜…è¯»orchestrator-clientå¯ä»¥å‘ç°, æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤åšâ€æœåŠ¡å‘ç°â€ 123orchestrator-client -c discover -i 172.16.120.10:3306å‡è®¾ 172.16.120.10 ä¸»æœºåä¸º centos-1 orchestrator-clientæ˜¯ä¸€ä¸ªè„šæœ¬, ç”¨æ–¹ä¾¿çš„å‘½ä»¤è¡Œç•Œé¢åŒ…è£…APIè°ƒç”¨. å®ƒå¯ä»¥è‡ªåŠ¨ç¡®å®šorchestratoré›†ç¾¤çš„leader, å¹¶åœ¨è¿™ç§æƒ…å†µä¸‹å°†æ‰€æœ‰è¯·æ±‚è½¬å‘ç»™leader. å®ƒéå¸¸æ¥è¿‘äºorchestrator command line interface. orchestrator-client -help æœ‰bug, å·²æäº¤PR. orchestrator-client helpä¿¡æ¯ä¹Ÿæ²¡æœ‰ä»‹ç»-iå‚æ•° æŸ¥çœ‹orchestrator-clientæºç  123456while getopts &quot;c:i:d:s:a:D:U:o:r:u:R:t:l:H:P:q:b:e:n:S:h&quot; OPTIONdo case $OPTION in h) command=&quot;help&quot; ;; c) command=&quot;$OPTARG&quot; ;; i) instance=&quot;$OPTARG&quot; ;; å¯ä»¥çœ‹å‡º-i çš„å€¼ç»™äº†instanceå˜é‡. åœ¨mainè¡Œæ•°ä¸­ä¼šå…ˆå¤„ç†instance 123456789function main &#123; check_requirements detect_leader_api instance_hostport=$(to_hostport $instance) destination_hostport=$(to_hostport $destination) run_command&#125;","text":"Orchestrator Discoveræºç åˆ†æåœ¨æ¢³ç†HostnameResolveMethodå’Œ MySQLHostnameResolveMethod ä¸¤ä¸ªå‚æ•°æ—¶æˆ‘äº§ç”Ÿäº†ä¸€äº›è¿·æƒ‘. æ‰€ä»¥æ·±å…¥çœ‹äº†ä¸‹orchestratoræºç , å†æ­¤è®°å½•ä¸‹. orchestrator-clienté˜…è¯»orchestrator-clientå¯ä»¥å‘ç°, æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤åšâ€æœåŠ¡å‘ç°â€ 123orchestrator-client -c discover -i 172.16.120.10:3306å‡è®¾ 172.16.120.10 ä¸»æœºåä¸º centos-1 orchestrator-clientæ˜¯ä¸€ä¸ªè„šæœ¬, ç”¨æ–¹ä¾¿çš„å‘½ä»¤è¡Œç•Œé¢åŒ…è£…APIè°ƒç”¨. å®ƒå¯ä»¥è‡ªåŠ¨ç¡®å®šorchestratoré›†ç¾¤çš„leader, å¹¶åœ¨è¿™ç§æƒ…å†µä¸‹å°†æ‰€æœ‰è¯·æ±‚è½¬å‘ç»™leader. å®ƒéå¸¸æ¥è¿‘äºorchestrator command line interface. orchestrator-client -help æœ‰bug, å·²æäº¤PR. orchestrator-client helpä¿¡æ¯ä¹Ÿæ²¡æœ‰ä»‹ç»-iå‚æ•° æŸ¥çœ‹orchestrator-clientæºç  123456while getopts &quot;c:i:d:s:a:D:U:o:r:u:R:t:l:H:P:q:b:e:n:S:h&quot; OPTIONdo case $OPTION in h) command=&quot;help&quot; ;; c) command=&quot;$OPTARG&quot; ;; i) instance=&quot;$OPTARG&quot; ;; å¯ä»¥çœ‹å‡º-i çš„å€¼ç»™äº†instanceå˜é‡. åœ¨mainè¡Œæ•°ä¸­ä¼šå…ˆå¤„ç†instance 123456789function main &#123; check_requirements detect_leader_api instance_hostport=$(to_hostport $instance) destination_hostport=$(to_hostport $destination) run_command&#125; to_hostportæ˜¯ä¸€ä¸ªå‡½æ•°. å¯ä»¥çœ‹å‡º -i å¯æ¥å—hostname:port / ip:port / hostname / ip 1234567891011121314151617# to_hostport transforms:# - fqdn:port =&gt; fqdn/port# - fqdn =&gt; fqdn/default_portfunction to_hostport &#123; instance_key=&quot;$1&quot; if [ -z &quot;$instance_key&quot; ] ; then # å¦‚æœ instance_key ä¸ºç©º echo &quot;&quot; return fi if [[ $instance_key == *&quot;:&quot;* ]]; then # å¦‚æœ-iä¸­åŒ…å« &#x27;:&#x27; echo $instance_key | tr &#x27;:&#x27; &#x27;/&#x27; # å°†å¼•å·æ›¿æ¢ä¸º &#x27;/&#x27; else # å¦åˆ™, è®¤ä¸ºåªæŒ‡å®šäº† hostname/ip, é‚£ä¹ˆç«¯å£ç”¨default_port. default_portåœ¨è„šæœ¬å¼€å¤´å®šä¹‰äº†, å°±æ˜¯3306 echo &quot;$instance_key/$default_port&quot; fi&#125; run_commandä¼šå®é™…æ ¹æ®å‘½ä»¤è¡Œä¼ å‚, è°ƒç”¨å¯¹åº”çš„å‡½æ•° 123456789function run_command &#123; if [ -z &quot;$command&quot; ] ; then fail &quot;No command given. Use $myname -c &lt;command&gt; [...] or $myname --command &lt;command&gt; [...] to do something useful&quot; fi command=$(echo $command | universal_sed -e &#x27;s/slave/replica/&#x27;) case $command in &quot;help&quot;) prompt_help ;; # Show available commands... &quot;discover&quot;) discover ;; # Lookup an instance, investigate it discoverå‡½æ•° 12345function discover &#123; assert_nonempty &quot;instance&quot; &quot;$instance_hostport&quot; api &quot;discover/$instance_hostport&quot; print_details | filter_key | print_key&#125; è¿™é‡Œapiå…¶å®ä¹Ÿæ˜¯ä¸ªå‡½æ•°, å°±ä¸å±•å¼€çœ‹äº†. å…¶æœ¬è´¨æœ€ç»ˆæ˜¯æ‰§è¡Œcurlå‘½ä»¤ 1curl $&#123;curl_auth_params&#125; -s &quot;/api/discover/$instance_hostport&quot; | jq &#x27;.&#x27; å…¶å®å°±æ˜¯è°ƒç”¨httpæ¥å£ orchestrator discoveræ¥å£^99dde2 åœ¨ go/http/api.go ä¸­å®šä¹‰äº†orchestratoræä¾›çš„æ¥å£. å…¶ä¸­, å¯ä»¥æ‰¾åˆ°discoverå¯¹åº”çš„è·¯ç”±ä¿¡æ¯ 1this.registerAPIRequest(m, &quot;discover/:host/:port&quot;, this.Discover) é‚£æ¥ä¸‹æ¥é‡ç‚¹, å°±æ˜¯çœ‹Discoveræ–¹æ³•äº† Discover ä»¥ä¸‹å†…ä¸­â†“â†“â†“ è¡¨ç¤ºä¸‹é’»è¿›å¯¹åº”å‡½æ•°ä¸­ è¿™é‡Œä¸€ç‚¹ä¸€ç‚¹çœ‹ 12345678910111213141516171819202122232425// Discover issues a synchronous read on an instancefunc (this *HttpAPI) Discover(params martini.Params, r render.Render, req *http.Request, user auth.User) &#123; if !isAuthorizedForAction(req, user) &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: &quot;Unauthorized&quot;&#125;) return &#125; instanceKey, err := this.getInstanceKey(params[&quot;host&quot;], params[&quot;port&quot;]) if err != nil &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: err.Error()&#125;) return &#125; instance, err := inst.ReadTopologyInstance(&amp;instanceKey) if err != nil &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: err.Error()&#125;) return &#125; if orcraft.IsRaftEnabled() &#123; orcraft.PublishCommand(&quot;discover&quot;, instanceKey) &#125; else &#123; logic.DiscoverInstance(instanceKey) &#125; Respond(r, &amp;APIResponse&#123;Code: OK, Message: fmt.Sprintf(&quot;Instance discovered: %+v&quot;, instance.Key), Details: instance&#125;)&#125; çœ‹ç¬¬7è¡Œ -&gt;getInstanceKey12345678instanceKey, err := this.getInstanceKey(params[&quot;host&quot;], params[&quot;port&quot;]) â†“â†“â†“ getInstanceKeyfunc (this *HttpAPI) getInstanceKey(host string, port string) (inst.InstanceKey, error) &#123; // host, portå°±æ˜¯ orchestrator-client -c discover -i 172.16.120.10:3306 ä¸­çš„ -i return this.getInstanceKeyInternal(host, port, true)&#125; getInstanceKeyInternal123456789101112131415161718192021func (this *HttpAPI) getInstanceKeyInternal(host string, port string, resolve bool) (inst.InstanceKey, error) &#123; var instanceKey *inst.InstanceKey var err error if resolve &#123; // getInstanceKeyä¼ çš„resolveæ˜¯true // æ‰€ä»¥èµ°è¿™é‡Œ instanceKey, err = inst.NewResolveInstanceKeyStrings(host, port) &#125; else &#123; instanceKey, err = inst.NewRawInstanceKeyStrings(host, port) &#125; if err != nil &#123; return emptyInstanceKey, err &#125; instanceKey, err = inst.FigureInstanceKey(instanceKey, nil) if err != nil &#123; return emptyInstanceKey, err &#125; if instanceKey == nil &#123; return emptyInstanceKey, fmt.Errorf(&quot;Unexpected nil instanceKey in getInstanceKeyInternal(%+v, %+v, %+v)&quot;, host, port, resolve) &#125; return *instanceKey, nil&#125; -&gt;NewResolveInstanceKeyStrings12345678910111213141516171819202122232425262728293031323334353637383940414243// NewResolveInstanceKeyStrings creates and resolves a new instance key based on string paramsfunc NewResolveInstanceKeyStrings(hostname string, port string) (*InstanceKey, error) &#123; return newInstanceKeyStrings(hostname, port, true)&#125; â†“â†“â†“ newInstanceKeyStrings// newInstanceKeyStringsfunc newInstanceKeyStrings(hostname string, port string, resolve bool) (*InstanceKey, error) &#123; if portInt, err := strconv.Atoi(port); err != nil &#123; // å°†portå­—ç¬¦ä¸²è½¬int return nil, fmt.Errorf(&quot;Invalid port: %s&quot;, port) &#125; else &#123; // è½¬æ¢æˆåŠŸ, èµ°è¿™é‡Œ return newInstanceKey(hostname, portInt, resolve) &#125;&#125; â†“â†“â†“ newInstanceKeyfunc newInstanceKey(hostname string, port int, resolve bool) (instanceKey *InstanceKey, err error) &#123; if hostname == &quot;&quot; &#123; return instanceKey, fmt.Errorf(&quot;NewResolveInstanceKey: Empty hostname&quot;) &#125; instanceKey = &amp;InstanceKey&#123;Hostname: hostname, Port: port&#125; // æ„é€ ä¸€ä¸ªinstanceKey if resolve &#123; // ä¼ çš„æ˜¯true, æ‰€ä»¥èµ°è¿™é‡Œ instanceKey, err = instanceKey.ResolveHostname() &#125; return instanceKey, err&#125; â†“â†“â†“ instanceKey.ResolveHostnamefunc (this *InstanceKey) ResolveHostname() (*InstanceKey, error) &#123; if !this.IsValid() &#123; // è¿›è¡Œä¸€äº›æ ¡éªŒ, éœ€æ»¡è¶³: Hostname!=&quot;_&quot; Hostnameä¸ä»¥&quot;//&quot;å¼€å¤´, Hostnameé•¿åº¦&gt;0, port&gt;0 return this, nil &#125; hostname, err := ResolveHostname(this.Hostname) // è§£æä¸»æœºå, è§£æåé‡æ–°èµ‹å€¼ç»™instanceKey.Hostname if err == nil &#123; this.Hostname = hostname &#125; return this, err&#125; ####### ResolveHostnameè¿™ä¸ªå‡½æ•°ä»£ç è¾ƒå¤š, ä¸»è¦æ˜¯è¿™æ®µ 1234567891011121314151617resolvedHostname, err := resolveHostname(hostname) â†“â†“â†“ resolveHostnamefunc resolveHostname(hostname string) (string, error) &#123; switch strings.ToLower(config.Config.HostnameResolveMethod) &#123; case &quot;none&quot;: return hostname, nil case &quot;default&quot;: return hostname, nil case &quot;cname&quot;: return GetCNAME(hostname) case &quot;ip&quot;: return getHostnameIP(hostname) &#125; return hostname, nil&#125; è¿™é‡Œå°±æ˜¯æ ¹æ® HostnameResolveMethodå‚æ•°è¿›è¡Œè§£æäº† none, default: ä»€ä¹ˆä¹Ÿä¸å¤„ç†, ç›´æ¥åŸæ ·è¿”å› cname: å–CNAME ip: æ ¹æ®hostnameå–ip getHostnameIP å®é™…ä¼šè°ƒç”¨ net.LookupIP LookupIP looks up host using the local resolver. It returns a slice of that hostâ€™s IPv4 and IPv6 addresses. ç®€å•çœ‹ä¸€ä¸‹net.LookupIP 1234567891011121314151617 // /etc/host // 172.16.201.206 namenode-1 // 172.16.201.220 namenode-2 fmt.Println(net.LookupIP(&quot;namenode-1&quot;)) fmt.Println(net.LookupIP(&quot;namenode-8&quot;)) // ping 172.16.120.18 // PING 172.16.120.18 (172.16.120.18): 56 data bytes // Request timeout for icmp_seq 0 fmt.Println(net.LookupIP(&quot;172.16.120.18&quot;)) // ä¸å­˜åœ¨çš„ä¸€ä¸ªip, ä¹Ÿpingä¸é€š fmt.Println(net.LookupIP(&quot;192.168.124.130&quot;))output=&gt;[172.16.201.206] &lt;nil&gt;[] lookup namenode-8: no such host[172.16.120.18] &lt;nil&gt;[192.168.124.130] &lt;nil&gt; æ‰€ä»¥è¯´, getHostnameIP, ä½ ç»™ä»–ä¼ ip, è¿”å›çš„è¿˜æ˜¯ip. ç»™ä»–ä¼ ä¸»æœºå, å°±è¦çœ‹ä½ æœ‰æ²¡æœ‰é…ç½®è§£æäº† &lt;-NewResolveInstanceKeyStringsæ‰€ä»¥NewResolveInstanceKeyStringså°±æ˜¯æ ¹æ®HostnameResolveMethodå°†ä¼ è¿›æ¥çš„host è§£æäº†ä¸€ä¸‹. ä»¥HostnameResolveMethodé»˜è®¤å€¼defaultä¸ºä¾‹, å°±æ˜¯åŸæ ·è¿”å›. instanceKey.Hostnameå°±æ˜¯-i host:port ä¸­çš„host. è¿™ä¸ªhostå¯ä»¥æ˜¯ipä¹Ÿå¯ä»¥æ˜¯ä¸»æœºå 123456789101112131415161718192021222324252627func (this *HttpAPI) getInstanceKeyInternal(host string, port string, resolve bool) (inst.InstanceKey, error) &#123; var instanceKey *inst.InstanceKey var err error if resolve &#123; // getInstanceKeyä¼ çš„resolveæ˜¯true // æ‰€ä»¥èµ°è¿™é‡Œ instanceKey, err = inst.NewResolveInstanceKeyStrings(host, port) &#125; else &#123; instanceKey, err = inst.NewRawInstanceKeyStrings(host, port) &#125; if err != nil &#123; return emptyInstanceKey, err &#125; // ä»è¿™é‡Œç»§ç»­ // FigureInstanceKeyæ˜¯å°è¯•å»backend dbæ¨¡ç³ŠåŒ¹é… &#x27;%host%&#x27;, port, å¦‚æœå–åˆ°äº†, å°±ä»backend dbæŠŠè¿™ä¸ªinstanceKeyå–å‡ºæ¥(è¿˜åŒ…å«ServerID, ServerUUID, Binlogç­‰ä¿¡æ¯) // å¦‚æœinstanceKey.Hostnameæ˜¯ ip, å°±ä¸æ¨¡ç³ŠåŒ¹é…äº†, ç›´æ¥åŸæ ·è¿”å› // å¦‚æœæ¨¡ç³ŠåŒ¹é…åˆ°å¤šè¡Œ, ä¹Ÿæ˜¯åŸå› è¿”å›, åªæœ‰æ¨¡ç³ŠåŒ¹é…åˆ°1è¡Œæ‰ä»æ•°æ®åº“å–instanceKeyä¿¡æ¯è¿”å› instanceKey instanceKey, err = inst.FigureInstanceKey(instanceKey, nil) if err != nil &#123; return emptyInstanceKey, err &#125; if instanceKey == nil &#123; return emptyInstanceKey, fmt.Errorf(&quot;Unexpected nil instanceKey in getInstanceKeyInternal(%+v, %+v, %+v)&quot;, host, port, resolve) &#125; return *instanceKey, nil&#125; &lt;-getInstanceKeyç»§ç»­å¾€ä¸‹è¯»Discover 123456789101112131415161718192021222324252627// Discover issues a synchronous read on an instancefunc (this *HttpAPI) Discover(params martini.Params, r render.Render, req *http.Request, user auth.User) &#123; if !isAuthorizedForAction(req, user) &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: &quot;Unauthorized&quot;&#125;) return &#125; instanceKey, err := this.getInstanceKey(params[&quot;host&quot;], params[&quot;port&quot;]) // ä»è¿™ç»§ç»­, ä¸Šé¢ç®€å•æ¥è¯´å°±æ˜¯è§£æäº†ä¸‹ host if err != nil &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: err.Error()&#125;) return &#125; instance, err := inst.ReadTopologyInstance(&amp;instanceKey) if err != nil &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: err.Error()&#125;) return &#125; if orcraft.IsRaftEnabled() &#123; orcraft.PublishCommand(&quot;discover&quot;, instanceKey) &#125; else &#123; logic.DiscoverInstance(instanceKey) &#125; Respond(r, &amp;APIResponse&#123;Code: OK, Message: fmt.Sprintf(&quot;Instance discovered: %+v&quot;, instance.Key), Details: instance&#125;)&#125; -&gt;ReadTopologyInstanceè¿™æ˜¯é‡ç‚¹, å¼€å§‹â€å‘ç°â€ æ‹“æ‰‘ç»“æ„ 123456789101112instance, err := inst.ReadTopologyInstance(&amp;instanceKey) â†“â†“â†“ inst.ReadTopologyInstance// ReadTopologyInstance collects information on the state of a MySQL// server and writes the result synchronously to the orchestrator// backend.func ReadTopologyInstance(instanceKey *InstanceKey) (*Instance, error) &#123; return ReadTopologyInstanceBufferable(instanceKey, false, nil) // è¿™é‡ŒbufferWrites=false&#125;â†“â†“â†“ ReadTopologyInstanceBufferable -&gt; ReadTopologyInstanceBufferableå°±æ˜¯è¯»æ‹“æ‰‘èŠ‚ç‚¹, è¯»å‡ºè¿™ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯, å’Œä»–æœ‰å“ªäº›ä»åº“ä»¥åŠä»–çš„ä¸»åº“. ç„¶åå°†ä¸€äº›ä¿¡æ¯å†™å…¥backend db, è¿˜ä¼šç¼“å­˜ä¸€äº›ä¿¡æ¯åˆ°â€bufferâ€, ä¸‹æ¬¡è¯»å¯ä»¥ç›´æ¥ä»â€bufferâ€è¯» è¿™ä¸ªå‡½æ•°å¾ˆé•¿, è¿™é‡Œåªæ‘˜éƒ¨åˆ†ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211// ReadTopologyInstanceBufferable connects to a topology MySQL instance// and collects information on the server and its replication state.// It writes the information retrieved into orchestrator&#x27;s backend.// - writes are optionally buffered.// - timing information can be collected for the stages performed.func ReadTopologyInstanceBufferable(instanceKey *InstanceKey, bufferWrites bool, latency *stopwatch.NamedStopwatch) (inst *Instance, err error) &#123; // bufferWritesä¼ è¿›æ¥çš„æ˜¯false // time.AfterFuncå‡½æ•°ä½œç”¨ // AfterFunc waits for the duration to elapse and then calls f // in its own goroutine. It returns a Timer that can // be used to cancel the call using its Stop method. // æ‰€ä»¥è¿™é‡Œå°±æ˜¯1ç§’åè°ƒç”¨UpdateInstanceLastAttemptedCheck, è¿™ä¸ªå‡½æ•°æ›´æ–°æŒ‡å®šinstanceKey database_instanceè¡¨ä¸­çš„last_attempted_checkå­—æ®µä¸ºå½“å‰æ—¶é—´ lastAttemptedCheckTimer := time.AfterFunc(time.Second, func() &#123; go UpdateInstanceLastAttemptedCheck(instanceKey) &#125;)... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  db, err := db.OpenDiscovery(instanceKey.Hostname, instanceKey.Port) // è¿åˆ°æŒ‡å®šçš„å®ä¾‹ if err != nil &#123; goto Cleanup // æ³¨æ„è¿™é‡Œå¾ˆé‡è¦, å¦‚æœè¿æ¥æ•°æ®åº“æŠ¥é”™, ä¼šèµ°goto &#125; instance.Key = *instanceKey... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  var mysqlHostname, mysqlReportHost string err = db.QueryRow(&quot;select @@global.hostname, ifnull(@@global.report_host, &#x27;&#x27;), @@global.server_id, @@global.version, @@global.version_comment, @@global.read_only, @@global.binlog_format, @@global.log_bin, @@global.log_slave_updates&quot;).Scan( &amp;mysqlHostname, &amp;mysqlReportHost, &amp;instance.ServerID, &amp;instance.Version, &amp;instance.VersionComment, &amp;instance.ReadOnly, &amp;instance.Binlog_format, &amp;instance.LogBinEnabled, &amp;instance.LogReplicationUpdatesEnabled) if err != nil &#123; goto Cleanup &#125; partialSuccess = true // We at least managed to read something from the server. // ä¸Šé¢é€šè¿‡ select @@global.hostname å–åˆ°äº†ä¸»æœºå // æ ¹æ®MySQLHostnameResolveMethod æ¥å–resolvedHostname switch strings.ToLower(config.Config.MySQLHostnameResolveMethod) &#123; case &quot;none&quot;: resolvedHostname = instance.Key.Hostname case &quot;default&quot;, &quot;hostname&quot;, &quot;@@hostname&quot;: // MySQLHostnameResolveMethod é»˜è®¤å€¼ å°±æ˜¯ @@hostname. ä»¥æ­¤ä¸ºä¾‹ resolvedHostnameå°±æ˜¯select @@global.hostnameå–åˆ°çš„ä¸»æœºå resolvedHostname = mysqlHostname case &quot;report_host&quot;, &quot;@@report_host&quot;: if mysqlReportHost == &quot;&quot; &#123; err = fmt.Errorf(&quot;MySQLHostnameResolveMethod configured to use @@report_host but %+v has NULL/empty @@report_host&quot;, instanceKey) goto Cleanup &#125; resolvedHostname = mysqlReportHost default: resolvedHostname = instance.Key.Hostname &#125;... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  // ä»¥æˆ‘ä»¬çš„ä¾‹å­ resolvedHostnameæ˜¯ä¸»æœºå: centos-1 // instance.Key.Hostname æ˜¯ 172.16.120.10 if resolvedHostname != instance.Key.Hostname &#123; latency.Start(&quot;backend&quot;) UpdateResolvedHostname(instance.Key.Hostname, resolvedHostname) // UpdateResolvedHostname å°† hostname, resolved_hostname è®°å½•åˆ°backend db // _, err := db.ExecOrchestrator(` // insert into // hostname_resolve (hostname, resolved_hostname, resolved_timestamp) // values // (?, ?, NOW()) // on duplicate key update // resolved_hostname = VALUES(resolved_hostname), // resolved_timestamp = VALUES(resolved_timestamp) // `, // hostname, // resolvedHostname) latency.Stop(&quot;backend&quot;) instance.Key.Hostname = resolvedHostname // å¹¶å°†instance.Key.Hostname ä»172.16.120.10 æ”¹æˆäº† centos-1 &#125; if instance.Key.Hostname == &quot;&quot; &#123; err = fmt.Errorf(&quot;ReadTopologyInstance: empty hostname (%+v). Bailing out&quot;, *instanceKey) goto Cleanup &#125; go ResolveHostnameIPs(instance.Key.Hostname) // è¿™é‡Œæœ‰å°è¯•å–ip, è¿™é‡Œä»¥æˆ‘ä»¬çš„ä¾‹å­instance.Key.Hostnameå·²ç»æ˜¯centos-1äº†. å¦‚æœorchestratoræ‰€åœ¨æœåŠ¡å™¨æ²¡é…ç½®ä¸»æœºåè§£æ(å¦‚/etc/hosts), é‚£ä¹ˆæ˜¯å–ä¸åˆ°çš„ // å¦‚æœèƒ½å–åˆ°, ä¼šå¾€ insert into hostname_ips (hostname, ipv4, ipv6, last_updated) ... ODKU ...... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç // ä¸‹é¢è¿™æ®µå°±æ˜¯å–äº† 172.16.120.10:3306 çš„masterä¸»åº“// æ³¨æ„è¿™é‡Œé€šè¿‡show slave status æŸ¥ä¸»åº“. show slave statuså¤šæºå¤åˆ¶æ˜¯å¯èƒ½è¿”å›å¤šè¡Œçš„. orchestratorå®˜æ–¹æ–‡æ¡£è¯´äº†, ä¸æ”¯æŒå¤šæºå¤åˆ¶, æ‰€ä»¥è¿™é‡Œinstance.MasterKeyåªæ˜¯ä¸€ä¸ªç»“æ„ä½“, ä¸æ˜¯åˆ‡ç‰‡ err = sqlutils.QueryRowsMap(db, &quot;show slave status&quot;, func(m sqlutils.RowMap) error &#123; ... masterHostname := m.GetString(&quot;Master_Host&quot;) if isMaxScale110 &#123; // Buggy buggy maxscale 1.1.0. Reported Master_Host can be corrupted. // Therefore we (currently) take @@hostname (which is masquarading as master host anyhow) masterHostname = maxScaleMasterHostname &#125; masterKey, err := NewResolveInstanceKey(masterHostname, m.GetInt(&quot;Master_Port&quot;)) if err != nil &#123; logReadTopologyInstanceError(instanceKey, &quot;NewResolveInstanceKey&quot;, err) &#125; masterKey.Hostname, resolveErr = ResolveHostname(masterKey.Hostname) if resolveErr != nil &#123; logReadTopologyInstanceError(instanceKey, fmt.Sprintf(&quot;ResolveHostname(%q)&quot;, masterKey.Hostname), resolveErr) &#125; instance.MasterKey = *masterKey... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  instanceFound = true // ------------------------------------------------------------------------- // Anything after this point does not affect the fact the instance is found. // No `goto Cleanup` after this point. // ------------------------------------------------------------------------- // Get replicas, either by SHOW SLAVE HOSTS or via PROCESSLIST // MaxScale does not support PROCESSLIST, so SHOW SLAVE HOSTS is the only option // ä¸‹é¢è¿™ä¸€å¤§æ®µä»£ç , å°±æ˜¯å– 172.16.120.10:3306çš„ä»åº“, å¦‚æœæœ‰ä»åº“, å°±æ”¾åˆ° instance.Replicasé‡Œ // Get replicas, either by SHOW SLAVE HOSTS or via PROCESSLIST // MaxScale does not support PROCESSLIST, so SHOW SLAVE HOSTS is the only option if config.Config.DiscoverByShowSlaveHosts || isMaxScale &#123; err := sqlutils.QueryRowsMap(db, `show slave hosts`, func(m sqlutils.RowMap) error &#123; // MaxScale 1.1 may trigger an error with this command, but // also we may see issues if anything on the MySQL server locks up. // Consequently it&#x27;s important to validate the values received look // good prior to calling ResolveHostname() host := m.GetString(&quot;Host&quot;) port := m.GetIntD(&quot;Port&quot;, 0) if host == &quot;&quot; || port == 0 &#123; if isMaxScale &amp;&amp; host == &quot;&quot; &amp;&amp; port == 0 &#123; // MaxScale reports a bad response sometimes so ignore it. // - seen in 1.1.0 and 1.4.3.4 return nil &#125; // otherwise report the error to the caller return fmt.Errorf(&quot;ReadTopologyInstance(%+v) &#x27;show slave hosts&#x27; returned row with &lt;host,port&gt;: &lt;%v,%v&gt;&quot;, instanceKey, host, port) &#125; replicaKey, err := NewResolveInstanceKey(host, port) if err == nil &amp;&amp; replicaKey.IsValid() &#123; if !FiltersMatchInstanceKey(replicaKey, config.Config.DiscoveryIgnoreReplicaHostnameFilters) &#123; instance.AddReplicaKey(replicaKey) &#125; foundByShowSlaveHosts = true &#125; return err &#125;) logReadTopologyInstanceError(instanceKey, &quot;show slave hosts&quot;, err) &#125; if !foundByShowSlaveHosts &amp;&amp; !isMaxScale &#123; // Either not configured to read SHOW SLAVE HOSTS or nothing was there. // Discover by information_schema.processlist waitGroup.Add(1) go func() &#123; defer waitGroup.Done() err := sqlutils.QueryRowsMap(db, ` select substring_index(host, &#x27;:&#x27;, 1) as slave_hostname from information_schema.processlist where command IN (&#x27;Binlog Dump&#x27;, &#x27;Binlog Dump GTID&#x27;) `, func(m sqlutils.RowMap) error &#123; cname, resolveErr := ResolveHostname(m.GetString(&quot;slave_hostname&quot;)) if resolveErr != nil &#123; logReadTopologyInstanceError(instanceKey, &quot;ResolveHostname: processlist&quot;, resolveErr) &#125; replicaKey := InstanceKey&#123;Hostname: cname, Port: instance.Key.Port&#125; if !FiltersMatchInstanceKey(&amp;replicaKey, config.Config.DiscoveryIgnoreReplicaHostnameFilters) &#123; instance.AddReplicaKey(&amp;replicaKey) &#125; return err &#125;) logReadTopologyInstanceError(instanceKey, &quot;processlist&quot;, err) &#125;() &#125;... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  Cleanup: // æ³¨æ„Cleanupçš„ä½ç½® æ˜¯åœ¨ è®¾ç½® instanceFound = true ä¹‹å, æ‰€ä»¥ä¸€ä½† db, err := db.OpenDiscovery(instanceKey.Hostname, instanceKey.Port)æŠ¥é”™, å°±è·³è½¬åˆ°è¿™é‡Œ, äºæ˜¯instanceFoundè¿˜æ˜¯false xxxx ... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  if instanceFound &#123; instance.LastDiscoveryLatency = time.Since(readingStartTime) instance.IsLastCheckValid = true instance.IsRecentlyChecked = true instance.IsUpToDate = true latency.Start(&quot;backend&quot;) if bufferWrites &#123; // bufferWritesä¼ è¿›æ¥çš„æ˜¯false enqueueInstanceWrite(instance, instanceFound, err) &#125; else &#123; WriteInstance(instance, instanceFound, err) // è¿™é‡Œæœ€ç»ˆæ˜¯æŠŠè·å–çš„instanceå„ç§ä¿¡æ¯å†™å…¥ database_instanceè¡¨, ä»¥åŠå¾ˆé‡è¦çš„, æ›´æ–° last_check=Now() last_seen=Now() last_attempted_check=Now() last_check_parital_success=1 &#125; lastAttemptedCheckTimer.Stop() latency.Stop(&quot;backend&quot;) return instance, nil &#125; // Something is wrong, could be network-wise. Record that we // tried to check the instance. last_attempted_check is also // updated on success by writeInstance. latency.Start(&quot;backend&quot;) _ = UpdateInstanceLastChecked(&amp;instance.Key, partialSuccess) // è¿æ¥æ•°æ®åº“å¤±è´¥, æˆ–æ‰§è¡Œä¸€äº›æŸ¥è¯¢å¦‚show slave statuså¤±è´¥, ä¼šGotoåˆ°Cleanup, æ­¤æ—¶instanceFoundä»ç„¶æ˜¯false // äºæ˜¯å°±ä¼šæ‰§è¡ŒUpdateInstanceLastChecked. è¿™å‡½æ•°æ˜¯æ›´æ–°æŒ‡å®šinstance.Keyçš„ last_checked = NOW(), last_check_partial_success = 0/1(å¦‚è¿‡åœ¨err = db.QueryRow(&quot;select @@global.hostname...æ‰§è¡Œå‰Goto Cleanup, åˆ™partialSuccess=False , last_check_partial_success=0, å¦åˆ™partialSuccessæ˜¯True, last_check_partial_success=1) // last_check_partial_success è¡¨ç¤º, è‡³å°‘æˆ‘ä»¬è¿æ¥åˆ°æ•°æ®åº“, è€Œä¸”èƒ½æ‰§è¡Œselect @@global.hostname... æŸ¥è¯¢ // ç”±æ­¤å¯ä»¥çœ‹å‡º latency.Stop(&quot;backend&quot;) return nil, err &lt;- ReadTopologyInstanceç»§ç»­å¾€ä¸‹è¯»Discover 1234567891011121314151617181920212223242526272829// Discover issues a synchronous read on an instancefunc (this *HttpAPI) Discover(params martini.Params, r render.Render, req *http.Request, user auth.User) &#123; if !isAuthorizedForAction(req, user) &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: &quot;Unauthorized&quot;&#125;) return &#125; instanceKey, err := this.getInstanceKey(params[&quot;host&quot;], params[&quot;port&quot;]) if err != nil &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: err.Error()&#125;) return &#125; instance, err := inst.ReadTopologyInstance(&amp;instanceKey) // ä»è¿™ç»§ç»­, ä¸Šé¢ç®€å•æ¥è¯´å°±æ˜¯è§£æäº†ä¸‹ host if err != nil &#123; Respond(r, &amp;APIResponse&#123;Code: ERROR, Message: err.Error()&#125;) return &#125; if orcraft.IsRaftEnabled() &#123; // å¦‚æœorchæ˜¯raftæ¨¡å¼éƒ¨ç½² // è¿™æ®µä»£ç æˆ‘æ²¡çœ‹, æˆ‘çŒœæµ‹æ˜¯è®©å…¶ä»–èŠ‚ç‚¹ä¹Ÿå»discoverä¸€é orcraft.PublishCommand(&quot;discover&quot;, instanceKey) &#125; else &#123; // ç»§ç»­é¡ºè—¤æ‘¸ç“œ, &quot;å‘ç°&quot; logic.DiscoverInstance(instanceKey) &#125; Respond(r, &amp;APIResponse&#123;Code: OK, Message: fmt.Sprintf(&quot;Instance discovered: %+v&quot;, instance.Key), Details: instance&#125;)&#125; æ ‘è—¤æ‘¸ç“œDiscoverInstanceä»ä¸Šé¢å¯ä»¥çœ‹åˆ°, åªå‘ç°äº† 172.16.120.10:3306 è‡ªèº«, ä¹Ÿå‘ç°äº†ä»–çš„ä»åº“å’Œä¸»åº“, ä½†åªæ˜¯æŠŠä»–çš„ä»åº“ip,portå­˜å…¥äº†instance.Replicas, ä¸»åº“å­˜å…¥äº†instance.MasterKey, æ²¡æœ‰å†è¿›ä¸€æ­¥æ¢æµ‹è¿™äº›ä»åº“å’Œä¸»åº“. å…¶å®ç»§ç»­çš„â€å‘ç°â€å·¥ä½œæ˜¯åœ¨DiscoverInstance ä¸­åšçš„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// DiscoverInstance will attempt to discover (poll) an instance (unless// it is already up to date) and will also ensure that its master and// replicas (if any) are also checked.func DiscoverInstance(instanceKey inst.InstanceKey) &#123;... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  // Calculate the expiry period each time as InstancePollSeconds // _may_ change during the run of the process (via SIGHUP) and // it is not possible to change the cache&#x27;s default expiry.. // è¿™ä¸ªifå¾ˆé‡è¦, è¿™é‡Œå°è¯•å‘recentDiscoveryOperationKeysè¿™ä¸ªcacheé‡Œadd key, keyå°±æ˜¯instanceKey.DisplayString() // addå‰ä¼šå…ˆæŸ¥è¿™ä¸ªcacheé‡Œæœ‰æ²¡æœ‰è¿™ä¸ªkey, å¦‚æœæœ‰, ä¼šè¿”å›err // å¦‚æœæ²¡æŸ¥åˆ°è¿™ä¸ªkey, å°±ä¼šæ·»åŠ åˆ°cache, å¹¶ä¸”è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºConfig.InstancePollSecondsé»˜è®¤5ç§’, æ‰€ä»¥ä»è¿™é‡Œæ§åˆ¶æ¯ä¸ªinstanceçš„å‘ç°é—´éš”ä¸º5ç§’ if existsInCacheError := recentDiscoveryOperationKeys.Add(instanceKey.DisplayString(), true, instancePollSecondsDuration()); existsInCacheError != nil &#123; // Just recently attempted return &#125;... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  // ä»åº“é‡Œå†æŠŠ`172.16.120.10:3306` ä¿¡æ¯å–å‡ºæ¥ instance, found, err := inst.ReadInstance(&amp;instanceKey)... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  // First we&#x27;ve ever heard of this instance. Continue investigation: instance, err = inst.ReadTopologyInstanceBufferable(&amp;instanceKey, config.Config.BufferInstanceWrites, latency)... çœç•¥éƒ¨åˆ†ä¸é‡è¦ä»£ç  // Investigate replicas and members of the same replication group: // æŠŠä»åº“å–å‡ºæ¥äº† for _, replicaKey := range append(instance.ReplicationGroupMembers.GetInstanceKeys(), instance.Replicas.GetInstanceKeys()...) &#123; replicaKey := replicaKey // not needed? no concurrency here? // Avoid noticing some hosts we would otherwise discover if inst.FiltersMatchInstanceKey(&amp;replicaKey, config.Config.DiscoveryIgnoreReplicaHostnameFilters) &#123; continue &#125; if replicaKey.IsValid() &#123; // æ”¾åˆ°ä¸€ä¸ªdiscoveryQueueå‘ç°é˜Ÿåˆ—é‡Œäº† discoveryQueue.Push(replicaKey) // Pushæ—¶, ä¼šè®°å½•è¿™ä¸ªkeyæ˜¯ä»€ä¹ˆæ—¶é—´pushè¿›å»çš„ &#125; &#125; // Investigate master: // æŠŠä¸»åº“ä¹Ÿå–å‡ºæ¥äº† if instance.MasterKey.IsValid() &#123; if !inst.FiltersMatchInstanceKey(&amp;instance.MasterKey, config.Config.DiscoveryIgnoreMasterHostnameFilters) &#123; // ä¸»åº“ä¹Ÿæ”¾åˆ°ä¸€ä¸ªdiscoveryQueueå‘ç°é˜Ÿåˆ—é‡Œäº† discoveryQueue.Push(instance.MasterKey) &#125; &#125; discoveryQueueå…¨å±€æœdiscoveryQueue, è‚¯å®šæœ‰äººæ¶ˆè´¹è¿™ä¸ªé˜Ÿåˆ— æœç„¶æœåˆ° instanceKey := discoveryQueue.Consume() 12345678910111213141516171819202122232425// handleDiscoveryRequests iterates the discoveryQueue channel and calls upon// instance discovery per entry.func handleDiscoveryRequests() &#123; discoveryQueue = discovery.CreateOrReturnQueue(&quot;DEFAULT&quot;) // create a pool of discovery workers for i := uint(0); i &lt; config.Config.DiscoveryMaxConcurrency; i++ &#123; go func() &#123; for &#123; instanceKey := discoveryQueue.Consume() // Possibly this used to be the elected node, but has // been demoted, while still the queue is full. if !IsLeaderOrActive() &#123; log.Debugf(&quot;Node apparently demoted. Skipping discovery of %+v. &quot;+ &quot;Remaining queue size: %+v&quot;, instanceKey, discoveryQueue.QueueLen()) discoveryQueue.Release(instanceKey) continue &#125; // çœ‹è¿™é‡Œ, ç»§ç»­é€šè¿‡DiscoverInstanceå‘ç° DiscoverInstance(instanceKey) discoveryQueue.Release(instanceKey) &#125; &#125;() &#125;&#125;","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Orchestrator","slug":"Orchestrator","permalink":"http://fuxkdb.com/tags/Orchestrator/"}]},{"title":"MySQL page cleanerå ç”¨CPUè¾ƒé«˜é—®é¢˜","slug":"2021-10-15-MySQL page cleanerå ç”¨CPUè¾ƒé«˜é—®é¢˜","date":"2021-10-15T04:23:00.000Z","updated":"2021-10-17T13:01:36.109Z","comments":true,"path":"2021/10/15/2021-10-15-MySQL page cleanerå ç”¨CPUè¾ƒé«˜é—®é¢˜/","link":"","permalink":"http://fuxkdb.com/2021/10/15/2021-10-15-MySQL%20page%20cleaner%E5%8D%A0%E7%94%A8CPU%E8%BE%83%E9%AB%98%E9%97%AE%E9%A2%98/","excerpt":"èƒŒæ™¯è¯´æ˜ä¼—æ‰€å‘¨çŸ¥, Seconds_Behind_Master æ— æ³•å‡†ç¡®ååº”å¤åˆ¶å»¶è¿Ÿ. ä¸ºäº†å‡†ç¡®çš„ååº”å¤åˆ¶å»¶è¿Ÿ, ä¸šç•Œçš„åŠæ³•æ˜¯, åˆ›å»ºä¸€ä¸ªå»¶è¿Ÿç›‘æ§è¡¨, å‘¨æœŸæ€§(å¾€å¾€æ˜¯æ¯ç§’)æ›´æ–°è¿™ä¸ªè¡¨çš„æ—¶é—´æˆ³å­—æ®µ, è®¡ç®—å½“å‰æ—¶é—´ä¸è¯¥å­—æ®µå·®å€¼, ä»¥æ­¤åˆ¤æ–­å¤åˆ¶å»¶è¿Ÿ. å…¸å‹çš„ä¾‹å­æ˜¯Perconaçš„pt-heartbeat. å¦å¤–TIDB DMä¹Ÿä½¿ç”¨äº†ç›¸åŒçš„æ–¹æ³•ç›‘æ§åŒæ­¥å»¶è¿Ÿ. åœ¨æˆ‘ä»¬è¿™é‡Œ, ä½¿ç”¨äº†ä¸»ä»å’ŒMGRä¸¤ç§æ¶æ„é›†ç¾¤, ä¸ºäº†æ›´å¥½åœ°ç›‘æ§å»¶è¿Ÿ, DBAå¼€å‘äº†ä¸€ä¸ªpythonè„šæœ¬, è„šæœ¬ä»CMDBè·å–æ‰€æœ‰é›†ç¾¤ProxySQLèŠ‚ç‚¹, è¿æ¥ProxySQL, æ¯ç§’æ›´æ–°dbms_monitor.monitor_delayè¡¨. è¡¨ç»“æ„å’Œæ‰§è¡Œçš„è¯­å¥ä¸º: 1234567891011121314root@localhost 13:23:42 [dbms_monitor]&gt; show create table monitor_delay\\G*************************** 1. row *************************** Table: monitor_delayCreate Table: CREATE TABLE `monitor_delay` ( `id` tinyint(3) unsigned NOT NULL, `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci1 row in set (0.00 sec) æ›´æ–°æ—¶é—´æˆ³è¯­å¥REPLACE INTO dbms_monitor.monitor_delay(id) VALUES(1) ä¸ºäº†ä¿è¯â€æ¯ç§’â€æ›´æ–°, è„šæœ¬åšäº†è¶…æ—¶å¤„ç†, å¦‚æœæŸä¸ªé›†ç¾¤æ‰§è¡Œè¯­å¥(è¿æ¥è¶…æ—¶/æ‰§è¡Œè¯­å¥è¶…æ—¶ç­‰)è¶…æ—¶, åˆ™æŠ›å‡ºå¼‚å¸¸, sleep ä¸€æ®µæ—¶é—´(è¿™ä¸ªä¸€æ®µæ—¶é—´+ æœ¬æ¬¡å¾ªç¯å·²ç”¨æ—¶é—´=1s), è¿›å…¥ä¸‹æ¬¡å¾ªç¯","text":"èƒŒæ™¯è¯´æ˜ä¼—æ‰€å‘¨çŸ¥, Seconds_Behind_Master æ— æ³•å‡†ç¡®ååº”å¤åˆ¶å»¶è¿Ÿ. ä¸ºäº†å‡†ç¡®çš„ååº”å¤åˆ¶å»¶è¿Ÿ, ä¸šç•Œçš„åŠæ³•æ˜¯, åˆ›å»ºä¸€ä¸ªå»¶è¿Ÿç›‘æ§è¡¨, å‘¨æœŸæ€§(å¾€å¾€æ˜¯æ¯ç§’)æ›´æ–°è¿™ä¸ªè¡¨çš„æ—¶é—´æˆ³å­—æ®µ, è®¡ç®—å½“å‰æ—¶é—´ä¸è¯¥å­—æ®µå·®å€¼, ä»¥æ­¤åˆ¤æ–­å¤åˆ¶å»¶è¿Ÿ. å…¸å‹çš„ä¾‹å­æ˜¯Perconaçš„pt-heartbeat. å¦å¤–TIDB DMä¹Ÿä½¿ç”¨äº†ç›¸åŒçš„æ–¹æ³•ç›‘æ§åŒæ­¥å»¶è¿Ÿ. åœ¨æˆ‘ä»¬è¿™é‡Œ, ä½¿ç”¨äº†ä¸»ä»å’ŒMGRä¸¤ç§æ¶æ„é›†ç¾¤, ä¸ºäº†æ›´å¥½åœ°ç›‘æ§å»¶è¿Ÿ, DBAå¼€å‘äº†ä¸€ä¸ªpythonè„šæœ¬, è„šæœ¬ä»CMDBè·å–æ‰€æœ‰é›†ç¾¤ProxySQLèŠ‚ç‚¹, è¿æ¥ProxySQL, æ¯ç§’æ›´æ–°dbms_monitor.monitor_delayè¡¨. è¡¨ç»“æ„å’Œæ‰§è¡Œçš„è¯­å¥ä¸º: 1234567891011121314root@localhost 13:23:42 [dbms_monitor]&gt; show create table monitor_delay\\G*************************** 1. row *************************** Table: monitor_delayCreate Table: CREATE TABLE `monitor_delay` ( `id` tinyint(3) unsigned NOT NULL, `ctime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci1 row in set (0.00 sec) æ›´æ–°æ—¶é—´æˆ³è¯­å¥REPLACE INTO dbms_monitor.monitor_delay(id) VALUES(1) ä¸ºäº†ä¿è¯â€æ¯ç§’â€æ›´æ–°, è„šæœ¬åšäº†è¶…æ—¶å¤„ç†, å¦‚æœæŸä¸ªé›†ç¾¤æ‰§è¡Œè¯­å¥(è¿æ¥è¶…æ—¶/æ‰§è¡Œè¯­å¥è¶…æ—¶ç­‰)è¶…æ—¶, åˆ™æŠ›å‡ºå¼‚å¸¸, sleep ä¸€æ®µæ—¶é—´(è¿™ä¸ªä¸€æ®µæ—¶é—´+ æœ¬æ¬¡å¾ªç¯å·²ç”¨æ—¶é—´=1s), è¿›å…¥ä¸‹æ¬¡å¾ªç¯ é—®é¢˜äº§ç”Ÿ2021.10.14 15:45å·¦å³, DBAåœ¨rcç¯å¢ƒè¿›è¡Œæ¼”ç»ƒ, éƒ¨åˆ†é›†ç¾¤å®•æœº ä»è„šæœ¬æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹å‡º, éƒ¨åˆ†rcé›†ç¾¤å¼‚å¸¸ éšåæ•°æ®åº“cpuè¶‹åŠ¿ç›‘æ§æŠ¥è­¦ æŸ¥çœ‹ç›‘æ§, å‘ç°å¾ˆå¤š8æ ¸å¿ƒæœåŠ¡å™¨cpuä½¿ç”¨ç‡æœ‰æ˜æ˜¾ä¸Šå‡ è¿™éƒ¨åˆ†æœåŠ¡å™¨ä¼šé‡‡ç”¨å¤šå®ä¾‹éƒ¨ç½²æ–¹å¼, éƒ¨ç½²éæ ¸å¿ƒä¸šåŠ¡é›†ç¾¤, å¾€å¾€æ¯”è¾ƒç©ºé—² DBAåœ¨ç»è¿‡ä¸€ç³»åˆ—åˆ†æå®šä½åæ’æŸ¥å, å‘ç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡: å…³é—­å»¶è¿Ÿç›‘æ§è„šæœ¬CPUä½¿ç”¨ç‡ä¸Šå‡ å¼€å¯å»¶è¿Ÿç›‘æ§è„šæœ¬CPUä½¿ç”¨ç‡ä¸‹é™ é—®é¢˜åŸå› å®šä½å ç”¨CPUçœŸå‡¶ä¸Šé¢çš„ç°è±¡å¥‡æ€ªå°±å¥‡æ€ªåœ¨ä¸æˆ‘ä»¬çš„é€šå¸¸è®¤çŸ¥ç›¸å; å¦‚æœæ˜¯å¼€å¯è„šæœ¬CPUä½¿ç”¨ç‡ä¸Šå‡, å…³é—­è„šæœ¬CPUä½¿ç”¨ç‡ä¸‹é™è¿˜å¯ä»¥ç†è§£, è¿™ç§æƒ…å†µ8æˆæ˜¯è„šæœ¬é—®é¢˜, ä½†å®æ—¶æƒ…å†µæ˜¯å®Œå…¨ç›¸åçš„ æˆ‘ä»¬ç™»å½•ä¸€ä¸ªé—®é¢˜æœåŠ¡å™¨, é€‰æ‹©ä¸€ä¸ªmysqlå®ä¾‹, ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰¾åˆ°å ç”¨CPUé«˜çš„mysqlçº¿ç¨‹id 123456789101112pidstat -t -p 16904 1 01:39:22 PM UID TGID TID %usr %system %guest %CPU CPU Command01:39:23 PM 3001 16904 - 100.00 0.00 0.00 100.00 6 mysqld01:39:23 PM 3001 - 16904 0.00 0.00 0.00 0.00 6 |__mysqld...01:39:23 PM 3001 - 17986 0.00 0.00 0.00 0.00 6 |__mysqld01:39:23 PM 3001 - 17987 100.00 0.00 0.00 100.00 5 |__mysqld01:39:23 PM 3001 - 17988 0.00 0.00 0.00 0.00 6 |__mysqld01:39:23 PM 3001 - 18016 0.00 0.00 0.00 0.00 0 |__mysqld... å¦‚ä¸Šæ‰€ç¤º, TID:17987 å ç”¨CPUé«˜, æˆ‘ä»¬ç™»å½•æ•°æ®åº“æŸ¥çœ‹è¿™ä¸ªçº¿ç¨‹åœ¨å¹²ä»€ä¹ˆ 1234567891011121314151617181920fan@127.0.0.1 13:41:03 [(none)]&gt; select * from performance_schema.threads where THREAD_OS_ID = 17987 \\G*************************** 1. row *************************** THREAD_ID: 19 NAME: thread/innodb/page_cleaner_thread TYPE: BACKGROUND PROCESSLIST_ID: NULL PROCESSLIST_USER: NULL PROCESSLIST_HOST: NULL PROCESSLIST_DB: NULLPROCESSLIST_COMMAND: NULL PROCESSLIST_TIME: NULL PROCESSLIST_STATE: NULL PROCESSLIST_INFO: NULL PARENT_THREAD_ID: NULL ROLE: NULL INSTRUMENTED: YES HISTORY: YES CONNECTION_TYPE: NULL THREAD_OS_ID: 179871 row in set (0.00 sec) å¦‚ä¸Šæ‰€ç¤º, è¿™ä¸ªçº¿ç¨‹æ˜¯innodbåå°çº¿ç¨‹page_cleaner_thread; page_cleaner_threadæ˜¯ç”¨æ¥åˆ·è„é¡µçš„ çœ‹åˆ°è¿™é‡Œ, å¾ˆè‡ªç„¶çš„ä¼šè®¤ä¸ºæ˜¯å†™æ“ä½œè¿‡å¤š, å¯¼è‡´é¢‘ç¹åˆ·è„, ä½†äº‹å®æ˜¯, è¿™äº›å®ä¾‹åŸºæœ¬æ²¡æœ‰å†™å…¥æ“ä½œ(é€šè¿‡åˆ†æbinlog). é€šè¿‡google æœç´¢ â€œpage_cleaner High cpu usageâ€, æ‰¾åˆ°ä¸€ç¯‡é˜¿é‡Œå†…æ ¸æœˆæŠ¥ MySQL Â· å¼•æ“ç‰¹æ€§ Â· page cleaner ç®—æ³• è¿™ç¯‡æ–‡ç« å¤§è‡´è¯´çš„æ˜¯, page cleanerçš„åˆ·è„é€»è¾‘, é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤º pc_sleep_if_neededpage cleaner çš„å¾ªç¯åˆ·è„å‘¨æœŸæ˜¯ 1sï¼Œå¦‚æœä¸è¶³ 1s å°±éœ€è¦ sleepï¼Œè¶…è¿‡ 1s å¯èƒ½æ˜¯åˆ·è„å¤ªæ…¢ï¼Œä¸è¶³ 1s å¯èƒ½æ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’çš„ã€‚ æ˜¯å¦æŒç»­ç¼“æ…¢åˆ·è„é”™è¯¯æ—¥å¿—é‡Œæœ‰æ—¶å€™ä¼šçœ‹åˆ°è¿™æ ·çš„æ—¥å¿—ï¼š Page cleaner took xx ms to flush xx and evict xx pages è¿™ä¸ªè¡¨ç¤ºä¸Šä¸€è½®åˆ·è„è¿›è¡Œçš„æ¯”è¾ƒç¼“æ…¢ï¼Œé¦–å…ˆ ret_sleep == OS_SYNC_TIME_EXCEEDED, å¹¶ä¸”æœ¬è½®åˆ·è„å’Œä¸Šä¸€è½®åˆ·è„è¶…è¿‡ 3sï¼Œwarn_interval æ§åˆ¶è¾“å‡ºæ—¥å¿—çš„é¢‘ç‡ï¼Œå¦‚æœæŒç»­æ‰“æ—¥å¿—ï¼Œå°±è¦çœ‹çœ‹ IO å»¶è¿Ÿäº†ã€‚ sync flushSync flush ä¸å— io_capacity/io_capacity_max çš„é™åˆ¶ï¼Œæ‰€ä»¥ä¼šå¯¹æ€§èƒ½äº§ç”Ÿæ¯”è¾ƒå¤§çš„å½±å“ã€‚ normal flushå½“ç³»ç»Ÿæœ‰è´Ÿè½½çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…é¢‘ç¹åˆ·è„å½±å“ç”¨æˆ·ï¼Œä¼šè®¡ç®—å‡ºæ¯æ¬¡åˆ·è„çš„ page æ•°é‡ idle flushç³»ç»Ÿç©ºé—²çš„æ—¶å€™ä¸ç”¨æ‹…å¿ƒåˆ·è„å½±å“ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨æœ€å¤§çš„ io_capacity åˆ·è„ã€‚RDS æœ‰å‚æ•° srv_idle_flush_pct æ§åˆ¶åˆ·è„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯ 100%ã€‚ è¿™é‡Œå°±æ˜¯é—®é¢˜çš„å…³é”®: ç³»ç»Ÿç©ºé—²çš„æ—¶å€™ä¸ç”¨æ‹…å¿ƒåˆ·è„å½±å“ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨æœ€å¤§çš„ io_capacity åˆ·è„; å½“ç³»ç»Ÿæœ‰è´Ÿè½½çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…é¢‘ç¹åˆ·è„å½±å“ç”¨æˆ·ï¼Œä¼šè®¡ç®—å‡ºæ¯æ¬¡åˆ·è„çš„ page æ•°é‡è¿›è¡Œåˆ·è„ çœ‹åˆ°è¿™é‡Œæˆ‘çŒœæµ‹, å½“ç›‘æ§è„šæœ¬å¯åŠ¨æ—¶, innodbè®¤ä¸ºâ€ç³»ç»Ÿæœ‰è´Ÿè½½â€, é‡‡ç”¨normal flushæ–¹å¼åˆ·è„é¡µ, é¿å…é¢‘ç¹åˆ·è„å½±å“ç”¨æˆ·; å½“è„šæœ¬å…³é—­æ—¶, innodbè®¤ä¸ºç³»ç»Ÿç©ºé—², é‡‡ç”¨idle flushæ–¹å¼å°½åŠ›åˆ·è„ æˆ‘åœ¨æµ‹è¯•æœåŠ¡å™¨, ä½¿ç”¨ while true; do mysql -udbms_monitor_rw -psuperpass -h172.16.23.x -P3307 dbms_monitor -eâ€REPLACE INTO dbms_monitor.monitor_delay(id) VALUES(1)â€ ; sleep 1 ; done æ¨¡æ‹Ÿç›‘æ§è„šæœ¬æ¯ç§’æ›´æ–° æµ‹è¯•æœåŠ¡å™¨åˆNä¸ªå®ä¾‹, å°±å¯åŠ¨Nä¸ªè„šæœ¬, ä¿è¯æ¯ä¸ªå®ä¾‹æ¯ç§’éƒ½æœ‰å†™å…¥, æˆ‘è¿™é‡Œæœ‰5ä¸ªå®ä¾‹ 3306-3310, æ‰€ä»¥æˆ‘å¼€äº†5ä¸ªçª—å£å¯¹æ¯ä¸ªå®ä¾‹è¿è¡Œä¸Šè¿°å‘½ä»¤ è¿™æ ·åšä¹Ÿå¯ä»¥æ’é™¤pythonè„šæœ¬å’Œproxysql ç»“æœCPUä½¿ç”¨ç‡æœ‰æ˜æ˜¾ä¸‹é™ å…³é—­è„šæœ¬CPUä½¿ç”¨ç‡ä¸Šå‡ æˆ‘ä»¬é€‰å–éæ ¸å¿ƒä¸šåŠ¡èŠ‚ç‚¹æµ‹è¯•, ä¹Ÿäº§ç”Ÿäº†ç›¸åŒçš„æ•ˆæœ, è‡³æ­¤åŸºæœ¬å®šä½äº†é—®é¢˜å‘ç”ŸåŸå›  å¦‚ä½•å¤„ç†?ä¸éœ€è¦å¤„ç†. åœ¨8.0ç‰ˆæœ¬å¢åŠ äº†å‚æ•°innodb_idle_flush_pct æ¥æ§åˆ¶idle flushæ¨¡å¼ä¸‹çš„åˆ·è„é‡","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"8.0MGR Subquery returns more than 1 row bug","slug":"2021-04-28-8.0MGR-Subquery-returns-more-than-1-row-bug","date":"2021-04-28T13:23:00.000Z","updated":"2021-04-28T13:06:05.588Z","comments":true,"path":"2021/04/28/2021-04-28-8.0MGR-Subquery-returns-more-than-1-row-bug/","link":"","permalink":"http://fuxkdb.com/2021/04/28/2021-04-28-8.0MGR-Subquery-returns-more-than-1-row-bug/","excerpt":"è¿™æ˜¯ä¸€ä¸ªPercona Server8.0.22ä¸‹ä½¿ç”¨MGR+ProxySQLæ—¶é‡åˆ°çš„bug ä½¿ç”¨mydumperå¤‡ä»½mgræ—¶å‘ç°ProxySQLæŠ¥é”™äº† 1234567# cat proxysql.log | grep -i subquery2021-04-28 15:14:22 MySQL_HostGroups_Manager.cpp:3875:update_group_replication_set_offline(): [WARNING] Group Replication: setting host 172.16.23.224:3309 offline because: Subquery returns more than 1 row2021-04-28 15:14:22 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee3540 , MYSQL 0x7fd62b804600 , FD 39 : Subquery returns more than 1 row2021-04-28 15:14:27 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee1440 , MYSQL 0x7fd62b800000 , FD 41 : Subquery returns more than 1 row2021-04-28 15:17:37 MySQL_HostGroups_Manager.cpp:3875:update_group_replication_set_offline(): [WARNING] Group Replication: setting host 172.16.23.151:3309 offline because: Subquery returns more than 1 row2021-04-28 15:17:37 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee78c0 , MYSQL 0x7fd62bc06400 , FD 51 : Subquery returns more than 1 row2021-04-28 15:17:42 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee0300 , MYSQL 0x7fd62bc00000 , FD 40 : Subquery returns more than 1 row","text":"è¿™æ˜¯ä¸€ä¸ªPercona Server8.0.22ä¸‹ä½¿ç”¨MGR+ProxySQLæ—¶é‡åˆ°çš„bug ä½¿ç”¨mydumperå¤‡ä»½mgræ—¶å‘ç°ProxySQLæŠ¥é”™äº† 1234567# cat proxysql.log | grep -i subquery2021-04-28 15:14:22 MySQL_HostGroups_Manager.cpp:3875:update_group_replication_set_offline(): [WARNING] Group Replication: setting host 172.16.23.224:3309 offline because: Subquery returns more than 1 row2021-04-28 15:14:22 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee3540 , MYSQL 0x7fd62b804600 , FD 39 : Subquery returns more than 1 row2021-04-28 15:14:27 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee1440 , MYSQL 0x7fd62b800000 , FD 41 : Subquery returns more than 1 row2021-04-28 15:17:37 MySQL_HostGroups_Manager.cpp:3875:update_group_replication_set_offline(): [WARNING] Group Replication: setting host 172.16.23.151:3309 offline because: Subquery returns more than 1 row2021-04-28 15:17:37 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee78c0 , MYSQL 0x7fd62bc06400 , FD 51 : Subquery returns more than 1 row2021-04-28 15:17:42 MySQL_Monitor.cpp:1472:monitor_group_replication_thread(): [ERROR] Got error. mmsd 0x7fd62cee0300 , MYSQL 0x7fd62bc00000 , FD 40 : Subquery returns more than 1 row çœ‹åˆ°è¿™ä¸ªé”™è¯¯æˆ‘æ€€ç–‘æ˜¯gr_member_routing_candidate_statusè§†å›¾æœ‰é—®é¢˜(å› ä¸ºä¹‹å‰è¢«è¿™ä¸ªè§†å›¾å‘è¿‡, è¯¦è§https://github.com/sysown/proxysql/issues/3406), å¹¶ä¸”çŒœæµ‹æ˜¯ç”±äºå¤‡ä»½æ—¶æ‰§è¡ŒFTWRLå¯¼è‡´çš„. è¿›è¡Œäº†å‡ æ¬¡æ¨¡æ‹Ÿ, å‘ç°äº†å¤ç°æ–¹æ³• ç¯å¢ƒ123456789101112131415161718192021222324[root@bj2-mysql-huoyun-prod-01 data]# mysql -uroot -p -S /data/mysql_3310/run/mysql.sockEnter password: Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 126072Server version: 8.0.22-13 Percona Server (GPL), Release 13, Revision 6f7822fCopyright (c) 2009-2020 Percona LLC and/or its affiliatesCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &#x27;help;&#x27; or &#x27;\\h&#x27; for help. Type &#x27;\\c&#x27; to clear the current input statement.root@localhost 17:54:49 [(none)]&gt; select * from performance_schema.replication_group_members;+---------------------------+--------------------------------------+---------------+-------------+--------------+-------------+----------------+| CHANNEL_NAME | MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |+---------------------------+--------------------------------------+---------------+-------------+--------------+-------------+----------------+| group_replication_applier | 06c6f8b7-a195-11eb-994b-fa163e39df9a | 172.16.xx.151 | 3310 | ONLINE | PRIMARY | 8.0.22 || group_replication_applier | 0710790b-a195-11eb-a621-fa163eb36fc8 | 172.16.xx.219 | 3310 | ONLINE | SECONDARY | 8.0.22 || group_replication_applier | 073ebcfe-a195-11eb-8b08-fa163efdcb19 | 172.16.xx.224 | 3310 | ONLINE | SECONDARY | 8.0.22 |+---------------------------+--------------------------------------+---------------+-------------+--------------+-------------+----------------+3 rows in set (0.00 sec) ProxySQLç›‘æ§æ£€æŸ¥éœ€è¦æŸ¥è¯¢gr_member_routing_candidate_statusè¡¨, å®šä¹‰å¦‚ä¸‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849DELIMITER $$CREATE FUNCTION gr_applier_queue_length()RETURNS INTDETERMINISTICBEGIN RETURN (SELECT sys.gtid_count( GTID_SUBTRACT( (SELECTReceived_transaction_set FROM performance_schema.replication_connection_statusWHERE Channel_name = &#x27;group_replication_applier&#x27; ), (SELECT@@global.GTID_EXECUTED) )));END$$CREATE FUNCTION gr_member_in_primary_partition()RETURNS VARCHAR(3)DETERMINISTICBEGIN RETURN (SELECT IF( MEMBER_STATE=&#x27;ONLINE&#x27; AND ((SELECT COUNT(*) FROMperformance_schema.replication_group_members WHERE MEMBER_STATE != &#x27;ONLINE&#x27;) &gt;=((SELECT COUNT(*) FROM performance_schema.replication_group_members)/2) = 0),&#x27;YES&#x27;, &#x27;NO&#x27; ) FROM performance_schema.replication_group_members JOINperformance_schema.replication_group_member_stats rgms USING(member_id) WHERE rgms.MEMBER_ID=@@SERVER_UUID ) ;END$$CREATE FUNCTION gr_transactions_to_cert() RETURNS int(11) DETERMINISTICBEGIN RETURN (select performance_schema.replication_group_member_stats.COUNT_TRANSACTIONS_IN_QUEUE AS transactions_to_cert FROM performance_schema.replication_group_member_stats where MEMBER_ID=@@SERVER_UUID );END$$CREATE VIEW gr_member_routing_candidate_status AS SELECT IFNULL(sys.gr_member_in_primary_partition(),&#x27;NO&#x27;) AS viable_candidate, IF((SELECT ((SELECT GROUP_CONCAT(performance_schema.global_variables.VARIABLE_VALUE SEPARATOR &#x27;,&#x27;) FROM performance_schema.global_variables WHERE (performance_schema.global_variables.VARIABLE_NAME IN (&#x27;read_only&#x27; , &#x27;super_read_only&#x27;))) &lt;&gt; &#x27;OFF,OFF&#x27;) ), &#x27;YES&#x27;, &#x27;NO&#x27;) AS read_only, IFNULL(sys.gr_applier_queue_length(),0) AS transactions_behind, IFNULL(sys.gr_transactions_to_cert(),0) AS transactions_to_cert;$$DELIMITER ; å¯åŠ¨ä¸¤ä¸ªsession, session1, session2, è¿æ¥MGRä»»æ„ä¸€ä¸ªèŠ‚ç‚¹(PRIMARYè¿˜æ˜¯SECONDARYæ— æ‰€è°“) session2æ‰§è¡Œ 1234567select * from gr_member_in_primary_partition();+--------------------------------------+| sys.gr_member_in_primary_partition() |+--------------------------------------+| YES |+--------------------------------------+1 row in set (0.00 sec) session1æ‰§è¡Œ 1flush tables with read lock; æ­¤æ—¶session2å†æ¬¡æ‰§è¡Œ 1234567&gt; select sys.gr_member_in_primary_partition();ERROR 1242 (21000): Subquery returns more than 1 rowå¯¼è‡´æŸ¥è¯¢gr_member_routing_candidate_statusä¹ŸæŠ¥é”™&gt; select * from gr_member_routing_candidate_status;ERROR 1242 (21000): Subquery returns more than 1 row ç„¶è€Œåœ¨session2ç›´æ¥è¿è¡Œgr_member_in_primary_partitionå®šä¹‰ä¸­çš„sqlè¯­å¥å´ä¸€åˆ‡æ­£å¸¸ 1234567891011121314&gt; SELECT IF( MEMBER_STATE=&#x27;ONLINE&#x27; AND ((SELECT COUNT(*) FROM -&gt; performance_schema.replication_group_members WHERE MEMBER_STATE != &#x27;ONLINE&#x27;) &gt;= -&gt; ((SELECT COUNT(*) FROM performance_schema.replication_group_members)/2) = 0), -&gt; &#x27;YES&#x27;, &#x27;NO&#x27; ) FROM performance_schema.replication_group_members JOIN -&gt; performance_schema.replication_group_member_stats rgms USING(member_id) WHERE rgms.MEMBER_ID=@@SERVER_UUID;+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| IF( MEMBER_STATE=&#x27;ONLINE&#x27; AND ((SELECT COUNT(*) FROMperformance_schema.replication_group_members WHERE MEMBER_STATE != &#x27;ONLINE&#x27;) &gt;=((SELECT COUNT(*) FROM performance_schema.replication_group_members)/2) = 0),&#x27;YES&#x27;, &#x27;NO&#x27; ) |+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| YES |+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+1 row in set (0.01 sec) æµ‹è¯•å¯åŠ¨session3, è¿è¡ŒæŸ¥è¯¢select sys.gr_member_in_primary_partition(); æ— å¼‚å¸¸ session1 unlock tables å session2 æ‰§è¡ŒæŸ¥è¯¢select sys.gr_member_in_primary_partition();ä»ç„¶æŠ¥é”™ æ€€ç–‘æ˜¯MySQL bug è§£å†³åŠæ³•å¦‚ä½•è§£å†³å‘¢, ä¸ä½¿ç”¨å‡½æ•°, ç›´æ¥ç”¨gr_member_in_primary_partitionä¸­çš„sqlæ›¿æ¢ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124SET @TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;SET @@SESSION.SQL_LOG_BIN= 0;SET @TEMP_READ_ONLY = @@GLOBAL.READ_ONLY;SET @TEMP_SUPER_READ_ONLY = @@GLOBAL.SUPER_READ_ONLY;SET @@GLOBAL.READ_ONLY = 0;USE sys;DROP VIEW IF EXISTS gr_member_routing_candidate_status;DROP FUNCTION IF EXISTS IFZERO;DROP FUNCTION IF EXISTS LOCATE2;DROP FUNCTION IF EXISTS GTID_NORMALIZE;DROP FUNCTION IF EXISTS GTID_COUNT;DROP FUNCTION IF EXISTS gr_applier_queue_length;DROP FUNCTION IF EXISTS gr_member_in_primary_partition;DROP FUNCTION IF EXISTS gr_transactions_to_cert;DELIMITER $$CREATE FUNCTION IFZERO(a INT, b INT)RETURNS INTDETERMINISTICRETURN IF(a = 0, b, a)$$CREATE FUNCTION LOCATE2(needle TEXT(10000), haystack TEXT(10000), offset INT)RETURNS INTDETERMINISTICRETURN IFZERO(LOCATE(needle, haystack, offset), LENGTH(haystack) + 1)$$CREATE FUNCTION GTID_NORMALIZE(g TEXT(10000))RETURNS TEXT(10000)DETERMINISTICRETURN GTID_SUBTRACT(g, &#x27;&#x27;)$$CREATE FUNCTION GTID_COUNT(gtid_set TEXT(10000))RETURNS INTDETERMINISTICBEGIN DECLARE result BIGINT DEFAULT 0; DECLARE colon_pos INT; DECLARE next_dash_pos INT; DECLARE next_colon_pos INT; DECLARE next_comma_pos INT; SET gtid_set = GTID_NORMALIZE(gtid_set); SET colon_pos = LOCATE2(&#x27;:&#x27;, gtid_set, 1); WHILE colon_pos != LENGTH(gtid_set) + 1 DO SET next_dash_pos = LOCATE2(&#x27;-&#x27;, gtid_set, colon_pos + 1); SET next_colon_pos = LOCATE2(&#x27;:&#x27;, gtid_set, colon_pos + 1); SET next_comma_pos = LOCATE2(&#x27;,&#x27;, gtid_set, colon_pos + 1); IF next_dash_pos &lt; next_colon_pos AND next_dash_pos &lt; next_comma_pos THEN SET result = result + SUBSTR(gtid_set, next_dash_pos + 1, LEAST(next_colon_pos, next_comma_pos) - (next_dash_pos + 1)) - SUBSTR(gtid_set, colon_pos + 1, next_dash_pos - (colon_pos + 1)) + 1; ELSE SET result = result + 1; END IF; SET colon_pos = next_colon_pos; END WHILE; RETURN result;END$$CREATE FUNCTION gr_applier_queue_length()RETURNS INTDETERMINISTICBEGIN RETURN (SELECT sys.gtid_count( GTID_SUBTRACT( (SELECTReceived_transaction_set FROM performance_schema.replication_connection_statusWHERE Channel_name = &#x27;group_replication_applier&#x27; ), (SELECT@@global.GTID_EXECUTED) )));END$$CREATE FUNCTION gr_transactions_to_cert() RETURNS int(11) DETERMINISTICBEGIN RETURN (select performance_schema.replication_group_member_stats.COUNT_TRANSACTIONS_IN_QUEUE AS transactions_to_cert FROM performance_schema.replication_group_member_stats where MEMBER_ID=@@SERVER_UUID );END$$CREATE FUNCTION my_server_uuid() RETURNS TEXT(36) DETERMINISTIC NO SQL RETURN (SELECT @@global.server_uuid as my_id);$$CREATE VIEW gr_member_routing_candidate_status AS SELECT IFNULL((SELECT IF(MEMBER_STATE = &#x27;ONLINE&#x27; AND ((SELECT COUNT(*) FROM performance_schema.replication_group_members WHERE MEMBER_STATE != &#x27;ONLINE&#x27;) &gt;= ((SELECT COUNT(*) FROM performance_schema.replication_group_members) / 2) = 0), &#x27;YES&#x27;, &#x27;NO&#x27;) FROM performance_schema.replication_group_members JOIN performance_schema.replication_group_member_stats rgms USING (member_id) WHERE rgms.MEMBER_ID = my_server_uuid()), &#x27;NO&#x27;) AS viable_candidate, IF((SELECT ((SELECT GROUP_CONCAT(performance_schema.global_variables.VARIABLE_VALUE SEPARATOR &#x27;,&#x27;) FROM performance_schema.global_variables WHERE (performance_schema.global_variables.VARIABLE_NAME IN (&#x27;read_only&#x27; , &#x27;super_read_only&#x27;))) &lt;&gt; &#x27;OFF,OFF&#x27;) ), &#x27;YES&#x27;, &#x27;NO&#x27;) AS read_only, IFNULL(sys.gr_applier_queue_length(), 0) AS transactions_behind, IFNULL(sys.gr_transactions_to_cert(), 0) AS transactions_to_cert;$$DELIMITER ;SET @@SESSION.SQL_LOG_BIN = @TEMP_LOG_BIN;SET @@GLOBAL.READ_ONLY = @TEMP_READ_ONLY;SET @@GLOBAL.SUPER_READ_ONLY = @TEMP_SUPER_READ_ONLY; å®Œæ•´ç‰ˆaddtion_to_sys123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123-- SET @TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;-- SET @@SESSION.SQL_LOG_BIN= 0;-- SET @TEMP_READ_ONLY = @@GLOBAL.READ_ONLY;-- SET @TEMP_SUPER_READ_ONLY = @@GLOBAL.SUPER_READ_ONLY;-- SET @@GLOBAL.READ_ONLY = 0;USE sys;DROP VIEW IF EXISTS gr_member_routing_candidate_status;DROP FUNCTION IF EXISTS IFZERO;DROP FUNCTION IF EXISTS LOCATE2;DROP FUNCTION IF EXISTS GTID_NORMALIZE;DROP FUNCTION IF EXISTS GTID_COUNT;DROP FUNCTION IF EXISTS gr_applier_queue_length;DROP FUNCTION IF EXISTS gr_member_in_primary_partition;DROP FUNCTION IF EXISTS gr_transactions_to_cert;DELIMITER $$CREATE FUNCTION IFZERO(a INT, b INT)RETURNS INTDETERMINISTICRETURN IF(a = 0, b, a)$$CREATE FUNCTION LOCATE2(needle TEXT(10000), haystack TEXT(10000), offset INT)RETURNS INTDETERMINISTICRETURN IFZERO(LOCATE(needle, haystack, offset), LENGTH(haystack) + 1)$$CREATE FUNCTION GTID_NORMALIZE(g TEXT(10000))RETURNS TEXT(10000)DETERMINISTICRETURN GTID_SUBTRACT(g, &#x27;&#x27;)$$CREATE FUNCTION GTID_COUNT(gtid_set TEXT(10000))RETURNS INTDETERMINISTICBEGIN DECLARE result BIGINT DEFAULT 0; DECLARE colon_pos INT; DECLARE next_dash_pos INT; DECLARE next_colon_pos INT; DECLARE next_comma_pos INT; SET gtid_set = GTID_NORMALIZE(gtid_set); SET colon_pos = LOCATE2(&#x27;:&#x27;, gtid_set, 1); WHILE colon_pos != LENGTH(gtid_set) + 1 DO SET next_dash_pos = LOCATE2(&#x27;-&#x27;, gtid_set, colon_pos + 1); SET next_colon_pos = LOCATE2(&#x27;:&#x27;, gtid_set, colon_pos + 1); SET next_comma_pos = LOCATE2(&#x27;,&#x27;, gtid_set, colon_pos + 1); IF next_dash_pos &lt; next_colon_pos AND next_dash_pos &lt; next_comma_pos THEN SET result = result + SUBSTR(gtid_set, next_dash_pos + 1, LEAST(next_colon_pos, next_comma_pos) - (next_dash_pos + 1)) - SUBSTR(gtid_set, colon_pos + 1, next_dash_pos - (colon_pos + 1)) + 1; ELSE SET result = result + 1; END IF; SET colon_pos = next_colon_pos; END WHILE; RETURN result;END$$CREATE FUNCTION gr_applier_queue_length()RETURNS INTDETERMINISTICBEGIN RETURN (SELECT sys.gtid_count( GTID_SUBTRACT( (SELECTReceived_transaction_set FROM performance_schema.replication_connection_statusWHERE Channel_name = &#x27;group_replication_applier&#x27; ), (SELECT@@global.GTID_EXECUTED) )));END$$CREATE FUNCTION gr_transactions_to_cert() RETURNS int(11) DETERMINISTICBEGIN RETURN (select performance_schema.replication_group_member_stats.COUNT_TRANSACTIONS_IN_QUEUE AS transactions_to_cert FROM performance_schema.replication_group_member_stats where MEMBER_ID=@@SERVER_UUID );END$$CREATE FUNCTION my_server_uuid() RETURNS TEXT(36) DETERMINISTIC NO SQL RETURN (SELECT @@global.server_uuid as my_id);$$CREATE VIEW gr_member_routing_candidate_status AS SELECT IFNULL((SELECT IF(MEMBER_STATE = &#x27;ONLINE&#x27; AND ((SELECT COUNT(*) FROM performance_schema.replication_group_members WHERE MEMBER_STATE != &#x27;ONLINE&#x27;) &gt;= ((SELECT COUNT(*) FROM performance_schema.replication_group_members) / 2) = 0), &#x27;YES&#x27;, &#x27;NO&#x27;) FROM performance_schema.replication_group_members JOIN performance_schema.replication_group_member_stats rgms USING (member_id) WHERE rgms.MEMBER_ID = my_server_uuid()), &#x27;NO&#x27;) AS viable_candidate, IF((SELECT ((SELECT GROUP_CONCAT(performance_schema.global_variables.VARIABLE_VALUE SEPARATOR &#x27;,&#x27;) FROM performance_schema.global_variables WHERE (performance_schema.global_variables.VARIABLE_NAME IN (&#x27;read_only&#x27; , &#x27;super_read_only&#x27;))) &lt;&gt; &#x27;OFF,OFF&#x27;) ), &#x27;YES&#x27;, &#x27;NO&#x27;) AS read_only, IFNULL(sys.gr_applier_queue_length(), 0) AS transactions_behind, IFNULL(sys.gr_transactions_to_cert(), 0) AS transactions_to_cert;$$DELIMITER ;-- SET @@SESSION.SQL_LOG_BIN = @TEMP_LOG_BIN;-- SET @@GLOBAL.READ_ONLY = @TEMP_READ_ONLY;-- SET @@GLOBAL.SUPER_READ_ONLY = @TEMP_SUPER_READ_ONLY;","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MGR","slug":"MGR","permalink":"http://fuxkdb.com/tags/MGR/"},{"name":"ProxySQL","slug":"ProxySQL","permalink":"http://fuxkdb.com/tags/ProxySQL/"}]},{"title":"skeemaç®€å•ä½¿ç”¨","slug":"2021-02-18-skeemaç®€å•ä½¿ç”¨","date":"2021-02-18T05:08:00.000Z","updated":"2021-02-18T05:15:11.043Z","comments":true,"path":"2021/02/18/2021-02-18-skeemaç®€å•ä½¿ç”¨/","link":"","permalink":"http://fuxkdb.com/2021/02/18/2021-02-18-skeema%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/","excerpt":"ç®€ä»‹Skeema is a tool for managing MySQL tables and schema changes in a declarative fashion using pure SQL. It provides a CLI tool allowing you to: Export CREATE TABLE statements to the filesystem, for tracking in a repo (git, hg, svn, etc) Diff changes in the schema repo against live DBs to automatically generate DDL Manage multiple environments (e.g. dev, staging, prod) and keep them in sync with ease Configure use of online schema change tools, such as pt-online-schema-change, for performing ALTERs Convert non-online migrations from frameworks like Rails or Django into online schema changes in production Skeema supports a pull-request-based workflow for schema change submission, review, and execution. This permits your team to manage schema changes in exactly the same way as you manage code changes. Our new companion Cloud Linter for GitHub repos provides automatic linting of schema change commits and pull requests. æˆ‘è¿™çš„éœ€æ±‚æ˜¯åŒæ­¥ç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„åˆ°æ¼”ç»ƒç¯å¢ƒ, ä»¥ä¸‹æ˜¯é’ˆå¯¹æˆ‘è¿™ä¸ªåœºæ™¯çš„å…·ä½“ä½¿ç”¨æ–¹æ³• æƒé™skeemaéœ€è¦çš„ç”¨æˆ·æƒé™å…·ä½“è§https://www.skeema.io/docs/requirements/ è¿™é‡Œè¯´ä¸€ä¸‹é‡ç‚¹, skeema diffæ—¶ä¼šåœ¨ç›®æ ‡ç¯å¢ƒåˆ›å»ºä¸€ä¸ª_skeema_tmpä¸´æ—¶æ•°æ®åº“, ç„¶åä¼šåˆ é™¤è¿™ä¸ªåº“","text":"ç®€ä»‹Skeema is a tool for managing MySQL tables and schema changes in a declarative fashion using pure SQL. It provides a CLI tool allowing you to: Export CREATE TABLE statements to the filesystem, for tracking in a repo (git, hg, svn, etc) Diff changes in the schema repo against live DBs to automatically generate DDL Manage multiple environments (e.g. dev, staging, prod) and keep them in sync with ease Configure use of online schema change tools, such as pt-online-schema-change, for performing ALTERs Convert non-online migrations from frameworks like Rails or Django into online schema changes in production Skeema supports a pull-request-based workflow for schema change submission, review, and execution. This permits your team to manage schema changes in exactly the same way as you manage code changes. Our new companion Cloud Linter for GitHub repos provides automatic linting of schema change commits and pull requests. æˆ‘è¿™çš„éœ€æ±‚æ˜¯åŒæ­¥ç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„åˆ°æ¼”ç»ƒç¯å¢ƒ, ä»¥ä¸‹æ˜¯é’ˆå¯¹æˆ‘è¿™ä¸ªåœºæ™¯çš„å…·ä½“ä½¿ç”¨æ–¹æ³• æƒé™skeemaéœ€è¦çš„ç”¨æˆ·æƒé™å…·ä½“è§https://www.skeema.io/docs/requirements/ è¿™é‡Œè¯´ä¸€ä¸‹é‡ç‚¹, skeema diffæ—¶ä¼šåœ¨ç›®æ ‡ç¯å¢ƒåˆ›å»ºä¸€ä¸ª_skeema_tmpä¸´æ—¶æ•°æ®åº“, ç„¶åä¼šåˆ é™¤è¿™ä¸ªåº“ å®‰è£…å®‰è£…goç¯å¢ƒ 123wget https://dl.google.com/go/go1.16.linux-amd64.tar.gztar -C /usr/local -xzf go1.16.linux-amd64.tar.gz export PATH=$PATH:/usr/local/go/bin å®‰è£…skeema 12curl -LO https://github.com/skeema/skeema/releases/latest/download/skeema_amd64.rpmrpm -ivh skeema ä½¿ç”¨initåœ¨æ¼”ç»ƒç¯å¢ƒ 1skeema init -h 127.0.0.1 -P 3358 -u fanboshi -p -d 3358 --schema sss -d dumpçš„sqlæ–‡ä»¶å­˜å‚¨è·¯å¾„ â€“schema åªå¯¼å‡ºsssè¿™ä¸ªæ•°æ®åº“çš„ç»“æ„ä¿¡æ¯ éšå3358ç›®å½•ä¸‹å›åŒ…å«ä¸€äº›.sqlæ–‡ä»¶å’Œä¸€ä¸ª.skeemaæ–‡ä»¶ 123456789101112131415-rw-r--r-- 1 root root 213 Feb 18 12:37 .skeema-rw-r--r-- 1 root root 1521 Feb 18 12:33 sss_cmdb_instances.sql-rw-r--r-- 1 root root 305 Feb 18 12:33 sss_cmdb_vip.sql-rw-r--r-- 1 root root 1122 Feb 18 12:33 sss_host_host.sql-rw-r--r-- 1 root root 388 Feb 18 12:33 sss_cmdb_cluster_domain_name_config.sql-rw-r--r-- 1 root root 369 Feb 18 12:33 sss_cmdb_cluster_portrayal_mapping.sql-rw-r--r-- 1 root root 602 Feb 18 12:33 sss_cmdb_cluster.sql-rw-r--r-- 1 root root 1148 Feb 18 12:33 sss_cmdb_cluster_users.sql-rw-r--r-- 1 root root 304 Feb 18 12:33 sss_cmdb_instance_ports.sql-rw-r--r-- 1 root root 756 Feb 18 12:33 sss_cmdb_instances_port.sql-rw-r--r-- 1 root root 244 Feb 18 12:33 sss_cmdb_productlines.sql-rw-r--r-- 1 root root 595 Feb 18 12:33 sss_cmdb_services.sql-rw-r--r-- 1 root root 274 Feb 18 12:33 sss_dbms_environment.sql-rw-r--r-- 1 root root 815 Feb 18 12:33 sss_dbms_sql_config.sql-rw-r--r-- 1 root root 625 Feb 18 12:33 sss_cmdb_environments.sql ç¼–è¾‘.skeemaæ–‡ä»¶ 12345678910#cat .skeema default-character-set=utf8default-collation=utf8_general_cischema=sss[production]flavor=percona:5.7host=127.0.0.1port=3358user=fanboshi æˆ‘ä»¬è¿™é‡Œä¿®æ”¹[production]ä¸º[drill], å¹¶å¢åŠ ä¸€äº›å‚æ•° 1234567891011alter-wrapper=&quot;gh-ost --allow-on-master --assume-rbr --initially-drop-ghost-table --initially-drop-old-table -exact-rowcount --approve-renamed-columns --concurrent-rowcount=false --chunk-size=800 --hooks-path=/tmp/hook --user=&#123;USER&#125; --ask-pass --host=&#123;HOST&#125; --port=&#123;PORT&#125; --database=&#123;SCHEMA&#125; --table=&#123;TABLE&#125; --alter=&#123;CLAUSES&#125; --execute&quot;default-character-set=utf8default-collation=utf8_general_cischema=sss[drill]flavor=percona:5.7host=127.0.0.1port=3358user=fanboshipassword=superpass #å¯åŠ å¯ä¸åŠ , å¦‚æœæ²¡æœ‰å®šä¹‰password, åˆ™éœ€è¦åœ¨å‘½ä»¤è¡Œå¢åŠ -på‚æ•° æ·»åŠ ç”Ÿäº§ç¯å¢ƒ 1skeema add-environment product -h 172.16.120.11 -P 3358 -u fanboshi æˆ–è€…ç›´æ¥åœ¨.skeemaæ·»åŠ å¦‚ä¸‹ä¿¡æ¯ 12345[product]flavor=percona:5.7host=172.16.120.11port=3358user=fanboshi æœ€ç»ˆçš„.skeemaæ–‡ä»¶å¦‚ä¸‹ 1234567891011121314151617alter-wrapper=&quot;gh-ost --allow-on-master --assume-rbr --initially-drop-ghost-table --initially-drop-old-table -exact-rowcount --approve-renamed-columns --concurrent-rowcount=false --chunk-size=800 --hooks-path=/tmp/hook --user=&#123;USER&#125; --ask-pass --host=&#123;HOST&#125; --port=&#123;PORT&#125; --database=&#123;SCHEMA&#125; --table=&#123;TABLE&#125; --alter=&#123;CLAUSES&#125; --execute&quot;default-character-set=utf8default-collation=utf8_general_cischema=sss[drill]flavor=percona:5.7host=127.0.0.1port=3358user=fanboshi#password=superpass #å¯åŠ å¯ä¸åŠ , å¦‚æœæ²¡æœ‰å®šä¹‰password, åˆ™éœ€è¦åœ¨å‘½ä»¤è¡Œå¢åŠ -på‚æ•°[product]flavor=percona:5.7host=172.16.120.11port=3358user=fanboshi æ‹‰å–ç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„12cd 3358skeema pull product -p ç”Ÿæˆdrillç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚sqlæ–‡ä»¶1skeema diff drill --allow-unsafe -psuperpass &gt; /tmp/diff.sql å¦‚æœæ²¡æœ‰åœ¨.skeemaæ–‡ä»¶ä¸­æŒ‡å®špasswordå‚æ•°, åˆ™è¦åœ¨å‘½ä»¤è¡ŒæŒ‡å®š-på‚æ•°å¹¶å¡«å†™å¯†ç  æŸ¥çœ‹ç”Ÿäº§çš„æ–‡ä»¶ 1234567891011121314151617-- instance: 127.0.0.1:3358USE `sss`;\\! gh-ost --allow-on-master --assume-rbr --initially-drop-ghost-table --initially-drop-old-table -exact-rowcount --approve-renamed-columns --concurrent-rowcount=false --chunk-size=800 --hooks-path=/tmp/hook --user=fanboshi --ask-pass --host=127.0.0.1 --port=3358 --database=sss --table=sss_cmdb_service_name --alter=&#x27;DROP COLUMN `environment_name`, DROP COLUMN `productline_name`, DROP COLUMN `cmdb_cluster_name`&#x27; --executeCREATE TABLE `sss_domain_manage` ( `id` int(11) NOT NULL AUTO_INCREMENT,... PRIMARY KEY (`id`), UNIQUE KEY `domain_name` (`domain_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;CREATE TABLE `sss_iam_role_members` ( `id` int(11) NOT NULL AUTO_INCREMENT,... UNIQUE KEY `sss_iam_role_members_role_id_profile_id_93c492ff_uniq` (`role_id`,`profile_id`), KEY `ytree_iam_role_members_profile_id_ce949eff_fk_users_profile_uid` (`profile_id`), CONSTRAINT `sss_iam_role_members_profile_id_ce949eff_fk_users_profile_uid` FOREIGN KEY (`profile_id`) REFERENCES `sss_users_profile` (`uid`), CONSTRAINT `sss_iam_role_members_role_id_8a1e407b_fk_ytree_iam_role_id` FOREIGN KEY (`role_id`) REFERENCES `sss_iam_role` (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯ä¸€ä¸ª.sqlæ–‡ä»¶, æ³¨æ„ç”Ÿæˆçš„gh-ostè¯­å¥å‰æœ‰ä¸€ä¸ª\\!, å¤§å®¶åº”è¯¥æ˜ç™½æ˜¯å•¥æ„æ€å§ å¦‚æœæ˜¯æƒ³æ‰‹åŠ¨æ‰§è¡Œgh-ostå‘½ä»¤, è®°å¾—æŠŠâ€`â€è½¬ä¹‰æ‰","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"DorisDB vs ClickHouse SSBå¯¹æ¯”æµ‹è¯•","slug":"2021-02-12-DorisDB-vs-ClickHouse-SSBå¯¹æ¯”æµ‹è¯•","date":"2021-02-12T09:24:00.000Z","updated":"2021-02-12T09:25:10.704Z","comments":true,"path":"2021/02/12/2021-02-12-DorisDB-vs-ClickHouse-SSBå¯¹æ¯”æµ‹è¯•/","link":"","permalink":"http://fuxkdb.com/2021/02/12/2021-02-12-DorisDB-vs-ClickHouse-SSB%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/","excerpt":"DorisDB vs ClickHouse SSBå¯¹æ¯”æµ‹è¯•TL;DR è¿›è¡Œæœ¬æ¬¡æµ‹è¯•æ—¶å¯¹DorisDBäº†è§£ç”šå¾® æœ¬æ¬¡æµ‹è¯•ç”±äºæœåŠ¡å™¨èµ„æºæœ‰é™, æ²¡æœ‰ä¸¥æ ¼éµå¾ªå•ä¸€å˜é‡åŸåˆ™è¿›è¡Œæµ‹è¯• æœ¬æ¬¡æµ‹è¯•æœ‰ä¸€å®šå‚è€ƒæ„ä¹‰ æ•°æ®å¯¼å…¥é€Ÿåº¦ ClickHouse: 3500s DorisDB: 5160s æ•°æ®å‹ç¼©æƒ…å†µ(é€šè¿‡ç£ç›˜å ç”¨ç©ºé—´æ¯”è¾ƒ) ClickHouse: 85.2G DorisDB: 132G æŸ¥è¯¢é€Ÿåº¦å•è¡¨æŸ¥è¯¢ DorisDB1 DorisDB2 ClickHouse1 ClickHouse2 Q1.1 350 290 226 195 Q1.2 270 190 34 63 Q1.3 310 240 43 22 Q2.1 410 370 1,723 1,791 Q2.2 780 720 1,463 1,470 Q2.3 340 280 659 1,337 Q3.1 1,560 860 3,488 1,254 Q3.2 1,080 790 1,272 966 Q3.3 250 290 979 889 Q3.4 230 260 36 20 Q4.1 870 720 5,067 2,791 Q4.2 720 490 804 752 Q4.3 510 380 561 482 å¤šè¡¨æŸ¥è¯¢ DorisDB1 DorisDB2 ClickHouse1 ClickHouse2 Q1.1 450 490 1,496 1,424 Q1.2 410 450 1,366 659 Q1.3 510 340 678 1,377 Q2.1 1,560 1,600 4,360 2,667 Q2.2 1,690 1,060 4,498 1,554 Q2.3 780 1,150 2,569 2,577 Q3.1 3,480 3,700 10,190 12,960 Q3.2 1,320 1,850 5,926 5,743 Q3.3 1,030 1,040 3,445 3,300 Q3.4 1,330 1,170 3,455 3,330 Q4.1 3,480 3,750 15,560 9,494 Q4.2 2,830 3,170 16,109 18,048 Q4.3 1,560 2,140 15,685 14,838","text":"DorisDB vs ClickHouse SSBå¯¹æ¯”æµ‹è¯•TL;DR è¿›è¡Œæœ¬æ¬¡æµ‹è¯•æ—¶å¯¹DorisDBäº†è§£ç”šå¾® æœ¬æ¬¡æµ‹è¯•ç”±äºæœåŠ¡å™¨èµ„æºæœ‰é™, æ²¡æœ‰ä¸¥æ ¼éµå¾ªå•ä¸€å˜é‡åŸåˆ™è¿›è¡Œæµ‹è¯• æœ¬æ¬¡æµ‹è¯•æœ‰ä¸€å®šå‚è€ƒæ„ä¹‰ æ•°æ®å¯¼å…¥é€Ÿåº¦ ClickHouse: 3500s DorisDB: 5160s æ•°æ®å‹ç¼©æƒ…å†µ(é€šè¿‡ç£ç›˜å ç”¨ç©ºé—´æ¯”è¾ƒ) ClickHouse: 85.2G DorisDB: 132G æŸ¥è¯¢é€Ÿåº¦å•è¡¨æŸ¥è¯¢ DorisDB1 DorisDB2 ClickHouse1 ClickHouse2 Q1.1 350 290 226 195 Q1.2 270 190 34 63 Q1.3 310 240 43 22 Q2.1 410 370 1,723 1,791 Q2.2 780 720 1,463 1,470 Q2.3 340 280 659 1,337 Q3.1 1,560 860 3,488 1,254 Q3.2 1,080 790 1,272 966 Q3.3 250 290 979 889 Q3.4 230 260 36 20 Q4.1 870 720 5,067 2,791 Q4.2 720 490 804 752 Q4.3 510 380 561 482 å¤šè¡¨æŸ¥è¯¢ DorisDB1 DorisDB2 ClickHouse1 ClickHouse2 Q1.1 450 490 1,496 1,424 Q1.2 410 450 1,366 659 Q1.3 510 340 678 1,377 Q2.1 1,560 1,600 4,360 2,667 Q2.2 1,690 1,060 4,498 1,554 Q2.3 780 1,150 2,569 2,577 Q3.1 3,480 3,700 10,190 12,960 Q3.2 1,320 1,850 5,926 5,743 Q3.3 1,030 1,040 3,445 3,300 Q3.4 1,330 1,170 3,455 3,330 Q4.1 3,480 3,750 15,560 9,494 Q4.2 2,830 3,170 16,109 18,048 Q4.3 1,560 2,140 15,685 14,838 ç¯å¢ƒä¿¡æ¯ClickHouse: 3å° åä¸ºäº‘ECS é«˜æ€§èƒ½è®¡ç®—å‹ | h3.xlarge.2 | 4vCPUs | 8GB | è¶…é«˜IO SSD DorisDB: 3å° åä¸ºäº‘ECS é«˜æ€§èƒ½è®¡ç®—å‹ | h3.2xlarge.4 | 8vCPUs | 32GB | è¶…é«˜IO SSD ç”±äºèµ„æºç´§å¼ , DorisDBæ‰€åœ¨æœåŠ¡å™¨ä¸Šè¿˜éƒ¨ç½²äº†rc mysql, ä½†è¿‡å¹´æœŸé—´æ— äººä½¿ç”¨, å®é™…å¯ç”¨å†…å­˜16G. DorisDB: DorisDB-SE-1.12.1 3Fe 3Be, feå’Œbeéƒ¨ç½²åœ¨ä¸€èµ· ClickHouse: 20.10.3.30, ä¸‰åˆ†ç‰‡ä¸¤å‰¯æœ¬æ··åˆéƒ¨ç½², éƒ¨ç½²æ–¹æ³•è¯¦è§ClickHouseé›†ç¾¤å¤šå®ä¾‹éƒ¨ç½² æ³¨æ„ å®é™…æ•°æ®å¯¼å…¥åDorsiDBå’ŒClickHouseé™¤lineorder_flatå¤–æ•°æ®æ— ä»»ä½•å·®å¼‚ lineorder_flat: DorsiDB: 546669614 ClickHouse: 622259902 DorisDBéƒ¨ç½²ç•¥ æ„å»ºæ•°æ®é¦–å…ˆä¸‹è½½ssb-pocå·¥å…·åŒ…å¹¶ç¼–è¯‘ 1234wget http://dorisdb-public.oss-cn-zhangjiakou.aliyuncs.com/ssb-poc-0.9.zipunzip ssb-poc-0.9.zipcd ssb-pocmake &amp;&amp; make install æ‰€æœ‰ç›¸å…³å·¥å…·å®‰è£…åˆ°outputç›®å½•ã€‚ è¿›å…¥outputç›®å½•ï¼Œç”Ÿæˆæ•°æ® 12cd outputbin/gen-ssb.sh 100 data_dir å»ºè¡¨ä¿®æ”¹é…ç½®æ–‡ä»¶conf/doris.confï¼ŒæŒ‡å®šè„šæœ¬æ“ä½œçš„Dorisé›†ç¾¤åœ°å€ 12345678910111213 # for mysql cmd mysql_host: 192.168.1.1 mysql_port: 9030 mysql_user: root mysql_password: doris_db: ssb # cluster ports http_port: 8030 be_heartbeat_port: 9050 broker_port: 8000 ... æ‰§è¡Œè„šæœ¬å»ºè¡¨ 1bin/create_db_table.sh ddl_100 æˆ‘è¿™é‡Œå»ºè¡¨è·‘å»ºè¡¨è„šæœ¬æŠ¥é”™äº†, æ”¹ä¸ºæ‰‹åŠ¨å»ºè¡¨, å‚è€ƒhttp://doc.dorisdb.com/2146807 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169CREATE TABLE IF NOT EXISTS `lineorder` ( `lo_orderkey` int(11) NOT NULL COMMENT &quot;&quot;, `lo_linenumber` int(11) NOT NULL COMMENT &quot;&quot;, `lo_custkey` int(11) NOT NULL COMMENT &quot;&quot;, `lo_partkey` int(11) NOT NULL COMMENT &quot;&quot;, `lo_suppkey` int(11) NOT NULL COMMENT &quot;&quot;, `lo_orderdate` int(11) NOT NULL COMMENT &quot;&quot;, `lo_orderpriority` varchar(16) NOT NULL COMMENT &quot;&quot;, `lo_shippriority` int(11) NOT NULL COMMENT &quot;&quot;, `lo_quantity` int(11) NOT NULL COMMENT &quot;&quot;, `lo_extendedprice` int(11) NOT NULL COMMENT &quot;&quot;, `lo_ordtotalprice` int(11) NOT NULL COMMENT &quot;&quot;, `lo_discount` int(11) NOT NULL COMMENT &quot;&quot;, `lo_revenue` int(11) NOT NULL COMMENT &quot;&quot;, `lo_supplycost` int(11) NOT NULL COMMENT &quot;&quot;, `lo_tax` int(11) NOT NULL COMMENT &quot;&quot;, `lo_commitdate` int(11) NOT NULL COMMENT &quot;&quot;, `lo_shipmode` varchar(11) NOT NULL COMMENT &quot;&quot;) ENGINE=OLAPDUPLICATE KEY(`lo_orderkey`)COMMENT &quot;OLAP&quot;DISTRIBUTED BY HASH(`lo_orderkey`) BUCKETS 96PROPERTIES (&quot;replication_num&quot; = &quot;1&quot;,&quot;colocate_with&quot; = &quot;group1&quot;,&quot;in_memory&quot; = &quot;false&quot;,&quot;storage_format&quot; = &quot;DEFAULT&quot;);CREATE TABLE IF NOT EXISTS `customer` ( `c_custkey` int(11) NOT NULL COMMENT &quot;&quot;, `c_name` varchar(26) NOT NULL COMMENT &quot;&quot;, `c_address` varchar(41) NOT NULL COMMENT &quot;&quot;, `c_city` varchar(11) NOT NULL COMMENT &quot;&quot;, `c_nation` varchar(16) NOT NULL COMMENT &quot;&quot;, `c_region` varchar(13) NOT NULL COMMENT &quot;&quot;, `c_phone` varchar(16) NOT NULL COMMENT &quot;&quot;, `c_mktsegment` varchar(11) NOT NULL COMMENT &quot;&quot;) ENGINE=OLAPDUPLICATE KEY(`c_custkey`)COMMENT &quot;OLAP&quot;DISTRIBUTED BY HASH(`c_custkey`) BUCKETS 12PROPERTIES (&quot;replication_num&quot; = &quot;1&quot;,&quot;colocate_with&quot; = &quot;groupa2&quot;,&quot;in_memory&quot; = &quot;false&quot;,&quot;storage_format&quot; = &quot;DEFAULT&quot;);CREATE TABLE IF NOT EXISTS `dates` ( `d_datekey` int(11) NOT NULL COMMENT &quot;&quot;, `d_date` varchar(20) NOT NULL COMMENT &quot;&quot;, `d_dayofweek` varchar(10) NOT NULL COMMENT &quot;&quot;, `d_month` varchar(11) NOT NULL COMMENT &quot;&quot;, `d_year` int(11) NOT NULL COMMENT &quot;&quot;, `d_yearmonthnum` int(11) NOT NULL COMMENT &quot;&quot;, `d_yearmonth` varchar(9) NOT NULL COMMENT &quot;&quot;, `d_daynuminweek` int(11) NOT NULL COMMENT &quot;&quot;, `d_daynuminmonth` int(11) NOT NULL COMMENT &quot;&quot;, `d_daynuminyear` int(11) NOT NULL COMMENT &quot;&quot;, `d_monthnuminyear` int(11) NOT NULL COMMENT &quot;&quot;, `d_weeknuminyear` int(11) NOT NULL COMMENT &quot;&quot;, `d_sellingseason` varchar(14) NOT NULL COMMENT &quot;&quot;, `d_lastdayinweekfl` int(11) NOT NULL COMMENT &quot;&quot;, `d_lastdayinmonthfl` int(11) NOT NULL COMMENT &quot;&quot;, `d_holidayfl` int(11) NOT NULL COMMENT &quot;&quot;, `d_weekdayfl` int(11) NOT NULL COMMENT &quot;&quot;) ENGINE=OLAPDUPLICATE KEY(`d_datekey`)COMMENT &quot;OLAP&quot;DISTRIBUTED BY HASH(`d_datekey`) BUCKETS 1PROPERTIES (&quot;replication_num&quot; = &quot;1&quot;,&quot;in_memory&quot; = &quot;false&quot;,&quot;colocate_with&quot; = &quot;groupa3&quot;,&quot;storage_format&quot; = &quot;DEFAULT&quot;); CREATE TABLE IF NOT EXISTS `supplier` ( `s_suppkey` int(11) NOT NULL COMMENT &quot;&quot;, `s_name` varchar(26) NOT NULL COMMENT &quot;&quot;, `s_address` varchar(26) NOT NULL COMMENT &quot;&quot;, `s_city` varchar(11) NOT NULL COMMENT &quot;&quot;, `s_nation` varchar(16) NOT NULL COMMENT &quot;&quot;, `s_region` varchar(13) NOT NULL COMMENT &quot;&quot;, `s_phone` varchar(16) NOT NULL COMMENT &quot;&quot;) ENGINE=OLAPDUPLICATE KEY(`s_suppkey`)COMMENT &quot;OLAP&quot;DISTRIBUTED BY HASH(`s_suppkey`) BUCKETS 12PROPERTIES (&quot;replication_num&quot; = &quot;1&quot;,&quot;colocate_with&quot; = &quot;groupa4&quot;,&quot;in_memory&quot; = &quot;false&quot;,&quot;storage_format&quot; = &quot;DEFAULT&quot;);CREATE TABLE IF NOT EXISTS `part` ( `p_partkey` int(11) NOT NULL COMMENT &quot;&quot;, `p_name` varchar(23) NOT NULL COMMENT &quot;&quot;, `p_mfgr` varchar(7) NOT NULL COMMENT &quot;&quot;, `p_category` varchar(8) NOT NULL COMMENT &quot;&quot;, `p_brand` varchar(10) NOT NULL COMMENT &quot;&quot;, `p_color` varchar(12) NOT NULL COMMENT &quot;&quot;, `p_type` varchar(26) NOT NULL COMMENT &quot;&quot;, `p_size` int(11) NOT NULL COMMENT &quot;&quot;, `p_container` varchar(11) NOT NULL COMMENT &quot;&quot;) ENGINE=OLAPDUPLICATE KEY(`p_partkey`)COMMENT &quot;OLAP&quot;DISTRIBUTED BY HASH(`p_partkey`) BUCKETS 12PROPERTIES (&quot;replication_num&quot; = &quot;1&quot;,&quot;colocate_with&quot; = &quot;groupa5&quot;,&quot;in_memory&quot; = &quot;false&quot;,&quot;storage_format&quot; = &quot;DEFAULT&quot;);CREATE TABLE IF NOT EXISTS `lineorder_flat` ( `LO_ORDERKEY` int(11) NOT NULL COMMENT &quot;&quot;, `LO_ORDERDATE` date NOT NULL COMMENT &quot;&quot;, `LO_LINENUMBER` tinyint(4) NOT NULL COMMENT &quot;&quot;, `LO_CUSTKEY` int(11) NOT NULL COMMENT &quot;&quot;, `LO_PARTKEY` int(11) NOT NULL COMMENT &quot;&quot;, `LO_SUPPKEY` int(11) NOT NULL COMMENT &quot;&quot;, `LO_ORDERPRIORITY` varchar(100) NOT NULL COMMENT &quot;&quot;, `LO_SHIPPRIORITY` tinyint(4) NOT NULL COMMENT &quot;&quot;, `LO_QUANTITY` tinyint(4) NOT NULL COMMENT &quot;&quot;, `LO_EXTENDEDPRICE` int(11) NOT NULL COMMENT &quot;&quot;, `LO_ORDTOTALPRICE` int(11) NOT NULL COMMENT &quot;&quot;, `LO_DISCOUNT` tinyint(4) NOT NULL COMMENT &quot;&quot;, `LO_REVENUE` int(11) NOT NULL COMMENT &quot;&quot;, `LO_SUPPLYCOST` int(11) NOT NULL COMMENT &quot;&quot;, `LO_TAX` tinyint(4) NOT NULL COMMENT &quot;&quot;, `LO_COMMITDATE` date NOT NULL COMMENT &quot;&quot;, `LO_SHIPMODE` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_NAME` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_ADDRESS` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_CITY` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_NATION` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_REGION` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_PHONE` varchar(100) NOT NULL COMMENT &quot;&quot;, `C_MKTSEGMENT` varchar(100) NOT NULL COMMENT &quot;&quot;, `S_NAME` varchar(100) NOT NULL COMMENT &quot;&quot;, `S_ADDRESS` varchar(100) NOT NULL COMMENT &quot;&quot;, `S_CITY` varchar(100) NOT NULL COMMENT &quot;&quot;, `S_NATION` varchar(100) NOT NULL COMMENT &quot;&quot;, `S_REGION` varchar(100) NOT NULL COMMENT &quot;&quot;, `S_PHONE` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_NAME` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_MFGR` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_CATEGORY` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_BRAND` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_COLOR` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_TYPE` varchar(100) NOT NULL COMMENT &quot;&quot;, `P_SIZE` tinyint(4) NOT NULL COMMENT &quot;&quot;, `P_CONTAINER` varchar(100) NOT NULL COMMENT &quot;&quot;) ENGINE=OLAPDUPLICATE KEY(`LO_ORDERKEY`)COMMENT &quot;OLAP&quot;DISTRIBUTED BY HASH(`LO_ORDERKEY`) BUCKETS 192PROPERTIES (&quot;replication_num&quot; = &quot;1&quot;,&quot;colocate_with&quot; = &quot;groupxx1&quot;,&quot;in_memory&quot; = &quot;false&quot;,&quot;storage_format&quot; = &quot;DEFAULT&quot;); è¿æ¥ä¸€ä¸ªfeæ‰§è¡Œä»¥ä¸Šsqlå³å¯ å¯¼å…¥æ•°æ® DorisDBæµ‹è¯•ä¸­ä½¿ç”¨pythonè„šæœ¬å¯¼å…¥æ•°æ®, éœ€è¦å®‰è£…pymysqlåº“ ä½¿ç”¨Stream loadå¯¼å…¥å•è¡¨æ•°æ® 12345678910111213141516171819202122232425262728293031323334353637383940414243(myrecover) [root@bj2-mysql-rc-drill-02 output]# time bin/stream_load.sh data_dirstream load start. table: lineorder, path: data_dir/lineorder.tbl.1stream load start. table: lineorder, path: data_dir/lineorder.tbl.2stream load start. table: lineorder, path: data_dir/lineorder.tbl.3stream load start. table: lineorder, path: data_dir/lineorder.tbl.4stream load start. table: lineorder, path: data_dir/lineorder.tbl.5stream load start. table: lineorder, path: data_dir/lineorder.tbl.6stream load start. table: lineorder, path: data_dir/lineorder.tbl.7stream load start. table: lineorder, path: data_dir/lineorder.tbl.8stream load start. table: lineorder, path: data_dir/lineorder.tbl.9stream load start. table: lineorder, path: data_dir/lineorder.tbl.10...stream load success. table: lineorder, path: data_dir/lineorder.tbl.100stream load success. table: lineorder, path: data_dir/lineorder.tbl.97stream load success. table: lineorder, path: data_dir/lineorder.tbl.99stream load success. table: lineorder, path: data_dir/lineorder.tbl.93stream load success. table: lineorder, path: data_dir/lineorder.tbl.98stream load success. table: lineorder, path: data_dir/lineorder.tbl.94stream load success. table: lineorder, path: data_dir/lineorder.tbl.92stream load success. table: lineorder, path: data_dir/lineorder.tbl.95stream load success. table: lineorder, path: data_dir/lineorder.tbl.91stream load success. table: lineorder, path: data_dir/lineorder.tbl.96stream load start. table: customer, path: data_dir/customer.tblstream load success. table: customer, path: data_dir/customer.tblstream load start. table: dates, path: data_dir/dates.tblstream load success. table: dates, path: data_dir/dates.tblstream load start. table: part, path: data_dir/part.tblstream load success. table: part, path: data_dir/part.tblstream load start. table: supplier, path: data_dir/supplier.tblstream load success. table: supplier, path: data_dir/supplier.tblreal 82m31.323suser 0m6.385ssys 0m36.761s(myrecover) [root@bj2-mysql-rc-drill-02 output]# time bin/flat_insert.sh sql: ssb_flat_insert startsql: ssb_flat_insert successreal 1m36.697suser 0m0.078ssys 0m0.022s æ’å…¥æ•°æ®åˆ°å®½è¡¨lineorder_flat 1234567(myrecover) [root@bj2-mysql-rc-drill-02 output]# time bin/flat_insert.shsql: ssb_flat_insert startsql: ssb_flat_insert successreal 2m37.530suser 0m0.063ssys 0m0.023s æœ‰ä¸€ä¸ªä¸ç†è§£çš„ç°è±¡æ˜¯, flat_insert.shå·²ç»æ‰§è¡Œå®Œæ¯•, ä½†æ˜¯æŸ¥çœ‹lineorder_flatè¡¨è¡Œæ•°æ—¶, å‘ç°å…¶å€¼æ˜¯åœ¨ä¸æ–­å¢å¤§ 123456789101112131415161718192021222324mysql&gt; select count(*) from lineorder_flat;+-----------+| count(*) |+-----------+| 182256332 |+-----------+1 row in set (0.10 sec)mysql&gt; select count(*) from lineorder_flat;+-----------+| count(*) |+-----------+| 364316982 |+-----------+1 row in set (0.16 sec)mysql&gt; select count(*) from lineorder_flat;+-----------+| count(*) |+-----------+| 546669614 |+-----------+1 row in set (0.41 sec) å¯ä»¥çœ‹åˆ°DorisDBæ•°æ®å¯¼å…¥è€—æ—¶çº¦86åˆ†é’Ÿ æœ€ç»ˆæ•°æ® 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849mysql&gt; select count(*) from customer ;+----------+| count(*) |+----------+| 3000000 |+----------+1 row in set (0.02 sec)mysql&gt; select count(*) from dates ;+----------+| count(*) |+----------+| 2556 |+----------+1 row in set (0.01 sec)mysql&gt; select count(*) from lineorder ;+-----------+| count(*) |+-----------+| 600037902 |+-----------+1 row in set (0.53 sec)mysql&gt; select count(*) from lineorder_flat ;+-----------+| count(*) |+-----------+| 546669614 |+-----------+1 row in set (0.40 sec)mysql&gt; select count(*) from part ;+----------+| count(*) |+----------+| 1400000 |+----------+1 row in set (0.01 sec)mysql&gt; select count(*) from supplier ;+----------+| count(*) |+----------+| 200000 |+----------+1 row in set (0.01 sec) æ•°æ®å ç”¨ç©ºé—´1234du -sh /data/DorisDB-SE-1.12.1/be/storage/data/44G /data/DorisDB-SE-1.12.1/be/storage/data/44*3 = 132G å•è¡¨æŸ¥è¯¢æµ‹è¯•1set global parallel_fragment_exec_instance_num = 4; Q1.112345678910SELECT sum(lo_extendedprice * lo_discount) AS `revenue` FROM lineorder_flat WHERE lo_orderdate &gt;= &#x27;1993-01-01&#x27; and lo_orderdate &lt;= &#x27;1993-12-31&#x27; AND lo_discount BETWEEN 1 AND 3 AND lo_quantity &lt; 25; +----------------+| revenue |+----------------+| 44652567249651 |+----------------+1 row in set (0.35 sec)1 row in set (0.29 sec) Q1.2123456789SELECT sum(lo_extendedprice * lo_discount) AS revenue FROM lineorder_flat WHERE lo_orderdate &gt;= &#x27;1994-01-01&#x27; and lo_orderdate &lt;= &#x27;1994-01-31&#x27; AND lo_discount BETWEEN 4 AND 6 AND lo_quantity BETWEEN 26 AND 35; +---------------+| revenue |+---------------+| 9624332170119 |+---------------+1 row in set (0.27 sec)1 row in set (0.19 sec) Q1.31234567891011SELECT sum(lo_extendedprice * lo_discount) AS revenue FROM lineorder_flat WHERE weekofyear(lo_orderdate) = 6 AND lo_orderdate &gt;= &#x27;1994-01-01&#x27; and lo_orderdate &lt;= &#x27;1994-12-31&#x27; AND lo_discount BETWEEN 5 AND 7 AND lo_quantity BETWEEN 26 AND 35;+---------------+| revenue |+---------------+| 2611093671163 |+---------------+1 row in set (0.31 sec)1 row in set (0.24 sec) Q2.112345678910SELECT sum(lo_revenue), year(lo_orderdate) AS year, p_brand FROM lineorder_flat WHERE p_category = &#x27;MFGR#12&#x27; AND s_region = &#x27;AMERICA&#x27; GROUP BY year, p_brand ORDER BY year, p_brand; ...240 rows in set (0.41 sec)240 rows in set (0.37 sec) Q2.2123456789SELECT sum(lo_revenue), year(lo_orderdate) AS year, p_brand FROM lineorder_flat WHERE p_brand &gt;= &#x27;MFGR#2221&#x27; AND p_brand &lt;= &#x27;MFGR#2228&#x27; AND s_region = &#x27;ASIA&#x27; GROUP BY year, p_brand ORDER BY year, p_brand; 48 rows in set (0.78 sec)48 rows in set (0.72 sec) Q2.312345678SELECT sum(lo_revenue), year(lo_orderdate) AS year, p_brand FROM lineorder_flat WHERE p_brand = &#x27;MFGR#2239&#x27; AND s_region = &#x27;EUROPE&#x27; GROUP BY year, p_brand ORDER BY year, p_brand; 6 rows in set (0.34 sec)6 rows in set (0.28 sec) Q3.11234567SELECT c_nation, s_nation, year(lo_orderdate) AS year, sum(lo_revenue) AS revenue FROM lineorder_flat WHERE c_region = &#x27;ASIA&#x27; AND s_region = &#x27;ASIA&#x27; AND lo_orderdate &gt;= &#x27;1992-01-01&#x27; AND lo_orderdate &lt;= &#x27;1997-12-31&#x27; GROUP BY c_nation, s_nation, year ORDER BY year ASC, revenue DESC; 150 rows in set (1.56 sec)150 rows in set (0.86 sec) Q3.212345678SELECT c_city, s_city, year(lo_orderdate) AS year, sum(lo_revenue) AS revenueFROM lineorder_flat WHERE c_nation = &#x27;UNITED STATES&#x27; AND s_nation = &#x27;UNITED STATES&#x27; AND lo_orderdate &gt;= &#x27;1992-01-01&#x27; AND lo_orderdate &lt;= &#x27;1997-12-31&#x27; GROUP BY c_city, s_city, year ORDER BY year ASC, revenue DESC; 600 rows in set (1.08 sec)600 rows in set (0.79 sec) Q3.312345678SELECT c_city, s_city, year(lo_orderdate) AS year, sum(lo_revenue) AS revenue FROM lineorder_flat WHERE c_city in ( &#x27;UNITED KI1&#x27; ,&#x27;UNITED KI5&#x27;) AND s_city in ( &#x27;UNITED KI1&#x27; ,&#x27;UNITED KI5&#x27;) AND lo_orderdate &gt;= &#x27;1992-01-01&#x27; AND lo_orderdate &lt;= &#x27;1997-12-31&#x27; GROUP BY c_city, s_city, year ORDER BY year ASC, revenue DESC; 24 rows in set (0.25 sec)24 rows in set (0.29 sec) Q3.412345678SELECT c_city, s_city, year(lo_orderdate) AS year, sum(lo_revenue) AS revenue FROM lineorder_flat WHERE c_city in (&#x27;UNITED KI1&#x27;, &#x27;UNITED KI5&#x27;) AND s_city in ( &#x27;UNITED KI1&#x27;, &#x27;UNITED KI5&#x27;) AND lo_orderdate &gt;= &#x27;1997-12-01&#x27; AND lo_orderdate &lt;= &#x27;1997-12-31&#x27; GROUP BY c_city, s_city, year ORDER BY year ASC, revenue DESC; 4 rows in set (0.23 sec)4 rows in set (0.26 sec) Q4.1åœ¨DorisDBæµ‹è¯•æ–‡æ¡£ä¸­å¯¹è¯¥SQLæ‰§è¡Œå‰æ‰§è¡Œäº† 1set vectorized_engine_enable = FALSE; ä½†å®é™…å‘ç°æ‰§è¡Œä¸Šé¢è¯­å¥ååè€Œä¼šæ…¢å¾ˆå¤š 1234567SELECT year(lo_orderdate) AS year, c_nation, sum(lo_revenue - lo_supplycost) AS profit FROM lineorder_flat WHERE c_region = &#x27;AMERICA&#x27; AND s_region = &#x27;AMERICA&#x27; AND p_mfgr in ( &#x27;MFGR#1&#x27; , &#x27;MFGR#2&#x27;) GROUP BY year, c_nation ORDER BY year ASC, c_nation ASC;30 rows in set (1 min 24.46 sec)30 rows in set (1 min 25.10 sec) 12345678set vectorized_engine_enable = TRUE; SELECT year(lo_orderdate) AS year, c_nation, sum(lo_revenue - lo_supplycost) AS profit FROM lineorder_flat WHERE c_region = &#x27;AMERICA&#x27; AND s_region = &#x27;AMERICA&#x27; AND p_mfgr in ( &#x27;MFGR#1&#x27; , &#x27;MFGR#2&#x27;) GROUP BY year, c_nation ORDER BY year ASC, c_nation ASC;30 rows in set (0.87 sec)30 rows in set (0.72 sec) æˆ‘æ¯”å¯¹äº†å¼€å¯å’Œå…³é—­vectorized_engine_enableåçš„æŸ¥è¯¢ç»“æœ, å‘ç°æ˜¯ä¸€æ ·çš„, è¿™é‡Œæˆ‘å°±ä¸æ˜ç™½ä¸ºå•¥è¦è®¾ç½®vectorized_engine_enableä¸ºFalseäº† Q4.2123456789SELECT year(lo_orderdate) AS year, s_nation, p_category, sum(lo_revenue - lo_supplycost) AS profit FROM lineorder_flat WHERE c_region = &#x27;AMERICA&#x27; AND s_region = &#x27;AMERICA&#x27; AND lo_orderdate &gt;= &#x27;1997-01-01&#x27; and lo_orderdate &lt;= &#x27;1998-12-31&#x27; AND p_mfgr in ( &#x27;MFGR#1&#x27; , &#x27;MFGR#2&#x27;) GROUP BY year, s_nation, p_category ORDER BY year ASC, s_nation ASC, p_category ASC; 30 rows in set (0.72 sec)50 rows in set (0.49 sec) Q4.3123456789SELECT year(lo_orderdate) AS year, s_city, p_brand, sum(lo_revenue - lo_supplycost) AS profit FROM lineorder_flat WHERE s_nation = &#x27;UNITED STATES&#x27; AND lo_orderdate &gt;= &#x27;1997-01-01&#x27; and lo_orderdate &lt;= &#x27;1998-12-31&#x27; AND p_category = &#x27;MFGR#14&#x27; GROUP BY year, s_city, p_brand ORDER BY year ASC, s_city ASC, p_brand ASC; 400 rows in set (0.51 sec)400 rows in set (0.38 sec) å¤šè¡¨å…³è”æµ‹è¯•æ‰§è¡Œ 1set global parallel_fragment_exec_instance_num = 8; Q1.1123456select sum(lo_revenue) as revenuefrom lineorder join dates on lo_orderdate = d_datekeywhere d_year = 1993 and lo_discount between 1 and 3 and lo_quantity &lt; 25;1 row in set (0.45 sec)1 row in set (0.49 sec) Q1.2123456789select sum(lo_revenue) as revenuefrom lineorderjoin dates on lo_orderdate = d_datekeywhere d_yearmonthnum = 199401and lo_discount between 4 and 6and lo_quantity between 26 and 35;1 row in set (0.41 sec)1 row in set (0.45 sec) Q1.3123456789select sum(lo_revenue) as revenuefrom lineorderjoin dates on lo_orderdate = d_datekeywhere d_weeknuminyear = 6 and d_year = 1994and lo_discount between 5 and 7and lo_quantity between 26 and 35;1 row in set (0.51 sec)1 row in set (0.34 sec) Q2.11234567891011select sum(lo_revenue) as lo_revenue, d_year, p_brandfrom lineorderinner join dates on lo_orderdate = d_datekeyjoin part on lo_partkey = p_partkeyjoin supplier on lo_suppkey = s_suppkeywhere p_category = &#x27;MFGR#12&#x27; and s_region = &#x27;AMERICA&#x27;group by d_year, p_brandorder by d_year, p_brand;280 rows in set (1.56 sec)280 rows in set (1.60 sec) Q2.21234567891011select sum(lo_revenue) as lo_revenue, d_year, p_brandfrom lineorderjoin dates on lo_orderdate = d_datekeyjoin part on lo_partkey = p_partkeyjoin supplier on lo_suppkey = s_suppkeywhere p_brand between &#x27;MFGR#2221&#x27; and &#x27;MFGR#2228&#x27; and s_region = &#x27;ASIA&#x27;group by d_year, p_brandorder by d_year, p_brand;56 rows in set (1.69 sec)56 rows in set (1.06 sec) Q2.31234567891011select sum(lo_revenue) as lo_revenue, d_year, p_brandfrom lineorderjoin dates on lo_orderdate = d_datekeyjoin part on lo_partkey = p_partkeyjoin supplier on lo_suppkey = s_suppkeywhere p_brand = &#x27;MFGR#2239&#x27; and s_region = &#x27;EUROPE&#x27;group by d_year, p_brandorder by d_year, p_brand;7 rows in set (0.78 sec)7 rows in set (1.15 sec) Q3.11234567891011select c_nation, s_nation, d_year, sum(lo_revenue) as lo_revenuefrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeywhere c_region = &#x27;ASIA&#x27; and s_region = &#x27;ASIA&#x27;and d_year &gt;= 1992 and d_year &lt;= 1997group by c_nation, s_nation, d_yearorder by d_year asc, lo_revenue desc;150 rows in set (3.48 sec)150 rows in set (3.70 sec) Q3.2123456789101112select c_city, s_city, d_year, sum(lo_revenue) as lo_revenuefrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeywhere c_nation = &#x27;UNITED STATES&#x27; and s_nation = &#x27;UNITED STATES&#x27;and d_year &gt;= 1992 and d_year &lt;= 1997group by c_city, s_city, d_yearorder by d_year asc, lo_revenue desc;600 rows in set (1.32 sec)600 rows in set (1.85 sec) Q3.312345678910111213select c_city, s_city, d_year, sum(lo_revenue) as lo_revenuefrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeywhere (c_city=&#x27;UNITED KI1&#x27; or c_city=&#x27;UNITED KI5&#x27;)and (s_city=&#x27;UNITED KI1&#x27; or s_city=&#x27;UNITED KI5&#x27;)and d_year &gt;= 1992 and d_year &lt;= 1997group by c_city, s_city, d_yearorder by d_year asc, lo_revenue desc;24 rows in set (1.03 sec)24 rows in set (1.04 sec) Q3.4123456789101112select c_city, s_city, d_year, sum(lo_revenue) as lo_revenuefrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeywhere (c_city=&#x27;UNITED KI1&#x27; or c_city=&#x27;UNITED KI5&#x27;) and (s_city=&#x27;UNITED KI1&#x27; or s_city=&#x27;UNITED KI5&#x27;) and d_yearmonth = &#x27;Dec1997&#x27;group by c_city, s_city, d_yearorder by d_year asc, lo_revenue desc;4 rows in set (1.33 sec)4 rows in set (1.17 sec) Q4.1123456789101112select d_year, c_nation, sum(lo_revenue) - sum(lo_supplycost) as profitfrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeyjoin part on lo_partkey = p_partkeywhere c_region = &#x27;AMERICA&#x27; and s_region = &#x27;AMERICA&#x27; and (p_mfgr = &#x27;MFGR#1&#x27; or p_mfgr = &#x27;MFGR#2&#x27;)group by d_year, c_nationorder by d_year, c_nation;35 rows in set (3.48 sec)35 rows in set (3.75 sec) Q4.21234567891011121314select d_year, s_nation, p_category, sum(lo_revenue) - sum(lo_supplycost) as profitfrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeyjoin part on lo_partkey = p_partkeywhere c_region = &#x27;AMERICA&#x27;and s_region = &#x27;AMERICA&#x27;and (d_year = 1997 or d_year = 1998)and (p_mfgr = &#x27;MFGR#1&#x27; or p_mfgr = &#x27;MFGR#2&#x27;)group by d_year, s_nation, p_categoryorder by d_year, s_nation, p_category;100 rows in set (2.83 sec)100 rows in set (3.17 sec) Q4.31234567891011121314select d_year, s_city, p_brand, sum(lo_revenue) - sum(lo_supplycost) as profitfrom lineorderjoin dates on lo_orderdate = d_datekeyjoin customer on lo_custkey = c_custkeyjoin supplier on lo_suppkey = s_suppkeyjoin part on lo_partkey = p_partkeywhere c_region = &#x27;AMERICA&#x27;and s_nation = &#x27;UNITED STATES&#x27;and (d_year = 1997 or d_year = 1998)and p_category = &#x27;MFGR#14&#x27;group by d_year, s_city, p_brandorder by d_year, s_city, p_brand;800 rows in set (1.56 sec)800 rows in set (2.14 sec) ClickHouseæ„å»ºæ•°æ®123456789$ git clone https://github.com/vadimtk/ssb-dbgen.git$ cd ssb-dbgen$ make$ ./dbgen -s 100 -T c$ ./dbgen -s 100 -T l$ ./dbgen -s 100 -T p$ ./dbgen -s 100 -T s$ ./dbgen -s 100 -T d å»ºè¡¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138CREATE DATABASE ssb on cluster ck_cluster;CREATE TABLE ssb.customer_local on cluster ck_cluster( C_CUSTKEY UInt32, C_NAME String, C_ADDRESS String, C_CITY LowCardinality(String), C_NATION LowCardinality(String), C_REGION LowCardinality(String), C_PHONE String, C_MKTSEGMENT LowCardinality(String))ENGINE = ReplicatedMergeTree( &#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/customer&#x27;, &#x27;&#123;replica&#125;&#x27;) ORDER BY (C_CUSTKEY) SETTINGS index_granularity = 8192;CREATE TABLE ssb.customer on cluster ck_cluster AS ssb.customer_local ENGINE = Distributed( ck_cluster, ssb, customer_local, rand() );CREATE TABLE ssb.lineorder_local on cluster ck_cluster( LO_ORDERKEY UInt32, LO_LINENUMBER UInt8, LO_CUSTKEY UInt32, LO_PARTKEY UInt32, LO_SUPPKEY UInt32, LO_ORDERDATE Date, LO_ORDERPRIORITY LowCardinality(String), LO_SHIPPRIORITY UInt8, LO_QUANTITY UInt8, LO_EXTENDEDPRICE UInt32, LO_ORDTOTALPRICE UInt32, LO_DISCOUNT UInt8, LO_REVENUE UInt32, LO_SUPPLYCOST UInt32, LO_TAX UInt8, LO_COMMITDATE Date, LO_SHIPMODE LowCardinality(String))ENGINE = ReplicatedMergeTree( &#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/lineorder&#x27;, &#x27;&#123;replica&#125;&#x27;) PARTITION BY toYear(LO_ORDERDATE) ORDER BY (LO_ORDERDATE, LO_ORDERKEY)SETTINGS index_granularity = 8192;CREATE TABLE ssb.lineorder on cluster ck_cluster AS ssb.lineorder_local ENGINE = Distributed( ck_cluster, ssb, lineorder_local, rand() );CREATE TABLE ssb.part_local on cluster ck_cluster( P_PARTKEY UInt32, P_NAME String, P_MFGR LowCardinality(String), P_CATEGORY LowCardinality(String), P_BRAND LowCardinality(String), P_COLOR LowCardinality(String), P_TYPE LowCardinality(String), P_SIZE UInt8, P_CONTAINER LowCardinality(String))ENGINE = ReplicatedMergeTree( &#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/part&#x27;, &#x27;&#123;replica&#125;&#x27;) ORDER BY P_PARTKEY SETTINGS index_granularity = 8192;CREATE TABLE ssb.part on cluster ck_cluster AS ssb.part_local ENGINE = Distributed( ck_cluster, ssb, part_local, rand() );CREATE TABLE ssb.supplier_local on cluster ck_cluster( S_SUPPKEY UInt32, S_NAME String, S_ADDRESS String, S_CITY LowCardinality(String), S_NATION LowCardinality(String), S_REGION LowCardinality(String), S_PHONE String)ENGINE = ReplicatedMergeTree( &#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/supplier&#x27;, &#x27;&#123;replica&#125;&#x27;) ORDER BY S_SUPPKEY SETTINGS index_granularity = 8192;CREATE TABLE ssb.supplier on cluster ck_cluster AS ssb.supplier_local ENGINE = Distributed( ck_cluster, ssb, supplier_local, rand() );CREATE TABLE ssb.dates_local on cluster ck_cluster( D_DATEKEY UInt32, D_DATE String, D_DAYOFWEEK String, D_MONTH String, D_YEAR UInt32, D_YEARMONTHNUM UInt32, D_YEARMONTH String, D_DAYNUMINWEEK UInt32, D_DAYNUMINMONTH UInt32, D_DAYNUMINYEAR UInt32, D_MONTHNUMINYEAR UInt32, D_WEEKNUMINYEAR UInt32, D_SELLINGSEASON String, D_LASTDAYINWEEKFL UInt32, D_LASTDAYINMONTHFL UInt32, D_HOLIDAYFL UInt32, D_WEEKDAYFL UInt32)ENGINE = ReplicatedMergeTree( &#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/dates&#x27;, &#x27;&#123;replica&#125;&#x27;) ORDER BY D_DATEKEY SETTINGS index_granularity = 8192;CREATE TABLE ssb.dates on cluster ck_cluster AS ssb.dates_local ENGINE = Distributed( ck_cluster, ssb, dates_local, rand() ); å¯¼å…¥æ•°æ®12345678cd ssb-dbgenclickhouse-client --database=ssb --query &quot;INSERT INTO customer FORMAT CSV&quot; &lt; customer.tblclickhouse-client --database=ssb --query &quot;INSERT INTO part FORMAT CSV&quot; &lt; part.tblclickhouse-client --database=ssb --query &quot;INSERT INTO supplier FORMAT CSV&quot; &lt; supplier.tblclickhouse-client --database=ssb --query &quot;INSERT INTO lineorder FORMAT CSV&quot; &lt; lineorder.tblclickhouse-client --database=ssb --query &quot;INSERT INTO dates FORMAT CSV&quot; &lt; date.tblä»¥ä¸Šç”¨æ—¶ä¸åˆ°600s Converting â€œstar schemaâ€ to denormalized â€œflat schemaâ€:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990åœ¨ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œset max_bytes_before_external_group_by=2000000000;set max_memory_usage=4000000000;CREATE TABLE lineorder_flat_tmpENGINE = MergeTreePARTITION BY toYear(LO_ORDERDATE)ORDER BY (LO_ORDERDATE, LO_ORDERKEY) ASSELECT l.LO_ORDERKEY AS LO_ORDERKEY, l.LO_LINENUMBER AS LO_LINENUMBER, l.LO_CUSTKEY AS LO_CUSTKEY, l.LO_PARTKEY AS LO_PARTKEY, l.LO_SUPPKEY AS LO_SUPPKEY, l.LO_ORDERDATE AS LO_ORDERDATE, l.LO_ORDERPRIORITY AS LO_ORDERPRIORITY, l.LO_SHIPPRIORITY AS LO_SHIPPRIORITY, l.LO_QUANTITY AS LO_QUANTITY, l.LO_EXTENDEDPRICE AS LO_EXTENDEDPRICE, l.LO_ORDTOTALPRICE AS LO_ORDTOTALPRICE, l.LO_DISCOUNT AS LO_DISCOUNT, l.LO_REVENUE AS LO_REVENUE, l.LO_SUPPLYCOST AS LO_SUPPLYCOST, l.LO_TAX AS LO_TAX, l.LO_COMMITDATE AS LO_COMMITDATE, l.LO_SHIPMODE AS LO_SHIPMODE, c.C_NAME AS C_NAME, c.C_ADDRESS AS C_ADDRESS, c.C_CITY AS C_CITY, c.C_NATION AS C_NATION, c.C_REGION AS C_REGION, c.C_PHONE AS C_PHONE, c.C_MKTSEGMENT AS C_MKTSEGMENT, s.S_NAME AS S_NAME, s.S_ADDRESS AS S_ADDRESS, s.S_CITY AS S_CITY, s.S_NATION AS S_NATION, s.S_REGION AS S_REGION, s.S_PHONE AS S_PHONE, p.P_NAME AS P_NAME, p.P_MFGR AS P_MFGR, p.P_CATEGORY AS P_CATEGORY, p.P_BRAND AS P_BRAND, p.P_COLOR AS P_COLOR, p.P_TYPE AS P_TYPE, p.P_SIZE AS P_SIZE, p.P_CONTAINER AS P_CONTAINERFROM lineorder AS lINNER JOIN customer AS c ON c.C_CUSTKEY = l.LO_CUSTKEYINNER JOIN supplier AS s ON s.S_SUPPKEY = l.LO_SUPPKEYINNER JOIN part AS p ON p.P_PARTKEY = l.LO_PARTKEY;0 rows in set. Elapsed: 2086.025 sec. Processed 604.64 million rows, 26.12 GB (289.85 thousand rows/s., 12.52 MB/s.) bj2-all-clickhouse-test-01 :) select count(*) from lineorder_flat;SELECT count(*)FROM lineorder_flatâ”Œâ”€â”€â”€count()â”€â”â”‚ 600037902 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.006 sec. CREATE TABLE ssb.lineorder_flat_local on cluster ck_clusterAS ssb.lineorder_flat_tmpENGINE = ReplicatedMergeTree( &#x27;/clickhouse/ssb/tables/&#123;layer&#125;-&#123;shard&#125;/lineorder_flat&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY toYear(LO_ORDERDATE)ORDER BY (LO_ORDERDATE, LO_ORDERKEY)CREATE TABLE ssb.lineorder_flat on cluster ck_cluster AS ssb.lineorder_flat_local ENGINE = Distributed( ck_cluster, ssb, lineorder_flat_local, rand() ); åœ¨ä¸‰ä¸ªåˆ†ç‰‡æ‰§è¡Œ:INSERT INTO ssb.lineorder_flat SELECT * from ssb_local.lineorder_flat_tmp; Ok.0 rows in set. Elapsed: 747.548 sec. Processed 600.04 million rows, 140.40 GB (802.67 thousand rows/s., 187.82 MB/s.) clickhouseæ•°æ®å¯¼å…¥ç”¨æ—¶æ€»è®¡çº¦3500ç§’ æœ€ç»ˆæ•°æ® 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465bj2-all-clickhouse-test-01 :) select count(*) from customer ;SELECT count(*)FROM customerâ”Œâ”€count()â”€â”â”‚ 3000000 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.004 sec. bj2-all-clickhouse-test-01 :) select count(*) from dates ;SELECT count(*)FROM datesâ”Œâ”€count()â”€â”â”‚ 2556 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.004 sec. bj2-all-clickhouse-test-01 :) select count(*) from lineorder ;SELECT count(*)FROM lineorderâ”Œâ”€â”€â”€count()â”€â”â”‚ 600037902 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.003 sec. bj2-all-clickhouse-test-01 :) select count(*) from lineorder_flat ;SELECT count(*)FROM lineorder_flatâ”Œâ”€â”€â”€count()â”€â”â”‚ 622259902 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.003 sec. bj2-all-clickhouse-test-01 :) select count(*) from part ;SELECT count(*)FROM partâ”Œâ”€count()â”€â”â”‚ 1400000 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.003 sec. bj2-all-clickhouse-test-01 :) select count(*) from supplier ;SELECT count(*)FROM supplierâ”Œâ”€count()â”€â”â”‚ 200000 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.004 sec. æ•°æ®å ç”¨ç©ºé—´12345678910111213141516171819202122232425262728293031[root@bj2-all-clickhouse-test-01 ssb]# lltotal 48lrwxrwxrwx 1 root root 69 Feb 9 10:51 customer -&gt; /data/clickhouse/node1/store/a61/a61a9f88-8bbb-4864-bd0a-1001f5ffcc1clrwxrwxrwx 1 root root 69 Feb 9 10:51 customer_local -&gt; /data/clickhouse/node1/store/c86/c86c8026-f804-4f93-9a2b-051d0fbc1cc9lrwxrwxrwx 1 root root 69 Feb 9 12:55 dates -&gt; /data/clickhouse/node1/store/95d/95db2800-91b5-44f3-b378-727bc80d25bclrwxrwxrwx 1 root root 69 Feb 9 12:55 dates_local -&gt; /data/clickhouse/node1/store/137/1371f45a-88bc-4d14-9f04-07895fd561balrwxrwxrwx 1 root root 69 Feb 9 11:33 lineorder -&gt; /data/clickhouse/node1/store/8f4/8f40504f-4e94-4d70-a1de-dbcb6d25d616lrwxrwxrwx 1 root root 69 Feb 9 11:54 lineorder_flat -&gt; /data/clickhouse/node1/store/9fd/9fdb7d2c-d2c2-49a0-ad7e-380fc76dff73lrwxrwxrwx 1 root root 69 Feb 9 11:49 lineorder_flat_local -&gt; /data/clickhouse/node1/store/883/883a4a97-f34b-491b-a305-398bd717cfb9lrwxrwxrwx 1 root root 69 Feb 9 10:52 lineorder_local -&gt; /data/clickhouse/node1/store/2d6/2d67810e-dfbc-438d-b7aa-6cbfee4c391flrwxrwxrwx 1 root root 69 Feb 9 11:36 part -&gt; /data/clickhouse/node1/store/45b/45b4a779-a2df-4048-a266-efc1481fce68lrwxrwxrwx 1 root root 69 Feb 9 10:53 part_local -&gt; /data/clickhouse/node1/store/83f/83f3ac5d-296b-424f-900e-f13d67d044aelrwxrwxrwx 1 root root 69 Feb 9 11:36 supplier -&gt; /data/clickhouse/node1/store/6a0/6a0b538a-8f79-4d24-bae0-82792fe8af19lrwxrwxrwx 1 root root 69 Feb 9 10:54 supplier_local -&gt; /data/clickhouse/node1/store/5e2/5e29e02d-e35b-4660-a5b9-1bfa1d9fb97d[root@bj2-all-clickhouse-test-01 ssb]# ll |awk -F&#x27;-&gt;&#x27; &#x27;&#123;print $2&#125;&#x27;|xargs du -sh20K /data/clickhouse/node1/store/a61/a61a9f88-8bbb-4864-bd0a-1001f5ffcc1c39M /data/clickhouse/node1/store/c86/c86c8026-f804-4f93-9a2b-051d0fbc1cc920K /data/clickhouse/node1/store/95d/95db2800-91b5-44f3-b378-727bc80d25bc64K /data/clickhouse/node1/store/137/1371f45a-88bc-4d14-9f04-07895fd561ba20K /data/clickhouse/node1/store/8f4/8f40504f-4e94-4d70-a1de-dbcb6d25d61620K /data/clickhouse/node1/store/9fd/9fdb7d2c-d2c2-49a0-ad7e-380fc76dff7322G /data/clickhouse/node1/store/883/883a4a97-f34b-491b-a305-398bd717cfb96.4G /data/clickhouse/node1/store/2d6/2d67810e-dfbc-438d-b7aa-6cbfee4c391f20K /data/clickhouse/node1/store/45b/45b4a779-a2df-4048-a266-efc1481fce688.3M /data/clickhouse/node1/store/83f/83f3ac5d-296b-424f-900e-f13d67d044ae20K /data/clickhouse/node1/store/6a0/6a0b538a-8f79-4d24-bae0-82792fe8af192.6M /data/clickhouse/node1/store/5e2/5e29e02d-e35b-4660-a5b9-1bfa1d9fb97dçº¦ 28.4G*3=85.2G å•è¡¨æŸ¥è¯¢æµ‹è¯•æ‰§è¡Œ 123456789set max_threads=4;SELECT *FROM system.settingsWHERE name = &#x27;max_threads&#x27;â”Œâ”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€valueâ”€â”¬â”€changedâ”€â”¬â”€descriptionâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€minâ”€â”€â”¬â”€maxâ”€â”€â”¬â”€readonlyâ”€â”¬â”€typeâ”€â”€â”€â”€â”€â”€â”€â”â”‚ max_threads â”‚ 4 â”‚ 1 â”‚ The maximum number of threads to execute the request. By default, it is determined automatically. â”‚ á´ºáµá´¸á´¸ â”‚ á´ºáµá´¸á´¸ â”‚ 0 â”‚ MaxThreads â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Q1.112345678910SELECT sum(LO_EXTENDEDPRICE * LO_DISCOUNT) AS revenueFROM lineorder_flatWHERE (toYear(LO_ORDERDATE) = 1993) AND ((LO_DISCOUNT &gt;= 1) AND (LO_DISCOUNT &lt;= 3)) AND (LO_QUANTITY &lt; 25)â”Œâ”€â”€â”€â”€â”€â”€â”€â”€revenueâ”€â”â”‚ 46310268722641 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.226 sec. Processed 94.38 million rows, 755.01 MB (417.85 million rows/s., 3.34 GB/s.) 1 rows in set. Elapsed: 0.195 sec. Processed 94.38 million rows, 755.01 MB (484.98 million rows/s., 3.88 GB/s.) Q1.21234567891011SELECT sum(LO_EXTENDEDPRICE * LO_DISCOUNT) AS revenueFROM lineorder_flatWHERE (toYYYYMM(LO_ORDERDATE) = 199401) AND ((LO_DISCOUNT &gt;= 4) AND (LO_DISCOUNT &lt;= 6)) AND ((LO_QUANTITY &gt;= 26) AND (LO_QUANTITY &lt;= 35))â”Œâ”€â”€â”€â”€â”€â”€â”€revenueâ”€â”â”‚ 9979491062883 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.034 sec. Processed 8.07 million rows, 64.55 MB (239.67 million rows/s., 1.92 GB/s.) 1 rows in set. Elapsed: 0.063 sec. Processed 8.07 million rows, 64.55 MB (127.89 million rows/s., 1.02 GB/s.) Q1.312345678910SELECT sum(LO_EXTENDEDPRICE * LO_DISCOUNT) AS revenueFROM lineorder_flatWHERE (toISOWeek(LO_ORDERDATE) = 6) AND (toYear(LO_ORDERDATE) = 1994) AND ((LO_DISCOUNT &gt;= 5) AND (LO_DISCOUNT &lt;= 7)) AND ((LO_QUANTITY &gt;= 26) AND (LO_QUANTITY &lt;= 35))â”Œâ”€â”€â”€â”€â”€â”€â”€revenueâ”€â”â”‚ 2709633167278 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.043 sec. Processed 2.03 million rows, 16.23 MB (46.78 million rows/s., 374.26 MB/s.) 1 rows in set. Elapsed: 0.022 sec. Processed 2.03 million rows, 16.23 MB (91.09 million rows/s., 728.68 MB/s.) Q2.11234567891011121314151617SELECT sum(LO_REVENUE), toYear(LO_ORDERDATE) AS year, P_BRANDFROM lineorder_flatWHERE P_CATEGORY = &#x27;MFGR#12&#x27; AND S_REGION = &#x27;AMERICA&#x27;GROUP BY year, P_BRANDORDER BY year, P_BRAND;...280 rows in set. Elapsed: 1.723 sec. Processed 622.26 million rows, 6.42 GB (361.17 million rows/s., 3.73 GB/s.) 280 rows in set. Elapsed: 1.791 sec. Processed 622.26 million rows, 6.42 GB (347.43 million rows/s., 3.59 GB/s.) Q2.21234567891011121314151617SELECT sum(LO_REVENUE), toYear(LO_ORDERDATE) AS year, P_BRANDFROM lineorder_flatWHERE P_BRAND &gt;= &#x27;MFGR#2221&#x27; AND P_BRAND &lt;= &#x27;MFGR#2228&#x27; AND S_REGION = &#x27;ASIA&#x27;GROUP BY year, P_BRANDORDER BY year, P_BRAND;...56 rows in set. Elapsed: 1.463 sec. Processed 622.26 million rows, 5.80 GB (425.29 million rows/s., 3.96 GB/s.) 56 rows in set. Elapsed: 1.470 sec. Processed 622.26 million rows, 5.80 GB (423.20 million rows/s., 3.94 GB/s.) Q2.312345678910111213141516171819202122232425SELECT sum(LO_REVENUE), toYear(LO_ORDERDATE) AS year, P_BRANDFROM lineorder_flatWHERE (P_BRAND = &#x27;MFGR#2239&#x27;) AND (S_REGION = &#x27;EUROPE&#x27;)GROUP BY year, P_BRANDORDER BY year ASC, P_BRAND ASCâ”Œâ”€sum(LO_REVENUE)â”€â”¬â”€yearâ”€â”¬â”€P_BRANDâ”€â”€â”€â”â”‚ 68153063027 â”‚ 1992 â”‚ MFGR#2239 â”‚â”‚ 67009399598 â”‚ 1993 â”‚ MFGR#2239 â”‚â”‚ 67185675813 â”‚ 1994 â”‚ MFGR#2239 â”‚â”‚ 67988181065 â”‚ 1995 â”‚ MFGR#2239 â”‚â”‚ 67265572303 â”‚ 1996 â”‚ MFGR#2239 â”‚â”‚ 66922128523 â”‚ 1997 â”‚ MFGR#2239 â”‚â”‚ 38630664245 â”‚ 1998 â”‚ MFGR#2239 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜7 rows in set. Elapsed: 0.659 sec. Processed 622.26 million rows, 5.80 GB (943.74 million rows/s., 8.79 GB/s.) 7 rows in set. Elapsed: 1.337 sec. Processed 622.26 million rows, 5.80 GB (465.51 million rows/s., 4.34 GB/s.) Q3.112345678910111213141516171819SELECT C_NATION, S_NATION, toYear(LO_ORDERDATE) AS year, sum(LO_REVENUE) AS revenueFROM lineorder_flatWHERE C_REGION = &#x27;ASIA&#x27; AND S_REGION = &#x27;ASIA&#x27; AND year &gt;= 1992 AND year &lt;= 1997GROUP BY C_NATION, S_NATION, yearORDER BY year ASC, revenue DESC;...150 rows in set. Elapsed: 2.488 sec. Processed 566.91 million rows, 5.68 GB (227.84 million rows/s., 2.28 GB/s.) 150 rows in set. Elapsed: 1.254 sec. Processed 566.91 million rows, 5.68 GB (452.10 million rows/s., 4.53 GB/s.) Q3.212345678910111213141516171819SELECT C_CITY, S_CITY, toYear(LO_ORDERDATE) AS year, sum(LO_REVENUE) AS revenueFROM lineorder_flatWHERE C_NATION = &#x27;UNITED STATES&#x27; AND S_NATION = &#x27;UNITED STATES&#x27; AND year &gt;= 1992 AND year &lt;= 1997GROUP BY C_CITY, S_CITY, yearORDER BY year ASC, revenue DESC;...600 rows in set. Elapsed: 1.272 sec. Processed 566.91 million rows, 5.77 GB (445.80 million rows/s., 4.54 GB/s.) 600 rows in set. Elapsed: 0.966 sec. Processed 566.91 million rows, 5.77 GB (587.07 million rows/s., 5.98 GB/s.) Q3.312345678910111213141516171819SELECT C_CITY, S_CITY, toYear(LO_ORDERDATE) AS year, sum(LO_REVENUE) AS revenueFROM lineorder_flatWHERE ((C_CITY = &#x27;UNITED KI1&#x27;) OR (C_CITY = &#x27;UNITED KI5&#x27;)) AND ((S_CITY = &#x27;UNITED KI1&#x27;) OR (S_CITY = &#x27;UNITED KI5&#x27;)) AND (year &gt;= 1992) AND (year &lt;= 1997)GROUP BY C_CITY, S_CITY, yearORDER BY year ASC, revenue DESC...24 rows in set. Elapsed: 0.979 sec. Processed 566.91 million rows, 4.63 GB (579.03 million rows/s., 4.73 GB/s.)24 rows in set. Elapsed: 0.889 sec. Processed 566.91 million rows, 4.63 GB (637.83 million rows/s., 5.21 GB/s.) Q3.4123456789101112131415161718192021222324SELECT C_CITY, S_CITY, toYear(LO_ORDERDATE) AS year, sum(LO_REVENUE) AS revenueFROM lineorder_flatWHERE ((C_CITY = &#x27;UNITED KI1&#x27;) OR (C_CITY = &#x27;UNITED KI5&#x27;)) AND ((S_CITY = &#x27;UNITED KI1&#x27;) OR (S_CITY = &#x27;UNITED KI5&#x27;)) AND (toYYYYMM(LO_ORDERDATE) = 199712)GROUP BY C_CITY, S_CITY, yearORDER BY year ASC, revenue DESCâ”Œâ”€C_CITYâ”€â”€â”€â”€â”€â”¬â”€S_CITYâ”€â”€â”€â”€â”€â”¬â”€yearâ”€â”¬â”€â”€â”€revenueâ”€â”â”‚ UNITED KI1 â”‚ UNITED KI1 â”‚ 1997 â”‚ 495955110 â”‚â”‚ UNITED KI5 â”‚ UNITED KI5 â”‚ 1997 â”‚ 421714882 â”‚â”‚ UNITED KI5 â”‚ UNITED KI1 â”‚ 1997 â”‚ 387387637 â”‚â”‚ UNITED KI1 â”‚ UNITED KI5 â”‚ 1997 â”‚ 380708672 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜4 rows in set. Elapsed: 0.036 sec. Processed 8.09 million rows, 66.07 MB (221.65 million rows/s., 1.81 GB/s.) 4 rows in set. Elapsed: 0.020 sec. Processed 8.09 million rows, 66.07 MB (402.92 million rows/s., 3.29 GB/s.) Q4.11234567891011121314151617SELECT toYear(LO_ORDERDATE) AS year, C_NATION, sum(LO_REVENUE - LO_SUPPLYCOST) AS profitFROM lineorder_flatWHERE (C_REGION = &#x27;AMERICA&#x27;) AND (S_REGION = &#x27;AMERICA&#x27;) AND ((P_MFGR = &#x27;MFGR#1&#x27;) OR (P_MFGR = &#x27;MFGR#2&#x27;))GROUP BY year, C_NATIONORDER BY year ASC, C_NATION ASC...35 rows in set. Elapsed: 5.067 sec. Processed 622.26 million rows, 8.72 GB (122.80 million rows/s., 1.72 GB/s.) 35 rows in set. Elapsed: 2.791 sec. Processed 622.26 million rows, 8.72 GB (222.97 million rows/s., 3.12 GB/s.) Q4.2123456789101112131415161718192021SELECT toYear(LO_ORDERDATE) AS year, S_NATION, P_CATEGORY, sum(LO_REVENUE - LO_SUPPLYCOST) AS profitFROM lineorder_flatWHERE C_REGION = &#x27;AMERICA&#x27; AND S_REGION = &#x27;AMERICA&#x27; AND (year = 1997 OR year = 1998) AND (P_MFGR = &#x27;MFGR#1&#x27; OR P_MFGR = &#x27;MFGR#2&#x27;)GROUP BY year, S_NATION, P_CATEGORYORDER BY year ASC, S_NATION ASC, P_CATEGORY ASC;...100 rows in set. Elapsed: 0.804 sec. Processed 149.77 million rows, 2.25 GB (186.21 million rows/s., 2.80 GB/s.) 100 rows in set. Elapsed: 0.752 sec. Processed 149.77 million rows, 2.25 GB (199.13 million rows/s., 2.99 GB/s.) Q4.31234567891011121314151617181920SELECT toYear(LO_ORDERDATE) AS year, S_CITY, P_BRAND, sum(LO_REVENUE - LO_SUPPLYCOST) AS profitFROM lineorder_flatWHERE S_NATION = &#x27;UNITED STATES&#x27; AND (year = 1997 OR year = 1998) AND P_CATEGORY = &#x27;MFGR#14&#x27;GROUP BY year, S_CITY, P_BRANDORDER BY year ASC, S_CITY ASC, P_BRAND ASC;...800 rows in set. Elapsed: 0.561 sec. Processed 149.77 million rows, 2.32 GB (266.84 million rows/s., 4.13 GB/s.) 800 rows in set. Elapsed: 0.483 sec. Processed 149.77 million rows, 2.32 GB (309.80 million rows/s., 4.80 GB/s.) å¤šè¡¨å…³è”æµ‹è¯•åœ¨DorisDB vs Clickhouse SSBæ€§èƒ½æµ‹è¯•å¯¹æ¯”æŠ¥å‘Š, ä¸çŸ¥é“æ˜¯ä¸æ˜¯ç–æ¼äº†, Dorisåœ¨æµ‹è¯•æ—¶è®¾ç½®äº†1set global parallel_fragment_exec_instance_num = 8;ä½†æ²¡æœ‰å†™æœ‰æ²¡æœ‰åœ¨clickhouseæµ‹è¯•æ—¶è®¾ç½®SETTINGS max_threads=8;ç”±äºæˆ‘çš„ç¯å¢ƒåªæœ‰å››ä¸ª4 cpu, æ‰€ä»¥æˆ‘è¿™é‡Œè®¾ç½®ä¸º4.é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯çŸ¥, lineorderæ¯ä¸ªåˆ†ç‰‡æ•°æ®æ–‡ä»¶å¤§æ¦‚6.4G(å‹ç¼©å), æˆ‘çš„ç¯å¢ƒå†…å­˜åªæœ‰8G, ä¸ç¡®å®šèƒ½å¦éƒ½ç¼“å­˜äº† è¿™é‡Œè¿˜éœ€è¦æ³¨æ„ä¸¤ä¸ªé—®é¢˜: clickhouseåˆ†å¸ƒå¼è¡¨ç›¸æ¯”å•è¡¨å…³è”æ›´åŠ ä¸å‹å¥½, JOINè¦æ”¹ä¸ºGLOBAL JOIN JOINæ“ä½œæ—¶ä¸€å®šè¦æŠŠæ•°æ®é‡å°çš„è¡¨æ”¾åœ¨å³è¾¹(è¿™ä¼šå¯¼è‡´SQLæ”¹å†™æ›´åŠ éº»çƒ¦) è¯¦è§ClickHouseæŸ¥è¯¢åˆ†å¸ƒå¼è¡¨LEFT JOINæ”¹RIGHT JOINçš„å¤§å‘ æ‰€ä»¥æˆ‘å¯¹DorisDB vs Clickhouse SSBæ€§èƒ½æµ‹è¯•å¯¹æ¯”æŠ¥å‘Šä¸­çš„å¤šè¡¨å…³è”æµ‹è¯•SQLè¿›è¡Œäº†å¾®è°ƒ Q1.1123456789101112SELECT SUM(LO_REVENUE) AS REVENUEFROM lineorderGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (D_YEAR = 1993) AND ((LO_DISCOUNT &gt;= 1) AND (LO_DISCOUNT &lt;= 3)) AND (LO_QUANTITY &lt; 25)SETTINGS max_threads = 4â”Œâ”€â”€â”€â”€â”€â”€â”€â”€REVENUEâ”€â”â”‚ 21881848590256 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 1.496 sec. Processed 600.04 million rows, 4.80 GB (401.10 million rows/s., 3.21 GB/s.) 1 rows in set. Elapsed: 1.424 sec. Processed 600.04 million rows, 4.80 GB (421.33 million rows/s., 3.37 GB/s.) Q1.2123456789101112SELECT SUM(LO_REVENUE) AS REVENUEFROM lineorderGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (D_YEARMONTHNUM = 199401) AND ((LO_DISCOUNT &gt;= 4) AND (LO_DISCOUNT &lt;= 6)) AND ((LO_QUANTITY &gt;= 26) AND (LO_QUANTITY &lt;= 35))SETTINGS max_threads = 4â”Œâ”€â”€â”€â”€â”€â”€â”€REVENUEâ”€â”â”‚ 1829705342413 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 1.366 sec. Processed 600.04 million rows, 4.80 GB (439.39 million rows/s., 3.52 GB/s.) 1 rows in set. Elapsed: 0.659 sec. Processed 600.04 million rows, 4.80 GB (910.87 million rows/s., 7.29 GB/s.) Q1.3123456789101112SELECT SUM(LO_REVENUE) AS REVENUEFROM lineorderGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (D_WEEKNUMINYEAR = 6) AND (D_YEAR = 1994) AND ((LO_DISCOUNT &gt;= 5) AND (LO_DISCOUNT &lt;= 7)) AND ((LO_QUANTITY &gt;= 26) AND (LO_QUANTITY &lt;= 35))SETTINGS max_threads = 4â”Œâ”€â”€â”€â”€â”€â”€REVENUEâ”€â”â”‚ 407995993835 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.678 sec. Processed 600.04 million rows, 4.80 GB (885.40 million rows/s., 7.08 GB/s.) 1 rows in set. Elapsed: 1.377 sec. Processed 600.04 million rows, 4.80 GB (435.84 million rows/s., 3.49 GB/s.) Q2.11234567891011121314SELECT SUM(LO_REVENUE) AS LO_REVENUE, D_YEAR, P_BRANDFROM lineorderGLOBAL JOIN part ON LO_PARTKEY = P_PARTKEYGLOBAL JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),&#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE P_CATEGORY = &#x27;MFGR#12&#x27; AND S_REGION = &#x27;AMERICA&#x27;GROUP BY D_YEAR, P_BRANDORDER BY D_YEAR, P_BRANDSETTINGS max_threads = 4;...280 rows in set. Elapsed: 4.367 sec. Processed 601.81 million rows, 8.45 GB (137.81 million rows/s., 1.94 GB/s.) 280 rows in set. Elapsed: 2.667 sec. Processed 601.81 million rows, 8.45 GB (225.69 million rows/s., 3.17 GB/s.) Q2.21234567891011121314SELECT SUM(LO_REVENUE) AS LO_REVENUE, D_YEAR, P_BRANDFROM lineorderGLOBAL JOIN part ON LO_PARTKEY = P_PARTKEYGLOBAL JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),&#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE P_BRAND BETWEEN &#x27;MFGR#2221&#x27; AND &#x27;MFGR#2228&#x27; AND S_REGION = &#x27;ASIA&#x27;GROUP BY D_YEAR, P_BRANDORDER BY D_YEAR, P_BRANDSETTINGS max_threads = 4;...56 rows in set. Elapsed: 4.498 sec. Processed 601.67 million rows, 8.45 GB (133.78 million rows/s., 1.88 GB/s.) 56 rows in set. Elapsed: 1.554 sec. Processed 601.67 million rows, 8.45 GB (387.23 million rows/s., 5.44 GB/s.) Q2.3123456789101112131415161718192021222324252627282930SELECT SUM(LO_REVENUE) AS LO_REVENUE, D_YEAR, P_BRANDFROM lineorderGLOBAL INNER JOIN part ON LO_PARTKEY = P_PARTKEYGLOBAL INNER JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (P_BRAND = &#x27;MFGR#2239&#x27;) AND (S_REGION = &#x27;EUROPE&#x27;)GROUP BY D_YEAR, P_BRANDORDER BY D_YEAR ASC, P_BRAND ASCSETTINGS max_threads = 4â”Œâ”€â”€LO_REVENUEâ”€â”¬â”€D_YEARâ”€â”¬â”€P_BRANDâ”€â”€â”€â”â”‚ 65751589723 â”‚ 1992 â”‚ MFGR#2239 â”‚â”‚ 64532844801 â”‚ 1993 â”‚ MFGR#2239 â”‚â”‚ 64722599002 â”‚ 1994 â”‚ MFGR#2239 â”‚â”‚ 65616432683 â”‚ 1995 â”‚ MFGR#2239 â”‚â”‚ 64802884686 â”‚ 1996 â”‚ MFGR#2239 â”‚â”‚ 64485541165 â”‚ 1997 â”‚ MFGR#2239 â”‚â”‚ 37276536361 â”‚ 1998 â”‚ MFGR#2239 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜7 rows in set. Elapsed: 2.569 sec. Processed 601.64 million rows, 8.45 GB (234.18 million rows/s., 3.29 GB/s.) 7 rows in set. Elapsed: 2.577 sec. Processed 601.64 million rows, 8.45 GB (233.47 million rows/s., 3.28 GB/s.) Q3.1123456789101112131415SELECT C_NATION, S_NATION, D_YEAR, SUM(LO_REVENUE) AS LO_REVENUEFROM lineorderGLOBAL JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),&#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE C_REGION = &#x27;ASIA&#x27; AND S_REGION = &#x27;ASIA&#x27;AND D_YEAR &gt;= 1992 AND D_YEAR &lt;= 1997GROUP BY C_NATION, S_NATION, D_YEARORDER BY D_YEAR ASC, LO_REVENUE DESCSETTINGS max_threads = 4;...150 rows in set. Elapsed: 10.190 sec. Processed 605.04 million rows, 8.66 GB (59.38 million rows/s., 850.20 MB/s.) 150 rows in set. Elapsed: 12.960 sec. Processed 605.04 million rows, 8.66 GB (46.69 million rows/s., 668.51 MB/s.) Q3.2123456789101112131415SELECT C_CITY, S_CITY, D_YEAR, SUM(LO_REVENUE) AS LO_REVENUEFROM lineorderGLOBAL JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY),&#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE C_NATION = &#x27;UNITED STATES&#x27; AND S_NATION = &#x27;UNITED STATES&#x27;AND D_YEAR &gt;= 1992 AND D_YEAR &lt;= 1997GROUP BY C_CITY, S_CITY, D_YEARORDER BY D_YEAR ASC, LO_REVENUE DESCSETTINGS max_threads = 4;...600 rows in set. Elapsed: 5.926 sec. Processed 603.60 million rows, 8.66 GB (101.85 million rows/s., 1.46 GB/s.) 600 rows in set. Elapsed: 5.743 sec. Processed 603.60 million rows, 8.66 GB (105.10 million rows/s., 1.51 GB/s.) Q3.31234567891011121314151617181920212223SELECT C_CITY, S_CITY, D_YEAR, SUM(LO_REVENUE) AS LO_REVENUEFROM lineorderGLOBAL INNER JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL INNER JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE ((C_CITY = &#x27;UNITED KI1&#x27;) OR (C_CITY = &#x27;UNITED KI5&#x27;)) AND ((S_CITY = &#x27;UNITED KI1&#x27;) OR (S_CITY = &#x27;UNITED KI5&#x27;)) AND (D_YEAR &gt;= 1992) AND (D_YEAR &lt;= 1997)GROUP BY C_CITY, S_CITY, D_YEARORDER BY D_YEAR ASC, LO_REVENUE DESCSETTINGS max_threads = 4...24 rows in set. Elapsed: 3.445 sec. Processed 603.31 million rows, 8.65 GB (175.11 million rows/s., 2.51 GB/s.) 24 rows in set. Elapsed: 3.300 sec. Processed 603.31 million rows, 8.65 GB (182.79 million rows/s., 2.62 GB/s.) Q3.41234567891011121314151617181920212223242526272829SELECT C_CITY, S_CITY, D_YEAR, SUM(LO_REVENUE) AS LO_REVENUEFROM lineorderGLOBAL INNER JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL INNER JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE ((C_CITY = &#x27;UNITED KI1&#x27;) OR (C_CITY = &#x27;UNITED KI5&#x27;)) AND ((S_CITY = &#x27;UNITED KI1&#x27;) OR (S_CITY = &#x27;UNITED KI5&#x27;)) AND (D_YEARMONTH = &#x27;Dec1997&#x27;)GROUP BY C_CITY, S_CITY, D_YEARORDER BY D_YEAR ASC, LO_REVENUE DESCSETTINGS max_threads = 4â”Œâ”€C_CITYâ”€â”€â”€â”€â”€â”¬â”€S_CITYâ”€â”€â”€â”€â”€â”¬â”€D_YEARâ”€â”¬â”€LO_REVENUEâ”€â”â”‚ UNITED KI1 â”‚ UNITED KI1 â”‚ 1997 â”‚ 481119563 â”‚â”‚ UNITED KI5 â”‚ UNITED KI5 â”‚ 1997 â”‚ 386477033 â”‚â”‚ UNITED KI5 â”‚ UNITED KI1 â”‚ 1997 â”‚ 378048353 â”‚â”‚ UNITED KI1 â”‚ UNITED KI5 â”‚ 1997 â”‚ 366630529 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜4 rows in set. Elapsed: 3.455 sec. Processed 603.31 million rows, 8.65 GB (174.63 million rows/s., 2.50 GB/s.) 4 rows in set. Elapsed: 3.330 sec. Processed 603.31 million rows, 8.65 GB (181.19 million rows/s., 2.60 GB/s. Q4.112345678910111213141516171819202122SELECT D_YEAR, C_NATION, SUM(LO_REVENUE) - SUM(LO_SUPPLYCOST) AS PROFITFROM lineorderGLOBAL INNER JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL INNER JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN part ON LO_PARTKEY = P_PARTKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (C_REGION = &#x27;AMERICA&#x27;) AND (S_REGION = &#x27;AMERICA&#x27;) AND ((P_MFGR = &#x27;MFGR#1&#x27;) OR (P_MFGR = &#x27;MFGR#2&#x27;))GROUP BY D_YEAR, C_NATIONORDER BY D_YEAR ASC, C_NATION ASCSETTINGS max_threads = 4...35 rows in set. Elapsed: 15.560 sec. Processed 606.44 million rows, 13.47 GB (38.97 million rows/s., 865.71 MB/s.) 35 rows in set. Elapsed: 9.494 sec. Processed 606.44 million rows, 13.47 GB (63.88 million rows/s., 1.42 GB/s.) Q4.212345678910111213141516171819202122232425SELECT D_YEAR, S_NATION, P_CATEGORY, SUM(LO_REVENUE) - SUM(LO_SUPPLYCOST) AS PROFITFROM lineorderGLOBAL INNER JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL INNER JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN part ON LO_PARTKEY = P_PARTKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (C_REGION = &#x27;AMERICA&#x27;) AND (S_REGION = &#x27;AMERICA&#x27;) AND ((D_YEAR = 1997) OR (D_YEAR = 1998)) AND ((P_MFGR = &#x27;MFGR#1&#x27;) OR (P_MFGR = &#x27;MFGR#2&#x27;))GROUP BY D_YEAR, S_NATION, P_CATEGORYORDER BY D_YEAR ASC, S_NATION ASC, P_CATEGORY ASCSETTINGS max_threads = 4...100 rows in set. Elapsed: 16.109 sec. Processed 606.44 million rows, 13.47 GB (37.64 million rows/s., 836.01 MB/s.) 100 rows in set. Elapsed: 18.048 sec. Processed 606.44 million rows, 13.47 GB (33.60 million rows/s., 746.35 MB/s.) Q4.312345678910111213141516171819202122232425SELECT D_YEAR, S_CITY, P_BRAND, SUM(LO_REVENUE) - SUM(LO_SUPPLYCOST) AS PROFITFROM lineorderGLOBAL INNER JOIN customer ON LO_CUSTKEY = C_CUSTKEYGLOBAL INNER JOIN supplier ON LO_SUPPKEY = S_SUPPKEYGLOBAL INNER JOIN part ON LO_PARTKEY = P_PARTKEYGLOBAL INNER JOIN dates ON LO_ORDERDATE = toDate(replaceRegexpAll(toString(D_DATEKEY), &#x27;(\\\\d&#123;4&#125;)(\\\\d&#123;2&#125;)(\\\\d&#123;2&#125;)&#x27;, &#x27;\\\\1-\\\\2-\\\\3&#x27;))WHERE (C_REGION = &#x27;AMERICA&#x27;) AND (S_NATION = &#x27;UNITED STATES&#x27;) AND ((D_YEAR = 1997) OR (D_YEAR = 1998)) AND (P_CATEGORY = &#x27;MFGR#14&#x27;)GROUP BY D_YEAR, S_CITY, P_BRANDORDER BY D_YEAR ASC, S_CITY ASC, P_BRAND ASCSETTINGS max_threads = 4...800 rows in set. Elapsed: 15.685 sec. Processed 606.44 million rows, 13.47 GB (38.66 million rows/s., 858.94 MB/s.) 800 rows in set. Elapsed: 14.838 sec. Processed 606.44 million rows, 13.47 GB (40.87 million rows/s., 907.94 MB/s.)","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"},{"name":"DorisDB","slug":"DorisDB","permalink":"http://fuxkdb.com/tags/DorisDB/"}]},{"title":"MHA Failoveræµ‹è¯•","slug":"2021-02-07-MHA-Failoveræµ‹è¯•","date":"2021-02-07T14:16:00.000Z","updated":"2021-02-07T14:18:21.289Z","comments":true,"path":"2021/02/07/2021-02-07-MHA-Failoveræµ‹è¯•/","link":"","permalink":"http://fuxkdb.com/2021/02/07/2021-02-07-MHA-Failover%E6%B5%8B%E8%AF%95/","excerpt":"TL;DR ç”¨ä¾‹ ping_type=CONNECT ping_type=INSERT master too many connection ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover master hang ä¸ä¼šè§¦å‘failover ä¼šè§¦å‘failoverä¸”æˆåŠŸ ä»…manageræ— æ³•è¿é€šmaster ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, ä¸”æ— æ³•ssh slave1 ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, ä¸”æ— æ³•ssh slave1å’Œslave2 ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, sshåˆ°slave1åæ— æ³•è¿é€šmaster ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, sshåˆ°slave1å’Œslave2åå‡æ— æ³•è¿é€šmaster ä¼šè§¦å‘failoverä¸”æˆåŠŸ ä¼šè§¦å‘failoverä¸”æˆåŠŸ(é•¿è¿æ¥æ–­å¼€åæ‰ä¼š) masterå®•æœºå‰slave1ä¹Ÿå®•æœºäº† ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 io_thread stopäº† ä¼šfailoverä¸”æˆåŠŸ ä¼šfailoverä¸”æˆåŠŸ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 io_thread erroräº† ä¼šfailoverä¸”æˆåŠŸ ä¼šfailoverä¸”æˆåŠŸ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 sql_thread stopäº† ä¼šfailoverä¸”æˆåŠŸ ä¼šfailoverä¸”æˆåŠŸ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 sql_thread erroräº† ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥","text":"TL;DR ç”¨ä¾‹ ping_type=CONNECT ping_type=INSERT master too many connection ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover master hang ä¸ä¼šè§¦å‘failover ä¼šè§¦å‘failoverä¸”æˆåŠŸ ä»…manageræ— æ³•è¿é€šmaster ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, ä¸”æ— æ³•ssh slave1 ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, ä¸”æ— æ³•ssh slave1å’Œslave2 ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, sshåˆ°slave1åæ— æ³•è¿é€šmaster ä¸ä¼šè§¦å‘failover ä¸ä¼šè§¦å‘failover manageræ— æ³•è¿é€šmaster, sshåˆ°slave1å’Œslave2åå‡æ— æ³•è¿é€šmaster ä¼šè§¦å‘failoverä¸”æˆåŠŸ ä¼šè§¦å‘failoverä¸”æˆåŠŸ(é•¿è¿æ¥æ–­å¼€åæ‰ä¼š) masterå®•æœºå‰slave1ä¹Ÿå®•æœºäº† ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 io_thread stopäº† ä¼šfailoverä¸”æˆåŠŸ ä¼šfailoverä¸”æˆåŠŸ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 io_thread erroräº† ä¼šfailoverä¸”æˆåŠŸ ä¼šfailoverä¸”æˆåŠŸ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 sql_thread stopäº† ä¼šfailoverä¸”æˆåŠŸ ä¼šfailoverä¸”æˆåŠŸ masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 sql_thread erroräº† ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥ ç¯å¢ƒä¿¡æ¯1234master: 172.16.120.10 centos-1 ä¸» + proxysqlslave1: 172.16.120.11 centos-2 ä» + proxysqlslave2: 172.16.120.12 centos-3 ä» + proxysql172.16.120.13 centos-4 mha manager MHAé…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960#cat /etc/masterha/conf/masterha_default.cnf [server default]# mysql user and passwordï¼Œæ­¤å¤„çš„å¯†ç ä¸èƒ½åŠ å¼•å·user=mhapassword=xxxx#replication_userrepl_user=replerrepl_password=xxxx#checking master every 3 second ping_interval=3# ä½¿ç”¨çŸ­è¿æ¥æ£€æµ‹ï¼Œé»˜è®¤æ˜¯é•¿è¿æ¥ping_type=INSERT#ping_type=CONNECT#ä¸‹é¢ä¼šæµ‹è¯•ä¸¤ç§type#ssh userssh_user=root#å‘é€é‚®ä»¶è„šæœ¬report_script=/etc/masterha/scripts/send_report# èŠ‚ç‚¹å·¥ä½œç›®å½•remote_workdir=/masterha/#cat /etc/masterha/conf/cls_new.cnf[server default]#workdir on the management servermanager_workdir=/masterha/cls_new/manager_log=/masterha/cls_new/manager.log#workdir on the node for mysql servermaster_binlog_dir=/data/mysql_3358/data/#è‡ªåŠ¨æ•…éšœVIPåˆ‡æ¢è°ƒç”¨è„šæœ¬master_ip_failover_script=/etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128#æ‰‹åŠ¨æ•…éšœåˆ‡æ¢è°ƒç”¨è„šæœ¬master_ip_online_change_script=/etc/masterha/scripts/master_ip_online_change_vip --vip=172.16.120.128#æ£€æµ‹masterçš„å¯ç”¨æ€§secondary_check_script=masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12[server1]hostname=172.16.120.10port=3358candidate_master=1[server2]hostname=172.16.120.11port=3358candidate_master=1[server3]hostname=172.16.120.12port=3358candidate_master=1 [ç”¨ä¾‹æµ‹è¯•] master too many connectionping_type=CONNECT123456789101112131415161718192021222324252627282930root@localhost 11:43:29 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 7 | | NULL | 0 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 4 | | NULL | 0 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 2 | | NULL | 0 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 14 | | NULL | 0 | 0 || 1256 | repler | 172.16.120.11:59594 | NULL | Binlog Dump GTID | 952922 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1257 | repler | 172.16.120.12:56540 | NULL | Binlog Dump GTID | 952902 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 2 | | NULL | 1 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 120 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 58 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 17 | | NULL | 1 | 0 || 1943 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+11 rows in set (0.00 sec)root@localhost 11:43:30 [dbms_monitor]&gt; show global variables like &#x27;%max_connec%&#x27;;+-----------------------+---------+| Variable_name | Value |+-----------------------+---------+| extra_max_connections | 1 || max_connect_errors | 1000000 || max_connections | 1024 |+-----------------------+---------+3 rows in set (0.01 sec)root@localhost 11:49:34 [dbms_monitor]&gt; set global max_connections=5;Query OK, 0 rows affected (0.01 sec); ç»“è®º: ä¸ä¼šfailover123456789101112131415161718192021Fri Oct 9 11:42:57 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 11:42:57 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 11:42:57 2020 - [info] OK.Fri Oct 9 11:42:57 2020 - [warning] shutdown_script is not defined.Fri Oct 9 11:42:57 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 11:42:57 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 11:42:57 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 11:42:57 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 11:49:51 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Too many connections at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.1040 (Too many connections)Fri Oct 9 11:49:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 11:49:51 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 11:49:51 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Master is reachable from 172.16.120.11!Fri Oct 9 11:49:52 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 11:49:54 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:49:54 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:49:57 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:49:57 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:50:00 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:50:00 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check.. ping_type=INSERT1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950root@localhost 11:55:13 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 1 | | NULL | 0 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 18 | | NULL | 1 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 16 | | NULL | 0 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 8 | | NULL | 0 | 0 || 1256 | repler | 172.16.120.11:59594 | NULL | Binlog Dump GTID | 953626 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1257 | repler | 172.16.120.12:56540 | NULL | Binlog Dump GTID | 953606 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 6 | | NULL | 1 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 103 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 41 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 1 | | NULL | 1 | 0 || 1943 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 2160 | mha | 172.16.120.13:34660 | NULL | Sleep | 2 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+12 rows in set (0.00 sec)root@localhost 11:55:14 [dbms_monitor]&gt; show global variables like &#x27;%max_connec%&#x27;;+-----------------------+---------+| Variable_name | Value |+-----------------------+---------+| extra_max_connections | 1 || max_connect_errors | 1000000 || max_connections | 1024 |+-----------------------+---------+3 rows in set (0.04 sec)root@localhost 11:55:19 [dbms_monitor]&gt; set global max_connections=5;Query OK, 0 rows affected (0.00 sec)root@localhost 11:55:25 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 6 | | NULL | 0 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 3 | | NULL | 0 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 31 | | NULL | 0 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 3 | | NULL | 1 | 0 || 1256 | repler | 172.16.120.11:59594 | NULL | Binlog Dump GTID | 953641 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1257 | repler | 172.16.120.12:56540 | NULL | Binlog Dump GTID | 953621 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 0 | | NULL | 0 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 118 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 56 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 6 | | NULL | 1 | 0 || 1943 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 2160 | mha | 172.16.120.13:34660 | NULL | Sleep | 2 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------+-----------+---------------+12 rows in set (0.00 sec) ping_type=INSERTæ˜¯é•¿è¿æ¥, ä¸ä¼šæ„ŸçŸ¥too many connection. æ‰‹åŠ¨killæ‰mhaè¿æ¥ 12root@localhost 11:55:29 [dbms_monitor]&gt; kill 2160;Query OK, 0 rows affected (0.01 sec) ç»“è®º: ä¸ä¼šfailover12345678910111213141516171819202122232425262728Fri Oct 9 11:54:48 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 11:54:48 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 11:54:48 2020 - [info] OK.Fri Oct 9 11:54:48 2020 - [warning] shutdown_script is not defined.Fri Oct 9 11:54:48 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 11:54:48 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 11:54:48 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 11:54:48 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 11:56:42 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Fri Oct 9 11:56:42 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 11:56:42 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 11:56:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.ERROR 1040 (HY000): Too many connectionsMonitoring server 172.16.120.11 is reachable, Master is not writable from 172.16.120.11. OK.ERROR 1040 (HY000): Too many connectionsMonitoring server 172.16.120.12 is reachable, Master is not writable from 172.16.120.12. OK.Fri Oct 9 11:56:43 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Fri Oct 9 11:56:45 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:56:45 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:56:48 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:56:48 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:56:51 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:56:51 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:56:54 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:56:54 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:56:57 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections)Fri Oct 9 11:56:57 2020 - [info] Got MySQL error 1040, but this is not a MySQL crash. Continue health check..Fri Oct 9 11:57:00 2020 - [warning] Got error on MySQL connect: 1040 (Too many connections) [ç”¨ä¾‹æµ‹è¯•] master hangping_type=CONNECTmaster hangä¸å¥½æ¨¡æ‹Ÿ, è¿™é‡Œé—´æ¥æ¨¡æ‹Ÿ. éœ€è¦å°†ping_selectçš„æ‰§è¡Œçš„select 1æ”¹ä¸ºselect innodb_tableæŸ¥è¯¢ä¸€ä¸ªinnodbè¡¨ 123456789sub ping_select($) &#123; my $self = shift; my $log = $self-&gt;&#123;logger&#125;; my $dbh = $self-&gt;&#123;dbh&#125;; my ( $query, $sth, $href ); eval &#123; $dbh-&gt;&#123;RaiseError&#125; = 1; #$sth = $dbh-&gt;prepare(&quot;SELECT 1 As Value&quot;); $sth = $dbh-&gt;prepare(&quot;SELECT 1 As Value from infra.chk_masterha limit 1&quot;); ç„¶åä¿®æ”¹innodb_thread_concurrencyå€¼ 12root@localhost 12:25:34 [dbms_monitor]&gt; set global innodb_thread_concurrency=1;Query OK, 0 rows affected (0.00 sec) æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢, æŸ¥è¯¢innodbè¡¨, è¿™æ ·mhaçš„selectä¼šè¢«é˜»å¡ 1234567891011121314151617181920212223242526272829root@localhost 12:25:45 [dbms_monitor]&gt; select sleep(600) from infra.chk_masterha limit 1;root@localhost 12:29:09 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 16 | | NULL | 1 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 4 | | NULL | 0 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 1 | | NULL | 0 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 4 | | NULL | 1 | 0 || 1256 | repler | 172.16.120.11:59594 | NULL | Binlog Dump GTID | 955662 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1257 | repler | 172.16.120.12:56540 | NULL | Binlog Dump GTID | 955642 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 11 | | NULL | 1 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 96 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 34 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 6 | | NULL | 0 | 0 || 1943 | root | localhost | dbms_monitor | Query | 21 | User sleep | select sleep(600) from infra.chk_masterha limit 1 | 0 | 0 || 2260 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 2303 | mha | 172.16.120.13:34982 | NULL | Query | 20 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 || 2305 | mha | 172.16.120.13:34988 | NULL | Query | 17 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 || 2308 | mha | 172.16.120.13:34994 | NULL | Query | 14 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 || 2310 | mha | 172.16.120.13:34998 | NULL | Query | 11 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 || 2312 | mha | 172.16.120.13:35002 | NULL | Query | 8 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 || 2314 | mha | 172.16.120.13:35006 | NULL | Query | 5 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 || 2317 | mha | 172.16.120.13:35010 | NULL | Query | 2 | Sending data | SELECT 1 As Value from infra.chk_masterha limit 1 | 0 | 0 |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+---------------------------------------------------+-----------+---------------+19 rows in set (0.00 sec) ç»“è®º: ä¸ä¼šfailover, mha managerå¯èƒ½æŠ¥é”™é€€å‡º1234567891011121314151617181920212223242526272829303132Fri Oct 9 12:28:44 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 12:28:44 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 12:28:44 2020 - [info] OK.Fri Oct 9 12:28:44 2020 - [warning] shutdown_script is not defined.Fri Oct 9 12:28:44 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 12:28:44 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 12:28:44 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 12:28:44 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 12:28:53 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:28:53 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 12:28:53 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 12:28:53 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 12:28:53 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Master is reachable from 172.16.120.11!Fri Oct 9 12:28:53 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 12:28:56 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:28:56 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 12:28:59 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:28:59 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond.....Fri Oct 9 12:30:47 2020 - [warning] Got timeout on MySQL Ping(CONNECT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:30:47 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..æ‰‹åŠ¨ctrl+cç»ˆæ­¢select sleep(600) from infra.chk_masterha limit 1å, mha manageræŠ¥é”™é€€å‡ºäº†Fri Oct 9 12:30:49 2020 - [warning] Got error when monitoring master: at /usr/local/share/perl5/MHA/MasterMonitor.pm line 489.Fri Oct 9 12:30:49 2020 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln491] Target master&#x27;s advisory lock is already held by someone. Please check whether you monitor the same master from multiple monitoring processes.Fri Oct 9 12:30:49 2020 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln511] Error happened on health checking. at /usr/local/bin/masterha_manager line 50.Fri Oct 9 12:30:49 2020 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln525] Error happened on monitoring servers.Fri Oct 9 12:30:49 2020 - [info] Got exit code 1 (Not master dead). ping_type=INSERTmaster hangä¸å¥½æ¨¡æ‹Ÿ, è¿™é‡Œé—´æ¥æ¨¡æ‹Ÿ. ä¿®æ”¹innodb_thread_concurrencyå€¼ 12root@localhost 12:25:34 [dbms_monitor]&gt; set global innodb_thread_concurrency=1;Query OK, 0 rows affected (0.00 sec) æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢, æŸ¥è¯¢innodbè¡¨, è¿™æ ·mhaçš„insertä¼šè¢«é˜»å¡ 123456789101112131415161718192021222324root@localhost 12:35:21 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 3 | | NULL | 1 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 1 | | NULL | 1 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 8 | | NULL | 0 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 1 | | NULL | 0 | 0 || 1256 | repler | 172.16.120.11:59594 | NULL | Binlog Dump GTID | 956039 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1257 | repler | 172.16.120.12:56540 | NULL | Binlog Dump GTID | 956019 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 28 | | NULL | 1 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 113 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 51 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 13 | | NULL | 0 | 0 || 1943 | root | localhost | dbms_monitor | Query | 15 | User sleep | select sleep(600) from infra.chk_masterha limit 1 | 0 | 0 || 2260 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 2395 | mha | 172.16.120.13:35206 | NULL | Query | 13 | update | INSERT INTO infra.chk_masterha values (1,unix_timestamp()) ON DUPLICATE KEY UPDATE val=unix_timestam | 0 | 0 || 2398 | mha | 172.16.120.13:35208 | NULL | Query | 11 | update | INSERT INTO infra.chk_masterha values (1,unix_timestamp()) ON DUPLICATE KEY UPDATE val=unix_timestam | 0 | 0 || 2400 | mha | 172.16.120.11:32908 | NULL | Query | 10 | update | INSERT INTO infra.chk_masterha values (1,unix_timestamp()) ON DUPLICATE KEY UPDATE val=unix_timestam | 0 | 0 || 2401 | mha | 172.16.120.13:35216 | NULL | Query | 8 | update | INSERT INTO infra.chk_masterha values (1,unix_timestamp()) ON DUPLICATE KEY UPDATE val=unix_timestam | 0 | 0 || 2403 | mha | 172.16.120.12:58066 | NULL | Query | 7 | update | INSERT INTO infra.chk_masterha values (1,unix_timestamp()) ON DUPLICATE KEY UPDATE val=unix_timestam | 0 | 0 || 2404 | mha | 172.16.120.13:35222 | NULL | Query | 5 | update | INSERT INTO infra.chk_masterha values (1,unix_timestamp()) ON DUPLICATE KEY UPDATE val=unix_timestam | 0 | 0 |+------+----------+---------------------+--------------------+------------------+--------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+-----------+---------------+18 rows in set (0.00 sec) ç»“è®º: ä¼šfailover123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229Fri Oct 9 12:35:00 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 12:35:01 2020 - [info] GTID failover mode = 1Fri Oct 9 12:35:01 2020 - [info] Dead Servers:Fri Oct 9 12:35:01 2020 - [info] Alive Servers:Fri Oct 9 12:35:01 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:01 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 12:35:01 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 12:35:01 2020 - [info] Alive Slaves:Fri Oct 9 12:35:01 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:01 2020 - [info] GTID ONFri Oct 9 12:35:01 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:01 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:01 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:01 2020 - [info] GTID ONFri Oct 9 12:35:01 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:01 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:01 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:01 2020 - [info] Checking slave configurations..Fri Oct 9 12:35:01 2020 - [info] Checking replication filtering settings..Fri Oct 9 12:35:01 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 12:35:01 2020 - [info] Replication filtering check ok.Fri Oct 9 12:35:01 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 12:35:01 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 12:35:01 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 12:35:01 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 12:35:01 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 12:35:01 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 12:35:01 2020 - [info] OK.Fri Oct 9 12:35:01 2020 - [warning] shutdown_script is not defined.Fri Oct 9 12:35:01 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 12:35:01 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 12:35:01 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 12:35:01 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 12:35:16 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:35:16 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 12:35:16 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 12:35:17 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 12:35:19 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:35:19 2020 - [warning] Connection failed 2 time(s)..Monitoring server 172.16.120.11 is reachable, Master is not writable from 172.16.120.11. OK.Fri Oct 9 12:35:22 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:35:22 2020 - [warning] Connection failed 3 time(s)..Monitoring server 172.16.120.12 is reachable, Master is not writable from 172.16.120.12. OK.Fri Oct 9 12:35:23 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Fri Oct 9 12:35:25 2020 - [warning] Got timeout on MySQL Ping(INSERT) child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.Fri Oct 9 12:35:25 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 12:35:25 2020 - [warning] Master is not reachable from health checker!Fri Oct 9 12:35:25 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Fri Oct 9 12:35:25 2020 - [warning] SSH is reachable.Fri Oct 9 12:35:25 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Fri Oct 9 12:35:25 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Fri Oct 9 12:35:25 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Fri Oct 9 12:35:25 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Fri Oct 9 12:35:27 2020 - [info] GTID failover mode = 1Fri Oct 9 12:35:27 2020 - [info] Dead Servers:Fri Oct 9 12:35:27 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:27 2020 - [info] Alive Servers:Fri Oct 9 12:35:27 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 12:35:27 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 12:35:27 2020 - [info] Alive Slaves:Fri Oct 9 12:35:27 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:27 2020 - [info] GTID ONFri Oct 9 12:35:27 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:27 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:27 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:27 2020 - [info] GTID ONFri Oct 9 12:35:27 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:27 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:27 2020 - [info] Checking slave configurations..Fri Oct 9 12:35:27 2020 - [info] Checking replication filtering settings..Fri Oct 9 12:35:27 2020 - [info] Replication filtering check ok.Fri Oct 9 12:35:27 2020 - [info] Master is down!Fri Oct 9 12:35:27 2020 - [info] Terminating monitoring script.Fri Oct 9 12:35:27 2020 - [info] Got exit code 20 (Master dead).Fri Oct 9 12:35:27 2020 - [info] MHA::MasterFailover version 0.58.Fri Oct 9 12:35:27 2020 - [info] Starting master failover.Fri Oct 9 12:35:27 2020 - [info] Fri Oct 9 12:35:27 2020 - [info] * Phase 1: Configuration Check Phase..Fri Oct 9 12:35:27 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] GTID failover mode = 1Fri Oct 9 12:35:28 2020 - [info] Dead Servers:Fri Oct 9 12:35:28 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Alive Servers:Fri Oct 9 12:35:28 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 12:35:28 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 12:35:28 2020 - [info] Alive Slaves:Fri Oct 9 12:35:28 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] Starting GTID based failover.Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] ** Phase 1: Configuration Check Phase completed.Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] Forcing shutdown so that applications never connect to the current master..Fri Oct 9 12:35:28 2020 - [info] Executing master IP deactivation script:Fri Oct 9 12:35:28 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 start down vipRTNETLINK answers: Cannot assign requested addressFake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Fri Oct 9 12:35:28 2020 - [info] done.Fri Oct 9 12:35:28 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Fri Oct 9 12:35:28 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 3: Master Recovery Phase..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:827239Fri Oct 9 12:35:28 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:8822-10390Fri Oct 9 12:35:28 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Fri Oct 9 12:35:28 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:827239Fri Oct 9 12:35:28 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:8822-10390Fri Oct 9 12:35:28 2020 - [info] Oldest slaves:Fri Oct 9 12:35:28 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 3.3: Determining New Master Phase..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] Searching new master from slaves..Fri Oct 9 12:35:28 2020 - [info] Candidate masters from the configuration file:Fri Oct 9 12:35:28 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 12:35:28 2020 - [info] GTID ONFri Oct 9 12:35:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 12:35:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 12:35:28 2020 - [info] Non-candidate masters:Fri Oct 9 12:35:28 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Fri Oct 9 12:35:28 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)Fri Oct 9 12:35:28 2020 - [info] Starting master failover..Fri Oct 9 12:35:28 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.11(172.16.120.11:3358) (new master) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 3.3: New Master Recovery Phase..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] Waiting all logs to be applied.. Fri Oct 9 12:35:28 2020 - [info] done.Fri Oct 9 12:35:28 2020 - [info] Getting new master&#x27;s binlog name and position..Fri Oct 9 12:35:28 2020 - [info] mysql-bin.000008:811243Fri Oct 9 12:35:28 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.11&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Fri Oct 9 12:35:28 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 811243, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-10390,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Fri Oct 9 12:35:28 2020 - [info] Executing master IP activate script:Fri Oct 9 12:35:28 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 Fake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Fri Oct 9 12:35:28 2020 - [info] OK.Fri Oct 9 12:35:28 2020 - [info] ** Finished master recovery successfully.Fri Oct 9 12:35:28 2020 - [info] * Phase 3: Master Recovery Phase completed.Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 4: Slaves Recovery Phase..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Fri Oct 9 12:35:28 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 44798. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009123527.log if it takes time..Fri Oct 9 12:35:29 2020 - [info] Fri Oct 9 12:35:29 2020 - [info] Log messages from 172.16.120.12 ...Fri Oct 9 12:35:29 2020 - [info] Fri Oct 9 12:35:28 2020 - [info] Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..Fri Oct 9 12:35:28 2020 - [info] Executed CHANGE MASTER.Fri Oct 9 12:35:28 2020 - [info] Slave started.Fri Oct 9 12:35:28 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-10390,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.Fri Oct 9 12:35:29 2020 - [info] End of log messages from 172.16.120.12.Fri Oct 9 12:35:29 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.Fri Oct 9 12:35:29 2020 - [info] All new slave servers recovered successfully.Fri Oct 9 12:35:29 2020 - [info] Fri Oct 9 12:35:29 2020 - [info] * Phase 5: New master cleanup phase..Fri Oct 9 12:35:29 2020 - [info] Fri Oct 9 12:35:29 2020 - [info] Resetting slave info on the new master..Fri Oct 9 12:35:29 2020 - [info] 172.16.120.11: Resetting slave info succeeded.Fri Oct 9 12:35:29 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Fri Oct 9 12:35:29 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.11(172.16.120.11:3358) as a new master.172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Fri Oct 9 12:35:29 2020 - [info] Sending mail.. ä»¥ä¸‹æƒ…å†µéƒ½ä¸ä¼šfailover, å³ä¾¿æ˜¯æ‰‹åŠ¨failoveræŒ‡å®šäº† â€“master_state=dead ä¹Ÿä¸è¡Œ12345678910111213our @ALIVE_ERROR_CODES = ( 1040, # ER_CON_COUNT_ERROR -- too many connection 1042, # ER_BAD_HOST_ERROR -- Can&#x27;t get hostname for your address 1043, # ER_HANDSHAKE_ERROR -- Bad handshake 1044, # ER_DBACCESS_DENIED_ERROR -- Access denied for user &#x27;%s&#x27;@&#x27;%s&#x27; to database &#x27;%s&#x27; 1045, # ER_ACCESS_DENIED_ERROR -- Access denied for user &#x27;%s&#x27;@&#x27;%s&#x27; (using password: %s) 1129, # ER_HOST_IS_BLOCKED -- Host &#x27;%s&#x27; is blocked because of many connection errors; unblock with &#x27;mysqladmin flush-hosts&#x27; 1130, # ER_HOST_NOT_PRIVILEGED -- Host &#x27;%s&#x27; is not allowed to connect to this MySQL server 1203, # ER_TOO_MANY_USER_CONNECTIONS -- User %s already has more than &#x27;max_user_connections&#x27; active connections 1226, # ER_USER_LIMIT_REACHED -- User &#x27;%s&#x27; has exceeded the &#x27;%s&#x27; resource (current value: %ld) 1251, # ER_NOT_SUPPORTED_AUTH_MODE -- Client does not support authentication protocol requested by server; consider upgrading MySQL client 1275, # ER_SERVER_IS_IN_SECURE_AUTH_MODE -- Server is running in --secure-auth mode, but &#x27;%s&#x27;@&#x27;%s&#x27; has a password in the old format; please change the password to the new format); è¯¦è§MHA-ä¸ºä»€ä¹ˆtoo many connectionä¸ä¼šfailover? [ç”¨ä¾‹æµ‹è¯•] master ä¸ mha manageré—´ç½‘ç»œå¼‚å¸¸1 Manager &lt;â€“ ä¸é€š â€“&gt; MasterManager &lt;â€“ æ­£å¸¸ â€“&gt; S1 &lt;â€“ æ­£å¸¸ â€“&gt; masterManager &lt;â€“ æ­£å¸¸ â€“&gt; S2 &lt;â€“ æ­£å¸¸ â€“&gt; master ping_type=CONNECT1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç»“è®º: ä¸ä¼šfailover12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485Fri Oct 9 15:29:50 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 15:29:51 2020 - [info] GTID failover mode = 1Fri Oct 9 15:29:51 2020 - [info] Dead Servers:Fri Oct 9 15:29:51 2020 - [info] Alive Servers:Fri Oct 9 15:29:51 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:29:51 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 15:29:51 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:29:51 2020 - [info] Alive Slaves:Fri Oct 9 15:29:51 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:29:51 2020 - [info] GTID ONFri Oct 9 15:29:51 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:29:51 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:29:51 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:29:51 2020 - [info] GTID ONFri Oct 9 15:29:51 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:29:51 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:29:51 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:29:51 2020 - [info] Checking slave configurations..Fri Oct 9 15:29:51 2020 - [info] Checking replication filtering settings..Fri Oct 9 15:29:51 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 15:29:51 2020 - [info] Replication filtering check ok.Fri Oct 9 15:29:51 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 15:29:51 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 15:29:51 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 15:29:51 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:29:51 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 15:29:51 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 15:29:51 2020 - [info] OK.Fri Oct 9 15:29:51 2020 - [warning] shutdown_script is not defined.Fri Oct 9 15:29:51 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 15:29:51 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 15:29:51 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 15:29:51 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:32:56 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:32:56 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:32:56 2020 - [info] Executing SSH check script: exit 0Master is reachable from 172.16.120.11!Fri Oct 9 15:32:56 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 15:33:00 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:00 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:33:01 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Fri Oct 9 15:33:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:03 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:33:06 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:06 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:33:06 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:33:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:09 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:33:09 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:33:09 2020 - [info] Executing SSH check script: exit 0Master is reachable from 172.16.120.11!Fri Oct 9 15:33:09 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 15:33:12 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:12 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:33:14 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Fri Oct 9 15:33:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:15 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:33:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:18 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:33:18 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:33:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:21 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:33:21 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:33:21 2020 - [info] Executing SSH check script: exit 0Master is reachable from 172.16.120.11!Fri Oct 9 15:33:21 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 15:33:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:24 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:33:26 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Fri Oct 9 15:33:27 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:27 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:33:30 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:30 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:33:30 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:33:33 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:33:33 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:33:33 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:33:33 2020 - [info] Executing SSH check script: exit 0Master is reachable from 172.16.120.11!Fri Oct 9 15:33:34 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen. ping_type=INSERT1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP æ­¤æ—¶managerå·¥ä½œæ­£å¸¸, å› ä¸ºping_type=INSERTæ˜¯é•¿è¿æ¥. killè¿æ¥ 123456789101112131415161718192021root@localhost 15:39:31 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 4 | | NULL | 0 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 22 | | NULL | 0 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 9 | | NULL | 1 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 2 | | NULL | 1 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 19 | | NULL | 0 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 111 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 49 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 4 | | NULL | 1 | 0 || 2409 | repler | 172.16.120.11:32918 | NULL | Binlog Dump GTID | 10898 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2411 | repler | 172.16.120.12:58084 | NULL | Binlog Dump GTID | 10873 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2627 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 2836 | mha | 172.16.120.13:35810 | NULL | Sleep | 2 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+12 rows in set (0.00 sec)root@localhost 15:39:39 [dbms_monitor]&gt; kill 2836;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¸ä¼šfailover123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172Fri Oct 9 15:37:54 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 15:37:55 2020 - [info] GTID failover mode = 1Fri Oct 9 15:37:55 2020 - [info] Dead Servers:Fri Oct 9 15:37:55 2020 - [info] Alive Servers:Fri Oct 9 15:37:55 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:37:55 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 15:37:55 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:37:55 2020 - [info] Alive Slaves:Fri Oct 9 15:37:55 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:37:55 2020 - [info] GTID ONFri Oct 9 15:37:55 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:37:55 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:37:55 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:37:55 2020 - [info] GTID ONFri Oct 9 15:37:55 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:37:55 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:37:55 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:37:55 2020 - [info] Checking slave configurations..Fri Oct 9 15:37:55 2020 - [info] Checking replication filtering settings..Fri Oct 9 15:37:55 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 15:37:55 2020 - [info] Replication filtering check ok.Fri Oct 9 15:37:55 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 15:37:55 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 15:37:55 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 15:37:55 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:37:55 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 15:37:55 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 15:37:55 2020 - [info] OK.Fri Oct 9 15:37:55 2020 - [warning] shutdown_script is not defined.Fri Oct 9 15:37:55 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 15:37:55 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 15:37:55 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 15:37:55 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:39:46 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Fri Oct 9 15:39:46 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:39:46 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTMaster is reachable from 172.16.120.11!Fri Oct 9 15:39:47 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 15:39:51 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Fri Oct 9 15:39:52 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:39:52 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:39:55 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:39:55 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:39:58 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:39:58 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:39:58 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:40:01 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:40:01 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:40:01 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 15:40:01 2020 - [info] Executing SSH check script: exit 0Master is reachable from 172.16.120.11!Fri Oct 9 15:40:01 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 15:40:04 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:40:04 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:40:06 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Fri Oct 9 15:40:07 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:40:07 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:40:10 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:40:10 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:40:10 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:40:13 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:40:13 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:40:13 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:40:13 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTMaster is reachable from 172.16.120.11!Fri Oct 9 15:40:13 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 15:40:14 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:40:14 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable. [ç”¨ä¾‹æµ‹è¯•] master ä¸ mha manageré—´ç½‘ç»œå¼‚å¸¸2 Manager &lt;â€“ ä¸é€š â€“&gt; MasterManager &lt;â€“ ä¸é€š â€“&gt; S1 &lt;â€“ æ­£å¸¸ â€“&gt; masterManager &lt;â€“ æ­£å¸¸ â€“&gt; S2 &lt;â€“ æ­£å¸¸ â€“&gt; master ping_type=CONNECTslave-1 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP æ­¤æ—¶managerå·²ç»æ— æ³•è¿é€šslave-1 123456789101112#ping centos-2PING centos-2 (172.16.120.11) 56(84) bytes of data.64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.349 ms64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.651 ms^C--- centos-2 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1001msrtt min/avg/max/mdev = 0.349/0.500/0.651/0.151 ms[root@centos-4 15:48:55 /usr/local/share/perl5/MHA]#ssh centos-2^C master 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç»“è®º: ä¸ä¼šfailover12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576Fri Oct 9 15:48:03 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 15:48:05 2020 - [info] GTID failover mode = 1Fri Oct 9 15:48:05 2020 - [info] Dead Servers:Fri Oct 9 15:48:05 2020 - [info] Alive Servers:Fri Oct 9 15:48:05 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:48:05 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 15:48:05 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:48:05 2020 - [info] Alive Slaves:Fri Oct 9 15:48:05 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:48:05 2020 - [info] GTID ONFri Oct 9 15:48:05 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:48:05 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:48:05 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:48:05 2020 - [info] GTID ONFri Oct 9 15:48:05 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:48:05 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:48:05 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:48:05 2020 - [info] Checking slave configurations..Fri Oct 9 15:48:05 2020 - [info] Checking replication filtering settings..Fri Oct 9 15:48:05 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 15:48:05 2020 - [info] Replication filtering check ok.Fri Oct 9 15:48:05 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 15:48:05 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 15:48:05 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 15:48:05 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:48:05 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 15:48:05 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 15:48:05 2020 - [info] OK.Fri Oct 9 15:48:05 2020 - [warning] shutdown_script is not defined.Fri Oct 9 15:48:05 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 15:48:05 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 15:48:05 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 15:48:05 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:50:40 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:40 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:50:40 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:50:44 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:44 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:50:45 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 15:50:45 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 15:50:47 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:47 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:50:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:50 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:50:50 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:50:53 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:53 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:50:53 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:50:53 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:50:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:56 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:50:58 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 15:50:58 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 15:50:59 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:50:59 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:51:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:51:02 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:51:02 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:51:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:51:05 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:51:05 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 15:51:05 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:51:05 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:51:05 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 15:51:09 2020 - [warning] Got timeout on Secondary Check child process and killed it! at /usr/local/share/perl5/MHA/HealthCheck.pm line 435.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable! ping_type=INSERTslave-1 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP æ­¤æ—¶managerå·²ç»æ— æ³•è¿é€šslave-1 123456789101112#ping centos-2PING centos-2 (172.16.120.11) 56(84) bytes of data.64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.349 ms64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.651 ms^C--- centos-2 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1001msrtt min/avg/max/mdev = 0.349/0.500/0.651/0.151 ms[root@centos-4 15:48:55 /usr/local/share/perl5/MHA]#ssh centos-2^C master 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP å› ä¸ºping_type=INSERTæ˜¯é•¿è¿æ¥,1 æ‰€ä»¥æ­¤æ—¶æ— å¼‚å¸¸. killè¿æ¥ 123456789101112131415161718192021root@localhost 15:39:45 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 3 | | NULL | 1 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 1 | | NULL | 0 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 8 | | NULL | 1 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 11 | | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 8 | | NULL | 0 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 89 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 26 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 3 | | NULL | 0 | 0 || 2409 | repler | 172.16.120.11:32918 | NULL | Binlog Dump GTID | 11837 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2411 | repler | 172.16.120.12:58084 | NULL | Binlog Dump GTID | 11812 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2627 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 2953 | mha | 172.16.120.13:36174 | NULL | Sleep | 0 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+12 rows in set (0.00 sec)root@localhost 15:55:18 [dbms_monitor]&gt; kill 2953;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¸ä¼šfailover1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889Fri Oct 9 15:52:43 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 15:52:44 2020 - [info] GTID failover mode = 1Fri Oct 9 15:52:44 2020 - [info] Dead Servers:Fri Oct 9 15:52:44 2020 - [info] Alive Servers:Fri Oct 9 15:52:44 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:52:44 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 15:52:44 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:52:44 2020 - [info] Alive Slaves:Fri Oct 9 15:52:44 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:52:44 2020 - [info] GTID ONFri Oct 9 15:52:44 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:52:44 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:52:44 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 15:52:44 2020 - [info] GTID ONFri Oct 9 15:52:44 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:52:44 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 15:52:44 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 15:52:44 2020 - [info] Checking slave configurations..Fri Oct 9 15:52:44 2020 - [info] Checking replication filtering settings..Fri Oct 9 15:52:44 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 15:52:44 2020 - [info] Replication filtering check ok.Fri Oct 9 15:52:44 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 15:52:44 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 15:52:45 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 15:52:45 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 15:52:45 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 15:52:45 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 15:52:45 2020 - [info] OK.Fri Oct 9 15:52:45 2020 - [warning] shutdown_script is not defined.Fri Oct 9 15:52:45 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 15:52:45 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 15:52:45 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 15:52:45 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:55:24 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Fri Oct 9 15:55:24 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 15:55:24 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:55:29 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 15:55:29 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 15:55:30 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:30 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:55:33 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:33 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:55:36 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:36 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:55:36 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:55:39 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:39 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:55:39 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 15:55:39 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:55:42 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:42 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:55:44 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 15:55:44 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 15:55:45 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:45 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:55:48 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:48 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:55:48 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:55:51 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:51 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:55:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 15:55:51 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:55:54 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:54 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 15:55:56 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 15:55:56 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 15:55:57 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:55:57 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 15:56:00 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:56:00 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 15:56:00 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 15:56:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 15:56:03 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 15:56:03 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 15:56:03 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 15:56:03 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 15:56:03 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Master is reachable from 172.16.120.11!Fri Oct 9 15:56:03 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen. [ç”¨ä¾‹æµ‹è¯•] master ä¸ mha manageré—´ç½‘ç»œå¼‚å¸¸3 Manager &lt;â€“ ä¸é€š â€“&gt; MasterManager &lt;â€“ ä¸é€š â€“&gt; S1 &lt;â€“ æ­£å¸¸ â€“&gt; masterManager &lt;â€“ ä¸é€š â€“&gt; S2 &lt;â€“ æ­£å¸¸ â€“&gt; master ping_type=CONNECTslave-1, slave-2 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP 1234567891011121314151617181920212223242526#ping centos-2PING centos-2 (172.16.120.11) 56(84) bytes of data.64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.442 ms64 bytes from centos-2 (172.16.120.11): icmp_seq=2 ttl=64 time=0.441 ms^C--- centos-2 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1001msrtt min/avg/max/mdev = 0.441/0.441/0.442/0.021 ms[root@centos-4 16:44:27 /usr/local/share/perl5/MHA]#ssh centos-2 ^C[root@centos-4 16:44:30 /usr/local/share/perl5/MHA]#ping centos-3PING centos-3 (172.16.120.12) 56(84) bytes of data.64 bytes from centos-3 (172.16.120.12): icmp_seq=1 ttl=64 time=0.335 ms64 bytes from centos-3 (172.16.120.12): icmp_seq=2 ttl=64 time=0.575 ms^C--- centos-3 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 1001msrtt min/avg/max/mdev = 0.335/0.455/0.575/0.120 ms[root@centos-4 16:44:34 /usr/local/share/perl5/MHA]#ssh centos-3^C master 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç»“è®º: ä¸ä¼šfailover1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465Fri Oct 9 16:43:25 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 16:43:26 2020 - [info] GTID failover mode = 1Fri Oct 9 16:43:26 2020 - [info] Dead Servers:Fri Oct 9 16:43:26 2020 - [info] Alive Servers:Fri Oct 9 16:43:26 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:43:26 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 16:43:26 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 16:43:26 2020 - [info] Alive Slaves:Fri Oct 9 16:43:26 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 16:43:26 2020 - [info] GTID ONFri Oct 9 16:43:26 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:43:26 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 16:43:26 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 16:43:26 2020 - [info] GTID ONFri Oct 9 16:43:26 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:43:26 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 16:43:26 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:43:26 2020 - [info] Checking slave configurations..Fri Oct 9 16:43:26 2020 - [info] Checking replication filtering settings..Fri Oct 9 16:43:26 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 16:43:26 2020 - [info] Replication filtering check ok.Fri Oct 9 16:43:26 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 16:43:26 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 16:43:26 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 16:43:26 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 16:43:26 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 16:43:26 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 16:43:26 2020 - [info] OK.Fri Oct 9 16:43:26 2020 - [warning] shutdown_script is not defined.Fri Oct 9 16:43:26 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 16:43:26 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 16:43:26 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 16:43:26 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 16:45:55 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:45:55 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:45:55 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 16:45:59 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:45:59 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:46:00 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 16:46:00 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 16:46:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:46:02 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 16:46:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:46:05 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 16:46:05 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 16:46:08 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:46:08 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 16:46:08 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:46:08 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 16:46:11 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:46:11 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:46:13 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 16:46:13 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 16:46:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:46:14 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 16:46:15 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond.. ping_type=INSERTslave-1,slave-2 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP 1234567891011121314151617181920212223#ping centos-2PING centos-2 (172.16.120.11) 56(84) bytes of data.64 bytes from centos-2 (172.16.120.11): icmp_seq=1 ttl=64 time=0.352 ms^C--- centos-2 ping statistics ---1 packets transmitted, 1 received, 0% packet loss, time 0msrtt min/avg/max/mdev = 0.352/0.352/0.352/0.000 ms[root@centos-4 17:52:38 ~]#ping centos-3PING centos-3 (172.16.120.12) 56(84) bytes of data.64 bytes from centos-3 (172.16.120.12): icmp_seq=1 ttl=64 time=0.221 ms^C--- centos-3 ping statistics ---1 packets transmitted, 1 received, 0% packet loss, time 0msrtt min/avg/max/mdev = 0.221/0.221/0.221/0.000 ms[root@centos-4 17:52:41 ~]#ssh centos-2 ^C[root@centos-4 17:52:44 ~]#ssh centos-3 master 1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.11 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç”±äºping_type=INSERTæ˜¯é•¿è¿æ¥, æ‰€ä»¥æ— å¼‚å¸¸ killè¿æ¥ 123456789101112131415161718192021root@localhost 17:48:11 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 14 | | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 4 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 32 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 4 | | NULL | 1 | 0 || 2409 | repler | 172.16.120.11:32918 | NULL | Binlog Dump GTID | 18936 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2411 | repler | 172.16.120.12:58084 | NULL | Binlog Dump GTID | 18911 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 3192 | proxysql | 172.16.120.11:33786 | NULL | Sleep | 4 | | NULL | 0 | 0 || 3238 | proxysql | 172.16.120.12:59006 | NULL | Sleep | 4 | | NULL | 1 | 0 || 3245 | proxysql | 172.16.120.11:33888 | NULL | Sleep | 14 | | NULL | 0 | 0 || 3262 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 3268 | mha | 172.16.120.13:36868 | NULL | Sleep | 2 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+11 rows in set (0.00 sec)root@localhost 17:53:37 [dbms_monitor]&gt; kill 3268;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¸ä¼šfailover12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879Fri Oct 9 17:50:48 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 17:50:49 2020 - [info] GTID failover mode = 1Fri Oct 9 17:50:49 2020 - [info] Dead Servers:Fri Oct 9 17:50:49 2020 - [info] Alive Servers:Fri Oct 9 17:50:49 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 17:50:49 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 17:50:49 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 17:50:49 2020 - [info] Alive Slaves:Fri Oct 9 17:50:49 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 17:50:49 2020 - [info] GTID ONFri Oct 9 17:50:49 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 17:50:49 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 17:50:49 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 17:50:49 2020 - [info] GTID ONFri Oct 9 17:50:49 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 17:50:49 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 17:50:49 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 17:50:49 2020 - [info] Checking slave configurations..Fri Oct 9 17:50:49 2020 - [info] Checking replication filtering settings..Fri Oct 9 17:50:49 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 17:50:49 2020 - [info] Replication filtering check ok.Fri Oct 9 17:50:49 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 17:50:49 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 17:50:49 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 17:50:49 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 17:50:49 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 17:50:49 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 17:50:49 2020 - [info] OK.Fri Oct 9 17:50:49 2020 - [warning] shutdown_script is not defined.Fri Oct 9 17:50:49 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 17:50:49 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 17:50:49 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 17:50:49 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 17:53:43 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Fri Oct 9 17:53:43 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 17:53:43 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 17:53:48 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 17:53:48 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 17:53:49 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:53:49 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 17:53:52 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:53:52 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 17:53:55 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:53:55 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 17:53:55 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 17:53:58 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:53:58 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 17:53:58 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 17:53:58 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 17:54:01 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:54:01 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 17:54:03 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 17:54:03 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 17:54:04 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:54:04 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 17:54:07 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:54:07 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 17:54:07 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 17:54:10 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:54:10 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 17:54:10 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 17:54:10 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 17:54:13 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:54:13 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 17:54:15 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.ssh: connect to host 172.16.120.11 port 22: Connection timed outMonitoring server 172.16.120.11 is NOT reachable!Fri Oct 9 17:54:15 2020 - [warning] At least one of monitoring servers is not reachable from this script. This is likely a network problem. Failover should not happen.Fri Oct 9 17:54:16 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 17:54:16 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 17:54:16 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond.. [ç”¨ä¾‹æµ‹è¯•] master ä¸ mha manageré—´ç½‘ç»œå¼‚å¸¸4 Manager &lt;â€“ ä¸é€š â€“&gt; MasterManager &lt;â€“ æ­£å¸¸ â€“&gt; S1 &lt;â€“ ä¸é€š â€“&gt; masterManager &lt;â€“ æ­£å¸¸ â€“&gt; S2 &lt;â€“ æ­£å¸¸ â€“&gt; master ping_type=CONNECTmaster 123456IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç»“è®º: ä¸ä¼šfailover1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768Fri Oct 9 16:05:55 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 16:05:56 2020 - [info] GTID failover mode = 1Fri Oct 9 16:05:56 2020 - [info] Dead Servers:Fri Oct 9 16:05:56 2020 - [info] Alive Servers:Fri Oct 9 16:05:56 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:05:56 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 16:05:56 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 16:05:56 2020 - [info] Alive Slaves:Fri Oct 9 16:05:56 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 16:05:56 2020 - [info] GTID ONFri Oct 9 16:05:56 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:05:56 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 16:05:56 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 16:05:56 2020 - [info] GTID ONFri Oct 9 16:05:56 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:05:56 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 16:05:56 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:05:56 2020 - [info] Checking slave configurations..Fri Oct 9 16:05:56 2020 - [info] Checking replication filtering settings..Fri Oct 9 16:05:56 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 16:05:56 2020 - [info] Replication filtering check ok.Fri Oct 9 16:05:56 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 16:05:56 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 16:05:56 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 16:05:56 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 16:05:56 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 16:05:56 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 16:05:56 2020 - [info] OK.Fri Oct 9 16:05:56 2020 - [warning] shutdown_script is not defined.Fri Oct 9 16:05:56 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 16:05:56 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 16:05:56 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 16:05:56 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 16:06:43 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:06:43 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:06:43 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 16:06:47 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:06:47 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:06:48 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Master is reachable from 172.16.120.12!Fri Oct 9 16:06:48 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 16:06:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:06:50 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 16:06:53 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:06:53 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 16:06:53 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 16:06:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:06:56 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 16:06:56 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 16:06:56 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:06:59 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:06:59 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:07:01 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Master is reachable from 172.16.120.12!Fri Oct 9 16:07:01 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 16:07:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:07:02 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 16:07:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:07:05 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 16:07:05 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 16:07:05 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond.. ping_type=INSERTmaster 123456IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç”±äºping_type=INSERTæ˜¯é•¿è¿æ¥, æ‰€ä»¥æ— å¼‚å¸¸ killè¿æ¥ 123456789101112131415161718192021root@localhost 15:55:23 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 19 | | NULL | 1 | 0 || 1249 | proxysql | 172.16.120.11:59582 | NULL | Sleep | 7 | | NULL | 0 | 0 || 1250 | proxysql | 172.16.120.12:56530 | NULL | Sleep | 4 | | NULL | 0 | 0 || 1254 | proxysql | 172.16.120.11:59592 | NULL | Sleep | 27 | | NULL | 1 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 14 | | NULL | 1 | 0 || 1341 | mha | 172.16.120.12:56698 | information_schema | Sleep | 114 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 51 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 9 | | NULL | 0 | 0 || 2409 | repler | 172.16.120.11:32918 | NULL | Binlog Dump GTID | 12703 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2411 | repler | 172.16.120.12:58084 | NULL | Binlog Dump GTID | 12678 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 2627 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 3022 | mha | 172.16.120.13:36466 | NULL | Sleep | 2 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+-------+---------------------------------------------------------------+------------------+-----------+---------------+12 rows in set (0.00 sec)root@localhost 16:09:44 [dbms_monitor]&gt; kill 3022;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¸ä¼šfailover12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576Fri Oct 9 16:08:29 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 16:08:30 2020 - [info] GTID failover mode = 1Fri Oct 9 16:08:30 2020 - [info] Dead Servers:Fri Oct 9 16:08:30 2020 - [info] Alive Servers:Fri Oct 9 16:08:30 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:08:30 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 16:08:30 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 16:08:30 2020 - [info] Alive Slaves:Fri Oct 9 16:08:30 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 16:08:30 2020 - [info] GTID ONFri Oct 9 16:08:30 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:08:30 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 16:08:30 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 16:08:30 2020 - [info] GTID ONFri Oct 9 16:08:30 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:08:30 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 16:08:30 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 16:08:30 2020 - [info] Checking slave configurations..Fri Oct 9 16:08:30 2020 - [info] Checking replication filtering settings..Fri Oct 9 16:08:30 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 16:08:30 2020 - [info] Replication filtering check ok.Fri Oct 9 16:08:30 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 16:08:30 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 16:08:30 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 16:08:30 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 16:08:30 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 16:08:30 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 16:08:30 2020 - [info] OK.Fri Oct 9 16:08:30 2020 - [warning] shutdown_script is not defined.Fri Oct 9 16:08:30 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 16:08:30 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 16:08:30 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 16:08:30 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 16:09:51 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Fri Oct 9 16:09:51 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 16:09:51 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:09:56 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Master is reachable from 172.16.120.12!Fri Oct 9 16:09:57 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 16:09:57 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:09:57 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:10:00 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:00 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 16:10:03 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:03 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 16:10:03 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 16:10:06 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:06 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 16:10:06 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 16:10:06 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:10:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:09 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:10:11 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Master is reachable from 172.16.120.12!Fri Oct 9 16:10:12 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen.Fri Oct 9 16:10:12 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:12 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 16:10:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:15 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 16:10:15 2020 - [warning] Secondary network check script returned errors. Failover should not start so checking server status again. Check network settings for details.Fri Oct 9 16:10:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:18 2020 - [warning] Connection failed 1 time(s)..Fri Oct 9 16:10:18 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 16:10:18 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 16:10:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 16:10:21 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 16:10:21 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 16:10:21 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Master is reachable from 172.16.120.11!Fri Oct 9 16:10:21 2020 - [warning] Master is reachable from at least one of other monitoring servers. Failover should not happen. [ç”¨ä¾‹æµ‹è¯•] master ä¸ mha manageré—´ç½‘ç»œå¼‚å¸¸5 Manager &lt;â€“ ä¸é€š â€“&gt; MasterManager &lt;â€“ æ­£å¸¸ â€“&gt; S1 &lt;â€“ ä¸é€š â€“&gt; masterManager &lt;â€“ æ­£å¸¸ â€“&gt; S2 &lt;â€“ ä¸é€š â€“&gt; master ping_type=CONNECTmaster 12345IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP ç»“è®º: ä¼šfailover123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230Fri Oct 9 18:21:13 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 18:21:14 2020 - [info] GTID failover mode = 1Fri Oct 9 18:21:14 2020 - [info] Dead Servers:Fri Oct 9 18:21:14 2020 - [info] Alive Servers:Fri Oct 9 18:21:14 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:21:14 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:21:14 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:21:14 2020 - [info] Alive Slaves:Fri Oct 9 18:21:14 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:21:14 2020 - [info] GTID ONFri Oct 9 18:21:14 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:21:14 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:21:14 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:21:14 2020 - [info] GTID ONFri Oct 9 18:21:14 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:21:14 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:21:14 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:21:14 2020 - [info] Checking slave configurations..Fri Oct 9 18:21:14 2020 - [info] Checking replication filtering settings..Fri Oct 9 18:21:14 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 18:21:14 2020 - [info] Replication filtering check ok.Fri Oct 9 18:21:14 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 18:21:14 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 18:21:14 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 18:21:14 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:21:14 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 18:21:14 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 18:21:14 2020 - [info] OK.Fri Oct 9 18:21:14 2020 - [warning] shutdown_script is not defined.Fri Oct 9 18:21:14 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 18:21:14 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 18:21:14 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 18:21:14 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 18:22:07 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:22:07 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 18:22:07 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTFri Oct 9 18:22:11 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:22:11 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 18:22:12 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Fri Oct 9 18:22:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:22:14 2020 - [warning] Connection failed 3 time(s)..Fri Oct 9 18:22:17 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:22:17 2020 - [warning] Connection failed 4 time(s)..Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Fri Oct 9 18:22:18 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Fri Oct 9 18:22:18 2020 - [warning] Master is not reachable from health checker!Fri Oct 9 18:22:18 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Fri Oct 9 18:22:18 2020 - [warning] SSH is NOT reachable.Fri Oct 9 18:22:18 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Fri Oct 9 18:22:18 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Fri Oct 9 18:22:18 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Fri Oct 9 18:22:18 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Fri Oct 9 18:22:19 2020 - [info] GTID failover mode = 1Fri Oct 9 18:22:19 2020 - [info] Dead Servers:Fri Oct 9 18:22:19 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:19 2020 - [info] Alive Servers:Fri Oct 9 18:22:19 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:22:19 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:22:19 2020 - [info] Alive Slaves:Fri Oct 9 18:22:19 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:19 2020 - [info] GTID ONFri Oct 9 18:22:19 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:19 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:19 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:19 2020 - [info] GTID ONFri Oct 9 18:22:19 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:19 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:19 2020 - [info] Checking slave configurations..Fri Oct 9 18:22:19 2020 - [info] Checking replication filtering settings..Fri Oct 9 18:22:19 2020 - [info] Replication filtering check ok.Fri Oct 9 18:22:19 2020 - [info] Master is down!Fri Oct 9 18:22:19 2020 - [info] Terminating monitoring script.Fri Oct 9 18:22:19 2020 - [info] Got exit code 20 (Master dead).Fri Oct 9 18:22:19 2020 - [info] MHA::MasterFailover version 0.58.Fri Oct 9 18:22:19 2020 - [info] Starting master failover.Fri Oct 9 18:22:19 2020 - [info] Fri Oct 9 18:22:19 2020 - [info] * Phase 1: Configuration Check Phase..Fri Oct 9 18:22:19 2020 - [info] Fri Oct 9 18:22:20 2020 - [info] GTID failover mode = 1Fri Oct 9 18:22:20 2020 - [info] Dead Servers:Fri Oct 9 18:22:20 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:20 2020 - [info] Checking master reachability via MySQL(double check)...Fri Oct 9 18:22:21 2020 - [info] ok.Fri Oct 9 18:22:21 2020 - [info] Alive Servers:Fri Oct 9 18:22:21 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:22:21 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:22:21 2020 - [info] Alive Slaves:Fri Oct 9 18:22:21 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] Starting GTID based failover.Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] ** Phase 1: Configuration Check Phase completed.Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] Forcing shutdown so that applications never connect to the current master..Fri Oct 9 18:22:21 2020 - [info] Executing master IP deactivation script:Fri Oct 9 18:22:21 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stop Disabling the VIP on old master: 172.16.120.10 Fake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Fri Oct 9 18:22:21 2020 - [info] done.Fri Oct 9 18:22:21 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Fri Oct 9 18:22:21 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 3: Master Recovery Phase..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:3084318Fri Oct 9 18:22:21 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:10391-19970Fri Oct 9 18:22:21 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Fri Oct 9 18:22:21 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:3084318Fri Oct 9 18:22:21 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:10391-19970Fri Oct 9 18:22:21 2020 - [info] Oldest slaves:Fri Oct 9 18:22:21 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 3.3: Determining New Master Phase..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] Searching new master from slaves..Fri Oct 9 18:22:21 2020 - [info] Candidate masters from the configuration file:Fri Oct 9 18:22:21 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:22:21 2020 - [info] GTID ONFri Oct 9 18:22:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:22:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:22:21 2020 - [info] Non-candidate masters:Fri Oct 9 18:22:21 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Fri Oct 9 18:22:21 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:22:21 2020 - [info] Starting master failover..Fri Oct 9 18:22:21 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.11(172.16.120.11:3358) (new master) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 3.3: New Master Recovery Phase..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] Waiting all logs to be applied.. Fri Oct 9 18:22:21 2020 - [info] done.Fri Oct 9 18:22:21 2020 - [info] Getting new master&#x27;s binlog name and position..Fri Oct 9 18:22:21 2020 - [info] mysql-bin.000008:3052407Fri Oct 9 18:22:21 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.11&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Fri Oct 9 18:22:21 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 3052407, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-19970,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Fri Oct 9 18:22:21 2020 - [info] Executing master IP activate script:Fri Oct 9 18:22:21 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 Fake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Fri Oct 9 18:22:21 2020 - [info] OK.Fri Oct 9 18:22:21 2020 - [info] ** Finished master recovery successfully.Fri Oct 9 18:22:21 2020 - [info] * Phase 3: Master Recovery Phase completed.Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 4: Slaves Recovery Phase..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Fri Oct 9 18:22:21 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 68999. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009182219.log if it takes time..Fri Oct 9 18:22:22 2020 - [info] Fri Oct 9 18:22:22 2020 - [info] Log messages from 172.16.120.12 ...Fri Oct 9 18:22:22 2020 - [info] Fri Oct 9 18:22:21 2020 - [info] Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..Fri Oct 9 18:22:21 2020 - [info] Executed CHANGE MASTER.Fri Oct 9 18:22:21 2020 - [info] Slave started.Fri Oct 9 18:22:21 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-19970,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.Fri Oct 9 18:22:22 2020 - [info] End of log messages from 172.16.120.12.Fri Oct 9 18:22:22 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.Fri Oct 9 18:22:22 2020 - [info] All new slave servers recovered successfully.Fri Oct 9 18:22:22 2020 - [info] Fri Oct 9 18:22:22 2020 - [info] * Phase 5: New master cleanup phase..Fri Oct 9 18:22:22 2020 - [info] Fri Oct 9 18:22:22 2020 - [info] Resetting slave info on the new master..Fri Oct 9 18:22:22 2020 - [info] 172.16.120.11: Resetting slave info succeeded.Fri Oct 9 18:22:22 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Fri Oct 9 18:22:22 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.11(172.16.120.11:3358) as a new master.172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Fri Oct 9 18:22:22 2020 - [info] Sending mail.. ping_type=INSERTç”±äºping_type=INSERTæ˜¯é•¿è¿æ¥, æ‰€ä»¥æ— å¼‚å¸¸ killè¿æ¥ 1234567891011121314151617181920root@localhost 18:24:52 [dbms_monitor]&gt; show processlist;+------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+| 1248 | proxysql | 172.16.120.10:58672 | NULL | Sleep | 1 | | NULL | 0 | 0 || 1264 | proxysql | 172.16.120.12:56552 | NULL | Sleep | 2 | | NULL | 0 | 0 || 1343 | mha | 172.16.120.11:59758 | information_schema | Sleep | 74 | | NULL | 0 | 0 || 1452 | proxysql | 172.16.120.10:59046 | NULL | Sleep | 2 | | NULL | 1 | 0 || 3192 | proxysql | 172.16.120.11:33786 | NULL | Sleep | 3 | | NULL | 1 | 0 || 3238 | proxysql | 172.16.120.12:59006 | NULL | Sleep | 1 | | NULL | 1 | 0 || 3245 | proxysql | 172.16.120.11:33888 | NULL | Sleep | 2 | | NULL | 0 | 0 || 3262 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 3357 | repler | 172.16.120.11:34036 | NULL | Binlog Dump GTID | 142 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 3359 | repler | 172.16.120.12:59166 | NULL | Binlog Dump GTID | 123 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 3364 | mha | 172.16.120.13:37512 | NULL | Sleep | 2 | | NULL | 0 | 0 |+------+----------+---------------------+--------------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+11 rows in set (0.00 sec)root@localhost 18:26:25 [dbms_monitor]&gt; kill 3364;Query OK, 0 rows affected (0.01 sec) ç»“è®º: é•¿è¿æ¥æ–­å¼€åæ‰ä¼šfailover, å¦åˆ™ä¸ä¼šfailover123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227Fri Oct 9 18:25:33 2020 - [info] MHA::MasterMonitor version 0.58.Fri Oct 9 18:25:34 2020 - [info] GTID failover mode = 1Fri Oct 9 18:25:34 2020 - [info] Dead Servers:Fri Oct 9 18:25:34 2020 - [info] Alive Servers:Fri Oct 9 18:25:34 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:25:34 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:25:34 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:25:34 2020 - [info] Alive Slaves:Fri Oct 9 18:25:34 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:25:34 2020 - [info] GTID ONFri Oct 9 18:25:34 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:25:34 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:25:34 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:25:34 2020 - [info] GTID ONFri Oct 9 18:25:34 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:25:34 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:25:34 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:25:34 2020 - [info] Checking slave configurations..Fri Oct 9 18:25:34 2020 - [info] Checking replication filtering settings..Fri Oct 9 18:25:34 2020 - [info] binlog_do_db= , binlog_ignore_db= Fri Oct 9 18:25:34 2020 - [info] Replication filtering check ok.Fri Oct 9 18:25:34 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Fri Oct 9 18:25:34 2020 - [info] Checking SSH publickey authentication settings on the current master..Fri Oct 9 18:25:35 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Fri Oct 9 18:25:35 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:25:35 2020 - [info] Checking master_ip_failover_script status:Fri Oct 9 18:25:35 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Fri Oct 9 18:25:35 2020 - [info] OK.Fri Oct 9 18:25:35 2020 - [warning] shutdown_script is not defined.Fri Oct 9 18:25:35 2020 - [info] Set master ping interval 3 seconds.Fri Oct 9 18:25:35 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Fri Oct 9 18:25:35 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Fri Oct 9 18:25:35 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..Fri Oct 9 18:26:44 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Fri Oct 9 18:26:44 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTFri Oct 9 18:26:44 2020 - [info] Executing SSH check script: exit 0Fri Oct 9 18:26:49 2020 - [warning] HealthCheck: Got timeout on checking SSH connection to 172.16.120.10! at /usr/local/share/perl5/MHA/HealthCheck.pm line 344.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Fri Oct 9 18:26:50 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:26:50 2020 - [warning] Connection failed 2 time(s)..Fri Oct 9 18:26:53 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:26:53 2020 - [warning] Connection failed 3 time(s)..Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Fri Oct 9 18:26:54 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Fri Oct 9 18:26:56 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (4))Fri Oct 9 18:26:56 2020 - [warning] Connection failed 4 time(s)..Fri Oct 9 18:26:56 2020 - [warning] Master is not reachable from health checker!Fri Oct 9 18:26:56 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Fri Oct 9 18:26:56 2020 - [warning] SSH is NOT reachable.Fri Oct 9 18:26:56 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Fri Oct 9 18:26:56 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Fri Oct 9 18:26:56 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Fri Oct 9 18:26:56 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Fri Oct 9 18:26:57 2020 - [info] GTID failover mode = 1Fri Oct 9 18:26:57 2020 - [info] Dead Servers:Fri Oct 9 18:26:57 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:57 2020 - [info] Alive Servers:Fri Oct 9 18:26:57 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:26:57 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:26:57 2020 - [info] Alive Slaves:Fri Oct 9 18:26:57 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:57 2020 - [info] GTID ONFri Oct 9 18:26:57 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:57 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:57 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:57 2020 - [info] GTID ONFri Oct 9 18:26:57 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:57 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:57 2020 - [info] Checking slave configurations..Fri Oct 9 18:26:57 2020 - [info] Checking replication filtering settings..Fri Oct 9 18:26:57 2020 - [info] Replication filtering check ok.Fri Oct 9 18:26:57 2020 - [info] Master is down!Fri Oct 9 18:26:57 2020 - [info] Terminating monitoring script.Fri Oct 9 18:26:57 2020 - [info] Got exit code 20 (Master dead).Fri Oct 9 18:26:57 2020 - [info] MHA::MasterFailover version 0.58.Fri Oct 9 18:26:57 2020 - [info] Starting master failover.Fri Oct 9 18:26:57 2020 - [info] Fri Oct 9 18:26:57 2020 - [info] * Phase 1: Configuration Check Phase..Fri Oct 9 18:26:57 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] GTID failover mode = 1Fri Oct 9 18:26:58 2020 - [info] Dead Servers:Fri Oct 9 18:26:58 2020 - [info] 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Alive Servers:Fri Oct 9 18:26:58 2020 - [info] 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:26:58 2020 - [info] 172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:26:58 2020 - [info] Alive Slaves:Fri Oct 9 18:26:58 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] Starting GTID based failover.Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] ** Phase 1: Configuration Check Phase completed.Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] Forcing shutdown so that applications never connect to the current master..Fri Oct 9 18:26:58 2020 - [info] Executing master IP deactivation script:Fri Oct 9 18:26:58 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stop Disabling the VIP on old master: 172.16.120.10 Fake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Fri Oct 9 18:26:58 2020 - [info] done.Fri Oct 9 18:26:58 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Fri Oct 9 18:26:58 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 3: Master Recovery Phase..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000009:3101017Fri Oct 9 18:26:58 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:19971-20041Fri Oct 9 18:26:58 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Fri Oct 9 18:26:58 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000009:3101017Fri Oct 9 18:26:58 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:19971-20041Fri Oct 9 18:26:58 2020 - [info] Oldest slaves:Fri Oct 9 18:26:58 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 3.3: Determining New Master Phase..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] Searching new master from slaves..Fri Oct 9 18:26:58 2020 - [info] Candidate masters from the configuration file:Fri Oct 9 18:26:58 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledFri Oct 9 18:26:58 2020 - [info] GTID ONFri Oct 9 18:26:58 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Fri Oct 9 18:26:58 2020 - [info] Primary candidate for the new Master (candidate_master is set)Fri Oct 9 18:26:58 2020 - [info] Non-candidate masters:Fri Oct 9 18:26:58 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Fri Oct 9 18:26:58 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)Fri Oct 9 18:26:58 2020 - [info] Starting master failover..Fri Oct 9 18:26:58 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.11(172.16.120.11:3358) (new master) +--172.16.120.12(172.16.120.12:3358)Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 3.3: New Master Recovery Phase..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] Waiting all logs to be applied.. Fri Oct 9 18:26:58 2020 - [info] done.Fri Oct 9 18:26:58 2020 - [info] Getting new master&#x27;s binlog name and position..Fri Oct 9 18:26:58 2020 - [info] mysql-bin.000008:3068991Fri Oct 9 18:26:58 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.11&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Fri Oct 9 18:26:58 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 3068991, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20041,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Fri Oct 9 18:26:58 2020 - [info] Executing master IP activate script:Fri Oct 9 18:26:58 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 Fake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Fri Oct 9 18:26:58 2020 - [info] OK.Fri Oct 9 18:26:58 2020 - [info] ** Finished master recovery successfully.Fri Oct 9 18:26:58 2020 - [info] * Phase 3: Master Recovery Phase completed.Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 4: Slaves Recovery Phase..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Fri Oct 9 18:26:58 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 69850. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201009182657.log if it takes time..Fri Oct 9 18:26:59 2020 - [info] Fri Oct 9 18:26:59 2020 - [info] Log messages from 172.16.120.12 ...Fri Oct 9 18:26:59 2020 - [info] Fri Oct 9 18:26:58 2020 - [info] Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..Fri Oct 9 18:26:58 2020 - [info] Executed CHANGE MASTER.Fri Oct 9 18:26:58 2020 - [info] Slave started.Fri Oct 9 18:26:58 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20041,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.Fri Oct 9 18:26:59 2020 - [info] End of log messages from 172.16.120.12.Fri Oct 9 18:26:59 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.Fri Oct 9 18:26:59 2020 - [info] All new slave servers recovered successfully.Fri Oct 9 18:26:59 2020 - [info] Fri Oct 9 18:26:59 2020 - [info] * Phase 5: New master cleanup phase..Fri Oct 9 18:26:59 2020 - [info] Fri Oct 9 18:26:59 2020 - [info] Resetting slave info on the new master..Fri Oct 9 18:26:59 2020 - [info] 172.16.120.11: Resetting slave info succeeded.Fri Oct 9 18:26:59 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Fri Oct 9 18:26:59 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.11(172.16.120.11:3358) as a new master.172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Fri Oct 9 18:26:59 2020 - [info] Sending mail.. [ç”¨ä¾‹æµ‹è¯•] masteræŒ‚äº†, ä¸”slaveä¹Ÿæœ‰é—®é¢˜1(éƒ¨åˆ†slaveå®•æœº) masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1å®•æœºäº† ping_type=CONNECTå¯åŠ¨managerå, å…³é—­slave-1 12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 10:28:35 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 10:28:37 2020 - [info] GTID failover mode = 1Sat Oct 10 10:28:37 2020 - [info] Dead Servers:Sat Oct 10 10:28:37 2020 - [info] Alive Servers:Sat Oct 10 10:28:37 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:28:37 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 10:28:37 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 10:28:37 2020 - [info] Alive Slaves:Sat Oct 10 10:28:37 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 10:28:37 2020 - [info] GTID ONSat Oct 10 10:28:37 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:28:37 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 10:28:37 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 10:28:37 2020 - [info] GTID ONSat Oct 10 10:28:37 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:28:37 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 10:28:37 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:28:37 2020 - [info] Checking slave configurations..Sat Oct 10 10:28:37 2020 - [info] Checking replication filtering settings..Sat Oct 10 10:28:37 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 10:28:37 2020 - [info] Replication filtering check ok.Sat Oct 10 10:28:37 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 10:28:37 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 10:28:37 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 10:28:37 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 10:28:37 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 10:28:37 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 10:28:37 2020 - [info] OK.Sat Oct 10 10:28:37 2020 - [warning] shutdown_script is not defined.Sat Oct 10 10:28:37 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 10:28:37 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 10:28:37 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 10:28:37 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond.. å…³é—­slave-1 123456789101112131415161718[root@centos-2 10:19:38 ~]#mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor mysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 2118Server version: 5.7.31-34-log Percona Server (GPL), Release 34, Revision 2e68637Copyright (c) 2009-2020 Percona LLC and/or its affiliatesCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &#x27;help;&#x27; or &#x27;\\h&#x27; for help. Type &#x27;\\c&#x27; to clear the current input statement.root@localhost 10:20:52 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.03 sec) å…³é—­å, mha managerä»ç„¶æ˜¯æ­£å¸¸çš„ å…³é—­master 123456789101112131415161718[root@centos-1 10:20:35 ~]#mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor mysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 3413Server version: 5.7.31-34-log Percona Server (GPL), Release 34, Revision 2e68637Copyright (c) 2009-2020 Percona LLC and/or its affiliatesCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &#x27;help;&#x27; or &#x27;\\h&#x27; for help. Type &#x27;\\c&#x27; to clear the current input statement.root@localhost 10:20:47 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.03 sec) ç»“è®º: ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758Sat Oct 10 10:50:38 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 10:50:38 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTSat Oct 10 10:50:38 2020 - [info] Executing SSH check script: exit 0Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Sat Oct 10 10:50:38 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 10:50:38 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 10:50:41 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 10:50:41 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 10:50:44 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 10:50:44 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 10:50:47 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 10:50:47 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 10:50:47 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 10:50:47 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 10:50:47 2020 - [warning] SSH is reachable.Sat Oct 10 10:50:47 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 10:50:47 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 10:50:47 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 10:50:47 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 10:50:48 2020 - [info] GTID failover mode = 1Sat Oct 10 10:50:48 2020 - [info] Dead Servers:Sat Oct 10 10:50:48 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:50:48 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 10:50:48 2020 - [info] Alive Servers:Sat Oct 10 10:50:48 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 10:50:48 2020 - [info] Alive Slaves:Sat Oct 10 10:50:48 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 10:50:48 2020 - [info] GTID ONSat Oct 10 10:50:48 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:50:48 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 10:50:48 2020 - [info] Checking slave configurations..Sat Oct 10 10:50:48 2020 - [info] Checking replication filtering settings..Sat Oct 10 10:50:48 2020 - [info] Replication filtering check ok.Sat Oct 10 10:50:48 2020 - [info] Master is down!Sat Oct 10 10:50:48 2020 - [info] Terminating monitoring script.Sat Oct 10 10:50:48 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 10:50:48 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 10:50:48 2020 - [info] Starting master failover.Sat Oct 10 10:50:48 2020 - [info] Sat Oct 10 10:50:48 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 10:50:48 2020 - [info] Sat Oct 10 10:50:49 2020 - [info] GTID failover mode = 1Sat Oct 10 10:50:49 2020 - [info] Dead Servers:Sat Oct 10 10:50:49 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:50:49 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 10:50:49 2020 - [info] Checking master reachability via MySQL(double check)...Sat Oct 10 10:50:49 2020 - [info] ok.Sat Oct 10 10:50:49 2020 - [info] Alive Servers:Sat Oct 10 10:50:49 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 10:50:49 2020 - [info] Alive Slaves:Sat Oct 10 10:50:49 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 10:50:49 2020 - [info] GTID ONSat Oct 10 10:50:49 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:50:49 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 10:50:49 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln492] Server 172.16.120.11(172.16.120.11:3358) is dead, but must be alive! Check server settings.Sat Oct 10 10:50:49 2020 - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177] Got ERROR: at /usr/local/share/perl5/MHA/MasterFailover.pm line 269. ping_type=INSERTå…¶å®å’Œconnectåº”è¯¥æ˜¯ä¸€æ ·çš„, ä¸è¿‡è¿˜æ˜¯èµ°ä¸€éæµç¨‹ å¯åŠ¨managerå, å…³é—­slave-1 12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 10:59:07 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 10:59:09 2020 - [info] GTID failover mode = 1Sat Oct 10 10:59:09 2020 - [info] Dead Servers:Sat Oct 10 10:59:09 2020 - [info] Alive Servers:Sat Oct 10 10:59:09 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:59:09 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 10:59:09 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 10:59:09 2020 - [info] Alive Slaves:Sat Oct 10 10:59:09 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 10:59:09 2020 - [info] GTID ONSat Oct 10 10:59:09 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:59:09 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 10:59:09 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 10:59:09 2020 - [info] GTID ONSat Oct 10 10:59:09 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:59:09 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 10:59:09 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 10:59:09 2020 - [info] Checking slave configurations..Sat Oct 10 10:59:09 2020 - [info] Checking replication filtering settings..Sat Oct 10 10:59:09 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 10:59:09 2020 - [info] Replication filtering check ok.Sat Oct 10 10:59:09 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 10:59:09 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 10:59:09 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 10:59:09 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 10:59:09 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 10:59:09 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 10:59:09 2020 - [info] OK.Sat Oct 10 10:59:09 2020 - [warning] shutdown_script is not defined.Sat Oct 10 10:59:09 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 10:59:09 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 10:59:09 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 10:59:09 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond.. å…³é—­slave-1 12[root@centos-2 10:56:24 /usr/local/Percona-Server-5.7.29-32-Linux.x86_64.ssl101]#2020-10-10T03:00:49.502943Z mysqld_safe mysqld from pid file /data/mysql_3358/run/mysql.pid ended å…³é—­master 123456789101112131415161718[root@centos-1 11:07:08 ~]#mysql -uroot -p -S /data/mysql_3358/run/mysql.sock dbms_monitor mysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 35Server version: 5.7.29-32-log Percona Server (GPL), Release 32, Revision 56bce88Copyright (c) 2009-2020 Percona LLC and/or its affiliatesCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &#x27;help;&#x27; or &#x27;\\h&#x27; for help. Type &#x27;\\c&#x27; to clear the current input statement.root@localhost 11:07:09 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455Sat Oct 10 11:07:15 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Sat Oct 10 11:07:15 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 11:07:15 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTMonitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Sat Oct 10 11:07:16 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 11:07:16 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 11:07:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:07:18 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 11:07:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:07:21 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 11:07:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:07:24 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 11:07:24 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 11:07:24 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 11:07:24 2020 - [warning] SSH is reachable.Sat Oct 10 11:07:24 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 11:07:24 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 11:07:24 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:07:24 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:07:25 2020 - [info] GTID failover mode = 1Sat Oct 10 11:07:25 2020 - [info] Dead Servers:Sat Oct 10 11:07:25 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:07:25 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:07:25 2020 - [info] Alive Servers:Sat Oct 10 11:07:25 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:07:25 2020 - [info] Alive Slaves:Sat Oct 10 11:07:25 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:07:25 2020 - [info] GTID ONSat Oct 10 11:07:25 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:07:25 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:07:25 2020 - [info] Checking slave configurations..Sat Oct 10 11:07:25 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:07:25 2020 - [info] Replication filtering check ok.Sat Oct 10 11:07:25 2020 - [info] Master is down!Sat Oct 10 11:07:25 2020 - [info] Terminating monitoring script.Sat Oct 10 11:07:25 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 11:07:25 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 11:07:25 2020 - [info] Starting master failover.Sat Oct 10 11:07:25 2020 - [info] Sat Oct 10 11:07:25 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 11:07:25 2020 - [info] Sat Oct 10 11:07:26 2020 - [info] GTID failover mode = 1Sat Oct 10 11:07:26 2020 - [info] Dead Servers:Sat Oct 10 11:07:26 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:07:26 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:07:26 2020 - [info] Alive Servers:Sat Oct 10 11:07:26 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:07:26 2020 - [info] Alive Slaves:Sat Oct 10 11:07:26 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:07:26 2020 - [info] GTID ONSat Oct 10 11:07:26 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:07:26 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:07:26 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln492] Server 172.16.120.11(172.16.120.11:3358) is dead, but must be alive! Check server settings.Sat Oct 10 11:07:26 2020 - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177] Got ERROR: at /usr/local/share/perl5/MHA/MasterFailover.pm line 269. æ€»ç»“: å¦‚ä¸å¸Œæœ›slave-1å®•æœºå½±å“failover, éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¯¹slave-1è®¾ç½®ignore_fail=112345[server2]hostname=172.16.120.11port=3358candidate_master=1ignore_fail=1 [ç”¨ä¾‹æµ‹è¯•] masteræŒ‚äº†, ä¸”slaveä¹Ÿæœ‰é—®é¢˜2(éƒ¨åˆ†slave io_thread stop) masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 io_thread stopäº† ping_type=CONNECTå¯åŠ¨managerå, å…³é—­slave-1 io_thread 12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 11:13:58 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 11:13:59 2020 - [info] GTID failover mode = 1Sat Oct 10 11:13:59 2020 - [info] Dead Servers:Sat Oct 10 11:13:59 2020 - [info] Alive Servers:Sat Oct 10 11:13:59 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:13:59 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:13:59 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:13:59 2020 - [info] Alive Slaves:Sat Oct 10 11:13:59 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:13:59 2020 - [info] GTID ONSat Oct 10 11:13:59 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:13:59 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:13:59 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:13:59 2020 - [info] GTID ONSat Oct 10 11:13:59 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:13:59 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:13:59 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:13:59 2020 - [info] Checking slave configurations..Sat Oct 10 11:13:59 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:13:59 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 11:13:59 2020 - [info] Replication filtering check ok.Sat Oct 10 11:13:59 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 11:13:59 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 11:13:59 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 11:13:59 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:13:59 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 11:13:59 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 11:14:00 2020 - [info] OK.Sat Oct 10 11:14:00 2020 - [warning] shutdown_script is not defined.Sat Oct 10 11:14:00 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 11:14:00 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 11:14:00 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 11:14:00 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond.. å…³é—­slave-1 123456789101112131415161718192021222324root@localhost 11:17:29 [dbms_monitor]&gt; stop slave io_thread;Query OK, 0 rows affected (0.01 sec)root@localhost 11:17:33 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;PAGER set to &#x27;cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;&#x27;root@localhost 11:17:49 [dbms_monitor]&gt; show slave status\\G Master_Log_File: mysql-bin.000011 Read_Master_Log_Pos: 194 Relay_Log_File: mysql-relay-bin.000009 Relay_Log_Pos: 407 Relay_Master_Log_File: mysql-bin.000011 Slave_IO_Running: No Slave_SQL_Running: Yes Last_Errno: 0 Last_Error: Exec_Master_Log_Pos: 194 Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 1 row in set (0.00 sec) å…³é—­io_threadå managerä»ç„¶æ­£å¸¸ å…³é—­master 12345678910111213root@localhost 11:21:18 [dbms_monitor]&gt; insert into monitor_delay values(1,now());Query OK, 1 row affected (0.01 sec)root@localhost 11:21:39 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 |+----+---------------------+1 row in set (0.00 sec)root@localhost 11:21:54 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) slave-1 12root@localhost 11:17:49 [dbms_monitor]&gt; select * from monitor_delay;Empty set (0.01 sec) slave-2 1234567root@localhost 10:20:54 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 |+----+---------------------+1 row in set (0.01 sec) ç»“è®º: ä¼šfailoverä¸”æˆåŠŸ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185Sat Oct 10 11:22:12 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:22:12 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTSat Oct 10 11:22:12 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 11:22:12 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 11:22:12 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 11:22:15 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:22:15 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 11:22:18 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:22:18 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 11:22:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:22:21 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 11:22:21 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 11:22:21 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 11:22:21 2020 - [warning] SSH is reachable.Sat Oct 10 11:22:21 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 11:22:21 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 11:22:21 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:22:21 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:22:22 2020 - [info] GTID failover mode = 1Sat Oct 10 11:22:22 2020 - [info] Dead Servers:Sat Oct 10 11:22:22 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:22 2020 - [info] Alive Servers:Sat Oct 10 11:22:22 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:22:22 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:22:22 2020 - [info] Alive Slaves:Sat Oct 10 11:22:22 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:22 2020 - [info] GTID ONSat Oct 10 11:22:22 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:22 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:22 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:22 2020 - [info] GTID ONSat Oct 10 11:22:22 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:22 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:22 2020 - [info] Checking slave configurations..Sat Oct 10 11:22:22 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:22:22 2020 - [info] Replication filtering check ok.Sat Oct 10 11:22:22 2020 - [info] Master is down!Sat Oct 10 11:22:22 2020 - [info] Terminating monitoring script.Sat Oct 10 11:22:22 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 11:22:22 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 11:22:22 2020 - [info] Starting master failover.Sat Oct 10 11:22:22 2020 - [info] Sat Oct 10 11:22:22 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 11:22:22 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] GTID failover mode = 1Sat Oct 10 11:22:23 2020 - [info] Dead Servers:Sat Oct 10 11:22:23 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Checking master reachability via MySQL(double check)...Sat Oct 10 11:22:23 2020 - [info] ok.Sat Oct 10 11:22:23 2020 - [info] Alive Servers:Sat Oct 10 11:22:23 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:22:23 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:22:23 2020 - [info] Alive Slaves:Sat Oct 10 11:22:23 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:23 2020 - [info] GTID ONSat Oct 10 11:22:23 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:23 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:23 2020 - [info] GTID ONSat Oct 10 11:22:23 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:23 2020 - [info] Starting GTID based failover.Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] ** Phase 1: Configuration Check Phase completed.Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] Forcing shutdown so that applications never connect to the current master..Sat Oct 10 11:22:23 2020 - [info] Executing master IP deactivation script:Sat Oct 10 11:22:23 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 Fake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Sat Oct 10 11:22:23 2020 - [info] done.Sat Oct 10 11:22:23 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Sat Oct 10 11:22:23 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] * Phase 3: Master Recovery Phase..Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000011:486Sat Oct 10 11:22:23 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20042-20531Sat Oct 10 11:22:23 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Sat Oct 10 11:22:23 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:23 2020 - [info] GTID ONSat Oct 10 11:22:23 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:23 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000011:194Sat Oct 10 11:22:23 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20143-20530Sat Oct 10 11:22:23 2020 - [info] Oldest slaves:Sat Oct 10 11:22:23 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:23 2020 - [info] GTID ONSat Oct 10 11:22:23 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] * Phase 3.3: Determining New Master Phase..Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] Searching new master from slaves..Sat Oct 10 11:22:23 2020 - [info] Candidate masters from the configuration file:Sat Oct 10 11:22:23 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:23 2020 - [info] GTID ONSat Oct 10 11:22:23 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:23 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:22:23 2020 - [info] GTID ONSat Oct 10 11:22:23 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:22:23 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:22:23 2020 - [info] Non-candidate masters:Sat Oct 10 11:22:23 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Sat Oct 10 11:22:23 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:22:23 2020 - [info] Starting master failover..Sat Oct 10 11:22:23 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.12(172.16.120.12:3358) (new master) +--172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] * Phase 3.3: New Master Recovery Phase..Sat Oct 10 11:22:23 2020 - [info] Sat Oct 10 11:22:23 2020 - [info] Waiting all logs to be applied.. Sat Oct 10 11:22:23 2020 - [info] done.Sat Oct 10 11:22:23 2020 - [info] Getting new master&#x27;s binlog name and position..Sat Oct 10 11:22:23 2020 - [info] mysql-bin.000007:3182161Sat Oct 10 11:22:23 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.12&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Sat Oct 10 11:22:23 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3182161, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Sat Oct 10 11:22:23 2020 - [info] Executing master IP activate script:Sat Oct 10 11:22:23 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 Fake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Sat Oct 10 11:22:24 2020 - [info] OK.Sat Oct 10 11:22:24 2020 - [info] ** Finished master recovery successfully.Sat Oct 10 11:22:24 2020 - [info] * Phase 3: Master Recovery Phase completed.Sat Oct 10 11:22:24 2020 - [info] Sat Oct 10 11:22:24 2020 - [info] * Phase 4: Slaves Recovery Phase..Sat Oct 10 11:22:24 2020 - [info] Sat Oct 10 11:22:24 2020 - [info] Sat Oct 10 11:22:24 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Sat Oct 10 11:22:24 2020 - [info] Sat Oct 10 11:22:24 2020 - [info] -- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 77208. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010112222.log if it takes time..Sat Oct 10 11:22:25 2020 - [info] Sat Oct 10 11:22:25 2020 - [info] Log messages from 172.16.120.11 ...Sat Oct 10 11:22:25 2020 - [info] Sat Oct 10 11:22:24 2020 - [info] Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..Sat Oct 10 11:22:24 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 11:22:24 2020 - [info] Slave started.Sat Oct 10 11:22:24 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.11(172.16.120.11:3358). Executed 2 events.Sat Oct 10 11:22:25 2020 - [info] End of log messages from 172.16.120.11.Sat Oct 10 11:22:25 2020 - [info] -- Slave on host 172.16.120.11(172.16.120.11:3358) started.Sat Oct 10 11:22:25 2020 - [info] All new slave servers recovered successfully.Sat Oct 10 11:22:25 2020 - [info] Sat Oct 10 11:22:25 2020 - [info] * Phase 5: New master cleanup phase..Sat Oct 10 11:22:25 2020 - [info] Sat Oct 10 11:22:25 2020 - [info] Resetting slave info on the new master..Sat Oct 10 11:22:25 2020 - [info] 172.16.120.12: Resetting slave info succeeded.Sat Oct 10 11:22:25 2020 - [info] Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 11:22:25 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.12(172.16.120.12:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.12(172.16.120.12:3358) as a new master.172.16.120.12(172.16.120.12:3358): OK: Applying all logs succeeded.172.16.120.12(172.16.120.12:3358): OK: Activated master IP address.172.16.120.11(172.16.120.11:3358): OK: Slave started, replicating from 172.16.120.12(172.16.120.12:3358)172.16.120.12(172.16.120.12:3358): Resetting slave info succeeded.Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 11:22:25 2020 - [info] Sending mail.. slave-1æ­£å¸¸changeåˆ°new master slave-2 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869root@localhost 11:21:44 [dbms_monitor]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 172.16.120.12 Master_User: repler Master_Port: 3358 Connect_Retry: 1 Master_Log_File: mysql-bin.000007 Read_Master_Log_Pos: 3182161 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 681 Relay_Master_Log_File: mysql-bin.000007 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 3182161 Relay_Log_Space: 888 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 120123358 Master_UUID: 45e70f96-fcad-11ea-a2f0-0050563108d2 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20531 Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20531,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)root@localhost 11:24:39 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 |+----+---------------------+1 row in set (0.00 sec) ping_type=INSERTå¯åŠ¨managerå, å…³é—­slave-1 io_thread 12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 11:29:28 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 11:29:30 2020 - [info] GTID failover mode = 1Sat Oct 10 11:29:30 2020 - [info] Dead Servers:Sat Oct 10 11:29:30 2020 - [info] Alive Servers:Sat Oct 10 11:29:30 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:29:30 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:29:30 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:29:30 2020 - [info] Alive Slaves:Sat Oct 10 11:29:30 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:29:30 2020 - [info] GTID ONSat Oct 10 11:29:30 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:29:30 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:29:30 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:29:30 2020 - [info] GTID ONSat Oct 10 11:29:30 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:29:30 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:29:30 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:29:30 2020 - [info] Checking slave configurations..Sat Oct 10 11:29:30 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:29:30 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 11:29:30 2020 - [info] Replication filtering check ok.Sat Oct 10 11:29:30 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 11:29:30 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 11:29:30 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 11:29:30 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:29:30 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 11:29:30 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 11:29:30 2020 - [info] OK.Sat Oct 10 11:29:30 2020 - [warning] shutdown_script is not defined.Sat Oct 10 11:29:30 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 11:29:30 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 11:29:30 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 11:29:30 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond.. å…³é—­slave-1 io_thread 123456789101112131415161718192021222324root@localhost 11:30:30 [dbms_monitor]&gt; stop slave io_thread;Query OK, 0 rows affected (0.00 sec)root@localhost 11:30:43 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;PAGER set to &#x27;cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;&#x27;root@localhost 11:30:45 [dbms_monitor]&gt; show slave status\\G Master_Log_File: mysql-bin.000012 Read_Master_Log_Pos: 18307 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 18480 Relay_Master_Log_File: mysql-bin.000012 Slave_IO_Running: No Slave_SQL_Running: Yes Last_Errno: 0 Last_Error: Exec_Master_Log_Pos: 18307 Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 1 row in set (0.00 sec) å…³é—­io_threadå managerä»ç„¶æ­£å¸¸ å…³é—­master 1234567891011121314root@localhost 11:31:40 [dbms_monitor]&gt; insert into monitor_delay values(2,now());Query OK, 1 row affected (0.00 sec)root@localhost 11:31:45 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 |+----+---------------------+2 rows in set (0.00 sec)root@localhost 11:31:51 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) slave-1 1234567root@localhost 11:30:45 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 |+----+---------------------+1 row in set (0.00 sec) slave-2 12345678root@localhost 11:27:07 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 |+----+---------------------+2 rows in set (0.00 sec) ç»“è®º: ä¼šfailoverä¸”æˆåŠŸ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169Sat Oct 10 11:33:09 2020 - [warning] SSH is reachable.Sat Oct 10 11:33:09 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 11:33:09 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 11:33:09 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:33:09 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:33:10 2020 - [info] GTID failover mode = 1Sat Oct 10 11:33:10 2020 - [info] Dead Servers:Sat Oct 10 11:33:10 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:10 2020 - [info] Alive Servers:Sat Oct 10 11:33:10 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:33:10 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:33:10 2020 - [info] Alive Slaves:Sat Oct 10 11:33:10 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:10 2020 - [info] GTID ONSat Oct 10 11:33:10 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:10 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:10 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:10 2020 - [info] GTID ONSat Oct 10 11:33:10 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:10 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:10 2020 - [info] Checking slave configurations..Sat Oct 10 11:33:10 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:33:10 2020 - [info] Replication filtering check ok.Sat Oct 10 11:33:10 2020 - [info] Master is down!Sat Oct 10 11:33:10 2020 - [info] Terminating monitoring script.Sat Oct 10 11:33:10 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 11:33:10 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 11:33:10 2020 - [info] Starting master failover.Sat Oct 10 11:33:10 2020 - [info] Sat Oct 10 11:33:10 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 11:33:10 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] GTID failover mode = 1Sat Oct 10 11:33:11 2020 - [info] Dead Servers:Sat Oct 10 11:33:11 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Alive Servers:Sat Oct 10 11:33:11 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:33:11 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:33:11 2020 - [info] Alive Slaves:Sat Oct 10 11:33:11 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:11 2020 - [info] GTID ONSat Oct 10 11:33:11 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:11 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:11 2020 - [info] GTID ONSat Oct 10 11:33:11 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:11 2020 - [info] Starting GTID based failover.Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] ** Phase 1: Configuration Check Phase completed.Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] Forcing shutdown so that applications never connect to the current master..Sat Oct 10 11:33:11 2020 - [info] Executing master IP deactivation script:Sat Oct 10 11:33:11 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 RTNETLINK answers: Cannot assign requested addressFake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Sat Oct 10 11:33:11 2020 - [info] done.Sat Oct 10 11:33:11 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Sat Oct 10 11:33:11 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 3: Master Recovery Phase..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000012:50590Sat Oct 10 11:33:11 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20532-20745Sat Oct 10 11:33:11 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Sat Oct 10 11:33:11 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:11 2020 - [info] GTID ONSat Oct 10 11:33:11 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:11 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000012:18307Sat Oct 10 11:33:11 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20532-20608Sat Oct 10 11:33:11 2020 - [info] Oldest slaves:Sat Oct 10 11:33:11 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:11 2020 - [info] GTID ONSat Oct 10 11:33:11 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 3.3: Determining New Master Phase..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] Searching new master from slaves..Sat Oct 10 11:33:11 2020 - [info] Candidate masters from the configuration file:Sat Oct 10 11:33:11 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:11 2020 - [info] GTID ONSat Oct 10 11:33:11 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:11 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:33:11 2020 - [info] GTID ONSat Oct 10 11:33:11 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:33:11 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:33:11 2020 - [info] Non-candidate masters:Sat Oct 10 11:33:11 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Sat Oct 10 11:33:11 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:33:11 2020 - [info] Starting master failover..Sat Oct 10 11:33:11 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.12(172.16.120.12:3358) (new master) +--172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 3.3: New Master Recovery Phase..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] Waiting all logs to be applied.. Sat Oct 10 11:33:11 2020 - [info] done.Sat Oct 10 11:33:11 2020 - [info] Getting new master&#x27;s binlog name and position..Sat Oct 10 11:33:11 2020 - [info] mysql-bin.000007:3232182Sat Oct 10 11:33:11 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.12&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Sat Oct 10 11:33:11 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3232182, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Sat Oct 10 11:33:11 2020 - [info] Executing master IP activate script:Sat Oct 10 11:33:11 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 RTNETLINK answers: File existsFake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Sat Oct 10 11:33:11 2020 - [info] OK.Sat Oct 10 11:33:11 2020 - [info] ** Finished master recovery successfully.Sat Oct 10 11:33:11 2020 - [info] * Phase 3: Master Recovery Phase completed.Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 4: Slaves Recovery Phase..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Sat Oct 10 11:33:11 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] -- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 78319. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010113310.log if it takes time..Sat Oct 10 11:33:12 2020 - [info] Sat Oct 10 11:33:12 2020 - [info] Log messages from 172.16.120.11 ...Sat Oct 10 11:33:12 2020 - [info] Sat Oct 10 11:33:11 2020 - [info] Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..Sat Oct 10 11:33:11 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 11:33:11 2020 - [info] Slave started.Sat Oct 10 11:33:12 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.11(172.16.120.11:3358). Executed 2 events.Sat Oct 10 11:33:12 2020 - [info] End of log messages from 172.16.120.11.Sat Oct 10 11:33:12 2020 - [info] -- Slave on host 172.16.120.11(172.16.120.11:3358) started.Sat Oct 10 11:33:12 2020 - [info] All new slave servers recovered successfully.Sat Oct 10 11:33:12 2020 - [info] Sat Oct 10 11:33:12 2020 - [info] * Phase 5: New master cleanup phase..Sat Oct 10 11:33:12 2020 - [info] Sat Oct 10 11:33:12 2020 - [info] Resetting slave info on the new master..Sat Oct 10 11:33:13 2020 - [info] 172.16.120.12: Resetting slave info succeeded.Sat Oct 10 11:33:13 2020 - [info] Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 11:33:13 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.12(172.16.120.12:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.12(172.16.120.12:3358) as a new master.172.16.120.12(172.16.120.12:3358): OK: Applying all logs succeeded.172.16.120.12(172.16.120.12:3358): OK: Activated master IP address.172.16.120.11(172.16.120.11:3358): OK: Slave started, replicating from 172.16.120.12(172.16.120.12:3358)172.16.120.12(172.16.120.12:3358): Resetting slave info succeeded.Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 11:33:13 2020 - [info] Sending mail.. slave-1å·²ç»changeåˆ°äº†slave-2 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970root@localhost 11:32:04 [dbms_monitor]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 172.16.120.12 Master_User: repler Master_Port: 3358 Connect_Retry: 1 Master_Log_File: mysql-bin.000007 Read_Master_Log_Pos: 3232182 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 32447 Relay_Master_Log_File: mysql-bin.000007 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 3232182 Relay_Log_Space: 32654 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 120123358 Master_UUID: 45e70f96-fcad-11ea-a2f0-0050563108d2 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20609-20745 Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20745,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)root@localhost 11:34:29 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 |+----+---------------------+2 rows in set (0.00 sec) [ç”¨ä¾‹æµ‹è¯•] masteræŒ‚äº†, ä¸”slaveä¹Ÿæœ‰é—®é¢˜3(éƒ¨åˆ†slave io_thread error) masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 io_thread erroräº† ping_type=CONNECTå¯åŠ¨managerå, è°ƒæ•´masteré˜²ç«å¢™, ç¦æ­¢slave-1è®¿é—®12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 11:58:40 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 11:58:41 2020 - [info] GTID failover mode = 1Sat Oct 10 11:58:41 2020 - [info] Dead Servers:Sat Oct 10 11:58:41 2020 - [info] Alive Servers:Sat Oct 10 11:58:41 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:58:41 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:58:41 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:58:41 2020 - [info] Alive Slaves:Sat Oct 10 11:58:41 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:58:41 2020 - [info] GTID ONSat Oct 10 11:58:41 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:58:41 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:58:41 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:58:41 2020 - [info] GTID ONSat Oct 10 11:58:41 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:58:41 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:58:41 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:58:41 2020 - [info] Checking slave configurations..Sat Oct 10 11:58:41 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:58:41 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 11:58:41 2020 - [info] Replication filtering check ok.Sat Oct 10 11:58:41 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 11:58:41 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 11:58:41 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 11:58:41 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:58:41 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 11:58:41 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 11:58:41 2020 - [info] OK.Sat Oct 10 11:58:41 2020 - [warning] shutdown_script is not defined.Sat Oct 10 11:58:41 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 11:58:41 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 11:58:41 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 11:58:41 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..è°ƒæ•´masteré˜²ç«å¢™, ç¦æ­¢slave-1è®¿é—®1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.13 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROPkill slave-1 io_thread12345678910111213141516171819root@localhost 12:04:35 [dbms_monitor]&gt; show processlist;+-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+| 2 | proxysql | 172.16.120.12:33384 | NULL | Sleep | 9 | | NULL | 0 | 0 || 3 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 4 | proxysql | 172.16.120.10:34072 | NULL | Sleep | 4 | | NULL | 0 | 0 || 6 | proxysql | 172.16.120.11:35090 | NULL | Sleep | 2 | | NULL | 0 | 0 || 7 | repler | 172.16.120.11:35092 | NULL | Binlog Dump GTID | 485 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 8 | repler | 172.16.120.12:33392 | NULL | Binlog Dump GTID | 472 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 110 | proxysql | 172.16.120.10:34094 | NULL | Sleep | 4 | | NULL | 1 | 0 |+-----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+7 rows in set (0.00 sec)root@localhost 12:04:46 [dbms_monitor]&gt; kill 7;Query OK, 0 rows affected (0.00 sec)root@localhost 12:05:20 [dbms_monitor]&gt; insert into monitor_delay values(6,now());Query OK, 1 row affected (0.00 sec) slave-11234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374root@localhost 12:05:02 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 || 3 | 2020-10-10 11:51:01 || 4 | 2020-10-10 11:59:15 || 5 | 2020-10-10 12:04:35 |+----+---------------------+5 rows in set (0.00 sec)root@localhost 12:07:32 [dbms_monitor]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Reconnecting after a failed master event read Master_Host: 172.16.120.10 Master_User: repler Master_Port: 3358 Connect_Retry: 1 Master_Log_File: mysql-bin.000014 Read_Master_Log_Pos: 778 Relay_Log_File: mysql-relay-bin.000003 Relay_Log_Pos: 605 Relay_Master_Log_File: mysql-bin.000014 Slave_IO_Running: Connecting Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 778 Relay_Log_Space: 1317 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 2003 Last_IO_Error: error reconnecting to master &#x27;repler@172.16.120.10:3358&#x27; - retry-time: 1 retries: 2 Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 120103358 Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: 201010 12:06:57 Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20748 Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20748,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) slave-2123456789101112root@localhost 12:04:42 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 || 3 | 2020-10-10 11:51:01 || 4 | 2020-10-10 11:59:15 || 5 | 2020-10-10 12:04:35 || 6 | 2020-10-10 12:05:30 |+----+---------------------+6 rows in set (0.00 sec) å…³é—­master12root@localhost 12:21:24 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¼šfailoverä¸”æˆåŠŸ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186Sat Oct 10 12:11:18 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:11:18 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTSat Oct 10 12:11:18 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 12:11:19 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 12:11:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:11:21 2020 - [warning] Connection failed 2 time(s)..Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 12:11:24 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 12:11:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:11:24 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 12:11:27 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:11:27 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 12:11:27 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 12:11:27 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 12:11:27 2020 - [warning] SSH is reachable.Sat Oct 10 12:11:27 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 12:11:27 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 12:11:27 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 12:11:27 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 12:11:28 2020 - [info] GTID failover mode = 1Sat Oct 10 12:11:28 2020 - [info] Dead Servers:Sat Oct 10 12:11:28 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:28 2020 - [info] Alive Servers:Sat Oct 10 12:11:28 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:11:28 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:11:28 2020 - [info] Alive Slaves:Sat Oct 10 12:11:28 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:28 2020 - [info] GTID ONSat Oct 10 12:11:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:28 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:28 2020 - [info] GTID ONSat Oct 10 12:11:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:28 2020 - [info] Checking slave configurations..Sat Oct 10 12:11:28 2020 - [info] Checking replication filtering settings..Sat Oct 10 12:11:28 2020 - [info] Replication filtering check ok.Sat Oct 10 12:11:28 2020 - [info] Master is down!Sat Oct 10 12:11:28 2020 - [info] Terminating monitoring script.Sat Oct 10 12:11:28 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 12:11:28 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 12:11:28 2020 - [info] Starting master failover.Sat Oct 10 12:11:28 2020 - [info] Sat Oct 10 12:11:28 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 12:11:28 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] GTID failover mode = 1Sat Oct 10 12:11:29 2020 - [info] Dead Servers:Sat Oct 10 12:11:29 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Checking master reachability via MySQL(double check)...Sat Oct 10 12:11:29 2020 - [info] ok.Sat Oct 10 12:11:29 2020 - [info] Alive Servers:Sat Oct 10 12:11:29 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:11:29 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:11:29 2020 - [info] Alive Slaves:Sat Oct 10 12:11:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:29 2020 - [info] GTID ONSat Oct 10 12:11:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:29 2020 - [info] GTID ONSat Oct 10 12:11:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:29 2020 - [info] Starting GTID based failover.Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] ** Phase 1: Configuration Check Phase completed.Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] Forcing shutdown so that applications never connect to the current master..Sat Oct 10 12:11:29 2020 - [info] Executing master IP deactivation script:Sat Oct 10 12:11:29 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 Fake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Sat Oct 10 12:11:29 2020 - [info] done.Sat Oct 10 12:11:29 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Sat Oct 10 12:11:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] * Phase 3: Master Recovery Phase..Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000014:1070Sat Oct 10 12:11:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20749Sat Oct 10 12:11:29 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Sat Oct 10 12:11:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:29 2020 - [info] GTID ONSat Oct 10 12:11:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:29 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000014:778Sat Oct 10 12:11:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20747-20748Sat Oct 10 12:11:29 2020 - [info] Oldest slaves:Sat Oct 10 12:11:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:29 2020 - [info] GTID ONSat Oct 10 12:11:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] * Phase 3.3: Determining New Master Phase..Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] Searching new master from slaves..Sat Oct 10 12:11:29 2020 - [info] Candidate masters from the configuration file:Sat Oct 10 12:11:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:29 2020 - [info] GTID ONSat Oct 10 12:11:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:11:29 2020 - [info] GTID ONSat Oct 10 12:11:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:11:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:11:29 2020 - [info] Non-candidate masters:Sat Oct 10 12:11:29 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Sat Oct 10 12:11:29 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:11:29 2020 - [info] Starting master failover..Sat Oct 10 12:11:29 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.12(172.16.120.12:3358) (new master) +--172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] * Phase 3.3: New Master Recovery Phase..Sat Oct 10 12:11:29 2020 - [info] Sat Oct 10 12:11:29 2020 - [info] Waiting all logs to be applied.. Sat Oct 10 12:11:29 2020 - [info] done.Sat Oct 10 12:11:29 2020 - [info] Getting new master&#x27;s binlog name and position..Sat Oct 10 12:11:29 2020 - [info] mysql-bin.000007:3233250Sat Oct 10 12:11:29 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.12&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Sat Oct 10 12:11:29 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3233250, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20749,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Sat Oct 10 12:11:29 2020 - [info] Executing master IP activate script:Sat Oct 10 12:11:29 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 RTNETLINK answers: File existsFake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Sat Oct 10 12:11:30 2020 - [info] OK.Sat Oct 10 12:11:30 2020 - [info] ** Finished master recovery successfully.Sat Oct 10 12:11:30 2020 - [info] * Phase 3: Master Recovery Phase completed.Sat Oct 10 12:11:30 2020 - [info] Sat Oct 10 12:11:30 2020 - [info] * Phase 4: Slaves Recovery Phase..Sat Oct 10 12:11:30 2020 - [info] Sat Oct 10 12:11:30 2020 - [info] Sat Oct 10 12:11:30 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Sat Oct 10 12:11:30 2020 - [info] Sat Oct 10 12:11:30 2020 - [info] -- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 81557. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010121128.log if it takes time..Sat Oct 10 12:11:31 2020 - [info] Sat Oct 10 12:11:31 2020 - [info] Log messages from 172.16.120.11 ...Sat Oct 10 12:11:31 2020 - [info] Sat Oct 10 12:11:30 2020 - [info] Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..Sat Oct 10 12:11:30 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 12:11:30 2020 - [info] Slave started.Sat Oct 10 12:11:30 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20749,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.11(172.16.120.11:3358). Executed 2 events.Sat Oct 10 12:11:31 2020 - [info] End of log messages from 172.16.120.11.Sat Oct 10 12:11:31 2020 - [info] -- Slave on host 172.16.120.11(172.16.120.11:3358) started.Sat Oct 10 12:11:31 2020 - [info] All new slave servers recovered successfully.Sat Oct 10 12:11:31 2020 - [info] Sat Oct 10 12:11:31 2020 - [info] * Phase 5: New master cleanup phase..Sat Oct 10 12:11:31 2020 - [info] Sat Oct 10 12:11:31 2020 - [info] Resetting slave info on the new master..Sat Oct 10 12:11:31 2020 - [info] 172.16.120.12: Resetting slave info succeeded.Sat Oct 10 12:11:31 2020 - [info] Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 12:11:31 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.12(172.16.120.12:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.12(172.16.120.12:3358) as a new master.172.16.120.12(172.16.120.12:3358): OK: Applying all logs succeeded.172.16.120.12(172.16.120.12:3358): OK: Activated master IP address.172.16.120.11(172.16.120.11:3358): OK: Slave started, replicating from 172.16.120.12(172.16.120.12:3358)172.16.120.12(172.16.120.12:3358): Resetting slave info succeeded.Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 12:11:31 2020 - [info] Sending mail.. ping_type=INSERTå¯åŠ¨managerå, è°ƒæ•´masteré˜²ç«å¢™, ç¦æ­¢slave-1è®¿é—®12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 12:14:59 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 12:15:00 2020 - [info] GTID failover mode = 1Sat Oct 10 12:15:00 2020 - [info] Dead Servers:Sat Oct 10 12:15:00 2020 - [info] Alive Servers:Sat Oct 10 12:15:00 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:15:00 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:15:00 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:15:00 2020 - [info] Alive Slaves:Sat Oct 10 12:15:00 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:15:00 2020 - [info] GTID ONSat Oct 10 12:15:00 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:15:00 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:15:00 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:15:00 2020 - [info] GTID ONSat Oct 10 12:15:00 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:15:00 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:15:00 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:15:00 2020 - [info] Checking slave configurations..Sat Oct 10 12:15:00 2020 - [info] Checking replication filtering settings..Sat Oct 10 12:15:00 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 12:15:00 2020 - [info] Replication filtering check ok.Sat Oct 10 12:15:00 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 12:15:00 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 12:15:00 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 12:15:00 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:15:00 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 12:15:00 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 12:15:00 2020 - [info] OK.Sat Oct 10 12:15:00 2020 - [warning] shutdown_script is not defined.Sat Oct 10 12:15:00 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 12:15:00 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 12:15:00 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 12:15:01 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond.. è°ƒæ•´masteré˜²ç«å¢™, ç¦æ­¢slave-1è®¿é—®1234567IPTABLES=&quot;/sbin/iptables&quot;$IPTABLES -F$IPTABLES -A INPUT -p icmp --icmp-type any -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.10 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.13 -j ACCEPT$IPTABLES -A INPUT -p tcp -s 172.16.120.12 -j ACCEPT$IPTABLES -A INPUT -p tcp --syn -j DROP åœ¨master kill slave-1 io_thread12345678910111213141516171819202122232425262728293031root@localhost 12:13:11 [dbms_monitor]&gt; show processlist;+----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+| Id | User | Host | db | Command | Time | State | Info | Rows_sent | Rows_examined |+----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+| 2 | proxysql | 172.16.120.12:33486 | NULL | Sleep | 9 | | NULL | 0 | 0 || 3 | root | localhost | dbms_monitor | Query | 0 | starting | show processlist | 0 | 0 || 4 | proxysql | 172.16.120.10:34148 | NULL | Sleep | 4 | | NULL | 0 | 0 || 5 | proxysql | 172.16.120.11:35190 | NULL | Sleep | 2 | | NULL | 0 | 0 || 8 | repler | 172.16.120.11:35200 | NULL | Binlog Dump GTID | 428 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 9 | repler | 172.16.120.12:33490 | NULL | Binlog Dump GTID | 379 | Master has sent all binlog to slave; waiting for more updates | NULL | 0 | 0 || 13 | mha | 172.16.120.13:40526 | NULL | Sleep | 0 | | NULL | 0 | 0 || 17 | proxysql | 172.16.120.10:34164 | NULL | Sleep | 14 | | NULL | 1 | 0 |+----+----------+---------------------+--------------+------------------+------+---------------------------------------------------------------+------------------+-----------+---------------+8 rows in set (0.00 sec)root@localhost 12:20:46 [dbms_monitor]&gt; kill 8;Query OK, 0 rows affected (0.00 sec)root@localhost 12:20:59 [dbms_monitor]&gt; truncate table monitor_delay;Query OK, 0 rows affected (0.01 sec)root@localhost 12:21:10 [dbms_monitor]&gt; insert into monitor_delay values(88,now());Query OK, 1 row affected (0.00 sec)root@localhost 12:21:17 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 88 | 2020-10-10 12:21:17 |+----+---------------------+1 row in set (0.00 sec) slave-11234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374root@localhost 12:21:29 [dbms_monitor]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Reconnecting after a failed master event read Master_Host: 172.16.120.10 Master_User: repler Master_Port: 3358 Connect_Retry: 1 Master_Log_File: mysql-bin.000015 Read_Master_Log_Pos: 85472 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 85645 Relay_Master_Log_File: mysql-bin.000015 Slave_IO_Running: Connecting Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 85472 Relay_Log_Space: 85852 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 2003 Last_IO_Error: error reconnecting to master &#x27;repler@172.16.120.10:3358&#x27; - retry-time: 1 retries: 1 Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 120103358 Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: 201010 12:21:59 Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21111 Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21111,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)root@localhost 12:22:03 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 || 3 | 2020-10-10 11:51:01 || 4 | 2020-10-10 11:59:15 || 5 | 2020-10-10 12:04:35 || 6 | 2020-10-10 12:05:30 |+----+---------------------+6 rows in set (0.00 sec) slave-21234567root@localhost 12:21:32 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 88 | 2020-10-10 12:21:17 |+----+---------------------+1 row in set (0.00 sec) å…³é—­master12root@localhost 12:21:24 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¼šfailoverä¸”æˆåŠŸ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184Sat Oct 10 12:22:43 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Sat Oct 10 12:22:43 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 12:22:43 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTSat Oct 10 12:22:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 12:22:46 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:22:46 2020 - [warning] Connection failed 2 time(s)..Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 12:22:48 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 12:22:49 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:22:49 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 12:22:52 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 12:22:52 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 12:22:52 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 12:22:52 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 12:22:52 2020 - [warning] SSH is reachable.Sat Oct 10 12:22:52 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 12:22:52 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 12:22:52 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 12:22:52 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 12:22:53 2020 - [info] GTID failover mode = 1Sat Oct 10 12:22:53 2020 - [info] Dead Servers:Sat Oct 10 12:22:53 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:53 2020 - [info] Alive Servers:Sat Oct 10 12:22:53 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:22:53 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:22:53 2020 - [info] Alive Slaves:Sat Oct 10 12:22:53 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:53 2020 - [info] GTID ONSat Oct 10 12:22:53 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:53 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:53 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:53 2020 - [info] GTID ONSat Oct 10 12:22:53 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:53 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:53 2020 - [info] Checking slave configurations..Sat Oct 10 12:22:53 2020 - [info] Checking replication filtering settings..Sat Oct 10 12:22:53 2020 - [info] Replication filtering check ok.Sat Oct 10 12:22:53 2020 - [info] Master is down!Sat Oct 10 12:22:53 2020 - [info] Terminating monitoring script.Sat Oct 10 12:22:53 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 12:22:53 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 12:22:53 2020 - [info] Starting master failover.Sat Oct 10 12:22:53 2020 - [info] Sat Oct 10 12:22:53 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 12:22:53 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] GTID failover mode = 1Sat Oct 10 12:22:54 2020 - [info] Dead Servers:Sat Oct 10 12:22:54 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Alive Servers:Sat Oct 10 12:22:54 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:22:54 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:22:54 2020 - [info] Alive Slaves:Sat Oct 10 12:22:54 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:54 2020 - [info] GTID ONSat Oct 10 12:22:54 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:54 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:54 2020 - [info] GTID ONSat Oct 10 12:22:54 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:54 2020 - [info] Starting GTID based failover.Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] ** Phase 1: Configuration Check Phase completed.Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] Forcing shutdown so that applications never connect to the current master..Sat Oct 10 12:22:54 2020 - [info] Executing master IP deactivation script:Sat Oct 10 12:22:54 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 RTNETLINK answers: Cannot assign requested addressFake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Sat Oct 10 12:22:54 2020 - [info] done.Sat Oct 10 12:22:54 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Sat Oct 10 12:22:54 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 3: Master Recovery Phase..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000015:110146Sat Oct 10 12:22:54 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21216Sat Oct 10 12:22:54 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Sat Oct 10 12:22:54 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:54 2020 - [info] GTID ONSat Oct 10 12:22:54 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:54 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000015:85472Sat Oct 10 12:22:54 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20750-21111Sat Oct 10 12:22:54 2020 - [info] Oldest slaves:Sat Oct 10 12:22:54 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:54 2020 - [info] GTID ONSat Oct 10 12:22:54 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 3.3: Determining New Master Phase..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] Searching new master from slaves..Sat Oct 10 12:22:54 2020 - [info] Candidate masters from the configuration file:Sat Oct 10 12:22:54 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:54 2020 - [info] GTID ONSat Oct 10 12:22:54 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:54 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 12:22:54 2020 - [info] GTID ONSat Oct 10 12:22:54 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 12:22:54 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 12:22:54 2020 - [info] Non-candidate masters:Sat Oct 10 12:22:54 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Sat Oct 10 12:22:54 2020 - [info] New master is 172.16.120.12(172.16.120.12:3358)Sat Oct 10 12:22:54 2020 - [info] Starting master failover..Sat Oct 10 12:22:54 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.12(172.16.120.12:3358) (new master) +--172.16.120.11(172.16.120.11:3358)Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 3.3: New Master Recovery Phase..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] Waiting all logs to be applied.. Sat Oct 10 12:22:54 2020 - [info] done.Sat Oct 10 12:22:54 2020 - [info] Getting new master&#x27;s binlog name and position..Sat Oct 10 12:22:54 2020 - [info] mysql-bin.000007:3342407Sat Oct 10 12:22:54 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.12&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Sat Oct 10 12:22:54 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000007, 3342407, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21216,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Sat Oct 10 12:22:54 2020 - [info] Executing master IP activate script:Sat Oct 10 12:22:54 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.12 --new_master_ip=172.16.120.12 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.12 RTNETLINK answers: File existsFake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Sat Oct 10 12:22:54 2020 - [info] OK.Sat Oct 10 12:22:54 2020 - [info] ** Finished master recovery successfully.Sat Oct 10 12:22:54 2020 - [info] * Phase 3: Master Recovery Phase completed.Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 4: Slaves Recovery Phase..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Sat Oct 10 12:22:54 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] -- Slave recovery on host 172.16.120.11(172.16.120.11:3358) started, pid: 82756. Check tmp log /masterha/cls_new//172.16.120.11_3358_20201010122253.log if it takes time..Sat Oct 10 12:22:55 2020 - [info] Sat Oct 10 12:22:55 2020 - [info] Log messages from 172.16.120.11 ...Sat Oct 10 12:22:55 2020 - [info] Sat Oct 10 12:22:54 2020 - [info] Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..Sat Oct 10 12:22:54 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 12:22:54 2020 - [info] Slave started.Sat Oct 10 12:22:55 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-21216,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.11(172.16.120.11:3358). Executed 2 events.Sat Oct 10 12:22:55 2020 - [info] End of log messages from 172.16.120.11.Sat Oct 10 12:22:55 2020 - [info] -- Slave on host 172.16.120.11(172.16.120.11:3358) started.Sat Oct 10 12:22:55 2020 - [info] All new slave servers recovered successfully.Sat Oct 10 12:22:55 2020 - [info] Sat Oct 10 12:22:55 2020 - [info] * Phase 5: New master cleanup phase..Sat Oct 10 12:22:55 2020 - [info] Sat Oct 10 12:22:55 2020 - [info] Resetting slave info on the new master..Sat Oct 10 12:22:55 2020 - [info] 172.16.120.12: Resetting slave info succeeded.Sat Oct 10 12:22:55 2020 - [info] Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 12:22:55 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.12(172.16.120.12:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.12(172.16.120.12:3358) as a new master.172.16.120.12(172.16.120.12:3358): OK: Applying all logs succeeded.172.16.120.12(172.16.120.12:3358): OK: Activated master IP address.172.16.120.11(172.16.120.11:3358): OK: Slave started, replicating from 172.16.120.12(172.16.120.12:3358)172.16.120.12(172.16.120.12:3358): Resetting slave info succeeded.Master failover to 172.16.120.12(172.16.120.12:3358) completed successfully.Sat Oct 10 12:22:55 2020 - [info] Sending mail.. [ç”¨ä¾‹æµ‹è¯•] masteræŒ‚äº†, ä¸”slaveä¹Ÿæœ‰é—®é¢˜4(éƒ¨åˆ†slave sql_thread stop) masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 sql_thread stopäº† ping_type=CONNECTå¯åŠ¨managerå, å…³é—­slave-1 sql_thread12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 11:43:34 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 11:43:35 2020 - [info] GTID failover mode = 1Sat Oct 10 11:43:35 2020 - [info] Dead Servers:Sat Oct 10 11:43:35 2020 - [info] Alive Servers:Sat Oct 10 11:43:35 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:43:35 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:43:35 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:43:35 2020 - [info] Alive Slaves:Sat Oct 10 11:43:35 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:43:35 2020 - [info] GTID ONSat Oct 10 11:43:35 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:43:35 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:43:35 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:43:35 2020 - [info] GTID ONSat Oct 10 11:43:35 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:43:35 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:43:35 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:43:35 2020 - [info] Checking slave configurations..Sat Oct 10 11:43:35 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:43:35 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 11:43:35 2020 - [info] Replication filtering check ok.Sat Oct 10 11:43:35 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 11:43:35 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 11:43:35 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 11:43:35 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:43:35 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 11:43:35 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 11:43:35 2020 - [info] OK.Sat Oct 10 11:43:35 2020 - [warning] shutdown_script is not defined.Sat Oct 10 11:43:35 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 11:43:35 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 11:43:35 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 11:43:35 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..å…³é—­slave-1 sql_thread123456789101112131415161718192021222324root@localhost 11:44:26 [dbms_monitor]&gt; stop slave sql_thread;Query OK, 0 rows affected (0.01 sec)root@localhost 11:50:00 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;PAGER set to &#x27;cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;&#x27;root@localhost 11:50:04 [dbms_monitor]&gt; show slave status\\G Master_Log_File: mysql-bin.000013 Read_Master_Log_Pos: 194 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 367 Relay_Master_Log_File: mysql-bin.000013 Slave_IO_Running: Yes Slave_SQL_Running: No Last_Errno: 0 Last_Error: Exec_Master_Log_Pos: 194 Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Slave_SQL_Running_State: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 1 row in set (0.00 sec)å…³é—­sql_threadå managerä»ç„¶æ­£å¸¸ å…³é—­master12345root@localhost 11:40:00 [dbms_monitor]&gt; insert into monitor_delay values(3,now());Query OK, 1 row affected (0.00 sec)root@localhost 11:51:01 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec)slave-112345678root@localhost 11:50:04 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 |+----+---------------------+2 rows in set (0.00 sec)slave-2123456789root@localhost 11:36:17 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 || 3 | 2020-10-10 11:51:01 |+----+---------------------+3 rows in set (0.00 sec) ç»“è®º: ä¼šfailoverä¸”æˆåŠŸ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207Sat Oct 10 11:51:18 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:51:18 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTSat Oct 10 11:51:18 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 11:51:18 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 11:51:18 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 11:51:21 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:51:21 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 11:51:24 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:51:24 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 11:51:27 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 11:51:27 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 11:51:27 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 11:51:27 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 11:51:27 2020 - [warning] SSH is reachable.Sat Oct 10 11:51:27 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 11:51:27 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 11:51:27 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:51:27 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 11:51:28 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:51:28 2020 - [info] GTID failover mode = 1Sat Oct 10 11:51:28 2020 - [info] Dead Servers:Sat Oct 10 11:51:28 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:28 2020 - [info] Alive Servers:Sat Oct 10 11:51:28 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:51:28 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:51:28 2020 - [info] Alive Slaves:Sat Oct 10 11:51:28 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:28 2020 - [info] GTID ONSat Oct 10 11:51:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:28 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:28 2020 - [info] GTID ONSat Oct 10 11:51:28 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:28 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:28 2020 - [info] Checking slave configurations..Sat Oct 10 11:51:28 2020 - [info] Checking replication filtering settings..Sat Oct 10 11:51:28 2020 - [info] Replication filtering check ok.Sat Oct 10 11:51:28 2020 - [info] Master is down!Sat Oct 10 11:51:28 2020 - [info] Terminating monitoring script.Sat Oct 10 11:51:28 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 11:51:28 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 11:51:28 2020 - [info] Starting master failover.Sat Oct 10 11:51:28 2020 - [info] Sat Oct 10 11:51:28 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 11:51:28 2020 - [info] Sat Oct 10 11:51:29 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:51:29 2020 - [info] GTID failover mode = 1Sat Oct 10 11:51:29 2020 - [info] Dead Servers:Sat Oct 10 11:51:29 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Checking master reachability via MySQL(double check)...Sat Oct 10 11:51:29 2020 - [info] ok.Sat Oct 10 11:51:29 2020 - [info] Alive Servers:Sat Oct 10 11:51:29 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:51:29 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:51:29 2020 - [info] Alive Slaves:Sat Oct 10 11:51:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] Starting SQL thread on 172.16.120.11(172.16.120.11:3358) ..Sat Oct 10 11:51:29 2020 - [info] done.Sat Oct 10 11:51:29 2020 - [info] Starting GTID based failover.Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] ** Phase 1: Configuration Check Phase completed.Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] Forcing shutdown so that applications never connect to the current master..Sat Oct 10 11:51:29 2020 - [info] Executing master IP deactivation script:Sat Oct 10 11:51:29 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 RTNETLINK answers: Cannot assign requested addressFake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Sat Oct 10 11:51:29 2020 - [info] done.Sat Oct 10 11:51:29 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Sat Oct 10 11:51:29 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 3: Master Recovery Phase..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000013:486Sat Oct 10 11:51:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20746Sat Oct 10 11:51:29 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Sat Oct 10 11:51:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000013:486Sat Oct 10 11:51:29 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:20746Sat Oct 10 11:51:29 2020 - [info] Oldest slaves:Sat Oct 10 11:51:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 3.3: Determining New Master Phase..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] Searching new master from slaves..Sat Oct 10 11:51:29 2020 - [info] Candidate masters from the configuration file:Sat Oct 10 11:51:29 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 11:51:29 2020 - [info] GTID ONSat Oct 10 11:51:29 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 11:51:29 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 11:51:29 2020 - [info] Non-candidate masters:Sat Oct 10 11:51:29 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Sat Oct 10 11:51:29 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)Sat Oct 10 11:51:29 2020 - [info] Starting master failover..Sat Oct 10 11:51:29 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.11(172.16.120.11:3358) (new master) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 3.3: New Master Recovery Phase..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] Waiting all logs to be applied.. Sat Oct 10 11:51:29 2020 - [info] done.Sat Oct 10 11:51:29 2020 - [info] Replicating from the latest slave 172.16.120.12(172.16.120.12:3358) and waiting to apply..Sat Oct 10 11:51:29 2020 - [info] Waiting all logs to be applied on the latest slave.. Sat Oct 10 11:51:29 2020 - [info] Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..Sat Oct 10 11:51:29 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 11:51:29 2020 - [info] Slave started.Sat Oct 10 11:51:29 2020 - [info] Waiting to execute all relay logs on 172.16.120.11(172.16.120.11:3358)..Sat Oct 10 11:51:29 2020 - [info] master_pos_wait(mysql-bin.000007:3232449) completed on 172.16.120.11(172.16.120.11:3358). Executed 1 events.Sat Oct 10 11:51:29 2020 - [info] done.Sat Oct 10 11:51:29 2020 - [info] done.Sat Oct 10 11:51:29 2020 - [info] Getting new master&#x27;s binlog name and position..Sat Oct 10 11:51:29 2020 - [info] mysql-bin.000010:141523Sat Oct 10 11:51:29 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.11&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Sat Oct 10 11:51:29 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000010, 141523, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20746,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Sat Oct 10 11:51:29 2020 - [info] Executing master IP activate script:Sat Oct 10 11:51:29 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 Fake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Sat Oct 10 11:51:29 2020 - [info] OK.Sat Oct 10 11:51:29 2020 - [info] ** Finished master recovery successfully.Sat Oct 10 11:51:29 2020 - [info] * Phase 3: Master Recovery Phase completed.Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 4: Slaves Recovery Phase..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Sat Oct 10 11:51:29 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 79937. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201010115128.log if it takes time..Sat Oct 10 11:51:30 2020 - [info] Sat Oct 10 11:51:30 2020 - [info] Log messages from 172.16.120.12 ...Sat Oct 10 11:51:30 2020 - [info] Sat Oct 10 11:51:29 2020 - [info] Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..Sat Oct 10 11:51:29 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 11:51:29 2020 - [info] Slave started.Sat Oct 10 11:51:29 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-20746,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.Sat Oct 10 11:51:30 2020 - [info] End of log messages from 172.16.120.12.Sat Oct 10 11:51:30 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.Sat Oct 10 11:51:30 2020 - [info] All new slave servers recovered successfully.Sat Oct 10 11:51:30 2020 - [info] Sat Oct 10 11:51:30 2020 - [info] * Phase 5: New master cleanup phase..Sat Oct 10 11:51:30 2020 - [info] Sat Oct 10 11:51:30 2020 - [info] Resetting slave info on the new master..Sat Oct 10 11:51:30 2020 - [info] 172.16.120.11: Resetting slave info succeeded.Sat Oct 10 11:51:30 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Sat Oct 10 11:51:30 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.11(172.16.120.11:3358) as a new master.172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Sat Oct 10 11:51:30 2020 - [info] Sending mail.. slave-1æˆäº†new master123456789101112root@localhost 11:51:06 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-10-10 11:21:39 || 2 | 2020-10-10 11:31:45 || 3 | 2020-10-10 11:51:01 |+----+---------------------+3 rows in set (0.00 sec)root@localhost 11:54:53 [dbms_monitor]&gt; show slave status;Empty set (0.00 sec) ping_type=INSERTå¯åŠ¨managerå, å…³é—­slave-1 sql_thread12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 14:06:09 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 14:06:10 2020 - [info] GTID failover mode = 1Sat Oct 10 14:06:10 2020 - [info] Dead Servers:Sat Oct 10 14:06:10 2020 - [info] Alive Servers:Sat Oct 10 14:06:10 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:06:10 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:06:10 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:06:10 2020 - [info] Alive Slaves:Sat Oct 10 14:06:10 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:06:10 2020 - [info] GTID ONSat Oct 10 14:06:10 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:06:10 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:06:10 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:06:10 2020 - [info] GTID ONSat Oct 10 14:06:10 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:06:10 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:06:10 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:06:10 2020 - [info] Checking slave configurations..Sat Oct 10 14:06:10 2020 - [info] Checking replication filtering settings..Sat Oct 10 14:06:10 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 14:06:10 2020 - [info] Replication filtering check ok.Sat Oct 10 14:06:10 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 14:06:10 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 14:06:10 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 14:06:10 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:06:10 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 14:06:10 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 14:06:10 2020 - [info] OK.Sat Oct 10 14:06:10 2020 - [warning] shutdown_script is not defined.Sat Oct 10 14:06:10 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 14:06:10 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 14:06:10 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 14:06:10 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..å…³é—­slave-1 sql_thread123456789101112131415161718192021222324252627root@localhost 14:10:20 [dbms_monitor]&gt; stop slave sql_thread;Query OK, 0 rows affected (0.03 sec)root@localhost 14:22:34 [dbms_monitor]&gt; pager cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;PAGER set to &#x27;cat - | grep -E &#x27;Master_Log_File|Relay_Master_Log_File|Read_Master_Log_Pos|Exec_Master_Log_Pos|Slave_IO_Running|Slave_SQL_Running|Slave_SQL_Running_State|Last|Relay_Log_File|Relay_Log_Pos&#x27;&#x27;root@localhost 14:22:57 [dbms_monitor]&gt; show slave status\\G Master_Log_File: mysql-bin.000016 Read_Master_Log_Pos: 238476 Relay_Log_File: mysql-relay-bin.000004 Relay_Log_Pos: 211835 Relay_Master_Log_File: mysql-bin.000016 Slave_IO_Running: Yes Slave_SQL_Running: No Last_Errno: 0 Last_Error: Exec_Master_Log_Pos: 211756 Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Slave_SQL_Running_State: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 1 row in set (0.00 sec)root@localhost 14:22:57 [dbms_monitor]&gt; pagerDefault pager wasn&#x27;t set, using stdout.master1234567891011root@localhost 14:22:09 [dbms_monitor]&gt; insert into monitor_delay values(90, now());Query OK, 1 row affected (0.00 sec)root@localhost 14:22:29 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 88 | 2020-10-10 12:21:17 || 90 | 2020-10-10 14:22:29 |+----+---------------------+2 rows in set (0.01 sec)slave-11234567root@localhost 14:22:57 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 88 | 2020-10-10 12:21:17 |+----+---------------------+1 row in set (0.00 sec)slave-212345678root@localhost 14:22:36 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 88 | 2020-10-10 12:21:17 || 90 | 2020-10-10 14:22:29 |+----+---------------------+2 rows in set (0.00 sec) å…³é—­sql_threadå managerä»ç„¶æ­£å¸¸ å…³é—­master12root@localhost 14:23:38 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¼šfailoverä¸”æˆåŠŸ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204Sat Oct 10 14:25:05 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Sat Oct 10 14:25:05 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTSat Oct 10 14:25:05 2020 - [info] Executing SSH check script: exit 0Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Sat Oct 10 14:25:06 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 14:25:06 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 14:25:08 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:25:08 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 14:25:11 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:25:11 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 14:25:14 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:25:14 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 14:25:14 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 14:25:14 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 14:25:14 2020 - [warning] SSH is reachable.Sat Oct 10 14:25:14 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 14:25:14 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 14:25:14 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 14:25:14 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 14:25:15 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:25:15 2020 - [info] GTID failover mode = 1Sat Oct 10 14:25:15 2020 - [info] Dead Servers:Sat Oct 10 14:25:15 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:15 2020 - [info] Alive Servers:Sat Oct 10 14:25:15 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:25:15 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:25:15 2020 - [info] Alive Slaves:Sat Oct 10 14:25:15 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:15 2020 - [info] GTID ONSat Oct 10 14:25:15 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:15 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:15 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:15 2020 - [info] GTID ONSat Oct 10 14:25:15 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:15 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:15 2020 - [info] Checking slave configurations..Sat Oct 10 14:25:15 2020 - [info] Checking replication filtering settings..Sat Oct 10 14:25:15 2020 - [info] Replication filtering check ok.Sat Oct 10 14:25:15 2020 - [info] Master is down!Sat Oct 10 14:25:15 2020 - [info] Terminating monitoring script.Sat Oct 10 14:25:15 2020 - [info] Got exit code 20 (Master dead).Sat Oct 10 14:25:15 2020 - [info] MHA::MasterFailover version 0.58.Sat Oct 10 14:25:15 2020 - [info] Starting master failover.Sat Oct 10 14:25:15 2020 - [info] Sat Oct 10 14:25:15 2020 - [info] * Phase 1: Configuration Check Phase..Sat Oct 10 14:25:15 2020 - [info] Sat Oct 10 14:25:16 2020 - [warning] SQL Thread is stopped(no error) on 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:25:16 2020 - [info] GTID failover mode = 1Sat Oct 10 14:25:16 2020 - [info] Dead Servers:Sat Oct 10 14:25:16 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Alive Servers:Sat Oct 10 14:25:16 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:25:16 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:25:16 2020 - [info] Alive Slaves:Sat Oct 10 14:25:16 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] Starting SQL thread on 172.16.120.11(172.16.120.11:3358) ..Sat Oct 10 14:25:16 2020 - [info] done.Sat Oct 10 14:25:16 2020 - [info] Starting GTID based failover.Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] ** Phase 1: Configuration Check Phase completed.Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] * Phase 2: Dead Master Shutdown Phase..Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] Forcing shutdown so that applications never connect to the current master..Sat Oct 10 14:25:16 2020 - [info] Executing master IP deactivation script:Sat Oct 10 14:25:16 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --command=stopssh --ssh_user=root Disabling the VIP on old master: 172.16.120.10 RTNETLINK answers: Cannot assign requested addressFake!!! åŸä¸»åº“ rpl_semi_sync_master_enabled=0 rpl_semi_sync_slave_enabled=1 Sat Oct 10 14:25:16 2020 - [info] done.Sat Oct 10 14:25:16 2020 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.Sat Oct 10 14:25:16 2020 - [info] * Phase 2: Dead Master Shutdown Phase completed.Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] * Phase 3: Master Recovery Phase..Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] * Phase 3.1: Getting Latest Slaves Phase..Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] The latest binary log file/position on all slaves is mysql-bin.000016:268346Sat Oct 10 14:25:16 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:21217-22354Sat Oct 10 14:25:16 2020 - [info] Latest slaves (Slaves that received relay log files to the latest):Sat Oct 10 14:25:16 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] The oldest binary log file/position on all slaves is mysql-bin.000016:268346Sat Oct 10 14:25:16 2020 - [info] Retrieved Gtid Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:21217-22354Sat Oct 10 14:25:16 2020 - [info] Oldest slaves:Sat Oct 10 14:25:16 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] * Phase 3.3: Determining New Master Phase..Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] Searching new master from slaves..Sat Oct 10 14:25:16 2020 - [info] Candidate masters from the configuration file:Sat Oct 10 14:25:16 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:25:16 2020 - [info] GTID ONSat Oct 10 14:25:16 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:25:16 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:25:16 2020 - [info] Non-candidate masters:Sat Oct 10 14:25:16 2020 - [info] Searching from candidate_master slaves which have received the latest relay log events..Sat Oct 10 14:25:16 2020 - [info] New master is 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:25:16 2020 - [info] Starting master failover..Sat Oct 10 14:25:16 2020 - [info] From:172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)To:172.16.120.11(172.16.120.11:3358) (new master) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] * Phase 3.3: New Master Recovery Phase..Sat Oct 10 14:25:16 2020 - [info] Sat Oct 10 14:25:16 2020 - [info] Waiting all logs to be applied.. Sat Oct 10 14:25:17 2020 - [info] done.Sat Oct 10 14:25:17 2020 - [info] Replicating from the latest slave 172.16.120.12(172.16.120.12:3358) and waiting to apply..Sat Oct 10 14:25:17 2020 - [info] Waiting all logs to be applied on the latest slave.. Sat Oct 10 14:25:17 2020 - [info] Resetting slave 172.16.120.11(172.16.120.11:3358) and starting replication from the new master 172.16.120.12(172.16.120.12:3358)..Sat Oct 10 14:25:17 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 14:25:17 2020 - [info] Slave started.Sat Oct 10 14:25:17 2020 - [info] Waiting to execute all relay logs on 172.16.120.11(172.16.120.11:3358)..Sat Oct 10 14:25:17 2020 - [info] master_pos_wait(mysql-bin.000007:3608644) completed on 172.16.120.11(172.16.120.11:3358). Executed 1 events.Sat Oct 10 14:25:17 2020 - [info] done.Sat Oct 10 14:25:17 2020 - [info] done.Sat Oct 10 14:25:17 2020 - [info] Getting new master&#x27;s binlog name and position..Sat Oct 10 14:25:17 2020 - [info] mysql-bin.000010:517718Sat Oct 10 14:25:17 2020 - [info] All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&#x27;172.16.120.11&#x27;, MASTER_PORT=3358, MASTER_AUTO_POSITION=1, MASTER_USER=&#x27;repler&#x27;, MASTER_PASSWORD=&#x27;xxx&#x27;;Sat Oct 10 14:25:17 2020 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000010, 517718, 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22354,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27Sat Oct 10 14:25:17 2020 - [info] Executing master IP activate script:Sat Oct 10 14:25:17 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=start --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 --new_master_host=172.16.120.11 --new_master_ip=172.16.120.11 --new_master_port=3358 --new_master_user=&#x27;mha&#x27; --new_master_password=xxxEnabling the VIP - 172.16.120.128 on the new master - 172.16.120.11 Fake!!! æ–°ä¸»åº“ rpl_semi_sync_master_enabled=1 rpl_semi_sync_slave_enabled=0 Set read_only=0 on the new master.Creating app user on the new master..Sat Oct 10 14:25:18 2020 - [info] OK.Sat Oct 10 14:25:18 2020 - [info] ** Finished master recovery successfully.Sat Oct 10 14:25:18 2020 - [info] * Phase 3: Master Recovery Phase completed.Sat Oct 10 14:25:18 2020 - [info] Sat Oct 10 14:25:18 2020 - [info] * Phase 4: Slaves Recovery Phase..Sat Oct 10 14:25:18 2020 - [info] Sat Oct 10 14:25:18 2020 - [info] Sat Oct 10 14:25:18 2020 - [info] * Phase 4.1: Starting Slaves in parallel..Sat Oct 10 14:25:18 2020 - [info] Sat Oct 10 14:25:18 2020 - [info] -- Slave recovery on host 172.16.120.12(172.16.120.12:3358) started, pid: 89417. Check tmp log /masterha/cls_new//172.16.120.12_3358_20201010142515.log if it takes time..Sat Oct 10 14:25:19 2020 - [info] Sat Oct 10 14:25:19 2020 - [info] Log messages from 172.16.120.12 ...Sat Oct 10 14:25:19 2020 - [info] Sat Oct 10 14:25:18 2020 - [info] Resetting slave 172.16.120.12(172.16.120.12:3358) and starting replication from the new master 172.16.120.11(172.16.120.11:3358)..Sat Oct 10 14:25:18 2020 - [info] Executed CHANGE MASTER.Sat Oct 10 14:25:18 2020 - [info] Slave started.Sat Oct 10 14:25:18 2020 - [info] gtid_wait(44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22354,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27) completed on 172.16.120.12(172.16.120.12:3358). Executed 0 events.Sat Oct 10 14:25:19 2020 - [info] End of log messages from 172.16.120.12.Sat Oct 10 14:25:19 2020 - [info] -- Slave on host 172.16.120.12(172.16.120.12:3358) started.Sat Oct 10 14:25:19 2020 - [info] All new slave servers recovered successfully.Sat Oct 10 14:25:19 2020 - [info] Sat Oct 10 14:25:19 2020 - [info] * Phase 5: New master cleanup phase..Sat Oct 10 14:25:19 2020 - [info] Sat Oct 10 14:25:19 2020 - [info] Resetting slave info on the new master..Sat Oct 10 14:25:19 2020 - [info] 172.16.120.11: Resetting slave info succeeded.Sat Oct 10 14:25:19 2020 - [info] Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Sat Oct 10 14:25:19 2020 - [info] ----- Failover Report -----cls_new: MySQL Master failover 172.16.120.10(172.16.120.10:3358) to 172.16.120.11(172.16.120.11:3358) succeededMaster 172.16.120.10(172.16.120.10:3358) is down!Check MHA Manager logs at centos-4:/masterha/cls_new/manager.log for details.Started automated(non-interactive) failover.Invalidated master IP address on 172.16.120.10(172.16.120.10:3358)Selected 172.16.120.11(172.16.120.11:3358) as a new master.172.16.120.11(172.16.120.11:3358): OK: Applying all logs succeeded.172.16.120.11(172.16.120.11:3358): OK: Activated master IP address.172.16.120.12(172.16.120.12:3358): OK: Slave started, replicating from 172.16.120.11(172.16.120.11:3358)172.16.120.11(172.16.120.11:3358): Resetting slave info succeeded.Master failover to 172.16.120.11(172.16.120.11:3358) completed successfully.Sat Oct 10 14:25:19 2020 - [info] Sending mail.. slave-1123456789root@localhost 14:23:56 [dbms_monitor]&gt; select * from monitor_delay;+----+---------------------+| id | ctime |+----+---------------------+| 88 | 2020-10-10 12:21:17 || 90 | 2020-10-10 14:22:29 |+----+---------------------+2 rows in set (0.00 sec) [ç”¨ä¾‹æµ‹è¯•] masteræŒ‚äº†, ä¸”slaveä¹Ÿæœ‰é—®é¢˜5(éƒ¨åˆ†slave sql_thread error) masteræŒ‚äº†, åœ¨æ­¤ä¹‹å‰slave-1 sql_thread erroräº† ping_type=CONNECTå¯åŠ¨manager12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 14:34:42 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 14:34:43 2020 - [info] GTID failover mode = 1Sat Oct 10 14:34:43 2020 - [info] Dead Servers:Sat Oct 10 14:34:43 2020 - [info] Alive Servers:Sat Oct 10 14:34:43 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:34:43 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 14:34:43 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:34:43 2020 - [info] Alive Slaves:Sat Oct 10 14:34:43 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:34:43 2020 - [info] GTID ONSat Oct 10 14:34:43 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:34:43 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:34:43 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.31-34-log (oldest major version between slaves) log-bin:enabledSat Oct 10 14:34:43 2020 - [info] GTID ONSat Oct 10 14:34:43 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:34:43 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 14:34:43 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 14:34:43 2020 - [info] Checking slave configurations..Sat Oct 10 14:34:43 2020 - [info] Checking replication filtering settings..Sat Oct 10 14:34:43 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 14:34:43 2020 - [info] Replication filtering check ok.Sat Oct 10 14:34:43 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 14:34:43 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 14:34:43 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 14:34:43 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 14:34:43 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 14:34:43 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 14:34:43 2020 - [info] OK.Sat Oct 10 14:34:43 2020 - [warning] shutdown_script is not defined.Sat Oct 10 14:34:43 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 14:34:43 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 14:34:43 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 14:34:43 2020 - [info] Ping(CONNECT) succeeded, waiting until MySQL doesn&#x27;t respond..åˆ¶é€ slave-1 sql_thread error åœ¨masteråˆ›å»ºè¡¨12root@localhost 14:35:55 [dbms_monitor]&gt; create table make_error(id int not null auto_increment primary key);Query OK, 0 rows affected (0.02 sec) åœ¨slave-1åˆ é™¤make_errorè¡¨1234567891011root@localhost 14:38:10 [dbms_monitor]&gt; set global super_read_only=0;Query OK, 0 rows affected (0.00 sec)root@localhost 14:38:14 [dbms_monitor]&gt; set sql_log_bin=0;Query OK, 0 rows affected (0.00 sec)root@localhost 14:38:17 [dbms_monitor]&gt; drop table make_error;Query OK, 0 rows affected (0.01 sec)root@localhost 14:38:20 [dbms_monitor]&gt; set sql_log_bin=1;Query OK, 0 rows affected (0.00 sec) åœ¨masteråˆ é™¤make_errorè¡¨(slave-1 sql_threadä¼šæŠ¥é”™)12root@localhost 14:36:28 [dbms_monitor]&gt; drop table make_error;Query OK, 0 rows affected (0.01 sec) æŸ¥çœ‹slave-1å¤åˆ¶çŠ¶æ€12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061root@localhost 14:38:26 [dbms_monitor]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 172.16.120.10 Master_User: repler Master_Port: 3358 Connect_Retry: 1 Master_Log_File: mysql-bin.000017 Read_Master_Log_Pos: 620 Relay_Log_File: mysql-relay-bin.000002 Relay_Log_Pos: 589 Relay_Master_Log_File: mysql-bin.000017 Slave_IO_Running: Yes Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 1051 Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Skip_Counter: 0 Exec_Master_Log_Pos: 416 Relay_Log_Space: 1000 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 1051 Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Replicate_Ignore_Server_Ids: Master_Server_Id: 120103358 Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 201010 14:39:25 Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:22355-22356 Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22355,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) æ­¤æ—¶managerä»ç„¶æ­£å¸¸è¿è¡Œ å…³é—­master12root@localhost 14:39:25 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥12345678910111213141516171819202122232425Sat Oct 10 14:40:59 2020 - [warning] Got error on MySQL connect ping: DBI connect(&#x27;;host=172.16.120.10;port=3358;mysql_connect_timeout=1&#x27;,&#x27;mha&#x27;,...) failed: Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111) at /usr/local/share/perl5/MHA/HealthCheck.pm line 98.2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:40:59 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=CONNECTSat Oct 10 14:40:59 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 14:40:59 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 14:40:59 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 14:41:02 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:41:02 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 14:41:05 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:41:05 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 14:41:08 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 14:41:08 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 14:41:08 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 14:41:08 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 14:41:08 2020 - [warning] SSH is reachable.Sat Oct 10 14:41:08 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 14:41:08 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 14:41:08 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 14:41:08 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 14:41:09 2020 - [error][/usr/local/share/perl5/MHA/Server.pm, ln935] SQL Thread is stopped(error) on 172.16.120.11(172.16.120.11:3358)! Errno:1051, Error:Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22356&#x27; at master log mysql-bin.000017, end_log_pos 620. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.Sat Oct 10 14:41:09 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln703] Server 172.16.120.11(172.16.120.11:3358) is alive, but does not work as a slave!Sat Oct 10 14:41:09 2020 - [warning] Got Error: at /usr/local/share/perl5/MHA/MasterMonitor.pm line 560.Sat Oct 10 14:41:09 2020 - [info] Got exit code 1 (Not master dead). ping_type=INSERTå¯åŠ¨manager12345678910111213141516171819202122232425262728293031323334353637Sat Oct 10 15:54:20 2020 - [info] MHA::MasterMonitor version 0.58.Sat Oct 10 15:54:21 2020 - [info] GTID failover mode = 1Sat Oct 10 15:54:21 2020 - [info] Dead Servers:Sat Oct 10 15:54:21 2020 - [info] Alive Servers:Sat Oct 10 15:54:21 2020 - [info] 172.16.120.10(172.16.120.10:3358)Sat Oct 10 15:54:21 2020 - [info] 172.16.120.11(172.16.120.11:3358)Sat Oct 10 15:54:21 2020 - [info] 172.16.120.12(172.16.120.12:3358)Sat Oct 10 15:54:21 2020 - [info] Alive Slaves:Sat Oct 10 15:54:21 2020 - [info] 172.16.120.11(172.16.120.11:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 15:54:21 2020 - [info] GTID ONSat Oct 10 15:54:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 15:54:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 15:54:21 2020 - [info] 172.16.120.12(172.16.120.12:3358) Version=5.7.29-32-log (oldest major version between slaves) log-bin:enabledSat Oct 10 15:54:21 2020 - [info] GTID ONSat Oct 10 15:54:21 2020 - [info] Replicating from 172.16.120.10(172.16.120.10:3358)Sat Oct 10 15:54:21 2020 - [info] Primary candidate for the new Master (candidate_master is set)Sat Oct 10 15:54:21 2020 - [info] Current Alive Master: 172.16.120.10(172.16.120.10:3358)Sat Oct 10 15:54:21 2020 - [info] Checking slave configurations..Sat Oct 10 15:54:21 2020 - [info] Checking replication filtering settings..Sat Oct 10 15:54:21 2020 - [info] binlog_do_db= , binlog_ignore_db= Sat Oct 10 15:54:21 2020 - [info] Replication filtering check ok.Sat Oct 10 15:54:21 2020 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.Sat Oct 10 15:54:21 2020 - [info] Checking SSH publickey authentication settings on the current master..Sat Oct 10 15:54:21 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Sat Oct 10 15:54:21 2020 - [info] 172.16.120.10(172.16.120.10:3358) (current master) +--172.16.120.11(172.16.120.11:3358) +--172.16.120.12(172.16.120.12:3358)Sat Oct 10 15:54:21 2020 - [info] Checking master_ip_failover_script status:Sat Oct 10 15:54:21 2020 - [info] /etc/masterha/scripts/master_ip_failover_vip --vip=172.16.120.128 --command=status --ssh_user=root --orig_master_host=172.16.120.10 --orig_master_ip=172.16.120.10 --orig_master_port=3358 Sat Oct 10 15:54:21 2020 - [info] OK.Sat Oct 10 15:54:21 2020 - [warning] shutdown_script is not defined.Sat Oct 10 15:54:21 2020 - [info] Set master ping interval 3 seconds.Sat Oct 10 15:54:21 2020 - [info] Set secondary check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12Sat Oct 10 15:54:21 2020 - [info] Starting ping health check on 172.16.120.10(172.16.120.10:3358)..Sat Oct 10 15:54:21 2020 - [info] Ping(INSERT) succeeded, waiting until MySQL doesn&#x27;t respond..å‡†å¤‡å·¥ä½œçœç•¥, slave-1 sql_threadæŠ¥é”™12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061root@localhost 15:55:13 [dbms_monitor]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 172.16.120.10 Master_User: repler Master_Port: 3358 Connect_Retry: 1 Master_Log_File: mysql-bin.000019 Read_Master_Log_Pos: 16331 Relay_Log_File: mysql-relay-bin.000007 Relay_Log_Pos: 14926 Relay_Master_Log_File: mysql-bin.000019 Slave_IO_Running: Yes Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 1051 Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Skip_Counter: 0 Exec_Master_Log_Pos: 14713 Relay_Log_Space: 19342 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 1051 Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Replicate_Ignore_Server_Ids: Master_Server_Id: 120103358 Master_UUID: 44a4ea53-fcad-11ea-bd16-0050563b7b42 Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 201010 15:55:16 Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:22356-22425 Executed_Gtid_Set: 44a4ea53-fcad-11ea-bd16-0050563b7b42:1-22418,45d1f02a-fcad-11ea-8a44-0050562f2198:1-27 Auto_Position: 1 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) å…³é—­master12root@localhost 15:55:16 [dbms_monitor]&gt; shutdown;Query OK, 0 rows affected (0.00 sec) ç»“è®º: ä¼šè§¦å‘failover, ä½†failoverå¤±è´¥123456789101112131415161718192021222324Sat Oct 10 15:56:03 2020 - [warning] Got error on MySQL insert ping: 2006 (MySQL server has gone away)Sat Oct 10 15:56:03 2020 - [info] Executing secondary network check script: masterha_secondary_check -s 172.16.120.11 -s 172.16.120.12 --user=root --master_host=172.16.120.10 --master_ip=172.16.120.10 --master_port=3358 --master_user=mha --master_password=xxx --ping_type=INSERTSat Oct 10 15:56:03 2020 - [info] Executing SSH check script: exit 0Sat Oct 10 15:56:04 2020 - [info] HealthCheck: SSH to 172.16.120.10 is reachable.Monitoring server 172.16.120.11 is reachable, Master is not reachable from 172.16.120.11. OK.Monitoring server 172.16.120.12 is reachable, Master is not reachable from 172.16.120.12. OK.Sat Oct 10 15:56:04 2020 - [info] Master is not reachable from all other monitoring servers. Failover should start.Sat Oct 10 15:56:06 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 15:56:06 2020 - [warning] Connection failed 2 time(s)..Sat Oct 10 15:56:09 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 15:56:09 2020 - [warning] Connection failed 3 time(s)..Sat Oct 10 15:56:12 2020 - [warning] Got error on MySQL connect: 2003 (Can&#x27;t connect to MySQL server on &#x27;172.16.120.10&#x27; (111))Sat Oct 10 15:56:12 2020 - [warning] Connection failed 4 time(s)..Sat Oct 10 15:56:12 2020 - [warning] Master is not reachable from health checker!Sat Oct 10 15:56:12 2020 - [warning] Master 172.16.120.10(172.16.120.10:3358) is not reachable!Sat Oct 10 15:56:12 2020 - [warning] SSH is reachable.Sat Oct 10 15:56:12 2020 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha/conf/masterha_default.cnf and /etc/masterha/conf/cls_new.cnf again, and trying to connect to all servers to check server status..Sat Oct 10 15:56:12 2020 - [info] Reading default configuration from /etc/masterha/conf/masterha_default.cnf..Sat Oct 10 15:56:12 2020 - [info] Reading application default configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 15:56:12 2020 - [info] Reading server configuration from /etc/masterha/conf/cls_new.cnf..Sat Oct 10 15:56:13 2020 - [error][/usr/local/share/perl5/MHA/Server.pm, ln935] SQL Thread is stopped(error) on 172.16.120.11(172.16.120.11:3358)! Errno:1051, Error:Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;44a4ea53-fcad-11ea-bd16-0050563b7b42:22419&#x27; at master log mysql-bin.000019, end_log_pos 14917. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.Sat Oct 10 15:56:13 2020 - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln703] Server 172.16.120.11(172.16.120.11:3358) is alive, but does not work as a slave!Sat Oct 10 15:56:13 2020 - [warning] Got Error: at /usr/local/share/perl5/MHA/MasterMonitor.pm line 560.Sat Oct 10 15:56:13 2020 - [info] Got exit code 1 (Not master dead).","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"ä½¿ç”¨Canal + ClickHouseå®æ—¶åˆ†æMySQLäº‹åŠ¡ä¿¡æ¯","slug":"2020-12-31-ä½¿ç”¨Canal-+-ClickHouseå®æ—¶åˆ†æMySQLäº‹åŠ¡ä¿¡æ¯","date":"2020-12-31T05:54:00.000Z","updated":"2020-12-31T05:56:19.701Z","comments":true,"path":"2020/12/31/2020-12-31-ä½¿ç”¨Canal-+-ClickHouseå®æ—¶åˆ†æMySQLäº‹åŠ¡ä¿¡æ¯/","link":"","permalink":"http://fuxkdb.com/2020/12/31/2020-12-31-%E4%BD%BF%E7%94%A8Canal-+-ClickHouse%E5%AE%9E%E6%97%B6%E5%88%86%E6%9E%90MySQL%E4%BA%8B%E5%8A%A1%E4%BF%A1%E6%81%AF/","excerpt":"ä½¿ç”¨Canal + ClickHouseå®æ—¶åˆ†æMySQLäº‹åŠ¡ä¿¡æ¯ä½œä¸ºDBA, æœ‰æ—¶å€™æˆ‘ä»¬ä¼šå¸Œæœ›èƒ½å¤Ÿäº†è§£çº¿ä¸Šæ ¸å¿ƒåº“æ›´å…·ä½“çš„â€æ ·è²Œâ€, å¦‚: è¿™ä¸ªåº“ä¸»è¦çš„DMLç±»å‹æ˜¯ä»€ä¹ˆ? è¿™ä¸ªåº“çš„äº‹åŠ¡å¤§å°, æ‰§è¡Œæ—¶é—´, å½±å“è¡Œæ•°å¤§æ¦‚æ˜¯ä»€ä¹ˆæ ·çš„? ä»¥ä¸Šä¿¡æ¯ä¹Ÿè®¸æ²¡ä»€ä¹ˆä»·å€¼, ä½†å¤§äº‹åŠ¡å¯¹å¤åˆ¶çš„å½±å“ä¸ç”¨å¤šè¯´, å¹¶ä¸”å½“æˆ‘ä»¬å¸Œæœ›å‡çº§å½“å‰ä¸»ä»æ¶æ„åˆ°MGR/PXCç­‰é«˜å¯ç”¨æ–¹æ¡ˆçš„åœºæ™¯æ—¶ä»¥ä¸Šä¿¡æ¯å°±æ¯”è¾ƒé‡è¦äº†(æ¯•ç«Ÿç”¨æ•°æ®è¯´è¯æ›´æœ‰åŠ›åº¦). å¤§äº‹åŠ¡å¯¹MGRå’ŒPXCéƒ½æ˜¯ä¸å‹å¥½çš„, å°¤å…¶æ˜¯MGR(èµ·ç åœ¨5.7ç‰ˆæœ¬)ä¸¥é‡æ—¶ä¼šå¯¼è‡´æ•´ä¸ªé›†ç¾¤hangæ­» åœ¨Galera 4.0ä¸­æ–°ç‰¹æ€§Streaming Replicationå¯¹å¤§äº‹åŠ¡æœ‰äº†æ›´å¥½çš„æ”¯æŒ å½“ç„¶, æœ‰äººå¯èƒ½ä¼šè¯´, é€šè¿‡åˆ†æbinlogå°±å¯ä»¥å®Œæˆè¿™æ ·çš„å·¥ä½œ, æœ€ç®€å•çš„æ–¹æ³•å†™ä¸ªshellè„šæœ¬å°±å¯ä»¥, æ¯”å¦‚è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»çš„æ–¹æ³•Identifying Useful Info from MySQL Row-Based Binary Logs(è¿™ç¯‡æ–‡ç« ä»‹ç»çš„æ–¹æ³•æ¯”è¾ƒç®€å•, åˆ†æé€Ÿåº¦ä¹Ÿè¾ƒæ…¢, å¯ä»¥è¯•è¯•analysis_binlog). å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–å·¥å…·, æ¯”å¦‚infobin. ä½†ä¸ªäººè®¤ä¸ºä¸Šé¢çš„æ–¹æ³•ä»æŸç§è§’åº¦æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦, è€Œä¸”ç°åœ¨ClickHouseè¶Šæ¥è¶Šæµè¡Œ, ä½¿ç”¨ClickHouseå»å®Œæˆè¿™ä¸ªå·¥ä½œä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å­¦ä¹ ClickHouse å…ˆçœ‹ä¸€ä¸‹æœ€ç»ˆçš„æˆæœ","text":"ä½¿ç”¨Canal + ClickHouseå®æ—¶åˆ†æMySQLäº‹åŠ¡ä¿¡æ¯ä½œä¸ºDBA, æœ‰æ—¶å€™æˆ‘ä»¬ä¼šå¸Œæœ›èƒ½å¤Ÿäº†è§£çº¿ä¸Šæ ¸å¿ƒåº“æ›´å…·ä½“çš„â€æ ·è²Œâ€, å¦‚: è¿™ä¸ªåº“ä¸»è¦çš„DMLç±»å‹æ˜¯ä»€ä¹ˆ? è¿™ä¸ªåº“çš„äº‹åŠ¡å¤§å°, æ‰§è¡Œæ—¶é—´, å½±å“è¡Œæ•°å¤§æ¦‚æ˜¯ä»€ä¹ˆæ ·çš„? ä»¥ä¸Šä¿¡æ¯ä¹Ÿè®¸æ²¡ä»€ä¹ˆä»·å€¼, ä½†å¤§äº‹åŠ¡å¯¹å¤åˆ¶çš„å½±å“ä¸ç”¨å¤šè¯´, å¹¶ä¸”å½“æˆ‘ä»¬å¸Œæœ›å‡çº§å½“å‰ä¸»ä»æ¶æ„åˆ°MGR/PXCç­‰é«˜å¯ç”¨æ–¹æ¡ˆçš„åœºæ™¯æ—¶ä»¥ä¸Šä¿¡æ¯å°±æ¯”è¾ƒé‡è¦äº†(æ¯•ç«Ÿç”¨æ•°æ®è¯´è¯æ›´æœ‰åŠ›åº¦). å¤§äº‹åŠ¡å¯¹MGRå’ŒPXCéƒ½æ˜¯ä¸å‹å¥½çš„, å°¤å…¶æ˜¯MGR(èµ·ç åœ¨5.7ç‰ˆæœ¬)ä¸¥é‡æ—¶ä¼šå¯¼è‡´æ•´ä¸ªé›†ç¾¤hangæ­» åœ¨Galera 4.0ä¸­æ–°ç‰¹æ€§Streaming Replicationå¯¹å¤§äº‹åŠ¡æœ‰äº†æ›´å¥½çš„æ”¯æŒ å½“ç„¶, æœ‰äººå¯èƒ½ä¼šè¯´, é€šè¿‡åˆ†æbinlogå°±å¯ä»¥å®Œæˆè¿™æ ·çš„å·¥ä½œ, æœ€ç®€å•çš„æ–¹æ³•å†™ä¸ªshellè„šæœ¬å°±å¯ä»¥, æ¯”å¦‚è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»çš„æ–¹æ³•Identifying Useful Info from MySQL Row-Based Binary Logs(è¿™ç¯‡æ–‡ç« ä»‹ç»çš„æ–¹æ³•æ¯”è¾ƒç®€å•, åˆ†æé€Ÿåº¦ä¹Ÿè¾ƒæ…¢, å¯ä»¥è¯•è¯•analysis_binlog). å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–å·¥å…·, æ¯”å¦‚infobin. ä½†ä¸ªäººè®¤ä¸ºä¸Šé¢çš„æ–¹æ³•ä»æŸç§è§’åº¦æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦, è€Œä¸”ç°åœ¨ClickHouseè¶Šæ¥è¶Šæµè¡Œ, ä½¿ç”¨ClickHouseå»å®Œæˆè¿™ä¸ªå·¥ä½œä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å­¦ä¹ ClickHouse å…ˆçœ‹ä¸€ä¸‹æœ€ç»ˆçš„æˆæœ å®ç°æ–¹æ³• canal + kafka éƒ¨ç½²canal, è®¢é˜…çº¿ä¸Šåº“çš„binlog, å†™å…¥åˆ°kafka æˆ‘è¿™é‡Œæ²¡æœ‰ä½¿ç”¨flatMessage(canal.mq.flatMessage = false), å†™å…¥åˆ°kafkaçš„æ¶ˆæ¯æ˜¯äºŒè¿›åˆ¶çš„protobufæ ¼å¼çš„, å½“ç„¶ä¹Ÿå¯ä»¥å¼€å¯flatMessage, é‚£ä¹ˆå†™åˆ°kafkaçš„æ¶ˆæ¯å°±æ˜¯jsonæ ¼å¼çš„. æ¶ˆè´¹binlog, æŒä¹…åŒ–åˆ°clickhouse å…·ä½“ä»£ç è¯¦è§ https://github.com/Fanduzi/Use_clickhouse_2_analyze_mysql_binlog clickhouseè¡¨ åŸºç¡€è¡¨canalæ¶ˆè´¹åç›´æ¥å†™å…¥ 1234567891011121314151617181920212223242526272829303132333435363738394041-- æœ¬åœ°è¡¨CREATE TABLE mysql_monitor.broker_binlog_local( `schema` String COMMENT &#x27;æ•°æ®åº“å&#x27;, `table` String COMMENT &#x27;è¡¨å&#x27;, `event_type` String COMMENT &#x27;è¯­å¥ç±»å‹&#x27;, `is_ddl` UInt8 COMMENT &#x27;DDL 1 else 0&#x27;, `binlog_file` String COMMENT &#x27;binlogæ–‡ä»¶å&#x27;, `binlog_pos` String COMMENT &#x27;binlog pos&#x27;, `characterset` String COMMENT &#x27;å­—ç¬¦é›†&#x27;, `execute_time` DateTime COMMENT &#x27;æ‰§è¡Œçš„æ—¶é—´&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `single_statement_affected_rows` UInt32 COMMENT &#x27;æ­¤è¯­å¥å½±å“è¡Œæ•°&#x27;, `single_statement_size` String DEFAULT &#x27;0&#x27; COMMENT &#x27;æ­¤è¯­å¥size,å•ä½bytes&#x27;, `ctime` DateTime DEFAULT now() COMMENT &#x27;å†™å…¥clickhouseæ—¶é—´&#x27;)ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_binlog&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY toDate(execute_time)ORDER BY (execute_time, gtid, table, schema)TTL execute_time + toIntervalMonth(30)SETTINGS index_granularity = 8192-- åˆ†å¸ƒå¼è¡¨CREATE TABLE mysql_monitor.broker_binlog( `schema` String COMMENT &#x27;æ•°æ®åº“å&#x27;, `table` String COMMENT &#x27;è¡¨å&#x27;, `event_type` String COMMENT &#x27;è¯­å¥ç±»å‹&#x27;, `is_ddl` UInt8 COMMENT &#x27;DDL 1 else 0&#x27;, `binlog_file` String COMMENT &#x27;binlogæ–‡ä»¶å&#x27;, `binlog_pos` String COMMENT &#x27;binlog pos&#x27;, `characterset` String COMMENT &#x27;å­—ç¬¦é›†&#x27;, `execute_time` DateTime COMMENT &#x27;æ‰§è¡Œçš„æ—¶é—´&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `single_statement_affected_rows` UInt32 COMMENT &#x27;æ­¤è¯­å¥å½±å“è¡Œæ•°&#x27;, `single_statement_size` String DEFAULT &#x27;0&#x27; COMMENT &#x27;æ­¤è¯­å¥size,å•ä½bytes&#x27;, `ctime` DateTime DEFAULT now() COMMENT &#x27;å†™å…¥clickhouseæ—¶é—´&#x27;)ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;mysql_monitor&#x27;, &#x27;broker_binlog_local&#x27;, rand()) ç»Ÿè®¡ç”¨è¡¨ SummingMergeTree ClickHouseä¼šå°†æ‰€æœ‰å…·æœ‰ç›¸åŒä¸»é”®ï¼ˆæˆ–æ›´å‡†ç¡®åœ°è¯´, å…·æœ‰ç›¸åŒsorting keyï¼‰çš„è¡Œæ›¿æ¢ä¸ºåŒ…å«å…·æœ‰æ•°å­—æ•°æ®ç±»å‹çš„åˆ—çš„æ±‡æ€»å€¼çš„ä¸€è¡Œ æ¯å¤©binlog å„ä¸ªevent_typeæ•°é‡ç”¨äºç»Ÿè®¡æ¯æ—¥æ•´ä½“binlog eventç±»å‹å æ¯” 1234567891011121314151617181920212223242526272829303132333435363738394041-- ç‰©åŒ–è§†å›¾åŸºè¡¨CREATE TABLE mysql_monitor.broker_daily_binlog_event_count_local ON CLUSTER ch_cluster_all( `day` Date, `event_type` String, `event_count` UInt64)ENGINE = ReplicatedSummingMergeTree(&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_daily_binlog_event_count&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY dayORDER BY (day, event_type)TTL day + toIntervalMonth(30)SETTINGS index_granularity = 8192-- æœ¬åœ°ç‰©åŒ–è§†å›¾CREATE MATERIALIZED VIEW mysql_monitor.broker_daily_binlog_event_count_mv_local ON CLUSTER ch_cluster_all TO mysql_monitor.broker_daily_binlog_event_count_local( `day` Date, `event_type` String, `event_count` UInt64) ASSELECT toDate(execute_time) AS day, event_type, count(*) AS event_countFROM mysql_monitor.broker_binlog_localGROUP BY day, event_typeORDER BY day ASC, event_type ASC-- åˆ†å¸ƒå¼ç‰©åŒ–è§†å›¾CREATE TABLE mysql_monitor.broker_daily_binlog_event_count_mv ON CLUSTER ch_cluster_all( `day` Date, `event_type` String, `event_count` UInt64)ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;mysql_monitor&#x27;, &#x27;broker_daily_binlog_event_count_mv_local&#x27;, rand()) grafanaä¸­æŸ¥è¯¢è¯­å¥ 12345678SELECT day as t, event_type, sum(event_count)FROM mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_mvWHERE day = yesterday() and event_type!=&#x27;QUERY&#x27; and event_type!=&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;GROUP BY day, event_type æ¯æ—¥TOP DMLè¡¨ç»Ÿè®¡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152-- ç‰©åŒ–è§†å›¾åŸºè¡¨CREATE TABLE mysql_monitor.broker_daily_binlog_event_count_by_table_local ON CLUSTER ch_cluster_all( `day` Date, `schema` String, `table` String, `event_type` String, `event_count` UInt64)ENGINE = ReplicatedSummingMergeTree(&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_daily_binlog_event_count_by_table&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY dayORDER BY (day, table, schema, event_type)TTL day + toIntervalMonth(30)SETTINGS index_granularity = 8192-- æœ¬åœ°ç‰©åŒ–è§†å›¾CREATE MATERIALIZED VIEW mysql_monitor.broker_daily_binlog_event_count_by_table_mv_local ON CLUSTER ch_cluster_all TO mysql_monitor.broker_daily_binlog_event_count_by_table_local( `day` Date, `schema` String, `table` String, `event_type` String, `event_count` UInt64) ASSELECT toDate(execute_time) AS day, schema, table, event_type, count(*) AS event_countFROM mysql_monitor.broker_binlog_localGROUP BY day, schema, table, event_typeORDER BY day ASC, schema ASC, table ASC, event_type DESC-- åˆ†å¸ƒå¼ç‰©åŒ–è§†å›¾CREATE TABLE mysql_monitor.broker_daily_binlog_event_count_by_table_mv ON CLUSTER ch_cluster_all( `day` Date, `schema` String, `table` String, `event_type` String, `event_count` UInt64)ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;mysql_monitor&#x27;, &#x27;broker_daily_binlog_event_count_by_table_mv_local&#x27;, rand()) grafanaä¸­æŸ¥è¯¢è¯­å¥ 1234567891011SELECT day as t, table, sum(event_count) countFROM mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_by_table_mvWHERE day = yesterday() and event_type!=&#x27;QUERY&#x27; and event_type!=&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;GROUP BY day, tableORDER BY count descLIMIT 10 grafanaä¸­æŸ¥è¯¢è¯­å¥ 1234567891011121314151617SELECT day as t, table, event_type, sum(event_count) countFROM mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_by_table_mvWHERE day = yesterday() and event_type!=&#x27;QUERY&#x27; and event_type!=&#x27;EVENTTYPECOMPATIBLEPROTO2&#x27; and table GLOBAL IN ( select table from ( select table, sum(event_count) count FROM mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_by_table_mv WHERE day = yesterday() GROUP BY table order by count desc limit 3 ))GROUP BY day, table, event_typeORDER BY count DESC ä¸€å‘¨æ‰§è¡ŒDMLæ€»é‡æƒ…å†µ 1234567891011121314WITH ( SELECT sum(event_count) FROM mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_mv WHERE (day &gt;= (today() - 6)) AND (event_type != &#x27;QUERY&#x27;) AND (event_type != &#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;) ) AS total_statement_countSELECT multiIf(toDayOfWeek(day) = 1, &#x27;æ˜ŸæœŸä¸€&#x27;, toDayOfWeek(day) = 2, &#x27;æ˜ŸæœŸäºŒ&#x27;, toDayOfWeek(day) = 3, &#x27;æ˜ŸæœŸä¸‰&#x27;, toDayOfWeek(day) = 4, &#x27;æ˜ŸæœŸå››&#x27;, toDayOfWeek(day) = 5, &#x27;æ˜ŸæœŸäº”&#x27;, toDayOfWeek(day) = 6, &#x27;æ˜ŸæœŸå…­&#x27;, toDayOfWeek(day) = 7, &#x27;æ˜ŸæœŸæ—¥&#x27;, &#x27;N/A&#x27;) AS w, day AS t, sum(event_count) AS statement_count, bar(statement_count, 0, total_statement_count, 500) AS barFROM mysql_monitor.$&#123;prefix&#125;_daily_binlog_event_count_mvWHERE (day &gt;= (today() - 6)) AND (event_type != &#x27;QUERY&#x27;) AND (event_type != &#x27;EVENTTYPECOMPATIBLEPROTO2&#x27;)GROUP BY day ORDER BY toDate(t) DESC äº‹åŠ¡æƒ…å†µç»Ÿè®¡ ç»Ÿè®¡å½±å“è¡Œæ•°å¯¹å¤šçš„äº‹åŠ¡, äº§ç”Ÿbinlogæœ€å¤§çš„äº‹åŠ¡, æ‰§è¡Œæ—¶é—´æœ€é•¿çš„äº‹åŠ¡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778CREATE TABLE mysql_monitor.broker_largest_transaction_local ON CLUSTER ch_cluster_all( `end_time` DateTime COMMENT &#x27;é‡‡é›†è¯­å¥ä¸­çš„end_time&#x27;, `invertal` String COMMENT &#x27;é‡‡é›†å‘¨æœŸ,å•ä½ç§’&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `transaction_spend_time` Int32 COMMENT &#x27;äº‹åŠ¡ç”¨æ—¶&#x27;, `transaction_size` Int64 COMMENT &#x27;äº‹åŠ¡size&#x27;, `single_statement_affected_rows` UInt64 COMMENT &#x27;äº‹åŠ¡å½±å“è¡Œæ•°&#x27;)ENGINE = ReplicatedSummingMergeTree(&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_largest_transaction&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY toDate(end_time)ORDER BY gtidTTL toDate(end_time) + toIntervalMonth(30)SETTINGS index_granularity = 8192CREATE TABLE mysql_monitor.broker_largest_transaction ON CLUSTER ch_cluster_all( `end_time` DateTime COMMENT &#x27;é‡‡é›†è¯­å¥ä¸­çš„end_time&#x27;, `invertal` String COMMENT &#x27;é‡‡é›†å‘¨æœŸ,å•ä½ç§’&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `transaction_spend_time` Int32 COMMENT &#x27;äº‹åŠ¡ç”¨æ—¶&#x27;, `transaction_size` Int64 COMMENT &#x27;äº‹åŠ¡size&#x27;, `single_statement_affected_rows` UInt64 COMMENT &#x27;äº‹åŠ¡å½±å“è¡Œæ•°&#x27;)ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;mysql_monitor&#x27;, &#x27;broker_largest_transaction_local&#x27;, rand())CREATE TABLE mysql_monitor.broker_most_time_consuming_transaction_local ON CLUSTER ch_cluster_all( `end_time` DateTime COMMENT &#x27;é‡‡é›†è¯­å¥ä¸­çš„end_time&#x27;, `invertal` String COMMENT &#x27;é‡‡é›†å‘¨æœŸ,å•ä½ç§’&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `transaction_spend_time` Int32 COMMENT &#x27;äº‹åŠ¡ç”¨æ—¶&#x27;, `transaction_size` Int64 COMMENT &#x27;äº‹åŠ¡size&#x27;, `single_statement_affected_rows` UInt64 COMMENT &#x27;äº‹åŠ¡å½±å“è¡Œæ•°&#x27;)ENGINE = ReplicatedSummingMergeTree(&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_most_time_consuming_transaction&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY toDate(end_time)ORDER BY gtidTTL toDate(end_time) + toIntervalMonth(30)SETTINGS index_granularity = 8192CREATE TABLE mysql_monitor.broker_most_time_consuming_transaction ON CLUSTER ch_cluster_all( `end_time` DateTime COMMENT &#x27;é‡‡é›†è¯­å¥ä¸­çš„end_time&#x27;, `invertal` String COMMENT &#x27;é‡‡é›†å‘¨æœŸ,å•ä½ç§’&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `transaction_spend_time` Int32 COMMENT &#x27;äº‹åŠ¡ç”¨æ—¶&#x27;, `transaction_size` Int64 COMMENT &#x27;äº‹åŠ¡size&#x27;, `single_statement_affected_rows` UInt64 COMMENT &#x27;äº‹åŠ¡å½±å“è¡Œæ•°&#x27;)ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;mysql_monitor&#x27;, &#x27;broker_most_time_consuming_transaction_local&#x27;, rand())CREATE TABLE mysql_monitor.broker_most_affected_rows_transaction_local ON CLUSTER ch_cluster_all( `end_time` DateTime COMMENT &#x27;é‡‡é›†è¯­å¥ä¸­çš„end_time&#x27;, `invertal` String COMMENT &#x27;é‡‡é›†å‘¨æœŸ,å•ä½ç§’&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `transaction_spend_time` Int32 COMMENT &#x27;äº‹åŠ¡ç”¨æ—¶&#x27;, `transaction_size` Int64 COMMENT &#x27;äº‹åŠ¡size&#x27;, `single_statement_affected_rows` UInt64 COMMENT &#x27;äº‹åŠ¡å½±å“è¡Œæ•°&#x27;)ENGINE = ReplicatedSummingMergeTree(&#x27;/clickhouse/mysql_monitor/tables/&#123;layer&#125;-&#123;shard&#125;/broker_most_affected_rows_transaction&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY toDate(end_time)ORDER BY gtidTTL toDate(end_time) + toIntervalMonth(30)SETTINGS index_granularity = 8192CREATE TABLE mysql_monitor.broker_most_affected_rows_transaction ON CLUSTER ch_cluster_all( `end_time` DateTime COMMENT &#x27;é‡‡é›†è¯­å¥ä¸­çš„end_time&#x27;, `invertal` String COMMENT &#x27;é‡‡é›†å‘¨æœŸ,å•ä½ç§’&#x27;, `gtid` String COMMENT &#x27;gtid&#x27;, `transaction_spend_time` Int32 COMMENT &#x27;äº‹åŠ¡ç”¨æ—¶&#x27;, `transaction_size` Int64 COMMENT &#x27;äº‹åŠ¡size&#x27;, `single_statement_affected_rows` UInt64 COMMENT &#x27;äº‹åŠ¡å½±å“è¡Œæ•°&#x27;)ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;mysql_monitor&#x27;, &#x27;broker_most_affected_rows_transaction_local&#x27;, rand()) æƒ³äº†æƒ³åªèƒ½å»ºä¸‰å¼ è¡¨, å†™è„šæœ¬è‡ªå·±å‘¨æœŸæ€§æŸ¥è¯¢size,è€—æ—¶, å½±å“è¡Œæ•°æœ€å¤šçš„åœ¨æ’å…¥è¿™äº›è¡¨ä¸­ æŸ¥è¯¢è¯­å¥å¤§è‡´å¦‚ä¸‹, ç”±äºgrafanaå¿…é¡»éœ€è¦ä¸€ä¸ªDateTimeåˆ—, æ‰€ä»¥åŠ äº†ä¸€ä¸ªtoDateTime(&#39;&#123;end&#125;&#39;) å–æ¯æ¬¡é‡‡é›†çª—å£çš„é«˜æ°´ä½. ä¸‰ä¸ªæŸ¥è¯¢åªæ˜¯order byä¸åŒ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192æ˜¨æ—¥æœ€å¤§äº‹ç‰©sizeSELECT $timeSeries as t, sum(transaction_size) sum_transaction_sizeFROM mysql_monitor.$&#123;prefix&#125;_largest_transactionWHERE end_time&gt;=toDateTime(yesterday()) and end_time&lt;toDateTime(today())GROUP BY t,gtidORDER BY sum_transaction_size desc limit 1æ˜¨æ—¥äº‹åŠ¡æœ€å¤§æ‰§è¡Œæ—¶é—´SELECT $timeSeries as t, sum(transaction_spend_time) sum_transaction_spend_timeFROM mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transactionWHERE end_time&gt;=toDateTime(yesterday()) and end_time&lt;toDateTime(today())GROUP BY t,gtidORDER BY sum_transaction_spend_time desc limit 1æ˜¨æ—¥äº‹åŠ¡å½±å“æœ€å¤§è¡Œæ•°SELECT $timeSeries as t, sum(single_statement_affected_rows) transaction_affected_rowsFROM mysql_monitor.$&#123;prefix&#125;_most_affected_rows_transactionWHERE end_time&gt;=toDateTime(yesterday()) and end_time&lt;toDateTime(today())GROUP BY t,gtidORDER BY transaction_affected_rows desc limit 1ä¸Šå‘¨æœ€å¤§äº‹ç‰©æ¦‚è§ˆselect t,max(sum_transaction_size) max_transaction_size from (SELECT toDate(end_time) as t, gtid, sum(transaction_size) sum_transaction_sizeFROM mysql_monitor.$&#123;prefix&#125;_largest_transactionWHERE end_time &gt;= (today() - 6)GROUP BY t,gtid) group by t order by t desc ä¸Šå‘¨äº‹åŠ¡æœ€å¤§æ‰§è¡Œæ—¶é—´æ¦‚è§ˆselect t,max(sum_transaction_spend_time) max_transaction_spend_time from (SELECT toDate(end_time) as t, gtid, sum(transaction_spend_time) sum_transaction_spend_timeFROM mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transactionWHERE end_time &gt;= (today() - 6)GROUP BY t,gtid) group by t order by t desc ä¸Šå‘¨äº‹åŠ¡å½±å“æœ€å¤§è¡Œæ•°æ¦‚è§ˆselect t,max(transaction_affected_rows) max_transaction_affected_rows from (SELECT toDate(end_time) as t, gtid, sum(single_statement_affected_rows) transaction_affected_rowsFROM mysql_monitor.$&#123;prefix&#125;_most_affected_rows_transactionWHERE end_time &gt;= (today() - 6)GROUP BY t,gtid) group by t order by t desc è¿‘å®æ—¶äº‹åŠ¡sizeå›¾SELECT $timeSeries as t, sum(transaction_size) transaction_sizeFROM mysql_monitor.$&#123;prefix&#125;_largest_transactionWHERE $timeFilterGROUP BY t, gtidORDER BY tSELECT $timeSeries as t, sum(transaction_spend_time) transaction_spend_timeFROM mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transactionWHERE $timeFilterGROUP BY t, gtidORDER BY tè¿‘å®æ—¶äº‹åŠ¡å½±å“è¡Œæ•°å›¾SELECT $timeSeries as t, sum(single_statement_affected_rows) transaction_affected_rowsFROM mysql_monitor.$&#123;prefix&#125;_most_affected_rows_transactionWHERE $timeFilterGROUP BY t, gtidORDER BY tSELECT $timeSeries as t, sum(transaction_spend_time) transaction_spend_timeFROM mysql_monitor.$&#123;prefix&#125;_most_time_consuming_transactionWHERE $timeFilterGROUP BY t, gtidORDER BY t æ€»ç»“å®é™…å¹²ä¸‹æ¥å‘ç°ä¸€äº›æŸ¥è¯¢ç¡®å®å¯ä»¥é€šè¿‡ç‰©åŒ–è§†å›¾ä¼˜åŒ–, ä½†æ˜¯grafanaæ¯æ¬¡éƒ½è¦å¸¦ä¸€ä¸ªDateTimeæ¯”è¾ƒçƒ¦, å¯èƒ½ç‰©åŒ–è§†å›¾è¿˜æœ‰ä¼˜åŒ–ç©ºé—´. å¯¹äºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„å®æ—¶ç»Ÿè®¡çš„éœ€æ±‚daily_binlogè¿™ç§å¤©çº§ç‰©åŒ–è§†å›¾å°±æ— æ³•å®ç°ç»†ç²’åº¦çš„æŸ¥è¯¢äº†(æŸ¥è¯¢é€Ÿåº¦å¤ªæ…¢, å¿…é¡»å€ŸåŠ©ç‰©åŒ–è§†å›¾) é‚£ä¹ˆå¦‚ä½•å®ç°æ›´ç»†ç²’åº¦çš„ç‰©åŒ–è§†å›¾å‘¢? å¾—çœ‹ä¸‹å¦‚ä½•æŒ‰å‘¨æœŸèšåˆ, æ¯”å¦‚5åˆ†é’Ÿä¸€ä¸ªèšåˆ. ç›®å‰clickhouseæ²¡æœ‰oracleé‚£æ ·çš„å¼€çª—å‡½æ•° oracleå¯ä»¥ sum over(partition by gtid order by execute_time range between interval â€˜1â€™ day preceding and interval â€˜1â€™ day following) å¯¹äºä¸€äº›ä¸å¥½ä¼˜åŒ–çš„æŸ¥è¯¢, å¦‚æœæ¢é©¬èœ‚çªé‚£äº›ä¸€å¤©ä¸Šç™¾G binlogçš„åº“å¯èƒ½çœŸçš„è·‘ä¸åŠ¨äº†. ä¹Ÿè®¸åªèƒ½å¤šæå‡ ä¸ªåˆ†ç‰‡, ä¸è¿‡ä¸çŸ¥é“æœ€åèšåˆä¼šä¸ä¼šå¾ˆè€—å†…å­˜, æ„Ÿè§‰æœ€ä¸»è¦æ˜¯è¿™å¥—ç³»ç»Ÿæ˜¯å¦å€¼å¾—ä»˜å‡ºåŠ èŠ‚ç‚¹çš„é‡‘é’±æˆæœ¬.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Canal","slug":"Canal","permalink":"http://fuxkdb.com/tags/Canal/"},{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"}]},{"title":"ç±»MHAé«˜å¯ç”¨æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜","slug":"2020-09-24-ç±»MHAé«˜å¯ç”¨æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜","date":"2020-09-24T11:00:00.000Z","updated":"2021-03-10T14:36:57.040Z","comments":true,"path":"2020/09/24/2020-09-24-ç±»MHAé«˜å¯ç”¨æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜/","link":"","permalink":"http://fuxkdb.com/2020/09/24/2020-09-24-%E7%B1%BBMHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98/","excerpt":"ç±»MHAé«˜å¯ç”¨æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜MHA Generaly Available since 2011? MHAåœ¨å½“æ—¶ä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜: è‡ªåŠ¨çš„æ•°æ®è¡¥å¿ è‡ªåŠ¨çš„ä¸»ä»åˆ‡æ¢ è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„èƒŒæ™¯éœ€è¦äº¤ä»£: å½“æ—¶ä¸»è¦ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ å½“æ—¶è¿˜æ²¡æœ‰ProxySQL æ‰€ä»¥å½“æ—¶åŸºæœ¬ä½¿ç”¨MHA+VIPä½œä¸ºMySQLå¤åˆ¶é›†çš„é«˜å¯ç”¨æ–¹æ¡ˆ. ä¸è°ˆvipçš„è„‘è£‚é—®é¢˜, è¿™ç§æ¶æ„çš„ä¸€ä¸ªå…³é”®ç‚¹åœ¨äº, MHAæ˜¯ä½œä¸ºä¸€ä¸ªå¤–éƒ¨æœºåˆ¶æ£€æµ‹MySQLå¤åˆ¶é›†çŠ¶æ€, å¹¶å˜æ›´å¤åˆ¶é›†æ‹“æ‰‘, å˜æ›´åæ¼‚ç§»vip, ä¹Ÿå°±æ˜¯è¯´MHAæ—¢æ§åˆ¶äº†é›†ç¾¤æ‹“æ‰‘çš„å˜åŒ–, åˆæ§åˆ¶äº†appçš„è®¿é—®è·¯å¾„(å†™é€šè¿‡vip)","text":"ç±»MHAé«˜å¯ç”¨æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜MHA Generaly Available since 2011? MHAåœ¨å½“æ—¶ä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜: è‡ªåŠ¨çš„æ•°æ®è¡¥å¿ è‡ªåŠ¨çš„ä¸»ä»åˆ‡æ¢ è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„èƒŒæ™¯éœ€è¦äº¤ä»£: å½“æ—¶ä¸»è¦ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ å½“æ—¶è¿˜æ²¡æœ‰ProxySQL æ‰€ä»¥å½“æ—¶åŸºæœ¬ä½¿ç”¨MHA+VIPä½œä¸ºMySQLå¤åˆ¶é›†çš„é«˜å¯ç”¨æ–¹æ¡ˆ. ä¸è°ˆvipçš„è„‘è£‚é—®é¢˜, è¿™ç§æ¶æ„çš„ä¸€ä¸ªå…³é”®ç‚¹åœ¨äº, MHAæ˜¯ä½œä¸ºä¸€ä¸ªå¤–éƒ¨æœºåˆ¶æ£€æµ‹MySQLå¤åˆ¶é›†çŠ¶æ€, å¹¶å˜æ›´å¤åˆ¶é›†æ‹“æ‰‘, å˜æ›´åæ¼‚ç§»vip, ä¹Ÿå°±æ˜¯è¯´MHAæ—¢æ§åˆ¶äº†é›†ç¾¤æ‹“æ‰‘çš„å˜åŒ–, åˆæ§åˆ¶äº†appçš„è®¿é—®è·¯å¾„(å†™é€šè¿‡vip) è„‘è£‚MHA+ProxySQLæ¶æ„æœ‰ä¸€ä¸ªé—®é¢˜: MHAå¯¹MySQLå¤åˆ¶é›†çš„ç›‘æ§æ£€æµ‹é€»è¾‘ä¸­ä¸åŒ…å«ProxySQL, å› ä¸ºMHAä¸çŸ¥é“ç”¨æˆ·åœ¨MySQLä¸Šå±‚ä¼šæ„å»ºä»€ä¹ˆæ ·çš„ä¸­é—´ä»¶, åŒæ—¶MHAå˜æ›´é›†ç¾¤æ‹“æ‰‘åä¹Ÿå¹¶ä¸ä¼šé€šçŸ¥ProxySQL. ä¹Ÿå°±æ˜¯è¯´MHAå’ŒProxySQLæœ‰å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„â€è§‚ç‚¹â€ å¦‚ä¸Šå›¾åœºæ™¯ APP-1, ProxySQL-1å’Œä¸»åº“åœ¨ä¸€ä¸ªç½‘ç»œåˆ†åŒº, æ­£åœ¨å†™å…¥æ•°æ®(å¼‚æ­¥å¤åˆ¶, æˆ–åŠåŒæ­¥è¶…æ—¶ä¸æ˜¯æ— é™å¤§) APP-2, ProxySQL-2, ä»åº“å’ŒMHA manageråœ¨ä¸€ä¸ªç½‘è·¯åˆ†åŒº, æ— æ³•è¿é€šä¸»åº“ è¿™ç§æƒ…å†µ, MHAä¼šFailover. Failoveråå˜æˆå¦‚ä¸‹æ‹“æ‰‘ è¿™å°±å¯¼è‡´äº†è„‘è£‚(å¦‚æœæ˜¯åŠåŒæ­¥ä¸”è¶…æ—¶æ— é™å¤§, é‚£ä¹ˆä¸ä¼šè„‘è£‚, å› ä¸ºæ•°æ®æ— æ³•å†™å…¥Master). å®é™…ä¸Šå¦‚æœåœ¨secondary_check_scriptä¸­é…ç½®äº†ProxySQLåœ°å€ 1secondary_check_script=masterha_secondary_check -s ProxySQL-1 -s ProxySQL-2 -s Slave-1 -s Slave-2 -s Slave-3 è¿™æ ·é…ç½®å, åœ¨å›¾-1çš„åœºæ™¯ä¸­, manageräºŒæ¬¡æ£€æµ‹æ—¶æ— æ³•sshåˆ°ProxySQL-1, äºŒæ¬¡æ£€æµ‹è„šæœ¬ä¼šä»¥exit_code=2é€€å‡º, ä¸ä¼šå‘ç”ŸFailover, å°±ä¸ä¼šè„‘è£‚(å¦‚æœæ˜¯åŠåŒæ­¥ä¸”è¶…æ—¶æ— é™å¤§, é‚£ä¹ˆä¸ä¼šè„‘è£‚, å› ä¸ºæ•°æ®æ— æ³•å†™å…¥Master). 12345åœ¨masterha_secondary_checkè„šæœ¬ä¸­æœ‰å¦‚ä¸‹æ³¨é‡Š, è¿™æ˜¯exit codeçš„å«ä¹‰, åªæœ‰0ä¼šè§¦å‘Failover# 0: master is not reachable from all monotoring servers# 1: unknown errors# 2: at least one of monitoring servers is not reachable from this script# 3: master is reachable from at least one of monitoring servers æç«¯åœºæ™¯æ— æ³•å®ŒæˆFailoverä¸Šæ–‡çš„åœºæ™¯å°±æ˜¯ä¸€ç§æç«¯åœºæ™¯. åœ¨è¿™ç§åœºæ™¯(å›¾-1)ä¸‹, æ­£ç¡®çš„åšæ³•æ˜¯åˆ‡æ–­Masteræµé‡(å…³é—­APP-1å¹¶ä¸å¤ªç°å®, å› ä¸ºå®é™…å¯èƒ½ä¸åªä¸€ä¸ªåº”ç”¨, å…³é—­ProxySQLæˆ–Masteréƒ½æ˜¯å¯ä»¥çš„), ç„¶åè¿›è¡Œåˆ‡æ¢. ä½†è¿™æ­£æ˜¯MHAæ— æ³•åšåˆ°çš„. æƒ³è±¡å›¾-3åœºæ™¯, ä½¿ç”¨åŠåŒæ­¥å¤åˆ¶rpl_semi_sync_master_wait_for_slave_count=1 è¿™ç§æƒ…å†µä¸‹, MHAä»ç„¶ä¸ä¼šFailover(äºŒæ¬¡æ£€æµ‹è„šæœ¬-sä¸­æŒ‡å®šäº†slave-4), é‚£ä¹ˆæŒ‰ç…§æ­£å¸¸é€»è¾‘, åº”è¯¥Failoverå—? ä¸ªäººè®¤ä¸ºè¦çœ‹æƒ…å†µ: å¦‚æœæ·»åŠ ä»åº“çš„é€Ÿåº¦å¾ˆæ…¢, ä¸€æ—¦Slave-4å‡ºç°é—®é¢˜æ— æ³•è¿”å›ack, Masterå°†ä¸èƒ½æä¾›å†™å…¥, é‚£ä¹ˆåº”è¯¥Failover, å°†Slave1-3ç»„æˆä¸€ä¸ªæ–°çš„å¤åˆ¶é›†, ä¸€ä¸»ä¸¤ä», ä¸¤ä¸ªä»åº“å‡ºç°å¼‚å¸¸çš„æ¦‚ç‡æ˜¾ç„¶è¦å°å¾ˆå¤š å¦‚æœæ·»åŠ ä»åº“çš„é€Ÿåº¦å¾ˆå¿«(å¤‡ä»½é›†å°, è‡ªåŠ¨åŒ–å®Œå–„), å¹¶ä¸”å½“æ—¶çš„åœºæ™¯ä¸å…è®¸å“ªæ€•3-5ç§’çš„ä¸å¯ç”¨(åˆ‡æ¢ç”¨æ—¶), é‚£ä¹ˆå¯ä»¥å¿«é€Ÿä¸ºMasteræ·»åŠ ä¸€ä¸ªä»åº“Slave-5 ä¸ºä»€ä¹ˆç±»MHAçš„é«˜å¯ç”¨æ–¹æ¡ˆåœ¨è¿™ç§æƒ…å†µä¸‹æ— æ³•å®ŒæˆFailover? ProxySQLæ˜¯ä¸€ä¸ªâ€ä¼ªé›†ç¾¤â€ ProxySQLé›†ç¾¤ç›®å‰åªåšåˆ°äº†é…ç½®åŒæ­¥, æˆå‘˜ä¹‹é—´å¹¶æ²¡æœ‰ä½¿ç”¨å…±è¯†ç®—æ³•å®ç°é€‰ä¸¾æœºåˆ¶, åœ¨å›¾-1çš„åœºæ™¯ä¸­æ£€æŸ¥ProxySQL-1å’ŒProxySQL-2çš„runtime_mysql_servers, ä½ ä¼šçœ‹åˆ°è¿™æ ·çš„ç»“æœ 123456789101112131415161718192021ProxySQL-1admin@127.0.0.1 15:10:50 [(none)]&gt; select * from runtime_mysql_servers;+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+| 10 | 172.16.120.10 | 3358 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | master for backup read || 11 | 172.16.120.10 | 3358 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | master for backup read || 11 | 172.16.120.12 | 3358 | 0 | SHUNNED | 1000 | 0 | 1000 | 120 | 0 | 0 | slave || 11 | 172.16.120.11 | 3358 | 0 | SHUNNED | 1000 | 0 | 1000 | 120 | 0 | 0 | slave |+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+ProxySQL-2admin@127.0.0.1 15:10:14 [(none)]&gt; select * from runtime_mysql_servers; +--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+| 11 | 172.16.120.11 | 3358 | 0 | ONLINE | 1000 | 0 | 1000 | 120 | 0 | 0 | slave || 11 | 172.16.120.10 | 3358 | 0 | SHUNNED | 1 | 0 | 1000 | 0 | 0 | 0 | master for backup read || 11 | 172.16.120.12 | 3358 | 0 | ONLINE | 1000 | 0 | 1000 | 120 | 0 | 0 | slave |+--------------+---------------+------+-----------+---------+--------+-------------+-----------------+---------------------+---------+----------------+------------------------+3 rows in set (0.00 sec) å¦‚æœProxySQLé›†ç¾¤æœ‰é€‰ä¸¾æœºåˆ¶, é‚£ä¹ˆä¸€ä¸ªé›†ç¾¤è‡³å°‘éœ€è¦ä¸‰ä¸ªèŠ‚ç‚¹, å½“ä¸€ä¸ªèŠ‚ç‚¹æ„è¯†åˆ°è‡ªå·±æ— æ³•ä¸å¤§å¤šæ•°æˆå‘˜é€šä¿¡æ—¶, å®ƒåº”å½“å°†è‡ªå·±ç½®ä¸ºä¸å¯ç”¨çŠ¶æ€. MHA managerå•ç‚¹ è¿™å’ŒProxySQLæœ‰ä¸€äº›ç±»ä¼¼çš„æƒ…å†µ. å¦‚æœMHAä¹Ÿæ˜¯ä¸€ä¸ªé›†ç¾¤, å¹¶åœ¨MySQLå¤åˆ¶é›†çš„æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²ä¸€ä¸ªnode, é‚£ä¹ˆåœ¨å›¾-1çš„åœºæ™¯ä¸­, MasterèŠ‚ç‚¹ä¸Šçš„MHA nodeåº”å½“æ„è¯†åˆ°è‡ªå·±å·²ç»è„±ç¦»äº†å¤§å¤šæ•°æˆå‘˜, å®ƒæ— æ³•å‘èµ·MySQLæ‹“æ‰‘å˜æ›´, å®ƒè¦åšåº”å½“æ˜¯å…³é—­Master(æˆ–æ‰“å¼€read_only) é’äº‘å¼€æºçš„Xenonå¥½åƒå®ç°äº†ç±»ä¼¼çš„åŠŸèƒ½, ä½†æˆ‘ä¹Ÿä¸ç¡®å®š, è¿™ä¸ªé¡¹ç›®ä½¿ç”¨äººæ•°å¤ªå°‘ â€‹ https://github.com/radondb/xenon/issues/107 â€‹ ä¸è¿‡åŒæ ·, xenonæ˜¯ä½¿ç”¨vipä¸ºåº”ç”¨æä¾›å†™å…¥é€šé“, ä¹Ÿå°±æ˜¯è¯´xenonæ§åˆ¶äº†è®¿é—®è·¯å¾„ Orchestratorä¸çŸ¥é“æ˜¯å¦å®ç°äº†è¿™æ ·çš„åŠŸèƒ½, éœ€è¦è°ƒç ” MHAçš„æ£€æµ‹é€»è¾‘ä¸åŒ…å«ProxySQL, å˜æ›´æ‹“æ‰‘åä¹Ÿæ²¡æœ‰é€šçŸ¥ProxySQL MHAçš„æ£€æµ‹æœºåˆ¶å’ŒProxySQLå¹¶ä¸ç›¸åŒ, ä¸¤è€…å¯èƒ½å¯¹æ‹“æ‰‘æƒ…å†µæœ‰ä¸åŒçš„åˆ¤æ–­. åº”å½“æ”¹é€ äºŒæ¬¡æ£€æµ‹è„šæœ¬, é€šè¿‡è¿æ¥ProxySQLåˆ¤æ–­ä¸»åº“çŠ¶æ€, ä½†å³ä½¿è¿™æ ·åš, åœ¨å›¾-1çš„åœºæ™¯ä¸­, managerä¼šå‘ç°è‡ªå·±æ— æ³•è¿æ¥ProxySQL-1, é‚£ä¹ˆäºŒæ¬¡æ£€æµ‹è„šæœ¬åº”å½“ä»¥exit_code=2é€€å‡º, ä¸ä¼šå‘ç”ŸFailover, æ‰€ä»¥è¿™ä»ç„¶æ— æ³•è§£å†³æç«¯åœºæ™¯ä¸èƒ½Failoverçš„é—®é¢˜. Failoverå, MHAåº”å½“ä¸»åŠ¨å˜æ›´ProxySQLä¸­çš„é…ç½® æºç¨‹æ•°æ®åº“é«˜å¯ç”¨æ¶æ„å®è·µæœ‰ç±»ä¼¼æè¿° æ­£ç¡®çš„åšæ³•ä¸å›¾-4ç±»ä¼¼, åœ¨FailoveråMHAåº”å½“å°†æ–°çš„æ‹“æ‰‘é…ç½®æ¨é€ç»™â€é…ç½®ä¸­å¿ƒâ€, ä¿è¯åº”ç”¨ä½¿ç”¨æ–°çš„é…ç½®è¿æ¥æ•°æ®åº“ ç¾å›¢ä¹Ÿå®ç°äº†ç±»ä¼¼çš„åŠŸèƒ½è¸©å‘æ— æ•°ï¼Œç¾å›¢ç‚¹è¯„é«˜å¯ç”¨æ•°æ®åº“æ¶æ„æ¼”è¿› ä¸»ä»å¤åˆ¶é›†å¹¶ä¸æ˜¯é›†ç¾¤ å³ä¾¿ä»åº“éƒ½åˆ¤å®šä¸»åº“ä¸å¯ç”¨, ä¹Ÿæ— èƒ½ä¸ºåŠ›. è€Œå‡è®¾æ˜¯ä¸€ä¸ªPXCæˆ–MGRé›†ç¾¤(æˆ‘ä»¬å…ˆä¸è®¨è®ºè¿™ä¸¤è€…çš„é—®é¢˜), å›¾-1çš„åœºæ™¯ä¼šå˜æˆè¿™æ ·(ä»¥PXCä¸ºä¾‹): å®é™…ä¸Šå›¾ä¸­PXCèŠ‚ç‚¹æ•°é‡ä¸ºå¶æ•°å¹¶ä¸åˆç†, åªæ˜¯ä¸ºäº†è¿åˆå›¾-1åœºæ™¯ä½œå¯¹æ¯” åœ¨PXCä¸­, æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ä¸»èŠ‚ç‚¹, éƒ½å¯ä»¥å†™å…¥, åªè¦æäº¤æˆåŠŸå°±ä¸ä¼šä¸¢å¤±æ•°æ® MGRä¹Ÿæœ‰å¤šä¸»æ¨¡å¼, å¦‚æœæ˜¯å•ä¸»æ¨¡å¼, è„±ç¦»é›†ç¾¤çš„èŠ‚ç‚¹ä¼šå°†è‡ªå·±è®¾ä¸ºread_only åœ¨å›¾-5çš„æƒ…å†µä¸‹, Masterä¼šè¢«è¸¢å‡ºé›†ç¾¤, ä¹Ÿå°±æ˜¯è¯´é€‰ä¸¾å’Œæ‹“æ‰‘å˜æ›´æ˜¯MySQLè‡ªå·±æ§åˆ¶çš„, ProxySQLåªéœ€è¦è¢«åŠ¨æ¥å—å°±å¥½äº†. (å¦‚æœæ— æ³•è¸¢å‡ºMasterå‘¢? é‚£åªèƒ½è¯´é‡åˆ°äº†å†…éƒ¨bug, ä»»ä½•è½¯ä»¶éƒ½å¯èƒ½æœ‰bug, åŒ…æ‹¬MHA ProxySQL, Orchestratorç­‰) å³ä¾¿æ˜¯ä¸‹å›¾çš„åœºæ™¯, PXCå’ŒMGRä¹Ÿèƒ½å¾ˆå¥½åœ°å®Œæˆé€‰ä¸¾, å‰”é™¤Masterå’ŒSlave-4 æ€»ç»“å¯¹äºç±»MHAé«˜å¯ç”¨æ–¹æ¡ˆ, éœ€è¦è¿›è¡Œæ”¹é€ ä»¥é€‚åº”ä¸­é—´ä»¶. å¯¹äºMHAæ¥è¯´: è¦æ”¹é€ masterha_secondary_checkè„šæœ¬, åœ¨äºŒæ¬¡æ£€æµ‹æ—¶è¿æ¥ProxySQLè¿›è¡Œä¸»åº“æ¢æ´». master_ip_failoverä¹Ÿéœ€è¦æ”¹é€ , è¦åœ¨failoverååˆ é™¤ProxySQL runtime_mysql_serverä¸­åŸä¸»ä¿¡æ¯å¹¶load ä¸€å®šè¦å°†åŠåŒæ­¥è¶…æ—¶è®¾ç½®æ— é™å¤§, é¿å…è„‘è£‚ å¦‚æœæ”¾å¼ƒMHA, æ— è®ºé€‰æ‹©Orchestrator, PXCäº¦æˆ–æ˜¯MGR, éƒ½æ˜¯MySQLæ¶æ„ä¸Šçš„å¤§å˜åŠ¨, éœ€è¦é•¿æ—¶é—´çš„æŠ€æœ¯è°ƒç ”å’Œæµ‹è¯•ä»¥åŠä¸šåŠ¡æ–¹çš„é…åˆ, è¿™ä¸‰è€…ä»»ä½•ä¸€ä¸ªéƒ½éœ€è¦DBAèŠ±æ—¶é—´å­¦ä¹ , æ˜¯å¦å‡çº§æ¶æ„å–å†³äºæˆ‘ä»¬é¢ä¸´çš„é—®é¢˜æ˜¯ä¸æ˜¯æœ€è¿«åˆ‡éœ€è¦è§£å†³çš„, ä»¥åŠé£é™©å¯æ§æ€§(æ‰å®çš„ç†è®ºåŸºç¡€å’Œå®Œå–„çš„æµ‹è¯•å¯ä»¥æé«˜å¯æ§æ€§). é‚£ä¹ˆé€‰æ‹©å…¶å®å°±ä¸¤ç§: ç»§ç»­ä½¿ç”¨MHAæˆ–ç±»MHAæ¶æ„, éœ€è¦åšäºŒæ¬¡å¼€å‘é€‚åº”ProxySQL ä½¿ç”¨PXCæˆ–MGRè¿™ç±»â€åŸç”Ÿâ€é›†ç¾¤æ–¹æ¡ˆ, éœ€è¦å®é™…æ•°æ®è®ºè¯å½“å‰ä¸šåŠ¡æ˜¯å¦å¯ä»¥åšè¿™æ ·çš„æ¶æ„è°ƒæ•´. ä¸ªäººè®¤ä¸ºä¸¤ç§éƒ½å¯ä»¥, ä¸è¿‡MGRå¿…å°†æ˜¯æœªæ¥é‡‘èçº§é«˜å¯ç”¨æ–¹æ¡ˆçš„äº‹å®æ ‡å‡†(ä¸ªäººæ‹™è§, æ®æˆ‘æ‰€çŸ¥ç½‘æ˜“,è…¾è®¯é‡‘èç›®å‰å°±æ˜¯ä½¿ç”¨MGR,ä¸è¿‡å®ƒä»¬å¯¹æºç åšäº†ä¿®æ”¹, è¿™å¹¶éä¸­å°ä¼ä¸šæ‰€å…·å¤‡çš„èƒ½åŠ›), ä½†ç›®å‰ä»éœ€ç­‰å¾…(å‘å±•åªæœ‰4å¹´), è€ŒPXCå·²ç»å‘å±•8å¹´äº†, ç›®å‰æ¥çœ‹ç›¸æ¯”MGRæ›´å¯é (å»å“ªå„¿ç½‘, é©¬èœ‚çªå’Œä¹‹å‰çš„ä¸€äº›p2pä¼ä¸šéƒ½æ˜¯ç”¨PXC), ä½†ä»»ä½•èƒ½ä¿è¯å¼ºä¸€è‡´æ€§çš„é›†ç¾¤éƒ½å¿…ç„¶ä¼šæœ‰æ€§èƒ½æŸè€—, è¿˜è¦çœ‹ä¸šåŠ¡æ˜¯å¦å¯ä»¥æ¥å—. å¦‚æœç”¨é•¿è¿œçš„çœ¼å…‰çœ‹, è°ƒç ”å¹¶åœ¨ä¸€äº›è¾¹ç¼˜ç³»ç»Ÿå®è·µMGRæ˜¯éœ€è¦åšçš„. å¦‚CMDB, æ˜æ˜¾çš„è¯»å¤šå†™å°‘çš„ç³»ç»Ÿ, ç¾å›¢ç‚¹è¯„åŸºäºMGRçš„CMDBé«˜å¯ç”¨æ¶æ„æ­å»ºä¹‹è·¯","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"ClickHouseåˆ°åº•æ”¹å†™æœ¬åœ°è¡¨è¿˜æ˜¯åˆ†å¸ƒå¼è¡¨","slug":"2020-09-22-ClickHouseåˆ°åº•æ”¹å†™æœ¬åœ°è¡¨è¿˜æ˜¯åˆ†å¸ƒå¼è¡¨","date":"2020-09-22T02:30:00.000Z","updated":"2020-09-22T02:31:06.713Z","comments":true,"path":"2020/09/22/2020-09-22-ClickHouseåˆ°åº•æ”¹å†™æœ¬åœ°è¡¨è¿˜æ˜¯åˆ†å¸ƒå¼è¡¨/","link":"","permalink":"http://fuxkdb.com/2020/09/22/2020-09-22-ClickHouse%E5%88%B0%E5%BA%95%E6%94%B9%E5%86%99%E6%9C%AC%E5%9C%B0%E8%A1%A8%E8%BF%98%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8/","excerpt":"TL;DRå¦‚æœé¢„ä¼°è‡ªå·±çš„ä¸šåŠ¡æ•°æ®é‡ä¸å¤§(æ—¥å¢ä¸åˆ°ç™¾ä¸‡è¡Œ), é‚£ä¹ˆå†™åˆ†å¸ƒå¼è¡¨å’Œæœ¬åœ°è¡¨éƒ½å¯ä»¥, ä½†è¦æ³¨æ„å¦‚æœé€‰æ‹©å†™æœ¬åœ°è¡¨, è¯·ä¿è¯æ¯æ¬¡å†™å…¥æ•°æ®éƒ½å»ºç«‹æ–°çš„è¿æ¥, ä¸”æ¯ä¸ªè¿æ¥å†™å…¥çš„æ•°æ®é‡åŸºæœ¬ç›¸åŒ å¦‚æœé¢„ä¼°è‡ªå·±çš„ä¸šåŠ¡æ•°æ®é‡å¤§(æ—¥å¢ç™¾ä¸‡ä»¥ä¸Š, å¹¶å‘æ’å…¥å¤§äº10), é‚£ä¹ˆè¯·å†™æœ¬åœ°è¡¨ å»ºè®®æ¯æ¬¡æ’å…¥50Wè¡Œå·¦å³æ•°æ®, æœ€å¤šä¸å¯è¶…è¿‡100Wè¡Œ. æ€»ä¹‹CHä¸åƒMySQLè¦å°äº‹åŠ¡. æ¯”å¦‚1000Wè¡Œæ•°æ®, MySQLå»ºè®®ä¸€æ¬¡æ’å…¥1Wå·¦å³, ä½¿ç”¨å°äº‹åŠ¡, æ‰§è¡Œ1000æ¬¡. CHå»ºè®®20æ¬¡,æ¯æ¬¡50W. è¿™æ˜¯MergeTreeå¼•æ“åŸç†å†³å®šçš„, é¢‘ç¹å°‘é‡æ’å…¥ä¼šå¯¼è‡´data partè¿‡å¤š, åˆå¹¶ä¸è¿‡æ¥. å†æœ‰, APä¸åƒTP, TPä¸ºäº†é¿å…å»ºç«‹æ–°è¿æ¥äº§ç”Ÿçš„æŸè€—å½±å“æ€§èƒ½, é€šå¸¸ä¼šä½¿ç”¨é•¿è¿æ¥, è¿æ¥æ± ç­‰æŠ€æœ¯åšä¼˜åŒ–. ä½†APä¸šåŠ¡ä¸éœ€è¦, å› ä¸ºAPçš„å±æ€§å°±ä¸ä¼šæœ‰é«˜å¹¶å‘, å°SQL.","text":"TL;DRå¦‚æœé¢„ä¼°è‡ªå·±çš„ä¸šåŠ¡æ•°æ®é‡ä¸å¤§(æ—¥å¢ä¸åˆ°ç™¾ä¸‡è¡Œ), é‚£ä¹ˆå†™åˆ†å¸ƒå¼è¡¨å’Œæœ¬åœ°è¡¨éƒ½å¯ä»¥, ä½†è¦æ³¨æ„å¦‚æœé€‰æ‹©å†™æœ¬åœ°è¡¨, è¯·ä¿è¯æ¯æ¬¡å†™å…¥æ•°æ®éƒ½å»ºç«‹æ–°çš„è¿æ¥, ä¸”æ¯ä¸ªè¿æ¥å†™å…¥çš„æ•°æ®é‡åŸºæœ¬ç›¸åŒ å¦‚æœé¢„ä¼°è‡ªå·±çš„ä¸šåŠ¡æ•°æ®é‡å¤§(æ—¥å¢ç™¾ä¸‡ä»¥ä¸Š, å¹¶å‘æ’å…¥å¤§äº10), é‚£ä¹ˆè¯·å†™æœ¬åœ°è¡¨ å»ºè®®æ¯æ¬¡æ’å…¥50Wè¡Œå·¦å³æ•°æ®, æœ€å¤šä¸å¯è¶…è¿‡100Wè¡Œ. æ€»ä¹‹CHä¸åƒMySQLè¦å°äº‹åŠ¡. æ¯”å¦‚1000Wè¡Œæ•°æ®, MySQLå»ºè®®ä¸€æ¬¡æ’å…¥1Wå·¦å³, ä½¿ç”¨å°äº‹åŠ¡, æ‰§è¡Œ1000æ¬¡. CHå»ºè®®20æ¬¡,æ¯æ¬¡50W. è¿™æ˜¯MergeTreeå¼•æ“åŸç†å†³å®šçš„, é¢‘ç¹å°‘é‡æ’å…¥ä¼šå¯¼è‡´data partè¿‡å¤š, åˆå¹¶ä¸è¿‡æ¥. å†æœ‰, APä¸åƒTP, TPä¸ºäº†é¿å…å»ºç«‹æ–°è¿æ¥äº§ç”Ÿçš„æŸè€—å½±å“æ€§èƒ½, é€šå¸¸ä¼šä½¿ç”¨é•¿è¿æ¥, è¿æ¥æ± ç­‰æŠ€æœ¯åšä¼˜åŒ–. ä½†APä¸šåŠ¡ä¸éœ€è¦, å› ä¸ºAPçš„å±æ€§å°±ä¸ä¼šæœ‰é«˜å¹¶å‘, å°SQL. åŸå› è¯·ç»§ç»­çœ‹çœ‹äº†ä¸€äº›æ–‡æ¡£éƒ½å»ºè®®å†™åˆ†å¸ƒå¼è¡¨, è™½è¯´åˆ«äººæ²¡å¿…è¦éª—æˆ‘ä»¬, ä½†æ˜¯ææŠ€æœ¯çš„ä¸èƒ½äººäº‘äº¦äº‘, è¿˜æ˜¯è¦æ˜ç™½ä¸ºå•¥, è¯´å®è¯æˆ‘æƒ³äº†å¾ˆä¹…æ²¡æƒ³å‡ºç›´æ¥å†™åˆ†å¸ƒå¼è¡¨æœ‰ä»€ä¹ˆè‡´å‘½ç¼ºé™·, äºæ˜¯åœ¨ClickHouseä¸­æ–‡ç¤¾åŒºæäº†é—®é¢˜, å†…å®¹å¦‚ä¸‹ çœ‹äº†sinaé«˜é¹å¤§ä½¬çš„åˆ†äº«ï¼Œçœ‹äº† https://github.com/ClickHouse/ClickHouse/issues/1854 ï¼Œè¿˜çœ‹äº†ä¸€äº›æ–‡ç« éƒ½æ˜¯å»ºè®®å†™æœ¬åœ°è¡¨è€Œä¸æ˜¯åˆ†å¸ƒå¼è¡¨å¦‚æœæˆ‘è®¾ç½® internal_replication=true , ä½¿ç”¨ ReplicatedMergeTree å¼•æ“, é™¤äº†å†™æœ¬åœ°è¡¨æ›´çµæ´»å¯æ§å¤–, å†™åˆ†å¸ƒå¼è¡¨åˆ°åº•æœ‰ä»€ä¹ˆè‡´å‘½ç¼ºé™·å—?å› ä¸ºè¦ç»™åŒäº‹è§£é‡Š, åªè¯´ä¸€ä¸ªå¤§å®¶è¯´æœ€ä½³å®è·µæ˜¯è¿™æ ·æ˜¯ä¸è¡Œçš„.. æˆ‘è‡ªå·±ä¹Ÿæ²¡ç†è§£åˆ°åº•å†™åˆ†å¸ƒå¼è¡¨æœ‰å•¥å¤§ç¼ºé™·å¦‚æœè¯´é€ æˆæ•°æ®åˆ†å¸ƒä¸å‡åŒ€, sharding key æˆ‘è®¾ä¸º rand() è¿˜ä¼šæœ‰å¾ˆå¤§ä¸å‡åŒ€å—? å¦‚æœè¯´æ‰©å®¹, æˆ‘ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´ weight æ§åˆ¶æ•°æ®å°½é‡å†™å…¥æ–° shared å•Š? éš¾é“æ˜¯å› ä¸ºï¼š Data is written asynchronously. When inserted in the table, the data block is just written to the local file system. The data is sent to the remote servers in the background as soon as possible. The period for sending data is managed by the distributed_directory_monitor_sleep_time_ms and distributed_directory_monitor_max_sleep_time_ms settings. The Distributed engine sends each file with inserted data separately, but you can enable batch sending of files with the distributed_directory_monitor_batch_inserts setting. This setting improves cluster performance by better utilizing local server and network resources. You should check whether data is sent successfully by checking the list of files (data waiting to be sent) in the table directory: /var/lib/clickhouse/data/database/table/. &gt; If the server ceased to exist or had a rough restart (for example, after a device failure) after an INSERT to a Distributed table, the inserted data might be lost. If a damaged data part is detected in the table directory, it is transferred to the â€˜brokenâ€™ subdirectory and no longer used. ä¸Šé¢æ–‡æ¡£å†…å®¹æˆ‘ç†è§£æ„æ€æ˜¯è¯´å‡å¦‚æˆ‘æœ‰S1 S2 S3 ä¸‰ä¸ªèŠ‚ç‚¹,æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰localè¡¨å’Œåˆ†å¸ƒå¼è¡¨. æˆ‘å‘S1çš„åˆ†å¸ƒå¼è¡¨å†™æ•°æ®1, 2, 3ï¼Œ1å†™å…¥S1, 2,3å…ˆå†™åˆ°S1æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ, ç„¶åå¼‚æ­¥å‘é€åˆ°S2 S3 , æ¯”å¦‚2å‘ç»™S2, 3å‘ç»™S3, å¦‚æœæ­¤æ—¶S3å®•æœºäº†, åˆ™3å‘åˆ°S3å¤±è´¥, ä½†æ˜¯1,2è¿˜æ˜¯æˆåŠŸå†™åˆ°S1,S2äº†? æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹ä¸èƒ½ä¿è¯åŸå­æ€§? å‡ºç°é—®é¢˜è¿˜è¦äººä¸ºä¿®æ•°æ®? https://github.com/ClickHouse/ClickHouse/issues/1343 è¿™ä¸ªissueè¯´S3 come backåS1ä¼šå°è¯•é‡æ–°å‘é€æ•°æ®ç»™S3. Data blocks are written in /var/lib/clickhouse/data/database/table/ folder. Special thread checks directory periodically and tries to send data. If it canâ€™t, it will try next time. é‚£ä¹ˆåªå‰©æ–‡æ¡£æœ€åä¸€å¥æ„æ€æ˜¯å¦‚æœS1è¿‡ç¨‹ä¸­å®•æœº, ä¼šä¸¢æ•°æ®?è‡ªé—®è‡ªç­”ä¸€ä¸‹å§, weight æ˜¯åˆ†ç‰‡çº§åˆ«çš„, ä¸æ˜¯è¡¨çº§åˆ«çš„, çµæ´»æ€§å·® é—®äº†ä¸‹æ–°æµªçš„é«˜é¹é«˜é¹çš„å›ç­”æ€»ç»“ä¸€ä¸‹å°±æ˜¯: æ–°æµªæ¯å¤©å¢é‡æ˜¯åƒäº¿çº§çš„, INSERTå¹¶å‘å’ŒèŠ‚ç‚¹æ•°åº”è¯¥æ¯”è¾ƒé«˜, ç›´æ¥å†™æŸä¸ªèŠ‚ç‚¹çš„åˆ†å¸ƒå¼è¡¨, è¿™ä¸ªèŠ‚ç‚¹è¿˜éœ€è¦å»ºç«‹N-1ä¸ªè¿æ¥(Næ˜¯é›†ç¾¤èŠ‚ç‚¹æ•°)åˆ†å‘æ•°æ®, å†æœ‰å°±æ˜¯ä»–è¯´çš„ç¬¬3ç‚¹ é€šè¿‡è´Ÿè½½å‡è¡¡å‘æœ¬åœ°è¡¨æ’å…¥æ•°æ®è¦æ§åˆ¶å°½é‡æ¯æ¬¡æ’å…¥æ•°æ®å»ºç«‹ä¸€æ¬¡è¿æ¥, æ¯ä¸ªé“¾æ¥æ’å…¥çš„æ•°æ®é‡è¦å·®ä¸å¤š, batch sizeä¸èƒ½å¤ªå°, å¦åˆ™data partè¿‡å¤š, mergeä¸è¿‡æ¥clickhouseä¼šæŠ¥é”™","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"}]},{"title":"å¢å¼ºåŠåŒæ­¥ä¼šä¸ä¼šä¸¢æ•°æ®","slug":"2020-09-20-å¢å¼ºåŠåŒæ­¥ä¼šä¸ä¼šä¸¢æ•°æ®","date":"2020-09-20T14:46:00.000Z","updated":"2020-09-20T14:47:09.090Z","comments":true,"path":"2020/09/20/2020-09-20-å¢å¼ºåŠåŒæ­¥ä¼šä¸ä¼šä¸¢æ•°æ®/","link":"","permalink":"http://fuxkdb.com/2020/09/20/2020-09-20-%E5%A2%9E%E5%BC%BA%E5%8D%8A%E5%90%8C%E6%AD%A5%E4%BC%9A%E4%B8%8D%E4%BC%9A%E4%B8%A2%E6%95%B0%E6%8D%AE/","excerpt":"åªè®¨è®º5.7å¢å¼ºåŠåŒæ­¥å’ŒåŒ1çš„æƒ…å†µ å¢å¼ºåŠåŒæ­¥ä¼šä¸ä¼šä¸¢æ•°æ®?è¿™é‡Œæ¶‰åŠä¸¤ä¸ªè¿‡ç¨‹: ä¸»åº“ Innodbä¸Binlogæ—¥å¿—çš„2PC å¢å¼ºåŠåŒæ­¥ Innodbä¸Binlogæ—¥å¿—çš„2PC åœ¨å¼€å¯Binlogå, MySQLå†…éƒ¨ä¼šè‡ªåŠ¨å°†æ™®é€šäº‹åŠ¡å½“åšä¸€ä¸ªXAäº‹åŠ¡æ¥å¤„ç†ï¼š è‡ªåŠ¨ä¸ºæ¯ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ID COMMITä¼šè¢«è‡ªåŠ¨çš„åˆ†æˆPrepareå’ŒCommitä¸¤ä¸ªé˜¶æ®µ Binlogä¼šè¢«å½“åšäº‹åŠ¡åè°ƒè€…(Transaction Coordinator), Binlog Eventä¼šè¢«å½“åšåè°ƒè€…æ—¥å¿—","text":"åªè®¨è®º5.7å¢å¼ºåŠåŒæ­¥å’ŒåŒ1çš„æƒ…å†µ å¢å¼ºåŠåŒæ­¥ä¼šä¸ä¼šä¸¢æ•°æ®?è¿™é‡Œæ¶‰åŠä¸¤ä¸ªè¿‡ç¨‹: ä¸»åº“ Innodbä¸Binlogæ—¥å¿—çš„2PC å¢å¼ºåŠåŒæ­¥ Innodbä¸Binlogæ—¥å¿—çš„2PC åœ¨å¼€å¯Binlogå, MySQLå†…éƒ¨ä¼šè‡ªåŠ¨å°†æ™®é€šäº‹åŠ¡å½“åšä¸€ä¸ªXAäº‹åŠ¡æ¥å¤„ç†ï¼š è‡ªåŠ¨ä¸ºæ¯ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ID COMMITä¼šè¢«è‡ªåŠ¨çš„åˆ†æˆPrepareå’ŒCommitä¸¤ä¸ªé˜¶æ®µ Binlogä¼šè¢«å½“åšäº‹åŠ¡åè°ƒè€…(Transaction Coordinator), Binlog Eventä¼šè¢«å½“åšåè°ƒè€…æ—¥å¿— åˆ†å¸ƒå¼äº‹åŠ¡ID(XID) ä½¿ç”¨2PCæ—¶, MySQLä¼šè‡ªåŠ¨çš„ä¸ºæ¯ä¸€ä¸ªäº‹åŠ¡åˆ†é…ä¸€ä¸ªID, å«XID. XIDæ˜¯å”¯ä¸€çš„, æ¯ä¸ªäº‹åŠ¡çš„XIDéƒ½ä¸ç›¸åŒ. XIDä¼šåˆ†åˆ«è¢«Binlogå’ŒInnoDBè®°å…¥æ—¥å¿—ä¸­, ä¾›æ¢å¤æ—¶ä½¿ç”¨. MySQå†…éƒ¨çš„XIDç”±ä¸‰éƒ¨åˆ†ç»„æˆ: å‰ç¼€éƒ¨åˆ†å‰ç¼€éƒ¨åˆ†æ˜¯å­—ç¬¦ä¸²â€MySQLXidâ€ Server IDéƒ¨åˆ†å½“å‰MySQLçš„server_id query_idéƒ¨åˆ†ä¸ºäº†ä¿è¯XIDçš„çš„å”¯ä¸€æ€§, æ•°å­—éƒ¨åˆ†ä½¿ç”¨äº†query_id. MySQLå†…éƒ¨ä¼šè‡ªåŠ¨çš„ä¸ºæ¯ä¸€ä¸ªè¯­å¥åˆ†é…ä¸€ä¸ªquery_id, å…¨å±€å”¯ä¸€. äº‹åŠ¡çš„åè°ƒè€…BinlogBinlogåœ¨2PCä¸­å……å½“äº†äº‹åŠ¡çš„åè°ƒè€…ï¼ˆTransaction Coordinatorï¼‰. ç”±Binlogæ¥é€šçŸ¥InnoDBå¼•æ“æ¥æ‰§è¡Œprepare, commitæˆ–è€…rollbackçš„æ­¥éª¤. äº‹åŠ¡æäº¤çš„æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š åè°ƒè€…å‡†å¤‡é˜¶æ®µ(Prepare Phase)å‘Šè¯‰å¼•æ“åšPrepare, InnoDBæ›´æ”¹äº‹åŠ¡çŠ¶æ€, å¹¶å°†Redo Logåˆ·å…¥ç£ç›˜. ä¸ªäººç†è§£: innodbå†™prepare log, äº‹åŠ¡æ ‡è®°ä¸ºprepareçŠ¶æ€, å¹¶å†™å…¥xid åè°ƒè€…æäº¤é˜¶æ®µ(Commit Phase)2.1 è®°å½•åè°ƒè€…æ—¥å¿—, å³Binlogæ—¥å¿—.2.2 å‘Šè¯‰å¼•æ“åšcommit. ä¸ªäººç†è§£: å†™Binlog eventå’Œxid, å†™å®Œåé€šçŸ¥innodb commit, innodbå†™commit log, äº‹åŠ¡æ ‡è®°ä¸ºcommitçŠ¶æ€ (è®°å¾—å§œæˆå°§è¯´è¦å†™binlog file posåˆ°redo) æ³¨æ„ï¼šè®°å½•Binlogæ˜¯åœ¨InnoDBå¼•æ“Prepare(å³Redo Logå†™å…¥ç£ç›˜)ä¹‹å, è¿™ç‚¹è‡³å…³é‡è¦. åè°ƒè€…æ—¥å¿—Xid_log_eventä½œä¸ºåè°ƒè€…, Binlogéœ€è¦å°†äº‹åŠ¡çš„XIDè®°å…¥æ—¥å¿—, ä¾›æ¢å¤æ—¶ä½¿ç”¨. Xid_log_eventæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š ä»…è®°å½•query_idå› ä¸ºå‰ç¼€éƒ¨åˆ†ä¸å˜, server_idå·²ç»è®°å½•åœ¨Event Headerä¸­, Xid_log_eventä¸­åªè®°å½•query_idéƒ¨åˆ†. æ ‡å¿—äº‹åŠ¡çš„ç»“æŸåœ¨Binlogä¸­ç›¸å½“äºä¸€ä¸ªäº‹åŠ¡çš„COMMITè¯­å¥.ä¸€ä¸ªäº‹åŠ¡åœ¨Binlogä¸­çœ‹èµ·æ¥æ—¶è¿™æ ·çš„: 123Query_log_event(&quot;BEGIN&quot;);DMLäº§ç”Ÿçš„events; Xid_log_event; DDLæ²¡æœ‰BEGIN, ä¹Ÿæ²¡æœ‰Xid_log_event. ä»…InnoDBçš„DMLä¼šäº§ç”ŸXid_log_event å› ä¸ºMyISAMä¸æ”¯æŒ2PCæ‰€ä»¥ä¸èƒ½ç”¨Xid_log_event, ä½†ä¼šæœ‰COMMIT Event. 123Query_log_event(&quot;BEGIN&quot;);DMLäº§ç”Ÿçš„events;Query_log_event(&quot;COMMIT&quot;); æ¢å¤(Recovery)è¿™ä¸ªæœºåˆ¶æ˜¯å¦‚ä½•ä¿è¯MySQLçš„CrashSafeçš„å‘¢, æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹. è¿™é‡Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·è®¾ç½®äº†ä»¥ä¸‹å‚æ•°æ¥ä¿è¯å¯é æ€§:sync_binlog=1innodb_flush_log_at_trx_commit=1 æ¢å¤å‰äº‹åŠ¡çš„çŠ¶æ€åœ¨æ¢å¤å¼€å§‹å‰äº‹åŠ¡æœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€: InnoDBä¸­å·²ç»æäº¤æ ¹æ®å‰é¢2PCçš„è¿‡ç¨‹, å¯çŸ¥Binlogä¸­ä¹Ÿä¸€å®šè®°å½•äº†è¯¥äº‹åŠ¡çš„çš„Events(æˆ‘æ„Ÿè§‰è¯´çš„åº”è¯¥æ˜¯Xid_log_event). æ‰€ä»¥è¿™ç§äº‹åŠ¡æ˜¯ä¸€è‡´çš„ä¸éœ€è¦å¤„ç†. InnoDBä¸­æ˜¯preparedçŠ¶æ€, Binlogä¸­æœ‰è¯¥äº‹åŠ¡çš„Events(æˆ‘æ„Ÿè§‰è¯´çš„åº”è¯¥æ˜¯Xid_log_event).éœ€è¦é€šçŸ¥InnoDBæäº¤è¿™äº›äº‹åŠ¡. InnoDBä¸­æ˜¯preparedçŠ¶æ€, Binlogä¸­æ²¡æœ‰è¯¥äº‹åŠ¡çš„Events(æˆ‘æ„Ÿè§‰è¯´çš„åº”è¯¥æ˜¯Xid_log_event).å› ä¸ºBinlogè¿˜æ²¡è®°å½•, éœ€è¦é€šçŸ¥InnoDBå›æ»šè¿™äº›äº‹åŠ¡. Before InnoDB Prepareäº‹åŠ¡å¯èƒ½è¿˜æ²¡æ‰§è¡Œå®Œ, å› æ­¤InnoDBä¸­çš„çŠ¶æ€è¿˜æ²¡æœ‰prepare. æ ¹æ®2PCçš„è¿‡ç¨‹, Binlogä¸­ä¹Ÿæ²¡æœ‰è¯¥äº‹åŠ¡çš„events(æˆ‘æ„Ÿè§‰è¯´çš„åº”è¯¥æ˜¯Xid_log_event). éœ€è¦é€šçŸ¥InnoDBå›æ»šè¿™äº›äº‹åŠ¡. æ¢å¤è¿‡ç¨‹ä»ä¸Šé¢çš„äº‹åŠ¡çŠ¶æ€å¯ä»¥çœ‹å‡º: æ¢å¤æ—¶äº‹åŠ¡è¦æäº¤è¿˜æ˜¯å›æ»š, æ˜¯ç”±Binlogæ¥å†³å®šçš„. äº‹åŠ¡çš„Xid_log_eventå­˜åœ¨, å°±è¦æäº¤. äº‹åŠ¡çš„Xid_log_eventä¸å­˜åœ¨, å°±è¦å›æ»š. æ¢å¤çš„è¿‡ç¨‹éå¸¸ç®€å•: ä»Binlogä¸­è¯»å‡ºæ‰€æœ‰çš„Xid_log_event å‘Šè¯‰InnoDBæäº¤è¿™äº›XIDçš„äº‹åŠ¡ InnoDBå›æ»šå…¶å®ƒçš„äº‹åŠ¡ äº†è§£äº†MySQLå…³äºInnodbä¸Binlogçš„ä¸¤é˜¶æ®µæäº¤æœºåˆ¶åï¼Œå°±å¯ä»¥æ›´æ·±å…¥å»æ¢ç©¶MySQLåœ¨æ•…éšœæ¢å¤æ—¶çš„å¤„ç†è¿‡ç¨‹ã€‚ åœ¨MySQLå¯åŠ¨æ—¶ï¼Œé¦–å…ˆä¼šåˆå§‹åŒ–å­˜å‚¨å¼•æ“ï¼Œå¦‚æœ¬ä¾‹ä¸­çš„InnoDBå¼•æ“ï¼Œç„¶åInnoDBå¼•æ“å±‚ä¼šè¯»å–redologè¿›è¡ŒInnoDBå±‚çš„æ•…éšœæ¢å¤ï¼Œå›æ»šæœªpreparedå’Œcommitçš„äº‹åŠ¡ï¼Œä½†å¯¹äºå·²ç»preparedï¼Œä½†æœªcommitçš„äº‹åŠ¡ï¼Œæš‚æ—¶æŒ‚èµ·ï¼Œä¿å­˜åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œç­‰å¾…åç»­è¯»å–binlogæ—¥å¿—ï¼Œç„¶åæ ¹æ®binlogæ—¥å¿—å†å¯¹è¿™éƒ¨åˆ†preparedçš„äº‹åŠ¡è¿›è¡Œå¤„ç†ã€‚ æ¥ä¸‹æ¥ï¼ŒMySQLä¼šè¯»å–æœ€åä¸€ä¸ªbinlogæ–‡ä»¶ã€‚binlogæ–‡ä»¶é€šå¸¸æ˜¯ä»¥å›ºå®šçš„æ–‡ä»¶ååŠ ä¸€ç»„è¿ç»­çš„ç¼–å·æ¥å‘½åçš„ï¼Œå¹¶ä¸”å°†å…¶è®°å½•åˆ°ä¸€ä¸ªbinlogç´¢å¼•æ–‡ä»¶ä¸­ï¼Œå› æ­¤ç´¢å¼•æ–‡ä»¶ä¸­çš„æœ€åä¸€ä¸ªbinlogæ–‡ä»¶å³æ˜¯MySQLå°†è¦è¯»å–çš„æœ€åä¸€ä¸ªbinlogæ–‡ä»¶ã€‚ è¯»å–è¿™ä¸ªbinlogæ–‡ä»¶æ—¶ï¼Œé€šè¿‡æ–‡ä»¶å¤´ä¸Šæ˜¯å¦å­˜åœ¨æ ‡è®°LOG_EVENT_BINLOG_IN_USE_Fï¼Œé€šè¿‡è¿™ä¸ªæ ‡è®°å¯ä»¥çŸ¥é“ä¸Šæ¬¡MySQLæ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œå¦‚æœæ˜¯å¼‚å¸¸å…³é—­ï¼Œåˆ™ä¼šè¿›å…¥æ•…éšœæ¢å¤è¿‡ç¨‹ã€‚ è¿›å…¥æ•…éšœæ¢å¤è¿‡ç¨‹åï¼Œä¼šä¾æ¬¡è¯»å–æœ€åä¸€ä¸ªbinlogæ–‡ä»¶ä¸­çš„æ‰€æœ‰log eventï¼Œå¹¶å°†æ‰€æœ‰å·²æäº¤äº‹åŠ¡çš„binlogæ—¥å¿—ä¸­è®°å½•çš„xidæå–å‡ºæ¥æ·»åŠ åˆ°hashè¡¨ä¸­ï¼Œä»¥å¤‡åç»­å¯¹å‰è¿°InnoDBæ•…éšœæ¢å¤åé—ç•™çš„Preparedäº‹åŠ¡ç»§ç»­å¤„ç†ã€‚å¦å¤–æ­¤å¤„è¿˜è¦å®šä½æœ€åä¸€ä¸ªå®Œæ•´äº‹åŠ¡çš„ä½ç½®ï¼Œé˜²æ­¢åœ¨ä¸Šæ¬¡ç³»ç»Ÿå¼‚å¸¸å…³é—­æ—¶æœ‰éƒ¨åˆ†binlogæ—¥å¿—æœªåˆ·åˆ°ç£ç›˜ä¸Šï¼Œå³å­˜åœ¨å†™äº†ä¸€åŠçš„binlogäº‹åŠ¡æ—¥å¿—ï¼Œè¿™éƒ¨åˆ†å†™äº†ä¸€åŠbinlogæ—¥å¿—çš„äº‹åŠ¡åœ¨MySQLä¸­ä¼šæŒ‰äº‹åŠ¡æœªæäº¤æ¥å¤„ç†ï¼Œåç»­ä¼šå°†å…¶åœ¨å­˜å‚¨å¼•æ“å±‚å›æ»šã€‚å½“æ­¤æ–‡ä»¶ä¸­çš„å†…å®¹å…¨éƒ¨è¯»å‡ºä¹‹åï¼Œä¸€æ˜¯å¾—åˆ°ä¸€ä¸ªå·²æäº¤äº‹åŠ¡çš„åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¯æœ€åä¸€ä¸ªå®Œæ•´äº‹åŠ¡çš„ä½ç½®ã€‚ ç„¶åæ£€æŸ¥ç”±InnoDBå±‚å¾—åˆ°çš„Preparedäº‹åŠ¡åˆ—è¡¨ï¼Œè‹¥Preparedäº‹åŠ¡åœ¨ä»Binlogä¸­å¾—åˆ°çš„æäº¤äº‹åŠ¡åˆ—è¡¨ä¸­ï¼Œåˆ™åœ¨InnoDBå±‚æäº¤æ­¤äº‹åŠ¡ï¼Œå¦åˆ™å›æ»šæ­¤äº‹åŠ¡ã€‚ å‡ºè‡ªMySQL Â· åŸç†ä»‹ç» Â· å†è®®MySQLçš„æ•…éšœæ¢å¤ ç–‘é—®1ï¼šå¦‚æœäº‹åŠ¡çš„Binlog Eventåªè®°å½•äº†ä¸€éƒ¨åˆ†æ€ä¹ˆåŠï¼Ÿåªæœ‰æœ€åä¸€ä¸ªäº‹åŠ¡çš„Eventä¼šå‘ç”Ÿè¿™æ ·çš„æƒ…å†µã€‚åœ¨æ¢å¤æ—¶ï¼Œbinlogä¼šè‡ªåŠ¨çš„å°†è¿™ä¸ªä¸å®Œæ•´çš„äº‹åŠ¡Eventsä»Binlogæ–‡ä»¶ä¸­ç»™æ¸…é™¤æ‰ã€‚ ç–‘é—®2ï¼šéšç€é•¿æ—¶é—´çš„è¿è¡Œï¼ŒBinlogä¸­ä¼šç§¯ç´¯äº†å¾ˆå¤šXid_log_eventï¼Œè¯»å–æ‰€æœ‰çš„Xid_log_eventä¼šä¸ä¼šæ•ˆç‡å¾ˆä½ï¼Ÿ å½“ç„¶å¾ˆä½ï¼Œæ‰€ä»¥Binlogä¸­æœ‰ä¸€ä¸ªæœºåˆ¶æ¥ä¿è¯æ¢å¤æ—¶åªç”¨è¯»å–æœ€åä¸€ä¸ªBinlogæ–‡ä»¶ä¸­çš„Xid_log_eventã€‚è¿™ç§æœºåˆ¶å¾ˆåƒä¸€ä¸ªç®€å•çš„Xid_log_eventçš„checkpointæœºåˆ¶ã€‚ CrashSafeçš„å†™ç›˜æ¬¡æ•°å‰é¢è¯´é“è¦æƒ³ä¿è¯CrashSafeå°±è¦è®¾ç½®ä¸‹é¢ä¸¤ä¸ªå‚æ•°ä¸º1:sync_binlog=1innodb_flush_log_at_trx_commit=1ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªå‚æ•°çš„ä½œç”¨. sync_binlogsync_binlogæ˜¯æ§åˆ¶Binlogå†™ç›˜çš„, 1è¡¨ç¤ºæ¯æ¬¡éƒ½å†™. ç”±äºBinlogä½¿ç”¨äº†ç»„æäº¤(Group Commit)çš„æœºåˆ¶, å®ƒä»£è¡¨ä¸€ç»„äº‹åŠ¡æäº¤æ—¶å¿…é¡»è¦å°†Binlogæ–‡ä»¶å†™å…¥ç¡¬ä»¶å­˜å‚¨1æ¬¡. innodb_flush_log_at_trx_commitçš„å†™ç›˜æ¬¡æ•°è¿™ä¸ªå˜é‡æ˜¯ç”¨æ¥æ§åˆ¶InnoDB commitæ—¶å†™ç›˜çš„æ–¹æ³•çš„. ç°åœ¨commitè¢«åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µ, åˆ°åº•åœ¨å“ªä¸ªé˜¶æ®µå†™ç›˜, è¿˜æ˜¯ä¸¤ä¸ªé˜¶æ®µéƒ½è¦å†™ç›˜å‘¢ï¼Ÿ Prepareé˜¶æ®µæ—¶éœ€è¦å†™ç›˜2PCè¦æ±‚åœ¨Prepareæ—¶å°±è¦å°†æ•°æ®æŒä¹…åŒ–, åªæœ‰è¿™æ ·, æ¢å¤æ—¶æ‰èƒ½æäº¤å·²ç»è®°å½•äº†Xid_log_eventçš„äº‹åŠ¡. Commité˜¶æ®µæ—¶ä¸éœ€è¦å†™ç›˜å¦‚æœCommité˜¶æ®µä¸å†™ç›˜, ä¼šé€ æˆä»€ä¹ˆç»“æœå‘¢ï¼Ÿå·²ç»Cmmitäº†çš„äº‹åŠ¡, åœ¨æ¢å¤æ—¶çš„çŠ¶æ€å¯èƒ½æ˜¯Prepared. ç”±äºæ¢å¤æ—¶, Preparedçš„äº‹åŠ¡å¯ä»¥é€šè¿‡Xid_log_eventæ¥æäº¤äº‹åŠ¡, æ‰€ä»¥åœ¨æ¢å¤åäº‹åŠ¡çš„çŠ¶æ€å°±æ˜¯æ­£ç¡®çš„. å› æ­¤åœ¨Commité˜¶æ®µä¸éœ€è¦å†™ç›˜. æ€»çš„æ¥è¯´ä¿è¯MySQLæœåŠ¡çš„CrashSafeéœ€è¦å†™ä¸¤æ¬¡ç›˜. åœ¨2PCçš„è¿‡ç¨‹ä¸­, InnoDBåªåœ¨prepareé˜¶æ®µæ—¶, å†™ä¸€æ¬¡ç›˜. Binlogåœ¨commité˜¶æ®µ, ä¼šè®¾ç½®ä¸€ä¸ªå‚æ•°å‘Šè¯‰InnoDBä¸è¦å†™ç›˜. è¿™ä¸ªå‚æ•°æ˜¯thd-&gt;durability_property= HA_IGNORE_DURABILITY;ä»£ç åœ¨sql/binlog.ccçš„MYSQL_BIN_LOG::ordered_commit()ä¸­. ä»¥ä¸Šå‡ºè‡ªMySQLçš„CrashSafeå’ŒBinlogçš„å…³ç³» å¢å¼ºåŠåŒæ­¥å¯¹äºå¢å¼ºåŠåŒæ­¥, ä¸»è¦æœ‰ä¸¤ç§æƒ…å†µ: ä¸»åº“å†™binlogè½ç›˜å, Binlog dumpçº¿ç¨‹å‘é€binlogç»™ä»åº“, ä»åº“IO threadæ¥æ”¶å†™å…¥relay log, ä½†æ˜¯æ²¡æœ‰å†™å…¥å®Œ, ä¸»åº“æŒ‚äº† ä»åº“IO threadæˆåŠŸå†™å…¥relay logå, è¿˜æ²¡å‘é€ACKæˆ–ACKå‘é€äº†ä½†æ˜¯ä¸»åº“æ”¶åˆ°å‰, ä¸»åº“æŒ‚äº† ç¬¬ä¸€ç§æƒ…å†µå¯¹åº”ç”¨æ¥è¯´, å¹¶æ²¡æœ‰æ”¶åˆ°commit okçš„ä¿¡æ¯, åº”å½“è®¤ä¸ºäº‹åŠ¡æäº¤å¤±è´¥. å¯¹äºä¸»åº“, å› ä¸ºå·²ç»å†™äº†Binlog(å†™äº†Xid_log_event), åªæ˜¯è¿˜æ²¡æœ‰å†™commit log, crash recoverå, è¿™éƒ¨åˆ†äº‹åŠ¡åˆä¼šæäº¤æ‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556å‡è®¾ä¸€ä¸»ä¸€ä»åŠåŒæ­¥root@localhost 19:23:00 [dbms_monitor]&gt; show global variables like &#x27;%semi%&#x27;;+-------------------------------------------+------------+| Variable_name | Value |+-------------------------------------------+------------+| rpl_semi_sync_master_enabled | OFF || rpl_semi_sync_master_timeout | 10000 || rpl_semi_sync_master_trace_level | 32 || rpl_semi_sync_master_wait_for_slave_count | 1 || rpl_semi_sync_master_wait_no_slave | ON || rpl_semi_sync_master_wait_point | AFTER_SYNC || rpl_semi_sync_slave_enabled | OFF || rpl_semi_sync_slave_trace_level | 32 |+-------------------------------------------+------------+8 rows in set (0.00 sec)root@localhost 19:23:02 [dbms_monitor]&gt; truncate table semi_sync;Query OK, 0 rows affected (0.01 sec)root@localhost 19:23:15 [dbms_monitor]&gt; show global status like &#x27;%semi%&#x27;; +--------------------------------------------+-------+| Variable_name | Value |+--------------------------------------------+-------+| Rpl_semi_sync_master_clients | 1 || Rpl_semi_sync_master_net_avg_wait_time | 0 || Rpl_semi_sync_master_net_wait_time | 0 || Rpl_semi_sync_master_net_waits | 18 || Rpl_semi_sync_master_no_times | 1 || Rpl_semi_sync_master_no_tx | 2 || Rpl_semi_sync_master_status | ON || Rpl_semi_sync_master_timefunc_failures | 0 || Rpl_semi_sync_master_tx_avg_wait_time | 555 || Rpl_semi_sync_master_tx_wait_time | 5000 || Rpl_semi_sync_master_tx_waits | 9 || Rpl_semi_sync_master_wait_pos_backtraverse | 0 || Rpl_semi_sync_master_wait_sessions | 0 || Rpl_semi_sync_master_yes_tx | 9 || Rpl_semi_sync_slave_status | OFF |+--------------------------------------------+-------+15 rows in set (0.00 sec)root@localhost 19:23:44 [dbms_monitor]&gt; set global rpl_semi_sync_master_timeout=999999;Query OK, 0 rows affected (0.00 sec)root@localhost 19:23:52 [dbms_monitor]&gt; insert into semi_sync values(1, now());Query OK, 1 row affected (0.00 sec)slave:root@localhost 19:24:10 [(none)]&gt; select * from dbms_monitor.semi_sync;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-09-20 19:24:01 |+----+---------------------+1 row in set (0.00 sec) å¯ä»¥çœ‹åˆ°å½“å‰æ˜¯åŠåŒæ­¥çŠ¶æ€, ä¸»åº“rpl_semi_sync_master_timeout=999999, å†™å…¥äº†ä¸€æ¡æ•°æ®. æˆ‘ä»¬å…³é—­ä»åº“, ä¹‹åå¼€ä¸‰ä¸ªçª—å£æ‰§è¡Œä¸‰ä¸ªinsert 12345root@localhost 19:24:50 [dbms_monitor]&gt; insert into semi_sync values(2, now());root@localhost 17:41:52 [dbms_monitor]&gt; insert into semi_sync values(3, now());root@localhost 17:41:52 [dbms_monitor]&gt; insert into semi_sync values(4, now()); ç”±äºrpl_semi_sync_master_wait_for_slave_count=1, æ‰€ä»¥ä¸‰ä¸ªinsertéƒ½åœ¨ç­‰å¾…. æ­¤æ—¶killä¸»åº“, ç„¶åé‡å¯ä¸»åº“ 12345678910111213[root@centos-1 mysql5731]# ps -ef| grep mysqldroot 29734 29681 0 17:33 pts/5 00:00:00 tail -f /data/mysql_3358/logs/mysqld.logroot 29743 29626 0 17:33 pts/4 00:00:00 /bin/sh ./bin/mysqld_safe --defaults-file=/data/mysql_3358/my_3358.cnf --user=mysqlmysql 31479 29743 0 17:33 pts/4 00:00:32 /usr/local/mysql5731/bin/mysqld --defaults-file=/data/mysql_3358/my_3358.cnf --basedir=/usr/local/mysql5731 --datadir=/data/mysql_3358/data --plugin-dir=/usr/local/mysql5731/lib/mysql/plugin --user=mysql --log-error=/data/mysql_3358/logs/mysqld.log --open-files-limit=65535 --pid-file=/data/mysql_3358/run/mysql.pid --socket=/data/mysql_3358/run/mysql.sock --port=3358root 32730 29626 0 19:25 pts/4 00:00:00 grep --color=auto mysqld[root@centos-1 mysql5731]# kill -9 29743 31479[root@centos-1 mysql5731]# ./bin/mysqld_safe --defaults-file=/data/mysql_3358/my_3358.cnf --user=mysql &amp;[2] 32735[root@centos-1 mysql5731]# mysqld_safe Adding &#x27;/usr/local/mysql5731/lib/mysql/libjemalloc.so.1&#x27; to LD_PRELOAD for mysqld2020-09-20T11:26:12.801721Z mysqld_safe Logging to &#x27;/data/mysql_3358/logs/mysqld.log&#x27;.2020-09-20T11:26:12.824485Z mysqld_safe Starting mysqld daemon with databases from /data/mysql_3358/data æŸ¥çœ‹æ•°æ® 12345678910root@localhost 19:26:44 [dbms_monitor]&gt; select * from semi_sync;+----+---------------------+| id | ctime |+----+---------------------+| 1 | 2020-09-20 19:24:01 || 2 | 2020-09-20 19:25:08 || 3 | 2020-09-20 19:25:10 || 4 | 2020-09-20 19:25:11 |+----+---------------------+4 rows in set (0.00 sec) å¯ä»¥çœ‹åˆ°, ä¸‰ä¸ªinsertåœ¨crash recoveråæˆåŠŸæäº¤äº† ç”±æ­¤å¯ä»¥çœ‹å‡º, ä¸»åº“å®•æœºæ¢å¤åæ˜¯ä¸èƒ½ä½œä¸ºä»åº“åŠ å…¥åŸé›†ç¾¤çš„, éœ€è¦é‡åš, å¦åˆ™æ•°æ®ä¸ä¸€è‡´. ç¬¬äºŒç§æƒ…å†µå¯¹åº”ç”¨æ¥è¯´, å¹¶æ²¡æœ‰æ”¶åˆ°commit okçš„ä¿¡æ¯, åº”å½“è®¤ä¸ºäº‹åŠ¡æäº¤å¤±è´¥. ä½†æ˜¯ç”±äºè¿™éƒ¨åˆ†äº‹åŠ¡å·²ç»å†™å…¥äº†relay log, ä»åº“sql threadåº”ç”¨å®Œrelay logä¸­æ‰€æœ‰binlog eventåæå‡ä¸ºä¸»åº“, æ­¤æ—¶åº”ç”¨è¿æ¥åˆ°æ–°ä¸»åº“, å‡†å¤‡é‡è¯•, é‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°é—®é¢˜: å¯¹äºINSERT: å¦‚æœINSERTè¯­å¥ä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®šä¸»é”®æˆ–ä»»ä½•å”¯ä¸€é”®, é‚£ä¹ˆåº”ç”¨é‡è¯•æ’å…¥å, ä¼šå‡ºç°é‡å¤æ•°æ®. å¯¹äºUPDATE å¦‚æœé‡‡ç”¨update set amount=amount-1000 where idçš„æ–¹å¼é‡è¯•, ä¼šå‡ºç°é‡å¤æ‰£æ¬¾, æ‰€ä»¥å³ä¾¿é‡è¯•, whereæ¡ä»¶ä¸­ä¹Ÿåº”å½“å¸¦ä¸Šè¦æ›´æ–°åˆ—çš„åŸå€¼ å¯¹äºDELETE æ²¡ä»€ä¹ˆå½±å“, åªæ˜¯å½±å“è¡Œæ•°ä¸º0 ç»“è®ºä¸ä¼šä¸¢æ•°æ®. å¯¹äºMHA+å¢å¼ºåŠåŒæ­¥, ä¸»ä»åˆ‡æ¢å, ä¸šåŠ¡ä¸èƒ½ç›²ç›®é‡è¯•, è€Œåº”å½“åšäº‹åŠ¡æ‰§è¡Œå¤±è´¥, æŒ‰ç…§æ­£å¸¸é€»è¾‘é‡æ–°æ‰§è¡Œå®Œæ•´çš„äº‹åŠ¡.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"åŠåŒæ­¥","slug":"åŠåŒæ­¥","permalink":"http://fuxkdb.com/tags/%E5%8D%8A%E5%90%8C%E6%AD%A5/"}]},{"title":"innodb_status_file innodb_status_output innodb_status_output_lockså’Œinnodb_show_verbose_locks","slug":"2020-09-13-innodb_status_file-innodb_status_output-innodb_status_output_lockså’Œinnodb_show_verbose_locks","date":"2020-09-13T02:33:00.000Z","updated":"2020-09-13T02:34:06.383Z","comments":true,"path":"2020/09/13/2020-09-13-innodb_status_file-innodb_status_output-innodb_status_output_lockså’Œinnodb_show_verbose_locks/","link":"","permalink":"http://fuxkdb.com/2020/09/13/2020-09-13-innodb_status_file-innodb_status_output-innodb_status_output_locks%E5%92%8Cinnodb_show_verbose_locks/","excerpt":"innodb_status_fileè¿™ä¸ªå‚æ•°å®˜æ–¹æ–‡æ¡£https://dev.mysql.com/doc/refman/5.7/en/server-system-variable-reference.html ä¸­æ²¡æœ‰ åœ¨https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html ä¸­æœ‰ --innodb-status-file Property Value Command-Line Format `â€“innodb-status-file[={OFF ON}]` Type Boolean Default Value OFF The --innodb-status-file startup option controls whether InnoDB creates a file named innodb_status.*pid* in the data directory and writes SHOW ENGINE INNODB STATUS output to it every 15 seconds, approximately. The innodb_status.*pid* file is not created by default. To create it, start mysqld with the --innodb-status-file option. InnoDB removes the file when the server is shut down normally. If an abnormal shutdown occurs, the status file may have to be removed manually. The --innodb-status-file option is intended for temporary use, as SHOW ENGINE INNODB STATUS output generation can affect performance, and the innodb_status.*pid* file can become quite large over time. For related information, see Section 14.18.2, â€œEnabling InnoDB Monitorsâ€.","text":"innodb_status_fileè¿™ä¸ªå‚æ•°å®˜æ–¹æ–‡æ¡£https://dev.mysql.com/doc/refman/5.7/en/server-system-variable-reference.html ä¸­æ²¡æœ‰ åœ¨https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html ä¸­æœ‰ --innodb-status-file Property Value Command-Line Format `â€“innodb-status-file[={OFF ON}]` Type Boolean Default Value OFF The --innodb-status-file startup option controls whether InnoDB creates a file named innodb_status.*pid* in the data directory and writes SHOW ENGINE INNODB STATUS output to it every 15 seconds, approximately. The innodb_status.*pid* file is not created by default. To create it, start mysqld with the --innodb-status-file option. InnoDB removes the file when the server is shut down normally. If an abnormal shutdown occurs, the status file may have to be removed manually. The --innodb-status-file option is intended for temporary use, as SHOW ENGINE INNODB STATUS output generation can affect performance, and the innodb_status.*pid* file can become quite large over time. For related information, see Section 14.18.2, â€œEnabling InnoDB Monitorsâ€. Section 14.18.2, â€œEnabling InnoDB Monitorsâ€. Directing Standard InnoDB Monitor Output to a Status FileStandard InnoDB Monitor output can be enabled and directed to a status file by specifying the --innodb-status-file option at startup. When this option is used, InnoDB creates a file named innodb_status.*pid* in the data directory and writes output to it every 15 seconds, approximately. InnoDB removes the status file when the server is shut down normally. If an abnormal shutdown occurs, the status file may have to be removed manually. The --innodb-status-file option is intended for temporary use, as output generation can affect performance, and the innodb_status.*pid* file can become quite large over time. éåŠ¨æ€å‚æ•°, å¯ä»¥å†my.cnfä¸­æ·»åŠ innodb_status_file=1å¯ç”¨ å¼€å¯åä¼šåœ¨datadirä¸‹ç”Ÿæˆä¸€ä¸ªinnodb_status.pidæ–‡ä»¶, å‘¨æœŸæ€§15ç§’å‘è¿™ä¸ªæ–‡ä»¶è¾“å‡ºshow engine innodb status. å¦‚æœå¼‚å¸¸å…³é—­æ•°æ®åº“, è¿™ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ çœ‹æ–‡æ¡£æ„æ€theinnodb_status.pidfile can become quite large over time., ä½†æˆ‘çœ‹ä¸ä¼šè¡¨è¾¾, ä»–ä¸æ˜¯è¿½åŠ å†™å…¥, èµ·ç perconaåˆ†æ”¯æ˜¯è¿™æ ·, ä¸Šé¢çš„å›¾æ˜¯å®˜æ–¹åˆ†æ”¯, ä¹Ÿæ²¡æœ‰è¿½åŠ  innodb_status_outputå¼€å¯åä¼šå‘¨æœŸæ€§å‘error logè¾“å‡ºshow engine innodb status innodb_status_output_lockså•ç‹¬å¼€è¿™ä¸ªå½±å“show engine innodb status. è¿™ä¸ªå‚æ•°å‚æ•°é…åˆinnodb_status_fileæˆ–innodb_status_outputä½¿ç”¨æ—¶, å½“å‰ä¸¤è€…å¼€å¯, åˆ™ä¼šå‘å‰ä¸¤è€…è¾“å‡ºä½ç½®è¾“å‡ºé”ä¿¡æ¯ innodb_status_output_locks=off 1234567891011121314------------TRANSACTIONS------------Trx id counter 5781Purge done for trx&#x27;s n:o &lt; 5776 undo n:o &lt; 0 state: running but idleHistory list length 33LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421976761960688, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421976761961816, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5780, ACTIVE 36 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 13, OS thread handle 140502089910016, query id 257 localhost root innodb_status_output_locks=on, innodb_show_verbose_locks=0 1234567891011121314151617------------TRANSACTIONS------------Trx id counter 5781Purge done for trx&#x27;s n:o &lt; 5776 undo n:o &lt; 0 state: running but idleHistory list length 33LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421976761960688, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421976761961816, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5780, ACTIVE 185 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 13, OS thread handle 140502089910016, query id 257 localhost rootTABLE LOCK table `fanboshi`.`t8` trx id 5780 lock mode IXRECORD LOCKS space id 133 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5780 lock_mode X locks rec but not gapRECORD LOCKS space id 133 page no 3 n bits 80 index PRIMARY of table `fanboshi`.`t8` trx id 5780 lock_mode X locks rec but not gap innodb_status_output_locks=on, innodb_show_verbose_locks=1 12345678910111213141516171819202122232425262728293031------------TRANSACTIONS------------Trx id counter 5781Purge done for trx&#x27;s n:o &lt; 5776 undo n:o &lt; 0 state: running but idleHistory list length 33LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421976761960688, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421976761961816, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5780, ACTIVE 48 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 13, OS thread handle 140502089910016, query id 257 localhost rootTABLE LOCK table `fanboshi`.`t8` trx id 5780 lock mode IXRECORD LOCKS space id 133 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5780 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 0: len 1; hex 31; asc 1;; 1: len 1; hex 31; asc 1;; 2: len 1; hex 80; asc ;; 3: len 8; hex 8000000000000001; asc ;;RECORD LOCKS space id 133 page no 3 n bits 80 index PRIMARY of table `fanboshi`.`t8` trx id 5780 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 8; hex 8000000000000001; asc ;; 1: len 6; hex 000000001647; asc G;; 2: len 7; hex b6000000040110; asc ;; 3: len 1; hex 31; asc 1;; 4: len 1; hex 31; asc 1;; 5: len 1; hex 80; asc ;; 6: len 1; hex 61; asc a;; innodb_show_verbose_locksperconaåˆ†æ”¯å‚æ•° variable innodb_show_verbose_locks Command Line:YesConfig File:YesScope:GlobalDynamic:YesVariable Type:ULONGDefault Value:0Range:0 - 1 Specifies to show records locked in SHOW ENGINE INNODB STATUS. The default is 0, which means only the higher-level information about the lock (which table and index is locked, etc.) is printed. If set to 1, then traditional InnoDB behavior is enabled: the records that are locked are dumped to the output. å®˜æ–¹åˆ†æ”¯æ²¡è¿™ä¸ªå‚æ•°, è¿™ä¸ªå‚æ•°å½±å“innodb_print_all_deadlockså’Œå‰é¢ä¸‰ä¸ªå‚æ•°. ä¾‹å¦‚innodb_show_verbose_locks=0, innodb_print_all_deadlocks=1, åˆ™error logä¸­æ­»é”ä¿¡æ¯ä¸º 12345678910111213141516171819202122232425262020-05-15T10:24:29.703878+08:00 4 [Note] InnoDB: Transactions deadlock detected, dumping detailed information.2020-05-15T10:24:29.703949+08:00 4 [Note] InnoDB: *** (1) TRANSACTION:TRANSACTION 5127, ACTIVE 5 sec starting index readmysql tables in use 1, locked 1LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)MySQL thread id 3, OS thread handle 140073055278848, query id 26 localhost root statisticsselect u_c from t8 where d_id=&#x27;1&#x27; and b_id=&#x27;1&#x27; and is_dropped=0 for update2020-05-15T10:24:29.703987+08:00 4 [Note] InnoDB: *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5127 lock_mode X locks rec but not gap waiting2020-05-15T10:24:29.704003+08:00 4 [Note] InnoDB: *** (2) TRANSACTION:TRANSACTION 5126, ACTIVE 9 sec starting index readmysql tables in use 1, locked 14 lock struct(s), heap size 1136, 3 row lock(s)MySQL thread id 4, OS thread handle 140073055008512, query id 27 localhost root updatingupdate t8 set u_c=&#x27;b&#x27; where d_id=&#x27;1&#x27; and b_id=&#x27;1&#x27;2020-05-15T10:24:29.704016+08:00 4 [Note] InnoDB: *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5126 lock_mode X locks rec but not gap2020-05-15T10:24:29.704025+08:00 4 [Note] InnoDB: *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5126 lock_mode X waiting2020-05-15T10:24:29.704034+08:00 4 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (1) innodb_show_verbose_locks=1, innodb_print_all_deadlocks=1, åˆ™error logä¸­æ­»é”ä¿¡æ¯ä¸º 12345678910111213141516171819202122232425262728293031323334353637383940414243442020-05-15T10:54:23.575868+08:00 4 [Note] InnoDB: Transactions deadlock detected, dumping detailed information.2020-05-15T10:54:23.575923+08:00 4 [Note] InnoDB: *** (1) TRANSACTION:TRANSACTION 5130, ACTIVE 6 sec starting index readmysql tables in use 1, locked 1LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)MySQL thread id 3, OS thread handle 140073055278848, query id 38 localhost root statisticsselect u_c from t8 where d_id=&#x27;1&#x27; and b_id=&#x27;1&#x27; and is_dropped=0 for update2020-05-15T10:54:23.575945+08:00 4 [Note] InnoDB: *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5130 lock_mode X locks rec but not gap waitingRecord lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 0: len 1; hex 31; asc 1;; 1: len 1; hex 31; asc 1;; 2: len 1; hex 80; asc ;; 3: len 8; hex 8000000000000001; asc ;;2020-05-15T10:54:23.576779+08:00 4 [Note] InnoDB: *** (2) TRANSACTION:TRANSACTION 5129, ACTIVE 8 sec starting index readmysql tables in use 1, locked 14 lock struct(s), heap size 1136, 3 row lock(s)MySQL thread id 4, OS thread handle 140073055008512, query id 39 localhost root updatingupdate t8 set u_c=&#x27;b&#x27; where d_id=&#x27;1&#x27; and b_id=&#x27;1&#x27;2020-05-15T10:54:23.576798+08:00 4 [Note] InnoDB: *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5129 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 0: len 1; hex 31; asc 1;; 1: len 1; hex 31; asc 1;; 2: len 1; hex 80; asc ;; 3: len 8; hex 8000000000000001; asc ;;2020-05-15T10:54:23.576847+08:00 4 [Note] InnoDB: *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5129 lock_mode X waitingRecord lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 0: len 1; hex 31; asc 1;; 1: len 1; hex 31; asc 1;; 2: len 1; hex 80; asc ;; 3: len 8; hex 8000000000000001; asc ;;2020-05-15T10:54:23.576896+08:00 4 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (1) innodb_status_output=1,innodb_show_verbose_locks=0æˆ–1, innodb_status_output_locks=off 1234567891011121314------------TRANSACTIONS------------Trx id counter 5134Purge done for trx&#x27;s n:o &lt; 5132 undo n:o &lt; 0 state: running but idleHistory list length 2LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421547726605656, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421547726604528, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5132, ACTIVE 93 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 6, OS thread handle 140073054738176, query id 60 localhost root innodb_status_output=1,innodb_show_verbose_locks=0, innodb_status_output_locks=on 1234567891011121314151617------------TRANSACTIONS------------Trx id counter 5134Purge done for trx&#x27;s n:o &lt; 5132 undo n:o &lt; 0 state: running but idleHistory list length 2LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421547726605656, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421547726604528, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5132, ACTIVE 287 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 6, OS thread handle 140073054738176, query id 60 localhost rootTABLE LOCK table `fanboshi`.`t8` trx id 5132 lock mode IXRECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5132 lock_mode X locks rec but not gapRECORD LOCKS space id 128 page no 3 n bits 80 index PRIMARY of table `fanboshi`.`t8` trx id 5132 lock_mode X locks rec but not gap innodb_status_output=1,innodb_show_verbose_locks=1, innodb_status_output_locks=on 12345678910111213141516171819202122232425262728293031------------TRANSACTIONS------------Trx id counter 5134Purge done for trx&#x27;s n:o &lt; 5132 undo n:o &lt; 0 state: running but idleHistory list length 2LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421547726605656, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 421547726604528, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5132, ACTIVE 132 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 6, OS thread handle 140073054738176, query id 60 localhost rootTABLE LOCK table `fanboshi`.`t8` trx id 5132 lock mode IXRECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5132 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 0: len 1; hex 31; asc 1;; 1: len 1; hex 31; asc 1;; 2: len 1; hex 80; asc ;; 3: len 8; hex 8000000000000001; asc ;;RECORD LOCKS space id 128 page no 3 n bits 80 index PRIMARY of table `fanboshi`.`t8` trx id 5132 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 8; hex 8000000000000001; asc ;; 1: len 6; hex 00000000103f; asc ?;; 2: len 7; hex b0000000040110; asc ;; 3: len 1; hex 31; asc 1;; 4: len 1; hex 31; asc 1;; 5: len 1; hex 80; asc ;; 6: len 1; hex 61; asc a;; å¯¹äºstatus_fileä¸€æ · 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162status_file v0 v1 off------------TRANSACTIONS------------Trx id counter 5640Purge done for trx&#x27;s n:o &lt; 0 undo n:o &lt; 0 state: running but idleHistory list length 0LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421976761961816, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5639, ACTIVE 301 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 3, OS thread handle 140502089639680, query id 23 localhost rootstatus_file v0 on------------TRANSACTIONS------------Trx id counter 5640Purge done for trx&#x27;s n:o &lt; 0 undo n:o &lt; 0 state: running but idleHistory list length 0LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421976761961816, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5639, ACTIVE 901 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 3, OS thread handle 140502089639680, query id 23 localhost rootTABLE LOCK table `fanboshi`.`t8` trx id 5639 lock mode IXRECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5639 lock_mode X locks rec but not gapRECORD LOCKS space id 128 page no 3 n bits 80 index PRIMARY of table `fanboshi`.`t8` trx id 5639 lock_mode X locks rec but not gapstatus_file v1 on------------TRANSACTIONS------------Trx id counter 5640Purge done for trx&#x27;s n:o &lt; 0 undo n:o &lt; 0 state: running but idleHistory list length 0LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 421976761961816, not started0 lock struct(s), heap size 1136, 0 row lock(s)---TRANSACTION 5639, ACTIVE 561 sec3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 3, OS thread handle 140502089639680, query id 23 localhost rootTABLE LOCK table `fanboshi`.`t8` trx id 5639 lock mode IXRECORD LOCKS space id 128 page no 4 n bits 80 index DealerAndBrokerAndDropped of table `fanboshi`.`t8` trx id 5639 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 0: len 1; hex 31; asc 1;; 1: len 1; hex 31; asc 1;; 2: len 1; hex 80; asc ;; 3: len 8; hex 8000000000000001; asc ;;RECORD LOCKS space id 128 page no 3 n bits 80 index PRIMARY of table `fanboshi`.`t8` trx id 5639 lock_mode X locks rec but not gapRecord lock, heap no 2 PHYSICAL RECORD: n_fields 7; compact format; info bits 0 0: len 8; hex 8000000000000001; asc ;; 1: len 6; hex 00000000103f; asc ?;; 2: len 7; hex b0000000040110; asc ;; 3: len 1; hex 31; asc 1;; 4: len 1; hex 31; asc 1;; 5: len 1; hex 80; asc ;; 6: len 1; hex 61; asc a;;","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"ClickHouseæŸ¥è¯¢åˆ†å¸ƒå¼è¡¨LEFT JOINæ”¹RIGHT JOINçš„å¤§å‘","slug":"2020-08-28-ClickHouseæŸ¥è¯¢åˆ†å¸ƒå¼è¡¨LEFT-JOINæ”¹RIGHT-JOINçš„å¤§å‘","date":"2020-08-28T09:06:00.000Z","updated":"2020-08-28T09:17:43.113Z","comments":true,"path":"2020/08/28/2020-08-28-ClickHouseæŸ¥è¯¢åˆ†å¸ƒå¼è¡¨LEFT-JOINæ”¹RIGHT-JOINçš„å¤§å‘/","link":"","permalink":"http://fuxkdb.com/2020/08/28/2020-08-28-ClickHouse%E6%9F%A5%E8%AF%A2%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8LEFT-JOIN%E6%94%B9RIGHT-JOIN%E7%9A%84%E5%A4%A7%E5%9D%91/","excerpt":"ç”±ä¸€ä¸ªæ…¢æŸ¥è¯¢è¡ç”Ÿå‡ºçš„é—®é¢˜æˆ‘ä»¬çº¿ä¸Šæœ‰ä¸€ä¸ªClickHouseé›†ç¾¤, æ€»å…±6ä¸ªæœåŠ¡å™¨, é…ç½®å‡ä¸º16C 64G SSD, é›†ç¾¤é…ç½®ä¸ºä¸‰åˆ†ç‰‡ä¸¤å‰¯æœ¬ æœ‰ä¸¤ä¸ªè¡¨è¿™é‡Œç§°ä¸ºsmall_tableå’Œbig_table. éƒ½æ˜¯ReplicatedMergeTreeå¼•æ“(ä¸‰ä¸ªåˆ†ç‰‡ä¸¤ä¸ªå‰¯æœ¬). small_tableæœ‰79wæ•°æ®, big_tableæœ‰5äº¿æ•°æ®(æ•°æ®åœ¨ä¹‹åçš„ç¤ºä¾‹ä¸­æ²¡æœ‰ä»»ä½•å˜åŒ–), åœ¨ä¸‹æ–‡ä¸­small_tableå’Œbig_tableéƒ½ä¸ºåˆ†å¸ƒå¼è¡¨, å¯ä»¥è·å–å…¨é‡æ•°æ®, small_table_localå’Œbig_table_localä¸ºå„èŠ‚ç‚¹ä¸Šçš„æœ¬åœ°è¡¨åç§° 1234567891011121314SELECT table, formatReadableSize(sum(data_compressed_bytes)) AS tc, formatReadableSize(sum(data_uncompressed_bytes)) AS tu, sum(data_compressed_bytes) / sum(data_uncompressed_bytes) AS ratioFROM system.columnsWHERE (database = currentDatabase()) AND (table IN (&#x27;small_table_local&#x27;, &#x27;big_table_local&#x27;))GROUP BY tableORDER BY table ASCâ”Œâ”€tableâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€tcâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€tuâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ratioâ”€â”â”‚ small_table_local â”‚ 12.87 MiB â”‚ 14.91 MiB â”‚ 0.8633041477100831 â”‚â”‚ big_table_local â”‚ 15.46 GiB â”‚ 57.31 GiB â”‚ 0.2697742507036428 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜","text":"ç”±ä¸€ä¸ªæ…¢æŸ¥è¯¢è¡ç”Ÿå‡ºçš„é—®é¢˜æˆ‘ä»¬çº¿ä¸Šæœ‰ä¸€ä¸ªClickHouseé›†ç¾¤, æ€»å…±6ä¸ªæœåŠ¡å™¨, é…ç½®å‡ä¸º16C 64G SSD, é›†ç¾¤é…ç½®ä¸ºä¸‰åˆ†ç‰‡ä¸¤å‰¯æœ¬ æœ‰ä¸¤ä¸ªè¡¨è¿™é‡Œç§°ä¸ºsmall_tableå’Œbig_table. éƒ½æ˜¯ReplicatedMergeTreeå¼•æ“(ä¸‰ä¸ªåˆ†ç‰‡ä¸¤ä¸ªå‰¯æœ¬). small_tableæœ‰79wæ•°æ®, big_tableæœ‰5äº¿æ•°æ®(æ•°æ®åœ¨ä¹‹åçš„ç¤ºä¾‹ä¸­æ²¡æœ‰ä»»ä½•å˜åŒ–), åœ¨ä¸‹æ–‡ä¸­small_tableå’Œbig_tableéƒ½ä¸ºåˆ†å¸ƒå¼è¡¨, å¯ä»¥è·å–å…¨é‡æ•°æ®, small_table_localå’Œbig_table_localä¸ºå„èŠ‚ç‚¹ä¸Šçš„æœ¬åœ°è¡¨åç§° 1234567891011121314SELECT table, formatReadableSize(sum(data_compressed_bytes)) AS tc, formatReadableSize(sum(data_uncompressed_bytes)) AS tu, sum(data_compressed_bytes) / sum(data_uncompressed_bytes) AS ratioFROM system.columnsWHERE (database = currentDatabase()) AND (table IN (&#x27;small_table_local&#x27;, &#x27;big_table_local&#x27;))GROUP BY tableORDER BY table ASCâ”Œâ”€tableâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€tcâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€tuâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ratioâ”€â”â”‚ small_table_local â”‚ 12.87 MiB â”‚ 14.91 MiB â”‚ 0.8633041477100831 â”‚â”‚ big_table_local â”‚ 15.46 GiB â”‚ 57.31 GiB â”‚ 0.2697742507036428 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 123456SELECT count(*)FROM small_tableâ”Œâ”€count()â”€â”â”‚ 794469 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1234567SELECT count(*)FROM big_tableâ”Œâ”€â”€â”€count()â”€â”â”‚ 519898780 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æœ‰å¦‚ä¸‹æŸ¥è¯¢ 1SELECT a.UID,B.UID from dwh.small_table a LEFT JOIN dwh.big_table b on a.UID = b.UID è¿™ä¸ªæŸ¥è¯¢åœ¨ClickHouseä¸­è¦è·‘è¿‘300ç§’ 12345678910111213#time clickhouse-client --time --progress --query=&quot;SELECT a.UID, B.UIDFROM dwh.small_table a LEFT JOIN dwh.big_table b ON a.UID = b.UID&quot; &gt; /dev/null293.769real 4m53.798suser 0m0.574ssys 0m0.225s è€Œåœ¨TIDBåªéœ€è¦20ç§’(èŠ‚ç‚¹æ•°å’Œé…ç½®æ¯”CHç•¥å¥½, æ•°æ®ç•¥å¤šäºCH, æœªä½¿ç”¨TIFlash) 12345678910111213# time mysql -uroot -hxx.xx.xx -P4000 -p dwh -e &quot;SELECT a.UID, B.UIDFROM dwh.small_table a LEFT JOIN dwh.big_table b ON a.UID = b.UID;&quot; &gt; /dev/nullEnter password:real 0m20.955suser 0m11.292ssys 0m2.321s æœ¬äººæ¥è§¦ClickHouseä¸ä¹…, æ²¡ä»€ä¹ˆå®æˆ˜ç»éªŒ, çœ‹åˆ°è¿™ç»“æœå°±æ„Ÿè§‰è‚¯å®šæ˜¯è‡ªå·±ä½¿ç”¨å§¿åŠ¿ä¸å¯¹ JOINæ“ä½œæ—¶ä¸€å®šè¦æŠŠæ•°æ®é‡å°çš„è¡¨æ”¾åœ¨å³è¾¹ä¸€é€šç™¾åº¦Google, çœ‹åˆ°ä¸€ç¯‡æ¥è‡ªæºç¨‹çš„æ–‡ç« æ¯å¤©åäº¿çº§æ•°æ®æ›´æ–°ï¼Œç§’å‡ºæŸ¥è¯¢ç»“æœï¼ŒClickHouseåœ¨æºç¨‹é…’åº—çš„åº”ç”¨, å…¶ä¸­æœ‰ä¸€æ®µè¯: JOINæ“ä½œæ—¶ä¸€å®šè¦æŠŠæ•°æ®é‡å°çš„è¡¨æ”¾åœ¨å³è¾¹ï¼ŒClickHouseä¸­æ— è®ºæ˜¯Left Join ã€Right Joinè¿˜æ˜¯Inner Joinæ°¸è¿œéƒ½æ˜¯æ‹¿ç€å³è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•åˆ°å·¦è¡¨ä¸­æŸ¥æ‰¾è¯¥è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œæ‰€ä»¥å³è¡¨å¿…é¡»æ˜¯å°è¡¨ã€‚ æœ‰ç‚¹ç¥å¥‡.. æˆ‘ä»¬çŸ¥é“åœ¨å¸¸è§çš„å…³ç³»å‹æ•°æ®åº“å¦‚Oralceã€MySQLä¸­, LEFT JOINå’ŒRIGTH JOINæ˜¯å¯ä»¥ç­‰ä»·æ”¹å†™çš„, é‚£ä¹ˆæˆ‘æ”¹æˆRIGHT JOINä¸å°±â€æŠŠå°è¡¨æ”¾åœ¨å³è¾¹â€äº†å—, äºæ˜¯SQLæ”¹å†™ä¸º 1SELECT a.UID,B.UID from dwh.big_table b RIGHT JOIN dwh.small_table a on a.UID = b.UID å®æµ‹ 12345678910111213#time clickhouse-client --time --progress --query=&quot;SELECT a.UID, B.UIDFROM dwh.big_table b RIGHT JOIN dwh.small_table a ON a.UID = b.UIDT&quot; &gt; /dev/null19.588real 0m19.609suser 0m0.742ssys 0m0.293s æ²¡æƒ³åˆ°è¿˜çœŸå¥½ä½¿â€¦ éš¾é“CHä¼˜åŒ–å™¨è¿™ä¹ˆå¼±? è°¨æ…èµ·è§, æˆ‘æ¯”å¯¹äº†ä¸€ä¸‹ç»“æœ, ç®€å•countä¸€ä¸‹å§ LEFT JOIN 1234567891011121314#time clickhouse-client --time --progress --query=&quot;SELECT COUNT(*)FROM dwh.small_table a LEFT JOIN dwh.big_table b ON a.UID = b.UID&quot;6042735 --count917.560 --æ—¶é—´real 15m17.580suser 0m0.253ssys 0m0.489s RIGHT JOIN 1234567891011121314#time clickhouse-client --time --progress --query=&quot;SELECT COUNT(*)FROM dwh.big_table b RIGHT JOIN dwh.small_table a ON a.UID = b.UID&quot;6897617 --count11.655 --æ—¶é—´real 0m11.675suser 0m0.014ssys 0m0.017s RIGHT JOINæ•°æ®ä¸å¯¹å•Š ClickHouseåˆ†å¸ƒå¼è¡¨A LEFT JOIN B != B RIGHT JOIN Aåˆ›å»ºæµ‹è¯•è¡¨12345678910111213141516171819202122232425262728293031323334353637383940414243ch-node-05 default@localhost:9000 [dwh]:) show create table t1;SHOW CREATE TABLE t1â”Œâ”€statementâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ CREATE TABLE dwh.t1 (`I_ID` String, `CTIME` DateTime) ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;dwh&#x27;, &#x27;t1_local&#x27;, rand()) â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.001 sec. ch-node-05 default@localhost:9000 [dwh]:) show create table t2;SHOW CREATE TABLE t2â”Œâ”€statementâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ CREATE TABLE dwh.t2 (`I_ID` String, `CTIME` DateTime) ENGINE = Distributed(&#x27;ch_cluster_all&#x27;, &#x27;dwh&#x27;, &#x27;t2_local&#x27;, rand()) â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.001 sec. ch-node-05 default@localhost:9000 [dwh]:) show create table t1_local;SHOW CREATE TABLE t1_localâ”Œâ”€statementâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ CREATE TABLE dwh.t1_local (`I_ID` String, `CTIME` DateTime) ENGINE = ReplicatedReplacingMergeTree(&#x27;/clickhouse/dwh/tables/&#123;layer&#125;-&#123;shard&#125;/t1&#x27;, &#x27;&#123;replica&#125;&#x27;) PARTITION BY toDate(CTIME) ORDER BY I_ID SETTINGS index_granularity = 8192 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.001 sec. ch-node-05 default@localhost:9000 [dwh]:) show create table t2_local;SHOW CREATE TABLE t2_localâ”Œâ”€statementâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ CREATE TABLE dwh.t2_local (`I_ID` String, `CTIME` DateTime) ENGINE = ReplicatedReplacingMergeTree(&#x27;/clickhouse/dwh/tables/&#123;layer&#125;-&#123;shard&#125;/t2&#x27;, &#x27;&#123;replica&#125;&#x27;) PARTITION BY toDate(CTIME) ORDER BY I_ID SETTINGS index_granularity = 8192 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.001 sec. æ•°æ®123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120ch-node-05 default@localhost:9000 [dwh]:) select * from t1;SELECT *FROM t1â”Œâ”€I_IDâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CTIMEâ”€â”â”‚ 1 â”‚ 2020-08-27 15:24:05 â”‚â”‚ 2 â”‚ 2020-08-27 15:24:50 â”‚â”‚ 8 â”‚ 2020-08-27 15:24:50 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€I_IDâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CTIMEâ”€â”â”‚ 3 â”‚ 2020-08-27 15:24:50 â”‚â”‚ 5 â”‚ 2020-08-27 15:24:50 â”‚â”‚ 9 â”‚ 2020-08-27 15:24:50 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€I_IDâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CTIMEâ”€â”â”‚ 10 â”‚ 2020-08-27 15:24:50 â”‚â”‚ 3 â”‚ 2020-08-27 15:24:50 â”‚â”‚ 6 â”‚ 2020-08-27 15:24:50 â”‚â”‚ 7 â”‚ 2020-08-27 15:24:50 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜10 rows in set. Elapsed: 0.003 sec. ch-node-05 default@localhost:9000 [dwh]:) select * from t2;SELECT *FROM t2â”Œâ”€I_IDâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CTIMEâ”€â”â”‚ 1 â”‚ 2020-08-27 15:25:14 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€I_IDâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CTIMEâ”€â”â”‚ 2 â”‚ 2020-08-27 15:25:33 â”‚â”‚ 5 â”‚ 2020-08-27 15:25:33 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€I_IDâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CTIMEâ”€â”â”‚ 3 â”‚ 2020-08-27 15:25:33 â”‚â”‚ 3 â”‚ 2020-08-27 15:25:33 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜5 rows in set. Elapsed: 0.003 sec. ch-node-05 default@localhost:9000 [dwh]:) SELECT :-] _shard_num, :-] count(*):-] FROM :-] (:-] SELECT :-] _shard_num, :-] a.*:-] FROM dwh.t1 AS a:-] ):-] GROUP BY _shard_num:-] WITH ROLLUP;SELECT _shard_num, count(*)FROM ( SELECT _shard_num, a.* FROM dwh.t1 AS a)GROUP BY _shard_num WITH ROLLUPâ”Œâ”€_shard_numâ”€â”¬â”€count()â”€â”â”‚ 3 â”‚ 3 â”‚â”‚ 2 â”‚ 3 â”‚â”‚ 1 â”‚ 4 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€_shard_numâ”€â”¬â”€count()â”€â”â”‚ 0 â”‚ 10 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜4 rows in set. Elapsed: 0.004 sec. ch-node-05 default@localhost:9000 [dwh]:) SELECT :-] _shard_num, :-] count(*):-] FROM :-] (:-] SELECT :-] _shard_num, :-] a.*:-] FROM dwh.t2 AS a:-] ):-] GROUP BY _shard_num:-] WITH ROLLUP;SELECT _shard_num, count(*)FROM ( SELECT _shard_num, a.* FROM dwh.t2 AS a)GROUP BY _shard_num WITH ROLLUPâ”Œâ”€_shard_numâ”€â”¬â”€count()â”€â”â”‚ 3 â”‚ 2 â”‚â”‚ 2 â”‚ 1 â”‚â”‚ 1 â”‚ 2 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€_shard_numâ”€â”¬â”€count()â”€â”â”‚ 0 â”‚ 5 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜4 rows in set. Elapsed: 0.005 sec. æµ‹è¯•LEFT JOIN RIGHT JOIN12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273ch-node-05 default@localhost:9000 [dwh]:) SELECT :-] a.I_ID, :-] b.I_ID:-] FROM dwh.t2 AS a:-] LEFT JOIN dwh.t1 AS b ON a.I_ID = b.I_ID:-] ORDER BY a.I_ID ASC;SELECT a.I_ID, b.I_IDFROM dwh.t2 AS aLEFT JOIN dwh.t1 AS b ON a.I_ID = b.I_IDORDER BY a.I_ID ASCâ”Œâ”€I_IDâ”€â”¬â”€b.I_IDâ”€â”â”‚ 1 â”‚ 1 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€I_IDâ”€â”¬â”€b.I_IDâ”€â”â”‚ 2 â”‚ 2 â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€I_IDâ”€â”¬â”€b.I_IDâ”€â”â”‚ 5 â”‚ 5 â”‚â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜7 rows in set. Elapsed: 0.006 sec. ch-node-05 default@localhost:9000 [dwh]:) SELECT :-] a.I_ID, :-] b.I_ID:-] FROM dwh.t1 AS b:-] RIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_ID:-] ORDER BY a.I_ID ASC;SELECT a.I_ID, b.I_IDFROM dwh.t1 AS bRIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_IDORDER BY toUInt32(a.I_ID) ASCâ”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 1 â”‚ â”‚â”‚ 1 â”‚ 1 â”‚â”‚ 1 â”‚ â”‚â”‚ 2 â”‚ â”‚â”‚ 2 â”‚ 2 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 2 â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 3 â”‚ â”‚â”‚ 3 â”‚ â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 5 â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 5 â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 5 â”‚ 5 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ å¯ä»¥çœ‹åˆ°RIGHT JOINè¿”å›äº†ä¸€äº›é”™è¯¯çš„æ•°æ® éš¾é“æƒ³è¦å¯¹äºè¿™ä¸ªSQL, å°±ä¸èƒ½ç”¨åˆ†å¸ƒå¼è¡¨äº†å—? å¦‚æœæˆ‘æƒ³ç”¨RIGHT JOINå°±åªèƒ½ç”¨å•æœº? è¯´å¥½çš„æ°´å¹³æ‰©å±•å‘¢? é‚£çœ‹ä¸€ä¸‹å•æœºæŸ¥è¯¢é€Ÿåº¦å§.. ä¸ºæ­¤æˆ‘åœ¨ä¸€ä¸ªCHèŠ‚ç‚¹åˆ›å»ºä¸¤ä¸ªè¡¨small_table_totalå’Œbig_table_toal ä»–ä»¬éƒ½ä¸æ˜¯åˆ†å¸ƒå¼è¡¨, éƒ½æ‹¥æœ‰å…¨é‡æ•°æ® 12345678910111213141516SELECT count(*)FROM `big_table_toal`â”Œâ”€â”€â”€count()â”€â”â”‚ 519898780 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 0.001 sec. SELECT count(*)FROM `small_table_total`â”Œâ”€count()â”€â”â”‚ 794469 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ åˆ†å¸ƒå¼è¡¨åªèƒ½å’Œåˆ†å¸ƒå¼è¡¨å…³è”, åˆ†å¸ƒå¼è¡¨æ— æ³•å’Œæœ¬åœ°è¡¨å…³è” 1234#clickhouse-client --time --progress --query=&quot;SELECT count(*) from dwh.big_table b RIGHT JOIN dwh.small_table_total a on a.UID = b.UID&quot; â†’ Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) Received exception from server (version 20.3.5):Code: 60. DB::Exception: Received from localhost:9000. DB::Exception: Received from bj2-ch-node-04:9000. DB::Exception: Table dwh.small_table_total doesn&#x27;t exist.. 0.107 æµ‹è¯•æŸ¥è¯¢é€Ÿåº¦ 12345678910#clickhouse-client --time --progress --query=&quot;SELECT COUNT(*)FROM dwh.big_table_total b RIGHT JOIN dwh.small_table_total a ON a.UID = b.UID&quot;6042735 --count7.262 --ç”¨æ—¶ å¥½å®¶ä¼™, æ•°æ®å‡†ç¡®, è€Œä¸”æ¯”åˆ†ç‰‡äº†è¿˜å¿« éš¾é“åªèƒ½ç”¨æœ¬åœ°è¡¨?åˆ†å¸ƒå¼è¡¨è¦æƒ³RIGHT JOINè¿”å›æ­£ç¡®ç»“æœ, åªèƒ½æ”¹å†™SQL åŸå§‹è¯­å¥123456SELECT a.UID, b.UIDFROM dwh.small_table a LEFT JOIN dwh.big_table b ON a.UID = b.UID æ”¹å†™ä¸ºINNER JOIN, ä½†æ˜¯æ²¡æœ‰æ”¹è¡¨é¡ºåº(æ€§èƒ½å·®)123456789101112131415SELECT a.id, b.uidFROM dwh.small_table a GLOBAL INNER JOIN dwh.big_table b ON a.UID = b.UID UNION ALL SELECT a.UID, NULLFROM dwh.small_table aWHERE a.UID GLOBAL NOT IN (SELECT UID FROM dwh.big_table) è¿™é‡Œæˆ‘è¿˜æ²¡ç†è§£ä¸ºä»€ä¹ˆè¦ç”¨GLOBAL JOIN åœ¨æˆ‘çš„ä¾‹å­ä¸­ ,è¿™ä¸ªè¯­å¥æ ¹æœ¬è·‘ä¸æˆåŠŸ, GLOBALå¤ªè€—è´¹å†…å­˜äº† 1234567891011121314151617181920212223SELECT a.UID, b.UIDFROM dwh.small_table AS aGLOBAL INNER JOIN dwh.big_table AS b ON a.UID = b.UIDUNION ALLSELECT a.UID, NULLFROM dwh.small_table AS aWHERE a.UID GLOBAL NOT IN ( SELECT UID FROM dwh.big_table)â†‘ Progress: 220.53 million rows, 29.82 GB (51.24 million rows/s., 6.93 GB/s.) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹ 20%Received exception from server (version 20.3.5):Code: 241. DB::Exception: Received from localhost:9000. DB::Exception: Memory limit (for query) exceeded: would use 50.00 GiB (attempt to allocate chunk of 4249200 bytes), maximum: 50.00 GiB: (while reading column CH_BILL_USER_TELEPHONE): (while reading from part /data/clickhouse/ch_9000/data/dwh/big_table_local/201910_0_5_1/ from mark 216 with max_rows_to_read = 8192): Code: 241, e.displayText() = DB::Exception: Memory limit (for query) exceeded: would use 50.00 GiB (attempt to allocate chunk of 4227680 bytes), maximum: 50.00 GiB: (while reading column CH_XXX_NAME): (while reading from part /data/clickhouse/ch_9000/data/dwh/big_table_local/202001_6_11_1/ from mark 240 with max_rows_to_read = 8192) (version 20.3.5.21 (official build)): Code: 241, e.displayText() = DB::Exception: Memory limit (for query) exceeded: would use 50.00 GiB (attempt to allocate chunk of 5211280 bytes), maximum: 50.00 GiB: (avg_value_size_hint = 66, avg_chars_size = 69.6, limit = 8192): (while reading column CH_BROKER_NAME): (while reading from part /data/clickhouse/ch_9000/data/dwh/big_table_local/202007_6_11_1/ from mark 24 with max_rows_to_read = 8192) (version 20.3.5.21 (official build)): Code: 241, e.displayText() = DB::Exception: Memory limit (for query) exceeded: would use 50.00 GiB (attempt to allocate chunk of 4572064 bytes), maximum: 50.00 GiB: (avg_value_size_hint = 66.00048828125, avg_chars_size = 69.6005859375, limit = 8192): (while reading column CH_XX_NAME): (while reading from part /data/clickhouse/ch_9000/data/dwh/big_table_local/201805_2_2_0/ from mark 24 with max_rows_to_read = 8192) (version 20.3.5.21 (official build)): While executing CreatingSetsTransform. 0 rows in set. Elapsed: 4.404 sec. Processed 220.53 million rows, 29.82 GB (50.07 million rows/s., 6.77 GB/s.) å¦‚æœå»æ‰GLOBAL JOIN, ä¹Ÿä¸è¡Œ(GLOBAL INä¸èƒ½å») 1234567891011121314151617181920SELECT a.UID, b.UIDFROM dwh.small_table AS aINNER JOIN dwh.big_table AS b ON a.UID = b.UIDUNION ALLSELECT a.UID, NULLFROM dwh.small_table AS aWHERE a.UID GLOBAL NOT IN ( SELECT UID FROM dwh.big_table)â†‘ Progress: 1.91 billion rows, 105.59 GB (6.36 million rows/s., 352.30 MB/s.) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š 90%Received exception from server (version 20.3.5):Code: 241. DB::Exception: Received from localhost:9000. DB::Exception: Received from clickhouse-node-01:9000. DB::Exception: Memory limit (total) exceeded: would use 50.10 GiB (attempt to allocate chunk of 133829856 bytes), maximum: 50.00 GiB: While executing CreatingSetsTransform. 0 rows in set. Elapsed: 299.809 sec. Processed 1.91 billion rows, 105.59 GB (6.35 million rows/s., 352.18 MB/s.) æ”¹å†™è¡¨é¡ºåº, è®©å°è¡¨åœ¨â€å³è¾¹â€12345678910SELECT a.UID FROM dwh.big_table bGLOBAL INNER JOIN dwh.small_table aON a.UID = b.UIDUNION ALLSELECT a.UID,null FROM dwh.small_table aWHERE a.UID GLOBAL NOT IN( SELECT UID FROM dwh.big_table WHERE UID GLOBAL IN (SELECT id FROM dwh.small_table)) å®æµ‹ 12345678910111213141516time clickhouse-client --time --progress --query=&quot;SELECT a.UID,b.UID FROM dwh.big_table bGLOBAL INNER JOIN dwh.small_table aon a.UID = b.UIDUNION ALLSELECT a.UID,null FROM dwh.small_table aWHERE a.UID GLOBAL NOT IN( SELECT UID FROM dwh.big_table WHERE UID GLOBAL IN (SELECT UID FROM dwh.small_table))&quot; &gt;/dev/null21.142real 0m21.164suser 0m1.133ssys 0m0.378s çœ‹ä¸€ä¸‹è¡Œæ•°å¯¹ä¸å¯¹ 123456789101112131415161718time clickhouse-client --time --progress --query=&quot;SELECT sum(cnt) FROM (SELECT count(*) cnt FROM dwh.big_table bGLOBAL INNER JOIN dwh.small_table aon a.UID = b.UIDUNION ALLSELECT count(*) cnt FROM dwh.small_table aWHERE a.UID GLOBAL NOT IN( SELECT UID FROM dwh.big_table WHERE UID GLOBAL IN (SELECT UID FROM dwh.small_table)))&quot;6042735 --count12.525 --ç”¨æ—¶real 0m12.545suser 0m0.018ssys 0m0.012s æœ€åä¸€ä¸ªé—®é¢˜ä¸çŸ¥é“ä½ ä»¬æ˜¯å¦æ³¨æ„åˆ°äº† ClickHouse 12345678910111213141516171819202122232425262728293031323334SELECT a.I_ID, b.I_IDFROM dwh.t1 AS bRIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_IDORDER BY a.I_ID ASCâ”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 1 â”‚ â”‚â”‚ 1 â”‚ 1 â”‚â”‚ 1 â”‚ â”‚â”‚ 2 â”‚ â”‚â”‚ 2 â”‚ 2 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 2 â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 3 â”‚ â”‚â”‚ 3 â”‚ â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 5 â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 5 â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 5 â”‚ 5 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜ MySQL(ä¾‹å­æ— å…³) 123456789101112131415161718192021222324252627root@localhost 15:15:26 [fanboshi]&gt; select a.id,b.id from t1 a left join t3 b on a.id=b.id; +----+------+| id | id |+----+------+| 1 | 1 || 2 | 2 || 3 | 3 || 4 | 4 || 5 | NULL || 6 | NULL || 7 | NULL || 8 | NULL || 9 | NULL || 11 | NULL || 13 | NULL || 15 | NULL || 17 | NULL || 19 | NULL || 21 | NULL || 23 | NULL || 25 | NULL || 27 | NULL || 29 | NULL || 30 | NULL || 31 | NULL |+----+------+21 rows in set (0.00 sec) åœ¨CHé‡Œå¤–é“¾æ¥ä¸æƒ³MySQLé‚£æ ·â€ç”¨nullè¡¥æœªåŒ¹é…çš„æ•°æ®â€è€Œæ˜¯ç”¨è¯¥åˆ—æ•°æ®ç±»å‹çš„é»˜è®¤å€¼å¡«å…… https://github.com/ClickHouse/ClickHouse/blob/master/src/Core/Settings.h#L189 join_use_nullså¯ä»¥åœ¨è¯­å¥,ç”¨æˆ·profileæ·»åŠ  12345678910111213141516171819202122232425262728293031323334353637SELECT a.I_ID, b.I_IDFROM dwh.t1 AS bRIGHT JOIN dwh.t2 AS a ON a.I_ID = b.I_IDORDER BY toUInt32(a.I_ID) ASCSETTINGS join_use_nulls = 1â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 1 â”‚ á´ºáµá´¸á´¸ â”‚â”‚ 1 â”‚ 1 â”‚â”‚ 1 â”‚ á´ºáµá´¸á´¸ â”‚â”‚ 2 â”‚ á´ºáµá´¸á´¸ â”‚â”‚ 2 â”‚ 2 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 2 â”‚ á´ºáµá´¸á´¸ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 3 â”‚ á´ºáµá´¸á´¸ â”‚â”‚ 3 â”‚ á´ºáµá´¸á´¸ â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 3 â”‚ 3 â”‚â”‚ 5 â”‚ á´ºáµá´¸á´¸ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 5 â”‚ á´ºáµá´¸á´¸ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€a.I_IDâ”€â”¬â”€I_IDâ”€â”â”‚ 5 â”‚ 5 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜15 rows in set. Elapsed: 0.015 sec. å‚è€ƒèµ„æ–™æˆ‘æäº†issue, è¯¦ç»†åŸå› è¯·çœ‹https://github.com/ClickHouse/ClickHouse/issues/14160 æ€»ä¹‹é™¤äº†LEFT JOIN å¤– For other OUTER JOINs there&#39;s no general solution to return expected result yet","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"}]},{"title":"è¯‘æ–‡ ClickHouse Materialized Views Illuminated, Part 2","slug":"2020-08-23-è¯‘æ–‡-ClickHouse-Materialized-Views-Illuminated,-Part-2","date":"2020-08-23T11:05:00.000Z","updated":"2020-08-24T07:44:14.541Z","comments":true,"path":"2020/08/23/2020-08-23-è¯‘æ–‡-ClickHouse-Materialized-Views-Illuminated,-Part-2/","link":"","permalink":"http://fuxkdb.com/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-2/","excerpt":"ClickHouse Materialized Views Illuminated, Part 2 Read part 1","text":"ClickHouse Materialized Views Illuminated, Part 2 Read part 1 åœ¨ä¸Šä¸€ç¯‡å…³äºç‰©åŒ–è§†å›¾çš„åšæ–‡ä¸­, æˆ‘ä»¬ä»‹ç»äº†ä¸€ç§æ„é€ ClickHouseç‰©åŒ–è§†å›¾çš„æ–¹æ³•, è¯¥è§†å›¾ä½¿ç”¨SummingMergeTreeå¼•æ“è®¡ç®—æ€»å’Œå’Œè®¡æ•°. SummingMergeTreeå¯ä»¥ä¸ºè¿™ä¸¤ç§ç±»å‹çš„èšåˆä½¿ç”¨æ™®é€šçš„SQLè¯­æ³•. æˆ‘ä»¬è¿˜è®©ç‰©åŒ–è§†å›¾å®šä¹‰è‡ªåŠ¨ä¸ºæ•°æ®åˆ›å»ºåŸºç¡€è¡¨(.innerè¡¨). è¿™ä¸¤ç§æŠ€æœ¯éƒ½å¾ˆå¿«é€Ÿ, ä½†å¯¹ç”Ÿäº§ç³»ç»Ÿæœ‰é™åˆ¶(éƒ½ä¸å¤ªé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ). åœ¨æœ¬ç¯‡æ–‡ç« ä¸­, æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åœ¨ç°æœ‰çš„è¡¨ä¸Šåˆ›å»ºä¸€ä¸ªå…·æœ‰ä¸€ç³»åˆ—èšåˆç±»å‹çš„ç‰©åŒ–è§†å›¾. å½“æ‚¨éœ€è¦è®¡ç®—çš„ä¸ä»…ä»…æ˜¯ç®€å•çš„æ€»å’Œæ—¶, æ­¤æ–¹æ³•éå¸¸é€‚åˆ. å¯¹äºè¡¨ä¸­æœ‰å¤§é‡æ­£åœ¨æ’å…¥çš„æ•°æ®(é’ˆå¯¹Part 1)ä¸­çš„ POPULATE, ä½¿ç”¨POPULATEä¼šå¡«å……å†å²æ•°æ®, ä½†è¿™æœŸé—´å‘åŸè¡¨ä¸­æ–°æ’å…¥æ•°æ®ä¼šè¢«å¿½ç•¥æ‰è€Œä¸ä¼šå†™å…¥ç‰©åŒ–è§†å›¾ä¸­)æˆ–å¿…é¡»å¤„ç†è¡¨ç»“æ„å˜æ›´çš„æƒ…å†µ, è¿™ä¹Ÿéå¸¸æ–¹ä¾¿. ä½¿ç”¨Stateå‡½æ•°å’ŒTo Tablesåˆ›å»ºæ›´çµæ´»çš„ç‰©åŒ–è§†å›¾åœ¨çº¿é¢çš„ä¾‹å­ä¸­, æˆ‘ä»¬å°†æµ‹é‡è®¾å¤‡çš„è¯»æ•°. è®©æˆ‘ä»¬ä»è¡¨å®šä¹‰å¼€å§‹. 1234567CREATE TABLE counter ( when DateTime DEFAULT now(), device UInt32, value Float32) ENGINE=MergeTreePARTITION BY toYYYYMM(when)ORDER BY (device, when) æ¥ä¸‹æ¥, æˆ‘ä»¬æ·»åŠ è¶³å¤Ÿçš„æ•°æ®, ä»¥ä½¿æŸ¥è¯¢é€Ÿåº¦å˜å¾—è¶³å¤Ÿæ…¢: 10ä¸ªè®¾å¤‡çš„10äº¿è¡Œåˆæˆæ•°æ®. æ³¨æ„: å¦‚æœæ‚¨è¦å°è¯•è¿™äº›æ“ä½œ, åªéœ€è¾“å…¥100ä¸‡è¡Œå³å¯. æ— è®ºæ•°æ®é‡å¦‚ä½•, ç¤ºä¾‹éƒ½å¯ä»¥å·¥ä½œ. 12345678910111213141516171819202122232425262728293031323334353637383940INSERT INTO counter SELECT toDateTime(&#x27;2015-01-01 00:00:00&#x27;) + toInt64(number / 10) AS when, (number % 10) + 1 AS device, ((device * 3) + (number / 10000)) + ((rand() % 53) * 0.1) AS valueFROM system.numbersLIMIT 1000000000â†“ Progress: 1.00 billion rows, 8.00 GB (5.13 million rows/s., 41.07 MB/s.) Ok.0 rows in set. Elapsed: 194.814 sec. Processed 1.00 billion rows, 8.00 GB (5.13 million rows/s., 41.07 MB/s.) SELECT count(*)FROM counterâ”Œâ”€â”€â”€â”€count()â”€â”â”‚ 1000000000 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜SELECT *FROM counterLIMIT 1â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€whenâ”€â”¬â”€deviceâ”€â”¬â”€valueâ”€â”â”‚ 2015-01-01 00:00:00 â”‚ 1 â”‚ 3.6 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜[root@bj2-all-clickhouse-test-02 11:21:30 /data/clickhouse/node2/data/duyalan]#du -sh counter/13G counter/[root@bj2-all-clickhouse-test-02 11:21:35 /data/clickhouse/node2/data/duyalan]#du -sh counter/12G counter/[root@bj2-all-clickhouse-test-02 11:26:04 /data/clickhouse/node2/data/duyalan]#du -sh counter/6.5G counter/æ•°æ®æ…¢æ…¢è¢«å‹å® ç°åœ¨, è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬å¸Œæœ›å®šæœŸè¿è¡Œçš„ç¤ºä¾‹æŸ¥è¯¢. å®ƒæ±‡æ€»äº†æ•´ä¸ªé‡‡æ ·æœŸé—´æ‰€æœ‰è®¾å¤‡çš„æ‰€æœ‰æ•°æ®. åœ¨è¿™ç§æƒ…å†µä¸‹, è¿™æ„å‘³ç€è¡¨ä¸­3.25å¹´çš„æ•°æ®, éƒ½æ˜¯åœ¨2019å¹´ä¹‹å‰. 12345678910111213141516171819202122232425262728293031323334353637SELECT device, count(*) AS count, max(value) AS max, min(value) AS min, avg(value) AS avgFROM counterGROUP BY deviceORDER BY device ASCâ”Œâ”€deviceâ”€â”¬â”€â”€â”€â”€â”€countâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€maxâ”€â”¬â”€â”€â”€â”€â”€minâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€avgâ”€â”â”‚ 1 â”‚ 100000000 â”‚ 100008.15 â”‚ 3.077 â”‚ 50005.599374785554 â”‚â”‚ 2 â”‚ 100000000 â”‚ 100011.164 â”‚ 6.0761 â”‚ 50008.59962170133 â”‚â”‚ 3 â”‚ 100000000 â”‚ 100014.1 â”‚ 9.0022 â”‚ 50011.599634214646 â”‚â”‚ 4 â”‚ 100000000 â”‚ 100017.17 â”‚ 12.0063 â”‚ 50014.59989124005 â”‚â”‚ 5 â”‚ 100000000 â”‚ 100020.164 â”‚ 15.0384 â”‚ 50017.59997032414 â”‚â”‚ 6 â”‚ 100000000 â”‚ 100023.19 â”‚ 18.1045 â”‚ 50020.60019940771 â”‚â”‚ 7 â”‚ 100000000 â”‚ 100026.055 â”‚ 21.0566 â”‚ 50023.60046194672 â”‚â”‚ 8 â”‚ 100000000 â”‚ 100029.14 â”‚ 24.0477 â”‚ 50026.60002471252 â”‚â”‚ 9 â”‚ 100000000 â”‚ 100032.17 â”‚ 27.0218 â”‚ 50029.60008679837 â”‚â”‚ 10 â”‚ 100000000 â”‚ 100035.02 â”‚ 30.0629 â”‚ 50032.60051765903 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜10 rows in set. Elapsed: 12.036 sec. Processed 1.00 billion rows, 8.00 GB (83.08 million rows/s., 664.67 MB/s.) bj2-all-clickhouse-test-02 :) select min(when),max(when) from counter;SELECT min(when), max(when)FROM counterâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€min(when)â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€max(when)â”€â”â”‚ 2015-01-01 00:00:00 â”‚ 2018-03-03 09:46:39 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜1 rows in set. Elapsed: 9.941 sec. Processed 1.00 billion rows, 4.00 GB (100.59 million rows/s., 402.36 MB/s.) å‰é¢çš„æŸ¥è¯¢å¾ˆæ…¢, å› ä¸ºå®ƒå¿…é¡»è¯»å–è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®æ‰èƒ½è·å¾—ç­”æ¡ˆ. æˆ‘ä»¬æƒ³è¦è®¾è®¡ä¸€ä¸ªç‰©åŒ–è§†å›¾, è¯¥è§†å›¾è¯»å–çš„æ•°æ®è¦å°‘å¾—å¤š. äº‹å®è¯æ˜, å¦‚æœæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ¯å¤©æ±‡æ€»æ•°æ®çš„è§†å›¾, åˆ™ClickHouseå°†æ­£ç¡®åœ°åœ¨æ•´ä¸ªæ—¶é—´é—´éš”å†…æ±‡æ€»æ¯å¤©çš„æ•°æ®. ä¸å‰é¢çš„ç®€å•ç¤ºä¾‹(Part 1)ä¸åŒ, æˆ‘ä»¬å°†è‡ªå·±å®šä¹‰ç›®æ ‡(.innerè¡¨)è¡¨. è¿™æ ·åšçš„å¥½å¤„æ˜¯, è¯¥è¡¨ç°åœ¨å¯è§, è¿™ä½¿å¾—åŠ è½½æ•°æ®ä»¥åŠè¿›è¡Œæ¨¡å¼è¿ç§»(è¡¨ç»“æ„å˜æ›´)æ›´åŠ å®¹æ˜“. ä¸‹é¢æ˜¯ç›®æ ‡è¡¨çš„å®šä¹‰. 1234567891011CREATE TABLE counter_daily ( day DateTime, device UInt32, count UInt64, max_value_state AggregateFunction(max, Float32), min_value_state AggregateFunction(min, Float32), avg_value_state AggregateFunction(avg, Float32))ENGINE = SummingMergeTree()PARTITION BY tuple()ORDER BY (device, day) è¯¥è¡¨å®šä¹‰å¼•å…¥äº†ä¸€ç§æ–°çš„æ•°æ®ç±»å‹, ç§°ä¸ºAggregateFunction, è¯¥æ•°æ®ç±»å‹ä¿å­˜éƒ¨åˆ†èšåˆçš„æ•°æ®(which holds partially aggregated data). è¿™ä¸ªæ•°æ®ç±»å‹ç”¨äºsumå’Œcountä»¥å¤–çš„èšåˆéœ€æ±‚. æ¥ä¸‹æ¥, æˆ‘ä»¬åˆ›å»ºç›¸åº”çš„ç‰©åŒ–è§†å›¾. å®ƒä»counter(æºè¡¨)ä¸­é€‰æ‹©æ•°æ®, å¹¶ä½¿ç”¨CREATEè¯­å¥ä¸­çš„ç‰¹æ®ŠTOè¯­æ³•å°†æ•°æ®å‘é€åˆ°counter_daily(ç›®æ ‡è¡¨). è¯¥è¡¨æœ‰èšåˆå‡½æ•°, SELECTè¯­å¥æœ‰ä¸ä¹‹ç›¸åŒ¹é…çš„å‡½æ•°, å¦‚â€™ maxState â€˜. æˆ‘ä»¬å°†åœ¨è¯¦ç»†è®¨è®ºèšåˆå‡½æ•°æ—¶è®¨è®ºå®ƒä»¬ä¹‹é—´çš„å…³ç³». 12345678910111213CREATE MATERIALIZED VIEW counter_daily_mvTO counter_dailyAS SELECT toStartOfDay(when) as day, device, count(*) as count, maxState(value) AS max_value_state, minState(value) AS min_value_state, avgState(value) AS avg_value_stateFROM counterWHERE when &gt;= toDate(&#x27;2019-01-01 00:00:00&#x27;)GROUP BY device, dayORDER BY device, day TOå…³é”®å­—ä½¿æˆ‘ä»¬å¯ä»¥æŒ‡å‘ç›®æ ‡è¡¨(å­˜å‚¨ç‰©åŒ–è§†å›¾æ•°æ®çš„è¡¨, åœ¨æœ¬ä¾‹ä¸­å³æ˜¯counter_dailyè¡¨), ä½†æœ‰ä¸€ä¸ªç¼ºç‚¹. ClickHouseä¸å…è®¸åœ¨TOä¸­ä½¿ç”¨POPULATEå…³é”®å­—. å› æ­¤, ç‰©åŒ–è§†å›¾åˆ›å»ºåæ²¡æœ‰ä»»ä½•æ•°æ®. æˆ‘ä»¬å°†æ‰‹åŠ¨åŠ è½½æ•°æ®. ä½†æ˜¯, æˆ‘ä»¬è¿˜å°†ä½¿ç”¨ä¸€ä¸ªä¸é”™çš„æŠ€å·§, ä½¿æˆ‘ä»¬å¯ä»¥é¿å…åœ¨åŒæ—¶è¿›è¡Œæ´»åŠ¨æ•°æ®åŠ è½½çš„æƒ…å†µä¸‹å‡ºç°é—®é¢˜. æ³¨æ„, è§†å›¾å®šä¹‰æœ‰ä¸€ä¸ªWHEREå­å¥. è¿™æ„å‘³ç€2019å¹´ä¹‹å‰çš„ä»»ä½•æ•°æ®éƒ½åº”è¯¥è¢«å¿½ç•¥. æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ç§ä¸ä¸¢å¤±æ•°æ®çš„æ–¹æ³•æ¥å¤„ç†æ•°æ®åŠ è½½. è¯¥è§†å›¾å°†å¤„ç†2019å¹´åˆ°è¾¾çš„æ–°æ•°æ®. åŒæ—¶, æˆ‘ä»¬å¯ä»¥é€šè¿‡æ’å…¥åŠ è½½2018å¹´åŠä¹‹å‰çš„æ—§æ•°æ®. è®©æˆ‘ä»¬é€šè¿‡å°†æ–°æ•°æ®åŠ è½½åˆ°counterè¡¨ä¸­æ¥æ¼”ç¤ºå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„. æ–°æ•°æ®å°†äº2019å¹´å¼€å§‹, å¹¶å°†è‡ªåŠ¨åŠ è½½åˆ°è§†å›¾ä¸­. 123456INSERT INTO counter SELECT toDateTime(&#x27;2019-01-01 00:00:00&#x27;) + toInt64(number/10) AS when, (number % 10) + 1 AS device, (device * 3) + (number / 10000) + (rand() % 53) * 0.1 AS value FROM system.numbers LIMIT 100000000 ç°åœ¨, ä½¿ç”¨ä»¥ä¸‹INSERTæ‰‹åŠ¨åŠ è½½æ—§æ•°æ®. å®ƒä¼šåŠ è½½2018å¹´åŠä¹‹å‰çš„æ‰€æœ‰æ•°æ®. 123456789101112INSERT INTO counter_dailySELECT toStartOfDay(when) as day, device, count(*) AS count, maxState(value) AS max_value_state, minState(value) AS min_value_state, avgState(value) AS avg_value_stateFROM counterWHERE when &lt; toDateTime(&#x27;2019-01-01 00:00:00&#x27;)GROUP BY device, dayORDER BY device, day æˆ‘ä»¬ç»ˆäºå¯ä»¥ä»è§†å›¾ä¸­æŸ¥è¯¢æ•°æ®äº†. ä¸ç›®æ ‡è¡¨å’Œç‰©åŒ–åŒ–è§†å›¾ä¸€æ ·, ClickHouseä½¿ç”¨ä¸“ç”¨è¯­æ³•ä»è§†å›¾ä¸­è¿›è¡Œé€‰æ‹©. 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677ç‰©åŒ–è§†å›¾ç›®æ ‡è¡¨SELECT device, sum(count) AS count, maxMerge(max_value_state) AS max, minMerge(min_value_state) AS min, avgMerge(avg_value_state) AS avgFROM counter_dailyGROUP BY deviceORDER BY device ASCâ”Œâ”€deviceâ”€â”¬â”€â”€â”€â”€â”€countâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€maxâ”€â”¬â”€â”€â”€â”€â”€minâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€avgâ”€â”â”‚ 1 â”‚ 110000000 â”‚ 100008.15 â”‚ 3.051 â”‚ 45914.69035234097 â”‚â”‚ 2 â”‚ 110000000 â”‚ 100011.164 â”‚ 6.0291 â”‚ 45917.69056040798 â”‚â”‚ 3 â”‚ 110000000 â”‚ 100014.1 â”‚ 9.0022 â”‚ 45920.690478928045 â”‚â”‚ 4 â”‚ 110000000 â”‚ 100017.17 â”‚ 12.0063 â”‚ 45923.69086044358 â”‚â”‚ 5 â”‚ 110000000 â”‚ 100020.164 â”‚ 15.0114 â”‚ 45926.69083122718 â”‚â”‚ 6 â”‚ 110000000 â”‚ 100023.19 â”‚ 18.0475 â”‚ 45929.691088042426 â”‚â”‚ 7 â”‚ 110000000 â”‚ 100026.055 â”‚ 21.0566 â”‚ 45932.69135215635 â”‚â”‚ 8 â”‚ 110000000 â”‚ 100029.14 â”‚ 24.0107 â”‚ 45935.690912335944 â”‚â”‚ 9 â”‚ 110000000 â”‚ 100032.17 â”‚ 27.0218 â”‚ 45938.69098338585 â”‚â”‚ 10 â”‚ 110000000 â”‚ 100035.02 â”‚ 30.0429 â”‚ 45941.69140548378 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜10 rows in set. Elapsed: 0.019 sec. Processed 13.69 thousand rows, 1.12 MB (729.14 thousand rows/s., 59.84 MB/s.) ç‰©åŒ–è§†å›¾SELECT device, sum(count) AS count, maxMerge(max_value_state) AS max, minMerge(min_value_state) AS min, avgMerge(avg_value_state) AS avgFROM counter_daily_mvGROUP BY deviceORDER BY device ASCâ”Œâ”€deviceâ”€â”¬â”€â”€â”€â”€â”€countâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€maxâ”€â”¬â”€â”€â”€â”€â”€minâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€avgâ”€â”â”‚ 1 â”‚ 110000000 â”‚ 100008.15 â”‚ 3.051 â”‚ 45914.69035234097 â”‚â”‚ 2 â”‚ 110000000 â”‚ 100011.164 â”‚ 6.0291 â”‚ 45917.69056040798 â”‚â”‚ 3 â”‚ 110000000 â”‚ 100014.1 â”‚ 9.0022 â”‚ 45920.690478928045 â”‚â”‚ 4 â”‚ 110000000 â”‚ 100017.17 â”‚ 12.0063 â”‚ 45923.69086044358 â”‚â”‚ 5 â”‚ 110000000 â”‚ 100020.164 â”‚ 15.0114 â”‚ 45926.69083122718 â”‚â”‚ 6 â”‚ 110000000 â”‚ 100023.19 â”‚ 18.0475 â”‚ 45929.691088042426 â”‚â”‚ 7 â”‚ 110000000 â”‚ 100026.055 â”‚ 21.0566 â”‚ 45932.69135215635 â”‚â”‚ 8 â”‚ 110000000 â”‚ 100029.14 â”‚ 24.0107 â”‚ 45935.690912335944 â”‚â”‚ 9 â”‚ 110000000 â”‚ 100032.17 â”‚ 27.0218 â”‚ 45938.69098338585 â”‚â”‚ 10 â”‚ 110000000 â”‚ 100035.02 â”‚ 30.0429 â”‚ 45941.69140548378 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜10 rows in set. Elapsed: 0.003 sec. Processed 13.69 thousand rows, 1.12 MB (3.99 million rows/s., 327.87 MB/s.) æºè¡¨SELECT device, count(*) AS count, max(value) AS max, min(value) AS min, avg(value) AS avgFROM counterGROUP BY deviceORDER BY device ASCâ”Œâ”€deviceâ”€â”¬â”€â”€â”€â”€â”€countâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€maxâ”€â”¬â”€â”€â”€â”€â”€minâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€avgâ”€â”â”‚ 1 â”‚ 110000000 â”‚ 100008.15 â”‚ 3.051 â”‚ 45914.69035234098 â”‚â”‚ 2 â”‚ 110000000 â”‚ 100011.164 â”‚ 6.0291 â”‚ 45917.69056040798 â”‚â”‚ 3 â”‚ 110000000 â”‚ 100014.1 â”‚ 9.0022 â”‚ 45920.69047892806 â”‚â”‚ 4 â”‚ 110000000 â”‚ 100017.17 â”‚ 12.0063 â”‚ 45923.69086044358 â”‚â”‚ 5 â”‚ 110000000 â”‚ 100020.164 â”‚ 15.0114 â”‚ 45926.690831227155 â”‚â”‚ 6 â”‚ 110000000 â”‚ 100023.19 â”‚ 18.0475 â”‚ 45929.69108804243 â”‚â”‚ 7 â”‚ 110000000 â”‚ 100026.055 â”‚ 21.0566 â”‚ 45932.691352156355 â”‚â”‚ 8 â”‚ 110000000 â”‚ 100029.14 â”‚ 24.0107 â”‚ 45935.690912335944 â”‚â”‚ 9 â”‚ 110000000 â”‚ 100032.17 â”‚ 27.0218 â”‚ 45938.69098338586 â”‚â”‚ 10 â”‚ 110000000 â”‚ 100035.02 â”‚ 30.0429 â”‚ 45941.69140548378 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜10 rows in set. Elapsed: 14.041 sec. Processed 1.10 billion rows, 8.80 GB (78.34 million rows/s., 626.72 MB/s.) è¯¥æŸ¥è¯¢æ­£ç¡®æ€»ç»“äº†åŒ…æ‹¬æ–°æ’å…¥æ•°æ®åœ¨å†…çš„æ‰€æœ‰æ•°æ®. æ‚¨å¯ä»¥é€šè¿‡åœ¨counterè¡¨ä¸Šé‡æ–°è¿è¡ŒåŸå§‹é€‰æ‹©æ¥æ£€æŸ¥è®¡ç®—ç»“æœæ˜¯å¦ä¸€è‡´. ä¸åŒä¹‹å¤„åœ¨äº, ç‰©åŒ–è§†å›¾è¿”å›æ•°æ®çš„é€Ÿåº¦è¦å¿«900å€(åœ¨æˆ‘çš„æµ‹è¯•ä¸­ä¸º4680å€). ç”±æ­¤å¯è§, å­¦ä¹ ä¸€äº›æ–°è¯­æ³•æ˜¯å€¼å¾—çš„!! æ­¤æ—¶, æˆ‘ä»¬å¯ä»¥å›è¿‡å¤´æ¥è§£é‡Šä¸€ä¸‹åœ¨è¿™ä¸€åˆ‡çš„å¹•åå‘ç”Ÿäº†ä»€ä¹ˆ. Aggregate FunctionsAggregate functionsç±»ä¼¼äºæ”¶é›†å™¨(collectors), å…è®¸ClickHouseä»åˆ†å¸ƒåœ¨å¤šä¸ªpartsä¸Šçš„æ•°æ®æ„å»ºèšåˆ. ä¸‹é¢çš„å›¾è¡¨æ˜¾ç¤ºäº†å¦‚ä½•è®¡ç®—å¹³å‡å€¼. æˆ‘ä»¬ä»æºè¡¨ä¸­çš„ä¸€ä¸ªå¯é€‰å€¼å¼€å§‹. ç‰©åŒ–è§†å›¾ä½¿ç”¨avgStateå‡½æ•°å°†æ•°æ®è½¬æ¢ä¸ºpartial aggregate, avgStateå‡½æ•°æ˜¯ä¸€ä¸ªå†…éƒ¨ç»“æ„. æœ€å, åœ¨æŸ¥è¯¢æ•°æ®æ—¶, åº”ç”¨avgMergeå°†partial aggregatesçš„æ•°æ®ç´¯åŠ ä¸ºæœ€ç»ˆçš„æ•°å­—. partial aggregateä½¿ç‰©åŒ–è§†å›¾èƒ½å¤Ÿå¤„ç†åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šçš„å¤šä¸ªpartsä¸Šçš„æ•°æ®. å³ä½¿æ‚¨æ›´æ”¹äº†group byåˆ—, mergeå‡½æ•°ä¹Ÿå¯ä»¥æ­£ç¡®åœ°ç»„è£…èšåˆ. ä»…ä»…ç»“åˆç®€å•çš„å¹³å‡å€¼æ˜¯è¡Œä¸é€šçš„, å› ä¸ºå®ƒä»¬åœ¨å°†æ¯ä¸ªéƒ¨åˆ†å¹³å‡å€¼åŠ åˆ°æ€»æ•°æ—¶ç¼ºä¹å¿…è¦çš„æƒé‡. è¿™ç§è¡Œä¸ºæœ‰ä¸€ä¸ªé‡è¦çš„åæœ(è¿™æ®µä¸ä¼šç¿»è¯‘, åŸæ–‡: It would not work just to combine simple average values, because they would be lacking the weights necessary to scale each partial average as it added to the total. This behavior has an important consequence.). è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡, ClickHouseå¯ä»¥ä½¿ç”¨å¸¦æœ‰æ±‡æ€»çš„æ¯æ—¥æ•°æ®çš„ç‰©åŒ–è§†å›¾æ¥å›ç­”æˆ‘ä»¬çš„ç¤ºä¾‹æŸ¥è¯¢å—?è¿™æ˜¯èšåˆå‡½æ•°å·¥ä½œçš„ç»“æœ. è¿™æ„å‘³ç€æˆ‘ä»¬çš„dailyè§†å›¾è¿˜å¯ä»¥å›ç­”å…³äºå‘¨ã€æœˆã€å¹´æˆ–æ•´ä¸ªé—´éš”çš„é—®é¢˜. ClickHouseæœ‰ç‚¹ä¸å¯»å¸¸, å®ƒç›´æ¥ä»¥SQLè¯­æ³•å…¬å¼€äº†partial aggregates, ä½†æ˜¯å®ƒä»¬è§£å†³é—®é¢˜çš„æ–¹å¼éå¸¸å¼ºå¤§. å½“æ‚¨è®¾è®¡å®ä¾‹åŒ–è§†å›¾æ—¶, è¯·å°è¯•ä½¿ç”¨æ¯æ—¥æ±‡æ€»ä¹‹ç±»çš„æŠ€å·§æ¥è§£å†³å•ä¸ªè§†å›¾ä¸­çš„å¤šä¸ªé—®é¢˜. å•ä¸ªè§†å›¾å¯ä»¥å›ç­”å¾ˆå¤šé—®é¢˜. Table Engines for Materialized ViewsClickHouseæœ‰å¤šä¸ªå¯¹ç‰©åŒ–è§†å›¾æœ‰ç”¨çš„å¼•æ“. AggregatingMergeTreeå¼•æ“åªä½¿ç”¨èšåˆå‡½æ•°. å¦‚æœæ‚¨æƒ³åšè®¡æ•°æˆ–æ±‚å’Œ, æ‚¨éœ€è¦ä½¿ç”¨ç›®æ ‡è¡¨ä¸­çš„AggregateFunctionæ•°æ®ç±»å‹æ¥å®šä¹‰å®ƒä»¬. æ‚¨è¿˜éœ€è¦åœ¨è§†å›¾å’Œselectè¯­å¥ä¸­ä½¿ç”¨stateå’Œmergeå‡½æ•°. ä¾‹å¦‚, è¦å¤„ç†è®¡æ•°(count), æ‚¨éœ€è¦åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨countState(count)å’ŒcountMerge(count). æˆ‘ä»¬å»ºè®®ä½¿ç”¨SummingMergeTreeå¼•æ“åœ¨ç‰©åŒ–è§†å›¾ä¸­è¿›è¡Œèšåˆ. å®ƒå¯ä»¥å¾ˆå¥½åœ°å¤„ç†èšåˆå‡½æ•°. å®ƒå¯ä»¥å¾ˆå¥½åœ°å¤„ç†èšåˆå‡½æ•°. ä½†æ˜¯, å®ƒä¼šå°†å®ƒä»¬éšè—èµ·æ¥ä»¥è¿›è¡Œæ€»æ•°å’Œè®¡æ•°, è¿™å¯¹äºç®€å•çš„æ¡ˆä¾‹æ¥è¯´éå¸¸æ–¹ä¾¿. åœ¨è¿™ç§æƒ…å†µä¸‹, å®ƒä¸ä¼šé˜»æ­¢æ‚¨ä½¿ç”¨stateå’Œmergeå‡½æ•°; åªæ˜¯ä½ æ²¡å¿…è¦è¿™ä¹ˆåš. åŒæ—¶, å®ƒå®Œæˆäº†AggregatingMergeTreeçš„æ‰€æœ‰å·¥ä½œ. Schema Migrationåœ¨ç”Ÿäº§ç³»ç»Ÿä¸­, æ•°æ®åº“æ¨¡å¼å¾€å¾€ä¼šå‘ç”Ÿå˜åŒ–, ç‰¹åˆ«æ˜¯é‚£äº›æ­£åœ¨ç§¯æå¼€å‘çš„ç³»ç»Ÿ. å½“ä½¿ç”¨å¸¦æœ‰æ˜¾å¼ç›®æ ‡è¡¨çš„ç‰©åŒ–è§†å›¾æ—¶, å¯ä»¥ç›¸å¯¹å®¹æ˜“åœ°ç®¡ç†è¿™äº›æ›´æ”¹. è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­. å‡è®¾counterè¡¨çš„åç§°æ›´æ”¹ä¸ºcounter_replicated. ä¸€æ—¦åº”ç”¨äº†æ­¤æ›´æ”¹, ç‰©åŒ–è§†å›¾å°†æ— æ³•å·¥ä½œ. æ›´ç³Ÿç³•çš„æ˜¯, è¿™ä¸ªé”™è¯¯å°†é˜»æ­¢å¯¹counterè¡¨çš„æ’å…¥. æ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹å¼å¤„ç†æ›´æ”¹. 1234567891011121314151617-- Delete view prior to schema change.DROP TABLE counter_daily_mv-- Rename source table.RENAME TABLE counter TO counter_replicated-- Recreate view with correct source table name.CREATE MATERIALIZED VIEW counter_daily_mvTO counter_dailyAS SELECT toStartOfDay(when) as day, device, count(*) as count, maxState(value) AS max_value_state, minState(value) AS min_value_state, avgState(value) AS avg_value_stateFROM counter_replicatedGROUP BY device, dayORDER BY device, day æ ¹æ®æ¶æ„è¿ç§»ä¸­çš„å®é™…æ­¥éª¤, æ‚¨å¯èƒ½å¿…é¡»å¤„ç†æ›´æ”¹ç‰©åŒ–è§†å›¾å®šä¹‰æ—¶æ’å…¥åˆ°æºè¡¨çš„æ•°æ®(è¿™äº›æ•°æ®æœªæ’å…¥åˆ°ç‰©åŒ–è§†å›¾ä¸­). æ‚¨å¯ä»¥ä½¿ç”¨è¿‡æ»¤æ¡ä»¶å’Œæ‰‹åŠ¨åŠ è½½æ¥å¤„ç†è¯¥é—®é¢˜, å¦‚æˆ‘ä»¬åœ¨ä¸»è¦ç¤ºä¾‹ä¸­æ‰€ç¤º. Materialized View Plumbing and Data Sizesæœ€å, è®©æˆ‘ä»¬å†çœ‹çœ‹æ•°æ®è¡¨å’Œç‰©åŒ–è§†å›¾ä¹‹é—´çš„å…³ç³». ç›®æ ‡è¡¨æ˜¯ä¸€ä¸ªæ™®é€šè¡¨. æ‚¨å¯ä»¥ä»ç›®æ ‡è¡¨æˆ–ç‰©åŒ–è§†å›¾ä¸­é€‰æ‹©æ•°æ®. æ²¡æœ‰åŒºåˆ«. æ­¤å¤–, å¦‚æœæ‚¨åˆ é™¤ç‰©åŒ–è§†å›¾, ç›®æ ‡è¡¨æ‰”å°†ä¿ç•™. æ­£å¦‚æˆ‘ä»¬åˆšæ‰æ‰€å±•ç¤ºçš„, æ‚¨å¯ä»¥é€šè¿‡ç®€å•åœ°åˆ é™¤å’Œé‡æ–°åˆ›å»ºè§†å›¾æ¥å¯¹å…¶è¿›è¡Œæ¨¡å¼æ›´æ”¹. å¦‚æœéœ€è¦æ›´æ”¹ç›®æ ‡è¡¨æœ¬èº«, å¯ä»¥åƒå¯¹ä»»ä½•å…¶ä»–è¡¨ä¸€æ ·è¿è¡ŒALTER tableå‘½ä»¤. è¯¥å›¾è¿˜æ˜¾ç¤ºäº†æºè¡¨å’Œç›®æ ‡è¡¨çš„æ•°æ®å¤§å°. ç‰©åŒ–è§†å›¾é€šå¸¸è¿œå°äºå…¶æ±‡æ€»æ•°æ®çš„è¡¨. æˆ‘ä»¬çš„ç¤ºä¾‹å°±æ˜¯è¿™æ ·çš„ç»“æœ. ä»¥ä¸‹æŸ¥è¯¢æ˜¾ç¤ºäº†æ­¤ç¤ºä¾‹çš„å¤§å°å·®å¼‚. 123456789101112131415SELECT table, formatReadableSize(sum(data_compressed_bytes)) AS tc, formatReadableSize(sum(data_uncompressed_bytes)) AS tu, sum(data_compressed_bytes) / sum(data_uncompressed_bytes) AS ratioFROM system.columnsWHERE database = currentDatabase()GROUP BY tableORDER BY table ASCâ”Œâ”€tableâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€tcâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€tuâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ratioâ”€â”â”‚ counter â”‚ 7.14 GiB â”‚ 12.29 GiB â”‚ 0.5805970993939394 â”‚â”‚ counter_daily â”‚ 248.77 KiB â”‚ 494.31 KiB â”‚ 0.503261750004939 â”‚â”‚ counter_daily_mv â”‚ 0.00 B â”‚ 0.00 B â”‚ nan â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å¦‚è®¡ç®—æ‰€ç¤º, ç‰©åŒ–è§†å›¾ç›®æ ‡è¡¨å¤§çº¦æ¯”ç‰©åŒ–è§†å›¾æ´¾ç”Ÿçš„æºæ•°æ®å°3ä¸‡å€. è¿™ç§å·®å¼‚æå¤§åœ°åŠ å¿«äº†æŸ¥è¯¢é€Ÿåº¦. å¦‚å‰é¢æ‰€ç¤º, åœ¨ä½¿ç”¨æ¥è‡ªç‰©åŒ–è§†å›¾çš„æ•°æ®æ—¶, æµ‹è¯•æŸ¥è¯¢çš„è¿è¡Œé€Ÿåº¦å¤§çº¦å¿«äº†900x(æˆ‘è¿™é‡Œæµ‹è¯•ä¸º4680x). Wrap-upClickHouseç‰©åŒ–è§†å›¾éå¸¸çµæ´», è¿™å¾—ç›Šäºå¼ºå¤§çš„èšåˆåŠŸèƒ½ä»¥åŠæºè¡¨ã€ç‰©åŒ–è§†å›¾å’Œç›®æ ‡è¡¨ä¹‹é—´çš„ç®€å•å…³ç³». ç‰©åŒ–è§†å›¾å…è®¸æ˜¾å¼ç›®æ ‡è¡¨, è¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„ç‰¹æ€§, å¯ä»¥ç®€åŒ–æ¨¡å¼è¿ç§». æ‚¨è¿˜å¯ä»¥é€šè¿‡å‘è§†å›¾é€‰æ‹©å®šä¹‰æ·»åŠ ç­›é€‰æ¡ä»¶å¹¶æ‰‹åŠ¨åŠ è½½ä¸¢å¤±çš„æ•°æ®æ¥å‡å°‘å¯èƒ½ä¸¢å¤±çš„è§†å›¾æ›´æ–°. ç‰©åŒ–è§†å›¾è¿˜æœ‰è®¸å¤šå…¶ä»–æ–¹æ³•å¯ä»¥å¸®åŠ©è½¬æ¢æ•°æ®. æˆ‘ä»¬å·²ç»æè¿°äº†å…¶ä¸­çš„ä¸€äº›é—®é¢˜, æ¯”å¦‚ last point queries, å¹¶ä¸”è®¡åˆ’å°†æ¥åœ¨è¿™ä¸ªåšå®¢ä¸Šå†™ä¸€äº›å…¶ä»–çš„é—®é¢˜. æ¬²äº†è§£æ›´å¤šä¿¡æ¯, è¯·æŸ¥çœ‹æˆ‘ä»¬æœ€è¿‘çš„ç½‘ç»œç ”è®¨ä¼šClickHouse and the Magic of Materialized Views. æˆ‘ä»¬åœ¨è¿™é‡Œä»‹ç»äº†å‡ ä¸ªç”¨ä¾‹ç¤ºä¾‹. æœ€å, å¦‚æœä½ æ­£åœ¨ä»¥ä½ è®¤ä¸ºå…¶ä»–ç”¨æˆ·ä¼šæ„Ÿå…´è¶£çš„æ–¹å¼ä½¿ç”¨ç‰©åŒ–è§†å›¾, å†™ä¸€ç¯‡æ–‡ç« æˆ–è€…åœ¨å½“åœ°çš„ClickHouseä¼šè®®ä¸Šå‘è¨€. æˆ‘ä»¬å¾ˆä¹æ„åœ¨Altinityçš„åšå®¢ä¸Šå‘å¸ƒç¤¾åŒºç”¨æˆ·çš„å†…å®¹, å¹¶åœ¨æœªæ¥çš„èšä¼šä¸Šå¯»æ‰¾æ¼”è®²è€…. å¦‚æœä½ æœ‰ä»€ä¹ˆæƒ³ä¸ç¤¾åŒºåˆ†äº«çš„, è¯·è®©æˆ‘ä»¬çŸ¥é“.","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"},{"name":"ç‰©åŒ–è§†å›¾","slug":"ç‰©åŒ–è§†å›¾","permalink":"http://fuxkdb.com/tags/%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE/"}]},{"title":"è¯‘æ–‡ ClickHouse Materialized Views Illuminated, Part 1","slug":"2020-08-23-è¯‘æ–‡-ClickHouse-Materialized-Views-Illuminated,-Part-1","date":"2020-08-23T11:04:00.000Z","updated":"2020-08-23T11:04:57.497Z","comments":true,"path":"2020/08/23/2020-08-23-è¯‘æ–‡-ClickHouse-Materialized-Views-Illuminated,-Part-1/","link":"","permalink":"http://fuxkdb.com/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-1/","excerpt":"ClickHouse Materialized Views Illuminated, Part 1 Altinity blogçš„è¯»è€…ä»¬çŸ¥é“æˆ‘ä»¬å–œæ¬¢ClickHouseçš„ç‰©åŒ–è§†å›¾. ç‰©åŒ–è§†å›¾å¯ä»¥å®ç°èšåˆè®¡ç®—, ä»Kafkaè¯»å–æ•°æ®, å®ç°æœ€åç‚¹æŸ¥è¯¢(last point queries)ä»¥åŠé‡ç»„è¡¨ä¸»é”®ç´¢å¼•å’Œæ’åºé¡ºåº. é™¤äº†è¿™äº›åŠŸèƒ½ä¹‹å¤–, ç‰©åŒ–è§†å›¾å¯ä»¥åœ¨å¤§é‡èŠ‚ç‚¹ä¸Šå¾ˆå¥½åœ°æ‰©ç¼©, å¹¶å¯ä»¥å¤„ç†å¤§å‹æ•°æ®é›†. å®ƒä»¬æ˜¯ClickHouseçš„ç‹¬ç‰¹åŠŸèƒ½ä¹‹ä¸€. åœ¨è®¡ç®—é¢†åŸŸ, å¼ºå¤§çš„åŠŸèƒ½è‡³å°‘æ„å‘³ç€ä¸€ç‚¹ç‚¹å¤æ‚æ€§. è¿™ç¯‡ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„æ–‡ç« é€šè¿‡è§£é‡Šç‰©åŒ–è§†å›¾çš„å·¥ä½œåŸç†æ¥å¡«è¡¥ç©ºç™½, ä»è€Œä½¿åˆå­¦è€…ä¹Ÿå¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨å®ƒä»¬. æˆ‘ä»¬å°†é€šè¿‡å‡ ä¸ªè¯¦ç»†çš„ç¤ºä¾‹, æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ä½¿ç”¨è¿›è¡Œè°ƒæ•´. åœ¨æ­¤è¿‡ç¨‹ä¸­, æˆ‘ä»¬å°†æ¢ç´¢ç”¨äºåˆ›å»ºè§†å›¾çš„è¯­æ³•çš„ç¡®åˆ‡å«ä¹‰, å¹¶è®©æ‚¨æ·±å…¥äº†è§£ClickHouseåœ¨åšä»€ä¹ˆ. ç¤ºä¾‹æ˜¯å®Œå…¨è‡ªåŒ…å«çš„, å› æ­¤æ‚¨å¯ä»¥å°†å®ƒä»¬å¤åˆ¶/ç²˜è´´åˆ°clickhouse-clientä¸­å¹¶è‡ªå·±è¿è¡Œå®ƒä»¬.","text":"ClickHouse Materialized Views Illuminated, Part 1 Altinity blogçš„è¯»è€…ä»¬çŸ¥é“æˆ‘ä»¬å–œæ¬¢ClickHouseçš„ç‰©åŒ–è§†å›¾. ç‰©åŒ–è§†å›¾å¯ä»¥å®ç°èšåˆè®¡ç®—, ä»Kafkaè¯»å–æ•°æ®, å®ç°æœ€åç‚¹æŸ¥è¯¢(last point queries)ä»¥åŠé‡ç»„è¡¨ä¸»é”®ç´¢å¼•å’Œæ’åºé¡ºåº. é™¤äº†è¿™äº›åŠŸèƒ½ä¹‹å¤–, ç‰©åŒ–è§†å›¾å¯ä»¥åœ¨å¤§é‡èŠ‚ç‚¹ä¸Šå¾ˆå¥½åœ°æ‰©ç¼©, å¹¶å¯ä»¥å¤„ç†å¤§å‹æ•°æ®é›†. å®ƒä»¬æ˜¯ClickHouseçš„ç‹¬ç‰¹åŠŸèƒ½ä¹‹ä¸€. åœ¨è®¡ç®—é¢†åŸŸ, å¼ºå¤§çš„åŠŸèƒ½è‡³å°‘æ„å‘³ç€ä¸€ç‚¹ç‚¹å¤æ‚æ€§. è¿™ç¯‡ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„æ–‡ç« é€šè¿‡è§£é‡Šç‰©åŒ–è§†å›¾çš„å·¥ä½œåŸç†æ¥å¡«è¡¥ç©ºç™½, ä»è€Œä½¿åˆå­¦è€…ä¹Ÿå¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨å®ƒä»¬. æˆ‘ä»¬å°†é€šè¿‡å‡ ä¸ªè¯¦ç»†çš„ç¤ºä¾‹, æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ä½¿ç”¨è¿›è¡Œè°ƒæ•´. åœ¨æ­¤è¿‡ç¨‹ä¸­, æˆ‘ä»¬å°†æ¢ç´¢ç”¨äºåˆ›å»ºè§†å›¾çš„è¯­æ³•çš„ç¡®åˆ‡å«ä¹‰, å¹¶è®©æ‚¨æ·±å…¥äº†è§£ClickHouseåœ¨åšä»€ä¹ˆ. ç¤ºä¾‹æ˜¯å®Œå…¨è‡ªåŒ…å«çš„, å› æ­¤æ‚¨å¯ä»¥å°†å®ƒä»¬å¤åˆ¶/ç²˜è´´åˆ°clickhouse-clientä¸­å¹¶è‡ªå·±è¿è¡Œå®ƒä»¬. How Materialized Views Work: Computing SumsClickHouseç‰©åŒ–è§†å›¾è‡ªåŠ¨åœ¨è¡¨ä¹‹é—´è½¬æ¢æ•°æ®. å®ƒä»¬ç±»ä¼¼äºè§¦å‘å™¨, å¯¹æ’å…¥çš„è¡Œè¿è¡ŒæŸ¥è¯¢å¹¶å°†ç»“æœå­˜å…¥ç¬¬äºŒä¸ªè¡¨. è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªåŸºæœ¬çš„ä¾‹å­. å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®°å½•ç”¨æˆ·ä¸‹è½½çš„è¡¨, å¦‚ä¸‹æ‰€ç¤º. 1234567CREATE TABLE download ( when DateTime, userid UInt32, bytes Float32) ENGINE=MergeTreePARTITION BY toYYYYMM(when)ORDER BY (userid, when) æˆ‘ä»¬å¸Œæœ›è·Ÿè¸ªæ¯ä¸ªç”¨æˆ·çš„æ¯æ—¥ä¸‹è½½. è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç”¨ä¸€ä¸ªæŸ¥è¯¢æ¥åšåˆ°è¿™ä¸€ç‚¹. é¦–å…ˆ, æˆ‘ä»¬éœ€è¦ä¸ºå•ä¸ªç”¨æˆ·å‘è¡¨ä¸­æ·»åŠ ä¸€äº›æ•°æ®. 1234567INSERT INTO download SELECT now() + number * 60 as when, 25, rand() % 100000000 FROM system.numbers LIMIT 5000 æ¥ä¸‹æ¥, è®©æˆ‘ä»¬è¿è¡Œä¸€ä¸ªæŸ¥è¯¢æ¥æ˜¾ç¤ºè¯¥ç”¨æˆ·çš„æ¯æ—¥ä¸‹è½½. å½“æ·»åŠ æ–°ç”¨æˆ·æ—¶, è¿™ä¹Ÿå°†æ­£å¸¸å·¥ä½œ. 12345678910111213141516171819SELECT toStartOfDay(when) AS day, userid, count() AS downloads, sum(bytes) AS bytesFROM downloadGROUP BY userid, dayORDER BY userid ASC, day ASCâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 736 â”‚ 36722522631 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73305428060 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73183910537 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 1384 â”‚ 70059352697 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯æ¬¡è¿è¡ŒæŸ¥è¯¢ä»¥äº¤äº’æ–¹å¼ä¸ºåº”ç”¨ç¨‹åºè®¡ç®—è¿™äº›æ¯æ—¥æ€»æ•°, ä½†æ˜¯å¯¹äºå¤§å‹è¡¨, æå‰è®¡ç®—å®ƒä»¬å°†æ›´å¿«, æ›´èŠ‚çœèµ„æº. å› æ­¤, æœ€å¥½å°†ç»“æœæ”¾åœ¨å•ç‹¬çš„è¡¨æ ¼ä¸­, è¯¥è¡¨æ ¼å¯ä»¥è¿ç»­è·Ÿè¸ªæ¯å¤©æ¯ä¸ªç”¨æˆ·çš„ä¸‹è½½æ€»æ•°. æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç‰©åŒ–è§†å›¾æ¥åšåˆ°è¿™ä¸€ç‚¹. 1234567891011CREATE MATERIALIZED VIEW download_daily_mvENGINE = SummingMergeTreePARTITION BY toYYYYMM(day) ORDER BY (userid, day)POPULATEAS SELECT toStartOfDay(when) AS day, userid, count() as downloads, sum(bytes) AS bytesFROM downloadGROUP BY userid, day è¿™é‡Œæœ‰ä¸‰ä»¶é‡è¦çš„äº‹æƒ…éœ€è¦æ³¨æ„. é¦–å…ˆ, ç‰©åŒ–è§†å›¾å®šä¹‰å…è®¸ç±»ä¼¼äºCREATE TABLEçš„è¯­æ³•, è¿™æ˜¯æœ‰æ„ä¹‰çš„, å› ä¸ºè¿™ä¸ªå‘½ä»¤å°†å®é™…åˆ›å»ºä¸€ä¸ªéšè—çš„ç›®æ ‡è¡¨(.innerè¡¨)æ¥ä¿å­˜è§†å›¾æ•°æ®. æˆ‘ä»¬ä½¿ç”¨çš„ClickHouseå¼•æ“æ—¨åœ¨ä½¿è®¡ç®—å’Œè®¡æ•°å˜å¾—ç®€å•:SummingMergeTree. å®ƒæ˜¯ç”¨äºè®¡ç®—èšåˆçš„ç‰©åŒ–è§†å›¾çš„æ¨èå¼•æ“. å…¶æ¬¡, è§†å›¾å®šä¹‰åŒ…å«å…³é”®å­—POPULATE. è¿™å‘Šè¯‰ClickHouseå°†downloadè¡¨ä¸­çš„ç°æœ‰æ•°æ®æ’å…¥ç‰©åŒ–è§†å›¾. æˆ‘ä»¬ç¨åä¼šæ›´å¤šåœ°è®¨è®ºautomatic population. éœ€è¦æ³¨æ„, åœ¨POPULATEå¡«å……å†å²æ•°æ®çš„æœŸé—´, æ–°è¿›å…¥çš„è¿™éƒ¨åˆ†æ•°æ®ä¼šè¢«å¿½ç•¥æ‰, æ‰€ä»¥å¦‚æœå¯¹å‡†ç¡®æ€§è¦æ±‚éå¸¸é«˜, åº”æ…ç”¨ ç¬¬ä¸‰, è§†å›¾å®šä¹‰åŒ…å«ä¸€ä¸ªSELECTè¯­å¥, è¯¥è¯­å¥å®šä¹‰åœ¨åŠ è½½è§†å›¾æ—¶å¦‚ä½•è½¬æ¢æ•°æ®. è¿™ä¸ªæŸ¥è¯¢åœ¨è¡¨ä¸­çš„æ–°æ•°æ®ä¸Šè¿è¡Œ, ä»¥è®¡ç®—æ¯å¤©æ¯ä¸ªç”¨æˆ·idçš„ä¸‹è½½æ•°é‡å’Œæ€»å­—èŠ‚æ•°. å®ƒæœ¬è´¨ä¸Šä¸æˆ‘ä»¬ä»¥äº¤äº’æ–¹å¼è¿è¡Œçš„æŸ¥è¯¢ç›¸åŒ, åªæ˜¯åœ¨æœ¬ä¾‹ä¸­, ç»“æœå°†æ”¾åœ¨éšè—çš„ç›®æ ‡è¡¨(.innerè¡¨)ä¸­. æˆ‘ä»¬å¯ä»¥è·³è¿‡æ’åº, å› ä¸ºè§†å›¾å®šä¹‰å·²ç»ç¡®ä¿äº†æ’åºé¡ºåº. ç°åœ¨, æˆ‘ä»¬ä»ç‰©åŒ–è§†å›¾ä¸­æŸ¥è¯¢æ•°æ® 12345678910SELECT * FROM download_daily_mvORDER BY day, userid LIMIT 5â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 736 â”‚ 36722522631 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73305428060 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73183910537 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 1384 â”‚ 70059352697 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ è¿™ä¸ºæˆ‘ä»¬æä¾›äº†ä¸å…ˆå‰æŸ¥è¯¢å®Œå…¨ç›¸åŒçš„ç­”æ¡ˆ. åŸå› æ˜¯ä¸Šé¢ä»‹ç»çš„POPULATEå…³é”®å­—. å®ƒç¡®ä¿æºè¡¨ä¸­çš„ç°æœ‰æ•°æ®è‡ªåŠ¨åŠ è½½åˆ°è§†å›¾ä¸­. ä¸è¿‡, æœ‰ä¸€ä¸ªé‡è¦è­¦å‘Šï¼šå¦‚æœåœ¨å¡«å……è§†å›¾æ—¶æ’å…¥äº†æ–°æ•°æ®, ClickHouseå°†ä¼šä¸¢å¤±å®ƒä»¬. åœ¨æœ¬ç³»åˆ—çš„ç¬¬äºŒéƒ¨åˆ†ä¸­, æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•æ‰‹åŠ¨æ’å…¥æ•°æ®å¹¶é¿å…æ•°æ®é—æ¼çš„é—®é¢˜. ç°åœ¨, å°è¯•ä½¿ç”¨å…¶ä»–ç”¨æˆ·å‘è¡¨ä¸­æ·»åŠ æ›´å¤šæ•°æ®. 1234567INSERT INTO download SELECT now() + number * 60 as when, 22, rand() % 100000000 FROM system.numbers LIMIT 5000 å¦‚æœæ‚¨ä»å®ä¾‹åŒ–è§†å›¾ä¸­è¿›è¡Œé€‰æ‹©, æ‚¨å°†çœ‹åˆ°å®ƒç°åœ¨å…·æœ‰ç”¨æˆ·ID 22å’Œ25çš„æ€»æ•°. è¯·æ³¨æ„, ä¸€æ—¦INSERTå®Œæˆ, å°†ç«‹å³å¡«å……æ–°æ•°æ®. è¿™æ˜¯ClickHouseå®ä¾‹åŒ–è§†å›¾çš„é‡è¦åŠŸèƒ½, è¿™ä½¿å…¶å¯¹äºå®æ—¶åˆ†æéå¸¸æœ‰ç”¨. ä¸‹é¢æ˜¯æŸ¥è¯¢å’Œæ–°ç»“æœ. 12345678910111213141516171819SELECT *FROM download_daily_mvORDER BY userid ASC, day ASCâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 22 â”‚ 416 â”‚ 21063519801 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 22 â”‚ 1440 â”‚ 71523929305 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 22 â”‚ 1440 â”‚ 70435459582 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 22 â”‚ 1440 â”‚ 70725673036 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 22 â”‚ 264 â”‚ 13826466067 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 1467 â”‚ 75441118166 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 144811386193 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 145138479865 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 2773 â”‚ 138488485955 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ä½œä¸ºç»ƒä¹ , æ‚¨å¯ä»¥å¯¹æºè¡¨è¿è¡ŒåŸå§‹æŸ¥è¯¢, ä»¥ç¡®è®¤å®ƒä¸ç‰©åŒ–è§†å›¾ä¸­çš„æ€»æ•°ç›¸åŒ¹é…. ä½œä¸ºæœ€åä¸€ä¸ªç¤ºä¾‹, è®©æˆ‘ä»¬ä½¿ç”¨ç‰©åŒ–è§†å›¾æŒ‰æœˆæ±‡æ€». åœ¨æœ¬ä¾‹ä¸­, æˆ‘ä»¬å°†ç‰©åŒ–è§†å›¾è§†ä¸ºä¸€ä¸ªæ™®é€šè¡¨, æŒ‰æœˆåˆ†ç»„, å¦‚ä¸‹æ‰€ç¤º. æˆ‘ä»¬æ·»åŠ äº†WITH TOTALSå­å¥, å®ƒæ‰“å°ä¸€ä¸ªæ–¹ä¾¿çš„èšåˆçš„æ€»å’Œ. 1234567891011121314151617181920212223SELECT toStartOfMonth(day) AS month, userid, sum(downloads), sum(bytes)FROM download_daily_mvGROUP BY userid, month WITH TOTALSORDER BY userid ASC, month ASCâ”Œâ”€â”€â”€â”€â”€â”€monthâ”€â”¬â”€useridâ”€â”¬â”€sum(downloads)â”€â”¬â”€â”€â”€sum(bytes)â”€â”â”‚ 2020-08-01 â”‚ 22 â”‚ 5000 â”‚ 247575047791 â”‚â”‚ 2020-08-01 â”‚ 25 â”‚ 10000 â”‚ 503879470179 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜Extremes:â”Œâ”€â”€â”€â”€â”€â”€monthâ”€â”¬â”€useridâ”€â”¬â”€sum(downloads)â”€â”¬â”€â”€â”€sum(bytes)â”€â”â”‚ 0000-00-00 â”‚ 0 â”‚ 15000 â”‚ 751454517970 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ä»å‰é¢çš„ç¤ºä¾‹ä¸­, æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°å®ä¾‹åŒ–è§†å›¾å¦‚ä½•æ­£ç¡®åœ°æ±‡æ€»æºæ•°æ®ä¸­çš„æ•°æ®(how the materialized view correctly summarizes data from the source data). å¦‚ä¸Šä¾‹æ‰€ç¤º, æˆ‘ä»¬ç”šè‡³å¯ä»¥â€œsummarize the summariesâ€. é‚£ä¹ˆå¹•ååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ ä¸‹å›¾è¯´æ˜äº†æ•°æ®çš„é€»è¾‘æµ. å¦‚å›¾æ‰€ç¤º, åŸè¡¨ä¸ŠINSERTçš„å€¼è¢«è½¬æ¢å¹¶åº”ç”¨äºéšè—çš„ç›®æ ‡è¡¨(.innerè¡¨). è¦å¡«å……è§†å›¾(To populate the view), æ‚¨è¦åšçš„å°±æ˜¯åœ¨æºè¡¨ä¸­æ’å…¥æ•°æ®. æ‚¨å¯ä»¥ä»éšè—çš„ç›®æ ‡è¡¨(.innerè¡¨)å’Œç‰©åŒ–è§†å›¾ä¸­è¿›è¡ŒæŸ¥è¯¢. å®é™…ä¸ŠClickHouseå°±æ˜¯å°†æŸ¥è¯¢è·¯ç”±åˆ°åˆ›å»ºç‰©åŒ–è§†å›¾æ—¶è‡ªåŠ¨åˆ›å»ºçš„internelè¡¨ä¸­çš„. å›¾ä¸­è¿˜æœ‰å¦å¤–ä¸€ä»¶é‡è¦çš„äº‹æƒ…éœ€è¦æ³¨æ„. ç‰©åŒ–è§†å›¾åˆ›å»ºä¸€ä¸ªå…·æœ‰ç‰¹æ®Šåç§°ç§æœ‰è¡¨æ¥ä¿å­˜æ•°æ®. å¦‚æœæ‚¨é€šè¿‡è¾“å…¥DROP TABLE download_daily_mvåˆ é™¤ç‰©åŒ–è§†å›¾, åˆ™ç§æœ‰è¡¨ä¹Ÿä¼šè¢«åˆ é™¤. å¦‚æœéœ€è¦æ›´æ”¹è§†å›¾, åˆ™éœ€è¦å°†å…¶åˆ é™¤å¹¶ä½¿ç”¨æ–°æ•°æ®é‡æ–°åˆ›å»º 12345678&gt;SHOW TABLES&gt;â”Œâ”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”&gt;â”‚ .inner.download_daily_mv â”‚&gt;â”‚ download â”‚&gt;â”‚ download_daily_mv â”‚&gt;â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ .inner.download_daily_mvå°±æ˜¯ internelè¡¨æˆ–å«ç§æœ‰è¡¨ Wrap-up - æ€»ç»“æˆ‘ä»¬åˆšåˆšå®¡é˜…çš„ç¤ºä¾‹ä½¿ç”¨SummingMergeTreeåˆ›å»ºä¸€ä¸ªè§†å›¾ä»¥ç´¯åŠ æ¯æ—¥ç”¨æˆ·ä¸‹è½½é‡. æˆ‘ä»¬ä»ç‰©åŒ–è§†å›¾å¯¹SELECTä½¿ç”¨äº†æ ‡å‡†SQLè¯­æ³•. è¿™æ˜¯SummingMergeTreeå¼•æ“çš„ç‰¹æ®ŠåŠŸèƒ½, ä»…é€‚ç”¨äºæ€»å’Œå’Œè®¡æ•°. å¯¹äºå…¶ä»–ç±»å‹çš„èšåˆ, æˆ‘ä»¬éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹æ³•. å¦å¤–, æˆ‘ä»¬çš„ç¤ºä¾‹ä½¿ç”¨POPULATEå…³é”®å­—å°†ç°æœ‰è¡¨æ•°æ®å‘å¸ƒåˆ°è§†å›¾åˆ›å»ºçš„ç§æœ‰ç›®æ ‡è¡¨(.innerè¡¨)ä¸­. å¦‚æœåœ¨å¡«å……è§†å›¾æ—¶åˆ°è¾¾æ–°çš„INSERTè¡Œ, ClickHouseå°†é”™è¿‡å®ƒä»¬. å½“æ‚¨æ˜¯å”¯ä¸€ä½¿ç”¨æ•°æ®é›†çš„äººæ—¶, æ­¤é™åˆ¶å¾ˆå®¹æ˜“è§£å†³, ä½†å¯¹äºä¸æ–­åŠ è½½æ•°æ®çš„ç”Ÿäº§ç³»ç»Ÿæ¥è¯´æ˜¯ä¸ªé—®é¢˜. æ­¤å¤–, åˆ é™¤è§†å›¾å, ä¸“ç”¨è¡¨ä¹Ÿä¼šæ¶ˆå¤±. è¿™ä½¿å¾—å¾ˆéš¾æ›´æ”¹è§†å›¾ä»¥é€‚åº”æºè¡¨ä¸­çš„æ¶æ„æ›´æ”¹. åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­, æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åˆ›å»ºç‰©åŒ–è§†å›¾æ¥è®¡ç®—å…¶ä»–ç±»å‹çš„èšåˆ, æ¯”å¦‚å¹³å‡å€¼æˆ–æœ€å¤§å€¼/æœ€å°å€¼. æˆ‘ä»¬è¿˜å°†å±•ç¤ºå¦‚ä½•æ˜¾å¼å®šä¹‰ç›®æ ‡è¡¨(.innerè¡¨), å¹¶ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„SQLè¯­å¥æ‰‹åŠ¨å°†æ•°æ®åŠ è½½åˆ°å…¶ä¸­. æˆ‘ä»¬è¿˜å°†ç®€è¦ä»‹ç»æ¨¡å¼è¿ç§»(schema migration). åŒæ—¶, æˆ‘ä»¬å¸Œæœ›æ‚¨å–œæ¬¢è¿™ä¸€ç®€è¦ä»‹ç», å¹¶å‘ç°ç¤ºä¾‹æœ‰ç”¨. å®æµ‹åŠé—®é¢˜åˆ é™¤åŸºè¡¨, ç‰©åŒ–è§†å›¾ä»ç„¶å¯ä»¥æŸ¥è¯¢è¿™æ˜¯ç¬¦åˆé¢„æœŸçš„, å› ä¸ºç‰©åŒ–è§†å›¾æ˜¯å­˜å‚¨äº†æ•°æ®çš„ 1234567891011121314151617181920212223242526272829303132333435363738394041bj2-all-clickhouse-test-02 :) drop table download;DROP TABLE downloadOk.0 rows in set. Elapsed: 0.016 sec. bj2-all-clickhouse-test-02 :) show tables;SHOW TABLESâ”Œâ”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ .inner.download_daily_mv â”‚â”‚ download_daily_mv â”‚â”‚ sbtest â”‚â”‚ sbtest_local â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜4 rows in set. Elapsed: 0.001 sec. bj2-all-clickhouse-test-02 :) select * from download_daily_mv;SELECT *FROM download_daily_mvâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 1467 â”‚ 75441118166 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 144811386193 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 145138479865 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 2773 â”‚ 138488485955 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 22 â”‚ 416 â”‚ 21063519801 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 22 â”‚ 1440 â”‚ 71523929305 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 22 â”‚ 1440 â”‚ 70435459582 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 22 â”‚ 1440 â”‚ 70725673036 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 22 â”‚ 264 â”‚ 13826466067 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜9 rows in set. Elapsed: 0.008 sec. æ•°æ®åœ¨åˆ†åŒºåˆå¹¶æ—¶èšåˆé‡æ–°åˆ›å»ºdownloadè¡¨å’Œç‰©åŒ–è§†å›¾ 12345678910111213141516171819202122232425262728293031323334SELECT toStartOfDay(when) AS day, userid, count() AS downloads, sum(bytes) AS bytesFROM downloadGROUP BY userid, dayORDER BY userid ASC, day ASCâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 387 â”‚ 19855551536 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73316885071 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 72322018002 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 71675677053 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 25 â”‚ 293 â”‚ 14125612942 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜SELECT *FROM download_daily_mvâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 387 â”‚ 19855551536 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73316885071 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 72322018002 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 71675677053 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 25 â”‚ 293 â”‚ 14125612942 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å†æ¬¡å‘åŸºè¡¨ä¸­æ’å…¥æ•°æ®, ç„¶åæŸ¥çœ‹ç‰©åŒ–è§†å›¾ä¸­çš„æ•°æ® 1234567891011121314151617181920212223242526INSERT INTO download SELECT now() + (number * 60) AS when, 25, rand() % 100000000FROM system.numbersLIMIT 5000SELECT *FROM download_daily_mvâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 387 â”‚ 19855551536 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73316885071 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 72322018002 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 71675677053 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 25 â”‚ 293 â”‚ 14125612942 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 385 â”‚ 18771807859 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 73675739078 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 70555293899 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 1440 â”‚ 70773685728 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 25 â”‚ 295 â”‚ 14750186600 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ å¯ä»¥çœ‹åˆ°ç‰©åŒ–è§†å›¾ä¸­çš„æ•°æ®å¹¶æ²¡æœ‰â€å…¨éƒ¨èšåˆå®Œæ•´â€ æŸ¥çœ‹ç‰©åŒ–è§†å›¾privateè¡¨åˆ†åŒºæƒ…å†µ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879bj2-all-clickhouse-test-02 :) select * from system.parts where table=&#x27;.inner.download_daily_mv&#x27;\\GSELECT *FROM system.partsWHERE table = &#x27;.inner.download_daily_mv&#x27;Row 1:â”€â”€â”€â”€â”€â”€partition: 202008name: 202008_1_1_0part_type: Wideactive: 1marks: 2rows: 5bytes_on_disk: 421data_compressed_bytes: 200data_uncompressed_bytes: 120marks_bytes: 192modification_time: 2020-08-18 17:33:51remove_time: 0000-00-00 00:00:00refcount: 1min_date: 0000-00-00max_date: 0000-00-00min_time: 2020-08-18 00:00:00max_time: 2020-08-22 00:00:00partition_id: 202008min_block_number: 1max_block_number: 1level: 0data_version: 1primary_key_bytes_in_memory: 16primary_key_bytes_in_memory_allocated: 8192is_frozen: 0database: duyalantable: .inner.download_daily_mvengine: SummingMergeTreedisk_name: defaultpath: /data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_1_1_0/hash_of_all_files: f4b55a88dac393d25ffe1c703cca4f6dhash_of_uncompressed_files: 58a4ab29ef36c22884ee7accd528b590uncompressed_hash_of_compressed_files: e18b006f608580db132ed90adb46902fRow 2:â”€â”€â”€â”€â”€â”€partition: 202008name: 202008_2_2_0part_type: Wideactive: 1marks: 2rows: 5bytes_on_disk: 421data_compressed_bytes: 200data_uncompressed_bytes: 120marks_bytes: 192modification_time: 2020-08-18 17:35:13remove_time: 0000-00-00 00:00:00refcount: 1min_date: 0000-00-00max_date: 0000-00-00min_time: 2020-08-18 00:00:00max_time: 2020-08-22 00:00:00partition_id: 202008min_block_number: 2max_block_number: 2level: 0data_version: 2primary_key_bytes_in_memory: 16primary_key_bytes_in_memory_allocated: 8192is_frozen: 0database: duyalantable: .inner.download_daily_mvengine: SummingMergeTreedisk_name: defaultpath: /data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_2_2_0/hash_of_all_files: 049d090ea65c24be8544ab86846ea9fahash_of_uncompressed_files: 58a4ab29ef36c22884ee7accd528b590uncompressed_hash_of_compressed_files: 9ffea93e6b9bc375c7f04374b4a4a6a92 rows in set. Elapsed: 0.002 sec. å¯ä»¥çœ‹åˆ°, æœ‰ä¸¤ä¸ªactiveåˆ†åŒº202008_1_1_0, 202008_2_2_0 æˆ‘ä»¬æ‰‹åŠ¨OPTIMIZEå°è¯•åˆå¹¶åˆ†åŒº 1234567bj2-all-clickhouse-test-02 :) optimize table download_daily_mv;OPTIMIZE TABLE download_daily_mvOk.0 rows in set. Elapsed: 0.004 sec. å†æ¬¡æŸ¥è¯¢ç‰©åŒ–è§†å›¾æ•°æ® 123456789101112131415bj2-all-clickhouse-test-02 :) select * from download_daily_mv;SELECT *FROM download_daily_mvâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€dayâ”€â”¬â”€useridâ”€â”¬â”€downloadsâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€bytesâ”€â”â”‚ 2020-08-18 00:00:00 â”‚ 25 â”‚ 772 â”‚ 38627359395 â”‚â”‚ 2020-08-19 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 146992624149 â”‚â”‚ 2020-08-20 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 142877311901 â”‚â”‚ 2020-08-21 00:00:00 â”‚ 25 â”‚ 2880 â”‚ 142449362781 â”‚â”‚ 2020-08-22 00:00:00 â”‚ 25 â”‚ 588 â”‚ 28875799542 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜5 rows in set. Elapsed: 0.001 sec. æŸ¥çœ‹privateè¡¨åˆ†åŒºæƒ…å†µ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115bj2-all-clickhouse-test-02 :) select * from system.parts where table=&#x27;.inner.download_daily_mv&#x27;\\GSELECT *FROM system.partsWHERE table = &#x27;.inner.download_daily_mv&#x27;Row 1:â”€â”€â”€â”€â”€â”€partition: 202008name: 202008_1_1_0part_type: Wideactive: 0marks: 2rows: 5bytes_on_disk: 421data_compressed_bytes: 200data_uncompressed_bytes: 120marks_bytes: 192modification_time: 2020-08-18 17:33:51remove_time: 2020-08-18 17:38:24refcount: 1min_date: 0000-00-00max_date: 0000-00-00min_time: 2020-08-18 00:00:00max_time: 2020-08-22 00:00:00partition_id: 202008min_block_number: 1max_block_number: 1level: 0data_version: 1primary_key_bytes_in_memory: 16primary_key_bytes_in_memory_allocated: 8192is_frozen: 0database: duyalantable: .inner.download_daily_mvengine: SummingMergeTreedisk_name: defaultpath: /data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_1_1_0/hash_of_all_files: f4b55a88dac393d25ffe1c703cca4f6dhash_of_uncompressed_files: 58a4ab29ef36c22884ee7accd528b590uncompressed_hash_of_compressed_files: e18b006f608580db132ed90adb46902fRow 2:â”€â”€â”€â”€â”€â”€partition: 202008name: 202008_1_2_1part_type: Wideactive: 1marks: 2rows: 5bytes_on_disk: 421data_compressed_bytes: 200data_uncompressed_bytes: 120marks_bytes: 192modification_time: 2020-08-18 17:38:24remove_time: 0000-00-00 00:00:00refcount: 1min_date: 0000-00-00max_date: 0000-00-00min_time: 2020-08-18 00:00:00max_time: 2020-08-22 00:00:00partition_id: 202008min_block_number: 1max_block_number: 2level: 1data_version: 1primary_key_bytes_in_memory: 16primary_key_bytes_in_memory_allocated: 8192is_frozen: 0database: duyalantable: .inner.download_daily_mvengine: SummingMergeTreedisk_name: defaultpath: /data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_1_2_1/hash_of_all_files: fdc534a9b9aa0904cde863ee1deff532hash_of_uncompressed_files: 58a4ab29ef36c22884ee7accd528b590uncompressed_hash_of_compressed_files: df972eeaad3304d9a16bfa8cb46861ceRow 3:â”€â”€â”€â”€â”€â”€partition: 202008name: 202008_2_2_0part_type: Wideactive: 0marks: 2rows: 5bytes_on_disk: 421data_compressed_bytes: 200data_uncompressed_bytes: 120marks_bytes: 192modification_time: 2020-08-18 17:35:13remove_time: 2020-08-18 17:38:24refcount: 1min_date: 0000-00-00max_date: 0000-00-00min_time: 2020-08-18 00:00:00max_time: 2020-08-22 00:00:00partition_id: 202008min_block_number: 2max_block_number: 2level: 0data_version: 2primary_key_bytes_in_memory: 16primary_key_bytes_in_memory_allocated: 8192is_frozen: 0database: duyalantable: .inner.download_daily_mvengine: SummingMergeTreedisk_name: defaultpath: /data/clickhouse/node2/data/duyalan/%2Einner%2Edownload_daily_mv/202008_2_2_0/hash_of_all_files: 049d090ea65c24be8544ab86846ea9fahash_of_uncompressed_files: 58a4ab29ef36c22884ee7accd528b590uncompressed_hash_of_compressed_files: 9ffea93e6b9bc375c7f04374b4a4a6a93 rows in set. Elapsed: 0.002 sec. å¯ä»¥çœ‹åˆ°åªæœ‰ä¸€ä¸ªactiveåˆ†åŒºäº†202008_1_2_1 æ‰€ä»¥å¯¹äºæœ¬ä¾‹ä¸­çš„ç‰©åŒ–è§†å›¾, åœ¨æŸ¥è¯¢æ˜¯ä»ç„¶åº”è¯¥ä½¿ç”¨èšåˆå‡½æ•°èšåˆæ•°æ® 123456789SELECT day, userid, sum(downloads), sum(bytes)FROM download_no_populate_daily_mvGROUP BY day, userid","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"},{"name":"ç‰©åŒ–è§†å›¾","slug":"ç‰©åŒ–è§†å›¾","permalink":"http://fuxkdb.com/tags/%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE/"}]},{"title":"ä¸ºä»€ä¹ˆpt-oscå’Œgh-oscåœ¨æ‹·è´æºè¡¨æ•°æ®æ—¶è¦ä½¿ç”¨insert IGNORE into select lock in share mode","slug":"2020-08-23-ä¸ºä»€ä¹ˆpt-oscå’Œgh-oscåœ¨æ‹·è´æºè¡¨æ•°æ®æ—¶è¦ä½¿ç”¨insert-IGNORE-into-select-lock-in-share-mode","date":"2020-08-23T10:58:00.000Z","updated":"2020-09-06T08:46:55.930Z","comments":true,"path":"2020/08/23/2020-08-23-ä¸ºä»€ä¹ˆpt-oscå’Œgh-oscåœ¨æ‹·è´æºè¡¨æ•°æ®æ—¶è¦ä½¿ç”¨insert-IGNORE-into-select-lock-in-share-mode/","link":"","permalink":"http://fuxkdb.com/2020/08/23/2020-08-23-%E4%B8%BA%E4%BB%80%E4%B9%88pt-osc%E5%92%8Cgh-osc%E5%9C%A8%E6%8B%B7%E8%B4%9D%E6%BA%90%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%97%B6%E8%A6%81%E4%BD%BF%E7%94%A8insert-IGNORE-into-select-lock-in-share-mode/","excerpt":"insert IGNORE into select lock in share mode çš„ä½œç”¨pt-oscå’Œgh-oscåœ¨æ‹·è´æ—§æ•°æ®æ—¶é€»è¾‘æ˜¯ä¸€æ ·çš„, éƒ½æ˜¯ç”¨insert ignore into å½±å­è¡¨ select * from åŸè¡¨force index (PRIMARY) where chunkèŒƒå›´ lock in share mode","text":"insert IGNORE into select lock in share mode çš„ä½œç”¨pt-oscå’Œgh-oscåœ¨æ‹·è´æ—§æ•°æ®æ—¶é€»è¾‘æ˜¯ä¸€æ ·çš„, éƒ½æ˜¯ç”¨insert ignore into å½±å­è¡¨ select * from åŸè¡¨force index (PRIMARY) where chunkèŒƒå›´ lock in share mode1234567pt-oscINSERT LOW_PRIORITY IGNORE INTO `sysbench`.`_sbtest1_new` (`id`, `k`, `c`, `pad`, `snum`) SELECT `id`, `k`, `c`, `pad`, `snum` FROM `sysbench`.`sbtest1` FORCE INDEX(`PRIMARY`) WHERE ((`id` &gt;= &#x27;98802&#x27;)) AND ((`id` &lt;= &#x27;98901&#x27;)) LOCK IN SHARE MODE /*pt-online-schema-change 6012 copy nibble*/gh-ostinsert /* gh-ost `sysbench`.`sbtest1` */ ignore into `sysbench`.`_sbtest1_gho` (`id`, `k`, `c`, `pad`, `snum`) (select `id`, `k`, `c`, `pad`, `snum` from `sysbench`.`sbtest1` force index (`PRIMARY`) where (((`id` &gt; _binary&#x27;419601&#x27;)) and ((`id` &lt; _binary&#x27;419701&#x27;) or ((`id` = _binary&#x27;419701&#x27;)))) lock in share mode ä¸ºä»€ä¹ˆéœ€è¦lock in share mode ?å‡è®¾ä¿®æ”¹è¡¨t1, t1æœ‰ä¸¤åˆ— id, sname, idä¸ºä¸»é”®, æ•°æ®å¦‚ä¸‹ 12345678id,sname1,&#x27;foo&#x27;10,&#x27;foo&#x27;20,&#x27;foo&#x27;30,&#x27;foo&#x27;40,&#x27;foo&#x27;...1000ä¸‡,&#x27;foo&#x27; å¼€å§‹æ”¹è¡¨, éœ€è¦æ‹·è´åŸå§‹æ•°æ®æ‹·è´åŸè¡¨æ•°æ®è¯­å¥A: 1insert IGNORE into _t1_å½±å­ select * from t1 where id&gt;1 and id&lt;100ä¸‡; æˆ‘ä»¬è¿™ä¸ªinsertæ­£åœ¨æ‰§è¡Œ,ä¸”æ‰§è¡Œçš„å¾ˆæ…¢, æ€»æ˜¯å°±æ˜¯æ”¾å¤§å®ƒçš„æ‰§è¡Œæ—¶é—´. æ­¤æ—¶å¦ä¸€ä¸ªä¼šè¯æ‰§è¡Œä¸‹é¢çš„è¯­å¥B 123insert into t1 values(11,&#x27;foo&#x27;);update t1 set sname=&#x27;hehe&#x27; where id=20;delete from t1 where id=30; å¦‚æœæ˜¯pt-osc ,èµ°è§¦å‘å™¨, è¿™äº›è¯­å¥ä¼šåº”ç”¨åˆ°å½±å­è¡¨ pt-osc ä¸‰ä¸ªè§¦å‘å™¨ 12345&gt;CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest1_del` AFTER DELETE ON `sysbench`.`sbtest1` FOR EACH ROW DELETE IGNORE FROM `sysbench`.`_sbtest1_new` WHERE `sysbench`.`_sbtest1_new`.`id` &lt;=&gt; OLD.`id`&gt;CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest1_upd` AFTER UPDATE ON `sysbench`.`sbtest1` FOR EACH ROW BEGIN DELETE IGNORE FROM `sysbench`.`_sbtest1_new` WHERE !(OLD.`id` &lt;=&gt; NEW.`id`) AND `sysbench`.`_sbtest1_new`.`id` &lt;=&gt; OLD.`id`;REPLACE INTO `sysbench`.`_sbtest1_new` (`id`, `k`, `c`, `pad`, `snum`) VALUES (NEW.`id`, NEW.`k`, NEW.`c`, NEW.`pad`, NEW.`snum`);END&gt;CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest1_del` AFTER DELETE ON `sysbench`.`sbtest1` FOR EACH ROW DELETE IGNORE FROM `sysbench`.`_sbtest1_new` WHERE `sysbench`.`_sbtest1_new`.`id` &lt;=&gt; OLD.`id` 123REPLACE INTO _t1_å½±å­ values(11,&#x27;foo&#x27;);REPLACE INTO _t1_å½±å­ values(20,&#x27;hehe&#x27;); (å¦‚æœæ›´æ–°äº†ä¸»é”®å€¼, åˆ™ä¼šdelete where id=åŸä¸»é”®å€¼, replace into æ–°ä¸»é”®å€¼)DELETE IGNORE FROM _t1_å½±å­ where id=30; æ­¤æ—¶å½±å­è¡¨ä¼šæœ‰å¦‚ä¸‹æ•°æ® 1211,&#x27;foo&#x27;20,&#x27;hehe&#x27; ä¹‹åæ‹·è´åŸè¡¨æ•°æ®è¯­å¥Aæ‰§è¡Œå®Œæ¯•, å½±å­è¡¨æ•°æ®å¦‚ä¸‹ 123456781,&#x27;foo&#x27;10,&#x27;foo&#x27;11,&#x27;foo&#x27; --20,&#x27;hehe&#x27; --30,&#x27;foo&#x27; --30åˆå›æ¥äº†40,&#x27;foo&#x27;...100,&#x27;foo&#x27; è¢«åˆ é™¤çš„id=30åˆä¼šè¢«æ’å…¥è¿›æ¥ æ‰€ä»¥æ•°æ®å°±å‡ºç°äº†é—®é¢˜, æ‰€ä»¥éœ€è¦insert IGNORE into select lock in share mode, è¿™æ ·è¯­å¥Bå°±ä¼šè¢«é˜»å¡ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆpt-oscå¯¹updateä¸èƒ½åƒgh-ostä¸€æ ·ä½¿ç”¨update, è€Œæ˜¯éœ€è¦replace intoæ•°æ®è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦lock in share mode å¦‚æœæ˜¯gh-ost, èµ°binlog, gh-ostè§£æbinlogåº”ç”¨åˆ°å½±å­è¡¨ https://github.com/github/gh-ost/blob/e48844de0bee9a8db611a06cd6080cac4dab25cb/go/sql/builder.goinsertå°±æ˜¯replace intoupdateè¿˜æ˜¯update (å¦‚æœæ›´æ–°äº†ä¸»é”®å€¼, åˆ™ä¼šdelete where id=åŸä¸»é”®å€¼, replace into æ–°ä¸»é”®å€¼)deleteè¿˜æ˜¯delete 123REPLACE INTO _t1_å½±å­ values(11,&#x27;foo&#x27;);update _t1_å½±å­ set sname=&#x27;hehe&#x27; where id=20; --æ›´æ–°ä¸åˆ°delete from _t1_å½±å­ where id=30; --åˆ é™¤ä¸åˆ° æ­¤æ—¶å½±å­è¡¨ä¼šæœ‰å¦‚ä¸‹æ•°æ® 111,&#x27;foo&#x27; ä¹‹åæ‹·è´åŸè¡¨æ•°æ®è¯­å¥Aæ‰§è¡Œå®Œæ¯•, å½±å­è¡¨æ•°æ®å¦‚ä¸‹ 123456781,&#x27;foo&#x27;10,&#x27;foo&#x27;11, &#x27;foo&#x27;20,&#x27;foo&#x27; --æ›´æ–°ä¸¢äº†30,&#x27;foo&#x27; --åˆ é™¤ä¹Ÿä¸¢äº†40,&#x27;foo&#x27;...100,&#x27;foo&#x27; æ•°æ®è¿˜æ˜¯æœ‰é—®é¢˜, æ‰€ä»¥éœ€è¦lock in share mode","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"gh-ost","slug":"gh-ost","permalink":"http://fuxkdb.com/tags/gh-ost/"},{"name":"pt-osc","slug":"pt-osc","permalink":"http://fuxkdb.com/tags/pt-osc/"}]},{"title":"ProxySQLå‡çº§æ—¶å¯¹é»˜è®¤éƒ¨ç½²çš„å®ä¾‹çš„å½±å“","slug":"2020-08-23-ProxySQLå‡çº§æ—¶å¯¹é»˜è®¤éƒ¨ç½²çš„å®ä¾‹çš„å½±å“","date":"2020-08-23T10:54:00.000Z","updated":"2020-08-23T10:55:07.570Z","comments":true,"path":"2020/08/23/2020-08-23-ProxySQLå‡çº§æ—¶å¯¹é»˜è®¤éƒ¨ç½²çš„å®ä¾‹çš„å½±å“/","link":"","permalink":"http://fuxkdb.com/2020/08/23/2020-08-23-ProxySQL%E5%8D%87%E7%BA%A7%E6%97%B6%E5%AF%B9%E9%BB%98%E8%AE%A4%E9%83%A8%E7%BD%B2%E7%9A%84%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%BD%B1%E5%93%8D/","excerpt":"å…¬å¸æœ‰ä½¿ç”¨é»˜è®¤å®‰è£…ç›®å½•çš„ProxySQLè·‘ä¸šåŠ¡. åœ¨å‡çº§2.0.8 è‡³ 2.0.12çš„æ—¶å€™å‘ç°å¸è½½2.0.8åè¿™äº›ä½¿ç”¨é»˜è®¤æ–¹å¼å®‰è£…çš„ProxySQLå®ä¾‹å°±ä¼šè¢«å…³é—­. åŸå› æ˜¯rpmåŒ…å®‰è£…å’Œå¸è½½å‰åæ‰§è¡Œäº†ä¸€äº›åŠ¨ä½œ 123456789101112131415161718192021222324252627282930313233343536373839404142[root@bj1-mysql-manager-prod-01 tmp]# rpm --scripts -qp /tmp/proxysql-2.0.8-1-centos7.x86_64.rpm preinstall scriptlet (using /bin/sh):# Cleanup artifactsif [ -f /var/lib/proxysql/PROXYSQL_UPGRADE ]; then rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfipostinstall scriptlet (using /bin/sh):# Create relevant user, directories and configuration filesif [ ! -d /var/run/proxysql ]; then /bin/mkdir /var/run/proxysql ; fiif [ ! -d /var/lib/proxysql ]; then /bin/mkdir /var/lib/proxysql ; fiif ! id -u proxysql &gt; /dev/null 2&gt;&amp;1; then useradd -r -U -s /bin/false -d /var/lib/proxysql -c &quot;ProxySQL Server&quot; proxysql; fi/bin/chown -R proxysql: /var/lib/proxysql /var/run/proxysql/bin/chown root:proxysql /etc/proxysql.cnf/bin/chmod 640 /etc/proxysql.cnf# Configure systemd appropriately./bin/systemctl daemon-reload/bin/systemctl enable proxysql.service# Notify that a package update is in progress in order to start service.if [ $1 -eq 2 ]; then /bin/touch /var/lib/proxysql/PROXYSQL_UPGRADE ; fipreuninstall scriptlet (using /bin/sh):# When uninstalling always try stop the service, ignore failures/bin/systemctl stop proxysql || truepostuninstall scriptlet (using /bin/sh):if [ $1 -eq 0 ]; then # This is a pure uninstall, systemd unit file removed # only daemon-reload is needed. /bin/systemctl daemon-reloadelse # This is an upgrade, ProxySQL should be started. This # logic works for packages newer than 2.0.7 and ensures # a faster restart time. /bin/systemctl start proxysql.service /bin/rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfiposttrans scriptlet (using /bin/sh):if [ -f /var/lib/proxysql/PROXYSQL_UPGRADE ]; then # This is a safeguard to start the service after an update # which supports legacy &quot;preun&quot; / &quot;postun&quot; logic and will # only execute for packages before 2.0.7. /bin/systemctl start proxysql.service /bin/rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfi","text":"å…¬å¸æœ‰ä½¿ç”¨é»˜è®¤å®‰è£…ç›®å½•çš„ProxySQLè·‘ä¸šåŠ¡. åœ¨å‡çº§2.0.8 è‡³ 2.0.12çš„æ—¶å€™å‘ç°å¸è½½2.0.8åè¿™äº›ä½¿ç”¨é»˜è®¤æ–¹å¼å®‰è£…çš„ProxySQLå®ä¾‹å°±ä¼šè¢«å…³é—­. åŸå› æ˜¯rpmåŒ…å®‰è£…å’Œå¸è½½å‰åæ‰§è¡Œäº†ä¸€äº›åŠ¨ä½œ 123456789101112131415161718192021222324252627282930313233343536373839404142[root@bj1-mysql-manager-prod-01 tmp]# rpm --scripts -qp /tmp/proxysql-2.0.8-1-centos7.x86_64.rpm preinstall scriptlet (using /bin/sh):# Cleanup artifactsif [ -f /var/lib/proxysql/PROXYSQL_UPGRADE ]; then rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfipostinstall scriptlet (using /bin/sh):# Create relevant user, directories and configuration filesif [ ! -d /var/run/proxysql ]; then /bin/mkdir /var/run/proxysql ; fiif [ ! -d /var/lib/proxysql ]; then /bin/mkdir /var/lib/proxysql ; fiif ! id -u proxysql &gt; /dev/null 2&gt;&amp;1; then useradd -r -U -s /bin/false -d /var/lib/proxysql -c &quot;ProxySQL Server&quot; proxysql; fi/bin/chown -R proxysql: /var/lib/proxysql /var/run/proxysql/bin/chown root:proxysql /etc/proxysql.cnf/bin/chmod 640 /etc/proxysql.cnf# Configure systemd appropriately./bin/systemctl daemon-reload/bin/systemctl enable proxysql.service# Notify that a package update is in progress in order to start service.if [ $1 -eq 2 ]; then /bin/touch /var/lib/proxysql/PROXYSQL_UPGRADE ; fipreuninstall scriptlet (using /bin/sh):# When uninstalling always try stop the service, ignore failures/bin/systemctl stop proxysql || truepostuninstall scriptlet (using /bin/sh):if [ $1 -eq 0 ]; then # This is a pure uninstall, systemd unit file removed # only daemon-reload is needed. /bin/systemctl daemon-reloadelse # This is an upgrade, ProxySQL should be started. This # logic works for packages newer than 2.0.7 and ensures # a faster restart time. /bin/systemctl start proxysql.service /bin/rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfiposttrans scriptlet (using /bin/sh):if [ -f /var/lib/proxysql/PROXYSQL_UPGRADE ]; then # This is a safeguard to start the service after an update # which supports legacy &quot;preun&quot; / &quot;postun&quot; logic and will # only execute for packages before 2.0.7. /bin/systemctl start proxysql.service /bin/rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfi å®‰è£…preinstall 123if [ -f /var/lib/proxysql/PROXYSQL_UPGRADE ]; then rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfi è¿™å°±æ˜¯çœ‹å¦‚æœæœ‰PROXYSQL_UPGRADEè¿™ä¸ªæ–‡ä»¶å°±åˆ é™¤æ‰,è¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯rpm -Uvhå‡çº§æ—¶ä¼šç”¨åˆ° postinstall 123456789101112# Create relevant user, directories and configuration filesif [ ! -d /var/run/proxysql ]; then /bin/mkdir /var/run/proxysql ; fiif [ ! -d /var/lib/proxysql ]; then /bin/mkdir /var/lib/proxysql ; fiif ! id -u proxysql &gt; /dev/null 2&gt;&amp;1; then useradd -r -U -s /bin/false -d /var/lib/proxysql -c &quot;ProxySQL Server&quot; proxysql; fi/bin/chown -R proxysql: /var/lib/proxysql /var/run/proxysql/bin/chown root:proxysql /etc/proxysql.cnf/bin/chmod 640 /etc/proxysql.cnf# Configure systemd appropriately./bin/systemctl daemon-reload/bin/systemctl enable proxysql.service# Notify that a package update is in progress in order to start service.if [ $1 -eq 2 ]; then /bin/touch /var/lib/proxysql/PROXYSQL_UPGRADE ; fi åˆ›å»ºç›®å½•, åˆ›å»ºç”¨æˆ·, è®¾ç½®å¼€æœºå¯åŠ¨proxysql.service. è¿™é‡Œä¸»è¦å°±æ˜¯ä¸€ç‚¹, ç”¨systemdç®¡ç†rpmåŒ…å®‰è£…çš„proxysql å¸è½½preuninstall 12# When uninstalling always try stop the service, ignore failures/bin/systemctl stop proxysql || true è¿™é‡Œå°±æ˜¯æŠŠrpmåŒ…å®‰è£…çš„proxysqlå®ä¾‹ç»™å…³äº†. æ‰€æœ‰å¦‚æœç”¨é»˜è®¤æ–¹å¼å®‰è£…çš„ProxySQLå®ä¾‹, å¸è½½rpmåŒ…çš„æ—¶å€™è¿™ä¸ªå®ä¾‹å°±ä¼šè¢«å…³é—­, æ‰€ä»¥ä¸å»ºè®®ç”¨è¿™ä¸ªå®ä¾‹, åº”è¯¥è‡ªå·±åˆ›å»º, å¹¶ä¸”å»ºè®®æŠŠrpmåŒ…ç”Ÿæˆçš„é…ç½®æ–‡ä»¶, systemdéƒ½mvæ”¹å, å¦åˆ™æœºå™¨é‡å¯é»˜è®¤å®ä¾‹å¯åŠ¨ä¼šå ç”¨6032,6033ç«¯å£ preuninstall 1234567891011121314preuninstall scriptlet (using /bin/sh):postuninstall scriptlet (using /bin/sh):if [ $1 -eq 0 ]; then # This is a pure uninstall, systemd unit file removed # only daemon-reload is needed. /bin/systemctl daemon-reloadelse # This is an upgrade, ProxySQL should be started. This # logic works for packages newer than 2.0.7 and ensures # a faster restart time. /bin/systemctl start proxysql.service /bin/rm -fr /var/lib/proxysql/PROXYSQL_UPGRADEfi è¿™é‡Œ$1æˆ‘ä¸çŸ¥é“å’‹å–çš„, æ€»ä¹‹å°±æ˜¯å¦‚æœæ˜¯å†™åœ¨å°±åˆ äº†proxysql.serviceæ–‡ä»¶åsystemctl daemon-reload å¦å¤–ï¼Œä¸ºæä¾›æ“ä½œä¸­å¯å‚è€ƒçš„ä¿¡æ¯ï¼Œrpmè¿˜æä¾›äº†ä¸€ç§ä¿¡å·æœºåˆ¶ï¼šä¸åŒçš„æ“ä½œä¼šè¿”å›ä¸åŒçš„ä¿¡æ¯ï¼Œå¹¶æ”¾åˆ°é»˜è®¤å˜é‡$1ä¸­ã€‚ 0ä»£è¡¨å¸è½½ã€1ä»£è¡¨å®‰è£…ã€2ä»£è¡¨å‡çº§ å¦‚æœæ˜¯å‡çº§åˆ™ä¼šå†å¯åŠ¨ å¯ä»¥ä½¿ç”¨rpm -Uvhå‡çº§å—?ansible yumå¯ä»¥å®Œæˆå‡çº§å·¥ä½œ, ä½†ä¸è¦ä½¿ç”¨ansible yumå‡çº§, ä½¿ç”¨æ­¤æ–¹å¼å‡çº§2.0.8 - 2.0.12ä¼šè‡ªåŠ¨å®‰è£…å¹¶å¯åŠ¨ä¸€ä¸ªproxysql12proxysql 125223 1 0 21:17 ? 00:00:00 /usr/bin/proxysql --idle-threads -c /etc/proxysql.cnfproxysql 125225 125223 0 21:17 ? 00:00:00 /usr/bin/proxysql --idle-threads -c /etc/proxysql.cnf è¿™ä¸ªproxysqlä¼šå ç”¨6032 å’Œ 6033 ç«¯å£. è¿™ç§æ–¹å¼å®é™…ä¸Šåº”è¯¥æ˜¯ä½¿ç”¨rpm -Uvhå®Œæˆçš„å‡çº§, æˆ‘æ‰‹åŠ¨ä½¿ç”¨rpm -Uvhå‡çº§æ•ˆæœå’Œansible yumæ˜¯ä¸€è‡´çš„ åº”è¯¥é€šè¿‡shell rpm -e 2.0.8 å†rpm -ivh 2.0.12è¿›è¡Œå‡çº§, è¿™ç§æ–¹å¼ä¸å½±å“(å½±å“rpmé»˜è®¤å®‰è£…çš„proxysqlå®ä¾‹,å› ä¸ºä¼šå…³é—­)å·²ç»è¿è¡Œçš„proxysqlè¿›ç¨‹ (æ–‡ä»¶å¥æŸ„æ²¡æœ‰é‡Šæ”¾)1234567[root@centos-1 data]# lsof | grep delete| grep proxysqlproxysql 118312 root txt REG 253,0 36156384 101426928 /usr/bin/proxysql (deleted)proxysql 118313 root txt REG 253,0 36156384 101426928 /usr/bin/proxysql (deleted)proxysql 118313 118315 root txt REG 253,0 36156384 101426928 /usr/bin/proxysql (deleted)proxysql 118313 118316 root txt REG 253,0 36156384 101426928 /usr/bin/proxysql (deleted)proxysql 118313 118317 root txt REG 253,0 36156384 101426928 /usr/bin/proxysql (deleted)proxysql 118313 118318 root txt REG 253,0 36156384 101426928 /usr/bin/proxysql (deleted)å¦å¤–å‡çº§åè¯·123mv /etc/proxysql.cnf /etc/proxysql.cnf.bakmv /etc/systemd/system/proxysql.service /etc/systemd/system/proxysql.service.bakmv /etc/systemd/system/proxysql-initial.service /etc/systemd/system/proxysql-initial.service.bakç›®å‰ä¸Šæµ·çš„proxysqlæˆ‘éƒ½æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼å‡çº§ ç»“è®ºæ£€æŸ¥æ˜¯å¦æœ‰rpmé»˜è®¤å®‰è£…çš„proxysqlå®ä¾‹, å¦‚æœæœ‰, è¯·å…ˆå‡çº§è¿™ä¸ªproxysqlå®ä¾‹!","categories":[],"tags":[{"name":"ProxySQL","slug":"ProxySQL","permalink":"http://fuxkdb.com/tags/ProxySQL/"},{"name":"å‡çº§","slug":"å‡çº§","permalink":"http://fuxkdb.com/tags/%E5%8D%87%E7%BA%A7/"}]},{"title":"MySQLåŠ¨æ€è¡Œè½¬åˆ—","slug":"2020-08-23-MySQLåŠ¨æ€è¡Œè½¬åˆ—","date":"2020-08-23T10:51:00.000Z","updated":"2020-08-23T10:51:27.868Z","comments":true,"path":"2020/08/23/2020-08-23-MySQLåŠ¨æ€è¡Œè½¬åˆ—/","link":"","permalink":"http://fuxkdb.com/2020/08/23/2020-08-23-MySQL%E5%8A%A8%E6%80%81%E8%A1%8C%E8%BD%AC%E5%88%97/","excerpt":"é€šè¿‡maxè¡Œè½¬åˆ—ä¸æ˜¯åŠ¨æ€çš„, ä½ è¿˜æ˜¯è¦çŸ¥é“æ‰€æœ‰åˆ—åæ‰å¯ä»¥12345678910111213141516171819root@localhost 17:46:56 [fanboshi]&gt; select * from t3;+----+---------+------+-----------+| id | title | env | progress |+----+---------+------+-----------+| 1 | å·¥å•1 | 1 | å®Œæˆ || 2 | å·¥å•1 | 2 | å®Œæˆ || 3 | å·¥å•1 | 3 | å¾…å®¡æ ¸ || 4 | å·¥å•2 | 1 | å¾…å®¡æ ¸ |+----+---------+------+-----------+4 rows in set (0.00 sec)root@localhost 17:48:20 [fanboshi]&gt; select title,max(if(env=1,progress,-1)) &#x27;RC&#x27;,max(if(env=2,progress,-1)) &#x27;Stage&#x27;,max(if(env=3,progress,-1)) &#x27;Prod&#x27; from t3 group by title;+---------+-----------+--------+-----------+| title | RC | Stage | Prod |+---------+-----------+--------+-----------+| å·¥å•1 | å®Œæˆ | å®Œæˆ | å¾…å®¡æ ¸ || å·¥å•2 | å¾…å®¡æ ¸ | -1 | -1 |+---------+-----------+--------+-----------+2 rows in set (0.00 sec)","text":"é€šè¿‡maxè¡Œè½¬åˆ—ä¸æ˜¯åŠ¨æ€çš„, ä½ è¿˜æ˜¯è¦çŸ¥é“æ‰€æœ‰åˆ—åæ‰å¯ä»¥12345678910111213141516171819root@localhost 17:46:56 [fanboshi]&gt; select * from t3;+----+---------+------+-----------+| id | title | env | progress |+----+---------+------+-----------+| 1 | å·¥å•1 | 1 | å®Œæˆ || 2 | å·¥å•1 | 2 | å®Œæˆ || 3 | å·¥å•1 | 3 | å¾…å®¡æ ¸ || 4 | å·¥å•2 | 1 | å¾…å®¡æ ¸ |+----+---------+------+-----------+4 rows in set (0.00 sec)root@localhost 17:48:20 [fanboshi]&gt; select title,max(if(env=1,progress,-1)) &#x27;RC&#x27;,max(if(env=2,progress,-1)) &#x27;Stage&#x27;,max(if(env=3,progress,-1)) &#x27;Prod&#x27; from t3 group by title;+---------+-----------+--------+-----------+| title | RC | Stage | Prod |+---------+-----------+--------+-----------+| å·¥å•1 | å®Œæˆ | å®Œæˆ | å¾…å®¡æ ¸ || å·¥å•2 | å¾…å®¡æ ¸ | -1 | -1 |+---------+-----------+--------+-----------+2 rows in set (0.00 sec) oracleæœ‰pivotå‡½æ•°å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜,MySQLå¹¶æ²¡æœ‰è¿™æ ·çš„å‡½æ•°, ä¸€ç§é€€è€Œæ±‚å…¶æ¬¡çš„åŠæ³•æ˜¯ä½¿ç”¨JSON_OBJECTAGG1234567&gt; select title,JSON_OBJECTAGG(env,progress) val from t3 group by title;+---------+--------------------------------------------------+| title | val |+---------+--------------------------------------------------+| å·¥å•1 | &#123;&quot;1&quot;: &quot;å®Œæˆ&quot;, &quot;2&quot;: &quot;å®Œæˆ&quot;, &quot;3&quot;: &quot;å¾…å®¡æ ¸&quot;&#125; || å·¥å•2 | &#123;&quot;1&quot;: &quot;å¾…å®¡æ ¸&quot;&#125; |+---------+--------------------------------------------------+ ç„¶åå†ç¨‹åºå¾ªç¯valä¸­çš„key,valueè‡ªå·±åšå¤„ç† ä½¿ç”¨prepare statementå¯ä»¥å®ç°, æœ¬ä¾‹éœ€è¦æ„é€ ä¸€ä¸ªenvå€¼ä¸envåå­—çš„å¯¹åº”è¡¨123456789root@localhost 17:42:07 [fanboshi]&gt; select * from t_env;+----+--------+----------+| id | env_id | env_name |+----+--------+----------+| 1 | 1 | RC || 2 | 2 | Stage || 3 | 3 | Prod |+----+--------+----------+3 rows in set (0.00 sec) ç„¶å 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647SELECT GROUP_CONCAT(DISTINCT CONCAT( &#x27;MAX(IF(pa.env = &#x27;&#x27;&#x27;, env, &#x27;&#x27;&#x27;, pa.progress, -1)) AS &#x27;, &quot;&#x27;&quot;,e.env_name,&quot;&#x27;&quot; ) ) INTO @sqlFROM t3,(select @sql:= NULL) tmp, t_env e where env = e.env_id;root@localhost 17:44:40 [fanboshi]&gt; select @sql;+---------------------------------------------------------------------------------------------------------------------------------------------------------+| @sql |+---------------------------------------------------------------------------------------------------------------------------------------------------------+| MAX(IF(pa.env = &#x27;1&#x27;, pa.progress, NULL)) AS &#x27;RC&#x27;,MAX(IF(pa.env = &#x27;2&#x27;, pa.progress, NULL)) AS &#x27;Stage&#x27;,MAX(IF(pa.env = &#x27;3&#x27;, pa.progress, NULL)) AS &#x27;Prod&#x27; |+---------------------------------------------------------------------------------------------------------------------------------------------------------+select @sql:=CONCAT(&#x27;SELECT pa.title , &#x27;, @sql, &#x27; FROM t3 pa GROUP BY pa.title&#x27;); +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| @sql:=CONCAT(&#x27;SELECT pa.title , &#x27;, @sql, &#x27; FROM t3 pa GROUP BY pa.title&#x27;) |+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| SELECT pa.title , MAX(IF(pa.env = &#x27;1&#x27;, pa.progress, -1)) AS &#x27;RC&#x27;,MAX(IF(pa.env = &#x27;2&#x27;, pa.progress, -1)) AS &#x27;Stage&#x27;,MAX(IF(pa.env = &#x27;3&#x27;, pa.progress, -1)) AS &#x27;Prod&#x27; FROM t3 pa GROUP BY pa.title |+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+1 row in set (0.00 sec)å…¶å®è¿™é‡Œå·²ç»æŠŠæ‹¼æ¥å¥½çš„sqlæŸ¥å‡ºæ¥äº†, ç¨‹åºç›´æ¥æ‹¿ç€ä¸ªç»“æœå»æ‰§è¡Œåº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„, å¯èƒ½ä¸ç”¨åé¢åœ¨ä½¿ç”¨prepare statementäº†PREPARE stmt FROM @sql;EXECUTE stmt;+---------+-----------+--------+-----------+| title | RC | Stage | Prod |+---------+-----------+--------+-----------+| å·¥å•1 | å®Œæˆ | å®Œæˆ | å¾…å®¡æ ¸ || å·¥å•2 | å¾…å®¡æ ¸ | -1 | -1 |+---------+-----------+--------+-----------+DEALLOCATE PREPARE stmt; é‚£ä¹ˆåŸºäºä¸Šé¢çš„æ€è·¯, æˆ‘å¯»æ€è¿˜ç”¨å¾—ç€prepare statementå—, ç›´æ¥æ‹¼ä¸ªsqlä¸å°±å®Œäº‹äº†å—, ç”¨SQLé€ SQL1234567891011121314151617181920212223242526272829303132SELECT CONCAT(&#x27;SELECT pa.title, &#x27;, GROUP_CONCAT(DISTINCT CONCAT(&#x27;MAX(IF(pa.env = \\&#x27;&#x27;, env, &#x27;\\&#x27;, pa.progress, -1)) AS &#x27;, &#x27;\\&#x27;&#x27;, e.env_name, &#x27;\\&#x27;&#x27;)), &#x27; FROM t3 pa group by pa.title&#x27;) final_sqlFROM t3, t_env eWHERE env = e.env_id;+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| final_sql |+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| SELECT pa.title, MAX(IF(pa.env = &#x27;1&#x27;, pa.progress, -1)) AS &#x27;RC&#x27;,MAX(IF(pa.env = &#x27;2&#x27;, pa.progress, -1)) AS &#x27;Stage&#x27;,MAX(IF(pa.env = &#x27;3&#x27;, pa.progress, -1)) AS &#x27;Prod&#x27; FROM t3 pa group by pa.title |+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+1 row in set (0.00 sec)&gt; SELECT pa.title, MAX(IF(pa.env = &#x27;1&#x27;, pa.progress, -1)) AS &#x27;RC&#x27;,MAX(IF(pa.env = &#x27;2&#x27;, pa.progress, -1)) AS &#x27;Stage&#x27;,MAX(IF(pa.env = &#x27;3&#x27;, pa.progress, -1)) AS &#x27;Prod&#x27; FROM t3 pa group by pa.title;+---------+-----------+--------+-----------+| title | RC | Stage | Prod |+---------+-----------+--------+-----------+| å·¥å•1 | å®Œæˆ | å®Œæˆ | å¾…å®¡æ ¸ || å·¥å•2 | å¾…å®¡æ ¸ | -1 | -1 |+---------+-----------+--------+-----------+2 rows in set (0.00 sec) å‚è€ƒ:https://stackoverflow.com/questions/12598120/mysql-pivot-table-query-with-dynamic-columns","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"æ­»é”æ¡ˆä¾‹2 ä¸¤ä¸ªUPDATEæ­»é”","slug":"2020-08-23-æ­»é”æ¡ˆä¾‹2-ä¸¤ä¸ªUPDATEæ­»é”","date":"2020-08-23T10:44:00.000Z","updated":"2020-08-23T10:45:15.485Z","comments":true,"path":"2020/08/23/2020-08-23-æ­»é”æ¡ˆä¾‹2-ä¸¤ä¸ªUPDATEæ­»é”/","link":"","permalink":"http://fuxkdb.com/2020/08/23/2020-08-23-%E6%AD%BB%E9%94%81%E6%A1%88%E4%BE%8B2-%E4%B8%A4%E4%B8%AAUPDATE%E6%AD%BB%E9%94%81/","excerpt":"é—®é¢˜æè¿°2020.05.18 16:12 æ”¶åˆ°æŠ¥è­¦ ç™»å½•ä¸»æœº, æŸ¥çœ‹error log( å¼€å¯äº†innodb_print_all_deadlockså‚æ•°) 123456789101112131415161718192021222324*** (1) TRANSACTION:TRANSACTION 1261729280, ACTIVE 0 sec starting index readmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 3645828, OS thread handle 139681739994880, query id 1522438991 172.16.23.82 yos_rw Searching rows for updateUPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 12020-05-18T16:11:11.696061+08:00 3056367 [Note] InnoDB: *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 1208 page no 29439 n bits 160 index PRIMARY of table `yos`.`f_log` trx id 1261729280 lock_mode X locks rec but not gap waiting2020-05-18T16:11:11.696079+08:00 3056367 [Note] InnoDB: *** (2) TRANSACTION:TRANSACTION 1261729278, ACTIVE 0 sec updating or deletingmysql tables in use 1, locked 110 lock struct(s), heap size 1136, 7 row lock(s), undo log entries 3MySQL thread id 3056367, OS thread handle 139682403342080, query id 1522438990 172.16.23.82 yos_rw updatingUPDATE f_log SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;)2020-05-18T16:11:11.696099+08:00 3056367 [Note] InnoDB: *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 1208 page no 29439 n bits 160 index PRIMARY of table `yos`.`f_log` trx id 1261729278 lock_mode X locks rec but not gap2020-05-18T16:11:11.696112+08:00 3056367 [Note] InnoDB: *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 1208 page no 17 n bits 1120 index idx_status_type of table `yos`.`f_log` trx id 1261729278 lock_mode X locks rec but not gap waiting2020-05-18T16:11:11.696223+08:00 3056367 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (1) ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„æ­»é”æ—¥å¿—","text":"é—®é¢˜æè¿°2020.05.18 16:12 æ”¶åˆ°æŠ¥è­¦ ç™»å½•ä¸»æœº, æŸ¥çœ‹error log( å¼€å¯äº†innodb_print_all_deadlockså‚æ•°) 123456789101112131415161718192021222324*** (1) TRANSACTION:TRANSACTION 1261729280, ACTIVE 0 sec starting index readmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 3645828, OS thread handle 139681739994880, query id 1522438991 172.16.23.82 yos_rw Searching rows for updateUPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 12020-05-18T16:11:11.696061+08:00 3056367 [Note] InnoDB: *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 1208 page no 29439 n bits 160 index PRIMARY of table `yos`.`f_log` trx id 1261729280 lock_mode X locks rec but not gap waiting2020-05-18T16:11:11.696079+08:00 3056367 [Note] InnoDB: *** (2) TRANSACTION:TRANSACTION 1261729278, ACTIVE 0 sec updating or deletingmysql tables in use 1, locked 110 lock struct(s), heap size 1136, 7 row lock(s), undo log entries 3MySQL thread id 3056367, OS thread handle 139682403342080, query id 1522438990 172.16.23.82 yos_rw updatingUPDATE f_log SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;)2020-05-18T16:11:11.696099+08:00 3056367 [Note] InnoDB: *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 1208 page no 29439 n bits 160 index PRIMARY of table `yos`.`f_log` trx id 1261729278 lock_mode X locks rec but not gap2020-05-18T16:11:11.696112+08:00 3056367 [Note] InnoDB: *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 1208 page no 17 n bits 1120 index idx_status_type of table `yos`.`f_log` trx id 1261729278 lock_mode X locks rec but not gap waiting2020-05-18T16:11:11.696223+08:00 3056367 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (1) ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„æ­»é”æ—¥å¿— TRANSACTION 1261729280, MySQL thread id 3645828, æœ€åä¸€æ¡æ‰§è¡Œçš„sqlä¸º 1UPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 1 å®ƒåœ¨ç­‰å¾…è·å–ä¸»é”®ä¸Šçš„è®°å½•é” 1RECORD LOCKS index PRIMARY of table `yos`.`f_log` lock_mode X locks rec but not gap waiting TRANSACTION 1261729278, MySQL thread id 3056367, æœ€åä¸€æ¡æ‰§è¡Œçš„sqlä¸º 1UPDATE f_log SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;) æŒæœ‰ä¸»é”®è®°å½•é” 1RECORD LOCKS index PRIMARY of table `yos`.`f_log` lock_mode X locks rec but not gap ç­‰å¾…åœ¨äºŒçº§ç´¢å¼•idx_status_typeä¸ŠåŠ è®°å½•é” 1RECORD LOCKS index idx_status_type of table `yos`.`f_log` lock_mode X locks rec but not gap waiting è¡¨ç»“æ„ 1234567891011121314151617root@localhost 16:18:24 [yos]&gt; show create table f_log\\G*************************** 1. row *************************** Table: f_logCreate Table: CREATE TABLE `f_log` ( `I_ID` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;è‡ªå¢ä¸»é”®&#x27;, `I_CHANNEL_ID` bigint(20) NOT NULL COMMENT &#x27;é€šé“ID&#x27;, `I_FILE_ID` varchar(100) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;æ–‡ä»¶ID&#x27;, `I_TYPE` tinyint(4) NOT NULL COMMENT &#x27;æ—¥å¿—ç±»å‹1 åŒæ­¥ 2 åˆ é™¤&#x27;, `I_STATUS` tinyint(1) NOT NULL COMMENT &#x27;åŒæ­¥æ ‡å¿— 0 æœªåŒæ­¥ 1 åŒæ­¥ä¸­ 2 å·²åŒæ­¥ 3&#x27;, `D_CREATED_AT` datetime DEFAULT NULL COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;, `D_UPDATED_AT` datetime DEFAULT NULL COMMENT &#x27;ä¿®æ”¹æ—¶é—´&#x27;, PRIMARY KEY (`I_ID`), KEY `idx_updatedat_status_type` (`D_UPDATED_AT`,`I_STATUS`,`I_TYPE`), KEY `idx_status_type` (`I_STATUS`,`I_TYPE`), KEY `idx_file_id` (`I_FILE_ID`)) ENGINE=InnoDB AUTO_INCREMENT=2011346 DEFAULT CHARSET=utf8 COMMENT=&#x27;æ–‡ä»¶æ—¥å¿—è¡¨&#x27;1 row in set (0.00 sec) äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºREAD-COMMITTED æ­»é”è¿™å—æˆ‘æ¯”è¾ƒå¼±, å…¶å®å‰å®³çš„è¯æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯å·²ç»å¯ä»¥çœ‹å‡ºåŸå› äº†. æ’æŸ¥è¿‡ç¨‹æˆ‘å½“æ—¶å»ç¿»å®¡è®¡æ—¥å¿—, é€šè¿‡è¯­å¥ä¸­çš„ä¸€äº›å…³é”®ä¿¡æ¯, å¦‚ `thread id 3645828/3056367â€™ æ—¶é—´èŒƒå›´, æ‰¾å‡ºäº†å¦‚ä¸‹ä¿¡æ¯ TRANSACTION (2) ä¹Ÿå°±æ˜¯ 12345TRANSACTION 1261729278, ACTIVE 0 sec updating or deletingmysql tables in use 1, locked 110 lock struct(s), heap size 1136, 7 row lock(s), undo log entries 3MySQL thread id 3056367, OS thread handle 139682403342080, query id 1522438990 172.16.23.82 yos_rw updatingUPDATE f_log SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;) æ‰§è¡Œè¯­å¥å¦‚ä¸‹: 123456789START TRANSACTIONSELECT I_FILE_ID,I_FILE_COUNT,I_FILE_STATUS,I_IS_EXPIRED,I_FILE_VALIDDAY,I_FILE_ACCESS,CH_FILE_NAME,CH_FILE_TYPE,I_BUSINESS_ID,D_CREATED_AT,D_UPDATED_AT,I_YOS_VERSION,D_EXPIRED_AT FROM f_file_info WHERE I_FILE_ID = &#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27; FOR UPDATESELECT i_channel_id FROM f_file_storage WHERE i_file_id = &#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27; AND i_storage_status = 1UPDATE f_file_info SET i_file_count = 2, d_updated_at = &#x27;2020-05-18 16:11:11.687696&#x27; WHERE i_file_id = &#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;SELECT I_ID,I_FILE_ID,I_STORAGE_STATUS,I_CHANNEL_ID,D_CREATED_AT,D_UPDATED_AT FROM f_file_storage WHERE i_file_id = &#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27; AND i_channel_id = 1 FOR UPDATEUPDATE f_file_storage SET i_storage_status = 1 , d_updated_at = &#x27;2020-05-18 16:11:11.690879&#x27; WHERE i_file_id = &#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27; AND i_channel_id = 1SELECT count(*) FROM f_file_storage WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27; AND I_STORAGE_STATUS=1)UPDATE f_log SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;)COMMIT TRANSACTION (1) ä¹Ÿå°±æ˜¯ 12345TRANSACTION 1261729280, ACTIVE 0 sec starting index readmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 3645828, OS thread handle 139681739994880, query id 1522438991 172.16.23.82 yos_rw Searching rows for updateUPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 1 æ‰§è¡Œè¯­å¥å¦‚ä¸‹: 12PrepareUPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 1 åˆ°è¿™é‡Œæƒ³ä¸å‡ºåŸå› äº†, å› ä¸ºä¸¤ä¸ªä¼šè¯å®é™…ä¸Šå°±æ˜¯updateè¯­å¥æ­»é”äº†. æˆ‘ä½†æ˜¯æ²¡æƒ³æ˜ç™½ä¸ºå•¥UPDATE f_log SET D_UPDATED_AT=&#39;2020-05-18 16:11:11.693998&#39;,I_STATUS=3 WHERE (I_FILE_ID=&#39;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#39;) è¦è¯·æ±‚åœ¨äºŒçº§ç´¢å¼•idx_status_typeä¸ŠåŠ è®°å½•é” åæ¥è¿˜æ˜¯å’Œç ”å‘è®¨è®º, ç ”å‘æé†’äº†æˆ‘updateè¦é”è¢«ä¿®æ”¹åˆ—äºŒçº§ç´¢å¼•. æˆ‘ä¸€å¼€å§‹è¿˜è¯´ä¸å¯¹â€¦ åæ¥æƒ³æƒ³æœ‰é“ç† https://www.aneasystone.com/archives/2017/12/solving-dead-locks-three.html é‚£ä¹ˆåˆ°è¿™é‡Œå°±è¯´é€šäº†, è¿™å°±æ˜¯ä¸ºå•¥UPDATE f_log SET D_UPDATED_AT=&#39;2020-05-18 16:11:11.693998&#39;,I_STATUS=3 WHERE (I_FILE_ID=&#39;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#39;) è¦è¯·æ±‚åœ¨äºŒçº§ç´¢å¼•idx_status_typeä¸ŠåŠ è®°å½•é” é‚£ä¹ˆå®é™…è¿™ä¸ªæ­»é”æ˜¯è¿™æ ·äº§ç”Ÿçš„ äº‹åŠ¡1,2 å¼€å§‹æ—¶ I_FILE_ID=â€™92b52d6589ce11a9a3c985e7c5f37462efb66ac7â€™ å¯¹åº”è®°å½•çš„ I_STATUS = 1 , I_TYPE = 1 äº‹åŠ¡2æ‰§è¡Œè¯­å¥ 1UPDATE f_log SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;92b52d6589ce11a9a3c985e7c5f37462efb66ac7&#x27;) èµ°I_FILE_IDåˆ—äºŒçº§ç´¢å¼•idx_file_id, æ ¹æ®äºŒçº§ç´¢å¼•ä¸­çš„ä¸»é”®å€¼æ‰¾åˆ°ä¸»é”®ç´¢å¼•å¯¹åº”è®°å½•åŠ è®°å½•é”, å› ä¸ºæ˜¯updateè¯­å¥æ›´æ–°äº†I_STATUSåˆ—, ä¸”I_STATUSåˆ—æœ‰äºŒçº§ç´¢å¼•idx_status_typeæ‰€ä»¥è¿˜è¦å»ä¿®æ”¹äºŒçº§ç´¢å¼•ä¸­å¯¹åº”è®°å½•, äºæ˜¯ä¹Ÿè¦é”idx_status_typeä¸­çš„è®°å½•I_STATUS = 1 , I_TYPE = 1, I_ID=2010712(åŸå€¼)å’ŒI_STATUS = 3 , I_TYPE = 1, I_ID=2010712(æ–°å€¼). ä½†æ­¤æ—¶äº‹åŠ¡2è¿˜æœªåœ¨idx_status_typeå¯¹åº”è®°å½•åŠ ä¸Šé”, äº‹åŠ¡1æ‰§è¡Œäº†è¯­å¥ 1UPDATE f_log SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 1 è¿™ä¸ªsqlèµ°äºŒçº§ç´¢å¼•idx_status_type, äºæ˜¯å…ˆå¯¹äºŒçº§ç´¢å¼•idx_status_typeå¯¹åº”è®°å½•I_STATUS = 1 , I_TYPE = 1, I_ID=2010712åŠ é”, åŠ é”æˆåŠŸ, ç„¶åéœ€è¦æ ¹æ®äºŒçº§ç´¢å¼•idx_status_typeä¸­è®°å½•çš„ä¸»é”®å€¼I_ID=2010712å»ä¸»é”®åŠ é”, ä½†æ­¤é”å·²ç»è¢«äº‹åŠ¡2æŒæœ‰ äº‹åŠ¡2æŒæœ‰ä¸»é”®é”, ç­‰å¾…åœ¨äºŒçº§ç´¢å¼•idx_status_typeåŠ è®°å½•é” äº‹åŠ¡1æŒæœ‰idx_status_typeè®°å½•é”, ç­‰å¾…åœ¨ä¸»é”®åŠ è®°å½•é” è‡³æ­¤é™·å…¥æ­»é”. é—®é¢˜å¤ç°è¿™ä¸ªæ­»é”å¯ä»¥è¯´æ˜¯å¾ˆå·§åˆäº†, æ‰‹å·¥æ— æ³•æ¨¡æ‹Ÿ æˆ‘æ˜¯è¿™æ ·çš„æ¨¡æ‹Ÿçš„, å¼€ä¸‰ä¸ªçª—å£, åˆ†åˆ«æ‰§è¡Œ 1while true;do mysql -uroot -p&#x27;123.com&#x27; -S /data/mysql_3306/run/mysql.sock fanboshi -e&quot;begin;UPDATE f_log_2 SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;250181420422912&#x27;);commit;&quot;;done 1while true;do mysql -uroot -p&#x27;123.com&#x27; -S /data/mysql_3306/run/mysql.sock fanboshi -e&quot;UPDATE f_log_2 SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 1&quot;;done 1while true;do mysql -uroot -p&#x27;123.com&#x27; -S /data/mysql_3306/run/mysql.sock fanboshi -e&quot;UPDATE f_log_2 SET I_STATUS = 1, I_TYPE=1 WHERE I_ID=9656 &quot;;done ç¬¬ä¸‰ä¸ªçª—å£ç›®çš„åªæ˜¯å°†I_STATUSå’ŒI_TYPEåˆ—å€¼æ›´æ–°å›å», åˆ¶é€ æ¡ä»¶, ä¸ç„¶å‰ä¸¤ä¸ªçª—å£è¯­å¥ä¸æ»¡è¶³æ¡ä»¶æ›´æ–°ä¸åˆ°è®°å½• å¤ç°å‡ºçš„æ­»é”æ—¥å¿—å¦‚ä¸‹, å¼€èµ·äº†innodb_show_verbose_lockså‚æ•°: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061622020-05-19T14:15:29.074829+08:00 11644 [Note] InnoDB: Transactions deadlock detected, dumping detailed information.2020-05-19T14:15:29.074841+08:00 11644 [Note] InnoDB: *** (1) TRANSACTION:TRANSACTION 19924, ACTIVE 0 sec starting index readmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)MySQL thread id 11643, OS thread handle 140502089639680, query id 40057 localhost root Searching rows for updateUPDATE f_log_2 SET D_UPDATED_AT = NOW() , I_STATUS = 17 WHERE I_STATUS = 1 AND I_TYPE = 12020-05-19T14:15:29.074858+08:00 11644 [Note] InnoDB: *** (1) WAITING FOR THIS LOCK TO BE GRANTED: --ç­‰å¾…è·å–å¦‚ä¸‹é”RECORD LOCKS space id 137 page no 136 n bits 312 index PRIMARY of table `fanboshi`.`f_log_2` trx id 19924 lock_mode X locks rec but not gap waiting --ä¸»é”®è®°å½•é”Record lock, heap no 217 PHYSICAL RECORD: n_fields 9; compact format; info bits 0 0: len 8; hex 80000000000025b8; asc % ;; ç¬¬ä¸€åˆ—, æ ¹æ®è¡¨ç»“æ„çŸ¥é“è¿™åˆ—æ˜¯ä¸»é”®, 16è¿›åˆ¶è½¬10è¿›åˆ¶ 9656 1: len 6; hex 000000004dd5; asc M ;; --è¯¥å­—æ®µä¸º6ä¸ªå­—èŠ‚çš„äº‹åŠ¡idï¼Œè¿™ä¸ªidè¡¨ç¤ºæœ€è¿‘ä¸€æ¬¡è¢«æ›´æ–°çš„äº‹åŠ¡id 000000004dd5 16è¿›åˆ¶è½¬10è¿›åˆ¶ç»“æœä¸º19925æ­£æ˜¯ä¸‹é¢äº‹åŠ¡2çš„çš„äº‹åŠ¡å·&quot;TRANSACTION 19925&quot; 2: len 7; hex 34000000051016; asc 4 ;; --è¯¥å­—æ®µä¸º7ä¸ªå­—èŠ‚çš„å›æ»šæŒ‡é’ˆï¼Œç”¨äºmvcc 3: len 8; hex 8000000000000001; asc ;; I_CHANNEL_ID = 1 4: len 15; hex 323530313831343230343232393132; asc 250181420422912;; I_FILE_ID è¿™ä¸€åˆ—æ˜¯varcharç±»å‹. 0x32 0x35 0x30 0x31 0x38 0x31 0x34 0x32 0x30 0x34 0x32 0x32 0x39 0x31 0x32 è½¬è¿‡æ¥å°±æ˜¯250181420422912 5: len 1; hex 81; asc ;; I_TYPE=1 6: len 1; hex 83; asc ;; I_STATUS=3 7: len 5; hex 99a2d8fd14; asc ;; D_CREATED_AT ä¸çŸ¥é“æ€ä¹ˆè½¬æ¢ 8: len 5; hex 99a66502cc; asc e ;; D_UPDATED_AT ä¸çŸ¥é“æ€ä¹ˆè½¬æ¢åˆ°è¿™é‡Œå·²ç»èƒ½å®šä½æ˜¯å“ªä¸€è¡Œäº†mysql&gt; select * from f_log_2 WHERE I_ID=9656;+------+--------------+-----------------+--------+----------+---------------------+---------------------+| I_ID | I_CHANNEL_ID | I_FILE_ID | I_TYPE | I_STATUS | D_CREATED_AT | D_UPDATED_AT |+------+--------------+-----------------+--------+----------+---------------------+---------------------+| 9656 | 1 | 250181420422912 | 1 | 1 | 2019-04-12 15:52:20 | 2020-05-18 16:11:12 |+------+--------------+-----------------+--------+----------+---------------------+---------------------+1 row in set (0.00 sec)2020-05-19T14:15:29.074996+08:00 11644 [Note] InnoDB: *** (2) TRANSACTION:TRANSACTION 19925, ACTIVE 0 sec updating or deletingmysql tables in use 1, locked 14 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1MySQL thread id 11644, OS thread handle 140502025062144, query id 40060 localhost root updatingUPDATE f_log_2 SET D_UPDATED_AT=&#x27;2020-05-18 16:11:11.693998&#x27;,I_STATUS=3 WHERE (I_FILE_ID=&#x27;250181420422912&#x27;)2020-05-19T14:15:29.075010+08:00 11644 [Note] InnoDB: *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 137 page no 136 n bits 312 index PRIMARY of table `fanboshi`.`f_log_2` trx id 19925 lock_mode X locks rec but not gap --æŒæœ‰ä¸»é”®è®°å½•é”Record lock, heap no 217 PHYSICAL RECORD: n_fields 9; compact format; info bits 0 0: len 8; hex 80000000000025b8; asc % ;; 1: len 6; hex 000000004dd5; asc M ;; 2: len 7; hex 34000000051016; asc 4 ;; 3: len 8; hex 8000000000000001; asc ;; 4: len 15; hex 323530313831343230343232393132; asc 250181420422912;; 5: len 1; hex 81; asc ;; 6: len 1; hex 83; asc ;; 7: len 5; hex 99a2d8fd14; asc ;; 8: len 5; hex 99a66502cc; asc e ;;æŒæœ‰TRANSACTION (1)ç­‰å¾…è·å–çš„å“ªä¸€è¡Œä¸»é”®é”2020-05-19T14:15:29.075141+08:00 11644 [Note] InnoDB: *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 137 page no 17 n bits 1120 index idx_status_type of table `fanboshi`.`f_log_2` trx id 19925 lock_mode X locks rec but not gap waiting --ç­‰å¾…äºŒçº§ç´¢å¼•åˆ—åŠ é”Record lock, heap no 526 PHYSICAL RECORD: n_fields 3; compact format; info bits 0 0: len 1; hex 81; asc ;; I_STATUS = 1 1: len 1; hex 81; asc ;; I_TYPE = 1 2: len 8; hex 80000000000025b8; asc % ;; è¿™æ˜¯ä¸»é”®å€¼ 12020-05-19T14:15:29.075197+08:00 11644 [Note] InnoDB: *** WE ROLL BACK TRANSACTION (1) å¯ä»¥çœ‹åˆ°å’Œçº¿ä¸Šå‡ºç°çš„æ­»é”æ—¥å¿—æ˜¯å»åˆçš„ è§£å†³åŠæ³•å°†äº‹åŠ¡1è¯­å¥æ”¹ä¸ºå…ˆæ ¹æ®æ¡ä»¶æŸ¥è¯¢å‡ºä¸»é”®å€¼, ç„¶åæ ¹æ®ä¸»é”®å€¼æ›´æ–°.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"æ­»é”","slug":"æ­»é”","permalink":"http://fuxkdb.com/tags/%E6%AD%BB%E9%94%81/"}]},{"title":"MGRå•ä¸»åˆ°åº•åšä¸åšå†²çªæ£€æµ‹?","slug":"2020-06-18-MGRå•ä¸»åˆ°åº•åšä¸åšå†²çªæ£€æµ‹","date":"2020-06-18T14:23:00.000Z","updated":"2020-06-18T14:34:48.314Z","comments":true,"path":"2020/06/18/2020-06-18-MGRå•ä¸»åˆ°åº•åšä¸åšå†²çªæ£€æµ‹/","link":"","permalink":"http://fuxkdb.com/2020/06/18/2020-06-18-MGR%E5%8D%95%E4%B8%BB%E5%88%B0%E5%BA%95%E5%81%9A%E4%B8%8D%E5%81%9A%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B/","excerpt":"å’ŒåŒäº‹æ¢è®¨ä¸€ä¸ªé—®é¢˜, MGRå•ä¸»åšä¸åšå†²çªæ£€æµ‹. æˆ‘ç†è§£æ˜¯ä¸éœ€è¦åšçš„, å› ä¸ºå·²ç»æ˜ç¡®åªæœ‰ä¸»èŠ‚ç‚¹æ‰èƒ½å†™å…¥æ•°æ®äº†, é‚£ä¹ˆå¿…ç„¶ä¸ä¼šæœ‰æ•°æ®å†²çªçš„å¯èƒ½, æ²¡å¿…è¦å†åšå†²çªæ£€æµ‹æµªè´¹æ€§èƒ½äº†. çœ‹äº†ä¸‹å®˜æ–¹æ–‡æ¡£ 1In single-primary mode, Group Replication enforces that only a single server writes to the group, so compared to multi-primary mode, consistency checking can be less strict and DDL statements do not need to be handled with any extra care","text":"å’ŒåŒäº‹æ¢è®¨ä¸€ä¸ªé—®é¢˜, MGRå•ä¸»åšä¸åšå†²çªæ£€æµ‹. æˆ‘ç†è§£æ˜¯ä¸éœ€è¦åšçš„, å› ä¸ºå·²ç»æ˜ç¡®åªæœ‰ä¸»èŠ‚ç‚¹æ‰èƒ½å†™å…¥æ•°æ®äº†, é‚£ä¹ˆå¿…ç„¶ä¸ä¼šæœ‰æ•°æ®å†²çªçš„å¯èƒ½, æ²¡å¿…è¦å†åšå†²çªæ£€æµ‹æµªè´¹æ€§èƒ½äº†. çœ‹äº†ä¸‹å®˜æ–¹æ–‡æ¡£ 1In single-primary mode, Group Replication enforces that only a single server writes to the group, so compared to multi-primary mode, consistency checking can be less strict and DDL statements do not need to be handled with any extra care è¿™é‡Œless strictè®©äººå¾ˆè¿·æƒ‘, æ„æ€æ˜¯è¿˜æœ‰å†²çªæ£€æµ‹å‘—, ä½†æ˜¯å’Œå¤šä¸»åŒºåˆ«æ˜¯å•¥æ²¡è¯´ ä¹‹å‰çœ‹MGRçš„æ—¶å€™çœ‹è¿‡ç½‘æ˜“æ¸©æ­£æ¹–çš„æ–‡ç« , è·¯ä¸Šæœäº†ä¸‹, å‘ç°ä¸¤ä¸ªæ–‡ç« : MySQL MGRäº‹åŠ¡è®¤è¯æœºåˆ¶ä¼˜åŒ– MySQLäº‹åŠ¡åœ¨MGRä¸­çš„æ¼«æ¸¸è®° - äº‹åŠ¡è®¤è¯ å…¶å®ä»–æ–‡ç« å“ªäº›æºç æˆ‘ä¹Ÿçœ‹ä¸æ‡‚. æˆ‘æ˜¯ä¸æƒ³åˆ«äººè¯´å•¥æˆ‘å°±ä¿¡å•¥, æ‰€ä»¥æƒ³æ‰¾åˆ°çŸ¥è¯†æºå¤´ åˆ°å®¶æˆ‘æœäº†ä¸‹conflict_detection_enable æœåˆ°è¿™ä¸ªç½‘ç«™https://s0dev0mysql0com.icopy.site/doc/dev/mysql-server/latest/classCertifier.html é‚£ä¹ˆè¿™ä¸ªç½‘ç«™æºå¤´åˆæ˜¯å•¥å‘¢, åˆæœäº†ä¸‹ https://dev.mysql.com/doc/dev/mysql-server/latest/classCertifier.htmlè¿™é‡Œé¢è¯´çš„å°±å¾ˆæ¸…æ¥šäº† å°±æ˜¯è¯´å•ä¸», ä¸»åº“æŒ‚äº†, æ–°ä¸»åº“åº”ç”¨åŸä¸»åº“äº‹åŠ¡çš„æ—¶å€™æ‰åšå†²çªæ£€æµ‹ æƒ³èµ·ä»¥å‰åšè¿‡å®éªŒå‹æµ‹2 5.7MGRæ˜¯å¦è¦åº”ç”¨å®Œæ‰€æœ‰binlogæ‰ä¼šé€‰ä¸¾å‡ºæ–°ä¸» å®é™…ä¸Š5.7å®˜æ–¹æ–‡æ¡£æœ‰æè¿° å•ä¸»æ¨¡å¼ä¸‹: å½“é€‰æ‹©ä¸€ä¸ªæ–°çš„ä¸»æ•°æ®åº“æ—¶ï¼Œå®ƒåªæœ‰åœ¨å¤„ç†å®Œæ‰€æœ‰æ¥è‡ªæ—§ä¸»æ•°æ®åº“çš„äº‹åŠ¡åæ‰å¯å†™ã€‚ è¿™æ ·å¯ä»¥é¿å…æ—§çš„ä¸»äº‹åŠ¡ä¸­çš„æ—§äº‹åŠ¡ä¸åœ¨è¯¥æˆå‘˜ä¸Šæ‰§è¡Œçš„æ–°äº‹åŠ¡ä¹‹é—´å¯èƒ½å‘ç”Ÿçš„å¹¶å‘é—®é¢˜ã€‚ åœ¨æ–°çš„ä¸»æ•°æ®åº“é‡æ–°è·¯ç”±å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¹‹å‰ï¼Œæœ€å¥½ç­‰å¾…æ–°çš„ä¸»æ•°æ®åº“åº”ç”¨å…¶å¤åˆ¶ç›¸å…³çš„ä¸­ç»§æ—¥å¿—ã€‚ When a new primary is elected, it is only writable once it has processed all of the transactions that came from the old primary. This avoids possible concurrency issues between old transactions from the old primary and the new ones being executed on this member. It is a good practice to wait for the new primary to apply its replication related relay-log before re-routing client applications to it. https://dev.mysql.com/doc/refman/5.7/en/group-replication-single-primary-mode.html åœ¨8.0æ–‡æ¡£ä¸­æ˜¯è¿™æ ·å†™çš„ é€‰ä¸¾æˆ–ä»»å‘½æ–°çš„ä¸»åº“æ—¶ï¼Œå¯èƒ½ä¼šç§¯å‹å·²åº”ç”¨äºæ—§çš„ä¸»åº“ä½†å°šæœªåœ¨æ­¤æœåŠ¡å™¨ä¸Šåº”ç”¨çš„æ›´æ”¹ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›´åˆ°æ–°çš„ä¸»æ•°æ®åº“èµ¶ä¸Šæ—§çš„ä¸»æ•°æ®åº“ï¼Œè¯»å†™äº‹åŠ¡å¯èƒ½ä¼šå¯¼è‡´å†²çªå¹¶å›æ»šï¼Œè€Œåªè¯»äº‹åŠ¡å¯èƒ½ä¼šå¯¼è‡´é™ˆæ—§çš„è¯»å–ã€‚ When a new primary is elected or appointed, it might have a backlog of changes that had been applied on the old primary but have not yet been applied on this server. In this situation, until the new primary catches up with the old primary, read-write transactions might result in conflicts and be rolled back, and read-only transactions might result in stale reads. https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html è¿™å…¶å®å¾ˆåˆç†, å‡è®¾ä¸€ä¸ªå•ä¸»æ¨¡å¼MGRé›†ç¾¤ ä¸‰ä¸ªèŠ‚ç‚¹A, B, C Aæ˜¯ä¸»åº“, appå‘T1è¡¨æ’å…¥ä¸‰æ¡æ•°æ®, ä¸»é”®å€¼åˆ†åˆ«ä¸º 1,2,3 B,Cæ”¶åˆ°binlog event, ä½†è¿˜æœªåº”ç”¨, æ­¤æ—¶Aå®•æœº, Bå½“é€‰ä¸ºæ–°ä¸»åº“, é‚£ä¹ˆBéœ€è¦åº”ç”¨åœ¨Aäº§ç”Ÿçš„ä¸‰ä¸ªæ’å…¥1,2,3. å¦‚æœæ²¡æœ‰å†²çªæ£€æµ‹, åœ¨Båº”ç”¨1,2,3å‰,ä¸šåŠ¡æœ‰æ’å…¥äº†æ–°æ•°æ®1,2,3, é‚£ä¹ˆå°±æ˜æ˜¾æœ‰é—®é¢˜, æ‰€ä»¥æ­¤é˜¶æ®µä¸€å®šè¦åšå†²çªæ£€æµ‹. ä»”ç»†çœ‹æ„Ÿè§‰5.7å’Œ8.0çš„æè¿°æœ‰äº†â€å¾ˆå¤§åŒºåˆ«â€ 5.7è¯´ When a new primary is elected, it is only writable once it has processed all of the transactions that came from the old primary. æ–°ä¸»å¿…é¡»åº”ç”¨å®ŒåŸä¸»æ‰€æœ‰äº‹ç‰©æ‰å¯å†™ 8.0è¯´In this situation, until the new primary catches up with the old primary, read-write transactions might result in conflicts and be rolled back, and read-only transactions might result in stale reads. åœ¨æ–°ä¸»åº”ç”¨å®ŒåŸä¸»æ‰€æœ‰äº‹ç‰©å‰, å†™å¯èƒ½ä¼šå†²çªå›æ»š, è€Œè¯»å¯èƒ½ä¼šè¯»åˆ°æ—§æ•°æ® æˆ‘çŒœæµ‹è¿™æ˜¯è¯´5.7å•ä¸»æ˜¯å½»åº•å…³é—­äº†å†²çªæ£€æµ‹, æ–°ä¸»åº”ç”¨åŸä¸»å®ŒåŸä¸»äº‹åŠ¡å‰æ˜¯ä¸å¯å†™çš„, é€šè¿‡ä¸å¯å†™é¿å…äº†å†²çª, è¿˜éœ€è¦ç»§ç»­åšå®éªŒæµ‹è¯•, æ–°ä¸»åº”ç”¨åŸä¸»å®ŒåŸä¸»äº‹åŠ¡å‰, æ˜¯å¦å¯ä»¥æ‰§è¡Œä¸å†²çªçš„äº‹åŠ¡(æ¯”å¦‚æˆ‘ä»¬åƒT1è¡¨å†™å¤§é‡æ•°æ®åˆ¶é€ transactions_behind, æ–°ä¸»å½“é€‰å, æˆ‘ä»¬æƒ³T2è¡¨å†™æ•°æ®, è¿™æ˜æ˜¾æ˜¯ä¸å†²çªçš„.) é‚£ä¹ˆçœ‹æ¥8.0æ¯”5.7æœ‰äº†æ”¹è¿›, åœ¨æ–°ä¸»åº”ç”¨åŸä¸»å®ŒåŸä¸»äº‹åŠ¡æœŸé—´å¼€å¯å†²çªæ£€æµ‹, é‚£ä¹ˆæŒ‰ç…§ä¸Šé¢çš„å®éªŒä¾‹å­, ä¸šåŠ¡å°±å¯ä»¥æ‰§è¡Œâ€ä¸å†²çªçš„äº‹åŠ¡äº†â€ ä½†æ˜¯æ˜¯å¦è¿™æ ·å¯¹ä¸šåŠ¡æ¥è¯´æ˜¯å¯æ¥å—çš„å‘¢? ä¹Ÿè®¸ä¸šåŠ¡å¸Œæœ›æ–°ä¸»åº”ç”¨åŸä¸»å®ŒåŸä¸»äº‹åŠ¡åæ‰å¯å†™æ˜¯åˆç†çš„, æ‰€ä»¥æœ‰äº†ä¸‹é¢çš„å‚æ•° 8.0.14åå¢åŠ äº†å‚æ•°group_replication_consistency, ä»æ ¹æœ¬ä¸Šè§£å†³äº†è¯»æ—§æ•°æ®çš„é—®é¢˜(å†™æ“ä½œæ— éœ€è®¾ç½®å‚æ•°ä¹Ÿä¼šç­‰å¾…åº”ç”¨å®Œæ‰€æœ‰backlogæ‰å¯ä»¥æ‰§è¡Œ) 123BEFORE_ON_PRIMARY_FAILOVERNew RO or RW transactions with a newly elected primary that is applying backlog from the old primary are held (not applied) until any backlog has been applied. This ensures that when a primary failover happens, intentionally or not, clients always see the latest value on the primary. This guarantees consistency, but means that clients must be able to handle the delay in the event that a backlog is being applied. Usually this delay should be minimal, but does depend on the size of the backlog. åœ¨å‘ç”Ÿåˆ‡æ¢æ—¶ï¼Œè¿åˆ°æ–°ä¸»çš„äº‹åŠ¡ä¼šè¢«é˜»å¡ï¼Œç­‰å¾…å…ˆåºæäº¤çš„äº‹åŠ¡å›æ”¾å®Œæˆï¼›è¿™æ ·ç¡®ä¿åœ¨æ•…éšœåˆ‡æ¢æ—¶å®¢æˆ·ç«¯éƒ½èƒ½è¯»å–åˆ°ä¸»æœåŠ¡å™¨ä¸Šçš„æœ€æ–°æ•°æ®ï¼Œä¿è¯äº†ä¸€è‡´æ€§ ä¸Šé¢çš„æè¿°ä¸ä¸¥è°¨, å‡ºè‡ªçŸ¥æ•°å ‚ç”°é¹çš„æ–‡ç« MySQL MGRâ€ä¸€è‡´æ€§è¯»å†™â€ç‰¹æ€§è§£è¯». äº‹å®ä¸Šåªè¯»äº‹åŠ¡ä¹Ÿä¼šç­‰å¾…, é™¤äº†ä»¥ä¸‹åªè¯»äº‹åŠ¡(å‚è€ƒæ­¤è¯‘æ–‡https://cloud.tencent.com/developer/article/1478455) SHOW commands SET option DO EMPTY USE SELECTing from performance_schema database SELECTing from table PROCESSLIST on database infoschema SELECTing from sys database SELECT command that donâ€™t use tables SELECT command that donâ€™t execute user defined functions STOP GROUP_REPLICATION command SHUTDOWN command RESET PERSIST ä¸ªäººç†è§£å¦‚æœè®¾ç½®BEFORE_ON_PRIMARY_FAILOVERè™½ç„¶ä¼šä¿è¯ä¸€è‡´æ€§, å¦‚æœèŠ‚ç‚¹æ–°ä¸»ä¸åŸä¸»å»¶è¿Ÿè¿‡å¤§, æ–°ä¸»åº”ç”¨å·®å¼‚æ—¥å¿—æ—¶é—´è¿‡é•¿, é‚£ä¹ˆä¼šå¯¼è‡´å¤§é‡è¿æ¥è¿›æ¥å¤„äºç­‰å¾…çŠ¶æ€, å¯¼è‡´Threads_runningæš´æ¶¨, ç”šè‡³è¿æ¥æ•°æ‰“æ»¡æ–°ä¸»å´©æºƒ è‡³8.0.18MGRé€‰ä¸»ç®—æ³•æ˜¯ 1.é€‰ç‰ˆæœ¬æœ€å°çš„ 2.é€‰æƒé‡æœ€å¤§çš„ 3.é€‰uuidæ’åºæœ€å°çš„ æ‰€ä»¥å¹¶æ²¡æœ‰åˆ¤æ–­å“ªä¸ªèŠ‚ç‚¹å»¶è¿Ÿæœ€å° https://dev.mysql.com/doc/refman/8.0/en/group-replication-single-primary-mode.html é‚£ä¹ˆå¤šä¸»å¦‚ä½•å¤„ç†? ä»å‚æ•°è¯´æ˜ä¸Šæ¥çœ‹BEFORE_ON_PRIMARY_FAILOVERåº”è¯¥åªæ˜¯é’ˆå¯¹å•ä¸», æ‰€ä»¥é™¤éåº”ç”¨æ˜¾ç¤ºæŒ‡å®šäº†group_replication_consistency, å¦åˆ™å¤šä¸»è¿˜æ˜¯ä¼šè¯»åˆ°æ—§æ•°æ®. å¯¹äºå†™å…¥, å› ä¸ºå¤šä¸»æ˜¯è¦åšå†²çªæ£€æµ‹çš„, æ‰€ä»¥æˆ‘ä»¬å‡è®¾ä¸€ä¸ªåœºæ™¯ å¤šä¸»MGR, N1,N2,N3, å•å†™N1, T1(id int primary key, sname varchar(10))è¡¨æ’å…¥ 123451,fan GTID: GROUP_UUID:12,bo GTID: GROUP_UUID:23,shi GTID: GROUP_UUID:3ç›®å‰GTID: GROUP_UUID:1-3 N1å®•æœº, N2åº”ç”¨åˆ°1, æœªæ‰§è¡Œ2,3. æ­¤æ—¶clientåƒN2æ’å…¥(2,hehe) é‚£ä¹ˆæ­¤æ—¶N2è¿™ä¸ªæ’å…¥ç‰ˆæœ¬æ˜¯GROUP_UUID:1 è€Œå†²çªæ£€æµ‹æ•°æ®åº“ä¸­id=2è¿™ä¸€è¡Œçš„ç‰ˆæœ¬æ˜¯GROUP_UUID:1-2, æ‰€ä»¥è¿™æ¡æ’å…¥ä¼šå†²çªæ£€æµ‹å¤±è´¥å›æ»šæ‰ ä»¥ä¸Šæ˜¯æˆ‘çš„ç†è§£, ç›®å‰æ²¡æœ‰æµ‹è¯•","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MGR","slug":"MGR","permalink":"http://fuxkdb.com/tags/MGR/"}]},{"title":"è¯‘æ–‡ New Feature in Percona XtraDB Cluster 8.0 â€“ Streaming Replication","slug":"2020-05-16-è¯‘æ–‡-New-Feature-in-Percona-XtraDB-Cluster-8.0-â€“-Streaming-Replication","date":"2020-05-16T14:56:00.000Z","updated":"2020-05-17T03:10:38.334Z","comments":true,"path":"2020/05/16/2020-05-16-è¯‘æ–‡-New-Feature-in-Percona-XtraDB-Cluster-8.0-â€“-Streaming-Replication/","link":"","permalink":"http://fuxkdb.com/2020/05/16/2020-05-16-%E8%AF%91%E6%96%87-New-Feature-in-Percona-XtraDB-Cluster-8.0-%E2%80%93-Streaming-Replication/","excerpt":"New Feature in Percona XtraDB Cluster 8.0 â€“ Streaming ReplicationPercona XtraDB Cluster 8.0é™„å¸¦äº†ä¸€ä¸ªå‡çº§çš„Galera 4.0åº“, å®ƒæä¾›äº†ä¸€ä¸ªæ–°ç‰¹æ€§â€”Streaming Replication.è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆ, ä»€ä¹ˆæ—¶å€™å¯èƒ½æœ‰ç”¨ ä»¥å‰ç‰ˆæœ¬çš„Percona XtraDBé›†ç¾¤å’ŒGalera 3.xåœ¨å¤„ç†å¤§äº‹åŠ¡æ–¹é¢æœ‰é™åˆ¶. è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹sysbench-tpccå·¥ä½œè´Ÿè½½ä¸‹çš„æ€§èƒ½, ä¸æ­¤åŒæ—¶, æˆ‘ä»¬å¯¹ä¸€ä¸ªè¡¨æ‰§è¡Œäº†ä¸€ä¸ªå¤§çš„æ›´æ–°è¯­å¥, è¯¥æ›´æ–°ç”šè‡³ä¸ä¸»å·¥ä½œè´Ÿè½½ä¸­çš„è¡¨éƒ½ä¸ç›¸å…³.","text":"New Feature in Percona XtraDB Cluster 8.0 â€“ Streaming ReplicationPercona XtraDB Cluster 8.0é™„å¸¦äº†ä¸€ä¸ªå‡çº§çš„Galera 4.0åº“, å®ƒæä¾›äº†ä¸€ä¸ªæ–°ç‰¹æ€§â€”Streaming Replication.è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆ, ä»€ä¹ˆæ—¶å€™å¯èƒ½æœ‰ç”¨ ä»¥å‰ç‰ˆæœ¬çš„Percona XtraDBé›†ç¾¤å’ŒGalera 3.xåœ¨å¤„ç†å¤§äº‹åŠ¡æ–¹é¢æœ‰é™åˆ¶. è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹sysbench-tpccå·¥ä½œè´Ÿè½½ä¸‹çš„æ€§èƒ½, ä¸æ­¤åŒæ—¶, æˆ‘ä»¬å¯¹ä¸€ä¸ªè¡¨æ‰§è¡Œäº†ä¸€ä¸ªå¤§çš„æ›´æ–°è¯­å¥, è¯¥æ›´æ–°ç”šè‡³ä¸ä¸»å·¥ä½œè´Ÿè½½ä¸­çš„è¡¨éƒ½ä¸ç›¸å…³. Without Streaming ReplicationLetâ€™s run two workloads. sysbench-tpcc workload with 1 sec resolution In parallel run UPDATE oltp.sbtest SET k=k+1 LIMIT 1000000 Running update: 123mysql&gt; update sbtest1 set k=k+1 limit 1000000;Query OK, 1000000 rows affected (34.48 sec)Rows matched: 1000000 Changed: 1000000 Warnings: 0 Check what is happening in sysbench-tpcc: 123456789101112131415161718192021222324252627[ 77s ] thds: 100 tps: 7011.97 qps: 198248.21 (r/w/o: 90469.64/93758.63/14019.94) lat (ms,95%): 25.28 err/s 31.00 reconn/s: 0.00[ 78s ] thds: 100 tps: 6779.94 qps: 196129.34 (r/w/o: 89462.24/93103.21/13563.88) lat (ms,95%): 26.20 err/s 30.00 reconn/s: 0.00[ 79s ] thds: 100 tps: 6948.01 qps: 199157.35 (r/w/o: 90878.16/94383.16/13896.02) lat (ms,95%): 26.20 err/s 28.00 reconn/s: 0.00[ 80s ] thds: 100 tps: 3920.09 qps: 113882.48 (r/w/o: 51940.13/54102.18/7840.17) lat (ms,95%): 27.17 err/s 15.00 reconn/s: 0.00[ 81s ] thds: 100 tps: 67.00 qps: 1956.02 (r/w/o: 899.01/923.01/134.00) lat (ms,95%): 623.33 err/s 0.00 reconn/s: 0.00[ 82s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 83s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 84s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 85s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 86s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 87s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 88s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 89s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 90s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 91s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 92s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 93s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 94s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 95s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 96s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 97s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 98s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 99s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 100s ] thds: 100 tps: 0.00 qps: 0.00 (r/w/o: 0.00/0.00/0.00) lat (ms,95%): 0.00 err/s 0.00 reconn/s: 0.00[ 101s ] thds: 100 tps: 3501.85 qps: 99695.66 (r/w/o: 45473.02/47218.94/7003.70) lat (ms,95%): 257.95 err/s 14.00 reconn/s: 0.00[ 102s ] thds: 100 tps: 6980.06 qps: 197777.73 (r/w/o: 90228.79/93588.82/13960.12) lat (ms,95%): 25.74 err/s 33.00 reconn/s: 0.00[ 103s ] thds: 100 tps: 6745.15 qps: 196518.25 (r/w/o: 89717.94/93310.02/13490.29) lat (ms,95%): 26.68 err/s 46.00 reconn/s: 0.00 æ›´æ–°æœ¬èº«èŠ±äº†34ç§’. åœ¨è¿™ç§æƒ…å†µä¸‹, ä¸»å·¥ä½œè´Ÿè½½åœæ­¢äº†22ç§’. åŸºæœ¬ä¸Šæ‰€æœ‰è¯­å¥åœ¨è¿™æ®µæ—¶é—´éƒ½è¢«æš‚åœ/é˜»å¡äº† With Streaming Replicationå¦‚ä½•é€šè¿‡streaming replicationæ”¹è¿›è¿™ä¸€ç‚¹? è®©æˆ‘ä»¬åœ¨æ‰§è¡Œæ›´æ–°è¯­å¥çš„ä¼šè¯ä¸­å¯ç”¨streaming replication 12SET SESSION wsrep_trx_fragment_unit=&#x27;rows&#x27;;SET SESSION wsrep_trx_fragment_size=1000; åŸºæœ¬ä¸Š, æˆ‘ä»¬è¯´é›†ç¾¤åº”è¯¥å°†å¤§äº‹åŠ¡åˆ†å‰²æˆå¤šä¸ªå—, æ¯ä¸ªå—1000è¡Œ, ç„¶ååœ¨è¿™äº›è¾ƒå°çš„å—ä¸­è¿›è¡Œå¤åˆ¶.wsrep_trx_fragment_unitè¿˜å¯ä»¥è®¾ç½®ä¸º â€˜rowsâ€™ , â€˜bytesâ€™ æˆ– â€˜statementsâ€™, å°±æ˜¯å¯ä»¥æŒ‰è¡Œæ•°, binlogå­—èŠ‚æ•°, è¯­å¥æ•°é‡è¿›è¡Œæ§åˆ¶ 1&gt;wsrep_trx_fragment_unit Defines the replication unit type to use in Streaming Replication. Command-line Format --wsrep-trx-fragment-unit System Variable wsrep_trx_fragment_unit Variable Scope Session Dynamic Variable Yes Permitted Values String Default Value bytes Valid Values bytes, events, rows, statements Initial Version Version 4.0 In Streaming Replication, the node breaks transactions down into fragments, then replicates and certifies them while the transaction is in progress. Once certified, a fragment can no longer be aborted due to conflicting transactions. This parameter determines the unit to use in determining the size of the fragment. To define the number of replication units to use in the fragment, use wsrep_trx_fragment_size. Supported replication units are: bytes: Refers to the fragment size in bytes. events: Refers to the number of binary log events in the fragment. rows: Refers to the number of rows updated in the fragment. statements: Refers to the number of SQL statements in the fragment. And run the query: 123mysql&gt; update sbtest1 set k=k+1 limit 1000000;Query OK, 1000000 rows affected (39.76 sec)Rows matched: 1000000 Changed: 1000000 Warnings: 0 In sysbench-tpcc: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849[ 81s ] thds: 100 tps: 6682.94 qps: 188552.70 (r/w/o: 85967.65/89221.16/13363.88) lat (ms,95%): 26.68 err/s 32.98 reconn/s: 0.00[ 82s ] thds: 100 tps: 6700.92 qps: 192216.77 (r/w/o: 87715.23/91103.70/13397.84) lat (ms,95%): 27.17 err/s 27.01 reconn/s: 0.00[ 83s ] thds: 100 tps: 3835.05 qps: 108387.43 (r/w/o: 49408.65/51302.68/7676.10) lat (ms,95%): 82.96 err/s 15.00 reconn/s: 0.00[ 84s ] thds: 100 tps: 2210.13 qps: 63161.58 (r/w/o: 28852.64/29888.70/4420.25) lat (ms,95%): 95.81 err/s 9.00 reconn/s: 0.00[ 85s ] thds: 100 tps: 2558.00 qps: 72592.08 (r/w/o: 33093.04/34383.04/5116.01) lat (ms,95%): 87.56 err/s 9.00 reconn/s: 0.00[ 86s ] thds: 100 tps: 2617.99 qps: 75127.81 (r/w/o: 34299.91/35591.91/5235.99) lat (ms,95%): 78.60 err/s 9.00 reconn/s: 0.00[ 87s ] thds: 100 tps: 2887.75 qps: 81760.97 (r/w/o: 37312.79/38672.68/5775.50) lat (ms,95%): 73.13 err/s 15.00 reconn/s: 0.00[ 88s ] thds: 100 tps: 3024.00 qps: 84461.96 (r/w/o: 38606.98/39806.98/6048.00) lat (ms,95%): 69.29 err/s 15.00 reconn/s: 0.00[ 89s ] thds: 100 tps: 3119.27 qps: 91128.99 (r/w/o: 41566.65/43323.80/6238.55) lat (ms,95%): 63.32 err/s 9.00 reconn/s: 0.00[ 90s ] thds: 100 tps: 3385.74 qps: 98314.42 (r/w/o: 44883.54/46659.40/6771.48) lat (ms,95%): 56.84 err/s 14.00 reconn/s: 0.00[ 91s ] thds: 100 tps: 3641.08 qps: 103916.20 (r/w/o: 47422.00/49212.04/7282.15) lat (ms,95%): 54.83 err/s 21.00 reconn/s: 0.00[ 92s ] thds: 100 tps: 3850.12 qps: 106013.43 (r/w/o: 48296.56/50021.62/7695.25) lat (ms,95%): 57.87 err/s 23.00 reconn/s: 0.00[ 93s ] thds: 100 tps: 3828.07 qps: 111682.90 (r/w/o: 51005.87/53015.90/7661.13) lat (ms,95%): 54.83 err/s 22.00 reconn/s: 0.00[ 94s ] thds: 100 tps: 4358.95 qps: 122173.63 (r/w/o: 55746.37/57709.35/8717.90) lat (ms,95%): 42.61 err/s 14.00 reconn/s: 0.00[ 95s ] thds: 100 tps: 4367.09 qps: 123297.63 (r/w/o: 56193.20/58370.24/8734.19) lat (ms,95%): 44.98 err/s 16.00 reconn/s: 0.00[ 96s ] thds: 100 tps: 4272.92 qps: 118822.67 (r/w/o: 54076.94/56201.90/8543.83) lat (ms,95%): 46.63 err/s 24.00 reconn/s: 0.00[ 97s ] thds: 100 tps: 4697.88 qps: 133071.68 (r/w/o: 60676.49/62997.43/9397.77) lat (ms,95%): 38.25 err/s 17.00 reconn/s: 0.00[ 98s ] thds: 100 tps: 4742.21 qps: 135167.87 (r/w/o: 61693.68/63989.78/9484.41) lat (ms,95%): 37.56 err/s 21.00 reconn/s: 0.00[ 99s ] thds: 100 tps: 4949.89 qps: 139343.00 (r/w/o: 63616.63/65826.58/9899.79) lat (ms,95%): 36.24 err/s 21.00 reconn/s: 0.00[ 100s ] thds: 100 tps: 4766.10 qps: 139554.99 (r/w/o: 63695.37/66327.42/9532.20) lat (ms,95%): 36.89 err/s 18.00 reconn/s: 0.00[ 101s ] thds: 100 tps: 5069.91 qps: 143318.44 (r/w/o: 65310.83/67867.79/10139.82) lat (ms,95%): 35.59 err/s 13.00 reconn/s: 0.00[ 102s ] thds: 100 tps: 4947.06 qps: 140053.63 (r/w/o: 63820.74/66338.77/9894.12) lat (ms,95%): 36.24 err/s 23.00 reconn/s: 0.00[ 103s ] thds: 100 tps: 5045.00 qps: 145397.93 (r/w/o: 66328.97/68978.97/10090.00) lat (ms,95%): 34.33 err/s 18.00 reconn/s: 0.00[ 104s ] thds: 100 tps: 5139.02 qps: 141954.54 (r/w/o: 64723.25/66953.25/10278.04) lat (ms,95%): 36.24 err/s 28.00 reconn/s: 0.00[ 105s ] thds: 100 tps: 5214.90 qps: 147582.10 (r/w/o: 67371.68/69780.63/10429.80) lat (ms,95%): 34.33 err/s 25.00 reconn/s: 0.00[ 106s ] thds: 100 tps: 4924.08 qps: 139603.33 (r/w/o: 63673.06/66082.10/9848.16) lat (ms,95%): 36.24 err/s 23.00 reconn/s: 0.00[ 107s ] thds: 100 tps: 5202.97 qps: 147199.09 (r/w/o: 67176.58/69616.57/10405.94) lat (ms,95%): 34.33 err/s 30.00 reconn/s: 0.00[ 108s ] thds: 100 tps: 5219.91 qps: 147677.47 (r/w/o: 67416.84/69820.80/10439.82) lat (ms,95%): 33.72 err/s 28.00 reconn/s: 0.00[ 109s ] thds: 100 tps: 5018.99 qps: 143211.61 (r/w/o: 65365.82/67808.81/10036.97) lat (ms,95%): 36.24 err/s 23.00 reconn/s: 0.00[ 110s ] thds: 100 tps: 5070.16 qps: 142049.54 (r/w/o: 64817.07/67091.15/10141.32) lat (ms,95%): 34.95 err/s 17.00 reconn/s: 0.00[ 111s ] thds: 100 tps: 4954.87 qps: 141476.26 (r/w/o: 64529.29/67037.23/9909.74) lat (ms,95%): 35.59 err/s 25.00 reconn/s: 0.00[ 112s ] thds: 100 tps: 4827.12 qps: 140426.46 (r/w/o: 64103.58/66668.64/9654.24) lat (ms,95%): 35.59 err/s 19.00 reconn/s: 0.00[ 113s ] thds: 100 tps: 5027.00 qps: 145229.08 (r/w/o: 66179.04/68996.04/10054.01) lat (ms,95%): 34.33 err/s 26.00 reconn/s: 0.00[ 114s ] thds: 100 tps: 5099.87 qps: 144585.36 (r/w/o: 65976.34/68409.28/10199.74) lat (ms,95%): 34.33 err/s 26.00 reconn/s: 0.00[ 115s ] thds: 100 tps: 5010.11 qps: 143316.08 (r/w/o: 65356.40/67939.46/10020.22) lat (ms,95%): 34.95 err/s 26.00 reconn/s: 0.00[ 116s ] thds: 100 tps: 5056.00 qps: 143686.98 (r/w/o: 65621.99/67952.99/10112.00) lat (ms,95%): 34.95 err/s 31.00 reconn/s: 0.00[ 117s ] thds: 100 tps: 4908.95 qps: 141669.49 (r/w/o: 64653.31/67198.28/9817.90) lat (ms,95%): 36.24 err/s 21.00 reconn/s: 0.00[ 118s ] thds: 100 tps: 5039.07 qps: 142667.01 (r/w/o: 65056.92/67531.95/10078.14) lat (ms,95%): 34.33 err/s 24.00 reconn/s: 0.00[ 119s ] thds: 100 tps: 5076.89 qps: 143205.79 (r/w/o: 65195.54/67856.48/10153.77) lat (ms,95%): 35.59 err/s 18.00 reconn/s: 0.00[ 120s ] thds: 100 tps: 4909.09 qps: 137380.48 (r/w/o: 62539.13/65024.17/9817.18) lat (ms,95%): 34.95 err/s 13.00 reconn/s: 0.00[ 121s ] thds: 100 tps: 5024.93 qps: 144610.91 (r/w/o: 66027.05/68533.01/10050.85) lat (ms,95%): 35.59 err/s 23.00 reconn/s: 0.00[ 122s ] thds: 100 tps: 4874.10 qps: 138066.96 (r/w/o: 62942.35/65376.40/9748.21) lat (ms,95%): 35.59 err/s 16.00 reconn/s: 0.00[ 123s ] thds: 100 tps: 6745.83 qps: 187288.34 (r/w/o: 85354.88/88441.80/13491.66) lat (ms,95%): 28.67 err/s 27.00 reconn/s: 0.00[ 124s ] thds: 100 tps: 6132.03 qps: 172854.73 (r/w/o: 78867.33/81723.34/12264.05) lat (ms,95%): 29.19 err/s 18.00 reconn/s: 0.00[ 125s ] thds: 100 tps: 6114.99 qps: 175777.68 (r/w/o: 80098.85/83448.85/12229.98) lat (ms,95%): 30.26 err/s 39.00 reconn/s: 0.00[ 126s ] thds: 100 tps: 6206.87 qps: 179830.22 (r/w/o: 82043.28/85374.21/12412.74) lat (ms,95%): 29.72 err/s 29.00 reconn/s: 0.00[ 127s ] thds: 100 tps: 6441.25 qps: 181759.03 (r/w/o: 82799.20/86076.33/12883.50) lat (ms,95%): 28.67 err/s 28.00 reconn/s: 0.00[ 128s ] thds: 100 tps: 5925.87 qps: 169978.30 (r/w/o: 77565.31/80561.24/11851.74) lat (ms,95%): 30.81 err/s 32.00 reconn/s: 0.00[ 129s ] thds: 100 tps: 6614.92 qps: 186834.71 (r/w/o: 85216.96/88388.92/13228.84) lat (ms,95%): 27.66 err/s 24.00 reconn/s: 0.00 so è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆ: æ›´æ–°æŸ¥è¯¢èŠ±äº†æ›´é•¿çš„æ—¶é—´(39ç§’è€Œä¸æ˜¯34ç§’).ä¸»è¦å·¥ä½œè´Ÿè½½ä¹Ÿå—åˆ°äº†ä¸€äº›å½±å“(ä»6700 tpsä¸‹é™åˆ°æœ€åæ—¶æœŸçš„2210 tps), ä½†å¹¶æ²¡æœ‰å®Œå…¨åœæ­¢, è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ”¹è¿›. ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸åº”è¯¥é»˜è®¤ä¸ºæ‰€æœ‰äº‹åŠ¡å¯ç”¨streaming replication?åŸå› æ˜¯å®ƒå¯èƒ½ä¼šå¯¹å¸¸è§„çš„å°äº‹åŠ¡äº§ç”Ÿè´Ÿé¢å½±å“, æ‰€ä»¥å»ºè®®åªå¯¹å¤§å‹æˆ–é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ä½¿ç”¨streaming replication.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PXC","slug":"PXC","permalink":"http://fuxkdb.com/tags/PXC/"},{"name":"MySQL 8.0","slug":"MySQL-8-0","permalink":"http://fuxkdb.com/tags/MySQL-8-0/"},{"name":"Galera 4.0","slug":"Galera-4-0","permalink":"http://fuxkdb.com/tags/Galera-4-0/"}]},{"title":"è¯‘æ–‡ Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0","slug":"2020-05-16-[è¯‘æ–‡]Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8.0","date":"2020-05-16T14:40:00.000Z","updated":"2020-05-16T15:06:34.937Z","comments":true,"path":"2020/05/16/2020-05-16-[è¯‘æ–‡]Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8.0/","link":"","permalink":"http://fuxkdb.com/2020/05/16/2020-05-16-[%E8%AF%91%E6%96%87]Galera-4-Streaming-Replication-in-Percona-XtraDB-Cluster-8.0/","excerpt":"Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0æˆ‘æ­£åœ¨æµ‹è¯•æœ€æ–°çš„Percona XtraDB Cluster 8.0 (PXC)ç‰ˆæœ¬, å…¶ä¸­åŒ…å«äº†Galera 4æ’ä»¶, æˆ‘æƒ³åˆ†äº«ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢æˆ‘åœ¨Streaming Replicationç‰¹æ€§æ–¹é¢çš„ç»éªŒå’Œæƒ³æ³•, What Is Streaming Replication, in One Sentence?åœ¨Galera 4ä¸­, å¤§å‹äº‹åŠ¡å¯ä»¥åˆ†å‰²æˆæ›´å°çš„ç‰‡æ®µ, ç”šè‡³åœ¨æäº¤ä¹‹å‰, è¿™äº›ç‰‡æ®µå°±å·²ç»è¢«å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹, å¹¶ä¸”å·²ç»å¼€å§‹äº†è®¤è¯(certification)å’Œåº”ç”¨(apply)è¿‡ç¨‹. æ‰‹å†Œæè¿°äº†æ‰€æœ‰çš„ä¼˜ç‚¹å’Œç¼ºç‚¹, ä½†æ˜¯è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„. æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«1åƒä¸‡è¡Œçš„è¡¨, æˆ‘å°†åœ¨è¿™ä¸ªè¡¨ä¸Šè¿è¡Œä¸€äº›å¤§çš„updateè¯­å¥, é¦–å…ˆ, æˆ‘åœ¨ä¸ä½¿ç”¨Streaming Replicationçš„æƒ…å†µä¸‹è¿è¡Œæ›´æ–°, ç”±äºé»˜è®¤æƒ…å†µä¸‹Streaming Replicationæ˜¯disabled, æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…, åªéœ€è¿è¡Œæ›´æ–°å³å¯. åœ¨node1ä¸Š, æˆ‘è®°å½•æ›´æ–°ä¹‹å‰å’Œä¹‹åçš„æ—¶é—´, åœ¨node2ä¸Š, æˆ‘æ¯ç§’é’Ÿè¿è¡Œä¸€æ¬¡select, ä»¥æŸ¥çœ‹è¿™ä¸ªæ›´æ–°åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šå®é™…æäº¤çš„æ—¶é—´.","text":"Galera 4 Streaming Replication in Percona XtraDB Cluster 8.0æˆ‘æ­£åœ¨æµ‹è¯•æœ€æ–°çš„Percona XtraDB Cluster 8.0 (PXC)ç‰ˆæœ¬, å…¶ä¸­åŒ…å«äº†Galera 4æ’ä»¶, æˆ‘æƒ³åˆ†äº«ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢æˆ‘åœ¨Streaming Replicationç‰¹æ€§æ–¹é¢çš„ç»éªŒå’Œæƒ³æ³•, What Is Streaming Replication, in One Sentence?åœ¨Galera 4ä¸­, å¤§å‹äº‹åŠ¡å¯ä»¥åˆ†å‰²æˆæ›´å°çš„ç‰‡æ®µ, ç”šè‡³åœ¨æäº¤ä¹‹å‰, è¿™äº›ç‰‡æ®µå°±å·²ç»è¢«å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹, å¹¶ä¸”å·²ç»å¼€å§‹äº†è®¤è¯(certification)å’Œåº”ç”¨(apply)è¿‡ç¨‹. æ‰‹å†Œæè¿°äº†æ‰€æœ‰çš„ä¼˜ç‚¹å’Œç¼ºç‚¹, ä½†æ˜¯è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„. æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«1åƒä¸‡è¡Œçš„è¡¨, æˆ‘å°†åœ¨è¿™ä¸ªè¡¨ä¸Šè¿è¡Œä¸€äº›å¤§çš„updateè¯­å¥, é¦–å…ˆ, æˆ‘åœ¨ä¸ä½¿ç”¨Streaming Replicationçš„æƒ…å†µä¸‹è¿è¡Œæ›´æ–°, ç”±äºé»˜è®¤æƒ…å†µä¸‹Streaming Replicationæ˜¯disabled, æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…, åªéœ€è¿è¡Œæ›´æ–°å³å¯. åœ¨node1ä¸Š, æˆ‘è®°å½•æ›´æ–°ä¹‹å‰å’Œä¹‹åçš„æ—¶é—´, åœ¨node2ä¸Š, æˆ‘æ¯ç§’é’Ÿè¿è¡Œä¸€æ¬¡select, ä»¥æŸ¥çœ‹è¿™ä¸ªæ›´æ–°åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šå®é™…æäº¤çš„æ—¶é—´.On the writer: 1234567891011121314151617node1-T1 mysql&gt; select now();update sbtest1 set k=1 where id &lt; 1000000;select now();+---------------------+| now() |+---------------------+| 2020-03-24 14:25:20 |+---------------------+1 row in set (0.00 sec)Query OK, 999997 rows affected (34.53 sec)Rows matched: 999997 Changed: 999997 Warnings: 0+---------------------+| now() |+---------------------+| 2020-03-24 14:25:54 |+---------------------+1 row in set (0.00 sec) è¿è¡Œå’Œè¿™ä¸ªupdateè¯­å¥èŠ±è´¹äº†å¤§çº¦34ç§’ Check the other node: 12345678910+---------------------+| now() |+---------------------+| 2020-03-24 14:26:22 |+---------------------++---+| k |+---+| 1 |+---+ æ­£å¦‚æˆ‘æ‰€è¯´, æˆ‘æ¯ç§’é’Ÿéƒ½åœ¨è¿è¡Œä¸€ä¸ªæŸ¥è¯¢, ä»¥æŸ¥çœ‹kä½•æ—¶å˜ä¸º1. node2èŠ±äº†28ç§’çš„æ—¶é—´æ¥éªŒè¯ã€åº”ç”¨å’Œæäº¤è¿™ä¸ªæ›´æ–°. é‡è¦çš„æ˜¯è¦ç†è§£, å½“èŠ‚ç‚¹æ­£åœ¨éªŒè¯è¿™ä¸ªå¤§æ›´æ–°æ—¶, ä»»ä½•å…¶ä»–è¡¨ä¸Šçš„æ‰€æœ‰å…¶ä»–æ›´æ”¹éƒ½å°†è¢«é˜»å¡, å› æ­¤è¯¥èŠ‚ç‚¹å°†åœæ»/å†»ç»“è¿‘30ç§’. Will Streaming Replication Decrease This Delay?ç†è®ºä¸Š, å…¶ä»–èŠ‚ç‚¹åº”è¯¥å¯ä»¥æ›´å¿«åœ°è¿›è¡Œæ›´æ–°, å› ä¸ºå½“æ›´æ–°åœ¨node1ä¸Šè¿è¡Œæ—¶, ç‰‡æ®µ(fragments æŒ‡äº‹åŠ¡çš„éƒ¨åˆ†binlog)å·²ç»è¢«å¤åˆ¶å¹¶åº”ç”¨åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Š, æˆ‘å°†æŠŠç‰‡æ®µå¤§å°è®¾ç½®ä¸º1MB, 12345678910111213141516171819set session wsrep_trx_fragment_size=1048576; node1-T1 mysql&gt; select now();update sbtest1 set k=2 where id &lt; 1000000;select now();+---------------------+| now() |+---------------------+| 2020-03-24 14:44:08 |+---------------------+1 row in set (0.00 sec) Query OK, 999997 rows affected (40.08 sec)Rows matched: 999997 Changed: 999997 Warnings: 0 +---------------------+| now() |+---------------------+| 2020-03-24 14:44:48 |+---------------------+1 row in set (0.00 sec) ç°åœ¨è¿™ä¸ªæ›´æ–°è¦è·‘40s, æˆ‘ä»¬çœ‹çœ‹å…¶ä»–èŠ‚ç‚¹. 12345678910+---------------------+| now() |+---------------------+| 2020-03-24 14:44:48 |+---------------------++---+| k |+---+| 2 |+---+ åœ¨åŒä¸€ç§’å†…, kåœ¨node2ä¸Šä¹Ÿå·²ç»æ˜¯2äº†, æˆ‘ä»¬ä¸å†æœ‰28ç§’çš„å»¶è¿Ÿ, è¿™å¾ˆå¥½, ä½†æ˜¯è¿™ä¸ªuupdateè¯­å¥æœ¬èº«å˜æ…¢äº†ä¸€ç‚¹, æˆ‘å¤šæ¬¡è¿è¡Œè¿™äº›æ›´æ–°, åœ¨æ²¡æœ‰Streaming Replicationçš„æƒ…å†µä¸‹æ€»æ˜¯æ›´å¿«, ä½†æ˜¯å¯¹äºå¤§å‹äº‹åŠ¡, æˆ‘æ›´å–œæ¬¢æµå¤åˆ¶, å› ä¸ºå…¶ä»–èŠ‚ç‚¹ä¸ä¼šä¸å†™èŠ‚ç‚¹(æ‰§è¡Œæ›´æ–°è¯­å¥çš„èŠ‚ç‚¹)å·®çš„å¤ªè¿œ. Why Could It Be Slower With Streaming Replication?å…¶ä¸­ä¸€ä¸ªåŸå› å¯èƒ½æ˜¯, ä½¿ç”¨Streaming Replicationæ—¶, GaleraåŸºæœ¬ä¸Šä¼šå†™ä¸¤ä»½write-sets.å®ƒåœ¨mysql.wsrep_streaming_logä¸­è®°å½•write-sets, ä»¥ç¡®ä¿åœ¨å‘ç”Ÿå´©æºƒçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¿›è¡ŒStreaming Replication updates.è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸ºæ‰€æœ‰æŸ¥è¯¢å¯ç”¨æµå¤åˆ¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„çš„åŸå› . Does the Fragment Size Matter?Letâ€™s change the fragment size to 0.1MB: 1234567891011121314151617181920node1-T1 mysql&gt; set session wsrep_trx_fragment_size=104857;Query OK, 0 rows affected (0.01 sec) node1-T1 mysql&gt; select now();update sbtest1 set k=5 where id &lt; 1000000;select now();+---------------------+| now() |+---------------------+| 2020-03-24 15:28:30 |+---------------------+1 row in set (0.00 sec) Query OK, 999997 rows affected (51.21 sec)Rows matched: 999997 Changed: 999997 Warnings: 0 +---------------------+| now() |+---------------------+| 2020-03-24 15:29:21 |+---------------------+1 row in set (0.00 sec) ç°åœ¨èŠ±äº†50å¤šç§’é’Ÿ, å› æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°gragment sizeå¾ˆé‡è¦. å½“æˆ‘å°†ç‰‡æ®µå¤§å°å¢åŠ åˆ°100MBæ—¶, æˆ‘ä¹Ÿè¿›è¡Œäº†æµ‹è¯•, åœ¨è¿™ç§æƒ…å†µä¸‹, æŸ¥è¯¢åˆèŠ±äº†40ç§’é’Ÿå·¦å³, ä½†å…¶ä»–èŠ‚ç‚¹éœ€è¦æ›´å¤šæ—¶é—´æ‰èƒ½èµ¶ä¸Š, å·®ä¸å¤š10ç§’é’Ÿå·¦å³. æ‰¾åˆ°æ­£ç¡®çš„ç‰‡æ®µå¤§å°å¾ˆé‡è¦, åœ¨æˆ‘çš„æµ‹è¯•ä¸­1MBæ˜¯å¯ä»¥æ¥å—çš„, ä½†æ˜¯æ‚¨ä¹Ÿå¯ä»¥å®šä¹‰è¡Œæ•°, å¦‚æ¯10000è¡Œä¹‹ååˆ›å»ºç‰‡æ®µ. Lockingåœ¨Galera 4ä¹‹å‰, é”æ²¡æœ‰ä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹. å¦‚æœæ‚¨åœ¨node1ä¸Šè¿è¡ŒæŸ¥è¯¢, åˆ™InnoDBä»…åœ¨node1ä¸Šé”å®šäº†å¿…è¦çš„è¡Œ, ä½†æ˜¯node2å’Œnode3ä¸çŸ¥é“å“ªäº›è¡Œè¢«é”å®š. å¦‚æœæœ‰äººåœ¨å†™node2å’Œnode3, é‚£ä¹ˆGaleraå¿…é¡»å¤„ç†è¿™äº›å†²çª, åŸºæœ¬ä¸Šæ˜¯å…ˆæäº¤çš„äº‹åŠ¡è·èƒœ. å¦‚æœè¦åœ¨å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œå†™å…¥, åˆ™å¯èƒ½ä¼šæœ‰å¾ˆå¤šå†²çª. ä½†éšç€Streaming Replicationçš„å‡ºç°, è¿™ç§æƒ…å†µä¹Ÿå‘ç”Ÿäº†å˜åŒ–.ç‰‡æ®µè¢«å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹, å®ƒä»¬ä¹Ÿå°†åœ¨é‚£é‡ŒæŒæœ‰å¿…è¦çš„é”. Letâ€™s see how this works, first without Streaming Replication, step by step. åœ¨node1å’Œnode2ä¸Šå¯åŠ¨äº‹åŠ¡, åœ¨node1ä¸Šè¿è¡Œå¤§å‹æ›´æ–°, åœ¨node2ä¸Šåˆ é™¤å•ä¸ªè¡Œ, ç„¶ååœ¨node2ä¸Šæäº¤äº‹åŠ¡.å½“æˆ‘åœ¨node1ä¸Šæäº¤æ—¶, æˆ‘å¾—åˆ°ä¸€ä¸ªæ­»é”: 1234567891011121314node1-T1 mysql&gt; begin;node2-T1 mysql&gt; begin;node1-T1 mysql&gt; update sbtest1 set k=8 where id &lt; 1000000;Query OK, 999997 rows affected (27.87 sec)Rows matched: 999997 Changed: 999997 Warnings: 0node2-T1 mysql&gt; delete from sbtest1 where id=12;Query OK, 1 row affected (0.01 sec)node2-T1 mysql&gt; commit;Query OK, 0 rows affected (0.00 sec)node1-T1 mysql&gt; commit;ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction å› ä¸ºæ²¡æœ‰é›†ç¾¤èŒƒå›´çš„é”å®š, æ‰€ä»¥åœ¨æœ¬ä¾‹ä¸­, å®ƒå°†ä½¿ç”¨ä¹è§‚é”å®š, å¹¶åœ¨è®¤è¯è¿‡ç¨‹ä¸­è·å¾—ä¸€ä¸ªé”™è¯¯. How Does This Work With Streaming Replication? Repeat the same steps: 123456789101112131415161718node1-T1 mysql&gt; set session wsrep_trx_fragment_size=1048570;Query OK, 0 rows affected (0.00 sec)node1-T1 mysql&gt; begin;Query OK, 0 rows affected (0.00 sec)node2-T1 mysql&gt; begin;Query OK, 0 rows affected (0.00 sec)node2-T1 mysql&gt; update sbtest1 set k=9 where id &lt; 1000000;Query OK, 999996 rows affected (38.15 sec)Rows matched: 999996 Changed: 999996 Warnings: 0node2-T1 mysql&gt; delete from sbtest1 where id=13;Waiting.....node1-T1 mysql&gt; commit;Query OK, 0 rows affected (2.46 sec)node2-T1 mysql&gt; commit;Query OK, 0 rows affected (0.00 sec) åŒæ ·çš„æ­¥éª¤, ä½†æ˜¯å½“æˆ‘ä»¬è¯•å›¾åœ¨node2ä¸Šè¿è¡Œdeleteæ—¶, å®ƒåªæ˜¯hangåœ¨é‚£é‡Œ, ç­‰å¾…è·å–é”, ä½†æ˜¯è¢«æ¥è‡ªnode1çš„æ›´æ–°è¯­å¥äº§ç”Ÿçš„é”é˜»å¡äº†, è¿™æ­£æ˜¯å› ä¸ºStreaming Replication.å½“æˆ‘åœ¨node1ä¸Šæäº¤äº‹åŠ¡æ—¶, node2å¯ä»¥ç»§ç»­è¿è¡Œdeleteè¯­å¥äº†.è¿™å¯ä»¥å°†æˆ‘ä»¬ä»è®¸å¤šåƒµå±€å’Œå†²çªä¸­è§£æ•‘å‡ºæ¥.æŸ¥è¯¢å¯èƒ½å¿…é¡»ç­‰å¾…é”, ä½†æœ€ç»ˆå®ƒä»¬ä»ç„¶ä¼šå®Œæˆ. è¿™å¬èµ·æ¥å¾ˆå¥½, ä½†æˆ‘ä»ç„¶ä¸å»ºè®®å°†Streaming Replicationä½œä¸ºé»˜è®¤è®¾ç½®å¯ç”¨, å› ä¸ºå®ƒä¼šå½±å“æ€§èƒ½, è€Œä¸”å®ƒä¼šå°†æ‰€æœ‰å†…å®¹é‡å¤å†™å…¥mysql.wsrep_streaming_logè¡¨.æ­¤å¤–, å¦‚æœæ‚¨æƒ³å›æ»šä¸€ä¸ªå¤§äº‹åŠ¡, é‚£ä¹ˆå®ƒå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ, è€Œä¸æ˜¯åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œ. Metrics/Monitoringæœ‰ä¸€ä¸ªè¡¨å«åšmysql.wsrep_streaming_log, å…¶ä¸­åŒ…å«å…³äºå½“å‰æ­£åœ¨è¿è¡Œçš„æµçš„ä¿¡æ¯. 123456node1-T1 mysql&gt; SELECT node_uuid, trx_id, seqno, flags FROM mysql.wsrep_streaming_log;+--------------------------------------+--------+-------+-------+| node_uuid | trx_id | seqno | flags |+--------------------------------------+--------+-------+-------+| 9d7f7e09-6d20-11ea-842b-26b6d24e606d | 8571 | 24712 | 1 |+--------------------------------------+--------+-------+-------+ ä½†æ˜¯è¦å°å¿ƒ, å› ä¸ºåä¸ºfragçš„åˆ—åŒ…å«æ•´ä¸ªäºŒè¿›åˆ¶æ—¥å¿—å¤åˆ¶äº‹ä»¶, è¿™ä¸ªäº‹ä»¶å¯èƒ½éå¸¸å¤§.åœ¨æˆ‘æ„è¯†åˆ°è¿™ä¸€ç‚¹ä¹‹å‰, æˆ‘å¾—åˆ°äº†ä»¥ä¸‹é”™è¯¯: 12node1-T1 mysql&gt; select * from mysql.wsrep_streaming_log;ERROR 2020 (HY000): Got packet bigger than &#x27;max_allowed_packet&#x27; bytes ä¸å¹¸çš„æ˜¯, æ®æˆ‘æ‰€çŸ¥, æ²¡æœ‰è®¡æ•°å™¨æ¥ç›‘è§†é€šè¿‡Streaming Replicationå¤åˆ¶äº†å¤šå°‘è¯­å¥.ä¸ºæ­¤, æˆ‘åˆ›å»ºäº†ä¸€ä¸ªfeature request. Conclusionåˆ°ç›®å‰ä¸ºæ­¢, Streaming Replicationæ•ˆæœå¾ˆå¥½, æˆ‘è®¤ä¸ºå®ƒå…·æœ‰å·¨å¤§çš„æ½œåŠ›. å› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨ä¼šè¯çº§å¯ç”¨å®ƒ, æ‰€ä»¥æ‚¨è‡ªå·±æˆ–åº”ç”¨ç¨‹åºå¯ä»¥åœ¨éœ€è¦æ—¶è½»æ¾æ‰“å¼€å®ƒ, but I am also waiting to see real-life experiences with it.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PXC","slug":"PXC","permalink":"http://fuxkdb.com/tags/PXC/"},{"name":"MySQL 8.0","slug":"MySQL-8-0","permalink":"http://fuxkdb.com/tags/MySQL-8-0/"},{"name":"Galera 4.0","slug":"Galera-4-0","permalink":"http://fuxkdb.com/tags/Galera-4-0/"}]},{"title":"è¯‘æ–‡-A Simple Approach to Troubleshooting High CPU in MySQL","slug":"2020-05-03-A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL","date":"2020-05-03T04:21:00.000Z","updated":"2020-05-03T04:27:52.057Z","comments":true,"path":"2020/05/03/2020-05-03-A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL/","link":"","permalink":"http://fuxkdb.com/2020/05/03/2020-05-03-A-Simple-Approach-to-Troubleshooting-High-CPU-in-MySQL/","excerpt":"A Simple Approach to Troubleshooting High CPU in MySQL - åœ¨MySQLä¸­å¯¹é«˜CPUè¿›è¡Œæ•…éšœæ’é™¤çš„ç®€å•æ–¹æ³•æˆ‘ä»¬çš„ä¸€ä½å®¢æˆ·æœ€è¿‘é—®ï¼Œæ˜¯å¦æœ‰å¯èƒ½ä»MySQLæ–¹é¢è¯†åˆ«å¯¼è‡´ç³»ç»ŸCPUä½¿ç”¨ç‡é«˜çš„æŸ¥è¯¢ã€‚ PostgreSQLå’ŒOracle DBAé•¿æœŸä»¥æ¥ä¸€ç›´ä½¿ç”¨ç®€å•çš„OSå·¥å…·æŸ¥æ‰¾ç½ªé­ç¥¸é¦–ï¼Œä½†æ˜¯å®ƒå¯¹MySQLæ— æ•ˆï¼Œå› ä¸ºå†å²ä¸Šæˆ‘ä»¬ä¸€ç›´ç¼ºä¹å°†OSçº¿ç¨‹ä¸å†…éƒ¨çº¿ç¨‹è¿›è¡ŒåŒ¹é…çš„å·¥å…· - ç›´åˆ°æœ€è¿‘ã€‚ Perconaæ·»åŠ äº†æ”¯æŒï¼Œå¯ä»é’ˆå¯¹MySQL 5.6.27çš„Percona Serverå¼€å§‹ï¼Œé€šè¿‡information_schema.processlistè¡¨çš„TIDåˆ—å°†è¿›ç¨‹åˆ—è¡¨IDæ˜ å°„åˆ°OSçº¿ç¨‹IDã€‚ åœ¨5.7å‘è¡Œç‰ˆä¸­ï¼ŒMySQLæ‰©å±•äº†PERFORMANCE_SCHEMA.THREADSè¡¨å¹¶æ·»åŠ äº†ä¸€ä¸ªåä¸ºTHREAD_OS_IDçš„æ–°åˆ—ï¼Œä»è€Œå®ç°äº†è‡ªå·±çš„å®ç°ï¼ŒPercona Server for MySQLä»£æ›¿äº†è‡ªå·±çš„åˆ—ï¼Œå› ä¸ºå®ƒé€šå¸¸å°½å¯èƒ½åœ°é è¿‘ä¸Šæ¸¸ã€‚ å¯¹äºåœ¨å…¶ä»–å†…æ ¸æ­£å¸¸è¿è¡Œæ—¶æŸ¥è¯¢ä½¿ä¸€ä¸ªç‰¹å®šCPUè¿‡è½½çš„æƒ…å†µï¼Œä»¥ä¸‹æ–¹æ³•å¾ˆæœ‰ç”¨ã€‚ å¯¹äºä¸€èˆ¬çš„CPUä½¿ç”¨é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä¾‹å¦‚å¦ä¸€ç¯‡åšå®¢æ–‡ç« Reducing High CPU on MySQL: A Case Studyçš„æ–¹æ³•.","text":"A Simple Approach to Troubleshooting High CPU in MySQL - åœ¨MySQLä¸­å¯¹é«˜CPUè¿›è¡Œæ•…éšœæ’é™¤çš„ç®€å•æ–¹æ³•æˆ‘ä»¬çš„ä¸€ä½å®¢æˆ·æœ€è¿‘é—®ï¼Œæ˜¯å¦æœ‰å¯èƒ½ä»MySQLæ–¹é¢è¯†åˆ«å¯¼è‡´ç³»ç»ŸCPUä½¿ç”¨ç‡é«˜çš„æŸ¥è¯¢ã€‚ PostgreSQLå’ŒOracle DBAé•¿æœŸä»¥æ¥ä¸€ç›´ä½¿ç”¨ç®€å•çš„OSå·¥å…·æŸ¥æ‰¾ç½ªé­ç¥¸é¦–ï¼Œä½†æ˜¯å®ƒå¯¹MySQLæ— æ•ˆï¼Œå› ä¸ºå†å²ä¸Šæˆ‘ä»¬ä¸€ç›´ç¼ºä¹å°†OSçº¿ç¨‹ä¸å†…éƒ¨çº¿ç¨‹è¿›è¡ŒåŒ¹é…çš„å·¥å…· - ç›´åˆ°æœ€è¿‘ã€‚ Perconaæ·»åŠ äº†æ”¯æŒï¼Œå¯ä»é’ˆå¯¹MySQL 5.6.27çš„Percona Serverå¼€å§‹ï¼Œé€šè¿‡information_schema.processlistè¡¨çš„TIDåˆ—å°†è¿›ç¨‹åˆ—è¡¨IDæ˜ å°„åˆ°OSçº¿ç¨‹IDã€‚ åœ¨5.7å‘è¡Œç‰ˆä¸­ï¼ŒMySQLæ‰©å±•äº†PERFORMANCE_SCHEMA.THREADSè¡¨å¹¶æ·»åŠ äº†ä¸€ä¸ªåä¸ºTHREAD_OS_IDçš„æ–°åˆ—ï¼Œä»è€Œå®ç°äº†è‡ªå·±çš„å®ç°ï¼ŒPercona Server for MySQLä»£æ›¿äº†è‡ªå·±çš„åˆ—ï¼Œå› ä¸ºå®ƒé€šå¸¸å°½å¯èƒ½åœ°é è¿‘ä¸Šæ¸¸ã€‚ å¯¹äºåœ¨å…¶ä»–å†…æ ¸æ­£å¸¸è¿è¡Œæ—¶æŸ¥è¯¢ä½¿ä¸€ä¸ªç‰¹å®šCPUè¿‡è½½çš„æƒ…å†µï¼Œä»¥ä¸‹æ–¹æ³•å¾ˆæœ‰ç”¨ã€‚ å¯¹äºä¸€èˆ¬çš„CPUä½¿ç”¨é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä¾‹å¦‚å¦ä¸€ç¯‡åšå®¢æ–‡ç« Reducing High CPU on MySQL: A Case Studyçš„æ–¹æ³•. æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ–°åˆ—æ¥æ‰¾å‡ºå“ªä¸ªä¼šè¯ä½¿ç”¨äº†æ•°æ®åº“ä¸­æœ€å¤šçš„CPUèµ„æº?è®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼š è¦è§£å†³CPUé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡ ç§å·¥å…·ï¼Œä¾‹å¦‚topæˆ–pidstatï¼ˆéœ€è¦sysstatç¨‹åºåŒ…ï¼‰ã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨pidstatã€‚ è¯¥å·¥å…·æœ‰ä¸€ä¸ªé€‰é¡¹ï¼ˆ-tï¼‰ï¼Œå¯å°†å…¶è§†å›¾ä»è¿›ç¨‹ï¼ˆé»˜è®¤å€¼ï¼‰æ›´æ”¹ä¸ºçº¿ç¨‹ï¼Œåœ¨å…¶ä¸­æ˜¾ç¤ºç»™å®šè¿›ç¨‹å†…çš„å…³è”çº¿ç¨‹ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ‰¾å‡ºå“ªä¸ªçº¿ç¨‹åœ¨æœåŠ¡å™¨ä¸­æ¶ˆè€—äº†æœ€å¤šçš„CPUã€‚ å°†-på‚æ•°ä¸mysqlè¿›ç¨‹IDä¸€èµ·æ·»åŠ ï¼Œä»¥ä¾¿è¯¥å·¥å…·ä»…æ˜¾ç¤ºMySQLçº¿ç¨‹ï¼Œä»è€Œä½¿æˆ‘ä»¬æ›´å®¹æ˜“è¿›è¡Œæ•…éšœæ’é™¤ã€‚ æœ€åä¸€ä¸ªå‚æ•°ï¼ˆ1ï¼‰æ˜¯æ¯ç§’æ˜¾ç¤ºä¸€ä¸ªæ ·æœ¬ï¼š å‘½ä»¤ä¸ºpidstat -t -p &lt;mysqld_pid&gt; 1ï¼š 12345678910111213141516171819202122shell&gt; pidstat -t -p 31258 103:31:06 PM UID TGID TID %usr %system %guest %CPU CPU Command[...]03:31:07 PM 10014 - 32039 5.00 1.00 0.00 6.00 22 |__mysqld03:31:07 PM 10014 - 32040 5.00 1.00 0.00 6.00 23 |__mysqld03:31:07 PM 10014 - 32042 6.00 1.00 0.00 7.00 8 |__mysqld03:31:07 PM 10014 - 32047 5.00 1.00 0.00 6.00 6 |__mysqld03:31:07 PM 10014 - 32048 5.00 1.00 0.00 6.00 15 |__mysqld03:31:07 PM 10014 - 32049 5.00 1.00 0.00 6.00 14 |__mysqld03:31:07 PM 10014 - 32052 5.00 1.00 0.00 6.00 14 |__mysqld03:31:07 PM 10014 - 32053 94.00 0.00 0.00 94.00 9 |__mysqld03:31:07 PM 10014 - 32055 4.00 1.00 0.00 5.00 10 |__mysqld03:31:07 PM 10014 - 4275 5.00 1.00 0.00 6.00 10 |__mysqld03:31:07 PM 10014 - 4276 5.00 1.00 0.00 6.00 7 |__mysqld03:31:07 PM 10014 - 4277 6.00 1.00 0.00 7.00 15 |__mysqld03:31:07 PM 10014 - 4278 5.00 1.00 0.00 6.00 18 |__mysqld03:31:07 PM 10014 - 4279 5.00 1.00 0.00 6.00 10 |__mysqld03:31:07 PM 10014 - 4280 5.00 1.00 0.00 6.00 12 |__mysqld03:31:07 PM 10014 - 4281 5.00 1.00 0.00 6.00 11 |__mysqld03:31:07 PM 10014 - 4282 4.00 1.00 0.00 5.00 2 |__mysqld03:31:07 PM 10014 - 35261 0.00 0.00 0.00 0.00 4 |__mysqld03:31:07 PM 10014 - 36153 0.00 0.00 0.00 0.00 5 |__mysqld æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çº¿ç¨‹32053åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ¶ˆè€—äº†æœ€å¤šçš„CPUï¼Œå¹¶ä¸”æˆ‘ä»¬ç¡®ä¿éªŒè¯äº†åœ¨pidstatçš„å¤šä¸ªæ ·æœ¬ä¹‹é—´çš„æ¶ˆè€—æ˜¯å¦æ’å®šã€‚ åˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç™»å½•æ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢æ¥æ‰¾å‡ºå“ªä¸ªMySQL Threadæ˜¯ç½ªé­ç¥¸é¦–ï¼š 1234567891011121314151617181920mysql &gt; select * from performance_schema.threads where THREAD_OS_ID = 32053 \\G*************************** 1. row *************************** THREAD_ID: 686 NAME: thread/sql/one_connection TYPE: FOREGROUND PROCESSLIST_ID: 590 PROCESSLIST_USER: msandbox PROCESSLIST_HOST: localhost PROCESSLIST_DB: NULLPROCESSLIST_COMMAND: Query PROCESSLIST_TIME: 0 PROCESSLIST_STATE: Sending data PROCESSLIST_INFO: select * from test.joinit where b = &#x27;a a eveniet ut.&#x27; PARENT_THREAD_ID: NULL ROLE: NULL INSTRUMENTED: YES HISTORY: YES CONNECTION_TYPE: SSL/TLS THREAD_OS_ID: 320531 row in set (0.00 sec) å¥½äº†ï¼ ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼ŒCPUé«˜æ¶ˆè€—æ¥è‡ªjoinitè¡¨ä¸­çš„æŸ¥è¯¢ï¼Œè¯¥æŸ¥è¯¢ç”±æ•°æ®åº“æµ‹è¯•ä¸­æ¥è‡ªæœ¬åœ°ä¸»æœºçš„ç”¨æˆ·msandboxæ‰§è¡Œã€‚ ä½¿ç”¨æ­¤ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æŸ¥è¯¢è¿›è¡Œæ•…éšœæ’é™¤ï¼Œå¹¶ä½¿ç”¨EXPLAINå‘½ä»¤æ£€æŸ¥æ‰§è¡Œè®¡åˆ’ï¼Œä»¥æŸ¥çœ‹æ˜¯å¦è¿˜æœ‰ä»»ä½•æ”¹è¿›çš„ä½™åœ°ã€‚ 123456789101112131415mysql &gt; explain select * from test.joinit where b = &#x27;a a eveniet ut.&#x27; \\G*************************** 1. row *************************** id: 1 select_type: SIMPLE table: joinit partitions: NULL type: ALLpossible_keys: NULL key: NULL key_len: NULL ref: NULL rows: 7170836 filtered: 10.00 Extra: Using where1 row in set, 1 warning (0.00 sec) In this case, it was a simple index that was missing! 123mysql &gt; alter table test.joinit add index (b) ;Query OK, 0 rows affected (15.18 sec)Records: 0 Duplicates: 0 Warnings: 0 After we create the index, we are no longer seeing CPU spikes: 12345678910111213141516171819202122shell&gt; pidstat -t -p 31258 103:37:53 PM UID TGID TID %usr %system %guest %CPU CPU Command[...]03:37:54 PM 10014 - 32039 25.00 6.00 0.00 31.00 0 |__mysqld03:37:54 PM 10014 - 32040 25.00 5.00 0.00 30.00 21 |__mysqld03:37:54 PM 10014 - 32042 25.00 6.00 0.00 31.00 20 |__mysqld03:37:54 PM 10014 - 32047 25.00 4.00 0.00 29.00 23 |__mysqld03:37:54 PM 10014 - 32048 25.00 7.00 0.00 32.00 22 |__mysqld03:37:54 PM 10014 - 32049 23.00 6.00 0.00 29.00 4 |__mysqld03:37:54 PM 10014 - 32052 23.00 7.00 0.00 30.00 14 |__mysqld03:37:54 PM 10014 - 32053 10.00 2.00 0.00 12.00 11 |__mysqld03:37:54 PM 10014 - 32055 24.00 6.00 0.00 30.00 1 |__mysqld03:37:54 PM 10014 - 4275 25.00 6.00 0.00 31.00 7 |__mysqld03:37:54 PM 10014 - 4276 25.00 6.00 0.00 31.00 1 |__mysqld03:37:54 PM 10014 - 4277 24.00 5.00 0.00 29.00 14 |__mysqld03:37:54 PM 10014 - 4278 24.00 6.00 0.00 30.00 9 |__mysqld03:37:54 PM 10014 - 4279 25.00 5.00 0.00 30.00 6 |__mysqld03:37:54 PM 10014 - 4280 26.00 5.00 0.00 31.00 14 |__mysqld03:37:54 PM 10014 - 4281 24.00 6.00 0.00 30.00 10 |__mysqld03:37:54 PM 10014 - 4282 25.00 6.00 0.00 31.00 10 |__mysqld03:37:54 PM 10014 - 35261 0.00 0.00 0.00 0.00 4 |__mysqld03:37:54 PM 10014 - 36153 0.00 0.00 0.00 0.00 5 |__mysqld ä¸ºä»€ä¹ˆä¸ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥è§£å†³IOå’Œå†…å­˜é—®é¢˜?ä»OSç«¯æµ‹é‡çº¿ç¨‹IOçš„é—®é¢˜åœ¨äºï¼Œå¤§å¤šæ•°MySQL IOæ“ä½œæ˜¯ç”±åå°çº¿ç¨‹å®Œæˆçš„ï¼Œä¾‹å¦‚è¯»å–ï¼Œå†™å…¥å’Œé¡µé¢æ¸…ç†ç¨‹åºçº¿ç¨‹ã€‚ è¦æµ‹é‡çº¿ç¨‹IOï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¸¦æœ‰-dï¼ˆIOè€Œä¸æ˜¯CPUï¼‰é€‰é¡¹çš„pidstatæˆ–å¸¦æœ‰-Hï¼ˆæ¯ä¸ªçº¿ç¨‹ï¼‰çš„iostatä¹‹ç±»çš„å·¥å…·ã€‚ å¦‚æœæ‚¨æœ‰ä¸€ä¸ªéå¸¸æ¶ˆè€—IOçš„çº¿ç¨‹ï¼Œæ‚¨ä¹Ÿè®¸å¯ä»¥çœ‹åˆ°å®ƒï¼Œä½†æ˜¯è¦è­¦å‘Šï¼Œç”±äºåå°çº¿ç¨‹æ“ä½œï¼Œç»“æœå¯èƒ½ä¼šäº§ç”Ÿè¯¯å¯¼ã€‚ å†…å­˜æ¶ˆè€—æ˜¯è¦ä»OSç«¯è¡¡é‡çš„ä¸€ä¸ªæ›´åŠ æ£˜æ‰‹çš„èµ„æºï¼Œå› ä¸ºæ‰€æœ‰å†…å­˜éƒ½æ˜¯åœ¨MySQLè¿›ç¨‹ä¸‹åˆ†é…çš„ï¼Œå¹¶ä¸”ç”±äºæ˜¯MySQLç®¡ç†å…¶å†…å­˜è®¿é—®ï¼Œå› æ­¤å¯¹äºOSæ¥è¯´å“ªä¸ªçº¿ç¨‹æ¶ˆè€—æœ€å¤šçš„å†…å­˜æ˜¯é€æ˜çš„ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»5.7å¼€å§‹ä½¿ç”¨perfomance_schema memory instrumentation available starting in 5.7. ç»“è®ºæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è§£å†³CPUä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜ï¼Œä½†æ˜¯ä»5.7ç‰ˆå¼€å§‹ï¼Œæˆ‘ä»¬åœ¨Oracleå’ŒPostgreSQLæ•°æ®åº“ä¸Šæä¾›äº†ä¸€ç§ç®€å•ä¸”å¹¿æ³›ä½¿ç”¨çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥é€‚åº”MySQLã€‚ é€šè¿‡ä»OSçº¿ç¨‹æ¶ˆè€—è·Ÿè¸ªåˆ°æ•°æ®åº“ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ£€æµ‹åˆ°å½±å“ç³»ç»Ÿæ€§èƒ½çš„CPUå¯†é›†å‹æŸ¥è¯¢ã€‚","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"è¯‘æ–‡-Group Replication and Percona XtraDB Cluster: Overview of Common Operations","slug":"2020-05-03-è¯‘æ–‡-Group-Replication-and-Percona-XtraDB-Cluster-Overview-of-Common-Operations","date":"2020-05-03T04:20:00.000Z","updated":"2020-05-03T04:28:19.223Z","comments":true,"path":"2020/05/03/2020-05-03-è¯‘æ–‡-Group-Replication-and-Percona-XtraDB-Cluster-Overview-of-Common-Operations/","link":"","permalink":"http://fuxkdb.com/2020/05/03/2020-05-03-%E8%AF%91%E6%96%87-Group-Replication-and-Percona-XtraDB-Cluster-Overview-of-Common-Operations/","excerpt":"Group Replication and Percona XtraDB Cluster: Overview of Common Operationsåœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ¦‚è¿°ä½¿ç”¨MySQL Group Replication 8.0.19 (aka GR å›½å†…çˆ±å«MGRå‘ç°å›½å¤–è¿˜æ˜¯ä¹ æƒ¯å«GR)å’ŒPercona XtraDB Cluster 8 (PXC)(åŸºäºGalera)æ—¶æœ€å¸¸è§çš„æ•…éšœè½¬ç§»åœºæ™¯å’Œæ“ä½œï¼Œå¹¶è§£é‡Šæ¯ç§æŠ€æœ¯å¦‚ä½•å¤„ç†æ¯ç§æƒ…å†µã€‚æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œä½¿ç”¨ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œä¸€ä¸ªåŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹çš„PXCè¿›è¡Œç»„å¤åˆ¶ï¼Œå®ƒä»¬å‡ä½¿ç”¨é»˜è®¤å‚æ•°é…ç½®ã€‚ æˆ‘è¿˜å°†ä½¿ç”¨ProxySQLä¸ä¸¤ä¸ªç¾¤é›†è¿›è¡Œäº¤äº’ã€‚ åœ¨è¿™ä¸¤ä¸ªç¾¤é›†ä¸­ï¼ŒèŠ‚ç‚¹çš„åç§°åˆ†åˆ«ä¸ºmysql1ï¼Œmysql2å’Œmysql3ã€‚ åœ¨ç»„å¤åˆ¶ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å•ä¸»æ¨¡å¼ï¼Œåˆ™ä¸»èŠ‚ç‚¹å¤„ç†å†™è¯·æ±‚ã€‚ åœ¨PXCä¸­ï¼Œæˆ‘ä¹Ÿå°†ä½¿ç”¨ç›¸åŒçš„æœ¯è¯­ï¼Œå¹¶å°†åœ¨å‘é€å†™æ“ä½œçš„èŠ‚ç‚¹ç§°ä¸ºPrimaryã€‚ è¯·æ³¨æ„ï¼Œåœ¨PXCä¸­æ²¡æœ‰ä¸»èŠ‚ç‚¹çš„æ¦‚å¿µï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç›¸ç­‰çš„ã€‚","text":"Group Replication and Percona XtraDB Cluster: Overview of Common Operationsåœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ¦‚è¿°ä½¿ç”¨MySQL Group Replication 8.0.19 (aka GR å›½å†…çˆ±å«MGRå‘ç°å›½å¤–è¿˜æ˜¯ä¹ æƒ¯å«GR)å’ŒPercona XtraDB Cluster 8 (PXC)(åŸºäºGalera)æ—¶æœ€å¸¸è§çš„æ•…éšœè½¬ç§»åœºæ™¯å’Œæ“ä½œï¼Œå¹¶è§£é‡Šæ¯ç§æŠ€æœ¯å¦‚ä½•å¤„ç†æ¯ç§æƒ…å†µã€‚æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œä½¿ç”¨ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œä¸€ä¸ªåŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹çš„PXCè¿›è¡Œç»„å¤åˆ¶ï¼Œå®ƒä»¬å‡ä½¿ç”¨é»˜è®¤å‚æ•°é…ç½®ã€‚ æˆ‘è¿˜å°†ä½¿ç”¨ProxySQLä¸ä¸¤ä¸ªç¾¤é›†è¿›è¡Œäº¤äº’ã€‚ åœ¨è¿™ä¸¤ä¸ªç¾¤é›†ä¸­ï¼ŒèŠ‚ç‚¹çš„åç§°åˆ†åˆ«ä¸ºmysql1ï¼Œmysql2å’Œmysql3ã€‚ åœ¨ç»„å¤åˆ¶ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å•ä¸»æ¨¡å¼ï¼Œåˆ™ä¸»èŠ‚ç‚¹å¤„ç†å†™è¯·æ±‚ã€‚ åœ¨PXCä¸­ï¼Œæˆ‘ä¹Ÿå°†ä½¿ç”¨ç›¸åŒçš„æœ¯è¯­ï¼Œå¹¶å°†åœ¨å‘é€å†™æ“ä½œçš„èŠ‚ç‚¹ç§°ä¸ºPrimaryã€‚ è¯·æ³¨æ„ï¼Œåœ¨PXCä¸­æ²¡æœ‰ä¸»èŠ‚ç‚¹çš„æ¦‚å¿µï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç›¸ç­‰çš„ã€‚è¿™æ˜¯ä¸¤ç§è§£å†³æ–¹æ¡ˆçš„è®¾ç½®ç¤ºæ„å›¾ã€‚ Primary Server Crashes Group Replication â€“ Writingåœ¨æ­¤æµ‹è¯•ä¸­ï¼Œæˆ‘ä»…å‘é›†ç¾¤å‘é€å†™è¯·æ±‚ã€‚ å½“æˆ‘æ€æ­»GRä¸Šçš„ä¸»èŠ‚ç‚¹æ—¶ï¼Œé‡æ–°ç»„ç»‡æ‹“æ‰‘éœ€è¦èŠ±è´¹5åˆ°15ç§’çš„æ—¶é—´ï¼ŒProxySQLè¯†åˆ«æ–°çš„æ‹“æ‰‘ç»“æ„åå°†å†™å…¥å‘é€åˆ°æ–°çš„ä¸»èŠ‚ç‚¹ã€‚ å¯åŠ¨æ—§çš„ä¸»æ•°æ®åº“å¹¶å°†å…¶é‡æ–°æ·»åŠ åˆ°é›†ç¾¤ä¸­ä¸ä¼šå¯¼è‡´ä»»ä½•ä¸­æ–­(ä¸ä¼šå½±å“ä¸šåŠ¡)ã€‚ Group Replication â€“ Readingå¦‚æœæˆ‘ä»…å‘é›†ç¾¤å‘é€è¯»å–è¯·æ±‚ï¼Œä¸»èŠ‚ç‚¹å´©æºƒå°†å¯¼è‡´è¯»å–ä¸­æ–­å—ï¼Ÿ ProxySQLåªä¼šå°†æµé‡é‡å®šå‘åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ é‡ç»„æœŸé—´ä¸ä¼šé˜»å¡æŸ¥è¯¢ã€‚ Percona XtraDB Cluster â€“ Writing/Readingåœ¨PXCä¸­ï¼Œè¯»å–å’Œå†™å…¥ä¹‹é—´æ²¡æœ‰åŒºåˆ«ï¼Œä¸€æ—¦èŠ‚ç‚¹å´©æºƒ/æ¶ˆå¤±/åˆ†ç¦»(crashes/goes away/gets separated)ï¼Œç¾¤é›†å¿…é¡»é‡æ–°åˆ›å»ºç¾¤é›†è§†å›¾å¹¶æ£€æŸ¥ä»²è£ã€‚ è¿™æ ·åšæ—¶ï¼Œå®ƒä¸æ¥å—ä»»ä½•è¯»å–æˆ–å†™å…¥ã€‚ é€šå¸¸ï¼Œè¿™éœ€è¦3åˆ°10ç§’ï¼Œåœ¨æ­¤æ—¶é—´èŒƒå›´å†…ï¼Œåº”ç”¨ç¨‹åºä¼šå—åˆ°å½±å“ã€‚ Removing/Adding Nodeå¦‚æœæˆ‘ä»¬åˆ é™¤æˆ–æ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œé›†ç¾¤ä¼šå¦‚ä½•åšã€‚ Group Replicationåœ¨GRä¸­ï¼Œæ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹ä¸ä¼šå½±å“æˆ–å¯¼è‡´åº”ç”¨ç¨‹åºä¸­æ–­ã€‚ å¦‚æœæˆ‘ä»¬ä½¿ç”¨å…‹éš†æ’ä»¶æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œåˆ™é›†ç¾¤ä¼šå°†æ•°æ®ä¼ æ’­åˆ°æ–°èŠ‚ç‚¹ã€‚ Percona XtraDB Clusteråˆ é™¤æˆ–æ·»åŠ èŠ‚ç‚¹ä¸ä¼šå¯¼è‡´ä»»ä½•ä¸­æ–­ã€‚ ç±»ä¼¼åœ°ï¼Œå°±åƒåœ¨GRä¸­æ·»åŠ æ–°èŠ‚ç‚¹æ—¶ä¸€æ ·ï¼Œå®ƒå°†æ‰§è¡ŒSSTï¼ˆState Snapshot TransferçŠ¶æ€å¿«ç…§ä¼ è¾“ï¼‰ä»¥ä»å¦ä¸€ä¸ªèŠ‚ç‚¹è·å–æ‰€æœ‰æ•°æ®ã€‚ Partial Network Failureå¦‚æœè¯»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹åˆ†ç¦»ï¼Œä½†ä»èƒ½å¤Ÿçœ‹åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ™ç¾¤é›†ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œmysql2ï¼ˆä¸»ï¼‰å’Œmysql3ä¹‹é—´å­˜åœ¨ç½‘ç»œä¸­æ–­ã€‚ Group Replicationåœ¨æˆ‘ä¹‹å‰çš„ä¸€ç¯‡åšæ–‡MySQL Group Replication â€“ Partial Network Failure Performance Impactä¸­æˆ‘æ›´è¯¦ç»†åœ°è§£é‡Šäº†è¿™ä¸ªç‰¹æ®Šæƒ…å†µã€‚åŸºæœ¬ä¸Šï¼Œéƒ¨åˆ†ç½‘ç»œä¸­æ–­ä¼šä¸¥é‡å½±å“é›†ç¾¤ä¸­çš„å†™æ€§èƒ½ï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºé—®é¢˜å’Œ/æˆ–åœæœºã€‚ 8.0.19æœ‰bug,å®˜æ–¹å·²ç»å¤ç°å¹¶ç¡®è®¤bug, ä½†æ˜¯ä¸€ä¸ªæœ‹å‹æ²¡æœ‰å¤ç° ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º8.0.20, åœ¨release noteæ²¡æœ‰çœ‹åˆ°ä¿®å¤æ­¤bug Percona XtraDB Clusteråœ¨PXCä¸­ï¼Œå½“ç¾¤é›†é‡æ–°åˆ›å»ºç¾¤é›†è§†å›¾å¹¶å¼€å§‹å°†æµé‡ä¸­ç»§åˆ°å¯çœ‹åˆ°è¯¥æœåŠ¡å™¨çš„èŠ‚ç‚¹æ—¶ï¼Œå°†å‘ç”Ÿ3-5ç§’çš„ä¸­æ–­ã€‚ ä¹‹åï¼Œå®ƒå°†åƒä»¥å‰ä¸€æ ·ç»§ç»­å·¥ä½œï¼Œè€Œä¸ä¼šå¯¹æ€§èƒ½é€ æˆä»»ä½•ä¸¥é‡å½±å“ã€‚ In PXC there is going to be a 3-5s outage while the cluster re-creates the cluster view and begins relaying the traffic to a node that sees that server. After that, it will continue working just like before without any serious performance impact. Total Network Isolation ç°åœ¨ï¼Œmysql3ä¸æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å®Œå…¨åˆ†ç¦»ã€‚ Group Replicationç¾¤é›†å¯ä»¥æ¥å—è¯»å–å’Œå†™å…¥è€Œä¸ä¼šå‘ç”Ÿä»»ä½•ä¸­æ–­ï¼ŒProxySQLä¼šå°†è¯»å–é‡å®šå‘åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ Percona XtraDB Clusteråœ¨PXCä¸Šï¼Œå°†æœ‰3-5ç§’çš„åœæœºæ—¶é—´ï¼Œè€Œç¾¤é›†æ„è¯†åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå¹¶å°†å¦‚ä¸Šæ‰€è¿°é‡æ–°åˆ›å»ºç¾¤é›†è§†å›¾ã€‚ åœ¨é‚£ä¹‹åï¼Œå®ƒèƒ½å¤Ÿå¤„ç†è¯»å†™ã€‚ Local Applications å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æˆ–éƒ¨åˆ†èŠ‚ç‚¹ä¸é›†ç¾¤åˆ†å¼€(ç½‘ç»œåˆ†åŒº, 5èŠ‚ç‚¹é›†ç¾¤,å½¢æˆ3, 2ç»“æ„), é‚£ä¸ªå¯¹äºåˆ†åŒºä¸­çš„2ä¸ªèŠ‚ç‚¹, å¯èƒ½åº”ç”¨ä»ç„¶èƒ½å’Œå®ƒä»¬é€šä¿¡, æ­¤æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µ? What happens if a node or part of the nodes are separated and they do not have the quorum, but they have the application server in the same network segments which could still connect to the server. Group Replicationåˆ†ç¦»çš„èŠ‚ç‚¹ä»å°†æ¥å—è¯»å–æµé‡ï¼Œå› æ­¤åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®è¿‡æ—¶çš„æ•°æ®åšå‡ºå†³ç­–ã€‚ è¿™æ˜¯é»˜è®¤è®¾ç½®ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨åä¸ºgroup_replication_exit_state_actionçš„å‚æ•°åšå‡ºè°ƒæ•´ group_replication_exit_state_action Property Value Command-Line Format --group-replication-exit-state-action=value Introduced 8.0.12 System Variable group_replication_exit_state_action Scope Global Dynamic Yes SET_VAR Hint Applies No Type Enumeration Default Value (â‰¥ 8.0.16) READ_ONLY Default Value (â‰¥ 8.0.12, â‰¤ 8.0.15) ABORT_SERVER Valid Values (â‰¥ 8.0.18) ABORT_SERVER``OFFLINE_MODE``READ_ONLY Valid Values (â‰¥ 8.0.12, â‰¤ 8.0.17) ABORT_SERVER``READ_ONLY ABORT_SERVERèŠ‚ç‚¹å®ä¾‹ä¼šè¢«shutdown OFFLINE_MODEè¿æ¥çš„å®¢æˆ·ç«¯ç”¨æˆ·åœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶æ–­å¼€è¿æ¥ï¼Œä¸å†æ¥å—è¿æ¥ READ_ONLY å®ä¾‹å˜ä¸ºåªè¯»æ¨¡å¼ Percona XtraDB Clusteråœ¨PXCä¸­ï¼Œå¦‚æœèŠ‚ç‚¹åˆ†ç¦»ï¼Œåˆ™å®ƒå°†ä¸æ¥å—ä»»ä½•è¯»å–æˆ–å†™å…¥ã€‚ ä¼˜å…ˆçº§æ˜¯æ•°æ®ä¸€è‡´æ€§ï¼Œåªæœ‰å…·æœ‰quorumçš„segmentæ‰èƒ½æ¥å—ä»»ä½•è¯»å–å’Œå†™å…¥ã€‚ In PXC, if a node gets separated, it is not going to accept any reads or writes. The priority is the data consistency and only the segment which has the quorum will accept any reads and writes. Changing PrimaryGroup ReplicationIf you would like to use a new Primary node you have to promote a reader to be the new primary: 1cluster.setPrimaryInstance(&quot;mysql2:3306&quot;) ProxySQLå°†éµå¾ªè¿™äº›æ›´æ”¹ï¼Œä½†æ˜¯åœ¨ç¾¤é›†é‡æ–°ç»„ç»‡è‡ªèº«æ—¶ï¼Œå®ƒå°†å¯¼è‡´å‡ ç§’é’Ÿçš„ä¸­æ–­ã€‚ Percona XtraDB Clusteråœ¨PXCä¸Šæ²¡æœ‰Primaryçš„æ¦‚å¿µï¼Œä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥åœ¨ä»»ä½•æ—¶é—´è¿›è¡Œå†™æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å°†æµé‡é‡å®šå‘åˆ°è´Ÿè½½å‡è¡¡å™¨ä¸­çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå³ProxySQLï¼‰ã€‚ PXCä¸­è¿˜æœ‰ä¸€ä¸ªpxc_maint_modeå˜é‡ã€‚ å°†å…¶æ›´æ”¹ä¸ºMAINTENANCEå¯ä»¥ä»èŠ‚ç‚¹ä¸Šè½¯åˆ é™¤è¯¥è¿æ¥ï¼Œå³ä½¿è¯¥è¿æ¥æ˜¯Primaryï¼Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä½†æ˜¯ProxySQL Native Galeraæ”¯æŒå¯¹æ­¤çš„æ”¯æŒå¾ˆå·®ã€‚ I would recommend using the 1.4 scheduler which respects this variable. Summary Group Replication Percona XtraDB Cluster Primary Crashes 5-15s outage 5-10s outage Reader Crashes No impact 3-5s outage Adding a Node No impact No impact Removing a Node No impact No impact Partial Network Failure Performance Impact 3-5s outage, than normal performance Total Network Isolation No impact 3-5s outage Changing Primary 1-3s outage No impact on the cluster å¦‚æœè¯»å–èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæˆ–åˆ†ç¦»ï¼Œåˆ™ç»„å¤åˆ¶çš„å½±å“è¾ƒå°ã€‚ åœ¨PXCä¸­ï¼Œç”±äºæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒçš„ï¼Œå› æ­¤æ²¡æœ‰ä¸“ç”¨çš„ä¸»èŠ‚ç‚¹ã€‚ å¦‚æœä»»ä½•èŠ‚ç‚¹å‘ç”Ÿä»»ä½•äº‹æƒ…ï¼Œåˆ™é›†ç¾¤å¿…é¡»æŠ•ç¥¨å¹¶é‡æ–°åˆ›å»ºé›†ç¾¤è§†å›¾ï¼Œè¿™å¯èƒ½ä¼šå¯¹åº”ç”¨ç¨‹åºäº§ç”Ÿä¸€äº›å½±å“ã€‚ ä½†æ˜¯ï¼ŒPXCå¯ä»¥æ›´å¥½åœ°å¤„ç†ä¸»èŠ‚ç‚¹åˆ‡æ¢(primary promotions)å’Œç½‘ç»œæ•…éšœã€‚ å¦‚æˆ‘ä»¬æ‰€è§ï¼Œè¿™ä¸¤ç§é›†ç¾¤è§£å†³æ–¹æ¡ˆéƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚ å¸Œæœ›æœ¬æ‘˜è¦å°†å¸®åŠ©æ‚¨å¯¹å®ƒä»¬æœ‰æ›´å¤šçš„äº†è§£ï¼Œå¹¶ä½¿æ‚¨å¯¹ä½¿ç”¨å“ªç§æŠ€æœ¯çš„å†³ç­–æ›´åŠ å®¹æ˜“ã€‚","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MGR","slug":"MGR","permalink":"http://fuxkdb.com/tags/MGR/"},{"name":"PXC","slug":"PXC","permalink":"http://fuxkdb.com/tags/PXC/"}]},{"title":"è¯‘æ–‡-ClickHouse In the Storm. Part 2 - Maximum QPS for key-value lookups","slug":"2020-05-03-[è¯‘æ–‡]ClickHouse-In-the-Storm.-Part-2-Maximum-QPS-for-key-value-lookups","date":"2020-05-03T03:43:00.000Z","updated":"2020-05-03T04:08:38.999Z","comments":true,"path":"2020/05/03/2020-05-03-[è¯‘æ–‡]ClickHouse-In-the-Storm.-Part-2-Maximum-QPS-for-key-value-lookups/","link":"","permalink":"http://fuxkdb.com/2020/05/03/2020-05-03-[%E8%AF%91%E6%96%87]ClickHouse-In-the-Storm.-Part-2-Maximum-QPS-for-key-value-lookups/","excerpt":"ClickHouse In the Storm. Part 2: Maximum QPS for key-value lookupsä¸Šä¸€ç¯‡æ–‡ç« è°ƒæŸ¥äº†ClickHouseçš„è¿æ¥æ€§åŸºå‡†ï¼Œä»¥ä¼°è®¡æœåŠ¡å™¨å¹¶å‘çš„æ€»ä½“æ€§èƒ½ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥å®é™…ç¤ºä¾‹ä¸ºä¾‹ï¼Œå¹¶åœ¨æ¶‰åŠå®é™…æ•°æ®æ—¶æ¢è®¨å¹¶å‘æ€§èƒ½ã€‚ MergeTree: Key-value lookupè®©æˆ‘ä»¬çœ‹çœ‹MergeTreeå¼•æ“è¡¨å¦‚ä½•å¤„ç†é«˜å¹¶å‘æ€§ï¼Œä»¥åŠå®ƒèƒ½å¤Ÿå¤„ç†å¤šå°‘ä¸ªQPSç”¨äºé”®å€¼æŸ¥æ‰¾ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨2ä¸ªç»¼åˆæ•°æ®é›†ï¼š â€˜fs12Mâ€™-å…·æœ‰1200ä¸‡æ¡è®°å½•çš„è¡¨ï¼Œidä¸ºFixedString(16)å’Œ5ä¸ªä¸åŒç±»å‹çš„å‚æ•°ï¼š 123456789CREATE TABLE default.fs12M ( id FixedString(16), value1 Float64, value2 Float64, value3 UInt32, value4 UInt64, str_value String) ENGINE = MergeTree PARTITION BY tuple() ORDER BY idSETTINGS index_granularity = 256","text":"ClickHouse In the Storm. Part 2: Maximum QPS for key-value lookupsä¸Šä¸€ç¯‡æ–‡ç« è°ƒæŸ¥äº†ClickHouseçš„è¿æ¥æ€§åŸºå‡†ï¼Œä»¥ä¼°è®¡æœåŠ¡å™¨å¹¶å‘çš„æ€»ä½“æ€§èƒ½ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥å®é™…ç¤ºä¾‹ä¸ºä¾‹ï¼Œå¹¶åœ¨æ¶‰åŠå®é™…æ•°æ®æ—¶æ¢è®¨å¹¶å‘æ€§èƒ½ã€‚ MergeTree: Key-value lookupè®©æˆ‘ä»¬çœ‹çœ‹MergeTreeå¼•æ“è¡¨å¦‚ä½•å¤„ç†é«˜å¹¶å‘æ€§ï¼Œä»¥åŠå®ƒèƒ½å¤Ÿå¤„ç†å¤šå°‘ä¸ªQPSç”¨äºé”®å€¼æŸ¥æ‰¾ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨2ä¸ªç»¼åˆæ•°æ®é›†ï¼š â€˜fs12Mâ€™-å…·æœ‰1200ä¸‡æ¡è®°å½•çš„è¡¨ï¼Œidä¸ºFixedString(16)å’Œ5ä¸ªä¸åŒç±»å‹çš„å‚æ•°ï¼š 123456789CREATE TABLE default.fs12M ( id FixedString(16), value1 Float64, value2 Float64, value3 UInt32, value4 UInt64, str_value String) ENGINE = MergeTree PARTITION BY tuple() ORDER BY idSETTINGS index_granularity = 256 â€˜int20Mâ€™-å…·æœ‰2000ä¸‡æ¡è®°å½•çš„è¡¨ï¼Œidä¸ºUInt64å’Œä¸€ä¸ªFloat32å‚æ•°ï¼š 12345CREATE TABLE default.int20M ( id UInt64, value Float64) ENGINE = MergeTree PARTITION BY tuple() ORDER BY idSETTINGS index_granularity = 256 You can find the create table statements here. æˆ‘ä»¬å°†åœ¨ä¸‹é¢ä½¿ç”¨ä¸¤ä¸ªæŸ¥è¯¢æ¥æ£€æŸ¥åœ¨4ç§æƒ…å†µä¸‹å¯¹è¿™äº›è¡¨çš„lookupæŸ¥è¯¢æ€§èƒ½ï¼š é€šè¿‡idæŸ¥è¯¢å•æ¡è®°å½• ä»¥1:3 hit/missæ¯”ç‡æŸ¥è¯¢100æ¡éšæœºè®°å½• æ­¤å¤–ï¼Œè¿˜è¦ä¸ºä¸Šé¢çš„æ¯ä¸ªæµ‹è¯•æ£€æŸ¥ä¸¤ç§å½¢å¼çš„ClickHouseè¿‡æ»¤â€”â€”WHEREå’ŒPREWHERE (PREWHEREå­å¥ä¸WHEREè¯­æ³•ç›¸åŒï¼Œä½†å†…éƒ¨å·¥ä½œæ–¹å¼ç•¥æœ‰ä¸åŒ)ã€‚ 12SELECT * FROM table WHERE id = â€¦ SELECT * FROM table WHERE id IN (... SELECT 100 random ids ...) You can find all the select statements here. CHOOSING INDEX_GRANULARITYMergeTreeçš„æœ€é‡è¦å‚æ•°ä¹‹ä¸€æ˜¯index_granularityã€‚ è®©æˆ‘ä»¬å°è¯•ä¸ºæ¯ç§æƒ…å†µæ‰¾åˆ°æœ€ä½³çš„index_granularityï¼š ç”±äºä¸Šé¢çš„è¡¨æ€»ç»“äº†å‡ ä¸ªä¸åŒæµ‹è¯•çš„ç»“æœï¼Œæ‰€ä»¥è¯¥å›¾æ˜¾ç¤ºäº†è§„èŒƒåŒ–åˆ°æœ€ä½³è¿è¡Œçš„QPS(å³1 =è¡¨ç¤ºæ‰€æœ‰æµ‹è¯•éƒ½ç»™å‡ºäº†æœ€å¤§QPS)ã€‚å¦‚æ‚¨æ‰€è§ï¼Œç›¸æ¯”â€™int20Mâ€™, â€˜fs12Mâ€™åœ¨index_granularityè¾ƒå°æ—¶æ€§èƒ½è¾ƒå¥½, å› ä¸ºé”®æ›´å¤§ï¼Œæ¶‰åŠçš„åˆ—æ›´å¤š(åŒ…æ‹¬ä¸€ä¸ªç›¸å½“å¤§çš„å­—ç¬¦ä¸²)ã€‚ For fs12M the best QPS performance gives index_granularity 64 &amp; 128 For int20M - 128 &amp; 256. å°æŸ¥è¯¢çš„æ€§èƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨uncompressed cacheæé«˜. ClickHouseé€šå¸¸ä¸ç¼“å­˜æ•°æ®, ä½†æ˜¯å¯¹äºå¿«é€Ÿçš„ç®€çŸ­æŸ¥è¯¢, å¯ä»¥ä½¿ç”¨internal cacheæ¥ä¿å­˜æœªå‹ç¼©çš„æ•°æ®åº“å—. å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶çº§åˆ«çš„use_uncompressed_cacheè®¾ç½®å°†å…¶æ‰“å¼€ã€‚ é»˜è®¤ç¼“å­˜å¤§å°ä¸º8GBï¼Œä½†å¯ä»¥å¢åŠ ã€‚ ç›®å‰use_uncompressed_cacheå‚æ•°åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒæ²¡æœ‰æ‰“å¼€, æˆ‘æŸ¥é˜…äº†ä¸€äº›èµ„æ–™å‘ç°å¯èƒ½æ˜¯å‚è€ƒäº†å›½å†…çš„åšå®¢, è€Œå›½å†…çš„åšå®¢å¯èƒ½éƒ½æ˜¯äº’ç›¸å€Ÿé‰´éƒ½æ²¡æœ‰è‡ªå·±çœ‹è¿™ä¸ªå‚æ•°, ä¹Ÿå¯èƒ½æ˜¯æˆ‘è‡†æµ‹çš„ use_uncompressed_cacheé»˜è®¤0å…³é—­, ä½†åœ¨æ–‡æ¡£ä¸­æœ‰å¦‚ä¸‹æè¿° For queries that read at least a somewhat large volume of data (one million rows or more), the uncompressed cache is disabled automatically to save space for truly small queries. This means that you can keep the â€˜use_uncompressed_cacheâ€™ setting always set to 1. ä¸è¿‡åœ¨æœ¬æ–‡ç»“è®ºåœ¨, ä½œè€…å»ºè®®åªå¯¹ç‰¹å®šçš„æŸ¥è¯¢å’Œç‰¹å®šçš„ç”¨æˆ·å¼€å¯use_uncompressed_cache, ä½†æ˜¯use_uncompressed_cacheå…¶å®å¥½åƒæ— æ³•é’ˆå¯¹æŸ¥è¯¢å¼€å¯ä½†å¯ä»¥é’ˆå¯¹ä¼šè¯ Letâ€™s see how QPS looks for 100 random ID lookups: æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œå¯¹â€™fs12â€™çš„æŸ¥æ‰¾è¦æ¯”å¯¹â€™int20Mâ€™çš„æŸ¥æ‰¾æ…¢ã€‚ ä½¿ç”¨PREWHEREè€Œä¸æ˜¯WHEREå¯ä»¥æ˜¾ç€æ”¹å–„æ€§èƒ½ã€‚ Here are QPS numbers for single value lookup: å¯ç”¨use_uncompressed_cacheæœ€å¤šå¯æé«˜50ï¼…æ€§èƒ½ã€‚ å¯¹äºâ€™int20Mâ€™å•ç‚¹æŸ¥è¯¢ï¼Œå®ƒçš„æ•ˆæœä¼¼ä¹è¾ƒä½ï¼Œå› ä¸ºåœ¨æ‰€æœ‰æµ‹è¯•æ¡ˆä¾‹ä¸­ï¼Œå®ƒçš„è¿è¡Œé€Ÿåº¦éƒ½éå¸¸å¿«ã€‚ ä½†æ˜¯ï¼Œå¦‚æœè¯¥QPSè¿˜ä¸å¤Ÿï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ ClickHouseå¯ä»¥åšå¾—æ›´å¥½å—ï¼Ÿ å¯ä»¥ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»åˆ‡æ¢åˆ°å…¶ä»–æ•°æ®ç»“æ„ä»¥ç¡®ä¿æ•°æ®å§‹ç»ˆåœ¨å†…å­˜ä¸­ã€‚ ClickHouseä¸ºæ­¤æä¾›äº†å¤šç§é€‰æ‹©ï¼šæˆ‘ä»¬å°†å°è¯•ä½¿ç”¨å¤–éƒ¨Dictionaryå’ŒJoinå¼•æ“ã€‚ Dictionaryé€šå¸¸ä½¿ç”¨å­—å…¸æ¥ä¸å¤–éƒ¨æ•°æ®é›†æˆã€‚ è¯·å‚é˜…æœ‰å…³æ­¤ä¸»é¢˜çš„åšå®¢æ–‡ç« ã€‚ ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­—å…¸æ¥ä¸ºå·²ç»å­˜å‚¨åœ¨ClickHouseä¸­çš„æ•°æ®å»ºç«‹å†…å­˜ä¸­çš„ç¼“å­˜ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åšã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸ºâ€int20Mâ€è¡¨é…ç½®å­—å…¸ï¼š 12345678910111213141516171819202122232425&lt;dictionaries&gt;&lt;dictionary&gt; &lt;name&gt;int20M&lt;/name&gt; &lt;source&gt; &lt;clickhouse&gt; &lt;host&gt;localhost&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;&lt;/password&gt; &lt;db&gt;default&lt;/db&gt; &lt;table&gt;int20M&lt;/table&gt; &lt;/clickhouse&gt; &lt;lifetime&gt;0&lt;/lifetime&gt; &lt;layout&gt;&lt;hashed&gt;&lt;/hashed&gt;&lt;/layout&gt; &lt;structure&gt; &lt;id&gt;&lt;name&gt;id&lt;/name&gt;&lt;/id&gt; &lt;attribute&gt; &lt;name&gt;value&lt;/name&gt; &lt;type&gt;Float32&lt;/type&gt; &lt;null_value&gt;0&lt;/null_value&gt; &lt;/attribute&gt; &lt;/structure&gt;&lt;/dictionary&gt;&lt;/dictionaries&gt; æ‚¨å¯ä»¥ä»æ­¤å¤„ä¸‹è½½æˆ‘ä»¬ä¸ºæ‚¨å‡†å¤‡å¥½æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶éœ€è¦æ”¾ç½®åœ¨ClickHouseé…ç½®æ–‡ä»¶å¤¹ä¸­ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œç›®å‰æ— æ³•ä½¿ç”¨FixedStringé”®åˆ›å»ºå­—å…¸ï¼Œå› æ­¤æˆ‘ä»¬ä»…æµ‹è¯•â€™int20Mâ€™æƒ…å†µã€‚ ä¸ºäº†é€šè¿‡é”®è·å–å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—å…¸getå‡½æ•°å¯¹å…¶è¿›è¡ŒæŸ¥è¯¢ï¼š 1select dictGetFloat32(&#x27;test100M&#x27;,&#x27;value&#x27;,9221669071414979782) You can find all the test selects here å¥½å§ï¼Œå®ƒçš„QPSçº¦ä¸º9.2Kï¼šæ¯”MergeTreeæ›´å¥½. æ ¹æ®ç»éªŒå¯¹äºsingle point select MySQLå¯ä»¥è½»æ¾è¾¾åˆ°90k qps. è¿™ä¹Ÿè¯´æ˜ClickHouseå¹¶ä¸æ˜¯ç”¨æ¥åšé«˜å¹¶å‘çŸ­æŸ¥è¯¢çš„. å¦ä¸€ä¸ªé€‰é¡¹æ˜¯ä½¿ç”¨â€œç¼“å­˜â€å­—å…¸å¸ƒå±€(â€˜cachedâ€™ dictionaries layout)ï¼Œå®ƒæç¤ºClickHouseåªå°†éƒ¨åˆ†è¡Œä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¦‚æœæ‚¨çš„ç¼“å­˜å‘½ä¸­ç‡å¾ˆé«˜ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥å¾ˆå¥½åœ°å·¥ä½œã€‚ å¦‚æœæ‚¨ä¸éœ€è¦è¿‡äºé¢‘ç¹åœ°æ›´æ–°å­—å…¸ï¼Œåˆ™å­—å…¸æ•ˆæœå¾ˆå¥½ã€‚ æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼› å­—å…¸ä¼šå®šæœŸæ£€æŸ¥æºè¡¨ï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦åˆ·æ–°å®ƒã€‚ æœ‰æ—¶å¯èƒ½ä¸æ–¹ä¾¿ã€‚ å¦ä¸€ä¸ªä¸ä¾¿ä¹‹å¤„æ˜¯XMLé…ç½®ã€‚ åº”è¯¥å¾ˆå¿«ç”¨å­—å…¸DDLä¿®å¤å®ƒï¼Œä½†æ˜¯æš‚æ—¶æˆ‘ä»¬å¿…é¡»åšæŒä½¿ç”¨XMLã€‚ Join table EngineClickHouseå†…éƒ¨ä½¿ç”¨è”æ¥è¡¨å¼•æ“æ¥å¤„ç†SQLè”æ¥ã€‚ ä½†æ˜¯æ‚¨å¯ä»¥åƒè¿™æ ·æ˜¾å¼åˆ›å»ºä¸€ä¸ªè¡¨ï¼š 12345678CREATE TABLE fs12M ( id FixedString(16), value1 Float64, value2 Float64, value3 UInt32, value4 UInt64, str_value String) ENGINE = Join(ANY, LEFT, id) ç„¶åå¯ä»¥åƒæ’å…¥å…¶ä»–è¡¨ä¸€æ ·æ’å…¥è¯¥è¡¨ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ç”¨ä¸€ä¸ªINSERTå¡«å……æ•´ä¸ªè¡¨ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç”¨partsæ¥å®Œæˆ(ä½†æ˜¯ä»ç„¶éœ€è¦è¶³å¤Ÿå¤§çš„partsï¼Œæœ€å¥½ä¸è¦æœ‰å¤ªå¤šçš„parts)ã€‚è”æ¥è¡¨åœ¨å†…å­˜ä¸­æŒä¹…å­˜åœ¨(å°±åƒå­—å…¸ä¸€æ ·ï¼Œä½†æ˜¯ä»¥ä¸€ç§æ›´ç´§å‡‘çš„æ–¹å¼)ï¼Œå¹¶ä¸”ä¹Ÿåœ¨ç£ç›˜ä¸Šåˆ·æ–°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå°†åœ¨æœåŠ¡å™¨é‡å¯åæ¢å¤ã€‚ æ— æ³•ç›´æ¥æŸ¥è¯¢Join tableï¼› æ‚¨å§‹ç»ˆéœ€è¦å°†å…¶ç”¨ä½œè”æ¥çš„æ­£ç¡®éƒ¨åˆ†ã€‚ æœ‰ä¸¤ä¸ªé€‰é¡¹å¯ä»è”æ¥è¡¨ä¸­æå–æ•°æ®ã€‚ ç¬¬ä¸€ä¸ªç±»ä¼¼äºä½¿ç”¨joinGetå‡½æ•°çš„å­—å…¸è¯­æ³•ï¼ˆå®ƒæ˜¯ç”±ä¸€ä¸ªè´¡çŒ®è€…æ·»åŠ çš„ï¼Œè‡ª18.6å¼€å§‹å¯ç”¨ï¼‰ã€‚ æˆ–è€…ï¼Œæ‚¨å¯ä»¥è¿›è¡ŒçœŸæ­£çš„è”æ¥ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨system.oneè¡¨ï¼‰ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢æ¥æµ‹è¯•è¿™ä¸¤ç§æ–¹æ³•ï¼š 12SELECT joinGet(&#x27;int20M&#x27;, &#x27;value&#x27;, 9221669071414979782) as valueSELECT 9221669071414979782 as id, * FROM system.one ANY LEFT JOIN int20M USING (id); Results, QPS: å½“æ‚¨éœ€è¦ä¸ºæ¯æ¬¡æŸ¥æ‰¾è¿›è¡Œå¤§é‡çš„joinGetè°ƒç”¨æ—¶ï¼Œå¯¹äºâ€™fs12Mâ€™æ¥è¯´ï¼ŒjoinGetå’Œå®é™…è”æ¥ä¹‹é—´çš„åŒºåˆ«æ˜¾è€Œæ˜“è§ã€‚ å½“æ‚¨åªéœ€è¦è°ƒç”¨ä¸€æ¬¡æ—¶-æ²¡æœ‰åŒºåˆ«ã€‚ ä¸å­—å…¸ç›¸æ¯”ï¼ŒJoinè¡¨çš„æ€§èƒ½ç¨å·®ã€‚ ä½†æ˜¯ï¼Œç”±äºå®ƒå·²ç»åœ¨æ•°æ®åº“æ¶æ„ä¸­ï¼Œå› æ­¤ç»´æŠ¤èµ·æ¥æ›´å®¹æ˜“ã€‚ ä¸å­—å…¸ç›¸æ¯”ï¼Œè”æ¥ä½¿ç”¨çš„å†…å­˜æ›´å°‘ï¼Œæ‚¨å¯ä»¥è½»æ¾æ·»åŠ æ–°æ•°æ®ï¼Œç­‰ç­‰ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œæ— æ³•è¿›è¡Œæ›´æ–°ã€‚ ï¼ˆThat would be too good. :)ï¼‰ è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æ‰€æœ‰QPSç»“æœå¹¶å°†å…¶æ”¾åœ¨ä¸€å¼ å›¾è¡¨ä¸­ï¼š Latencies (90th percentile) Conclusions - ç»“è®ºåœ¨æœ¬æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç ”ç©¶äº†å¹¶å‘åŸºç¡€çŸ¥è¯†ã€‚è¿™æ˜¯æ‚¨å¯ä»¥ç”¨äºè‡ªå·±çš„åº”ç”¨ç¨‹åºçš„ä¸€äº›ä¸»è¦ç»“è®ºã€‚ ClickHouse is not a key-value database (surprise! :) ) å¦‚æœæ‚¨éœ€è¦åœ¨Clickhouseå†…éƒ¨æ¨¡æ‹Ÿé”®å€¼æŸ¥æ‰¾æ–¹æ¡ˆ-è¿æ¥å¼•æ“å’Œå­—å…¸å¯æä¾›æœ€ä½³æ€§èƒ½ å¦‚æœæ¯ç§’æœ‰å¾ˆå¤šæŸ¥è¯¢ï¼Œåˆ™ç¦ç”¨æ—¥å¿—ï¼ˆæˆ–é™ä½æ—¥å¿—çº§åˆ«ï¼‰å¯ä»¥æé«˜æ€§èƒ½ å¯ç”¨uncompressed cacheæœ‰åŠ©äºæé«˜æŸ¥è¯¢æ€§èƒ½ï¼ˆå¯¹äºâ€œå°çš„â€æŸ¥è¯¢ä»…è¿”å›å‡ è¡Œï¼‰ã€‚æœ€å¥½ä»…é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢å’Œç‰¹å®šç”¨æˆ·profileå¯ç”¨å®ƒ åœ¨é«˜å¹¶å‘æ–¹æ¡ˆä¸­ä½¿ç”¨max_thread = 1 å°½é‡ä¿æŒåŒæ—¶è¿æ¥çš„æ•°é‡è¶³å¤Ÿå°‘ï¼Œä»¥è·å¾—æœ€å¤§çš„QPSæ€§èƒ½ã€‚å…·ä½“æ•°å­—å½“ç„¶å–å†³äºç¡¬ä»¶ã€‚ä½¿ç”¨æˆ‘ä»¬çš„ä½ç«¯æœºå™¨è¿›è¡Œæµ‹è¯•ï¼Œ16-32èŒƒå›´å†…çš„è¿æ¥æ˜¾ç¤ºäº†æœ€å¥½çš„QPSæ€§èƒ½å¯¹äºUInt64é”®çš„é”®å€¼ç±»å‹åœºæ™¯ï¼Œindex_granularity= 256çœ‹èµ·æ¥æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œå¯¹äºFixedString(16)é”®ï¼Œä¹Ÿè¦è€ƒè™‘index_granularity= 128ã€‚ ç„¶è€Œé»˜è®¤index_granularityä¸º8192 ä½¿ç”¨PREWHEREè€Œä¸æ˜¯WHEREè¿›è¡Œç‚¹æŸ¥æ‰¾ã€‚ Summary - æ€»ç»“ClickHouseä¸æ˜¯key-value stroe, ä½†æ˜¯æ ¹æ®æˆ‘ä»¬çš„ç»“æœè¯å®ClickHouseåœ¨ä¸åŒå¹¶å‘çš„é«˜è´Ÿè½½ä¸‹è¡¨ç°ç¨³å®š, å¹¶ä¸”èƒ½å¤Ÿåœ¨MergeTreeè¡¨ä¸Šï¼ˆå½“æ•°æ®ä½äºæ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­æ—¶ï¼‰æ¯ç§’æä¾›çº¦4K(æ¯ç§’)çš„æŸ¥è¯¢, å½“ä½¿ç”¨Dictionaryæˆ–Join engineæ˜¯ç”šè‡³å¯ä»¥è¾¾åˆ°10k(æ¯ç§’). å½“ç„¶ï¼Œåœ¨æ›´å¥½çš„ç¡¬ä»¶ä¸Šï¼Œæ‚¨ä¼šæœ‰æ›´å¥½çš„æ•°å­—. è¿™äº›ç»“æœè¿œéé”®å€¼æ•°æ®åº“ï¼ˆä¾‹å¦‚Redisï¼Œåœ¨ç›¸åŒçš„ç¡¬ä»¶ä¸Šå¯æä¾›çº¦125K QPSï¼‰ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå³ä½¿è¿™æ ·çš„QPSé€Ÿç‡ä¹Ÿå¯ä»¥ä»¤äººæ»¡æ„ã€‚ ä¾‹å¦‚-é€šè¿‡å¤æ‚çš„OLAPè®¡ç®—åœ¨å®æ—¶åˆ›å»ºçš„æ•°æ®ä¸­è¿›è¡ŒåŸºäºidçš„æŸ¥æ‰¾/é€šè¿‡idä»ç‰©åŒ–è§†å›¾ä¸­æå–ä¸€äº›èšåˆç­‰ã€‚å¹¶ä¸”ï¼ŒClickHouseè¿˜å¯ä»¥æ°´å¹³å’Œå‚ç›´ç¼©æ”¾ã€‚ ç®€å•pingå’Œæ™®é€šselectä¹‹é—´çš„QPSå·®å¼‚è¡¨æ˜ï¼Œæœªæ¥çš„ä¼˜åŒ–å…·æœ‰ä¸€å®šçš„æ½œåŠ›ã€‚å¦å¤–ï¼Œå°†ClickHouseä¸é”®å€¼æ•°æ®åº“ç»“åˆèµ·æ¥ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¸ClickHouseæ— ç¼åˆä½œï¼Œè¿™ä¸ªæƒ³æ³•å¬èµ·æ¥å¾ˆæœ‰å‰é€”ã€‚å¦‚æœä½ å…³æ³¨ClickHouseçš„pull requestsï¼Œä½ å¯èƒ½å·²ç»çœ‹åˆ°äº†ä¸€äº›ä¸Cassandraå’ŒRedisçš„è‰æ¡ˆæ•´åˆã€‚ è¯·ç»§ç»­å…³æ³¨ï¼Œå¹¶è®¢é˜…æˆ‘ä»¬çš„åšå®¢ï¼ åŸæ–‡é“¾æ¥:https://www.altinity.com/blog/clickhouse-in-the-storm-part-2","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"}]},{"title":"è¯‘æ–‡-ClickHouse In the Storm. Part 1 - Maximum QPS estimation - æœ€å¤§QPSä¼°ç®—","slug":"2020-05-03-[è¯‘æ–‡]ClickHouse-In-the-Storm.-Part-1-Maximum-QPS-estimation---æœ€å¤§QPSä¼°ç®—","date":"2020-05-03T03:33:00.000Z","updated":"2020-05-03T04:08:44.568Z","comments":true,"path":"2020/05/03/2020-05-03-[è¯‘æ–‡]ClickHouse-In-the-Storm.-Part-1-Maximum-QPS-estimation---æœ€å¤§QPSä¼°ç®—/","link":"","permalink":"http://fuxkdb.com/2020/05/03/2020-05-03-[%E8%AF%91%E6%96%87]ClickHouse-In-the-Storm.-Part-1-Maximum-QPS-estimation---%E6%9C%80%E5%A4%A7QPS%E4%BC%B0%E7%AE%97/","excerpt":"ClickHouse In the Storm. Part 1: Maximum QPS estimation - æœ€å¤§QPSä¼°ç®—ClickHouseæ˜¯ä¸€ä¸ªç”¨äºåˆ†æçš„OLAPæ•°æ®åº“, å› æ­¤å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯å¤„ç†ç›¸å¯¹å°‘é‡çš„è¯·æ±‚: æ¯å°æ—¶å‡ ä¸ªæŸ¥è¯¢åˆ°æ¯ç§’å‡ åç”šè‡³å‡ ç™¾ä¸ªæŸ¥è¯¢ å½±å“å¤§é‡æ•°æ®(gigabytes/millions of rows) ä½†æ˜¯å®ƒåœ¨å…¶ä»–æƒ…å†µä¸‹è¡¨ç°å¦‚ä½•? Letâ€™s try to use a steam-hammer to crack nuts, å¹¶æ£€æŸ¥ClickHouseæ¯ç§’å°†å¦‚ä½•å¤„ç†æ•°åƒä¸ªå°è¯·æ±‚ã€‚ è¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å¯èƒ½çš„ç”¨ä¾‹èŒƒå›´å’Œé™åˆ¶ã€‚ è¿™ç¯‡æ–‡ç« åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ ç¬¬ä¸€éƒ¨åˆ†ä»‹ç»è¿æ¥æ€§åŸºå‡†æµ‹è¯•å’Œæµ‹è¯•è®¾ç½®ã€‚ ä¸‹ä¸€éƒ¨åˆ†å°†ä»‹ç»æ¶‰åŠå®é™…æ•°æ®çš„æ–¹æ¡ˆä¸­çš„æœ€å¤§QPSã€‚","text":"ClickHouse In the Storm. Part 1: Maximum QPS estimation - æœ€å¤§QPSä¼°ç®—ClickHouseæ˜¯ä¸€ä¸ªç”¨äºåˆ†æçš„OLAPæ•°æ®åº“, å› æ­¤å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯å¤„ç†ç›¸å¯¹å°‘é‡çš„è¯·æ±‚: æ¯å°æ—¶å‡ ä¸ªæŸ¥è¯¢åˆ°æ¯ç§’å‡ åç”šè‡³å‡ ç™¾ä¸ªæŸ¥è¯¢ å½±å“å¤§é‡æ•°æ®(gigabytes/millions of rows) ä½†æ˜¯å®ƒåœ¨å…¶ä»–æƒ…å†µä¸‹è¡¨ç°å¦‚ä½•? Letâ€™s try to use a steam-hammer to crack nuts, å¹¶æ£€æŸ¥ClickHouseæ¯ç§’å°†å¦‚ä½•å¤„ç†æ•°åƒä¸ªå°è¯·æ±‚ã€‚ è¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å¯èƒ½çš„ç”¨ä¾‹èŒƒå›´å’Œé™åˆ¶ã€‚ è¿™ç¯‡æ–‡ç« åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ ç¬¬ä¸€éƒ¨åˆ†ä»‹ç»è¿æ¥æ€§åŸºå‡†æµ‹è¯•å’Œæµ‹è¯•è®¾ç½®ã€‚ ä¸‹ä¸€éƒ¨åˆ†å°†ä»‹ç»æ¶‰åŠå®é™…æ•°æ®çš„æ–¹æ¡ˆä¸­çš„æœ€å¤§QPSã€‚ Environmentåœ¨æœ€åˆçš„æµ‹è¯•ä¸­ï¼Œæˆ‘é€‰æ‹©äº†ç°æœ‰çš„æ—§å·¥ä½œç«™ï¼š 4-cores Intel(R) Core(TM) i5-2400 CPU @ 3.10GHz 8Gb of RAM SSD disk CentOS 7 æœ¬æ–‡ä»‹ç»äº†ä»è¯¥æœºå™¨æ”¶é›†çš„ç»“æœï¼Œä½†æ˜¯å½“ç„¶ï¼Œå°è¯•åœ¨åŠŸèƒ½æ›´å¼ºå¤§çš„ç¡¬ä»¶ä¸Šé‡å¤è¿™äº›æµ‹è¯•éå¸¸æœ‰è¶£ã€‚ æˆ‘å°†è¿™é¡¹ä»»åŠ¡ç•™ç»™æˆ‘ä»¬çš„è¯»è€…ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨è‡ªå·±çš„ç¡¬ä»¶ä¸Šçš„ä¸åŒæƒ…å†µä¸‹æµ‹è¯•ClickHouseçš„æœ€å¤§QPSã€‚ å¦‚æœå¯ä»¥ï¼Œè¯·å‘å¸ƒç»“æœï¼ ä¸ºäº†è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œæˆ‘è¿˜åˆ›å»ºäº†ä¸€å¥—å¯åœ¨Altinity githubä¸­å…è´¹ä½¿ç”¨çš„è„šæœ¬ï¼šhttps://github.com/Altinity/clickhouse-sts/ã€‚ è¿™äº›è„šæœ¬éœ€è¦Dockerï¼ˆI have v18.09ï¼‰å’ŒBashã€‚ è¦è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼Œåªéœ€å…‹éš†GitHubå­˜å‚¨åº“å¹¶åœ¨æ ¹æ–‡ä»¶å¤¹ä¸­è¿è¡Œâ€œ make testâ€å‘½ä»¤ã€‚ å®ƒå°†åœ¨æ‚¨çš„ä¸»æœºä¸Šæ‰§è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆå°†èŠ±è´¹å‡ ä¸ªå°æ—¶ï¼‰ï¼Œå¹¶å°†ç»“æœæ”¾å…¥ä¸€ä¸ªCSVæ–‡ä»¶ä¸­ï¼Œä»¥åå¯ä»¥åœ¨Excelï¼ŒPandasæˆ–ClickHouseæœ¬èº«ä¸­è¿›è¡Œåˆ†æã€‚ å½“ç„¶ï¼Œæ‚¨å¯ä»¥å…±äº«æ‚¨çš„å‘ç°ä»¥å°†å®ƒä»¬ä¸æœ¬æ–‡çš„ç»“æœè¿›è¡Œæ¯”è¾ƒã€‚ Under the hood those scripts use: https://github.com/wg/wrkï¼Œä¸€ç§è½»é‡çº§ä¸”å¿«é€Ÿçš„HTTPåŸºå‡†æµ‹è¯•å·¥å…·ï¼Œå…è®¸åˆ›å»ºä¸åŒçš„HTTPå·¥ä½œè´Ÿè½½ ClickHouseå‘è¡Œç‰ˆä¸­åŒ…å«çš„clickhouse-benchmarkå·¥å…·-ç”¨äºæœ¬æœºåè®®ClickHouseæµ‹è¯• è¿™ä¸¤ç§å·¥å…·éƒ½å…è®¸æ‚¨åˆ›å»ºæ‰€éœ€çš„å¹¶å‘è´Ÿè½½ï¼ˆæ¨¡æ‹Ÿä¸åŒæ•°é‡çš„å¹¶å‘å®¢æˆ·ç«¯ï¼‰ï¼Œå¹¶æµ‹é‡æ¯ç§’æœåŠ¡çš„æŸ¥è¯¢æ•°é‡å’Œå»¶è¿Ÿç™¾åˆ†ä½æ•°ã€‚ A few words about handling concurrent requests in ClickHouseé»˜è®¤æƒ…å†µä¸‹ClickHouseæœ€å¤šå¯ä»¥å¤„ç†4096ä¸ªinbound connections (max_connections setting in server config file), ä½†åªä¼šåŒæ—¶æ‰§è¡Œ100ä¸ªæŸ¥è¯¢(max_concurrent_queries.), æ‰€ä»¥æ‰€æœ‰å…¶ä»–clientä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…so all other clients will just wait in the queue.å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥ä¿æŒå¤šä¹…æ’é˜Ÿæœ€é•¿æŒç»­æ—¶é—´é€šè¿‡è®¾ç½®queue_max_wait_mså®šä¹‰(è¿™ä¸ªå‚æ•°æ–‡æ¡£ä¸­æ²¡æœ‰æ‰¾åˆ°, åªæœ‰issueä¸­æœåˆ°äº†)(5000 or 5 sec by default) è¯‘è€…æ³¨: è¿™é‡Œè¯´queue_max_wait_msé»˜è®¤5000 or 5 sec æœ‰ç‚¹æè¿°ä¸æ¸…, 5000ä¼°è®¡å•ä½æ˜¯ms. ä½†æ˜¯æˆ‘æŸ¥è¯¢é»˜è®¤å€¼å¹¶ä¸æ˜¯5ms, åº”è¯¥æ˜¯ç‰ˆæœ¬å·®å¼‚ 1234567SELECT *FROM settingsWHERE name = &#x27;queue_max_wait_ms&#x27;â”Œâ”€nameâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€valueâ”€â”¬â”€changedâ”€â”¬â”€descriptionâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€minâ”€â”€â”¬â”€maxâ”€â”€â”¬â”€readonlyâ”€â”â”‚ queue_max_wait_ms â”‚ 0 â”‚ 0 â”‚ The wait time in the request queue, if the number of concurrent requests exceeds the maximum. â”‚ á´ºáµá´¸á´¸ â”‚ á´ºáµá´¸á´¸ â”‚ 0 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ It is a user/profile setting, so users can define some smaller value to prompt an exception in cases where the queue is too long. Keepalive timeout for http connection is relatively low by default - itâ€™s 3 seconds (keep_alive_timeout setting). There are also a lot of advanced network-related settings to fine-tune different timeouts, poll intervals, listen_backlog size etc. HTTP ping: theoretically possible maximum throughput of HTTP server - HTTP ping: ç†è®ºä¸Šå¯èƒ½çš„æœ€å¤§HTTPæœåŠ¡å™¨ååé‡é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ClickHouseæœ¬èº«ä½¿ç”¨çš„HTTPæœåŠ¡å™¨æœ‰å¤šå¿«ã€‚ æ¢å¥è¯è¯´ï¼ŒæœåŠ¡å™¨å¯ä»¥å¤„ç†å¤šå°‘ä¸ªâ€do nothingâ€è¯·æ±‚ã€‚ å¯¹äºHTTPï¼Œä¸¤ä¸ªä¸»è¦çš„åœºæ™¯å¾ˆé‡è¦: ä½¿ç”¨keepalive(ä½¿ç”¨æŒä¹…è¿æ¥æ¥å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œæ— éœ€é‡æ–°è¿æ¥) æ²¡æœ‰keepalive(ä¸ºæ¯ä¸ªè¯·æ±‚å»ºç«‹æ–°è¿æ¥)ã€‚ å¦å¤–ï¼ŒClickHouseåœ¨é»˜è®¤æƒ…å†µä¸‹æœ‰ä¸€ä¸ªéå¸¸è¯¦ç»†çš„æ—¥å¿—çº§åˆ«(â€œtraceâ€)ã€‚å¯¹äºæ¯ä¸ªæŸ¥è¯¢ï¼Œå®ƒéƒ½ä¼šå‘æ—¥å¿—æ–‡ä»¶å†™å…¥å‡ è¡Œä»£ç ï¼Œè¿™å¯¹äºè°ƒè¯•æ¥è¯´å¾ˆå¥½ï¼Œä½†æ˜¯å½“ç„¶ä¼šé€ æˆä¸€äº›é¢å¤–çš„å»¶è¿Ÿã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜æ£€æŸ¥äº†ç¦ç”¨æ—¥å¿—çš„ä¸¤ä¸ªç›¸åŒåœºæ™¯ã€‚ æˆ‘ä»¬åœ¨ä¸åŒçš„å¹¶å‘çº§åˆ«ä¸Šæ£€æŸ¥äº†è¿™äº›åœºæ™¯ï¼Œä»¥æ¨¡æ‹Ÿä¸åŒæ•°é‡çš„åŒæ—¶è¿æ¥çš„å®¢æˆ·æœº(ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å‘é€è¯·æ±‚)ã€‚æ¯ä¸ªæµ‹è¯•æ‰§è¡Œ15ç§’ï¼Œç„¶åå–æ¯ç§’å¤„ç†è¯·æ±‚çš„å¹³å‡å€¼ã€‚ Results: åœ¨Xè½´ä¸Šï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åŒæ—¶è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡ã€‚åœ¨Yè½´ä¸Šæ˜¯æ¯ä¸ªç‰¹å®šåœºæ™¯ä¸­æ¯ç§’å¤„ç†çš„è¯·æ±‚çš„å¹³å‡æ•°é‡ã€‚ Well, results look good: åœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œè¯¥serverä¸ŠQPSçš„æœ€å¤§å€¼ä¸º8åˆ°64ä¸ªå¹¶å‘è¿æ¥ã€‚ å¯ç”¨keepaliveå’Œç¦ç”¨æ—¥å¿—åï¼Œæœ€å¤§ååé‡çº¦ä¸º97K QPSã€‚ å¯ç”¨æ—¥å¿—åï¼Œé€Ÿåº¦é™ä½äº†çº¦30ï¼…ï¼Œå¹¶æä¾›äº†çº¦71K QPSã€‚ ä¸¤ç§éKeepaliveå˜ä½“éƒ½æ…¢å¾—å¤šï¼ˆçº¦18.5 kqpsï¼‰ï¼Œç”šè‡³åœ¨æ­¤å¤„çœ‹ä¸åˆ°æ—¥å¿—è®°å½•å¼€é”€ã€‚ è¿™æ˜¯å¯ä»¥é¢„æœŸçš„ï¼Œå› ä¸ºæœ‰äº†Keepaliveï¼ŒClickHouseå½“ç„¶å¯ä»¥å¤„ç†æ›´å¤šçš„pingå‘½ä»¤ï¼Œè¿™æ˜¯å› ä¸ºè·³è¿‡äº†ä¸ºæ¯ä¸ªè¯·æ±‚å»ºç«‹è¿æ¥çš„é¢å¤–è´¹ç”¨ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹ClickHouse web-serverç†è®ºä¸Šå¯èƒ½è¾¾åˆ°çš„æœ€å¤§ååé‡å’Œå¹¶å‘çº§åˆ«æœ‰äº†ä¸€ç§æ„Ÿè§‰ã€‚äº‹å®ä¸Šï¼ŒClickHouse HTTP-serverå®ç°éå¸¸å¿«ã€‚ä¾‹å¦‚ï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šä½¿ç”¨é»˜è®¤è®¾ç½®çš„NGINXæ¯ç§’å¯ä»¥å¤„ç†å¤§çº¦30Kä¸ªè¯·æ±‚ã€‚ SELECT 1è®©æˆ‘ä»¬è¿›ä¸€æ­¥æ£€æŸ¥ä¸€ä¸ªæ™®é€šçš„â€SELECT 1â€è¯·æ±‚. è¿™æ ·çš„æŸ¥è¯¢æ˜¯åœ¨æŸ¥è¯¢è§£æé˜¶æ®µâ€œæ‰§è¡Œâ€çš„ï¼Œè¿™æ ·å°±ä¼šæ˜¾ç¤ºâ€œç½‘ç»œ+æˆæƒ+æŸ¥è¯¢è§£æ+æ ¼å¼åŒ–ç»“æœâ€(â€˜network + authorization + query parser + formatting resultâ€™)çš„ç†è®ºæœ€å¤§ååé‡ï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…çš„è¯·æ±‚æ°¸è¿œä¸ä¼šæ¯”è¿™ä¸ªé€Ÿåº¦å¿«ã€‚ We will test http and https using keepalive and no-keepalive options, and native client (both secure and non-secure). Results: æœ€ä½³æƒ…å†µçº¦ä¸º14K QPS: http &amp; keepalive åœ¨httpsï¼†keepaliveæƒ…å†µä¸‹, æ€§èƒ½ç¨å·®ä¸€äº›(13K QPS). åœ¨è¿™ç§æƒ…å†µä¸‹, Httpså¼€é”€å¹¶ä¸é‡è¦ 10.7 kqps for http no-keepalive. 10.1 kqps for native (no secure). 9.3 kqps for native (secure) And quite poor 4.3 kqps for https no-keepalive åœ¨æœ€é«˜å¹¶å‘çº§åˆ«ä¸Šï¼Œæˆ‘ä»¬è®°å½•äº†å‡ åä¸ªè¿æ¥é”™è¯¯ï¼ˆå³å°äº0.01ï¼…ï¼‰ï¼Œè¿™å¾ˆå¯èƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿçº§åˆ«ä¸Šçš„å¥—æ¥å­—é‡ç”¨é—®é¢˜å¼•èµ·çš„ã€‚ ClickHouseåœ¨è¯¥æµ‹è¯•ä¸­çš„è¿è¡Œæƒ…å†µç¨³å®šï¼Œæˆ‘æ²¡æœ‰å‘ç°ä»»ä½•å¯è§çš„é—®é¢˜ã€‚ ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæœ¬æœºåè®®çš„æ€§èƒ½æ¯”httpå·®ï¼Œä½†å®é™…ä¸Šè¿™æ˜¯é¢„æœŸçš„:æœ¬æœºTCP/IPæ›´å¤æ‚ï¼Œå¹¶ä¸”æœ‰è®¸å¤šé¢å¤–çš„åè®®ç‰¹æ€§ã€‚å®ƒä¸é€‚ç”¨äºé«˜QPSï¼Œè€Œæ˜¯ç”¨äºæ¥å›ä¼ è¾“å¤§æ•°æ®å—ã€‚ å½“æœ¬æœºå®¢æˆ·ç«¯ä¸­çš„å¹¶å‘å¢é•¿æ—¶ï¼ŒQPSä¹Ÿä¼šæ˜¾ç€ä¸‹é™ï¼Œå¹¶å‘çº§åˆ«æ›´é«˜ï¼ˆ&gt; 3000ï¼‰ã€‚ æ­¤æ—¶ï¼Œç³»ç»Ÿå˜å¾—æ— å“åº”ï¼Œå¹¶ä¸”ä¸è¿”å›ä»»ä½•ç»“æœã€‚ è¿™å¾ˆå¯èƒ½æ˜¯ç”±äºclickhouse-benchmarkå·¥å…·ä¸ºæ¯ä¸ªè¿æ¥ä½¿ç”¨äº†ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¹¶ä¸”çº¿ç¨‹å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ•°é‡å¯¹äºç³»ç»Ÿæ¥è¯´å¤ªå¤šäº†ã€‚ ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç­‰å¾…æ—¶é—´ï¼Œå³æ¯ä¸ªå®¢æˆ·ç­‰å¾…ç»“æœé›†çš„æ—¶é—´ã€‚ è¯¥æ•°å­—åœ¨æ¯ä¸ªè¯·æ±‚ä¸­æœ‰æ‰€ä¸åŒï¼Œå› æ­¤è¯¥å›¾æ˜¾ç¤ºäº†æ¯ç§æƒ…å†µä¸‹å»¶è¿Ÿçš„90ï¼…(90th percentile of the latency)ã€‚ è¿™æ„å‘³ç€90ï¼…çš„ç”¨æˆ·æ¯”æ˜¾ç¤ºçš„æ•°å­—æ›´å¿«åœ°å¾—åˆ°ç­”æ¡ˆã€‚ LATENCIES (90TH PERCENTILE) - 1-256 CONCURRENCY LEVELS éšç€å¹¶å‘æ€§çš„å¢é•¿ï¼Œå»¶è¿Ÿä¼šé™ä½ã€‚ç°åœ¨çœ‹èµ·æ¥è¿˜ä¸é”™:å¦‚æœæ‚¨çš„å¹¶å‘ç”¨æˆ·å°‘äº256ä¸ªï¼Œé‚£ä¹ˆå»¶è¿Ÿå¯èƒ½ä¼šä½äº50æ¯«ç§’(æ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯â€™network + authorization + query parser + formatting resultâ€™ç”¨æ—¶)ã€‚ è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†æ›´é«˜çš„å¹¶å‘æ€§çš„ã€‚ LATENCIES (90TH PERCENTILE) - &gt;256 CONCURRENCY LEVELS ç°åœ¨ï¼Œå»¶è¿Ÿé€€åŒ–å˜å¾—æ›´åŠ ä¸¥é‡ï¼Œå¹¶ä¸”æœ¬æœºåè®®native protocolå†æ¬¡æ˜¾ç¤ºå‡ºæœ€å·®çš„ç»“æœã€‚ æœ‰è¶£çš„æ˜¯ï¼Œæ²¡æœ‰keepaliveçš„httpè¯·æ±‚çš„è¡Œä¸ºéå¸¸ç¨³å®šï¼Œå³ä½¿æœ‰2Kä¸ªå¹¶å‘ç”¨æˆ·ï¼Œå…¶å»¶è¿Ÿä¹Ÿä½äº50msã€‚å¦‚æœæ²¡æœ‰keepaliveï¼Œå»¶è¿Ÿå°†æ›´åŠ å¯é¢„æµ‹ï¼Œå¹¶ä¸”stdevå°†éšç€å¹¶å‘æ€§çš„å¢åŠ è€Œä¿æŒè¾ƒå°çš„å€¼ï¼Œä½†æ˜¯QPSçš„é€Ÿç‡ä¼šé™ä½ä¸€äº›ã€‚å®ƒå¯èƒ½ä¸webserverçš„å®ç°ç»†èŠ‚æœ‰å…³:ä¾‹å¦‚ï¼Œå½“æ¯ä¸ªè¿æ¥ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šä½¿æœåŠ¡å™¨å˜æ…¢ï¼Œå¹¶åœ¨ä¸€å®šçš„å¹¶å‘çº§åˆ«åå¢åŠ å»¶è¿Ÿã€‚ æˆ‘ä»¬è¿˜æ£€æŸ¥äº†å…¶ä»–è®¾ç½®ï¼Œå¦‚max_concurrent_queriesã€queue_max_wait_msã€max_threadsã€network_compression_methodã€enable_http_compressionå’Œä¸€äº›è¾“å‡ºæ ¼å¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒæ•´å®ƒä»¬çš„æ•ˆæœåŸºæœ¬ä¸Šå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ Effects of multithreadingé»˜è®¤æƒ…å†µä¸‹ï¼ŒClickHouseä½¿ç”¨å¤šä¸ªçº¿ç¨‹æ¥å¤„ç†æ›´å¤§çš„æŸ¥è¯¢ï¼Œä»è€Œæœ‰æ•ˆåœ°ä½¿ç”¨æ‰€æœ‰çš„CPUæ ¸å¿ƒã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨æœ‰å¤§é‡çš„å¹¶å‘è¿æ¥ï¼Œå¤šçº¿ç¨‹å°†åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ã€é‡æ–°è¿æ¥çº¿ç¨‹å’Œå·¥ä½œåŒæ­¥æ–¹é¢äº§ç”Ÿé¢å¤–çš„æˆæœ¬ã€‚ ä¸ºäº†è¡¡é‡å¹¶å‘è¿æ¥å’Œå¤šçº¿ç¨‹çš„äº¤äº’ä½œç”¨, æˆ‘ä»¬çœ‹çœ‹åœ¨ä½¿ç”¨é»˜è®¤çš„multithreadingè®¾ç½®(æˆ‘è®¤ä¸ºè¿™é‡Œä½œè€…æ˜¯æŒ‡max_threadsé»˜è®¤å€¼, å³ä¸ºthe number of physical CPU cores)å’ŒæŒ‡å®šmax_threads=1ä¸¤ç§æƒ…å†µä¸‹è¿è¡ŒæŸ¥è¯¢â€synthetic select for finding maximum of 100K random numbersâ€(è¿™é‡Œåº”è¯¥æ˜¯æŒ‡æŸ¥è¯¢system.numbers_mtè¡¨)çš„æ€§èƒ½å·®å¼‚ To measure the interaction of concurrent connections and multithreading letâ€™s look at the difference in a synthetic select for finding maximum of 100K random numbers with default multithreading settings and with max_threads=1. ç»“è®ºå¾ˆç®€å•:è¦åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­å®ç°æ›´é«˜çš„QPSï¼Œä½¿ç”¨max_threads=1è®¾ç½®ã€‚ To Be Continuedâ€¦æœ¬æ–‡ä»‹ç»äº†ClickHouseçš„ä¸€èˆ¬è¿æ¥æµ‹è¯•ã€‚æˆ‘ä»¬æ£€æŸ¥äº†æœåŠ¡å™¨æœ¬èº«çš„é€Ÿåº¦æœ‰å¤šå¿«ï¼Œå®ƒå¯ä»¥å¤„ç†å¤šå°‘ä¸ªç®€å•çš„æŸ¥è¯¢ï¼Œä»¥åŠåœ¨é«˜å¹¶å‘æ€§åœºæ™¯ä¸­å“ªäº›è®¾ç½®ä¼šå½±å“QPSã€‚è¯·å‚é˜…åç»­æ–‡ç« ï¼Œå…¶ä¸­æˆ‘ä»¬æ·±å…¥ç ”ç©¶äº†åœ¨é”®å€¼åœºæ™¯ä¸­ä¼°è®¡å®é™…æŸ¥è¯¢çš„æœ€å¤§QPSï¼Œè¿™å°†å‘æµ‹è¯•ç”¨ä¾‹æ·»åŠ æ•°æ®ã€‚ åŸæ–‡é“¾æ¥:https://www.altinity.com/blog/clickhouse-in-the-storm-part-1","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"}]},{"title":"ClickHouseå¤šå®ä¾‹éƒ¨ç½²","slug":"2020-05-02-ClickHouseå¤šå®ä¾‹éƒ¨ç½²","date":"2020-05-02T15:46:00.000Z","updated":"2020-09-22T02:35:42.616Z","comments":true,"path":"2020/05/02/2020-05-02-ClickHouseå¤šå®ä¾‹éƒ¨ç½²/","link":"","permalink":"http://fuxkdb.com/2020/05/02/2020-05-02-ClickHouse%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2/","excerpt":"ClickHouseå¤šå®ä¾‹éƒ¨ç½²æœ¬äººåˆšæ¥è§¦ClickHouseä¸¤å‘¨, éš¾å…æœ‰é”™è¯¯ä¹‹å¤„, æ„Ÿè°¢æŒ‡æ­£. å¦å¤–ä¸€äº›å‚æ•°æˆ‘ä¹Ÿä¸ç”šç†è§£, å¤§å®¶ä¹Ÿå¯ä»¥å…ˆä¸å¿…çº ç»“å‚æ•°, å…ˆéƒ¨ç½²èµ·æ¥å†è¯´, æˆ‘çš„æ„Ÿè§¦æ˜¯éƒ¨ç½²åå°±ä¼šå¯¹æ•´ä½“ç»“æ„æœ‰äº†ä¸€éè®¤è¯†. å¦‚æœå¤šå®ä¾‹éƒ½å¯ä»¥éƒ¨ç½²å®Œæ¯•, é‚£ä¹ˆç”Ÿäº§å•å®ä¾‹éƒ¨ç½²å½“ç„¶å°±ä¸æˆé—®é¢˜äº†. ç”Ÿäº§ç¯å¢ƒå¹¶ä¸å»ºè®®å¤šå®ä¾‹éƒ¨ç½², ClickHouseä¸€ä¸ªæŸ¥è¯¢å¯ä»¥ç”¨åˆ°å¤šä¸ªCPU, æœ¬ä¾‹åªé€‚ç”¨äºæµ‹è¯•ç¯å¢ƒ","text":"ClickHouseå¤šå®ä¾‹éƒ¨ç½²æœ¬äººåˆšæ¥è§¦ClickHouseä¸¤å‘¨, éš¾å…æœ‰é”™è¯¯ä¹‹å¤„, æ„Ÿè°¢æŒ‡æ­£. å¦å¤–ä¸€äº›å‚æ•°æˆ‘ä¹Ÿä¸ç”šç†è§£, å¤§å®¶ä¹Ÿå¯ä»¥å…ˆä¸å¿…çº ç»“å‚æ•°, å…ˆéƒ¨ç½²èµ·æ¥å†è¯´, æˆ‘çš„æ„Ÿè§¦æ˜¯éƒ¨ç½²åå°±ä¼šå¯¹æ•´ä½“ç»“æ„æœ‰äº†ä¸€éè®¤è¯†. å¦‚æœå¤šå®ä¾‹éƒ½å¯ä»¥éƒ¨ç½²å®Œæ¯•, é‚£ä¹ˆç”Ÿäº§å•å®ä¾‹éƒ¨ç½²å½“ç„¶å°±ä¸æˆé—®é¢˜äº†. ç”Ÿäº§ç¯å¢ƒå¹¶ä¸å»ºè®®å¤šå®ä¾‹éƒ¨ç½², ClickHouseä¸€ä¸ªæŸ¥è¯¢å¯ä»¥ç”¨åˆ°å¤šä¸ªCPU, æœ¬ä¾‹åªé€‚ç”¨äºæµ‹è¯•ç¯å¢ƒ éƒ¨ç½²è§„åˆ’ é›†ç¾¤éƒ¨ç½²å…³ç³»å¦‚ä¸‹: é€»è¾‘ç»“æ„å›¾å¦‚ä¸‹: ç¼–è¾‘ä¸‰å°ä¸»æœº/etc/hostsæ·»åŠ å¦‚ä¸‹å†…å®¹: 123172.16.120.10 centos-1172.16.120.11 centos-2172.16.120.12 centos-3 ä¾èµ–ç»„ä»¶å®‰è£…JDKä¸‹è½½openjdk12wget https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u242-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u242b08.tar.gztar -zxvf OpenJDK8U-jdk_x64_linux_hotspot_8u242b08.tar.gz -C /usr/local/ åšè½¯é“¾1ln -s /usr/local/jdk8u242-b08 /usr/local/java é…ç½®ç¯å¢ƒå˜é‡123456#vi ~/.bashrc export JAVA_HOME=/usr/local/javaexport JRE_HOME=$&#123;JAVA_HOME&#125;/jreexport CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/libexport PATH=$&#123;JAVA_HOME&#125;/bin:$PATH ZooKeeper3.6.0æœ‰bug æ‰€ä»¥æ”¹ç”¨ç¨³å®šç‰ˆæœ¬3.4.14 ä¸‹è½½å®‰è£…åŒ…12wget https://downloads.apache.org/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gztar -zxvf zookeeper-3.4.14.tar.gz -C /usr/local/ åšè½¯é“¾1ln -s /usr/local/zookeeper-3.4.14 /usr/local/zookeeper é…ç½®ç¯å¢ƒå˜é‡1234#vi ~/.bashrc export ZOOKEEPER_HOME=/usr/local/zookeeperexport PATH=$PATH:$ZOOKEEPER_HOME/bin ä¿®æ”¹é…ç½®æ–‡ä»¶1234567891011121314151617181920212223242526272829303132333435363738394041cd /usr/local/zookeeper/conf #å‚è€ƒå®˜æ–¹#https://clickhouse.tech/docs/en/operations/tips/#zookeeper#vim zoo.cfg tickTime=2000initLimit=30000syncLimit=10maxClientCnxns=2000maxSessionTimeout=60000000dataDir=/data/zookeeper/datadataLogDir=/data/zookeeper/logsautopurge.snapRetainCount=10autopurge.purgeInterval=1preAllocSize=131072snapCount=3000000leaderServes=yesclientPort=2181 é›†ç¾¤é…ç½®éƒ¨åˆ†ä¸‰ä¸ªèŠ‚ç‚¹åˆ†åˆ«ä¸º:# centos-1server.1=0.0.0.0:2888:3888server.2=172.16.120.11:2888:3888server.3=172.16.120.12:2888:3888 # centos-2server.1=172.16.120.10:2888:3888server.2=0.0.0.0:2888:3888server.3=172.16.120.12:2888:3888 # centos-3server.1=172.16.120.10:2888:3888server.2=172.16.120.11:2888:3888server.3=0.0.0.0:2888:3888 åˆ›å»ºç›®å½•12mkdir -p /data/zookeeper/&#123;data,logs&#125;mkdir -p /usr/local/zookeeper/logs myid12345678# centos-1echo &quot;1&quot;&gt;/data/zookeeper/data/myid # centos-2echo &quot;2&quot;&gt;/data/zookeeper/data/myid # centos-3echo &quot;3&quot;&gt;/data/zookeeper/data/myid é…ç½®zkæ—¥å¿—é»˜è®¤zkæ—¥å¿—è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶,ä¸”ä¸ä¼šè‡ªåŠ¨æ¸…ç†,æ‰€ä»¥,ä¸€æ®µæ—¶é—´åzkæ—¥å¿—ä¼šéå¸¸å¤§ 1.zookeeper-env.sh ./confç›®å½•ä¸‹æ–°å»ºzookeeper-env.shæ–‡ä»¶,ä¿®æ”¹åˆ°sudo chmod 755 zookeeper-env.shæƒé™12345678#cat conf/zookeeper-env.sh #!/usr/bin/env bash#tip:custom configurationfileï¼Œdo not amend the zkEnv.sh file#chang the log dir and output of rolling file ZOO_LOG_DIR=&quot;/usr/local/zookeeper/logs&quot;ZOO_LOG4J_PROP=&quot;INFO,ROLLINGFILE&quot; 2.log4j.properties ä¿®æ”¹æ—¥å¿—çš„è¾“å…¥å½¢å¼12345678zookeeper.root.logger=INFO, ROLLINGFILE#zookeeper.root.logger=INFO, CONSOLE # Max log file size of 10MBlog4j.appender.ROLLINGFILE.MaxFileSize=128MB# uncomment the next line to limit number of backup fileslog4j.appender.ROLLINGFILE.MaxBackupIndex=10 é…ç½®è¿è¡Œzkçš„JVM./confç›®å½•ä¸‹æ–°å»ºjava.envæ–‡ä»¶,ä¿®æ”¹åˆ°sudo chmod 755 java.envæƒé™,ä¸»è¦ç”¨äºGC log,RAMç­‰çš„é…ç½®. 1234567#!/usr/bin/env bash#config the jvm parameter in a reasonable#note that the shell is source in so that do not need to use export#set java classpath#CLASSPATH=&quot;&quot;#set jvm start parameter , also can set JVMFLAGS variableSERVER_JVMFLAGS=&quot;-Xms1024m -Xmx2048m $JVMFLAGS&quot; å¯åŠ¨zookeeperæœåŠ¡(æ‰€æœ‰èŠ‚ç‚¹)1234# zkServer.sh startZooKeeper JMX enabled by defaultUsing config: /usr/local/zookeeper/bin/../conf/zoo.cfgStarting zookeeper ... STARTED éªŒè¯zk12345678910111213141516171819202122232425262728# zkServer.sh status #bin/zkCli.sh -server 127.0.0.1:2181Connecting to 127.0.0.1:2181 [zk: 127.0.0.1:2181(CONNECTED) 0][zk: 127.0.0.1:2181(CONNECTED) 0] ls /[zookeeper] [zk: 127.0.0.1:2181(CONNECTED) 1] create /zk_test mydataCreated /zk_test [zk: 127.0.0.1:2181(CONNECTED) 2] ls /[zk_test, zookeeper] [zk: 127.0.0.1:2181(CONNECTED) 3] get /zk_testmydata [zk: 127.0.0.1:2181(CONNECTED) 4] set /zk_test junk[zk: 127.0.0.1:2181(CONNECTED) 5] get /zk_testjunk [zk: 127.0.0.1:2181(CONNECTED) 6] delete /zk_test[zk: 127.0.0.1:2181(CONNECTED) 7] ls /[zookeeper] [zk: 127.0.0.1:2181(CONNECTED) 8] ClickHouseå®‰è£…yumå®‰è£…123456yum install yum-utilsrpm --import https://repo.clickhouse.tech/CLICKHOUSE-KEY.GPGyum-config-manager --add-repo https://repo.clickhouse.tech/rpm/stable/x86_64 yum install clickhouse-server clickhouse-client åˆ›å»ºç›®å½•12345678centos-1 åˆ›å»ºç›®å½•ï¼šmkdir -p /data/clickhouse/&#123;node1,node4&#125;/&#123;data,tmp,logs&#125; centos-2 åˆ›å»ºç›®å½•ï¼šmkdir -p /data/clickhouse/&#123;node2,node5&#125;/&#123;data,tmp,logs&#125; centos-3 åˆ›å»ºç›®å½•ï¼šmkdir -p /data/clickhouse/&#123;node3,node6&#125;/&#123;data,tmp,logs&#125; åˆ›å»ºé…ç½®æ–‡ä»¶é…ç½®clickhouseå‚æ•°æ–‡ä»¶ï¼Œè´¦æˆ·æ–‡ä»¶ï¼Œåˆ†ç‰‡é…ç½®æ–‡ä»¶ è¿™éƒ¨åˆ†ä¼šå•°å—¦ä¸€äº›, èŠ‚ç‚¹é—´æœ‰ä¸€äº›é‡å¤çš„é…ç½®ä¸ºäº†æ–¹ä¾¿ä¹Ÿæ²¡æœ‰çœç•¥, éƒ½è´´å‡ºæ¥äº†, ç…§ç€é…ç½®å°±å¯ä»¥äº† node1é…ç½®æ–‡ä»¶å¦‚ä¸‹config.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--æ—¥å¿—--&gt; &lt;logger&gt; &lt;level&gt;warning&lt;/level&gt; &lt;log&gt;/data/clickhouse/node1/logs/clickhouse.log&lt;/log&gt; &lt;errorlog&gt;/data/clickhouse/node1/logs/error.log&lt;/errorlog&gt; &lt;size&gt;500M&lt;/size&gt; &lt;count&gt;5&lt;/count&gt; &lt;/logger&gt; &lt;!--æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯--&gt; &lt;http_port&gt;8123&lt;/http_port&gt; &lt;tcp_port&gt;9000&lt;/tcp_port&gt; &lt;interserver_http_port&gt;9009&lt;/interserver_http_port&gt; &lt;interserver_http_host&gt;centos-1&lt;/interserver_http_host&gt; &lt;!--æœ¬æœºåŸŸåæˆ–IP--&gt; &lt;!--æœ¬åœ°é…ç½®--&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;max_connections&gt;2048&lt;/max_connections&gt; &lt;receive_timeout&gt;800&lt;/receive_timeout&gt; &lt;send_timeout&gt;800&lt;/send_timeout&gt; &lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt; &lt;max_concurrent_queries&gt;64&lt;/max_concurrent_queries&gt; &lt;uncompressed_cache_size&gt;4294967296&lt;/uncompressed_cache_size&gt; &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt; &lt;path&gt;/data/clickhouse/node1/&lt;/path&gt; &lt;tmp_path&gt;/data/clickhouse/node1/tmp/&lt;/tmp_path&gt; &lt;users_config&gt;/data/clickhouse/node1/users.xml&lt;/users_config&gt; &lt;default_profile&gt;default&lt;/default_profile&gt; &lt;query_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_log&gt; &lt;query_thread_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_thread_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_thread_log&gt; &lt;prometheus&gt; &lt;endpoint&gt;/metrics&lt;/endpoint&gt; &lt;port&gt;8001&lt;/port&gt; &lt;metrics&gt;true&lt;/metrics&gt; &lt;events&gt;true&lt;/events&gt; &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt; &lt;/prometheus&gt; &lt;default_database&gt;default&lt;/default_database&gt; &lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt; &lt;!--é›†ç¾¤ç›¸å…³é…ç½®--&gt; &lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt; &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;macros incl=&quot;macros&quot; optional=&quot;true&quot; /&gt; &lt;builtin_dictionaries_reload_interval&gt;3600&lt;/builtin_dictionaries_reload_interval&gt; &lt;max_session_timeout&gt;3600&lt;/max_session_timeout&gt; &lt;default_session_timeout&gt;300&lt;/default_session_timeout&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;merge_tree&gt; &lt;parts_to_delay_insert&gt;300&lt;/parts_to_delay_insert&gt; &lt;parts_to_throw_insert&gt;600&lt;/parts_to_throw_insert&gt; &lt;max_delay_to_insert&gt;2&lt;/max_delay_to_insert&gt; &lt;/merge_tree&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;max_partition_size_to_drop&gt;0&lt;/max_partition_size_to_drop&gt; &lt;distributed_ddl&gt; &lt;!-- Path in ZooKeeper to queue with DDL queries --&gt; &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt; &lt;/distributed_ddl&gt; &lt;include_from&gt;/data/clickhouse/node1/metrika.xml&lt;/include_from&gt;&lt;/yandex&gt; users.xml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;!-- è¯·æ ¹æ®è‡ªå·±æœºå™¨å®é™…å†…å­˜é…ç½® --&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/readonly&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;/users&gt;&lt;/yandex&gt; metrika.xml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--cké›†ç¾¤èŠ‚ç‚¹--&gt; &lt;clickhouse_remote_servers&gt; &lt;ch_cluster_all&gt; &lt;!--åˆ†ç‰‡1--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†1--&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡2--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†2--&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡3--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†3--&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/ch_cluster_all&gt; &lt;/clickhouse_remote_servers&gt; &lt;!--zookeeperç›¸å…³é…ç½®--&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;layer&gt;01&lt;/layer&gt; &lt;shard&gt;01&lt;/shard&gt; &lt;!--åˆ†ç‰‡å·--&gt; &lt;replica&gt;node1&lt;/replica&gt; &lt;!--å½“å‰èŠ‚ç‚¹IP--&gt; &lt;/macros&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;!--å‹ç¼©ç›¸å…³é…ç½®--&gt; &lt;clickhouse_compression&gt; &lt;case&gt; &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt; &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt; &lt;method&gt;lz4&lt;/method&gt; &lt;!--å‹ç¼©ç®—æ³•lz4å‹ç¼©æ¯”zstdå¿«, æ›´å ç£ç›˜--&gt; &lt;/case&gt; &lt;/clickhouse_compression&gt;&lt;/yandex&gt; node2é…ç½®æ–‡ä»¶å¦‚ä¸‹:config.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--æ—¥å¿—--&gt; &lt;logger&gt; &lt;level&gt;warning&lt;/level&gt; &lt;log&gt;/data/clickhouse/node2/logs/clickhouse.log&lt;/log&gt; &lt;errorlog&gt;/data/clickhouse/node2/logs/error.log&lt;/errorlog&gt; &lt;size&gt;500M&lt;/size&gt; &lt;count&gt;5&lt;/count&gt; &lt;/logger&gt; &lt;!--æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯--&gt; &lt;http_port&gt;8123&lt;/http_port&gt; &lt;tcp_port&gt;9000&lt;/tcp_port&gt; &lt;interserver_http_port&gt;9009&lt;/interserver_http_port&gt; &lt;interserver_http_host&gt;centos-2&lt;/interserver_http_host&gt; &lt;!--æœ¬æœºåŸŸåæˆ–IP--&gt; &lt;!--æœ¬åœ°é…ç½®--&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;max_connections&gt;2048&lt;/max_connections&gt; &lt;receive_timeout&gt;800&lt;/receive_timeout&gt; &lt;send_timeout&gt;800&lt;/send_timeout&gt; &lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt; &lt;max_concurrent_queries&gt;64&lt;/max_concurrent_queries&gt; &lt;uncompressed_cache_size&gt;4294967296&lt;/uncompressed_cache_size&gt; &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt; &lt;path&gt;/data/clickhouse/node2/&lt;/path&gt; &lt;tmp_path&gt;/data/clickhouse/node2/tmp/&lt;/tmp_path&gt; &lt;users_config&gt;/data/clickhouse/node2/users.xml&lt;/users_config&gt; &lt;default_profile&gt;default&lt;/default_profile&gt; &lt;query_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_log&gt; &lt;query_thread_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_thread_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_thread_log&gt; &lt;prometheus&gt; &lt;endpoint&gt;/metrics&lt;/endpoint&gt; &lt;port&gt;8001&lt;/port&gt; &lt;metrics&gt;true&lt;/metrics&gt; &lt;events&gt;true&lt;/events&gt; &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt; &lt;/prometheus&gt; &lt;default_database&gt;default&lt;/default_database&gt; &lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt; &lt;!--é›†ç¾¤ç›¸å…³é…ç½®--&gt; &lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt; &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;macros incl=&quot;macros&quot; optional=&quot;true&quot; /&gt; &lt;builtin_dictionaries_reload_interval&gt;3600&lt;/builtin_dictionaries_reload_interval&gt; &lt;max_session_timeout&gt;3600&lt;/max_session_timeout&gt; &lt;default_session_timeout&gt;300&lt;/default_session_timeout&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;merge_tree&gt; &lt;parts_to_delay_insert&gt;300&lt;/parts_to_delay_insert&gt; &lt;parts_to_throw_insert&gt;600&lt;/parts_to_throw_insert&gt; &lt;max_delay_to_insert&gt;2&lt;/max_delay_to_insert&gt; &lt;/merge_tree&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;max_partition_size_to_drop&gt;0&lt;/max_partition_size_to_drop&gt; &lt;distributed_ddl&gt; &lt;!-- Path in ZooKeeper to queue with DDL queries --&gt; &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt; &lt;/distributed_ddl&gt; &lt;include_from&gt;/data/clickhouse/node2/metrika.xml&lt;/include_from&gt;&lt;/yandex&gt; users.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;!-- è¯·æ ¹æ®è‡ªå·±æœºå™¨å®é™…å†…å­˜é…ç½® --&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/readonly&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;/users&gt;&lt;/yandex&gt; metrika.xml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--cké›†ç¾¤èŠ‚ç‚¹--&gt; &lt;clickhouse_remote_servers&gt; &lt;ch_cluster_all&gt; &lt;!--åˆ†ç‰‡1--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†1--&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡2--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†2--&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡3--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†3--&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/ch_cluster_all&gt; &lt;/clickhouse_remote_servers&gt; &lt;!--zookeeperç›¸å…³é…ç½®--&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;layer&gt;01&lt;/layer&gt; &lt;shard&gt;02&lt;/shard&gt; &lt;!--åˆ†ç‰‡å·--&gt; &lt;replica&gt;node2&lt;/replica&gt; &lt;!--å½“å‰èŠ‚ç‚¹IP--&gt; &lt;/macros&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;!--å‹ç¼©ç›¸å…³é…ç½®--&gt; &lt;clickhouse_compression&gt; &lt;case&gt; &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt; &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt; &lt;method&gt;lz4&lt;/method&gt; &lt;!--å‹ç¼©ç®—æ³•lz4å‹ç¼©æ¯”zstdå¿«, æ›´å ç£ç›˜--&gt; &lt;/case&gt; &lt;/clickhouse_compression&gt;&lt;/yandex&gt; node3é…ç½®æ–‡ä»¶å¦‚ä¸‹:config.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--æ—¥å¿—--&gt; &lt;logger&gt; &lt;level&gt;warning&lt;/level&gt; &lt;log&gt;/data/clickhouse/node3/logs/clickhouse.log&lt;/log&gt; &lt;errorlog&gt;/data/clickhouse/node3/logs/error.log&lt;/errorlog&gt; &lt;size&gt;500M&lt;/size&gt; &lt;count&gt;5&lt;/count&gt; &lt;/logger&gt; &lt;!--æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯--&gt; &lt;http_port&gt;8123&lt;/http_port&gt; &lt;tcp_port&gt;9000&lt;/tcp_port&gt; &lt;interserver_http_port&gt;9009&lt;/interserver_http_port&gt; &lt;interserver_http_host&gt;centos-3&lt;/interserver_http_host&gt; &lt;!--æœ¬æœºåŸŸåæˆ–IP--&gt; &lt;!--æœ¬åœ°é…ç½®--&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;max_connections&gt;2048&lt;/max_connections&gt; &lt;receive_timeout&gt;800&lt;/receive_timeout&gt; &lt;send_timeout&gt;800&lt;/send_timeout&gt; &lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt; &lt;max_concurrent_queries&gt;64&lt;/max_concurrent_queries&gt; &lt;uncompressed_cache_size&gt;4294967296&lt;/uncompressed_cache_size&gt; &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt; &lt;path&gt;/data/clickhouse/node3/&lt;/path&gt; &lt;tmp_path&gt;/data/clickhouse/node3/tmp/&lt;/tmp_path&gt; &lt;users_config&gt;/data/clickhouse/node3/users.xml&lt;/users_config&gt; &lt;default_profile&gt;default&lt;/default_profile&gt; &lt;query_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_log&gt; &lt;query_thread_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_thread_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_thread_log&gt; &lt;prometheus&gt; &lt;endpoint&gt;/metrics&lt;/endpoint&gt; &lt;port&gt;8001&lt;/port&gt; &lt;metrics&gt;true&lt;/metrics&gt; &lt;events&gt;true&lt;/events&gt; &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt; &lt;/prometheus&gt; &lt;default_database&gt;default&lt;/default_database&gt; &lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt; &lt;!--é›†ç¾¤ç›¸å…³é…ç½®--&gt; &lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt; &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;macros incl=&quot;macros&quot; optional=&quot;true&quot; /&gt; &lt;builtin_dictionaries_reload_interval&gt;3600&lt;/builtin_dictionaries_reload_interval&gt; &lt;max_session_timeout&gt;3600&lt;/max_session_timeout&gt; &lt;default_session_timeout&gt;300&lt;/default_session_timeout&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;merge_tree&gt; &lt;parts_to_delay_insert&gt;300&lt;/parts_to_delay_insert&gt; &lt;parts_to_throw_insert&gt;600&lt;/parts_to_throw_insert&gt; &lt;max_delay_to_insert&gt;2&lt;/max_delay_to_insert&gt; &lt;/merge_tree&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;max_partition_size_to_drop&gt;0&lt;/max_partition_size_to_drop&gt; &lt;distributed_ddl&gt; &lt;!-- Path in ZooKeeper to queue with DDL queries --&gt; &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt; &lt;/distributed_ddl&gt; &lt;include_from&gt;/data/clickhouse/node3/metrika.xml&lt;/include_from&gt;&lt;/yandex&gt; users.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;!-- è¯·æ ¹æ®è‡ªå·±æœºå™¨å®é™…å†…å­˜é…ç½® --&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/readonly&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;/users&gt;&lt;/yandex&gt; metrika.xml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--cké›†ç¾¤èŠ‚ç‚¹--&gt; &lt;clickhouse_remote_servers&gt; &lt;ch_cluster_all&gt; &lt;!--åˆ†ç‰‡1--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†1--&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡2--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†2--&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡3--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†3--&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/ch_cluster_all&gt; &lt;/clickhouse_remote_servers&gt; &lt;!--zookeeperç›¸å…³é…ç½®--&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;layer&gt;01&lt;/layer&gt; &lt;shard&gt;03&lt;/shard&gt; &lt;!--åˆ†ç‰‡å·--&gt; &lt;replica&gt;node3&lt;/replica&gt; &lt;!--å½“å‰èŠ‚ç‚¹IP--&gt; &lt;/macros&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;!--å‹ç¼©ç›¸å…³é…ç½®--&gt; &lt;clickhouse_compression&gt; &lt;case&gt; &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt; &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt; &lt;method&gt;lz4&lt;/method&gt; &lt;!--å‹ç¼©ç®—æ³•lz4å‹ç¼©æ¯”zstdå¿«, æ›´å ç£ç›˜--&gt; &lt;/case&gt; &lt;/clickhouse_compression&gt;&lt;/yandex&gt; node4é…ç½®æ–‡ä»¶å¦‚ä¸‹:config.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--æ—¥å¿—--&gt; &lt;logger&gt; &lt;level&gt;warning&lt;/level&gt; &lt;log&gt;/data/clickhouse/node4/logs/clickhouse.log&lt;/log&gt; &lt;errorlog&gt;/data/clickhouse/node4/logs/error.log&lt;/errorlog&gt; &lt;size&gt;500M&lt;/size&gt; &lt;count&gt;5&lt;/count&gt; &lt;/logger&gt; &lt;!--æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯--&gt; &lt;http_port&gt;8124&lt;/http_port&gt; &lt;tcp_port&gt;9002&lt;/tcp_port&gt; &lt;interserver_http_port&gt;9010&lt;/interserver_http_port&gt; &lt;interserver_http_host&gt;centos-1&lt;/interserver_http_host&gt; &lt;!--æœ¬æœºåŸŸåæˆ–IP--&gt; &lt;!--æœ¬åœ°é…ç½®--&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;max_connections&gt;2048&lt;/max_connections&gt; &lt;receive_timeout&gt;800&lt;/receive_timeout&gt; &lt;send_timeout&gt;800&lt;/send_timeout&gt; &lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt; &lt;max_concurrent_queries&gt;64&lt;/max_concurrent_queries&gt; &lt;uncompressed_cache_size&gt;4294967296&lt;/uncompressed_cache_size&gt; &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt; &lt;path&gt;/data/clickhouse/node4/&lt;/path&gt; &lt;tmp_path&gt;/data/clickhouse/node4/tmp/&lt;/tmp_path&gt; &lt;users_config&gt;/data/clickhouse/node4/users.xml&lt;/users_config&gt; &lt;default_profile&gt;default&lt;/default_profile&gt; &lt;query_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_log&gt; &lt;query_thread_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_thread_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_thread_log&gt; &lt;prometheus&gt; &lt;endpoint&gt;/metrics&lt;/endpoint&gt; &lt;port&gt;8002&lt;/port&gt; &lt;metrics&gt;true&lt;/metrics&gt; &lt;events&gt;true&lt;/events&gt; &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt; &lt;/prometheus&gt; &lt;default_database&gt;default&lt;/default_database&gt; &lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt; &lt;!--é›†ç¾¤ç›¸å…³é…ç½®--&gt; &lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt; &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;macros incl=&quot;macros&quot; optional=&quot;true&quot; /&gt; &lt;builtin_dictionaries_reload_interval&gt;3600&lt;/builtin_dictionaries_reload_interval&gt; &lt;max_session_timeout&gt;3600&lt;/max_session_timeout&gt; &lt;default_session_timeout&gt;300&lt;/default_session_timeout&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;merge_tree&gt; &lt;parts_to_delay_insert&gt;300&lt;/parts_to_delay_insert&gt; &lt;parts_to_throw_insert&gt;600&lt;/parts_to_throw_insert&gt; &lt;max_delay_to_insert&gt;2&lt;/max_delay_to_insert&gt; &lt;/merge_tree&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;max_partition_size_to_drop&gt;0&lt;/max_partition_size_to_drop&gt; &lt;distributed_ddl&gt; &lt;!-- Path in ZooKeeper to queue with DDL queries --&gt; &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt; &lt;/distributed_ddl&gt; &lt;include_from&gt;/data/clickhouse/node4/metrika.xml&lt;/include_from&gt;&lt;/yandex&gt; users.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;!-- è¯·æ ¹æ®è‡ªå·±æœºå™¨å®é™…å†…å­˜é…ç½® --&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/readonly&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;/users&gt;&lt;/yandex&gt; metrika.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--cké›†ç¾¤èŠ‚ç‚¹--&gt; &lt;clickhouse_remote_servers&gt; &lt;ch_cluster_all&gt; &lt;!--åˆ†ç‰‡1--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†1--&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡2--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†2--&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡3--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†3--&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/ch_cluster_all&gt; &lt;/clickhouse_remote_servers&gt; &lt;!--zookeeperç›¸å…³é…ç½®--&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;layer&gt;01&lt;/layer&gt; &lt;shard&gt;02&lt;/shard&gt; &lt;!--åˆ†ç‰‡å·--&gt; &lt;replica&gt;node4&lt;/replica&gt; &lt;/macros&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;!--å‹ç¼©ç›¸å…³é…ç½®--&gt; &lt;clickhouse_compression&gt; &lt;case&gt; &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt; &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt; &lt;method&gt;lz4&lt;/method&gt; &lt;!--å‹ç¼©ç®—æ³•lz4å‹ç¼©æ¯”zstdå¿«, æ›´å ç£ç›˜--&gt; &lt;/case&gt; &lt;/clickhouse_compression&gt;&lt;/yandex&gt; node5é…ç½®æ–‡ä»¶å¦‚ä¸‹:config.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--æ—¥å¿—--&gt; &lt;logger&gt; &lt;level&gt;warning&lt;/level&gt; &lt;log&gt;/data/clickhouse/node5/logs/clickhouse.log&lt;/log&gt; &lt;errorlog&gt;/data/clickhouse/node5/logs/error.log&lt;/errorlog&gt; &lt;size&gt;500M&lt;/size&gt; &lt;count&gt;5&lt;/count&gt; &lt;/logger&gt; &lt;!--æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯--&gt; &lt;http_port&gt;8124&lt;/http_port&gt; &lt;tcp_port&gt;9002&lt;/tcp_port&gt; &lt;interserver_http_port&gt;9010&lt;/interserver_http_port&gt; &lt;interserver_http_host&gt;centos-2&lt;/interserver_http_host&gt; &lt;!--æœ¬æœºåŸŸåæˆ–IP--&gt; &lt;!--æœ¬åœ°é…ç½®--&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;max_connections&gt;2048&lt;/max_connections&gt; &lt;receive_timeout&gt;800&lt;/receive_timeout&gt; &lt;send_timeout&gt;800&lt;/send_timeout&gt; &lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt; &lt;max_concurrent_queries&gt;64&lt;/max_concurrent_queries&gt; &lt;uncompressed_cache_size&gt;4294967296&lt;/uncompressed_cache_size&gt; &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt; &lt;path&gt;/data/clickhouse/node5/&lt;/path&gt; &lt;tmp_path&gt;/data/clickhouse/node5/tmp/&lt;/tmp_path&gt; &lt;users_config&gt;/data/clickhouse/node5/users.xml&lt;/users_config&gt; &lt;default_profile&gt;default&lt;/default_profile&gt; &lt;query_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_log&gt; &lt;query_thread_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_thread_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_thread_log&gt; &lt;prometheus&gt; &lt;endpoint&gt;/metrics&lt;/endpoint&gt; &lt;port&gt;8002&lt;/port&gt; &lt;metrics&gt;true&lt;/metrics&gt; &lt;events&gt;true&lt;/events&gt; &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt; &lt;/prometheus&gt; &lt;default_database&gt;default&lt;/default_database&gt; &lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt; &lt;!--é›†ç¾¤ç›¸å…³é…ç½®--&gt; &lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt; &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;macros incl=&quot;macros&quot; optional=&quot;true&quot; /&gt; &lt;builtin_dictionaries_reload_interval&gt;3600&lt;/builtin_dictionaries_reload_interval&gt; &lt;max_session_timeout&gt;3600&lt;/max_session_timeout&gt; &lt;default_session_timeout&gt;300&lt;/default_session_timeout&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;merge_tree&gt; &lt;parts_to_delay_insert&gt;300&lt;/parts_to_delay_insert&gt; &lt;parts_to_throw_insert&gt;600&lt;/parts_to_throw_insert&gt; &lt;max_delay_to_insert&gt;2&lt;/max_delay_to_insert&gt; &lt;/merge_tree&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;max_partition_size_to_drop&gt;0&lt;/max_partition_size_to_drop&gt; &lt;distributed_ddl&gt; &lt;!-- Path in ZooKeeper to queue with DDL queries --&gt; &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt; &lt;/distributed_ddl&gt; &lt;include_from&gt;/data/clickhouse/node5/metrika.xml&lt;/include_from&gt;&lt;/yandex&gt; users.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;!-- è¯·æ ¹æ®è‡ªå·±æœºå™¨å®é™…å†…å­˜é…ç½® --&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/readonly&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;/users&gt;&lt;/yandex&gt; metrika.xml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--cké›†ç¾¤èŠ‚ç‚¹--&gt; &lt;clickhouse_remote_servers&gt; &lt;ch_cluster_all&gt; &lt;!--åˆ†ç‰‡1--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†1--&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡2--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†2--&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡3--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†3--&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/ch_cluster_all&gt; &lt;/clickhouse_remote_servers&gt; &lt;!--zookeeperç›¸å…³é…ç½®--&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;layer&gt;01&lt;/layer&gt; &lt;shard&gt;03&lt;/shard&gt; &lt;!--åˆ†ç‰‡å·--&gt; &lt;replica&gt;node5&lt;/replica&gt; &lt;!--å½“å‰èŠ‚ç‚¹IP--&gt; &lt;/macros&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;!--å‹ç¼©ç›¸å…³é…ç½®--&gt; &lt;clickhouse_compression&gt; &lt;case&gt; &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt; &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt; &lt;method&gt;lz4&lt;/method&gt; &lt;!--å‹ç¼©ç®—æ³•lz4å‹ç¼©æ¯”zstdå¿«, æ›´å ç£ç›˜--&gt; &lt;/case&gt; &lt;/clickhouse_compression&gt;&lt;/yandex&gt; node6é…ç½®æ–‡ä»¶å¦‚ä¸‹:config.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--æ—¥å¿—--&gt; &lt;logger&gt; &lt;level&gt;warning&lt;/level&gt; &lt;log&gt;/data/clickhouse/node6/logs/clickhouse.log&lt;/log&gt; &lt;errorlog&gt;/data/clickhouse/node6/logs/error.log&lt;/errorlog&gt; &lt;size&gt;500M&lt;/size&gt; &lt;count&gt;5&lt;/count&gt; &lt;/logger&gt; &lt;!--æœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯--&gt; &lt;http_port&gt;8124&lt;/http_port&gt; &lt;tcp_port&gt;9002&lt;/tcp_port&gt; &lt;interserver_http_port&gt;9010&lt;/interserver_http_port&gt; &lt;interserver_http_host&gt;centos-3&lt;/interserver_http_host&gt; &lt;!--æœ¬æœºåŸŸåæˆ–IP--&gt; &lt;!--æœ¬åœ°é…ç½®--&gt; &lt;listen_host&gt;0.0.0.0&lt;/listen_host&gt; &lt;max_connections&gt;2048&lt;/max_connections&gt; &lt;receive_timeout&gt;800&lt;/receive_timeout&gt; &lt;send_timeout&gt;800&lt;/send_timeout&gt; &lt;keep_alive_timeout&gt;3&lt;/keep_alive_timeout&gt; &lt;max_concurrent_queries&gt;64&lt;/max_concurrent_queries&gt; &lt;uncompressed_cache_size&gt;4294967296&lt;/uncompressed_cache_size&gt; &lt;mark_cache_size&gt;5368709120&lt;/mark_cache_size&gt; &lt;path&gt;/data/clickhouse/node6/&lt;/path&gt; &lt;tmp_path&gt;/data/clickhouse/node6/tmp/&lt;/tmp_path&gt; &lt;users_config&gt;/data/clickhouse/node6/users.xml&lt;/users_config&gt; &lt;default_profile&gt;default&lt;/default_profile&gt; &lt;query_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_log&gt; &lt;query_thread_log&gt; &lt;database&gt;system&lt;/database&gt; &lt;table&gt;query_thread_log&lt;/table&gt; &lt;partition_by&gt;toMonday(event_date)&lt;/partition_by&gt; &lt;flush_interval_milliseconds&gt;7500&lt;/flush_interval_milliseconds&gt; &lt;/query_thread_log&gt; &lt;prometheus&gt; &lt;endpoint&gt;/metrics&lt;/endpoint&gt; &lt;port&gt;8002&lt;/port&gt; &lt;metrics&gt;true&lt;/metrics&gt; &lt;events&gt;true&lt;/events&gt; &lt;asynchronous_metrics&gt;true&lt;/asynchronous_metrics&gt; &lt;/prometheus&gt; &lt;default_database&gt;default&lt;/default_database&gt; &lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt; &lt;!--é›†ç¾¤ç›¸å…³é…ç½®--&gt; &lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt; &lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; &lt;macros incl=&quot;macros&quot; optional=&quot;true&quot; /&gt; &lt;builtin_dictionaries_reload_interval&gt;3600&lt;/builtin_dictionaries_reload_interval&gt; &lt;max_session_timeout&gt;3600&lt;/max_session_timeout&gt; &lt;default_session_timeout&gt;300&lt;/default_session_timeout&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;merge_tree&gt; &lt;parts_to_delay_insert&gt;300&lt;/parts_to_delay_insert&gt; &lt;parts_to_throw_insert&gt;600&lt;/parts_to_throw_insert&gt; &lt;max_delay_to_insert&gt;2&lt;/max_delay_to_insert&gt; &lt;/merge_tree&gt; &lt;max_table_size_to_drop&gt;0&lt;/max_table_size_to_drop&gt; &lt;max_partition_size_to_drop&gt;0&lt;/max_partition_size_to_drop&gt; &lt;distributed_ddl&gt; &lt;!-- Path in ZooKeeper to queue with DDL queries --&gt; &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt; &lt;/distributed_ddl&gt; &lt;include_from&gt;/data/clickhouse/node6/metrika.xml&lt;/include_from&gt;&lt;/yandex&gt; users.xml1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;!-- è¯·æ ¹æ®è‡ªå·±æœºå™¨å®é™…å†…å­˜é…ç½® --&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/readonly&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;put_your_passwordsha256hex_here&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;/users&gt;&lt;/yandex&gt; metrika.xml123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;!--cké›†ç¾¤èŠ‚ç‚¹--&gt; &lt;clickhouse_remote_servers&gt; &lt;ch_cluster_all&gt; &lt;!--åˆ†ç‰‡1--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†1--&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡2--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†2--&gt; &lt;replica&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;!--åˆ†ç‰‡3--&gt; &lt;shard&gt; &lt;internal_replication&gt;true&lt;/internal_replication&gt; &lt;replica&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;9000&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;!--å¤åˆ¶é›†3--&gt; &lt;replica&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;9002&lt;/port&gt; &lt;user&gt;default&lt;/user&gt; &lt;password&gt;supersecrect&lt;/password&gt; &lt;/replica&gt; &lt;/shard&gt; &lt;/ch_cluster_all&gt; &lt;/clickhouse_remote_servers&gt; &lt;!--zookeeperç›¸å…³é…ç½®--&gt; &lt;zookeeper-servers&gt; &lt;node index=&quot;1&quot;&gt; &lt;host&gt;centos-1&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;2&quot;&gt; &lt;host&gt;centos-2&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;node index=&quot;3&quot;&gt; &lt;host&gt;centos-3&lt;/host&gt; &lt;port&gt;2181&lt;/port&gt; &lt;/node&gt; &lt;/zookeeper-servers&gt; &lt;macros&gt; &lt;layer&gt;01&lt;/layer&gt; &lt;shard&gt;01&lt;/shard&gt; &lt;!--åˆ†ç‰‡å·--&gt; &lt;replica&gt;node6&lt;/replica&gt; &lt;!--å½“å‰èŠ‚ç‚¹IP--&gt; &lt;/macros&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;!--å‹ç¼©ç›¸å…³é…ç½®--&gt; &lt;clickhouse_compression&gt; &lt;case&gt; &lt;min_part_size&gt;10000000000&lt;/min_part_size&gt; &lt;min_part_size_ratio&gt;0.01&lt;/min_part_size_ratio&gt; &lt;method&gt;lz4&lt;/method&gt; &lt;!--å‹ç¼©ç®—æ³•lz4å‹ç¼©æ¯”zstdå¿«, æ›´å ç£ç›˜--&gt; &lt;/case&gt; &lt;/clickhouse_compression&gt;&lt;/yandex&gt; ç”¨æˆ·å¯†ç ç”Ÿæˆæ–¹å¼å¯†ç ç”Ÿæˆæ–¹å¼ï¼š https://clickhouse.tech/docs/en/operations/settings/settings_users/ shellå‘½ä»¤è¡Œæ‰§è¡Œï¼š 1PASSWORD=$(base64 &lt; /dev/urandom | head -c8); echo &quot;$PASSWORD&quot;; echo -n &quot;$PASSWORD&quot; | sha256sum | tr -d &#x27;-&#x27; è¾“å‡ºç»“æœ 12X1UNizCSï¼ˆæ˜æ–‡å¯†ç ï¼‰379444c5e109e2f7e5f284831db54cd955011e6ae27d6e7a572cca635fbc7b1d ï¼ˆåŠ å¯†é•¿å¯†ç , å³password_sha256_hexï¼‰ ä¿®æ”¹å±ä¸»1cd /data &amp;&amp; chown -R clickhouse.clickhouse clickhouse è¿›ç¨‹å®ˆæŠ¤ä½¿ç”¨systemdç®¡ç† ä»¥node1ä¸ºä¾‹ 12345678910111213141516171819202122232425# vim /etc/systemd/system/clickhouse_node1.service [Unit]Description=ClickHouse Server (analytic DBMS for big data)Requires=network-online.targetAfter=network-online.target [Service]#Type=simpleType=forkingUser=clickhouseGroup=clickhouseRestart=alwaysRestartSec=30RuntimeDirectory=clickhouse-server#ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config.xml --pid-file=/run/clickhouse-server/clickhouse-server.pidExecStart=/usr/bin/clickhouse-server --daemon --config=/data/clickhouse/ch_9000/config.xml --pid-file=/data/clickhouse/node1/clickhouse-server.pid#PIDFile=/data/clickhouse/node1/clickhouse-server.pidLimitCORE=infinityLimitNOFILE=500000CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE [Install]WantedBy=multi-user.target ä»¥ä¸Šé¢çš„é…ç½®ä½œä¸ºæ¨¡æ¿åˆ›å»º node1~node6 çš„systemdé…ç½®æ–‡ä»¶ ClickHouseæœåŠ¡å¯åŠ¨123456789101112131415161718192021222324252627centos-1ä¸»æœºè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šsystemctl start clickhouse_node1.servicesystemctl start clickhouse_node4.service centos-2ä¸»æœºè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šsystemctl start clickhouse_node2.servicesystemctl start clickhouse_node5.service centos-3ä¸»æœºè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼šsystemctl start clickhouse_node3.servicesystemctl start clickhouse_node6.service éªŒè¯å¦‚ä¸‹ç«¯å£æ˜¯å¦è¢«ç›‘å¬ï¼šnetstat -anlp|grep 9000 ï¼ˆclickhouse tcpç«¯å£ï¼‰netstat -anlp|grep 9002 ï¼ˆclickhouse tcpç«¯å£ï¼‰netstat -anlp|grep 8123 (clickhouse httpç«¯å£)netstat -anlp|grep 8124 (clickhouse httpç«¯å£)netstat -anlp|grep 9009 (clickhouse æ•°æ®äº¤äº’ç«¯å£)netstat -anlp|grep 9010 (clickhouse æ•°æ®äº¤äº’ç«¯å£) ç™»é™†æ–¹å¼ï¼šclickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1 --query=&quot;show databases&quot; æµ‹è¯•é›†ç¾¤åŠŸèƒ½æ˜¯å¦æ­£å¸¸åˆ›å»ºæ•°æ®åº“testdb1234567891011121314151617181920# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1ClickHouse client version 20.3.4.10 (official build).Connecting to localhost:9000 as user default.Connected to ClickHouse server version 20.3.4 revision 54433.centos-1 :) create database testdb on cluster ch_cluster_all;CREATE DATABASE testdb ON CLUSTER ck_clusterâ”Œâ”€hostâ”€â”€â”€â”€â”€â”¬â”€portâ”€â”¬â”€statusâ”€â”¬â”€errorâ”€â”¬â”€num_hosts_remainingâ”€â”¬â”€num_hosts_activeâ”€â”â”‚ centos-3 â”‚ 9000 â”‚ 0 â”‚ â”‚ 5 â”‚ 0 â”‚â”‚ centos-2 â”‚ 9000 â”‚ 0 â”‚ â”‚ 4 â”‚ 0 â”‚â”‚ centos-1 â”‚ 9002 â”‚ 0 â”‚ â”‚ 3 â”‚ 0 â”‚â”‚ centos-3 â”‚ 9002 â”‚ 0 â”‚ â”‚ 2 â”‚ 0 â”‚â”‚ centos-1 â”‚ 9000 â”‚ 0 â”‚ â”‚ 1 â”‚ 0 â”‚â”‚ centos-2 â”‚ 9002 â”‚ 0 â”‚ â”‚ 0 â”‚ 0 â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜6 rows in set. Elapsed: 0.107 sec. åˆ›å»ºæœ¬åœ°è¡¨1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1 --query=&quot;CREATE TABLE testdb.sbtest_local(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/01-01/sbtest&#x27;,&#x27;node1&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID))SETTINGS index_granularity = 8192;&quot;clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-1 --query=&quot;CREATE TABLE testdb.sbtest_local(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/01-02/sbtest&#x27;,&#x27;node4&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID))SETTINGS index_granularity = 8192;&quot;clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-2 --query=&quot;CREATE TABLE testdb.sbtest_local(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/01-02/sbtest&#x27;,&#x27;node2&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID))SETTINGS index_granularity = 8192;&quot;clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-2 --query=&quot;CREATE TABLE testdb.sbtest_local(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/01-03/sbtest&#x27;,&#x27;node5&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID))SETTINGS index_granularity = 8192;&quot;clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-3 --query=&quot;CREATE TABLE testdb.sbtest_local(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/01-03/sbtest&#x27;,&#x27;node3&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID))SETTINGS index_granularity = 8192;&quot;clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-3 --query=&quot;CREATE TABLE testdb.sbtest_local(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/01-01/sbtest&#x27;,&#x27;node6&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID))SETTINGS index_granularity = 8192;&quot; åˆ›å»ºåˆ†å¸ƒå¼è¡¨1234567891011121314151617181920212223242526272829303132333435363738394041clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1 --query=&quot;CREATE TABLE testdb.sbtest (EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = Distributed(ck_cluster,testdb, sbtest_local, rand())&quot;clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-1 --query=&quot;CREATE TABLE testdb.sbtest (EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = Distributed(ck_cluster,testdb, sbtest_local, rand())&quot;clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-2 --query=&quot;CREATE TABLE testdb.sbtest (EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = Distributed(ck_cluster,testdb, sbtest_local, rand())&quot;clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-2 --query=&quot;CREATE TABLE testdb.sbtest (EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = Distributed(ck_cluster,testdb, sbtest_local, rand())&quot;clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-3 --query=&quot;CREATE TABLE testdb.sbtest (EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = Distributed(ck_cluster,testdb, sbtest_local, rand())&quot;clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-3 --query=&quot;CREATE TABLE testdb.sbtest (EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = Distributed(ck_cluster,testdb, sbtest_local, rand())&quot; éªŒè¯æ•°æ®å¤åˆ¶çŠ¶æ€ï¼šå†™å…¥åˆ†ç‰‡1ç»„çš„å†™å…¥èŠ‚ç‚¹çš„localè¡¨1# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1 --query=&quot;insert into testdb.sbtest_local VALUES (now(), 10000, 10000)&quot; åœ¨åˆ†ç‰‡1ç»„localè¡¨å¯è§ä¸€æ¡è®°å½•12# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1 --query=&quot;select * from testdb.sbtest_local&quot;2020-05-02 23:02:31 10000 10000 åœ¨åˆ†ç‰‡1 å‰¯æœ¬èŠ‚ç‚¹localè¯»å–å¯è§ä¸€æ¡è®°å½•12# clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-3 --query=&quot;select * from testdb.sbtest_local&quot;2020-05-02 23:02:31 10000 10000 å†™å…¥åˆ†ç‰‡2ç»„çš„å†™å…¥èŠ‚ç‚¹çš„localè¡¨1# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-2 --query=&quot;insert into testdb.sbtest_local VALUES (now(), 20000, 20000)&quot; åœ¨åˆ†ç‰‡2ç»„localè¡¨å¯è§ä¸€æ¡è®°å½•12# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-2 --query=&quot;select * from testdb.sbtest_local&quot;2020-05-02 23:03:31 20000 20000 åœ¨åˆ†ç‰‡2 å‰¯æœ¬èŠ‚ç‚¹localè¯»å–å¯è§ä¸€æ¡è®°å½•12# clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-1 --query=&quot;select * from testdb.sbtest_local&quot;2020-05-02 23:03:31 20000 20000 å†™å…¥åˆ†ç‰‡3ç»„çš„å†™å…¥èŠ‚ç‚¹çš„localè¡¨1# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-3 --query=&quot;insert into testdb.sbtest_local VALUES (now(), 30000, 30000)&quot; åœ¨åˆ†ç‰‡3ç»„localè¡¨å¯è§ä¸€æ¡è®°å½•12# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-3 --query=&quot;select * from testdb.sbtest_local&quot;2020-05-02 23:04:39 30000 30000 åœ¨åˆ†ç‰‡3 å‰¯æœ¬èŠ‚ç‚¹localè¯»å–å¯è§ä¸€æ¡è®°å½•12# clickhouse-client -u default --password xxxxxx --port 9002 -hcentos-2 --query=&quot;select * from testdb.sbtest_local&quot;2020-05-02 23:04:39 30000 30000 Distributedè¡¨éªŒè¯1234# clickhouse-client -u default --password xxxxxx --port 9000 -hcentos-1 --query=&quot;select * from testdb.sbtest&quot;2020-05-02 23:02:31 10000 100002020-05-02 23:03:31 20000 200002020-05-02 23:04:39 30000 30000 å¯ä»¥çœ‹åˆ°ç»“æœæ˜¯ä¹‹å‰å†™å…¥çš„3æ¡è®°å½• ç»“è®ºï¼ŒclickhouseåŸºæœ¬åŠŸèƒ½æ­£å¸¸ macroså»ºè¡¨é›†ç¾¤åæœŸè§„æ¨¡è¾ƒå¤§ï¼Œåˆ›å»ºåˆ†å¸ƒå¼è¡¨æ—¶å¾ˆå¤æ‚ï¼Œclickhouseæä¾›äº†åœ¨é…ç½®æ–‡ä»¶å®šä¹‰macrosï¼Œåˆ›å»ºè¡¨ä½¿ç”¨&#123;&#125;æ›¿ä»£å…·ä½“å‚æ•°çš„æ–¹å¼ï¼Œè®©è¡¨åˆ›å»ºæ›´é€æ˜æ–¹ä¾¿ã€‚ å¯ä»¥åœ¨config.xmlå’Œmetrika.xmlä¸­æœç´¢ä¸€ä¸‹macrosæ‰¾åˆ°ç›¸åº”çš„é…ç½® ä½¿ç”¨ä»¥ä¸‹è¯­å¥è¿æ¥ä¸€ä¸ªèŠ‚ç‚¹å³å¯å†é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºå¥½å¯¹åº”çš„è¡¨ 12345678910111213# ReplicatedMergeTreeè¡¨ç¤ºä¾‹ï¼šCREATE TABLE testdb.sbtest_local on cluster ch_cluster_all(EventDate DateTime,CounterID UInt32,UserID UInt32) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/&#123;layer&#125;-&#123;shard&#125;/sbtest_local&#x27;, &#x27;&#123;replica&#125;&#x27;)PARTITION BY toYYYYMM(EventDate)ORDER BY (CounterID, EventDate, intHash32(UserID)); # Distributedè¡¨ç¤ºä¾‹ï¼šCREATE TABLE testdb.sbtest ON CLUSTER ch_cluster_all AS testdb.sbtest_local engine = Distributed(ch_cluster_all, testdb, sbtest_local, rand()); ClickHouseç”¨æˆ·ç®¡ç†æ®æˆ‘äº†è§£ClickHouseæ²¡æœ‰åˆ›å»ºç”¨æˆ·çš„è¯­å¥(ç°åœ¨å·²ç»æœ‰äº†), åˆ›å»ºç”¨æˆ·çš„æ–¹å¼æ˜¯å¢åŠ é…ç½®å‚æ•°, ClickHouseä¼šè‡ªåŠ¨æ£€æµ‹é…ç½®æ–‡ä»¶å˜åŒ–, æ‰€ä»¥æ— éœ€é‡å¯æœåŠ¡ åœ¨ä¹‹å‰çš„é…ç½®ä¸­æˆ‘ä»¬åˆ¶å®šäº†å¦‚ä¸‹é…ç½® 1&lt;users_config&gt;/data/clickhouse/node1/users.xml&lt;/users_config&gt; è¿™è¡¨ç¤ºç”¨æˆ·é…ç½®åœ¨è¿™ä¸ªæ–‡ä»¶ä¸‹. å…¶å®æ ¹æ®å®˜æ–¹æ–‡æ¡£ä»‹ç», æˆ‘ä»¬å¯ä»¥åœ¨/data/clickhouse/node1ç›®å½•ä¸‹åˆ›å»ºusers.dç›®å½•, ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºå•ç‹¬çš„é…ç½®æ–‡ä»¶, è¿™æ ·å°±ä¸å¿…åœ¨ä¸€ä¸ªusers.xmlä¸­ç»´æŠ¤æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯äº†, ClickHouseä¼šè‡ªåŠ¨åˆå¹¶/data/clickhouse/node1/users.xmlå’Œ/data/clickhouse/node1/users.d/*.xml, ç”Ÿäº§ä¸€ä¸ªâ€è¿è¡Œæ—¶â€é…ç½®/data/clickhouse/node1/preprocessed_configs/users.xml ä¾‹å¦‚æˆ‘åœ¨users.dåˆ›å»ºäº†ä¸¤ä¸ªç”¨æˆ· 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859[root@centos-1 node1]# cd users.d/[root@centos-1 users.d]# lltotal 12-rwxr-xr-x 1 clickhouse clickhouse 1025 Apr 29 17:46 fanboshi.xml-rwxr-xr-x 1 clickhouse clickhouse 1035 Apr 30 16:35 monitor_ro.xml[root@centos-1 users.d]# cat fanboshi.xml &lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;fanboshi&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;readonly&gt;0&lt;/readonly&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;/fanboshi&gt; &lt;/profiles&gt; &lt;users&gt; &lt;fanboshi&gt; &lt;password_sha256_hex&gt;fanboshi_user_password_sha256_hex&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;fanboshi&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/fanboshi&gt; &lt;/users&gt;&lt;/yandex&gt;[root@centos-1 users.d]# cat monitor_ro.xml &lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;monitor_ro&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;readonly&gt;0&lt;/readonly&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;/monitor_ro&gt; &lt;/profiles&gt; &lt;users&gt; &lt;monitor_ro&gt; &lt;password_sha256_hex&gt;monitor_ro_user_password_sha256_hex&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;monitor_ro&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/monitor_ro&gt; &lt;/users&gt;&lt;/yandex&gt; ç›®å‰æˆ‘ä¸ªäººå»ºè®®å°†ä¸€ä¸ªç”¨æˆ·çš„profile, quotaç­‰ä¿¡æ¯éƒ½é…ç½®åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­, é¿å…æ··ä¹± å¦‚æ­¤é…ç½®ä¹‹å, /data/clickhouse/node1/preprocessed_configs/users.xmlå°±ä¼šè‡ªåŠ¨åˆå¹¶æˆ‘ä»¬çš„æ‰€æœ‰ç”¨æˆ·é…ç½®, ç”Ÿæˆå¦‚ä¸‹é…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687&lt;!-- This file was generated automatically. Do not edit it: it is likely to be discarded and generated again before it&#x27;s read next time. Files used to generate this file: /data/clickhouse/node1/users.xml /data/clickhouse/node1/users.d/fanboshi.xml --&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;default&gt; &lt;max_memory_usage&gt;4294967296&lt;/max_memory_usage&gt; &lt;!-- æ¯ä¸ª session çš„å†…å­˜é™åˆ¶ --&gt; &lt;max_bytes_before_external_group_by&gt;2147483648&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;2147483648&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;1&lt;/max_threads&gt; &lt;/default&gt; &lt;readonly&gt; &lt;max_threads&gt;1&lt;/max_threads&gt; &lt;max_memory_usage&gt;4294967296&lt;/max_memory_usage&gt; &lt;max_bytes_before_external_group_by&gt;2147483648&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;2147483648&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;readonly&gt;1&lt;/readonly&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;/readonly&gt; &lt;fanboshi&gt; &lt;max_threads&gt;8&lt;/max_threads&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;readonly&gt;0&lt;/readonly&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;/fanboshi&gt; &lt;/profiles&gt; &lt;quotas&gt; &lt;default&gt; &lt;interval&gt; &lt;duration&gt;3600&lt;/duration&gt; &lt;queries&gt;0&lt;/queries&gt; &lt;errors&gt;0&lt;/errors&gt; &lt;result_rows&gt;0&lt;/result_rows&gt; &lt;read_rows&gt;0&lt;/read_rows&gt; &lt;execution_time&gt;0&lt;/execution_time&gt; &lt;/interval&gt; &lt;/default&gt; &lt;/quotas&gt; &lt;users&gt; &lt;default&gt; &lt;password_sha256_hex&gt;default_user_password_sha256_hex&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/default&gt; &lt;ch_ro&gt; &lt;password_sha256_hex&gt;ch_ro_user_password_sha256_hex&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;readonly&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/ch_ro&gt; &lt;fanboshi&gt; &lt;password_sha256_hex&gt;fanboshi_user_password_sha256_hex&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;fanboshi&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/fanboshi&gt; &lt;/users&gt; &lt;/yandex&gt; æ³¨æ„çœ‹è¿™é‡Œ 12345&lt;!-- This file was generated automatically. Do not edit it: it is likely to be discarded and generated again before it&#x27;s read next time. Files used to generate this file: /data/clickhouse/node1/users.xml /data/clickhouse/node1/users.d/fanboshi.xml --&gt; åˆ›å»ºç”¨æˆ·è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„, è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹å¢åŠ é…ç½®æ–‡ä»¶, å»ºè®®è¿˜æ˜¯ä½¿ç”¨ansibleä¹‹ç±»çš„å·¥å…·é…åˆ, è¿™é‡Œæˆ‘ç»™å‡ºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„ansible roleçš„å…³é”®éƒ¨åˆ†å§, å…³é”®å°±æ˜¯templateå’Œvarå§ template 123456789101112131415161718192021222324252627282930313233#jinja2: lstrip_blocks:True&lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;&#123;&#123; user.name &#125;&#125;&gt; &#123;% for key, value in profile.settings.items() %&#125; &lt;&#123;&#123; key &#125;&#125;&gt;&#123;&#123; value &#125;&#125;&lt;/&#123;&#123; key &#125;&#125;&gt; &#123;% endfor %&#125; &lt;/&#123;&#123; user.name &#125;&#125;&gt; &lt;/profiles&gt; &lt;users&gt; &lt;&#123;&#123; user.name &#125;&#125;&gt; &lt;password_sha256_hex&gt;&#123;&#123; password_sha256_hex &#125;&#125;&lt;/password_sha256_hex&gt; &lt;networks&gt; &#123;% for key, values in user.networks.items() %&#125; &#123;% for value in values %&#125; &lt;&#123;&#123; key &#125;&#125;&gt;&#123;&#123; value &#125;&#125;&lt;/&#123;&#123; key &#125;&#125;&gt; &#123;% endfor %&#125; &#123;% endfor %&#125; &lt;/networks&gt; &lt;profile&gt;&#123;&#123; user.name|default(&#x27;default&#x27;)&#125;&#125;&lt;/profile&gt; &lt;quota&gt;&#123;&#123;quota|default(&#x27;default&#x27;)&#125;&#125;&lt;/quota&gt; &#123;% if user.allow_databases|default(&#x27;&#x27;)|length &gt; 0 %&#125; &lt;allow_databases&gt; &#123;% for database in user.allow_databases %&#125; &lt;database&gt;&#123;&#123; database &#125;&#125;&lt;/database&gt; &#123;% endfor %&#125; &lt;/allow_databases&gt; &#123;% endif %&#125; &lt;/&#123;&#123; user.name &#125;&#125;&gt; &lt;/users&gt;&lt;/yandex&gt; var 12345678910111213141516171819202122232425---# vars file for clickhouse_add_usersprofile: settings: max_memory_usage: 54975581388# max_memory_usage_for_all_queries: 61847529062 max_bytes_before_external_group_by: 21474836480 max_bytes_before_external_sort: 21474836480 use_uncompressed_cache: 0 load_balancing: random distributed_aggregation_memory_efficient: 1 max_threads: 8 log_queries: 1 readonly: 0user: name: test password: &quot;&quot;# ä¸è¦å®šä¹‰password_sha256_hex, password_sha256_hexåº”è¯¥æ ¹æ®passwordç”Ÿæˆ networks: ip: - ::/0 quota: default allow_databases: [] clickhouse-client promptè°ƒæ•´æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿°: clickhouse-client uses the first existing file of the following: Defined in the --config-file parameter. ./clickhouse-client.xml ~/.clickhouse-client/config.xml /etc/clickhouse-client/config.xml æŸ¥çœ‹/etc/clickhouse-client/config.xml(yumå®‰è£…ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªé…ç½®), å‘ç°æœ‰ç¤ºä¾‹é…ç½® 12345&lt;prompt_by_server_display_name&gt; &lt;default&gt;&#123;display_name&#125; :) &lt;/default&gt; &lt;test&gt;&#123;display_name&#125; \\x01\\e[1;32m\\x02:)\\x01\\e[0m\\x02 &lt;/test&gt; &lt;!-- if it matched to the substring &quot;test&quot; in the server display name - --&gt; &lt;production&gt;&#123;display_name&#125; \\x01\\e[1;31m\\x02:)\\x01\\e[0m\\x02 &lt;/production&gt; &lt;!-- if it matched to the substring &quot;production&quot; in the server display name --&gt;&lt;/prompt_by_server_display_name&gt; äºæ˜¯è°ƒæ•´ä¸€ä¸‹, æ¯”å¦‚defaultæ”¹æˆ 1&lt;default&gt;&#123;display_name&#125; &#123;user&#125;@&#123;host&#125;:&#123;port&#125; [&#123;database&#125;]\\n\\x01\\e[1;31m\\x02:)\\x01\\e[0m\\x02 &lt;/default&gt; 12345678#clickhouse-client -ufanboshi --ask-password ClickHouse client version 20.3.5.21 (official build).Password for user (fanboshi): Connecting to localhost:9000 as user fanboshi.Connected to ClickHouse server version 20.3.5 revision 54433.bj2-clickhouse-all-prod-01 fanboshi@localhost:9000 [default]:) --å…¶å®ç¬‘è„¸æ˜¯çº¢è‰²çš„.. å…¶å®è¿™ä¸ªé…ç½®è¿˜ä¸æ˜¯å¾ˆç†è§£, å› ä¸ºä½ å¯ä»¥æ³¨æ„åˆ°æˆ‘è¿™é‡Œä½¿ç”¨çš„ç”¨æˆ·æ˜¯fanboshi, è€Œédefaultä½†å´ä¹Ÿåº”ç”¨åˆ°äº†è¿™ä¸ªprompt, æˆ‘æ€€ç–‘æ˜¯å› ä¸ºprofileæ˜¯default 123456789101112131415161718192021222324252627#cat /data/clickhouse/ch_9000/users.d/fanboshi.xml &lt;?xml version=&quot;1.0&quot;?&gt;&lt;yandex&gt; &lt;profiles&gt; &lt;fanboshi&gt; &lt;max_memory_usage&gt;54975581388&lt;/max_memory_usage&gt; &lt;max_memory_usage_for_all_queries&gt;61847529062&lt;/max_memory_usage_for_all_queries&gt; &lt;max_bytes_before_external_group_by&gt;21474836480&lt;/max_bytes_before_external_group_by&gt; &lt;max_bytes_before_external_sort&gt;21474836480&lt;/max_bytes_before_external_sort&gt; &lt;use_uncompressed_cache&gt;0&lt;/use_uncompressed_cache&gt; &lt;load_balancing&gt;random&lt;/load_balancing&gt; &lt;distributed_aggregation_memory_efficient&gt;1&lt;/distributed_aggregation_memory_efficient&gt; &lt;max_threads&gt;10&lt;/max_threads&gt; &lt;log_queries&gt;1&lt;/log_queries&gt; &lt;/fanboshi&gt; &lt;/profiles&gt; &lt;users&gt; &lt;fanboshi&gt; &lt;password_sha256_hex&gt;supersecurt&lt;/password_sha256_hex&gt; &lt;networks&gt; &lt;ip&gt;::/0&lt;/ip&gt; &lt;/networks&gt; &lt;profile&gt;default&lt;/profile&gt; &lt;quota&gt;default&lt;/quota&gt; &lt;/fanboshi&gt; &lt;/users&gt;&lt;/yandex&gt; å®ç°ç±»ä¼¼mysqlå…è¾“ç”¨æˆ·å¯†ç ç™»å½•æˆ‘ä»¬éƒ½çŸ¥é“mysql cliå¯ä»¥é€šè¿‡åœ¨my.cnfæ·»åŠ å¦‚ä¸‹å‚æ•°å®ç°å¿«é€Ÿç™»å½• 123[client]user=xxpassword=xxx clickhouse-clientä¹Ÿå¯ä»¥ æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿°, åœ¨client configæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å‚æ•°å³å¯ 1234567# vim ~/.clickhouse-client/config.xml &lt;config&gt; &lt;user&gt;username&lt;/user&gt; &lt;password&gt;password&lt;/password&gt; &lt;secure&gt;False&lt;/secure&gt;&lt;/config&gt; ç–‘é—®çœ‹äº†å¾ˆå¤šå¤§ä½¬çš„æ–‡ç« , å¤§å®¶éƒ½æ˜¯å»ºè®®ç»™åº”ç”¨æä¾›ä¸€ä¸ªè´Ÿè½½å‡è¡¡å†™æœ¬åœ°è¡¨è¯»åˆ†å¸ƒå¼è¡¨, è€Œä¸ç›´æ¥é€šè¿‡åˆ†å¸ƒå¼è¡¨å†™æ•°æ® æˆ‘ä»¬ææŠ€æœ¯çš„è‚¯å®šä¸æ„¿æ„äººäº‘äº¦äº‘, åˆ«äººè¯´ä»€ä¹ˆå°±ä¿¡ä»€ä¹ˆ, å½“ç„¶å‰ä»»ç»éªŒè‚¯å®šæ˜¯æœ‰ä»·å€¼çš„ ä¸è¿‡æˆ‘æƒ³æ¥æƒ³å»è¿˜æ˜¯æœ‰äº›æ²¡æƒ³æ˜ç™½ç›´æ¥å†™åˆ†å¸ƒå¼è¡¨æœ‰ä»€ä¹ˆè‡´å‘½ç¼ºé™·, äºæ˜¯åœ¨ClickHouseä¸­æ–‡ç¤¾åŒºæäº†ä¸€ä¸ªé—®é¢˜), å†…å®¹å¦‚ä¸‹: ä¸è¿‡è‡³ä»Šæ— äººç­”å¤ çœ‹äº†sinaé«˜é¹å¤§ä½¬çš„åˆ†äº« çœ‹äº† https://github.com/ClickHouse/ClickHouse/issues/1854 è¿˜çœ‹äº†ä¸€äº›æ–‡ç« éƒ½æ˜¯å»ºè®®å†™æœ¬åœ°è¡¨è€Œä¸æ˜¯åˆ†å¸ƒå¼è¡¨ å¦‚æœæˆ‘è®¾ç½®internal_replication=true, ä½¿ç”¨ReplicatedMergeTreeå¼•æ“, é™¤äº†å†™æœ¬åœ°è¡¨æ›´çµæ´»å¯æ§å¤–, å†™åˆ†å¸ƒå¼è¡¨åˆ°åº•æœ‰ä»€ä¹ˆè‡´å‘½ç¼ºé™·å—? å› ä¸ºè¦ç»™åŒäº‹è§£é‡Š, åªè¯´ä¸€ä¸ªå¤§å®¶è¯´æœ€ä½³å®è·µæ˜¯è¿™æ ·æ˜¯ä¸è¡Œçš„â€¦ æˆ‘è‡ªå·±ä¹Ÿæ²¡ç†è§£åˆ°åº•å†™åˆ†å¸ƒå¼è¡¨æœ‰å•¥å¤§ç¼ºé™· å¦‚æœè¯´é€ æˆæ•°æ®åˆ†å¸ƒä¸å‡åŒ€, sharding keyæˆ‘è®¾ä¸ºrand()è¿˜ä¼šæœ‰å¾ˆå¤§ä¸å‡åŒ€å—? å¦‚æœè¯´æ‰©å®¹, æˆ‘ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´weightæ§åˆ¶æ•°æ®å°½é‡å†™å…¥æ–°sharedå•Š? éš¾é“æ˜¯å› ä¸ºæ–‡æ¡£ä¸­è¿™æ®µ: 123Data is written asynchronously. When inserted in the table, the data block is just written to the local file system. The data is sent to the remote servers in the background as soon as possible. The period for sending data is managed by the distributed_directory_monitor_sleep_time_ms and distributed_directory_monitor_max_sleep_time_ms settings. The Distributed engine sends each file with inserted data separately, but you can enable batch sending of files with the distributed_directory_monitor_batch_inserts setting. This setting improves cluster performance by better utilizing local server and network resources. You should check whether data is sent successfully by checking the list of files (data waiting to be sent) in the table directory: /var/lib/clickhouse/data/database/table/.If the server ceased to exist or had a rough restart (for example, after a device failure) after an INSERT to a Distributed table, the inserted data might be lost. If a damaged data part is detected in the table directory, it is transferred to the â€˜brokenâ€™ subdirectory and no longer used. ä¸Šé¢æ–‡æ¡£å†…å®¹æˆ‘ç†è§£æ„æ€æ˜¯è¯´å‡å¦‚æˆ‘æœ‰S1 S2 S3 ä¸‰ä¸ªèŠ‚ç‚¹,æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰localè¡¨å’Œåˆ†å¸ƒå¼è¡¨. æˆ‘å‘S1çš„åˆ†å¸ƒå¼è¡¨å†™æ•°æ®1, 2, 3 1å†™å…¥S1, 2,3å…ˆå†™åˆ°S1æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ, ç„¶åå¼‚æ­¥å‘é€åˆ°S2 S3 , æ¯”å¦‚2å‘ç»™S2, 3å‘ç»™S3, å¦‚æœæ­¤æ—¶S3å®•æœºäº†, åˆ™3å‘åˆ°S3å¤±è´¥, ä½†æ˜¯1,2è¿˜æ˜¯æˆåŠŸå†™åˆ°S1,S2äº†? æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹ä¸èƒ½ä¿è¯åŸå­æ€§? å‡ºç°é—®é¢˜è¿˜è¦äººä¸ºä¿®æ•°æ®? https://github.com/ClickHouse/ClickHouse/issues/1343 è¿™ä¸ªissueè¯´S3 come backåS1ä¼šå°è¯•é‡æ–°å‘é€æ•°æ®ç»™S3. Data blocks are written in /var/lib/clickhouse/data/database/table/ folder. Special thread checks directory periodically and tries to send data. If it canâ€™t, it will try next time. é‚£ä¹ˆåªå‰©æ–‡æ¡£æœ€åä¸€å¥æ„æ€æ˜¯å¦‚æœS1è¿‡ç¨‹ä¸­å®•æœº, ä¼šä¸¢æ•°æ®? å†å°±æ˜¯weightæ˜¯åˆ†ç‰‡çº§åˆ«çš„, ä¸æ˜¯è¡¨çº§åˆ«çš„, çµæ´»æ€§å·®? å·²ç»æœ‰ç­”æ¡ˆäº†, è¯¦è§ClickHouseåˆ°åº•æ”¹å†™æœ¬åœ°è¡¨è¿˜æ˜¯åˆ†å¸ƒå¼è¡¨","categories":[],"tags":[{"name":"ClickHouse","slug":"ClickHouse","permalink":"http://fuxkdb.com/tags/ClickHouse/"}]},{"title":"Zookeeper3.6.0é›†ç¾¤éƒ¨ç½²æ–‡æ¡£","slug":"2020-04-15-Zookeeper3.6.0é›†ç¾¤éƒ¨ç½²æ–‡æ¡£","date":"2020-04-15T15:32:00.000Z","updated":"2020-04-15T15:33:28.928Z","comments":true,"path":"2020/04/15/2020-04-15-Zookeeper3.6.0é›†ç¾¤éƒ¨ç½²æ–‡æ¡£/","link":"","permalink":"http://fuxkdb.com/2020/04/15/2020-04-15-Zookeeper3.6.0%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3/","excerpt":"Zookeeper3.6.0é›†ç¾¤éƒ¨ç½²æ–‡æ¡£ä¸€ç‚¹ä¸€ç‚¹å®Œå–„â€¦","text":"Zookeeper3.6.0é›†ç¾¤éƒ¨ç½²æ–‡æ¡£ä¸€ç‚¹ä¸€ç‚¹å®Œå–„â€¦ ä¸‹è½½å®‰è£…åŒ…https://zookeeper.apache.org/releases.html 12345cd /tmp &amp;&amp; \\wget https://downloads.apache.org/zookeeper/zookeeper-3.6.0/apache-zookeeper-3.6.0-bin.tar.gztar -zxvf apache-zookeeper-3.6.0-bin.tar.gz -C /usr/local/ln -s /usr/local/apache-zookeeper-3.6.0-bin /usr/local/zookeeper é…ç½®ç¯å¢ƒå˜é‡1234vi ~/.bashrcexport ZOOKEEPER_HOME=/usr/local/zookeeperexport PATH=$PATH:$ZOOKEEPER_HOME/bin ä¿®æ”¹é…ç½®æ–‡ä»¶zoo.cfg12345678910111213141516171819202122cat zoo.cfg# æŠ„çš„clickhouseå®˜ç½‘# https://clickhouse.tech/docs/en/operations/tips/#zookeepertickTime=2000initLimit=30000syncLimit=10maxClientCnxns=2000maxSessionTimeout=60000000autopurge.snapRetainCount=10autopurge.purgeInterval=1preAllocSize=131072snapCount=3000000leaderServes=yesstandaloneEnabled=falsereconfigEnabled=true4lw.commands.whitelist=*dataDir=/data/zookeeper/test/datadataLogDir=/data/zookeeper/test/logsdynamicConfigFile=/usr/local/apache-zookeeper-3.6.0-bin/conf/zoo_replicated1.cfg.dynamic4lw.commands.whitelist=* dynamicConfigFilevim /usr/local/apache-zookeeper-3.6.0-bin/conf/zoo_replicated1.cfg.dynamic ä¸‰ä¸ªèŠ‚ç‚¹ä¸€æ · 1234#cat zoo_replicated1.cfg.dynamicserver.1=172.16.24.2:2888:3888:participant;2181server.2=172.16.24.13:2888:3888:participant;2181server.3=172.16.24.109:2888:3888:participant;2181 æ³¨æ„ä¸èƒ½ç”¨0.0.0.0, å¦åˆ™æœ‰bug ç”¨äºå®¢æˆ·ç«¯è¿æ¥çš„ç«¯å£clientPort: 2181ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡çš„TCPç«¯å£peerPort: 2888ç”¨äºé¦–é¢†é€‰ä¸¾çš„TCPç«¯å£leaderPort: 3888 participantä»£è¡¨å‚ä¸è€… myid12345678#masterecho &quot;1&quot;&gt;/data/zookeeper/ch_9000/data/myid#slave1echo &quot;2&quot;&gt;/data/zookeeper/ch_9000/data/myid#slave2echo &quot;3&quot;&gt;/data/zookeeper/ch_9000/data/myid é…ç½®zkæ—¥å¿—çš„æ»šåŠ¨è¾“å…¥ çœ‹bin/zkEnv.sh é‡Œé¢ é»˜è®¤zkæ—¥å¿—è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶,ä¸”ä¸ä¼šè‡ªåŠ¨æ¸…ç†,æ‰€ä»¥,ä¸€æ®µæ—¶é—´åzkæ—¥å¿—ä¼šéå¸¸å¤§!è¿™é‡Œé…ç½®zkæ—¥å¿—æ»šåŠ¨è¾“å‡º,ä¸”æ¯ä¸ªæ–‡ä»¶10Mé™åˆ¶,æœ€å¤šä¿ç•™10ä¸ªæ–‡ä»¶. zookeeper-env.sh./confç›®å½•ä¸‹æ–°å»ºzookeeper-env.shæ–‡ä»¶,ä¿®æ”¹åˆ°sudo chmod 755 zookeeper-env.shæƒé™ 1234567#cat conf/zookeeper-env.sh#!/usr/bin/env bash#tip:custom configurationfileï¼Œdo not amend the zkEnv.sh file#chang the log dir and output of rolling fileZOO_LOG_DIR=&quot;/usr/local/zookeeper/logs&quot;ZOO_LOG4J_PROP=&quot;INFO,ROLLINGFILE&quot; log4j.properties ä¿®æ”¹æ—¥å¿—çš„è¾“å…¥å½¢å¼ 1234567891011zookeeper.root.logger=INFO, ROLLINGFILE#zookeeper.root.logger=INFO, CONSOLEzookeeper.console.threshold=INFOzookeeper.log.dir=/usr/local/zookeeper/logszookeeper.log.file=zookeeper.logzookeeper.log.threshold=INFOzookeeper.log.maxfilesize=256MB --è¦æ”¹å°±æ”¹è¿™ä¸ªzookeeper.log.maxbackupindex=20 --è¦æ”¹å°±æ”¹è¿™ä¸ª mkdir /usr/local/zookeeper/logs 123456789### é…ç½®è¿è¡Œzkçš„jvm&gt; çœ‹bin/zkEnv.sh é‡Œé¢`./conf`ç›®å½•ä¸‹æ–°å»º`java.env`æ–‡ä»¶,ä¿®æ”¹åˆ°`sudo chmod 755 java.env`æƒé™,ä¸»è¦ç”¨äº`GC log`,`RAM`ç­‰çš„é…ç½®. #!/usr/bin/env bash #config the jvm parameter in a reasonable #note that the shell is source in so that do not need to use export #set java classpath #CLASSPATH=&quot;&quot; #set jvm start parameter , also can set JVMFLAGS variable SERVER_JVMFLAGS=&quot;-Xms1024m -Xmx2048m $JVMFLAGS&quot; 12345## å¯åŠ¨zookeeperæœåŠ¡(æ‰€æœ‰èŠ‚ç‚¹) # zkServer.sh start ZooKeeper JMX enabled by default Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg Starting zookeeper ... STARTED 12345678910## é‡åˆ°é—®é¢˜### é—®é¢˜1ä½¿ç”¨statéªŒè¯zookeeperæœåŠ¡æ—¶æŠ¥é”™ #telnet 127.0.0.1 2181 Trying 127.0.0.1... Connected to 127.0.0.1. Escape character is &apos;^]&apos;. stat stat is not executed because it is not in the whitelist. Connection closed by foreign host. 12345678910è¿™é‡Œå‡ºé—®é¢˜äº†. 3.5.3ä»¥åæ–°å¢å‚æ•°`4lw.commands.whitelist`https://zookeeper.apache.org/doc/r3.6.0/zookeeperAdmin.html### é—®é¢˜2ä¹‹å‰æˆ‘æ˜¯è¿™æ ·é…ç½®çš„dynamicConfigFileçš„ä¸‰ä¸ªèŠ‚ç‚¹, è‡ªå·±éƒ½æ˜¯`0.0.0.0` #cat zoo_ch_9000.cfg.dynamic server.1=0.0.0.0:2888:3888:participant;0.0.0.0:2181 server.2=172.16.24.13:2888:3888:participant;0.0.0.0:2181 server.3=172.16.24.109:2888:3888:participant;0.0.0.0:2181 1 #cat zoo_ch_9000.cfg.dynamic server.1=172.16.24.2:2888:3888:participant;0.0.0.0:2181 server.2=0.0.0.0:2888:3888:participant;0.0.0.0:2181 server.3=172.16.24.109:2888:3888:participant;0.0.0.0:2181 1 #cat zoo_ch_9000.cfg.dynamic server.1=172.16.24.2:2888:3888:participant;0.0.0.0:2181 server.2=172.16.24.13:2888:3888:participant;0.0.0.0:2181 server.3=0.0.0.0:2888:3888:participant;0.0.0.0:2181 123è¿™æ ·è£…å®Œä»¥åèƒ½ç”¨, ä½†æ˜¯myid=1æŒ‚æ‰é‡å¯åä¸€ç›´æ— æ³•åŠ å…¥ 2020-04-15 16:03:24,420 [myid:1] - INFO [WorkerSender[myid=1]:QuorumCnxManager@462] - Have smaller server identifier, so dropping the connection: (3, 1) 2020-04-15 16:03:24,622 [myid:1] - INFO [QuorumPeer[myid=1](plain=0.0.0.0:2181)(secure=disabled):QuorumCnxManager@462] - Have smaller server identifier, so dropping the connection: (2, 1) 2020-04-15 16:03:24,623 [myid:1] - INFO [QuorumPeer[myid=1](plain=0.0.0.0:2181)(secure=disabled):QuorumCnxManager@462] - Have smaller server identifier, so dropping the connection: (3, 1) 2020-04-15 16:03:24,623 [myid:1] - INFO [QuorumPeer[myid=1](plain=0.0.0.0:2181)(secure=disabled):FastLeaderElection@966] - Notification time out: 400 2020-04-15 16:03:25,024 [myid:1] - INFO [QuorumPeer[myid=1](plain=0.0.0.0:2181)(secure=disabled):QuorumCnxManager@462] - Have smaller server identifier, so dropping the connection: (2, 1) 2020-04-15 16:03:25,025 [myid:1] - INFO [QuorumPeer[myid=1](plain=0.0.0.0:2181)(secure=disabled):QuorumCnxManager@462] - Have smaller server identifier, so dropping the connection: (3, 1) 2020-04-15 16:03:25,025 [myid:1] - INFO [QuorumPeer[myid=1](plain=0.0.0.0:2181)(secure=disabled):FastLeaderElection@966] - Notification time out: 800 è²Œä¼¼æ˜¯bug https://issues.apache.org/jira/browse/ZOOKEEPER-2938 ç”¨3.4.14çš„é…ç½®å¯åŠ¨3.6.0 ä»ç„¶æœ‰æ­¤é—®é¢˜, è¯´æ˜å¯èƒ½ä¸æ˜¯é…ç½®é—®é¢˜åå¤æµ‹è¿‡å‡ æ¬¡å°±æ˜¯0.0.0.0çš„é—®é¢˜, å®é™…ä¸Šæˆ‘åœ¨æ¥äº‘è´¦æˆ·ä¹‹å‰ä»æ²¡æœ‰ç”¨è¿‡0.0.0.0, ä¹‹å‰é©¬èœ‚çªçš„æœåŠ¡å™¨ä¹Ÿæ˜¯åŒç½‘å¡, æˆ‘çœ‹è¿‡è¿ç»´çš„kafkaå’Œå¤§æ•°æ®çš„kafkaéƒ½æ²¡æœ‰ä½¿ç”¨è¿‡0.0.0.0è¿™ç§æ–¹å¼, æ¥åˆ°è¿™è¾¹æ‰çœ‹åˆ°è¿™ç§ç”¨æ³•, æœ¬ç€â€å¯èƒ½æœ‰å‘ã€ä¸çº¿ä¸Šç»Ÿä¸€â€çš„åŸåˆ™ç»§æ‰¿äº†è¿™æ ·çš„é…ç½®, å®é™…å¯¹è¿™ç§é…ç½®æˆ‘è¿˜æ˜¯ä¸å¤ªç†è§£, è™½ç„¶ç™¾åº¦äº†ä¸€ä¸‹è¯´æ˜¯ECSæˆ–Dockerä¸è¿™æ ·é…æœ‰é—®é¢˜","categories":[],"tags":[{"name":"ZooKeeper","slug":"ZooKeeper","permalink":"http://fuxkdb.com/tags/ZooKeeper/"}]},{"title":"Kafkaç‰ˆæœ¬å‡çº§","slug":"2020-04-15-Kafkaç‰ˆæœ¬å‡çº§","date":"2020-04-15T15:29:00.000Z","updated":"2020-04-16T02:46:15.915Z","comments":true,"path":"2020/04/15/2020-04-15-Kafkaç‰ˆæœ¬å‡çº§/","link":"","permalink":"http://fuxkdb.com/2020/04/15/2020-04-15-Kafka%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7/","excerpt":"Kafkaç‰ˆæœ¬å‡çº§æœ¬æ–‡æ¡£ä»‹ç»kafka_2.11_2.1.1å‡çº§åˆ°2.12-2.4.1çš„å…·ä½“æ“ä½œæ–¹æ³•. å…¶ä»–ç‰ˆæœ¬å¤§åŒå°å¼‚, è¯¦è§1.5 Upgrading From Previous Versions","text":"Kafkaç‰ˆæœ¬å‡çº§æœ¬æ–‡æ¡£ä»‹ç»kafka_2.11_2.1.1å‡çº§åˆ°2.12-2.4.1çš„å…·ä½“æ“ä½œæ–¹æ³•. å…¶ä»–ç‰ˆæœ¬å¤§åŒå°å¼‚, è¯¦è§1.5 Upgrading From Previous Versions å‡çº§å‰æ£€æŸ¥é¡¹1.ç¡®è®¤æ˜¯å¦æœ‰å‰¯æœ¬å› å­æ˜¯1çš„Topic1bin/kafka-topics.sh --zookeeper localhost:2182 --describe|grep &quot;ReplicationFactor:[[:space:]]*1&quot; å•å‰¯æœ¬Topicåœ¨rolling restartè¿‡ç¨‹ä¸­å¿…å®šä¼šå—åˆ°å½±å“ 2.ç¡®è®¤æ˜¯å¦æœ‰åªæœ‰ä¸€ä¸ªIsrçš„Topic12345678910111213bin/kafka-topics.sh --zookeeper localhost:2182 --describe|grep Replicas|while read line;do echo &quot;$(awk -F&#x27;Topic:&#x27; &#x27;&#123;print $NF&#125;&#x27; &lt;&lt;&lt; &quot;$&#123;line&#125;&quot;|awk -F &#x27;Partition:&#x27; &#x27;&#123;print $1&#125;&#x27;|sed &#x27;s/[ \\t]*//g&#x27; ) Isr: $(awk -F&#x27;Isr:&#x27; &#x27;&#123;print $NF&#125;&#x27; &lt;&lt;&lt; &quot;$&#123;line&#125;&quot;|tr &quot;,&quot; &quot;\\n&quot;|sort -n|tr &quot;\\n&quot; &quot;,&quot;|sed &#x27;s/,$/\\n/g;&#x27;|sed &#x27;s/[ \\t]*//g&#x27; )&quot;;done|awk &#x27;&#123;printf &quot;%-64s%-4s%-23s\\n&quot;,$1,$2,$3&#125;&#x27;test.t_batch Isr:8,13,174 test.t_template Isr:8,13,174 test.t_user_apply Isr:8,13,174 test.t_user_order Isr:8,13,174 test.t_user Isr:8,13,174 test.t_user_job_record Isr:8,13,174 ä½¿ç”¨å¦‚ä¸‹è¯­å¥è¾“å‡ºåªæœ‰ä¸€ä¸ªIsrçš„Topic. (if (length(a) == 1)bin/kafka-topics.sh --zookeeper localhost:2182 --describe|grep Replicas|awk &#x27;&#123;split($NF,a,&quot;,&quot;);slen=asort(a,tA);&#125;&#123;if (length(a) == 1)&#123;&#123;printf $2&quot; : &quot;;for (i = 1; i &lt;= length(a); i++)&#123;if (i==length(a)&amp;&amp;i==1)&#123;printf tA[i];&#125;else&#123;printf tA[i]&quot;,&quot;;&#125;&#125;&#125;&#123;printf &quot;\\n&quot;;&#125;&#125;&#125;&#x27;|awk &#x27;&#123;printf &quot;%-64s%-23s\\n&quot;,$1,$3&#125;&#x27; åªæœ‰ä¸€ä¸ªIsrçš„åœ¨rolling restartè¿‡ç¨‹ä¸­å¿…å®šä¼šå—åˆ°å½±å“ å¢åŠ Topicå‰¯æœ¬æ•°å½“ä¸Šä¸€æ­¥æ£€æŸ¥æ­¥éª¤å­˜åœ¨é—®é¢˜Topicæ—¶, éœ€è¦é’ˆå¯¹è¿™äº›Topicå¢åŠ å‰¯æœ¬, æˆ–ç­‰å¾…Isr&gt;1. æœ¬æ¬¡çº¿ä¸Šå‡çº§æˆ‘ä»¬å·²çŸ¥æ‰€æœ‰Topicéƒ½åªæœ‰ä¸€ä¸ªå‰¯æœ¬, æ‰€ä»¥å…¨éƒ¨éœ€è¦å¢åŠ å‰¯æœ¬æ•° å¢åŠ å‰¯æœ¬ä¼šè§¦å‘æ•°æ®å¤åˆ¶, å¯èƒ½å¯¼è‡´ç½‘å¡æ‰“æ»¡, IOå¢é«˜, è¿˜æ˜¯ä¼šå½±å“ä¸šåŠ¡ å¢åŠ å‰¯æœ¬æ•°Kafka æ”¯æŒä¸ºå·²æœ‰ topic çš„åˆ†åŒºå¢åŠ å‰¯æœ¬å› å­(replication factor)ï¼Œå…·ä½“çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨kafka-reassign-partitions.shå¹¶ä¸”ä¸º topicåˆ†åŒºå¢åŠ é¢å¤–çš„å‰¯æœ¬ ç†è®ºä¸Šä¸å½±å“ç”Ÿäº§å’Œæ¶ˆè´¹, å®æµ‹ä¹Ÿç¡®å®æ²¡å½±å“ ç”Ÿæˆjsonæ–‡ä»¶æˆ‘ä»¬å…ˆä¸º__consumer_offsetså¢åŠ å‰¯æœ¬, å…ˆdescribeä¸€ä¸‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152#bin/kafka-topics.sh --zookeeper localhost:2182 --topic __consumer_offsets --describeTopic: __consumer_offsets PartitionCount: 50 ReplicationFactor: 1 Configs: compression.type=producer,cleanup.policy=compact,segment.bytes=104857600 Topic: __consumer_offsets Partition: 0 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 1 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 2 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 3 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 4 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 5 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 6 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 7 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 8 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 9 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 10 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 11 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 12 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 13 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 14 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 15 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 16 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 17 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 18 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 19 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 20 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 21 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 22 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 23 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 24 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 25 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 26 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 27 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 28 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 29 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 30 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 31 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 32 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 33 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 34 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 35 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 36 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 37 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 38 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 39 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 40 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 41 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 42 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 43 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 44 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 45 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 46 Leader: 174 Replicas: 174 Isr: 174 Topic: __consumer_offsets Partition: 47 Leader: 8 Replicas: 8 Isr: 8 Topic: __consumer_offsets Partition: 48 Leader: 13 Replicas: 13 Isr: 13 Topic: __consumer_offsets Partition: 49 Leader: 174 Replicas: 174 Isr: 174 ç›®å‰å‰¯æœ¬å› å­æ˜¯1, ç°åœ¨æˆ‘ä»¬è¦æŠŠå®ƒé‡è®¾æˆ3, åˆ›å»ºjsonæ–‡ä»¶/tmp/incr_replica.json 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:13,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:14,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:15,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:16,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:17,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:18,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:19,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:20,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:21,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:22,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:23,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:24,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:25,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:26,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:27,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:28,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:29,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:30,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:31,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:32,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:33,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:34,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:35,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:36,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:37,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:38,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:39,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:40,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:41,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:42,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:43,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:44,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:45,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:46,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:47,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:48,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:49,&quot;replicas&quot;:[13,174,8]&#125;]&#125; æ‰§è¡Œé‡åˆ†é…å·¥ä½œ1234567[root@bj1-mysql-dba-prod-01 kafka_2.11-2.1.1]# bin/kafka-reassign-partitions.sh --zookeeper localhost:2182 --reassignment-json-file /tmp/incr_replica.json --executeCurrent partition replica assignment&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:22,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:30,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:21,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:27,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:46,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:25,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:35,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:41,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:33,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:23,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:49,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:47,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:16,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:28,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:31,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:36,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:42,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:18,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:37,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:15,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:24,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:38,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:17,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:48,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:19,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:13,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:43,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:14,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:20,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:44,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:39,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:45,&quot;replicas&quot;:[13],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:26,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:29,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:34,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:32,&quot;replicas&quot;:[8],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:40,&quot;replicas&quot;:[174],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;]&#125;Save this to use as the --reassignment-json-file option during rollbackSuccessfully started reassignment of partitions. éªŒè¯é‡åˆ†é…æ˜¯å¦æˆåŠŸ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152bin/kafka-reassign-partitions.sh --zookeeper localhost:2182 --reassignment-json-file /tmp/incr_replica.json --verifyStatus of partition reassignment: Reassignment of partition __consumer_offsets-22 completed successfullyReassignment of partition __consumer_offsets-30 completed successfullyReassignment of partition __consumer_offsets-8 completed successfullyReassignment of partition __consumer_offsets-21 completed successfullyReassignment of partition __consumer_offsets-4 completed successfullyReassignment of partition __consumer_offsets-27 completed successfullyReassignment of partition __consumer_offsets-7 completed successfullyReassignment of partition __consumer_offsets-9 completed successfullyReassignment of partition __consumer_offsets-46 completed successfullyReassignment of partition __consumer_offsets-25 completed successfullyReassignment of partition __consumer_offsets-35 completed successfullyReassignment of partition __consumer_offsets-41 completed successfullyReassignment of partition __consumer_offsets-33 completed successfullyReassignment of partition __consumer_offsets-23 completed successfullyReassignment of partition __consumer_offsets-49 completed successfullyReassignment of partition __consumer_offsets-47 completed successfullyReassignment of partition __consumer_offsets-16 completed successfullyReassignment of partition __consumer_offsets-28 completed successfullyReassignment of partition __consumer_offsets-31 completed successfullyReassignment of partition __consumer_offsets-36 completed successfullyReassignment of partition __consumer_offsets-42 completed successfullyReassignment of partition __consumer_offsets-3 completed successfullyReassignment of partition __consumer_offsets-18 completed successfullyReassignment of partition __consumer_offsets-37 completed successfullyReassignment of partition __consumer_offsets-15 completed successfullyReassignment of partition __consumer_offsets-24 completed successfullyReassignment of partition __consumer_offsets-38 completed successfullyReassignment of partition __consumer_offsets-17 completed successfullyReassignment of partition __consumer_offsets-48 completed successfullyReassignment of partition __consumer_offsets-19 completed successfullyReassignment of partition __consumer_offsets-11 completed successfullyReassignment of partition __consumer_offsets-13 completed successfullyReassignment of partition __consumer_offsets-2 completed successfullyReassignment of partition __consumer_offsets-43 completed successfullyReassignment of partition __consumer_offsets-6 completed successfullyReassignment of partition __consumer_offsets-14 completed successfullyReassignment of partition __consumer_offsets-20 completed successfullyReassignment of partition __consumer_offsets-0 completed successfullyReassignment of partition __consumer_offsets-44 completed successfullyReassignment of partition __consumer_offsets-39 completed successfullyReassignment of partition __consumer_offsets-12 completed successfullyReassignment of partition __consumer_offsets-45 completed successfullyReassignment of partition __consumer_offsets-1 completed successfullyReassignment of partition __consumer_offsets-5 completed successfullyReassignment of partition __consumer_offsets-26 completed successfullyReassignment of partition __consumer_offsets-29 completed successfullyReassignment of partition __consumer_offsets-34 completed successfullyReassignment of partition __consumer_offsets-10 completed successfullyReassignment of partition __consumer_offsets-32 completed successfullyReassignment of partition __consumer_offsets-40 completed successfully å†describeç¡®è®¤ä¸€ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253[root@bj1-mysql-dba-prod-01 kafka_2.11-2.1.1]# bin/kafka-topics.sh --zookeeper localhost:2182 --topic __consumer_offsets --describeTopic:__consumer_offsets PartitionCount:50 ReplicationFactor:3 Configs:segment.bytes=104857600,cleanup.policy=compact,compression.type=producer Topic: __consumer_offsets Partition: 0 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 1 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 2 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 3 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 4 Leader: 174 Replicas: 13,174,8 Isr: 174,13,8 Topic: __consumer_offsets Partition: 5 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 6 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 7 Leader: 174 Replicas: 13,174,8 Isr: 174,13,8 Topic: __consumer_offsets Partition: 8 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 9 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 10 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 11 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 12 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 13 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 14 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 15 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 16 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 17 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 18 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 19 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 20 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 21 Leader: 13 Replicas: 13,174,8 Isr: 13,174,8 Topic: __consumer_offsets Partition: 22 Leader: 174 Replicas: 13,174,8 Isr: 174,13,8 Topic: __consumer_offsets Partition: 23 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 24 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 25 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 26 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 27 Leader: 13 Replicas: 13,174,8 Isr: 13,174,8 Topic: __consumer_offsets Partition: 28 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 29 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 30 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 31 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 32 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 33 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 34 Leader: 174 Replicas: 13,174,8 Isr: 174,13,8 Topic: __consumer_offsets Partition: 35 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 36 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 37 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 38 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 39 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 40 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 41 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 42 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 43 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 44 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 45 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 46 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 Topic: __consumer_offsets Partition: 47 Leader: 8 Replicas: 13,174,8 Isr: 8,174,13 Topic: __consumer_offsets Partition: 48 Leader: 13 Replicas: 13,174,8 Isr: 13,8,174 Topic: __consumer_offsets Partition: 49 Leader: 174 Replicas: 13,174,8 Isr: 174,8,13 å‰¯æœ¬æ˜¯3, éƒ½æ˜¯Isr, è¿™æ ·å°±OKäº† ä¸ºå…¶ä»–topicå¢åŠ å‰¯æœ¬1bin/kafka-topics.sh --zookeeper localhost:2182 --describe| grep &quot;Topic: &quot;| grep -v &quot;__consumer_offsets&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; |awk &#x27;&#123;print $1&#125;&#x27; 12345678910111213&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;pd.t1&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;pd.t2&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;pd.t3&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;pd.t4&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;bk.t5&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;bk.t6&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;bk.t7&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;bk.t8&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;bk.t9&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;,&#123;&quot;topic&quot;:&quot;bk.t10&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[13,174,8]&#125;]&#125; è§‚å¯Ÿå‰¯æœ¬å¢åŠ æƒ…å†µ123456789101112è¿”å›å¿…é¡»ä¸ºç©ºbin/kafka-topics.sh --zookeeper localhost:2182 --describe|grep &quot;ReplicationFactor:[[:space:]]*1&quot;è¾“å‡ºIsréœ€è¦&gt;1bin/kafka-topics.sh --zookeeper localhost:2182 --describe|grep Replicas|while read line;do echo &quot;$(awk -F&#x27;Topic:&#x27; &#x27;&#123;print $NF&#125;&#x27; &lt;&lt;&lt; &quot;$&#123;line&#125;&quot;|awk -F &#x27;Partition:&#x27; &#x27;&#123;print $1&#125;&#x27;|sed &#x27;s/[ \\t]*//g&#x27; ) Isr: $(awk -F&#x27;Isr:&#x27; &#x27;&#123;print $NF&#125;&#x27; &lt;&lt;&lt; &quot;$&#123;line&#125;&quot;|tr &quot;,&quot; &quot;\\n&quot;|sort -n|tr &quot;\\n&quot; &quot;,&quot;|sed &#x27;s/,$/\\n/g;&#x27;|sed &#x27;s/[ \\t]*//g&#x27; )&quot;;done|awk &#x27;&#123;printf &quot;%-64s%-4s%-23s\\n&quot;,$1,$2,$3&#125;&#x27;ä½¿ç”¨å¦‚ä¸‹è¯­å¥è¾“å‡ºåªæœ‰ä¸€ä¸ªIsrçš„Topic. (if (length(a) == 1)bin/kafka-topics.sh --zookeeper localhost:2182 --describe|grep Replicas|awk &#x27;&#123;split($NF,a,&quot;,&quot;);slen=asort(a,tA);&#125;&#123;if (length(a) == 1)&#123;&#123;printf $2&quot; : &quot;;for (i = 1; i &lt;= length(a); i++)&#123;if (i==length(a)&amp;&amp;i==1)&#123;printf tA[i];&#125;else&#123;printf tA[i]&quot;,&quot;;&#125;&#125;&#125;&#123;printf &quot;\\n&quot;;&#125;&#125;&#125;&#x27;|awk &#x27;&#123;printf &quot;%-64s%-23s\\n&quot;,$1,$3&#125;&#x27;ä»¥ä¸‹ä¸¤ä¸ªè¿”å›éƒ½éœ€è¦ä¸ºç©ºbin/kafka-topics.sh --zookeeper localhost:2182 --describe --under-replicated-partitionsbin/kafka-topics.sh --zookeeper localhost:2182 --describe --unavailable-partitions åˆ†åŒºé‡åˆ†é…å¢åŠ å‰¯æœ¬æ•°ä»¥å, prefferred replicaæ˜¯ä¸å˜çš„, åœ¨æˆ‘è¿™ä¸ªä¾‹å­é‡Œ, ç”±äºä¹‹å‰æ‰€æœ‰topicæ‰€æœ‰åˆ†åŒºéƒ½åªæœ‰ä¸€ä¸ªå‰¯æœ¬112, æ‰€ä»¥å¢åŠ å‰¯æœ¬ä»¥åprefferred replicaä»ç„¶æ˜¯112. è™½ç„¶auto.leader.rebalance.enableé»˜è®¤ä¸ºtrue, ä½†æ˜¯ç”±äºkafkaè®¡ç®—leaderä¸å‡è¡¡çš„æ–¹æ³•æ˜¯: Kafkaè®¡ç®—ä¸å‡è¡¡ç¨‹åº¦çš„é€»è¾‘å®é™…ä¸Šéå¸¸ç®€å•â€”â€”è¯¥brokerä¸Šçš„leaderä¸æ˜¯preferred replicaçš„åˆ†åŒºæ•°/ brokerä¸Šæ€»çš„åˆ†åŒºæ•°ã€‚ èƒ¡å¤•. Apache Kafkaå®æˆ˜ (Kindle ä½ç½® 4563-4564). ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾. Kindle ç‰ˆæœ¬. æ‰€ä»¥æ²¡æœ‰åµç”¨ æˆ‘ä»¬éœ€è¦è¿›è¡Œåˆ†åŒºé‡åˆ†é…, ç›®çš„æ˜¯æ›´æ”¹prefferred replica ä»¥å¾€è¿›è¡Œé‡åˆ†é…çš„åœºæ™¯æ˜¯kafkaé›†ç¾¤å¢åŠ äº†æ–°çš„broker, æ¯”å¦‚æºé›†ç¾¤k1 k2 k3, æ–°å¢k4 k5. åŸæœ‰Topicä¸ä¼šè‡ªåŠ¨è¿ç§»åˆ°æ–°èŠ‚ç‚¹ä¸Š, ä¸ºäº†è®©k4 k5ä¹Ÿèƒ½å¹²æ´», è¿›è¡Œé‡åˆ†é…, å°†ä¸€éƒ¨åˆ†topicè¿ç§»åˆ°k4 k5 é‡åˆ†é…ååº”è¯¥ä¹Ÿä¼šäº§ç”Ÿä¸€äº›leaderé€‰ä¸¾, å¯¹å®¢æˆ·ç«¯ä¹Ÿä¼šé€ æˆå½±å“ æ„é€ topics-to-move-json-fileæˆ‘ä»¬éœ€è¦æŒ‡æ˜ä¸€ä¸ªéœ€è¦è¿›è¡Œåˆ†åŒºé‡åˆ†é…çš„topicåˆ—è¡¨(å»ºè®®å°‘é‡å¤šæ¬¡) 12# cat /tmp/topics-to-move.json&#123;&quot;topics&quot;: [&#123;&quot;topic&quot;:&quot;ReconChannelMatch&quot;&#125;, &#123;&quot;topic&quot;:&quot;ReconImportBill&quot;&#125;, &#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;&#125;], &quot;version&quot;:1&#125; ç”Ÿäº§åˆ†é…æ–¹æ¡ˆ12345678# bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --topics-to-move-json-file /tmp/topics-to-move.json --broker-list &quot;112,167,226&quot; --generateCurrent partition replica assignment&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:22,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:30,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:21,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:27,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:46,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:25,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:35,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:41,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:33,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:23,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:49,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:47,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:16,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:28,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:31,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:36,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:42,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:18,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:37,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;ReconChannelMatch&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;ReconImportBill&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:15,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:24,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:38,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:17,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:48,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:19,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:13,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:43,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:14,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:20,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:44,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:39,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:45,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:26,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:29,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:34,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:32,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:40,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;]&#125;Proposed partition reassignment configuration&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:49,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:38,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:16,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:27,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:19,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:13,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:46,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:35,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:24,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:43,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:21,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:32,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:37,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:48,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;ReconImportBill&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:40,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:18,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:29,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:23,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:45,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:34,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:26,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:15,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:42,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:31,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:20,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:28,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:17,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:39,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:44,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;ReconChannelMatch&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:36,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:47,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:25,&quot;replicas&quot;:[112,226,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:14,&quot;replicas&quot;:[167,112,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:30,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:41,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:22,&quot;replicas&quot;:[112,167,226],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:33,&quot;replicas&quot;:[226,112,167],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[167,226,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[226,167,112],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;]&#125;[root@bj3-canal-canal-prod-01 kafka]# cat /tmp/topics-to-move.json&#123;&quot;topics&quot;: [&#123;&quot;topic&quot;:&quot;ReconChannelMatch&quot;&#125;, &#123;&quot;topic&quot;:&quot;ReconImportBill&quot;&#125;, &#123;&quot;topic&quot;:&quot;__consumer_offsets&quot;&#125;], &quot;version&quot;:1&#125; ä¿å­˜Proposed partition reassignment configurationåé¢çš„éƒ¨åˆ†åˆ° æ‰§è¡Œé‡åˆ†é…1bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file /tmp/move_prefferred.json --execute æ‰§è¡Œåå¯ä»¥ä½¿ç”¨--verifyå‚æ•°æ¥æŸ¥çœ‹åˆ†åŒºé‡åˆ†é…æ‰§è¡Œæƒ…å†µ 1bin/kafka-reassign-partitions.sh --zookeeper localhost:2181 --reassignment-json-file /tmp/move_prefferred.json --verify æ»šåŠ¨å‡çº§ä»¥ä¸‹æ­¥éª¤æ¯ä¸ªbrokerä¾æ¬¡æ‰§è¡Œ, å…¨éƒ¨æ‰§è¡Œå®Œæˆå†è¿›è¡Œä¸‹ä¸€ä¸ªbrokerçš„æ“ä½œ éƒ¨ç½²æ–°ç‰ˆæœ¬kafkaè¿‡ç¨‹ç•¥, åªè§£å‹è½¯ä»¶åŒ…, å¤åˆ¶æ—§ç‰ˆçš„é…ç½®æ–‡ä»¶server.properties, å¢åŠ å¦‚ä¸‹å‚æ•°é…ç½® 1234567inter.broker.protocol.version=2.1default.replication.factor=3offsets.topic.replication.factor=3transaction.state.log.replication.factor=3transaction.state.log.min.isr=2min.insync.replicas=2 é€ä¸€å‡çº§brokerå¼€ä¸¤ä¸ªçª—å£,åˆ†åˆ«å¯åŠ¨ä¸€ä¸ªproducerå’Œconsumer 123bin/kafka-console-producer.sh --broker-list 172.16.x.x:9092,172.16.x.x:9092,172.16.x.x:9092 --topic test_upgradebin/kafka-console-consumer.sh --bootstrap-server 172.16.x.x:9092,172.16.x.x:9092,172.16.x.x:9092 --topic test_upgrade æµ‹è¯•ä¸€ä¸‹producerå†™æ•°æ®consumeræ˜¯å¦å¯ä»¥æ¶ˆè´¹åˆ°, æˆ‘ä»¬åœ¨ä¸‹æ–‡ä¸­ç§°è¿™ä¸ªæ­¥éª¤ä¸ºT1 å…³é—­æ—§ç‰ˆæœ¬broker12345678910# jps -m2224 WrapperSimpleApp CloudResetPwdUpdateAgent2432 ZooKeeperMain -server localhost:21829204 Jps -m21351 QuorumPeerMain /usr/local/zookeeper/bin/../conf/zoo_test.cfg32542 QuorumPeerMain /usr/local/zookeeper/bin/../conf/zoo.cfg28335 ZooKeeperMain -server localhost:218227279 Kafka config/server.properties# kill 27279 è§‚å¯Ÿæ—¥å¿—, ç¡®è®¤shutdown complete 123tail -f /usr/local/kafka_2.11-2.1.1/logs/kafkaServer.out INFO [ReplicaFetcher replicaId=8, leaderId=174, fetcherId=0] Shutdown completed (kafka.server.ReplicaFetcherThread) æ‰§è¡ŒT1æµ‹è¯•, å¦‚æœç”Ÿäº§æˆ–æ¶ˆè´¹å¤±è´¥, åˆ™å¯åŠ¨æ—§ç‰ˆæœ¬broker, æ’æŸ¥å¥½é—®é¢˜åå†æ¬¡å‡çº§ ä½¿ç”¨æ–°ç‰ˆæœ¬å¯åŠ¨ç¡®è®¤ä¸€ä¸‹å‘½ä»¤æ— è¾“å‡º 1bin/kafka-topics.sh --zookeeper localhost:2182 --describe --unavailable-partitions å¯åŠ¨ 12345cd new_kafka_path./bin/kafka-server-start.sh -daemon config/server.propertiesç¡®è®¤æ— è¾“å‡ºbin/kafka-topics.sh --zookeeper localhost:2182 --describe --under-replicated-partitions æ‰§è¡ŒT1æµ‹è¯•, å¦‚æœç”Ÿäº§æˆ–æ¶ˆè´¹å¤±è´¥, åˆ™å¯åŠ¨æ—§ç‰ˆæœ¬broker, æ’æŸ¥å¥½é—®é¢˜åå†æ¬¡å‡çº§ åˆ‡æ¢è‡³æ–°åè®®ä¿®æ”¹é…ç½®å‚æ•° 1inter.broker.protocol.version=2.4 é€ä¸€é‡å¯broker","categories":[],"tags":[{"name":"Kafka","slug":"Kafka","permalink":"http://fuxkdb.com/tags/Kafka/"}]},{"title":"ä½¿ç”¨Ansibleè‡ªåŠ¨éƒ¨ç½²MGRä¸­ç”Ÿæˆgroup_replication_group_seedså€¼çš„æ–¹æ³•","slug":"2017-08-22-ä½¿ç”¨Ansibleè‡ªåŠ¨éƒ¨ç½²MGRä¸­ç”Ÿæˆgroup_replication_group_seedså€¼çš„æ–¹æ³•","date":"2020-03-20T04:23:00.000Z","updated":"2020-03-20T04:56:09.423Z","comments":true,"path":"2020/03/20/2017-08-22-ä½¿ç”¨Ansibleè‡ªåŠ¨éƒ¨ç½²MGRä¸­ç”Ÿæˆgroup_replication_group_seedså€¼çš„æ–¹æ³•/","link":"","permalink":"http://fuxkdb.com/2020/03/20/2017-08-22-%E4%BD%BF%E7%94%A8Ansible%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2MGR%E4%B8%AD%E7%94%9F%E6%88%90group_replication_group_seeds%E5%80%BC%E7%9A%84%E6%96%B9%E6%B3%95/","excerpt":"ç”Ÿæˆgroup_replication_group_seedså€¼çš„æ–¹æ³•ç½‘å¡ä¸ç»Ÿä¸€ä¹‹å‰æˆ‘æ˜¯é€šè¿‡groups[&#39;mfw_test&#39;] | map(&#39;extract&#39;, hostvars, [&#39;ansible_all_ipv4_addresses&#39;])è¿™ç§å½¢å¼, å»ä¸€ä¸ªinventory groupä¸‹æ¯ä¸€ä¸ªhostçš„ansible_all_ipv4_addresses ansible_all_ipv4_addressæ˜¯æ‰€æœ‰ç½‘å¡ä¸Šçš„ip, åŒ…æ‹¬æ‰‹åŠ¨æ·»åŠ çš„ip(ä¾‹å¦‚vip) 123456&quot;msg&quot;: &#123; &quot;centos-1&quot;: &#123; &quot;ansible_all_ipv4_addresses&quot;: [ &quot;192.168.124.136&quot;, &quot;172.16.120.10&quot; ],","text":"ç”Ÿæˆgroup_replication_group_seedså€¼çš„æ–¹æ³•ç½‘å¡ä¸ç»Ÿä¸€ä¹‹å‰æˆ‘æ˜¯é€šè¿‡groups[&#39;mfw_test&#39;] | map(&#39;extract&#39;, hostvars, [&#39;ansible_all_ipv4_addresses&#39;])è¿™ç§å½¢å¼, å»ä¸€ä¸ªinventory groupä¸‹æ¯ä¸€ä¸ªhostçš„ansible_all_ipv4_addresses ansible_all_ipv4_addressæ˜¯æ‰€æœ‰ç½‘å¡ä¸Šçš„ip, åŒ…æ‹¬æ‰‹åŠ¨æ·»åŠ çš„ip(ä¾‹å¦‚vip) 123456&quot;msg&quot;: &#123; &quot;centos-1&quot;: &#123; &quot;ansible_all_ipv4_addresses&quot;: [ &quot;192.168.124.136&quot;, &quot;172.16.120.10&quot; ], æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„playbookæŸ¥çœ‹hostvars 12- debug: msg: &quot;&#123;&#123; hostvars &#125;&#125;&quot; ä¸Šé¢çš„æƒ…å†µæ˜¯æ²¡æœ‰vip, ä¹Ÿå°±æ˜¯ 1234567891011121314151617181920212223[root@centos-1 ~]# ip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:0c:29:b2:18:33 brd ff:ff:ff:ff:ff:ff inet 172.16.120.10/24 brd 172.16.120.255 scope global ens33 valid_lft forever preferred_lft forever inet6 fe80::e880:2501:cdab:b11d/64 scope link tentative dadfailed valid_lft forever preferred_lft forever inet6 fe80::ada9:2128:e605:334a/64 scope link tentative dadfailed valid_lft forever preferred_lft forever inet6 fe80::2f9b:31f4:73e6:e438/64 scope link tentative dadfailed valid_lft forever preferred_lft forever3: ens37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:50:56:2c:1a:a8 brd ff:ff:ff:ff:ff:ff inet 192.168.124.166/24 brd 192.168.124.255 scope global dynamic ens37 valid_lft 1452sec preferred_lft 1452sec inet6 fe80::5c28:fb1e:459:1b9/64 scope link valid_lft forever preferred_lft forever å¦‚æœæœ‰vipåˆ™æ˜¯ 1234567&quot;msg&quot;: &#123; &quot;centos-1&quot;: &#123; &quot;ansible_all_ipv4_addresses&quot;: [ &quot;192.168.124.136&quot;, &quot;172.16.120.10&quot;, &quot;172.16.120.100&quot; ], ä¹‹å‰æˆ‘ä¸ºäº†è§£å†³ç°å®æœåŠ¡å™¨ç½‘å¡åç§°ä¸ç»Ÿä¸€çš„é—®é¢˜(ç°å®æœ‰å«em2çš„æœ‰å«p6p1çš„è¿˜æœ‰team0, eth0ç­‰ç­‰, è€Œcmdbä¸­åˆæ²¡æœ‰è¿™äº›ä¿¡æ¯), é‡‡ç”¨äº†ansible_all_ipv4_addressesçš„æ–¹æ³•, å–æ‰€æœ‰ip, ç„¶åæ ¹æ®è§„åˆ™è‡ªå·±è¿‡æ»¤(æ¯”å¦‚è¿‡æ»¤æ‰vipç­‰ç­‰). æ—¶é—´é•¿äº†å°±æˆäº†è¿™ä¹ˆä¸€å¨ 123456789101112131415&#123;%- for ip_list in (groups[group] | map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_all_ipv4_addresses&#x27;])) -%&#125; &#123;%- if loop.last -%&#125; &#123;%- for ip in ip_list -%&#125; &#123;%- if (ip.startswith(&#x27;192.168&#x27;) or ip.startswith(&#x27;10.163&#x27;) or ip.startswith(&#x27;10.152&#x27;) or ip.startswith(&#x27;10.132&#x27;) or ip.startswith(&#x27;10.133&#x27;)) and not ip.startswith(&#x27;192.168.3&#x27;) and not ip.startswith(&#x27;192.168.8&#x27;) and not ip.startswith(&#x27;192.168.16&#x27;) and not ip.startswith(&#x27;10.62&#x27;) and not ip.startswith(&#x27;10.32&#x27;) and not ip.startswith(&#x27;10.52&#x27;) and not ip.startswith(&#x27;10.33&#x27;) and not (ip.startswith(&#x27;10.133.1.2&#x27;) and ip.split(&#x27;.&#x27;)[3]|int&gt;=200) -%&#125; &#123;&#123; ip &#125;&#125;:2&#123;&#123; mysql_port &#125;&#125; &#123;%- endif -%&#125; &#123;%- endfor %&#125; &#123;%- else -%&#125; &#123;%- for ip in ip_list -%&#125; &#123;%- if (ip.startswith(&#x27;192.168&#x27;) or ip.startswith(&#x27;10.163&#x27;) or ip.startswith(&#x27;10.152&#x27;) or ip.startswith(&#x27;10.132&#x27;) or ip.startswith(&#x27;10.133&#x27;)) and not ip.startswith(&#x27;192.168.3&#x27;) and not ip.startswith(&#x27;192.168.8&#x27;) and not ip.startswith(&#x27;192.168.16&#x27;) and not ip.startswith(&#x27;10.62&#x27;) and not ip.startswith(&#x27;10.32&#x27;) and not ip.startswith(&#x27;10.52&#x27;) and not ip.startswith(&#x27;10.33&#x27;) and not (ip.startswith(&#x27;10.133.1.2&#x27;) and ip.split(&#x27;.&#x27;)[3]|int&gt;=200) -%&#125; &#123;&#123; ip &#125;&#125;:2&#123;&#123; mysql_port &#125;&#125;, &#123;%- endif -%&#125; &#123;%- endfor -%&#125; &#123;%- endif -%&#125;&#123;%- endfor -%&#125; å†™åˆ°vars/main.yamlé‡Œ 1group_replication_group_seeds: &quot;&#123;%- for ip_list in (groups[group] | map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_all_ipv4_addresses&#x27;])) -%&#125;&#123;%- if loop.last -%&#125;&#123;%- for ip in ip_list -%&#125;&#123;%- if (ip.startswith(&#x27;192.168&#x27;) or ip.startswith(&#x27;10.163&#x27;) or ip.startswith(&#x27;10.152&#x27;) or ip.startswith(&#x27;10.132&#x27;) or ip.startswith(&#x27;10.133&#x27;)) and not ip.startswith(&#x27;192.168.3&#x27;) and not ip.startswith(&#x27;192.168.8&#x27;) and not ip.startswith(&#x27;192.168.16&#x27;) and not ip.startswith(&#x27;10.62&#x27;) and not ip.startswith(&#x27;10.32&#x27;) and not ip.startswith(&#x27;10.52&#x27;) and not ip.startswith(&#x27;10.33&#x27;) and not (ip.startswith(&#x27;10.133.1.2&#x27;) and ip.split(&#x27;.&#x27;)[3]|int&gt;=200) -%&#125;&#123;&#123; ip &#125;&#125;:2&#123;&#123; mysql_port &#125;&#125;&#123;%- endif -%&#125;&#123;%- endfor %&#125;&#123;%- else -%&#125;&#123;%- for ip in ip_list -%&#125;&#123;%- if (ip.startswith(&#x27;192.168&#x27;) or ip.startswith(&#x27;10.163&#x27;) or ip.startswith(&#x27;10.152&#x27;) or ip.startswith(&#x27;10.132&#x27;) or ip.startswith(&#x27;10.133&#x27;)) and not ip.startswith(&#x27;192.168.3&#x27;) and not ip.startswith(&#x27;192.168.8&#x27;) and not ip.startswith(&#x27;192.168.16&#x27;) and not ip.startswith(&#x27;10.62&#x27;) and not ip.startswith(&#x27;10.32&#x27;) and not ip.startswith(&#x27;10.52&#x27;) and not ip.startswith(&#x27;10.33&#x27;) and not (ip.startswith(&#x27;10.133.1.2&#x27;) and ip.split(&#x27;.&#x27;)[3]|int&gt;=200) -%&#125;&#123;&#123; ip &#125;&#125;:2&#123;&#123; mysql_port &#125;&#125;,&#123;%- endif -%&#125;&#123;%- endfor -%&#125;&#123;%- endif -%&#125;&#123;%- endfor -%&#125;&quot; ç½‘å¡ç»Ÿä¸€å¦‚æœç½‘å¡æ˜¯ç»Ÿä¸€çš„, æˆ–è€…æˆ‘ä»¬èƒ½çŸ¥é“è¦éƒ¨ç½²æœåŠ¡å™¨çš„ç½‘å¡å«ä»€ä¹ˆ. ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡çš„æœºå™¨ç½‘å¡åç§°è¦ä¸€è‡´, å¦åˆ™ä¸‹é¢çš„æ–¹æ³•ä¹Ÿç”¨ä¸äº† è§‚å¯Ÿhostvarså¯ä»¥å‘ç° ansible_ens33æ— vip 12345678910111213141516171819202122232425&quot;msg&quot;: &#123; &quot;centos-1&quot;: &#123; &quot;ansible_all_ipv4_addresses&quot;: [ &quot;192.168.124.136&quot;, &quot;172.16.120.10&quot; ], ...çœç•¥ &quot;ansible_ens33&quot;: &#123; &quot;active&quot;: true, &quot;device&quot;: &quot;ens33&quot;, ...çœç•¥ &quot;hw_timestamp_filters&quot;: [], &quot;ipv4&quot;: &#123; &quot;address&quot;: &quot;172.16.120.10&quot;, &quot;broadcast&quot;: &quot;172.16.120.255&quot;, &quot;netmask&quot;: &quot;255.255.255.0&quot;, &quot;network&quot;: &quot;172.16.120.0&quot; &#125;, &quot;ipv6&quot;: [ &#123; &quot;address&quot;: &quot;fe80::e880:2501:cdab:b11d&quot;, &quot;prefix&quot;: &quot;64&quot;, &quot;scope&quot;: &quot;link&quot; &#125; ], ansible_ens33æœ‰vip 12345678910111213141516171819202122232425262728293031323334353637383940&quot;msg&quot;: &#123; &quot;centos-1&quot;: &#123; &quot;ansible_all_ipv4_addresses&quot;: [ &quot;192.168.124.136&quot;, &quot;172.16.120.10&quot;, &quot;172.16.120.100&quot; ], ...çœç•¥ &quot;ansible_ens33&quot;: &#123; &quot;active&quot;: true, &quot;device&quot;: &quot;ens33&quot;, ...çœç•¥ &quot;hw_timestamp_filters&quot;: [], &quot;ipv4&quot;: &#123; &quot;address&quot;: &quot;172.16.120.10&quot;, &quot;broadcast&quot;: &quot;172.16.120.255&quot;, &quot;netmask&quot;: &quot;255.255.255.0&quot;, &quot;network&quot;: &quot;172.16.120.0&quot; &#125;, &quot;ipv4_secondaries&quot;: [ --ä¸çŸ¥é“ä¸ºä»€ä¹ˆæœ‰ä¿© &#123; &quot;address&quot;: &quot;172.16.120.100&quot;, &quot;broadcast&quot;: &quot;global&quot;, &quot;netmask&quot;: &quot;255.255.255.0&quot;, &quot;network&quot;: &quot;172.16.120.0&quot; &#125;, &#123; &quot;address&quot;: &quot;172.16.120.100&quot;, &quot;broadcast&quot;: &quot;global&quot;, &quot;netmask&quot;: &quot;255.255.255.0&quot;, &quot;network&quot;: &quot;172.16.120.0&quot; &#125; ], &quot;ipv6&quot;: [ &#123; &quot;address&quot;: &quot;fe80::e880:2501:cdab:b11d&quot;, &quot;prefix&quot;: &quot;64&quot;, &quot;scope&quot;: &quot;link&quot; &#125; ], å¯ä»¥è¿™æ ·å–map(&#39;extract&#39;, hostvars, [&#39;ansible_ens33&#39;, &#39;ipv4&#39;, &#39;address&#39;]) äºæ˜¯ 1234567891011121314151617181920[root@centos-4 ansible]# cat hosts[mysql]172.16.120.10 mysql_repl_role=master172.16.120.11 mysql_repl_role=slave172.16.120.12 mysql_repl_role=slave[mha]172.16.120.13[proxysql]172.16.120.10 weight=100 comment=PRIMARY172.16.120.11 weight=99 comment=SECONDARY172.16.120.12 weight=99 comment=SECONDARY[all:vars]ansible_user=root#ansible_password=vagrantansible_port=22ansible_become=true playbook 1234567---- name: &#x27;æµ‹è¯•&#x27; hosts: mysql tasks: - name: &quot; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])|list&quot; debug: msg: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])|list&#125;&#125;&quot; å…¶ä¸­172.16.120.10è¿˜æ˜¯æœ‰vip 172.16.120.100çš„ ç»“æœ 12345678910111213141516171819202122TASK [groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])|list] *********************************************************************************************************************************************************************ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: [ &quot;172.16.120.10&quot;, &quot;172.16.120.11&quot;, &quot;172.16.120.12&quot; ]&#125;ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: [ &quot;172.16.120.10&quot;, &quot;172.16.120.11&quot;, &quot;172.16.120.12&quot; ]&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: [ &quot;172.16.120.10&quot;, &quot;172.16.120.11&quot;, &quot;172.16.120.12&quot; ]&#125; åˆ°è¿™ä¸€æ­¥è¿™æ˜¯å–åˆ°äº†æ‰€æœ‰ip, è¿˜æ²¡å®Œæˆæ‹¼æ¥å‡ºgroup_replication_group_seeds æ¥ä¸‹æ¥è¦ç”¨åˆ°zip_longest æ‹¿å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ 1234567891011121314- name: &#x27;æµ‹è¯•&#x27; hosts: 172.16.120.10 tasks: - name: give me list combo of two lists debug: msg: &quot;&#123;&#123; [1,2,3,4,5] | zip([&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;,&#x27;d&#x27;,&#x27;e&#x27;,&#x27;f&#x27;]) | list &#125;&#125;&quot; - name: give me shortest combo of two lists debug: msg: &quot;&#123;&#123; [1,2,3] | zip([&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;,&#x27;d&#x27;,&#x27;e&#x27;,&#x27;f&#x27;], [&#x27;!&#x27;,&#x27;@&#x27;,&#x27;#&#x27;,&#x27;$&#x27;]) | list &#125;&#125;&quot; - name: give me longest combo of three lists , fill with X debug: msg: &quot;&#123;&#123; [1,2,3] | zip_longest([&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;,&#x27;d&#x27;,&#x27;e&#x27;,&#x27;f&#x27;], [21, 22, 23], fillvalue=&#x27;X&#x27;) | list &#125;&#125;&quot; ç»“æœ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182TASK [give me list combo of two lists] *************************************************************************************************************************************************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: [ [ 1, &quot;a&quot; ], [ 2, &quot;b&quot; ], [ 3, &quot;c&quot; ], [ 4, &quot;d&quot; ], [ 5, &quot;e&quot; ] ]&#125;TASK [give me shortest combo of two lists] *********************************************************************************************************************************************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: [ [ 1, &quot;a&quot;, &quot;!&quot; ], [ 2, &quot;b&quot;, &quot;@&quot; ], [ 3, &quot;c&quot;, &quot;#&quot; ] ]&#125;TASK [give me longest combo of three lists , fill with X] ******************************************************************************************************************************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: [ [ 1, &quot;a&quot;, 21 ], [ 2, &quot;b&quot;, 22 ], [ 3, &quot;c&quot;, 23 ], [ &quot;X&quot;, &quot;d&quot;, &quot;X&quot; ], [ &quot;X&quot;, &quot;e&quot;, &quot;X&quot; ], [ &quot;X&quot;, &quot;f&quot;, &quot;X&quot; ] ]&#125; å¯ä»¥çœ‹åˆ°åœ¨è¿™å‰ä¸¤ä¸ªtaskä¸­, â€œå¤šä½™â€çš„ä¼šè¢«èˆå¼ƒæ‰, è€Œä¸”å¯ä»¥zipå¤šä¸ªlist, æœ€åä¸€ä¸ªtaskä½¿ç”¨fillvalueå–â€è¡¥é½â€ äºæ˜¯æˆ‘ä»¬å°±å¯ä»¥ 123- name: &quot; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) |list&quot; debug: msg: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;]) | list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) |list&#125;&#125;&quot; è¿™é‡Œä¸ºäº†çœ‹åˆ°ç»“æœæ‰€ä»¥listä¸€ä¸‹,å¦åˆ™æ˜¯ä¸€ä¸ª&lt;itertools.izip_longest object at 0x24468e8&gt; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849TASK [groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) |list] **********************************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: [ [ &quot;172.16.120.10&quot;, &quot;:23306&quot; ], [ &quot;172.16.120.11&quot;, &quot;:23306&quot; ], [ &quot;172.16.120.12&quot;, &quot;:23306&quot; ] ]&#125;ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: [ [ &quot;172.16.120.10&quot;, &quot;:23306&quot; ], [ &quot;172.16.120.11&quot;, &quot;:23306&quot; ], [ &quot;172.16.120.12&quot;, &quot;:23306&quot; ] ]&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: [ [ &quot;172.16.120.10&quot;, &quot;:23306&quot; ], [ &quot;172.16.120.11&quot;, &quot;:23306&quot; ], [ &quot;172.16.120.12&quot;, &quot;:23306&quot; ] ]&#125; ç„¶åä½¿ç”¨map(â€˜joinâ€™),å°±æ˜¯å°†åˆ—è¡¨é‡Œçš„æ¯ä¸€ä¸ªå…ƒç´ ä½¿ç”¨joinæ‹¼æ¥ 123- name: &quot; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) | map(&#x27;join&#x27;)|list &quot; debug: msg: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;]) | list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) | map(&#x27;join&#x27;) |list&#125;&#125;&quot; 12345678910111213141516171819202122TASK [groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) | map(&#x27;join&#x27;)|list] *********************************************************************************************ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: [ &quot;172.16.120.10:23306&quot;, &quot;172.16.120.11:23306&quot;, &quot;172.16.120.12:23306&quot; ]&#125;ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: [ &quot;172.16.120.10:23306&quot;, &quot;172.16.120.11:23306&quot;, &quot;172.16.120.12:23306&quot; ]&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: [ &quot;172.16.120.10:23306&quot;, &quot;172.16.120.11:23306&quot;, &quot;172.16.120.12:23306&quot; ]&#125; æœ€å 123456789---- name: &#x27;æµ‹è¯•&#x27; hosts: mysql vars: mysql_port: 3306 tasks: - name: &quot; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) | map(&#x27;join&#x27;) | join(&#x27;,&#x27;)&quot; debug: msg: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;]) | list | zip_longest([], fillvalue=&#x27;:2&#x27;+mysql_port|string) | map(&#x27;join&#x27;) | join(&#x27;,&#x27;)&#125;&#125;&quot; 12345678910TASK [groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=:3306) | map(&#x27;join&#x27;) | join(&#x27;,&#x27;)] *******************************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10:23306,172.16.120.11:23306,172.16.120.12:23306&quot;&#125;ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10:23306,172.16.120.11:23306,172.16.120.12:23306&quot;&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10:23306,172.16.120.11:23306,172.16.120.12:23306&quot;&#125; é™„1: ç”Ÿäº§group_replication_local_addressçš„æ–¹æ³•ä½¿ç”¨hostvars[inventory_hostname] 123- name: &quot;hostvars[inventory_hostname][&#x27;ansible_ens33&#x27;][&#x27;ipv4&#x27;][&#x27;address&#x27;]:23306&quot; debug: msg: &quot;&#123;&#123; hostvars[inventory_hostname][&#x27;ansible_ens33&#x27;][&#x27;ipv4&#x27;][&#x27;address&#x27;] &#125;&#125;:2&#123;&#123; mysql_port &#125;&#125;&quot; 12345678910TASK [hostvars[inventory_hostname][&#x27;ansible_ens33&#x27;][&#x27;ipv4&#x27;][&#x27;address&#x27;]:23306] **********************************************************************************************************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10:23306&quot;&#125;ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.11:23306&quot;&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.12:23306&quot;&#125; åŒæ ·, å¦‚æœç½‘å¡ä¸ç»Ÿä¸€, åªèƒ½â€¦ 12345&#123;% for ip in ansible_all_ipv4_addresses -%&#125; &#123;% if (ip.startswith(&#x27;192.168&#x27;) or ip.startswith(&#x27;10.163&#x27;) or ip.startswith(&#x27;10.152&#x27;) or ip.startswith(&#x27;10.132&#x27;) or ip.startswith(&#x27;10.133&#x27;)) and not ip.startswith(&#x27;192.168.3&#x27;) and not ip.startswith(&#x27;192.168.8&#x27;) and not ip.startswith(&#x27;192.168.16&#x27;) and not ip.startswith(&#x27;10.62&#x27;) and not ip.startswith(&#x27;10.32&#x27;) and not ip.startswith(&#x27;10.52&#x27;) and not ip.startswith(&#x27;10.33&#x27;) and not (ip.startswith(&#x27;10.133.1.2&#x27;) and ip.split(&#x27;.&#x27;)[3]|int&gt;=200) -%&#125; loose-group_replication_local_address = &#123;&#123; ip &#125;&#125;:2&#123;&#123; mysql_port &#125;&#125; &#123;% endif %&#125;&#123;% endfor %&#125; é™„2: /etc/hostsç½‘å¡ä¸ç»Ÿä¸€ 123456- name: è®¾ç½®/etc/hosts blockinfile: path: /etc/hosts block: | &#123;&#123; item &#125;&#125; with_items: &quot;&#123;&#123; etc_hosts &#125;&#125;&quot; 123456789101112etc_hosts: | &#123;% for ip_list in (groups[group] | map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_all_ipv4_addresses&#x27;])) -%&#125; &#123;% set iploop = loop %&#125; &#123;% for ip in ip_list -%&#125; &#123;% for hostname in (groups[group] | map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_hostname&#x27;])) -%&#125; &#123;% if loop.index == iploop.index -%&#125; &#123;% if (ip.startswith(&#x27;192.168&#x27;) or ip.startswith(&#x27;10.163&#x27;) or ip.startswith(&#x27;10.152&#x27;) or ip.startswith(&#x27;10.132&#x27;) or ip.startswith(&#x27;10.133&#x27;) ) and not ip.startswith(&#x27;192.168.3&#x27;) and not ip.startswith(&#x27;192.168.8&#x27;) and not ip.startswith(&#x27;192.168.16&#x27;) and not ip.startswith(&#x27;10.62&#x27;) and not ip.startswith(&#x27;10.32&#x27;) and not ip.startswith(&#x27;10.52&#x27;) and not ip.startswith(&#x27;10.33&#x27;) and not (ip.startswith(&#x27;10.133.1.2&#x27;) and ip.split(&#x27;.&#x27;)[3]|int&gt;=200) -%&#125; &#123;&#123; ip &#125;&#125; &#123;&#123; hostname &#125;&#125; &#123;% endif %&#125; &#123;% endif %&#125; &#123;% endfor %&#125; &#123;% endfor %&#125; &#123;% endfor %&#125; ç½‘å¡ç»Ÿä¸€ 123456789101112131415---- name: &#x27;æµ‹è¯•&#x27; hosts: mysql vars: etc_hosts: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;]) | list | zip(groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_hostname&#x27;])) | map(&#x27;join&#x27;,&#x27; &#x27;) | join(&#x27;\\n&#x27;) &#125;&#125;&quot; tasks: - name: &quot; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip(groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_hostname&#x27;])) | map(&#x27;join&#x27;,&#x27; &#x27;) | join(&#x27;\\n&#x27;) &quot; debug: msg: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;]) | list | zip(groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_hostname&#x27;])) | map(&#x27;join&#x27;,&#x27; &#x27;) | join(&#x27;\\n&#x27;) &#125;&#125;&quot; - name: è®¾ç½®/etc/hosts blockinfile: path: /tmp/hosts.test block: | &#123;&#123; item &#125;&#125; with_items: &quot;&#123;&#123; etc_hosts &#125;&#125;&quot; 12345678910111213141516171819TASK [groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip(groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_hostname&#x27;])) | map(&#x27;join&#x27;,&#x27; &#x27;) | join(&#x27;&#x27;)] ***************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10 centos-1\\n172.16.120.11 centos-2\\n172.16.120.12 centos-3&quot;&#125;ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10 centos-1\\n172.16.120.11 centos-2\\n172.16.120.12 centos-3&quot;&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10 centos-1\\n172.16.120.11 centos-2\\n172.16.120.12 centos-3&quot;&#125;[root@centos-1 ~]# cat /tmp/hosts.test # BEGIN ANSIBLE MANAGED BLOCK172.16.120.10 centos-1172.16.120.11 centos-2172.16.120.12 centos-3# END ANSIBLE MANAGED BLOCK æ³¨æ„hostnameè¦ç”¨groups[&#39;mysql&#39;]|map(&#39;extract&#39;, hostvars, [&#39;ansible_hostname&#39;])å–, ä¸èƒ½ç›´æ¥ansible_hostname 123- name: &quot; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27; &#x27;+ansible_hostname) | map(&#x27;join&#x27;)| join(&#x27;\\n&#x27;) &quot; debug: msg: &quot;&#123;&#123; groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;]) | list | zip_longest([], fillvalue=&#x27; &#x27;+ansible_hostname) | map(&#x27;join&#x27;) | join(&#x27;\\n&#x27;)&#125;&#125;&quot; çœ‹è¾“å‡ºçš„ç»“æœhostnameéƒ¨åˆ†, æ¯ä¸ªä¸»æœºéƒ½åªå–åˆ°è‡ªå·±çš„hostname 123456789101112TASK [groups[&#x27;mysql&#x27;]|map(&#x27;extract&#x27;, hostvars, [&#x27;ansible_ens33&#x27;, &#x27;ipv4&#x27;, &#x27;address&#x27;])| list | zip_longest([], fillvalue=&#x27; &#x27;+ansible_hostname) | map(&#x27;join&#x27;)| join(&#x27;&#x27;)] ****************************************************************************************ok: [172.16.120.10] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10 centos-1\\n172.16.120.11 centos-1\\n172.16.120.12 centos-1&quot;&#125;ok: [172.16.120.11] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10 centos-2\\n172.16.120.11 centos-2\\n172.16.120.12 centos-2&quot;&#125;ok: [172.16.120.12] =&gt; &#123; &quot;msg&quot;: &quot;172.16.120.10 centos-3\\n172.16.120.11 centos-3\\n172.16.120.12 centos-3&quot;&#125;","categories":[],"tags":[{"name":"Ansible","slug":"Ansible","permalink":"http://fuxkdb.com/tags/Ansible/"}]},{"title":"ä½¿ç”¨pythonæ¶ˆè´¹canal protobufæ ¼å¼æ•°æ®","slug":"2020-03-19-ä½¿ç”¨pythonæ¶ˆè´¹canal-protobufæ ¼å¼æ•°æ®","date":"2020-03-19T15:23:00.000Z","updated":"2020-03-19T14:55:55.042Z","comments":true,"path":"2020/03/19/2020-03-19-ä½¿ç”¨pythonæ¶ˆè´¹canal-protobufæ ¼å¼æ•°æ®/","link":"","permalink":"http://fuxkdb.com/2020/03/19/2020-03-19-%E4%BD%BF%E7%94%A8python%E6%B6%88%E8%B4%B9canal-protobuf%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE/","excerpt":"canal -&gt; kafka -&gt; consumer. flatMessage=Falseå‚è€ƒ canal Pythonå®¢æˆ·ç«¯.ç”±äºcanal Pythonå®¢æˆ·ç«¯æ˜¯ä½œä¸ºcanalçš„clientç›´è¿canal 11111ç«¯å£æ¶ˆè´¹æ•°æ®è€Œéæ¶ˆè´¹kafkaæ•°æ®, æ‰€ä»¥exampleä¸èƒ½ç…§æ¬, éœ€è¦åšä¸€äº›ä¿®æ”¹ Python3.7.4 requriments 12345678910111213141516171819202122232425262728293031backcall==0.1.0bleach==3.1.0canal-python==0.4certifi==2019.6.16chardet==3.0.4confluent-kafka==1.3.0decorator==4.4.2docopt==0.6.2docutils==0.15.2idna==2.8ipython==7.13.0ipython-genutils==0.2.0jedi==0.16.0parso==0.6.2pexpect==4.8.0pickleshare==0.7.5pkginfo==1.5.0.1prompt-toolkit==3.0.4protobuf==3.9.1ptyprocess==0.6.0Pygments==2.4.2readme-renderer==24.0requests==2.22.0requests-toolbelt==0.9.1six==1.12.0tqdm==4.34.0traitlets==4.3.3twine==1.13.0urllib3==1.25.3wcwidth==0.1.8webencodings==0.5.1","text":"canal -&gt; kafka -&gt; consumer. flatMessage=Falseå‚è€ƒ canal Pythonå®¢æˆ·ç«¯.ç”±äºcanal Pythonå®¢æˆ·ç«¯æ˜¯ä½œä¸ºcanalçš„clientç›´è¿canal 11111ç«¯å£æ¶ˆè´¹æ•°æ®è€Œéæ¶ˆè´¹kafkaæ•°æ®, æ‰€ä»¥exampleä¸èƒ½ç…§æ¬, éœ€è¦åšä¸€äº›ä¿®æ”¹ Python3.7.4 requriments 12345678910111213141516171819202122232425262728293031backcall==0.1.0bleach==3.1.0canal-python==0.4certifi==2019.6.16chardet==3.0.4confluent-kafka==1.3.0decorator==4.4.2docopt==0.6.2docutils==0.15.2idna==2.8ipython==7.13.0ipython-genutils==0.2.0jedi==0.16.0parso==0.6.2pexpect==4.8.0pickleshare==0.7.5pkginfo==1.5.0.1prompt-toolkit==3.0.4protobuf==3.9.1ptyprocess==0.6.0Pygments==2.4.2readme-renderer==24.0requests==2.22.0requests-toolbelt==0.9.1six==1.12.0tqdm==4.34.0traitlets==4.3.3twine==1.13.0urllib3==1.25.3wcwidth==0.1.8webencodings==0.5.1 ä¸»è¦å‚è€ƒ https://github.com/haozi3156666/canal-python/blob/master/canal/client.py 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183# -*- coding: utf8 -*-# __author__ = &#x27;Fan()&#x27;# Date: 2020-03-18&#x27;&#x27;&#x27;Usage: canal_kafka_protobuf_consume.py --bootstrap-servers=&lt;host:port,host2:port2..&gt; [--k_user=&lt;user&gt; ] [--from-beginning=&lt;false&gt; | --from-end=&lt;false&gt;] --topic=&lt;topic_name&gt; [--partition=&lt;partition_number&gt;] [--verbose=&lt;0&gt;] canal_kafka_protobuf_consume.py -h | --help canal_kafka_protobuf_consume.py --versionOptions: -h --help æ‰“å°å¸®åŠ©ä¿¡æ¯. --version ç‰ˆæœ¬ä¿¡æ¯. --bootstrap_servers=&lt;host:port,host2:port2..&gt; kafka servers --from-beginning=&lt;false&gt; ä»å¤´å¼€å§‹æ¶ˆè´¹ [default: False] --from-end=&lt;false&gt; ä»æœ€åå¼€å§‹æ¶ˆè´¹ [default: True] --k_user=&lt;user&gt; kafkaç”¨æˆ·, å¯é€‰é¡¹ --topic=&lt;topic_name&gt; topicåç§° --partition=&lt;partition_number&gt; topicåˆ†åŒºå· [default: 0] --verbose=&lt;0&gt; è¾“å‡ºè¯¦ç»†ä¿¡æ¯0,1,2 é»˜è®¤0ä¸è¾“å‡º [default: 0]&#x27;&#x27;&#x27;import getpassfrom docopt import docoptfrom canal.protocol import CanalProtocol_pb2from canal.protocol import EntryProtocol_pb2from confluent_kafka import Consumer, KafkaError, TopicPartition, OFFSET_END, OFFSET_BEGINNINGclass DocOptArgs: def __init__(self, args): self.topic = args[&#x27;--topic&#x27;] self.k_user = args[&#x27;--k_user&#x27;] self.verbose = int(args[&#x27;--verbose&#x27;]) self.partition = int(args[&#x27;--partition&#x27;]) self.bootstrap_servers = args[&#x27;--bootstrap-servers&#x27;] self.from_end = eval(args[&#x27;--from-end&#x27;].capitalize()) self.from_beginning = eval(args[&#x27;--from-beginning&#x27;].capitalize()) if not self.k_user: self.k_password = None elif self.k_user == &#x27;admin&#x27;: self.k_password = &#x27;superSecurt&#x27; else: self.k_password = getpass.getpass(&quot;please enter kafka password: &quot;)class MyConsumer(DocOptArgs): def __init__(self, docopt_args): self.args = docopt_args DocOptArgs.__init__(self, self.args) if self.verbose &gt;= 1: print(self.args) def _on_send_response(self, err, partations): pt = partations[0] if isinstance(err, KafkaError): print(&#x27;Topic &#123;&#125; åç§»é‡ &#123;&#125; æäº¤å¼‚å¸¸. &#123;&#125;&#x27;.format(pt.topic, pt.offset, err)) raise Exception(err) def messages(self, offset_end=True): config = &#123;&#x27;bootstrap.servers&#x27;: self.bootstrap_servers, &quot;group.id&quot;: self.topic, &#x27;enable.auto.commit&#x27;: True, &quot;fetch.wait.max.ms&quot;: 3000, &quot;max.poll.interval.ms&quot;: 60000, &#x27;session.timeout.ms&#x27;: 60000, &quot;on_commit&quot;: self._on_send_response, &quot;default.topic.config&quot;: &#123;&quot;auto.offset.reset&quot;: &quot;latest&quot;&#125;&#125; if self.k_user and self.k_password: config[&#x27;security.protocol&#x27;] = &#x27;SASL_PLAINTEXT&#x27; config[&#x27;sasl.mechanism&#x27;] = &#x27;SCRAM-SHA-256&#x27; config[&#x27;sasl.username&#x27;] = self.k_user config[&#x27;sasl.password&#x27;] = self.k_password consumer = Consumer(config) offset = OFFSET_END if offset_end else OFFSET_BEGINNING pt = TopicPartition(self.topic, 0, offset) consumer.assign([pt]) # consumer.seek(pt) try: while True: ret = consumer.consume(num_messages=100, timeout=0.1) if ret is None: print(&quot;No message Continue!&quot;) continue for msg in ret: if msg.error() is None: # protobuf binary yield msg.value() elif msg.error(): if msg.error().code() == KafkaError._PARTITION_EOF: continue else: raise Exception(msg.error()) except Exception as e: print(e) consumer.close() except KeyboardInterrupt: consumer.close()class Decoder: @staticmethod def create_canal_message(kafka_message): data = kafka_message packet = CanalProtocol_pb2.Packet() packet.MergeFromString(data) message = dict(id=0, entries=[]) # å› ä¸ºä»kafkaè·å–çš„canalå†™å…¥çš„æ¶ˆæ¯, æ‰€ä»¥è¿™ä¸ªæ¡ä»¶åº”è¯¥æ°¸è¿œæˆç«‹ # if packet.type == CanalProtocol_pb2.PacketType.MESSAGES: messages = CanalProtocol_pb2.Messages() messages.MergeFromString(packet.body) for item in messages.messages: entry = EntryProtocol_pb2.Entry() entry.MergeFromString(item) message[&#x27;entries&#x27;].append(entry) return messageif __name__ == &#x27;__main__&#x27;: version = &#x27;canal_kafka_protobuf_consume 0.1.0&#x27; arguments = docopt(__doc__, version=version) consumer = MyConsumer(arguments) for message in consumer.messages(): canal_message = Decoder.create_canal_message(message) entries = canal_message[&#x27;entries&#x27;] for entry in entries: entry_type = entry.entryType if entry_type in [EntryProtocol_pb2.EntryType.TRANSACTIONBEGIN, EntryProtocol_pb2.EntryType.TRANSACTIONEND]: continue row_change = EntryProtocol_pb2.RowChange() row_change.MergeFromString(entry.storeValue) # event_type = row_change.eventType header = entry.header database = header.schemaName table = header.tableName binlog_file = header.logfileName binlog_pos = header.logfileOffset characterset = header.serverenCode es = header.executeTime gtid = header.gtid event_type = header.eventType for row in row_change.rowDatas: format_data = dict() if event_type == EntryProtocol_pb2.EventType.DELETE: for column in row.beforeColumns: format_data.update(&#123; column.name: column.value &#125;) elif event_type == EntryProtocol_pb2.EventType.INSERT: for column in row.afterColumns: format_data.update(&#123; column.name: column.value &#125;) else: format_data[&#x27;before&#x27;] = dict() format_data[&#x27;after&#x27;] = dict() for column in row.beforeColumns: format_data[&#x27;before&#x27;][column.name] = column.value for column in row.afterColumns: format_data[&#x27;after&#x27;][column.name] = column.value data = dict( db=database, table=table, event_type=EntryProtocol_pb2.EventType.Name(event_type), is_ddl=row_change.isDdl, binlog_file=binlog_file, binlog_pos=binlog_pos, characterset=characterset, es=es, gtid=header.gtid, data=format_data, ) print(data) ä½¿ç”¨æ•ˆæœ 123#python canal_kafka_protobuf_consume.py --bootstrap-servers=172.16.xx.xx:9092,172.16.xx.xx:9092,172.16.xx.xx:9092 --topic=fanboshi.monitor_delay&#123;&#x27;db&#x27;: &#x27;fanboshi&#x27;, &#x27;table&#x27;: &#x27;monitor_delay&#x27;, &#x27;event_type&#x27;: &#x27;INSERT&#x27;, &#x27;is_ddl&#x27;: False, &#x27;binlog_file&#x27;: &#x27;mysql-bin.000006&#x27;, &#x27;binlog_pos&#x27;: 469896982, &#x27;characterset&#x27;: &#x27;UTF-8&#x27;, &#x27;es&#x27;: 1584535911000, &#x27;gtid&#x27;: &#x27;c30c6a02-4e32-11ea-84ec-fa163edcd14e:1-2940100&#x27;, &#x27;data&#x27;: &#123;&#x27;id&#x27;: &#x27;5&#x27;, &#x27;ctime&#x27;: &#x27;2020-03-18 20:51:51&#x27;&#125;&#125;&#123;&#x27;db&#x27;: &#x27;fanboshi&#x27;, &#x27;table&#x27;: &#x27;monitor_delay&#x27;, &#x27;event_type&#x27;: &#x27;INSERT&#x27;, &#x27;is_ddl&#x27;: False, &#x27;binlog_file&#x27;: &#x27;mysql-bin.000006&#x27;, &#x27;binlog_pos&#x27;: 469897261, &#x27;characterset&#x27;: &#x27;UTF-8&#x27;, &#x27;es&#x27;: 1584535912000, &#x27;gtid&#x27;: &#x27;c30c6a02-4e32-11ea-84ec-fa163edcd14e:1-2940101&#x27;, &#x27;data&#x27;: &#123;&#x27;id&#x27;: &#x27;6&#x27;, &#x27;ctime&#x27;: &#x27;2020-03-18 20:51:52&#x27;&#125;&#125;","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Canal","slug":"Canal","permalink":"http://fuxkdb.com/tags/Canal/"}]},{"title":"Canal dynamicTopicé—®é¢˜ç»­","slug":"2020-03-07-Canal-dynamicTopicé—®é¢˜ç»­","date":"2020-03-07T13:23:00.000Z","updated":"2020-03-07T13:23:10.407Z","comments":true,"path":"2020/03/07/2020-03-07-Canal-dynamicTopicé—®é¢˜ç»­/","link":"","permalink":"http://fuxkdb.com/2020/03/07/2020-03-07-Canal-dynamicTopic%E9%97%AE%E9%A2%98%E7%BB%AD/","excerpt":"æœ€è¿‘åœ¨æ–°å…¬å¸æ­äº†ä¸€å¥—canal. æŒ‰ç…§&lt;&gt;è®¾ç½®äº†canal.mq.topicå’Œcanal.mq.dynamicTopic æ„å›¾å°†ä¸€äº›ä¸ç¬¦åˆdynamicTopicåŒ¹é…çš„è¯­å¥çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªé»˜è®¤çš„topicè€Œé¿å…æŠ¥é”™INVALID_TOPIC_EXCEPTION 123456789101112131415161718# table regexcanal.instance.filter.regex=fanboshi\\\\..*,sysbench\\\\..*# table black regexcanal.instance.filter.black.regex=.*\\\\.\\\\_.*\\\\_ghc,.*\\\\.\\\\_.*\\\\_gho,.*\\\\.\\\\_.*\\\\_del# table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)#canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch# table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)#canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch# mq configcanal.mq.topic=default_topic# dynamic topic route by schema or table regex#canal.mq.dynamicTopic=mytest1.user,mytest2\\\\..*,.*\\\\..*canal.mq.dynamicTopic=.*\\\\..*#canal.mq.partition=0# hash partition config#canal.mq.partitionsNum=3#canal.mq.partitionHash=test.table:id^name,.*\\\\..*","text":"æœ€è¿‘åœ¨æ–°å…¬å¸æ­äº†ä¸€å¥—canal. æŒ‰ç…§&lt;&gt;è®¾ç½®äº†canal.mq.topicå’Œcanal.mq.dynamicTopic æ„å›¾å°†ä¸€äº›ä¸ç¬¦åˆdynamicTopicåŒ¹é…çš„è¯­å¥çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªé»˜è®¤çš„topicè€Œé¿å…æŠ¥é”™INVALID_TOPIC_EXCEPTION 123456789101112131415161718# table regexcanal.instance.filter.regex=fanboshi\\\\..*,sysbench\\\\..*# table black regexcanal.instance.filter.black.regex=.*\\\\.\\\\_.*\\\\_ghc,.*\\\\.\\\\_.*\\\\_gho,.*\\\\.\\\\_.*\\\\_del# table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)#canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch# table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)#canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch# mq configcanal.mq.topic=default_topic# dynamic topic route by schema or table regex#canal.mq.dynamicTopic=mytest1.user,mytest2\\\\..*,.*\\\\..*canal.mq.dynamicTopic=.*\\\\..*#canal.mq.partition=0# hash partition config#canal.mq.partitionsNum=3#canal.mq.partitionHash=test.table:id^name,.*\\\\..* å› ä¸ºå’Œå‰å‡ å¤©åŒäº‹è¯´ä¹‹å‰ä½¿dynamicTopicé‡åˆ°äº†bug. ä»Šå¤©æ­£å‡†å¤‡è‡ªå·±æäº›è¯­å¥æµ‹ä¸€æµ‹, äºæ˜¯æƒ³çœ‹ä¸‹default_topicèƒ½å¦æ¶ˆè´¹åˆ°æ¶ˆæ¯(å¦‚æœæ¶ˆè´¹åˆ°äº†å°±è¯´æ˜æˆ‘æ‰§è¡Œçš„è¯­å¥æ— æ³•è¢«dynamicTopicè§„åˆ™åŒ¹é…åˆ°è€Œå‘é€åˆ°äº†è¿™ä¸ªâ€é»˜è®¤Topicâ€) ç»“æœå‘ç°å¤§é‡æ¶ˆæ¯ 123456&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;&quot;,&quot;es&quot;:1583581779000,&quot;id&quot;:655469,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;UPDATE sbtest1 SET c=? WHERE id=?&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;sbtest1&quot;,&quot;ts&quot;:1583581779149,&quot;type&quot;:&quot;QUERY&quot;&#125;&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;&quot;,&quot;es&quot;:1583581779000,&quot;id&quot;:655469,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;DELETE FROM sbtest8 WHERE id=?&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;sbtest8&quot;,&quot;ts&quot;:1583581779149,&quot;type&quot;:&quot;QUERY&quot;&#125;&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;&quot;,&quot;es&quot;:1583581779000,&quot;id&quot;:655469,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;INSERT INTO sbtest8 (id, k, c, pad) VALUES (?, ?, ?, ?)&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;sbtest8&quot;,&quot;ts&quot;:1583581779149,&quot;type&quot;:&quot;QUERY&quot;&#125;&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;&quot;,&quot;es&quot;:1583581779000,&quot;id&quot;:655470,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;insert into fanboshi.monitor_delay(ctime) values(now())&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;monitor_delay&quot;,&quot;ts&quot;:1583581779465,&quot;type&quot;:&quot;QUERY&quot;&#125;&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;&quot;,&quot;es&quot;:1583581780000,&quot;id&quot;:655471,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;insert into fanboshi.monitor_delay(ctime) values(now())&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;monitor_delay&quot;,&quot;ts&quot;:1583581780570,&quot;type&quot;:&quot;QUERY&quot;&#125;&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;&quot;,&quot;es&quot;:1583581781000,&quot;id&quot;:655472,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;insert into fanboshi.monitor_delay(ctime) values(now())&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;monitor_delay&quot;,&quot;ts&quot;:1583581781475,&quot;type&quot;:&quot;QUERY&quot;&#125; ä¸€å¼€å§‹æœ‰ç‚¹æ‡µ, åæ¥ç»†çœ‹å‘ç°è¿™äº›å±…ç„¶éƒ½æ˜¯â€statementâ€æ ¼å¼çš„, æ˜¯åŸå§‹è¯­å¥ äºæ˜¯æœäº†ä¸‹github https://github.com/alibaba/canal/issues/1361 å‚è€ƒä¸€ä¸‹FAQé‡Œçš„è§£é‡Šï¼šhttps://github.com/alibaba/canal/wiki/FAQ é—®1ï¼šINSERT/UPDATE/DELETEè¢«è§£æä¸ºQueryæˆ–DDLè¯­å¥ï¼Ÿ ç­”1ï¼šå‡ºç°è¿™ç±»æƒ…å†µä¸»è¦åŸå› ä¸ºæ”¶åˆ°çš„binlogå°±ä¸ºQueryäº‹ä»¶ï¼Œæ¯”å¦‚: binlogæ ¼å¼ä¸ºérowæ¨¡å¼ï¼Œé€šè¿‡show variables like â€˜binlog_formatâ€™å¯ä»¥æŸ¥çœ‹. é’ˆå¯¹statement/mixedæ¨¡å¼ï¼ŒDMLè¯­å¥éƒ½ä¼šæ˜¯ä»¥SQLè¯­å¥å­˜åœ¨ mysql5.6+ä¹‹åï¼Œåœ¨binlogä¸ºrowæ¨¡å¼ä¸‹ï¼Œé’ˆå¯¹DMLè¯­å¥é€šè¿‡ä¸€ä¸ªå¼€å…³(binlog-rows-query-log-events=true, show variablesé‡Œä¹Ÿå¯ä»¥çœ‹åˆ°è¯¥å˜é‡)ï¼Œè®°å½•DMLçš„åŸå§‹SQLï¼Œå¯¹åº”binlogäº‹ä»¶ä¸ºRowsQueryLogEventï¼ŒåŒæ—¶ä¹Ÿæœ‰å¯¹åº”çš„rowè®°å½•. ps. canalå¯ä»¥é€šè¿‡propertiesè®¾ç½®æ¥è¿‡æ»¤ï¼šcanal.instance.filter.query.dml = true æˆ‘è¿™é‡Œè‚¯å®šæ˜¯rowæ ¼å¼äº†. é‚£ä¹ˆå¯èƒ½å°±æ˜¯binlog_rows_query_log_events = 1çš„åŸå› , çœ‹äº†ä¸‹è¿˜çœŸæ˜¯è®¾ç½®æˆäº†on è‡³äºä½œè€…è¯´çš„ 1ps. canalå¯ä»¥é€šè¿‡propertiesè®¾ç½®æ¥è¿‡æ»¤ï¼šcanal.instance.filter.query.dml = true https://github.com/alibaba/canal/wiki/AdminGuide canal.instance.filter.query.dml æ˜¯å¦å¿½ç•¥dmlè¯­å¥(mysql5.6ä¹‹åï¼Œåœ¨rowæ¨¡å¼ä¸‹æ¯æ¡DMLè¯­å¥ä¹Ÿä¼šè®°å½•SQLåˆ°binlogä¸­,å¯å‚è€ƒMySQLæ–‡æ¡£) false è¿™è§£é‡Šä¸æ˜¯å¾ˆæ¸…æ¥šçš„æ ·å­, åˆ°åº•æ˜¯è¿‡æ»¤å•¥å•Š, ä¸ç®¡äº†åæ­£ç”¨ä¸ç€ ç°åœ¨æ€€ç–‘é‚£æ¬¡åŒäº‹é‡åˆ°é—®é¢˜æ˜¯ä¸æ˜¯å°±æ˜¯å› ä¸ºå°±æ˜¯å¼€å¯äº†binlog_rows_query_log_events","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Canal","slug":"Canal","permalink":"http://fuxkdb.com/tags/Canal/"}]},{"title":"canal.mq.flatMessageå‚æ•°","slug":"2020-03-06-canal.mq.flatMessageå‚æ•°","date":"2020-03-06T14:23:00.000Z","updated":"2020-03-07T13:33:32.116Z","comments":true,"path":"2020/03/06/2020-03-06-canal.mq.flatMessageå‚æ•°/","link":"","permalink":"http://fuxkdb.com/2020/03/06/2020-03-06-canal.mq.flatMessage%E5%8F%82%E6%95%B0/","excerpt":"canal.mq.flatMessage æ˜¯å¦ä¸ºjsonæ ¼å¼å¦‚æœè®¾ç½®ä¸ºfalse,å¯¹åº”MQæ”¶åˆ°çš„æ¶ˆæ¯ä¸ºprotobufæ ¼å¼éœ€è¦é€šè¿‡CanalMessageDeserializerè¿›è¡Œè§£ç  canal.mq.flatMessage = true ç”Ÿäº§åˆ°kafkaçš„æ¶ˆæ¯å°±æ˜¯jsonçš„, å¦åˆ™å°±æ˜¯protobufäºŒè¿›åˆ¶çš„","text":"canal.mq.flatMessage æ˜¯å¦ä¸ºjsonæ ¼å¼å¦‚æœè®¾ç½®ä¸ºfalse,å¯¹åº”MQæ”¶åˆ°çš„æ¶ˆæ¯ä¸ºprotobufæ ¼å¼éœ€è¦é€šè¿‡CanalMessageDeserializerè¿›è¡Œè§£ç  canal.mq.flatMessage = true ç”Ÿäº§åˆ°kafkaçš„æ¶ˆæ¯å°±æ˜¯jsonçš„, å¦åˆ™å°±æ˜¯protobufäºŒè¿›åˆ¶çš„12345678910111213141516171819202122232425262728$bin/kafka-console-consumer.sh --bootstrap-server 172.16.23.174:9092 --topic fanboshi.t1 --from-beginning&#123;&quot;data&quot;:null,&quot;database&quot;:&quot;fanboshi&quot;,&quot;es&quot;:1583414454000,&quot;id&quot;:2,&quot;isDdl&quot;:true,&quot;mysqlType&quot;:null,&quot;old&quot;:null,&quot;pkNames&quot;:null,&quot;sql&quot;:&quot;create table t1(id int not null auto_increment primary key,sname varchar(10))&quot;,&quot;sqlType&quot;:null,&quot;table&quot;:&quot;t1&quot;,&quot;ts&quot;:1583414454111,&quot;type&quot;:&quot;CREATE&quot;&#125;&#123;&quot;data&quot;:[&#123;&quot;id&quot;:&quot;1&quot;,&quot;sname&quot;:&quot;fan&quot;&#125;],&quot;database&quot;:&quot;fanboshi&quot;,&quot;es&quot;:1583414520000,&quot;id&quot;:3,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:&#123;&quot;id&quot;:&quot;int(11)&quot;,&quot;sname&quot;:&quot;varchar(10)&quot;&#125;,&quot;old&quot;:null,&quot;pkNames&quot;:[&quot;id&quot;],&quot;sql&quot;:&quot;&quot;,&quot;sqlType&quot;:&#123;&quot;id&quot;:4,&quot;sname&quot;:12&#125;,&quot;table&quot;:&quot;t1&quot;,&quot;ts&quot;:1583414520403,&quot;type&quot;:&quot;INSERT&quot;&#125;&#123;&quot;data&quot;:[&#123;&quot;id&quot;:&quot;1&quot;,&quot;sname&quot;:&quot;fan&quot;&#125;],&quot;database&quot;:&quot;fanboshi&quot;,&quot;es&quot;:1583414520000,&quot;id&quot;:1,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:&#123;&quot;id&quot;:&quot;int(11)&quot;,&quot;sname&quot;:&quot;varchar(10)&quot;&#125;,&quot;old&quot;:null,&quot;pkNames&quot;:[&quot;id&quot;],&quot;sql&quot;:&quot;&quot;,&quot;sqlType&quot;:&#123;&quot;id&quot;:4,&quot;sname&quot;:12&#125;,&quot;table&quot;:&quot;t1&quot;,&quot;ts&quot;:1583414603231,&quot;type&quot;:&quot;INSERT&quot;&#125;&#123;&quot;data&quot;:[&#123;&quot;id&quot;:&quot;2&quot;,&quot;sname&quot;:&quot;bo&quot;&#125;],&quot;database&quot;:&quot;fanboshi&quot;,&quot;es&quot;:1583414621000,&quot;id&quot;:2,&quot;isDdl&quot;:false,&quot;mysqlType&quot;:&#123;&quot;id&quot;:&quot;int(11)&quot;,&quot;sname&quot;:&quot;varchar(10)&quot;&#125;,&quot;old&quot;:null,&quot;pkNames&quot;:[&quot;id&quot;],&quot;sql&quot;:&quot;&quot;,&quot;sqlType&quot;:&#123;&quot;id&quot;:4,&quot;sname&quot;:12&#125;,&quot;table&quot;:&quot;t1&quot;,&quot;ts&quot;:1583414621766,&quot;type&quot;:&quot;INSERT&quot;&#125;*\u0001mysql-bin.000002 *UTF-80ÖŠ.8fanboshiJt1P,Xb6curtGtid*c30c6a02-4e32-11ea-84ec-fa163edcd14e:65460bcurtGtidSn64398bcurtGtidLct64397b _-+_C-+++1+,c30c6a02-4e32-11ea-84ec-fa163edcd14e:1-65460\u0001Pbid (0B1Ri++(11)# _+a+e (0Bfa+R +a_cha_(10)\u0002+y_-+-bi+.000002\u0003 *UTF-80ÖŠ.8fa+b-_hiJ+1P+Xb6c+_+G+id*c30c6a02-4e32-11ea-84ec-fa163edcd14e:65461bc+_+G+idS+64399bc+_+G+idLc+64398b _-+_C-+++1+,c30c6a02-4e32-11ea-84ec-fa163edcd14e:1-65461\u0001Pbid (0B2Ri++(11)&quot; _+a+e (0Bb-R +a_cha_(10)*\u0002\u0002 ä¹±ç éƒ¨åˆ†å°±æ˜¯protobufçš„ protobufæ€§èƒ½è¦å¥½å¾ˆå¤š. 1.1.5æ€§èƒ½æœ‰å¾ˆå¤§æå‡. å³ä¾¿canal.mq.flatMessage = trueæ€§èƒ½ä¹Ÿæ¯”ä»¥å‰å¥½äº†å¾ˆå¤šå¾ˆå¤š canal.mq.flatMessage = trueé»˜è®¤çš„æ ¼å¼æ²¡å¸¦GTID https://github.com/alibaba/canal/wiki/Canal-MQ-Performance","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Canal","slug":"Canal","permalink":"http://fuxkdb.com/tags/Canal/"}]},{"title":"mlanuchæ–‡æ¡£ç¿»è¯‘","slug":"2020-01-21-mlanuchæ–‡æ¡£ç¿»è¯‘","date":"2020-01-21T10:09:00.000Z","updated":"2020-01-21T10:09:59.000Z","comments":true,"path":"2020/01/21/2020-01-21-mlanuchæ–‡æ¡£ç¿»è¯‘/","link":"","permalink":"http://fuxkdb.com/2020/01/21/2020-01-21-mlanuch%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91/","excerpt":"[TOC] mlanuchä½¿ç”¨æ­¤å·¥å…·ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿå¯åŠ¨å¹¶ç›‘è§†æœ¬åœ°è®¡ç®—æœºä¸Šçš„MongoDBç¯å¢ƒã€‚ å®ƒæ”¯æŒç‹¬ç«‹æœåŠ¡å™¨ï¼Œå‰¯æœ¬é›†å’Œåˆ†ç‰‡ç¾¤é›†çš„å„ç§é…ç½®ã€‚ å•ä¸ªèŠ‚ç‚¹æˆ–èŠ‚ç‚¹ç»„å¯ä»¥è½»æ¾åœæ­¢å¹¶é‡æ–°å¯åŠ¨ã€‚ é™¤äº†ä¸‹é¢åˆ—å‡ºçš„mlaunchçš„æ‰€æœ‰åˆ—å‡ºçš„å‚æ•°ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä¼ é€’mongosæˆ–mongodäºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ç†è§£çš„ä»»æ„é€‰é¡¹ï¼Œmlaunchä¼šä¼ é€’æ­£ç¡®çš„å‚æ•°ç»™mongosæˆ–mongodäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ è¿™åŒ…æ‹¬-fæˆ–--configé€‰é¡¹ï¼Œä»¥ä¼ é€’å¸¦æœ‰æ›´å¤šé€‰é¡¹çš„é…ç½®æ–‡ä»¶ã€‚","text":"[TOC] mlanuchä½¿ç”¨æ­¤å·¥å…·ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿå¯åŠ¨å¹¶ç›‘è§†æœ¬åœ°è®¡ç®—æœºä¸Šçš„MongoDBç¯å¢ƒã€‚ å®ƒæ”¯æŒç‹¬ç«‹æœåŠ¡å™¨ï¼Œå‰¯æœ¬é›†å’Œåˆ†ç‰‡ç¾¤é›†çš„å„ç§é…ç½®ã€‚ å•ä¸ªèŠ‚ç‚¹æˆ–èŠ‚ç‚¹ç»„å¯ä»¥è½»æ¾åœæ­¢å¹¶é‡æ–°å¯åŠ¨ã€‚ é™¤äº†ä¸‹é¢åˆ—å‡ºçš„mlaunchçš„æ‰€æœ‰åˆ—å‡ºçš„å‚æ•°ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥ä¼ é€’mongosæˆ–mongodäºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ç†è§£çš„ä»»æ„é€‰é¡¹ï¼Œmlaunchä¼šä¼ é€’æ­£ç¡®çš„å‚æ•°ç»™mongosæˆ–mongodäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ è¿™åŒ…æ‹¬-fæˆ–--configé€‰é¡¹ï¼Œä»¥ä¼ é€’å¸¦æœ‰æ›´å¤šé€‰é¡¹çš„é…ç½®æ–‡ä»¶ã€‚ Usage12mlaunch [-h] [--version] [--no-progressbar] &#123;init,start,stop,restart,list,kill&#125; ... General Parameters ä»¥ä¸‹å‚æ•°é€‚ç”¨äºæ‰€æœ‰å‘½ä»¤. Help -h, --help æ˜¾ç¤ºå¸®åŠ©æ–‡æœ¬å¹¶é€€å‡º. Version --version æ˜¾ç¤ºç‰ˆæœ¬å·å¹¶é€€å‡º. Verbosity --verbose è¿™å°†æ‰“å°å…¶ä»–ä¿¡æ¯ï¼Œå…·ä½“å–å†³äºæ¯ä¸ªå‘½ä»¤. Data directory --dir DIR æ­¤å‚æ•°æ›´æ”¹mlaunchå­˜å‚¨å…¶æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶çš„ç›®å½•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥ç›®å½•æ˜¯æœ¬åœ°ç›®å½•./dataï¼Œä½äºå½“å‰å·¥ä½œç›®å½•ä¸‹ã€‚ Commandsmlaunch uses different commands to initialize, stop, start and list test environments. The general syntax is: 1mlaunch &lt;command&gt; [--parameters ...] å…¶ä¸­ï¼Œcommandæ˜¯ä»¥ä¸‹é€‰æ‹©ä¹‹ä¸€: init: åˆ›å»ºä¸€ä¸ªåˆå§‹ç¯å¢ƒå¹¶å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ stop: åœæ­¢å½“å‰ç¯å¢ƒä¸­çš„éƒ¨åˆ†æˆ–æ‰€æœ‰èŠ‚ç‚¹ start: å¯åŠ¨å½“å‰ç¯å¢ƒä¸­çš„éƒ¨åˆ†æˆ–æ‰€æœ‰èŠ‚ç‚¹ list: æ˜¾ç¤ºå½“å‰ç¯å¢ƒçš„åˆ—è¡¨ kill: å‘å½“å‰ç¯å¢ƒä¸­çš„èŠ‚ç‚¹å‘é€ç»ˆæ­¢ä¿¡å·ï¼ˆæˆ–å…¶ä»–ä¿¡å·ï¼‰ å¯¹äºç»™å®šçš„ç¯å¢ƒï¼ˆç”±å¸¦æœ‰--dirå‚æ•°çš„æ•°æ®ç›®å½•æŒ‡å®šï¼Œé»˜è®¤å€¼ä¸º./dataï¼‰ï¼Œinitå‘½ä»¤åªéœ€è°ƒç”¨ä¸€æ¬¡ã€‚ mlaunchå°†é…ç½®å­˜å‚¨åœ¨æ•°æ®ç›®å½•ä¸­çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶åä¸º.mlaunch_startupã€‚ ä½¿ç”¨æ­¤æ–‡ä»¶ï¼Œmlaunchå¯ä»¥è®°ä½é…ç½®ï¼Œå¹¶å¯ä»¥åœ¨éœ€è¦æ—¶å¯åŠ¨å’Œåœæ­¢èŠ‚ç‚¹ã€‚ initè¿™ä¸ªå‘½ä»¤åˆå§‹åŒ–å¹¶å¯åŠ¨MongoDB stand-anloneinstance, replica sets, æˆ–shared cluster. æ¯ä¸ªç¯å¢ƒåªéœ€è¦è°ƒç”¨ä¸€æ¬¡ï¼ˆç”±å¸¦æœ‰--dirå‚æ•°çš„æ•°æ®ç›®å½•æŒ‡å®šï¼Œé»˜è®¤ä¸º./dataï¼‰ã€‚ Usage1234567mlaunch init [-h] (--single | --replicaset) [--nodes NUM] [--arbiter] [--name NAME] [--priority] [--sharded N [N ...]] [--config NUM] [--csrs] [--mongos NUM] [--verbose] [--port PORT] [--binarypath PATH] [--dir DIR] [--hostname HOSTNAME] [--auth] [--username USERNAME] [--password PASSWORD] [--auth-db DB] [--auth-roles [ROLE [ROLE ...]]] ä¸ºäº†æ–¹ä¾¿å’Œå‘åå…¼å®¹ï¼Œinitå‘½ä»¤æ˜¯é»˜è®¤å‘½ä»¤ï¼Œå¯ä»¥çœç•¥ã€‚ Required Parametersinitå‘½ä»¤éœ€è¦ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ä¹‹ä¸€æ‰èƒ½è¿è¡Œï¼š--singleæˆ–--replicasetã€‚å®ƒä»¬æ˜¯äº’æ–¥çš„ï¼Œå¹¶ä¸”å¿…é¡»ä¸ºæŒ‡å®šä¸€ä¸ªã€‚ --single æ­¤å‚æ•°å°†åˆ›å»ºä¸€ä¸ªstand-alone nodeã€‚å¦‚æœè¿˜æŒ‡å®šäº†--shardedï¼Œåˆ™æ­¤å‚æ•°ä¼šå°†æ¯ä¸ªåˆ†ç‰‡åˆ›å»ºä¸ºstand-alone nodeã€‚ ä¾‹å¦‚, è¦åœ¨ç«¯å£27017ä¸Šå¯åŠ¨ä¸€ä¸ªmongodå®ä¾‹: 1mlaunch --single --replicaset æ­¤å‚æ•°å°†åˆ›å»ºå‰¯æœ¬é›†ï¼Œè€Œä¸æ˜¯å•ä¸ªèŠ‚ç‚¹ã€‚å…¶ä»–å‰¯æœ¬é›†å‚æ•°é€‚ç”¨ï¼Œå¹¶å¯ä¿®æ”¹å‰¯æœ¬é›†çš„å±æ€§ä»¥å¯åŠ¨ã€‚å¦‚æœè¿˜æŒ‡å®šäº†--shardedï¼Œåˆ™æ­¤å‚æ•°å°†ä¸ºæ¯ä¸ªåˆ†ç‰‡åˆ›å»ºä¸€ä¸ªè¿™æ ·çš„å‰¯æœ¬é›†ã€‚ ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨ç«¯å£27017ã€27018ã€27019 å¯åŠ¨3ä¸ªèŠ‚ç‚¹çš„å‰¯æœ¬é›†ï¼š 1mlaunch --replicaset Replica Set Parametersä»¥ä¸‹å‚æ•°æ›´æ”¹äº†å‰¯æœ¬é›†çš„è®¾ç½®æ–¹å¼ã€‚è¿™äº›å‚æ•°è¦æ±‚æ‚¨ä»æ‰€éœ€å‚æ•°ä¸­é€‰æ‹©--replicaseté€‰é¡¹ã€‚ The following parameters change how a replica set is set up. These parameters require that you picked the --replicaset option from the required parameters. --nodes N æŒ‡å®šæ­¤å‰¯æœ¬é›†çš„æ•°æ®æ‰¿è½½èŠ‚ç‚¹ï¼ˆä¸åŒ…æ‹¬ä»²è£å™¨ï¼‰çš„æ•°é‡ã€‚é¢„è®¾å€¼ä¸º3 ä¾‹å¦‚: 1mlaunch --replicaset --nodes 5 è¿™ä¸ªå‘½ä»¤å¯åŠ¨5ä¸ªmongodå®ä¾‹å¹¶é…ç½®ä¸ºä¸€ä¸ªå‰¯æœ¬é›† --arbiter å¦‚æœå­˜åœ¨æ­¤å‚æ•°ï¼Œåˆ™å°†é™„åŠ arbiteræ·»åŠ åˆ°å‰¯æœ¬é›†ã€‚ç›®å‰ï¼Œmlaunchä»…æ”¯æŒæ·»åŠ ä¸€ä¸ªarbiterã€‚æ‚¨ä¹Ÿå¯ä»¥å¯åŠ¨å…¶ä»–arbiterå¹¶å°†å…¶æ‰‹åŠ¨æ·»åŠ åˆ°å‰¯æœ¬é›† ä¾‹å¦‚: 1mlaunch --replicaset --nodes 2 --arbiter æ­¤å‘½ä»¤å¯åŠ¨2ä¸ªæ‰¿è½½æ•°æ®çš„mongodå®ä¾‹ï¼Œå¹¶å°†ä¸€ä¸ªarbiteræ·»åŠ åˆ°å‰¯æœ¬é›†ï¼Œæ€»å…±3ä¸ªæŠ•ç¥¨èŠ‚ç‚¹ã€‚ --name NAME æ­¤é€‰é¡¹ä½¿æ‚¨å¯ä»¥ä¿®æ”¹å‰¯æœ¬é›†çš„åç§°ã€‚è¿™å°†æ›´æ”¹dbpathçš„åç§°å’Œå­ç›®å½•ã€‚æ­¤é€‰é¡¹ä»…å…è®¸ç”¨äºå•ä¸ªå‰¯æœ¬é›†ï¼Œè€Œä¸é€‚ç”¨äºåˆ†ç‰‡è®¾ç½®ï¼ˆå‰¯æœ¬é›†åç§°ä¸åˆ†ç‰‡åç§°ç­‰æ•ˆï¼‰çš„åˆ†ç‰‡è®¾ç½®ä¸­ã€‚é»˜è®¤åç§°æ˜¯replset For example: 1mlaunch --replicaset --name &quot;my_rs_1&quot; æ­¤å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªåä¸ºmy_rs_1çš„å‰¯æœ¬é›†ï¼Œå¹¶å°†dbpathå’Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨åœ¨./data/my_rs_1ä¸‹ Sharding Parametersä»¥ä¸‹å‚æ•°ä¼šå½±å“åˆ†ç‰‡ç¯å¢ƒçš„è®¾ç½®ã€‚æ¯ä¸ªåˆ†ç‰‡å°†æ˜¯å…ˆå‰æŒ‡å®šè®¾ç½®çš„å‰¯æœ¬ï¼Œæ— è®ºæ˜¯å•ä¸ªå®ä¾‹è¿˜æ˜¯å‰¯æœ¬é›†ã€‚ --sharded S [S ...] å¦‚æœæŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™å¯ç”¨åˆ†ç‰‡ï¼Œå¹¶ä¸”mlaunchå°†åˆ›å»ºæŒ‡å®šæ•°é‡çš„åˆ†ç‰‡ï¼Œå¹¶å°†è¿™äº›åˆ†ç‰‡ä¸€èµ·æ·»åŠ åˆ°åˆ†ç‰‡ç¾¤é›†ä¸­ã€‚è¯¥å‚æ•°å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å·¥ä½œï¼šé€šè¿‡æŒ‡å®šå•ä¸ªæ•°å­—ï¼ˆå³åˆ†ç‰‡çš„æ•°é‡ï¼‰ï¼Œæˆ–é€šè¿‡æŒ‡å®šåˆ†ç‰‡çš„åç§°åˆ—è¡¨ã€‚ ä¾‹å¦‚: 1mlaunch --single --sharded 3 è¯¥å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªåŒ…å«3ä¸ªåˆ†ç‰‡çš„ç¯å¢ƒï¼Œæ¯ä¸ªåˆ†ç‰‡ç”±ä¸€ä¸ªç‹¬ç«‹èŠ‚ç‚¹ç»„æˆã€‚ç¢ç‰‡åç§°ä¸ºshard0001ï¼Œshard0002ï¼Œshard0003ã€‚å®ƒè¿˜å°†é»˜è®¤åˆ›å»º1ä¸ªé…ç½®æœåŠ¡å™¨å’Œ1ä¸ªmongos ä¾‹å¦‚: 1mlaunch --replicaset --sharded tic tac toe æ­¤å‘½ä»¤å°†åˆ›å»º3ä¸ªåˆ†ç‰‡ï¼Œåˆ†åˆ«åä¸ºticï¼Œtacå’Œtoe. æ¯ä¸ªåˆ†ç‰‡å°†åŒ…å«ä¸€ä¸ªå‰¯æœ¬é›†ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ä¸º3ä¸ªèŠ‚ç‚¹. å®ƒè¿˜å°†é»˜è®¤åˆ›å»º1ä¸ªé…ç½®æœåŠ¡å™¨å’Œ1ä¸ªmongos. --config N æ­¤å‚æ•°ç¡®å®šåœ¨åˆ†ç‰‡ç¯å¢ƒä¸­å¯åŠ¨äº†å¤šå°‘ä¸ªé…ç½®æœåŠ¡å™¨ã€‚é»˜è®¤æ•°å­—æ˜¯1ã€‚Nçš„å”¯ä¸€æœ‰æ•ˆé€‰é¡¹æ˜¯1æˆ–3 --csrs æ­¤å‚æ•°å¯å°†é…ç½®æœåŠ¡å™¨ç”¨ä½œå‰¯æœ¬é›†ï¼ˆCSRSï¼‰ï¼Œè€Œä¸æ˜¯è¾ƒæ—©çš„åŒæ­¥é›†ç¾¤è¿æ¥é…ç½®ï¼ˆSCCCï¼‰ MongoDB 3.2+æ”¯æŒCSRSéƒ¨ç½²é€‰é¡¹ï¼Œè€Œä»MongoDB 3.4å¼€å§‹ï¼Œé»˜è®¤ï¼ˆå”¯ä¸€ï¼‰æ”¯æŒçš„é€‰é¡¹æ˜¯CSRSéƒ¨ç½²é€‰é¡¹ã€‚ If you are using MongoDB 3.4 and greater, mlaunch will use CSRS by default. Changed in version 1.2.3 CSRS config servers will no longer include incompatible settings, such as: --storageEngine â€“ CSRS config servers will always use WiredTiger. --arbiter â€“ CSRS config servers cannot have any arbiter. --mongos N æ­¤å‚æ•°ç¡®å®šåœ¨åˆ†ç‰‡ç¯å¢ƒä¸­å¯åŠ¨äº†å¤šå°‘ä¸ªmongoså®ä¾‹ã€‚é»˜è®¤æ•°å­—ä¸º1ã€‚ä½¿ç”¨æ­¤è®¾ç½®ï¼Œé»˜è®¤å€¼å¯ä»¥æ›´æ”¹ä¸ºNä¸ªmongoså®ä¾‹ã€‚ Authentication Parameters --auth æ­¤å‚æ•°åœ¨æ‚¨çš„è®¾ç½®ä¸Šå¯ç”¨èº«ä»½éªŒè¯ã€‚å®ƒå¯ä»¥é€æ˜åœ°ç”¨äºå•ä¸ªå®ä¾‹ï¼ˆéœ€è¦--authï¼‰ä»¥åŠå‰¯æœ¬é›†å’Œåˆ†ç‰‡ç¯å¢ƒï¼ˆéœ€è¦--keyFileï¼‰ã€‚æ— éœ€å¦å¤–æŒ‡å®škeyfileï¼Œmlaunchå°†ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ªéšæœºkeyfileã€‚ ç”¨æˆ·åå’Œå¯†ç ä¹Ÿå°†è¢«è®¾ç½®ï¼Œæˆ–è€…åœ¨mongosä¸ºåˆ†ç‰‡çš„ç¯å¢ƒä¸­ï¼Œæˆ–å¯¹å‰¯æœ¬é›†ä¸»èŠ‚ç‚¹æˆ–åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ A username and password will also be set up, either on the mongos for sharded environments, or on the primary node for replica sets or on a single node. --username æ­¤å‚æ•°å°†é»˜è®¤ç”¨æˆ·åç”¨æˆ·æ›´æ”¹ä¸ºæŒ‡å®šç”¨æˆ· --password æ­¤å‚æ•°å°†é»˜è®¤å¯†ç passwordæ›´æ”¹ä¸ºæŒ‡å®šçš„å¯†ç  --auth-db æ­¤å‚æ•°ä»adminæ›´æ”¹é»˜è®¤æ•°æ®åº“ï¼Œå°†åœ¨å…¶ä¸­åˆ›å»ºç”¨æˆ·ã€‚(ä¸è¦æ”¹è¿™ä¸ªå‚æ•°é»˜è®¤å€¼) é»˜è®¤å¯†ç æ˜¯æ•…æ„åœ¨é€‰æ‹©æ˜“äºè®°å¿†æˆ–çŒœæµ‹ã€‚ mlaunchæ˜¯ä¸ºæµ‹è¯•å’Œé—®é¢˜å†ç°ï¼Œè€Œä¸æ˜¯ç”¨äºç”Ÿäº§ã€‚ å› ä¸ºç”¨æˆ·åå’Œå¯†ç éƒ½ä»¥æ˜æ–‡å½¢å¼åŒ…å«åœ¨data/.mlaunch_startupæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å³ä½¿æ˜¯å¼ºå¯†ç ä¹Ÿæ— æ³•ä¿è¯åœ¨mlaunchç”Ÿæˆçš„ç¯å¢ƒä¸­çš„å®‰å…¨æ€§ã€‚ --auth-roles This parameter changes the initial default roles that the user will receive. The default roles are dbAdminAnyDatabase, readWriteAnyDatabase, userAdminAnyDatabase and clusterAdmin. You can provide different roles with this parameter, separated by spaces. If you change the default roles, it may not be possible for mlaunch to execute certain commands due to missing privileges. This may lead to unexpected behavior for some mlaunch operations, like for example mlaunch stop, which uses the internal shutdown command. If this is the case, use mlaunch kill instead. ä¾‹å¦‚: 1mlaunch --sharded 2 --single --auth --auth-user thomas --auth-password my_s3cr3t_p4ssw0rd This command would start a sharded cluster with 2 single shards, 1 config server, 1 mongos, and create the user thomas with password my_s3cr3t_p4ssw0rd. It will use the default roles and place the user in the admin database. mlaunch will Optional Parameters --port PORT ä½¿ç”¨æŒ‡å®šçš„PORTå€¼ä½œä¸ºç¬¬ä¸€ä¸ªå®ä¾‹çš„èµ·å§‹ç«¯å£å·ï¼Œå…¶ä½™å®ä¾‹ï¼ˆmongod / mongosï¼‰ä»¥PORTå€¼é€’å¢ä½œä¸ºè‡ªå·±çš„ç®—å£å·ä½¿ç”¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒMongoDBèµ·å§‹ç«¯å£å€¼ä¸ºæ ‡å‡†ç«¯å£27017ã€‚ä½¿ç”¨æ­¤å‚æ•°å¯ä»¥åœ¨ä¸åŒç«¯å£èŒƒå›´ä¸Šå¹¶è¡Œå¯åŠ¨å¤šä¸ªè®¾ç½®ã€‚ ä¾‹å¦‚: 1mlaunch --replicaset --nodes 3 --port 30000 æ­¤å‘½ä»¤å°†ä½¿ç”¨ç«¯å£30000ã€30001å’Œ30002å¯åŠ¨3ä¸ªèŠ‚ç‚¹çš„å‰¯æœ¬é›†ã€‚ --binarypath PATH å°†è®¾ç½®mlaunchåœ¨å…¶ä¸­æŸ¥æ‰¾mongodå’Œmongosçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„åˆ°æä¾›çš„PATHã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ$PATHç¯å¢ƒå˜é‡ç”¨äºç¡®å®šå¯åŠ¨å“ªä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹è¦†ç›–é»˜è®¤è®¾ç½®ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ç¼–è¯‘è‡ªå·±çš„æºä»£ç å¹¶å¸Œæœ›mlaunchä½¿ç”¨å·²ç¼–è¯‘çš„ç‰ˆæœ¬ï¼Œåˆ™è¿™å¾ˆæœ‰ç”¨ã€‚ ä¾‹å¦‚ï¼š 1mlaunch --single --binarypath ./build/bin æ­¤å‘½ä»¤å°†åœ¨./build/bin/mongodä¸­æŸ¥æ‰¾mongodäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œä¸æ˜¯é»˜è®¤ä½ç½®ã€‚ killé€šè¿‡å‘é€SIGTERM(15)ä¿¡å·ï¼Œkillå‘½ä»¤æ ¹æ®æŒ‡å®šçš„æ ‡ç­¾åœæ­¢å½“å‰ç¯å¢ƒä¸­çš„éƒ¨åˆ†æˆ–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹ã€‚ å¦‚æœæœªæŒ‡å®šæ ‡ç­¾ï¼Œåˆ™mlaunch killå°†æ€æ­»æ‰€æœ‰èŠ‚ç‚¹ã€‚ å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œåˆ™mlaunch killå°†ä»…æ€æ­»å…·æœ‰æ‰€æœ‰ç»™å®šæ ‡ç­¾ï¼ˆè®¾ç½®äº¤é›†ï¼‰çš„èŠ‚ç‚¹ã€‚ å³ä½¿æ²¡æœ‰å…·æœ‰clusterAdminè§’è‰²çš„ç®¡ç†å‘˜ç”¨æˆ·ï¼Œæ­¤æ–¹æ³•ä¹Ÿæœ‰æ•ˆã€‚ å¯ä»¥ä½¿ç”¨--signalå‚æ•°æ¥æŒ‡å®šå…¶ä»–ä¿¡å·ï¼Œè€Œä¸æ˜¯SIGTERMä¿¡å·ã€‚ ï¼ˆåœ¨Windowsä¸Šä¸å¯ç”¨ï¼‰ Usage1mlaunch kill [TAG [TAG ...]] [--signal S] [--dir DIR] [--verbose] Tag ParametersThe following tags are used with mlaunch, although not all tags are present in every environment: all: å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ running: å½“å‰æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹ down: æ‰€æœ‰å…³é—­çš„èŠ‚ç‚¹ mongos: æ‰€æœ‰mongosè¿›ç¨‹ mongod: æ‰€æœ‰mongodè¿›ç¨‹(åŒ…æ‹¬arbiterså’Œconfig servers). config: æ‰€æœ‰config servers shard: è¯¥æ ‡ç­¾ä»…ç”¨äºæ ‡è¯†ç‰¹å®šçš„åˆ†ç‰‡å·ï¼ˆè¯·å‚è§ä¸‹æ–‡ï¼‰ &lt;shard name&gt;: å¯¹äºåˆ†ç‰‡ç¯å¢ƒï¼Œåˆ†ç‰‡çš„æ¯ä¸ªæˆå‘˜éƒ½å°†åˆ†ç‰‡åç§°ä½œä¸ºæ ‡ç­¾ï¼Œä¾‹å¦‚â€œshard-aâ€ primary: æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä¸»èŠ‚ç‚¹ secondary: æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„secondaryèŠ‚ç‚¹ arbiter: æ‰€æœ‰arbiter &lt;port number&gt;: æ¯ä¸ªèŠ‚ç‚¹éƒ½å°†å…¶ç«¯å£å·ä½œä¸ºæ ‡è®° å¦‚æœä¸ºkillå‘½ä»¤æŒ‡å®šå•ä¸ªæ ‡ç­¾ï¼Œåˆ™åŒ¹é…è¯¥æ ‡ç­¾çš„èŠ‚ç‚¹å°†è¢«æ€æ­»ã€‚ å¦‚æœæŒ‡å®šäº†å¤šä¸ªæ ‡ç­¾ï¼Œåˆ™ä»…æ€æ­»ä¸æ‰€æœ‰æ ‡ç­¾åŒ¹é…çš„èŠ‚ç‚¹ã€‚ æ¯ä¸ªæ ‡ç­¾éƒ½ä¼šè¿›ä¸€æ­¥ç¼©å°åŒ¹é…èŒƒå›´ã€‚(è²Œä¼¼æ„æ€æ˜¯å–è¿ä¸ªæ ‡ç­¾çš„äº¤é›†) ä¾‹: 1mlaunch kill è¯¥å‘½ä»¤å°†æ€æ­»å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹ã€‚ ä¾‹: 1mlaunch kill mongos è¯¥å‘½ä»¤å°†æ€æ­»å½“å‰ç¯å¢ƒä¸­æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„mongosè¿›ç¨‹ ä¾‹: 1mlaunch kill shard-a secondary è¯¥å‘½ä»¤å°†æ€æ­»å½“å‰ç¯å¢ƒä¸­åä¸ºâ€œ shard-aâ€çš„æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„secondaryèŠ‚ç‚¹ã€‚ ä¾‹: 1mlaunch kill config primary è¯¥å‘½ä»¤ä¸ä¼šæ€æ­»ä»»ä½•èŠ‚ç‚¹ï¼Œå› ä¸ºæ²¡æœ‰èŠ‚ç‚¹åŒæ—¶å…·æœ‰configå’Œprimaryæ ‡ç­¾ã€‚ ä¾‹: 1mlaunch kill 27017 æ­¤å‘½ä»¤å°†æ€æ­»åœ¨ç«¯å£27017ä¸Šè¿è¡Œçš„èŠ‚ç‚¹ã€‚ å¦å¤–ï¼ŒæŸäº›æ ‡ç­¾å¯ä»¥ä¸åç»­ç¼–å·ç»„åˆã€‚ è¿™äº›æ ‡ç­¾æ˜¯ï¼šmongosï¼Œshardï¼Œconfigï¼Œsecondaryã€‚ ä¾‹: 1mlaunch kill shard 1 This command kills all members of shard 1 in the current sharded environment. ä¾‹: 1mlaunch kill shard 2 primary This command kills the primary of the second shard in the current sharded environment. ä¾‹: 1mlaunch kill secondary 1 This command kills the first secondary node of all shards if the environment is sharded. If the environment is a replicaset, it only applies to the first secondary. å¦‚æœæ˜¯shard, killæ‰€æœ‰sharedçš„ç¬¬ä¸€ä¸ªsecondaryèŠ‚ç‚¹. å¦‚æœæ˜¯replicaset, åªkillç¬¬ä¸€ä¸ªsecondary ä¾‹: 1mlaunch kill è¯¥å‘½ä»¤å°†ä¿¡å·SIGTERMï¼ˆ15ï¼‰å‘é€åˆ°å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚ ä¾‹: 1mlaunch kill --signal SIGUSR1 æ­¤å‘½ä»¤å°†ä¿¡å·SIGUSR1ï¼ˆ30ï¼‰å‘é€åˆ°å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œè¿™åœ¨MongoDBä¸­å¯¼è‡´æ—¥å¿—è½®æ¢log rotationã€‚ startstartå‘½ä»¤æ ¹æ®æŒ‡å®šçš„æ ‡ç­¾å¯åŠ¨å½“å‰ç¯å¢ƒä¸­å½“å‰å¤„äºå…³é—­çŠ¶æ€çš„æŸäº›æˆ–æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦‚æœæœªæŒ‡å®šæ ‡ç­¾ï¼Œåˆ™mlaunch startå°†å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œåˆ™å¯åŠ¨å°†ä»…å¯åŠ¨å…·æœ‰æ‰€æœ‰ç»™å®šæ ‡ç­¾çš„èŠ‚ç‚¹ï¼ˆè®¾ç½®äº¤é›†ï¼‰ã€‚ Usage1mlaunch start [TAG [TAG ...]] [--dir DIR] [--verbose] Tag ParametersThe following tags are used with mlaunch, although not all tags are present in every environment: all: å½“å‰ç¯å¢ƒä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ running: å½“å‰æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹ down: æ‰€æœ‰å…³é—­çš„èŠ‚ç‚¹ mongos: æ‰€æœ‰mongosè¿›ç¨‹ mongod: æ‰€æœ‰mongodè¿›ç¨‹(åŒ…æ‹¬arbiterså’Œconfig servers). config: æ‰€æœ‰config servers shard: è¯¥æ ‡ç­¾ä»…ç”¨äºæ ‡è¯†ç‰¹å®šçš„åˆ†ç‰‡å·ï¼ˆè¯·å‚è§ä¸‹æ–‡ï¼‰ &lt;shard name&gt;: å¯¹äºåˆ†ç‰‡ç¯å¢ƒï¼Œåˆ†ç‰‡çš„æ¯ä¸ªæˆå‘˜éƒ½å°†åˆ†ç‰‡åç§°ä½œä¸ºæ ‡ç­¾ï¼Œä¾‹å¦‚â€œshard-aâ€ arbiter: æ‰€æœ‰arbiter &lt;port number&gt;: æ¯ä¸ªèŠ‚ç‚¹éƒ½å°†å…¶ç«¯å£å·ä½œä¸ºæ ‡è®° Different to the stop command, there tags for primary and secondary are not available for the start command. This is because the replica set state of a running node is undetermined. stopstopå‘½ä»¤é€šè¿‡å°†shutdownå‘½ä»¤å‘é€åˆ°mongodæˆ–mongoså®ä¾‹æ¥åœæ­¢å½“å‰ç¯å¢ƒä¸­æŸäº›æˆ–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹ï¼ˆå–å†³äºæŒ‡å®šçš„æ ‡ç­¾ï¼‰ã€‚ å¦‚æœæœªæŒ‡å®šæ ‡ç­¾ï¼Œåˆ™mlaunch stopå°†åœæ­¢æ‰€æœ‰èŠ‚ç‚¹ã€‚ å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œåˆ™mlaunch stopå°†ä»…åœæ­¢å…·æœ‰æ‰€æœ‰ç»™å®šæ ‡ç­¾çš„èŠ‚ç‚¹ï¼ˆè®¾ç½®äº¤é›†ï¼‰ã€‚ åœ¨ç»è¿‡èº«ä»½éªŒè¯çš„ç¯å¢ƒä¸­ï¼Œstopå‘½ä»¤è¦æ±‚ç®¡ç†å‘˜æ•°æ®åº“ä¸­çš„ç”¨æˆ·å…·æœ‰clusterAdminè§’è‰²ã€‚ å¦åˆ™ï¼Œåœæ­¢å‘½ä»¤å°†ä¸ä¼šæˆåŠŸã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ”¹ç”¨killå‘½ä»¤ã€‚ Changed in version 1.2.3 As of version 1.2.3, the stop command is an alias for the kill command. Usage1mlaunch stop [TAG [TAG ...]] [--dir DIR] [--verbose] Tag ParametersThe tags for the stop command are the same as for kill. restartrestartå‘½ä»¤å°†åœæ­¢ï¼Œç„¶åé‡æ–°å¯åŠ¨å½“å‰ç¯å¢ƒä¸­çš„æŸäº›æˆ–æ‰€æœ‰èŠ‚ç‚¹ï¼Œå…·ä½“å–å†³äºæŒ‡å®šçš„æ ‡ç­¾ã€‚ ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæ·»åŠ äº†å®ƒï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºè¿ç»­çš„åœæ­¢å’Œå¯åŠ¨å‘½ä»¤ã€‚ å¦‚æœæœªæŒ‡å®šæ ‡ç­¾ï¼Œåˆ™mlaunch restartå°†é‡æ–°å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹ã€‚ å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œåˆ™mlaunch restartå°†ä»…é‡æ–°å¯åŠ¨å…·æœ‰æ‰€æœ‰ç»™å®šæ ‡ç­¾çš„èŠ‚ç‚¹ï¼ˆè®¾ç½®äº¤é›†ï¼‰ã€‚ Usage1mlaunch restart [TAG [TAG ...]] [--dir DIR] [--verbose] Tag ParametersSee start and stop. listlistå‘½ä»¤æ˜¾ç¤ºå½“å‰ç¯å¢ƒä¸­æ‰€æœ‰èŠ‚ç‚¹çš„æ¦‚è¿°ï¼Œä»¥åŠå®ƒä»¬çš„çŠ¶æ€ï¼ˆè¿è¡Œ/å…³é—­ï¼‰å’Œç«¯å£ã€‚ ä½¿ç”¨å¯é€‰çš„â€“verboseæ ‡å¿—ï¼Œlistå‘½ä»¤è¿˜æ˜¾ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰æ ‡ç­¾ã€‚ Usage1mlaunch list [--dir DIR] [--startup] [--tags] For example: 1234567891011121314151617181920mlaunch listPROCESS STATUS PORTmongos running 27017mongos running 27018config server running 27025config server running 27026config server down 27027shard01 primary running 27019 secondary running 27020 arbiter running 27021shard02 mongod down 27022 mongod down 27023 mongod down 27024 æ­¤å‘½ä»¤æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„åˆ—è¡¨ï¼Œå®ƒä»¬çš„çŠ¶æ€å’Œç«¯å£å·ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¯å¢ƒç”±ä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–ï¼š 1mlaunch --sharded 2 --replicaset --nodes 2 --arbiter --config 3 --mongos 2 Optional Parameters --tags æ­¤é€‰é¡¹è¿˜æ˜¾ç¤ºä¸€åˆ—ï¼Œå…¶ä¸­åŒ…å«å®ä¾‹å¯ä»¥ä½¿ç”¨çš„æ‰€æœ‰æ ‡ç­¾ã€‚ æ ‡ç­¾å¯ç”¨äºå°†æŸäº›å®ä¾‹ä½œä¸ºå¯åŠ¨ï¼Œåœæ­¢ï¼Œç»ˆæ­¢ç­‰å‘½ä»¤çš„ç›®æ ‡ã€‚ For example: 1234567mlaunch list --tagsPROCESS STATUS PORT TAGSprimary running 27017 27017, all, mongod, primary, runningsecondary running 27018 27018, all, mongod, running, secondarymongod down 27019 27019, all, down, mongod è¯¥å‘½ä»¤æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„åˆ—è¡¨ï¼Œå®ƒä»¬çš„çŠ¶æ€å’Œç«¯å£å·ï¼Œä»¥åŠå®ƒä»¬çš„æ ‡ç­¾ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¯å¢ƒç”±ä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–ï¼š 1mlaunch --replicaset --startup æ­¤é€‰é¡¹è¿˜æ˜¾ç¤ºå¸¦æœ‰å¯åŠ¨å‘½ä»¤çš„åˆ—ï¼Œè¯¥å¯åŠ¨å‘½ä»¤ç”¨äºè¿è¡Œç»™å®šå®ä¾‹ã€‚ å¦‚æœéœ€è¦æ‰‹åŠ¨å¯åŠ¨å®ä¾‹ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚ For example: 1234567mlaunch list --startupPROCESS PORT STATUS PID STARTUP COMMANDsecondary 27017 running 4264 mongod --replSet replset --dbpath /tmp/data/replset/rs1/db --logpath /tmp/data/replset/rs1/mongod.log --port 27017 --logappend --fork -vvmongod 27018 running 4267 mongod --replSet replset --dbpath /tmp/data/replset/rs2/db --logpath /tmp/data/replset/rs2/mongod.log --port 27018 --logappend --fork -vvmongod 27019 running 4270 mongod --replSet replset --dbpath /tmp/data/replset/rs3/db --logpath /tmp/data/replset/rs3/mongod.log --port 27019 --logappend --fork -vv æ­¤å‘½ä»¤æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„åˆ—è¡¨ï¼Œå®ƒä»¬çš„çŠ¶æ€å’Œç«¯å£å·ï¼Œä»¥åŠå®ƒä»¬çš„å¯åŠ¨å‘½ä»¤ã€‚","categories":[],"tags":[{"name":"MongoDB","slug":"MongoDB","permalink":"http://fuxkdb.com/tags/MongoDB/"},{"name":"mtools","slug":"mtools","permalink":"http://fuxkdb.com/tags/mtools/"}]},{"title":"Canal dynamicTopicé—®é¢˜","slug":"2020-01-12-Canal-dynamicTopicé—®é¢˜","date":"2020-01-12T04:23:00.000Z","updated":"2020-03-07T13:21:57.359Z","comments":true,"path":"2020/01/12/2020-01-12-Canal-dynamicTopicé—®é¢˜/","link":"","permalink":"http://fuxkdb.com/2020/01/12/2020-01-12-Canal-dynamicTopic%E9%97%AE%E9%A2%98/","excerpt":"æœªæ¥åŒäº‹è·‘äº†å‡ ä¸ªæœˆçš„canalçªç„¶æŠ¥ä¸‹é¢çš„é”™, ä½¿ç”¨äº†dynamicTopic. å…¶å®æˆ‘æ²¡æœ‰ç”¨è¿‡dynamicTopic, åªèƒ½æœä¸€æœissue å…³äºdynamicTopicå’ŒpartitionHashçš„è¯´æ˜ canal.mq.dynamicTopic è¡¨è¾¾å¼è¯´æ˜12345678910111213141516&gt;canal 1.1.3ç‰ˆæœ¬ä¹‹å, æ”¯æŒé…ç½®æ ¼å¼ï¼šschema æˆ– schema.tableï¼Œå¤šä¸ªé…ç½®ä¹‹é—´ä½¿ç”¨é€—å·æˆ–åˆ†å·åˆ†éš”&gt;ä¾‹å­1ï¼štest\\\\.test æŒ‡å®šåŒ¹é…çš„å•è¡¨ï¼Œå‘é€åˆ°ä»¥test_testä¸ºåå­—çš„topicä¸Š&gt;ä¾‹å­2ï¼š.*\\\\..* åŒ¹é…æ‰€æœ‰è¡¨ï¼Œåˆ™æ¯ä¸ªè¡¨éƒ½ä¼šå‘é€åˆ°å„è‡ªè¡¨åçš„topicä¸Š&gt;ä¾‹å­3ï¼štest æŒ‡å®šåŒ¹é…å¯¹åº”çš„åº“ï¼Œä¸€ä¸ªåº“çš„æ‰€æœ‰è¡¨éƒ½ä¼šå‘é€åˆ°åº“åçš„topicä¸Š&gt;ä¾‹å­4ï¼štest\\\\.* æŒ‡å®šåŒ¹é…çš„è¡¨è¾¾å¼ï¼Œé’ˆå¯¹åŒ¹é…çš„è¡¨ä¼šå‘é€åˆ°å„è‡ªè¡¨åçš„topicä¸Š&gt;ä¾‹å­5ï¼štest,test1\\\\.test1ï¼ŒæŒ‡å®šå¤šä¸ªè¡¨è¾¾å¼ï¼Œä¼šå°†teståº“çš„è¡¨éƒ½å‘é€åˆ°testçš„topicä¸Šï¼Œtest1\\\\.test1çš„è¡¨å‘é€åˆ°å¯¹åº”çš„test1_test1 topicä¸Šï¼Œå…¶ä½™çš„è¡¨å‘é€åˆ°é»˜è®¤çš„canal.mq.topicå€¼&gt;ä¸ºæ»¡è¶³æ›´å¤§çš„çµæ´»æ€§ï¼Œå…è®¸å¯¹åŒ¹é…æ¡ä»¶çš„è§„åˆ™æŒ‡å®šå‘é€çš„topicåå­—ï¼Œé…ç½®æ ¼å¼ï¼štopicName:schema æˆ– topicName:schema.table&gt;ä¾‹å­1: test:test\\\\.test æŒ‡å®šåŒ¹é…çš„å•è¡¨ï¼Œå‘é€åˆ°ä»¥testä¸ºåå­—çš„topicä¸Š&gt;ä¾‹å­2: test:.*\\\\..* åŒ¹é…æ‰€æœ‰è¡¨ï¼Œå› ä¸ºæœ‰æŒ‡å®štopicï¼Œåˆ™æ¯ä¸ªè¡¨éƒ½ä¼šå‘é€åˆ°testçš„topicä¸‹&gt;ä¾‹å­3: test:test æŒ‡å®šåŒ¹é…å¯¹åº”çš„åº“ï¼Œä¸€ä¸ªåº“çš„æ‰€æœ‰è¡¨éƒ½ä¼šå‘é€åˆ°testçš„topicä¸‹&gt;ä¾‹å­4ï¼štestA:test\\\\.* æŒ‡å®šåŒ¹é…çš„è¡¨è¾¾å¼ï¼Œé’ˆå¯¹åŒ¹é…çš„è¡¨ä¼šå‘é€åˆ°testAçš„topicä¸‹&gt;ä¾‹å­5ï¼štest0:test,test1:test1\\\\.test1ï¼ŒæŒ‡å®šå¤šä¸ªè¡¨è¾¾å¼ï¼Œä¼šå°†teståº“çš„è¡¨éƒ½å‘é€åˆ°test0çš„topicä¸‹ï¼Œtest1\\\\.test1çš„è¡¨å‘é€åˆ°å¯¹åº”çš„test1çš„topicä¸‹ï¼Œå…¶ä½™çš„è¡¨å‘é€åˆ°é»˜è®¤çš„canal.mq.topicå€¼&gt;å¤§å®¶å¯ä»¥ç»“åˆè‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®¾ç½®åŒ¹é…è§„åˆ™ï¼Œå»ºè®®MQå¼€å¯è‡ªåŠ¨åˆ›å»ºtopicçš„èƒ½åŠ› canal.mq.partitionHash è¡¨è¾¾å¼è¯´æ˜123456789&gt;canal 1.1.3ç‰ˆæœ¬ä¹‹å, æ”¯æŒé…ç½®æ ¼å¼ï¼šschema.table:pk1^pk2ï¼Œå¤šä¸ªé…ç½®ä¹‹é—´ä½¿ç”¨é€—å·åˆ†éš”&gt;ä¾‹å­1ï¼štest\\\\.test:pk1^pk2 æŒ‡å®šåŒ¹é…çš„å•è¡¨ï¼Œå¯¹åº”çš„hashå­—æ®µä¸ºpk1 + pk2&gt;ä¾‹å­2ï¼š.*\\\\..*:id æ­£åˆ™åŒ¹é…ï¼ŒæŒ‡å®šæ‰€æœ‰æ­£åˆ™åŒ¹é…çš„è¡¨å¯¹åº”çš„hashå­—æ®µä¸ºid&gt;ä¾‹å­3ï¼š.*\\\\..*:$pk$ æ­£åˆ™åŒ¹é…ï¼ŒæŒ‡å®šæ‰€æœ‰æ­£åˆ™åŒ¹é…çš„è¡¨å¯¹åº”çš„hashå­—æ®µä¸ºè¡¨ä¸»é”®(è‡ªåŠ¨æŸ¥æ‰¾)&gt;ä¾‹å­4: åŒ¹é…è§„åˆ™å•¥éƒ½ä¸å†™ï¼Œåˆ™é»˜è®¤å‘åˆ°0è¿™ä¸ªpartitionä¸Š&gt;ä¾‹å­5ï¼š.*\\\\..* ï¼Œä¸æŒ‡å®špkä¿¡æ¯çš„æ­£åˆ™åŒ¹é…ï¼Œå°†æ‰€æœ‰æ­£åˆ™åŒ¹é…çš„è¡¨,å¯¹åº”çš„hashå­—æ®µä¸ºè¡¨å&gt;æŒ‰è¡¨hash: ä¸€å¼ è¡¨çš„æ‰€æœ‰æ•°æ®å¯ä»¥å‘åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œä¸åŒè¡¨ä¹‹é—´ä¼šåšæ•£åˆ— (ä¼šæœ‰çƒ­ç‚¹è¡¨åˆ†åŒºè¿‡å¤§é—®é¢˜)&gt;ä¾‹å­6: test\\\\.test:id,.\\\\..* , é’ˆå¯¹testçš„è¡¨æŒ‰ç…§idæ•£åˆ—,å…¶ä½™çš„è¡¨æŒ‰ç…§tableæ•£åˆ— æ³¨æ„ï¼šå¤§å®¶å¯ä»¥ç»“åˆè‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®¾ç½®åŒ¹é…è§„åˆ™ï¼Œå¤šæ¡åŒ¹é…è§„åˆ™ä¹‹é—´æ˜¯æŒ‰ç…§é¡ºåºè¿›è¡ŒåŒ¹é…(å‘½ä¸­ä¸€æ¡è§„åˆ™å°±è¿”å›) å…¶ä»–è¯¦ç»†å‚æ•°å¯å‚è€ƒCanal AdminGuide","text":"æœªæ¥åŒäº‹è·‘äº†å‡ ä¸ªæœˆçš„canalçªç„¶æŠ¥ä¸‹é¢çš„é”™, ä½¿ç”¨äº†dynamicTopic. å…¶å®æˆ‘æ²¡æœ‰ç”¨è¿‡dynamicTopic, åªèƒ½æœä¸€æœissue å…³äºdynamicTopicå’ŒpartitionHashçš„è¯´æ˜ canal.mq.dynamicTopic è¡¨è¾¾å¼è¯´æ˜12345678910111213141516&gt;canal 1.1.3ç‰ˆæœ¬ä¹‹å, æ”¯æŒé…ç½®æ ¼å¼ï¼šschema æˆ– schema.tableï¼Œå¤šä¸ªé…ç½®ä¹‹é—´ä½¿ç”¨é€—å·æˆ–åˆ†å·åˆ†éš”&gt;ä¾‹å­1ï¼štest\\\\.test æŒ‡å®šåŒ¹é…çš„å•è¡¨ï¼Œå‘é€åˆ°ä»¥test_testä¸ºåå­—çš„topicä¸Š&gt;ä¾‹å­2ï¼š.*\\\\..* åŒ¹é…æ‰€æœ‰è¡¨ï¼Œåˆ™æ¯ä¸ªè¡¨éƒ½ä¼šå‘é€åˆ°å„è‡ªè¡¨åçš„topicä¸Š&gt;ä¾‹å­3ï¼štest æŒ‡å®šåŒ¹é…å¯¹åº”çš„åº“ï¼Œä¸€ä¸ªåº“çš„æ‰€æœ‰è¡¨éƒ½ä¼šå‘é€åˆ°åº“åçš„topicä¸Š&gt;ä¾‹å­4ï¼štest\\\\.* æŒ‡å®šåŒ¹é…çš„è¡¨è¾¾å¼ï¼Œé’ˆå¯¹åŒ¹é…çš„è¡¨ä¼šå‘é€åˆ°å„è‡ªè¡¨åçš„topicä¸Š&gt;ä¾‹å­5ï¼štest,test1\\\\.test1ï¼ŒæŒ‡å®šå¤šä¸ªè¡¨è¾¾å¼ï¼Œä¼šå°†teståº“çš„è¡¨éƒ½å‘é€åˆ°testçš„topicä¸Šï¼Œtest1\\\\.test1çš„è¡¨å‘é€åˆ°å¯¹åº”çš„test1_test1 topicä¸Šï¼Œå…¶ä½™çš„è¡¨å‘é€åˆ°é»˜è®¤çš„canal.mq.topicå€¼&gt;ä¸ºæ»¡è¶³æ›´å¤§çš„çµæ´»æ€§ï¼Œå…è®¸å¯¹åŒ¹é…æ¡ä»¶çš„è§„åˆ™æŒ‡å®šå‘é€çš„topicåå­—ï¼Œé…ç½®æ ¼å¼ï¼štopicName:schema æˆ– topicName:schema.table&gt;ä¾‹å­1: test:test\\\\.test æŒ‡å®šåŒ¹é…çš„å•è¡¨ï¼Œå‘é€åˆ°ä»¥testä¸ºåå­—çš„topicä¸Š&gt;ä¾‹å­2: test:.*\\\\..* åŒ¹é…æ‰€æœ‰è¡¨ï¼Œå› ä¸ºæœ‰æŒ‡å®štopicï¼Œåˆ™æ¯ä¸ªè¡¨éƒ½ä¼šå‘é€åˆ°testçš„topicä¸‹&gt;ä¾‹å­3: test:test æŒ‡å®šåŒ¹é…å¯¹åº”çš„åº“ï¼Œä¸€ä¸ªåº“çš„æ‰€æœ‰è¡¨éƒ½ä¼šå‘é€åˆ°testçš„topicä¸‹&gt;ä¾‹å­4ï¼štestA:test\\\\.* æŒ‡å®šåŒ¹é…çš„è¡¨è¾¾å¼ï¼Œé’ˆå¯¹åŒ¹é…çš„è¡¨ä¼šå‘é€åˆ°testAçš„topicä¸‹&gt;ä¾‹å­5ï¼štest0:test,test1:test1\\\\.test1ï¼ŒæŒ‡å®šå¤šä¸ªè¡¨è¾¾å¼ï¼Œä¼šå°†teståº“çš„è¡¨éƒ½å‘é€åˆ°test0çš„topicä¸‹ï¼Œtest1\\\\.test1çš„è¡¨å‘é€åˆ°å¯¹åº”çš„test1çš„topicä¸‹ï¼Œå…¶ä½™çš„è¡¨å‘é€åˆ°é»˜è®¤çš„canal.mq.topicå€¼&gt;å¤§å®¶å¯ä»¥ç»“åˆè‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®¾ç½®åŒ¹é…è§„åˆ™ï¼Œå»ºè®®MQå¼€å¯è‡ªåŠ¨åˆ›å»ºtopicçš„èƒ½åŠ› canal.mq.partitionHash è¡¨è¾¾å¼è¯´æ˜123456789&gt;canal 1.1.3ç‰ˆæœ¬ä¹‹å, æ”¯æŒé…ç½®æ ¼å¼ï¼šschema.table:pk1^pk2ï¼Œå¤šä¸ªé…ç½®ä¹‹é—´ä½¿ç”¨é€—å·åˆ†éš”&gt;ä¾‹å­1ï¼štest\\\\.test:pk1^pk2 æŒ‡å®šåŒ¹é…çš„å•è¡¨ï¼Œå¯¹åº”çš„hashå­—æ®µä¸ºpk1 + pk2&gt;ä¾‹å­2ï¼š.*\\\\..*:id æ­£åˆ™åŒ¹é…ï¼ŒæŒ‡å®šæ‰€æœ‰æ­£åˆ™åŒ¹é…çš„è¡¨å¯¹åº”çš„hashå­—æ®µä¸ºid&gt;ä¾‹å­3ï¼š.*\\\\..*:$pk$ æ­£åˆ™åŒ¹é…ï¼ŒæŒ‡å®šæ‰€æœ‰æ­£åˆ™åŒ¹é…çš„è¡¨å¯¹åº”çš„hashå­—æ®µä¸ºè¡¨ä¸»é”®(è‡ªåŠ¨æŸ¥æ‰¾)&gt;ä¾‹å­4: åŒ¹é…è§„åˆ™å•¥éƒ½ä¸å†™ï¼Œåˆ™é»˜è®¤å‘åˆ°0è¿™ä¸ªpartitionä¸Š&gt;ä¾‹å­5ï¼š.*\\\\..* ï¼Œä¸æŒ‡å®špkä¿¡æ¯çš„æ­£åˆ™åŒ¹é…ï¼Œå°†æ‰€æœ‰æ­£åˆ™åŒ¹é…çš„è¡¨,å¯¹åº”çš„hashå­—æ®µä¸ºè¡¨å&gt;æŒ‰è¡¨hash: ä¸€å¼ è¡¨çš„æ‰€æœ‰æ•°æ®å¯ä»¥å‘åˆ°åŒä¸€ä¸ªåˆ†åŒºï¼Œä¸åŒè¡¨ä¹‹é—´ä¼šåšæ•£åˆ— (ä¼šæœ‰çƒ­ç‚¹è¡¨åˆ†åŒºè¿‡å¤§é—®é¢˜)&gt;ä¾‹å­6: test\\\\.test:id,.\\\\..* , é’ˆå¯¹testçš„è¡¨æŒ‰ç…§idæ•£åˆ—,å…¶ä½™çš„è¡¨æŒ‰ç…§tableæ•£åˆ— æ³¨æ„ï¼šå¤§å®¶å¯ä»¥ç»“åˆè‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®¾ç½®åŒ¹é…è§„åˆ™ï¼Œå¤šæ¡åŒ¹é…è§„åˆ™ä¹‹é—´æ˜¯æŒ‰ç…§é¡ºåºè¿›è¡ŒåŒ¹é…(å‘½ä¸­ä¸€æ¡è§„åˆ™å°±è¿”å›) å…¶ä»–è¯¦ç»†å‚æ•°å¯å‚è€ƒCanal AdminGuide canal.logæŠ¥INVALID_TOPIC_EXCEPTION 12345672020-01-10 15:58:31.552 [canal-instance-scan-0] INFO com.alibaba.otter.canal.deployer.CanalController - auto notify start example successful.2020-01-10 16:37:26.946 [canal-instance-scan-0] INFO com.alibaba.otter.canal.deployer.CanalController - auto notify start mgr_fanboshi successful.2020-01-10 16:38:03.992 [kafka-producer-network-thread | producer-1] WARN org.apache.kafka.clients.NetworkClient - [Producer clientId=producer-1] Error while fetching metadata with correlation id 10 : &#123;=INVALID_TOPIC_EXCEPTION&#125;2020-01-10 16:38:04.096 [kafka-producer-network-thread | producer-1] WARN org.apache.kafka.clients.NetworkClient - [Producer clientId=producer-1] Error while fetching metadata with correlation id 11 : &#123;=INVALID_TOPIC_EXCEPTION&#125;2020-01-10 16:38:04.200 [kafka-producer-network-thread | producer-1] WARN org.apache.kafka.clients.NetworkClient - [Producer clientId=producer-1] Error while fetching metadata with correlation id 12 : &#123;=INVALID_TOPIC_EXCEPTION&#125;2020-01-10 16:38:04.304 [kafka-producer-network-thread | producer-1] WARN org.apache.kafka.clients.NetworkClient - [Producer clientId=producer-1] Error while fetching metadata with correlation id 13 : &#123;=INVALID_TOPIC_EXCEPTION&#125;2020-01-10 16:38:04.409 [kafka-producer-network-thread | producer-1] WARN org.apache.kafka.clients.NetworkClient - [Producer clientId=producer-1] Error while fetching metadata with correlation id 14 : &#123;=INVALID_TOPIC_EXCEPTION&#125; instanceçš„logä¸­ä¼šæŠ¥é”™ 12345678910111213141516171819202122232020-01-10 16:37:27.159 [destination = mgr_fanboshi , address = /172.18.8.200:3399 , EventParser] WARN c.a.o.c.p.inbound.mysql.rds.RdsBinlogEventParserProxy - ---&gt; find start position successfully, EntryPosition[included=false,journalName=0080323399-mysql-bin.000004,position=1065960584,serverId=&lt;null&gt;,gtid=69ce1dcb-1b67-5e4b-9945-7cc64c64a14f:1-566281:1000009-2590159:3005066-3017688,ce947b65-6b70-539b-8e6a-59e9bcde28a0:206083443-206083524:207812793-207825891:207921053-207921085,d58aa5c2-b773-5944-bfe9-0a1142ef87f4:1706527:2447252-2447264,f5d4a39c-7800-52ec-b181-8c751ba2d078:868915-869106:1968590-1968591,timestamp=&lt;null&gt;] cost : 2ms , the next step is binlog dump2020-01-10 16:39:03.987 [pool-3-thread-2] ERROR com.alibaba.otter.canal.kafka.CanalKafkaProducer - java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms.java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms. at com.alibaba.otter.canal.kafka.CanalKafkaProducer.produce(CanalKafkaProducer.java:215) ~[canal.server-1.1.4.jar:na] at com.alibaba.otter.canal.kafka.CanalKafkaProducer.send(CanalKafkaProducer.java:179) ~[canal.server-1.1.4.jar:na] at com.alibaba.otter.canal.kafka.CanalKafkaProducer.send(CanalKafkaProducer.java:117) ~[canal.server-1.1.4.jar:na] at com.alibaba.otter.canal.server.CanalMQStarter.worker(CanalMQStarter.java:183) [canal.server-1.1.4.jar:na] at com.alibaba.otter.canal.server.CanalMQStarter.access$500(CanalMQStarter.java:23) [canal.server-1.1.4.jar:na] at com.alibaba.otter.canal.server.CanalMQStarter$CanalMQRunnable.run(CanalMQStarter.java:225) [canal.server-1.1.4.jar:na] at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [na:1.8.0_111] at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_111] at java.lang.Thread.run(Thread.java:745) [na:1.8.0_111]Caused by: java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms. at org.apache.kafka.clients.producer.KafkaProducer$FutureFailure.&lt;init&gt;(KafkaProducer.java:1150) ~[kafka-clients-1.1.1.jar:na] at org.apache.kafka.clients.producer.KafkaProducer.doSend(KafkaProducer.java:846) ~[kafka-clients-1.1.1.jar:na] at org.apache.kafka.clients.producer.KafkaProducer.send(KafkaProducer.java:784) ~[kafka-clients-1.1.1.jar:na] at org.apache.kafka.clients.producer.KafkaProducer.send(KafkaProducer.java:671) ~[kafka-clients-1.1.1.jar:na] at com.alibaba.otter.canal.kafka.CanalKafkaProducer.produce(CanalKafkaProducer.java:199) ~[canal.server-1.1.4.jar:na] ... 8 common frames omittedCaused by: org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms. æœåˆ°ä¸€ä¸ªissueç»™äº†æˆ‘ä¸€äº›å¯å‘https://github.com/alibaba/canal/issues/1716 åœ¨instance.propertiesé‡Œé¢é…ç½®åŒæ­¥åº“é…ç½®canal.instance.filter.regex=A\\\\..*,B\\\\..*,C\\\\..* æ¶ˆæ¯é˜Ÿåˆ—é…ç½®ä½¿ç”¨æ­£åˆ™è·¯ç”±schemaå’Œtableæ ¼å¼topic:schema.table,topic:schema.table,topic:schema.tablecanal.mq.dynamicTopic=topic_A:A,topic_B:B,topic_C:Cæœ€å¥½é…ç½®ä¸€ä¸ªcanal.mq.topicä½œä¸ºé»˜è®¤çš„topicï¼Œåœ¨å®è·µä¸­å‘ç°ï¼Œæœ‰ä¸€äº›mysql schemaçš„binlogä¹Ÿä¼šè¯»è¿›æ¥ï¼ˆå»ºè¡¨è¯­å¥ï¼Œgrantè¯­å¥ç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªé»˜è®¤çš„topicï¼Œä¼šæŠ¥æ‰¾ä¸åˆ°åˆ†åŒºçš„é”™è¯¯ï¼Œä»è€Œå¯¼è‡´canalåœæ­¢å†™å…¥ã€‚canal.mq.topic=a_default_topic åˆ†åŒºè®¾ç½® å¦‚æœæ¯ä¸ªtopicåªæœ‰ä¸€ä¸ªåˆ†åŒºè®¾ç½®å¦‚ä¸‹canal.mq.partition=0 å¦‚æœæ¯ä¸ªtopicæœ‰å¤šä¸ªåˆ†åŒºï¼Œä¸”å¸Œæœ›æŒ‰ç…§è¡¨ååšhashè¿›è¡Œå¦‚ä¸‹é…ç½®# hash partition configcanal.mq.partitionsNum=3canal.mq.partitionHash=.*\\\\..* æ˜¯ä¸æ˜¯canal.mq.topicè¿™ä¸ªå‚æ•°éšä¾¿å†™ä¸€ä¸ªå­˜åœ¨çš„topicï¼Œç„¶åä¸»è¦è®¾ç½®åœ¨è¿™é‡Œå¯¹å§ï¼Ÿcanal.mq.dynamicTopic=topic_A:A,topic_B:B,topic_C:C æ˜¯çš„ã€‚canal.mq.topicç®—æ˜¯ä¸€ä¸ªé»˜è®¤çš„ï¼Œæ²¡æœ‰åŒ¹é…åˆ°çš„schemaå’Œtableçš„æ—¥å¿—éƒ½ä¼šè¾“å…¥åˆ°é‚£ä¸ªé»˜è®¤çš„é‡Œé¢å»ã€‚æ¶ˆè´¹çš„æ—¶å€™åªå…³å¿ƒä½ è®¾ç½®çš„åŠ¨æ€åˆ†åŒºã€‚ æˆ‘çš„ç†è§£å°±æ˜¯ä¸€äº›ä¸æ˜¯æˆ‘ä»¬åŒ¹é…è§„åˆ™æ‰€éœ€è¦çš„æ¶ˆæ¯å› ä¸ºæ²¡æœ‰é…ç½®é»˜è®¤topicè€Œæ‰¾ä¸åˆ°topicå¯å†™, äºæ˜¯æ‰ä¼šæŠ¥é”™INVALID_TOPIC_EXCEPTION è™½ç„¶æœªæ¥åŒäº‹é…ç½®äº†canal.instance.filter.regex=broker\\\\..* ä½†æ˜¯æœ‰å¯èƒ½grantä¹‹ç±»çš„è¯­å¥è¿˜æ˜¯ä¼šæœ‰é—®é¢˜å§ æœ€åé™„ä¸Šè‡ªå·±1.1.4çš„é…ç½®å§ canal.properties 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142########################################################## common argument ############################################################### tcp bind ipcanal.ip = 172.18.8.32# register ip to zookeepercanal.register.ip = 172.18.8.32canal.port = 11111canal.metrics.pull.port = 11112# canal instance user/passwd# canal.user = canal# canal.passwd = E3619321C1A937C46A0D8BD1DAC39F93B27D4458# canal admin config#canal.admin.manager = 127.0.0.1:8089canal.admin.port = 11110canal.admin.user = admincanal.admin.passwd = 4ACFE3202A5FF5CF467898FC58AAB1D615029441canal.zkServers = 172.18.12.212:2181,172.18.12.213:2181# flush data to zkcanal.zookeeper.flush.period = 1000canal.withoutNetty = true# tcp, kafka, RocketMQcanal.serverMode = kafka# flush meta cursor/parse position to filecanal.file.data.dir = $&#123;canal.conf.dir&#125;canal.file.flush.period = 1000## memory store RingBuffer size, should be Math.pow(2,n)canal.instance.memory.buffer.size = 16384## memory store RingBuffer used memory unit size , default 1kbcanal.instance.memory.buffer.memunit = 1024 ## meory store gets mode used MEMSIZE or ITEMSIZEcanal.instance.memory.batch.mode = MEMSIZEcanal.instance.memory.rawEntry = true## detecing configcanal.instance.detecting.enable = false#canal.instance.detecting.sql = insert into retl.xdual values(1,now()) on duplicate key update x=now()canal.instance.detecting.sql = select 1canal.instance.detecting.interval.time = 3canal.instance.detecting.retry.threshold = 3canal.instance.detecting.heartbeatHaEnable = false# support maximum transaction size, more than the size of the transaction will be cut into multiple transactions deliverycanal.instance.transaction.size = 1024# mysql fallback connected to new master should fallback timescanal.instance.fallbackIntervalInSeconds = 60# network configcanal.instance.network.receiveBufferSize = 16384canal.instance.network.sendBufferSize = 16384canal.instance.network.soTimeout = 30# binlog filter configcanal.instance.filter.druid.ddl = truecanal.instance.filter.query.dcl = falsecanal.instance.filter.query.dml = falsecanal.instance.filter.query.ddl = falsecanal.instance.filter.table.error = falsecanal.instance.filter.rows = falsecanal.instance.filter.transaction.entry = false# binlog format/image checkcanal.instance.binlog.format = ROW,STATEMENT,MIXED canal.instance.binlog.image = FULL,MINIMAL,NOBLOB# binlog ddl isolationcanal.instance.get.ddl.isolation = false# parallel parser configcanal.instance.parser.parallel = true## concurrent thread number, default 60% available processors, suggest not to exceed Runtime.getRuntime().availableProcessors()#canal.instance.parser.parallelThreadSize = 16## disruptor ringbuffer size, must be power of 2canal.instance.parser.parallelBufferSize = 256# table meta tsdb infocanal.instance.tsdb.enable = falsecanal.instance.tsdb.dir = $&#123;canal.file.data.dir:../conf&#125;/$&#123;canal.instance.destination:&#125;canal.instance.tsdb.url = jdbc:h2:$&#123;canal.instance.tsdb.dir&#125;/h2;CACHE_SIZE=1000;MODE=MYSQL;canal.instance.tsdb.dbUsername = canalcanal.instance.tsdb.dbPassword = canal# dump snapshot interval, default 24 hourcanal.instance.tsdb.snapshot.interval = 24# purge snapshot expire , default 360 hour(15 days)canal.instance.tsdb.snapshot.expire = 360# aliyun ak/sk , support rds/mqcanal.aliyun.accessKey =canal.aliyun.secretKey =########################################################## destinations ##############################################################canal.destinations =# conf root dircanal.conf.dir = ../conf# auto scan instance dir add/remove and start/stop instancecanal.auto.scan = truecanal.auto.scan.interval = 5canal.instance.tsdb.spring.xml = classpath:spring/tsdb/h2-tsdb.xml#canal.instance.tsdb.spring.xml = classpath:spring/tsdb/mysql-tsdb.xmlcanal.instance.global.mode = springcanal.instance.global.lazy = falsecanal.instance.global.manager.address = $&#123;canal.admin.manager&#125;#canal.instance.global.spring.xml = classpath:spring/memory-instance.xml#canal.instance.global.spring.xml = classpath:spring/file-instance.xmlcanal.instance.global.spring.xml = classpath:spring/default-instance.xml########################################################### MQ ###############################################################canal.mq.servers = 172.18.12.212:9092canal.mq.retries = 0canal.mq.batchSize = 16384canal.mq.maxRequestSize = 33554432canal.mq.lingerMs = 100canal.mq.bufferMemory = 33554432canal.mq.canalBatchSize = 50canal.mq.canalGetTimeout = 100canal.mq.flatMessage = truecanal.mq.compressionType = nonecanal.mq.acks = all#canal.mq.properties. =canal.mq.transaction = falsecanal.mq.extraParams.enable.idempotence=truecanal.mq.extraParams.max.in.flight.requests.per.connection=1#canal.mq.producerGroup = test# Set this value to &quot;cloud&quot;, if you want open message trace feature in aliyun.#canal.mq.accessChannel = local# aliyun mq namespace#canal.mq.namespace =########################################################### Kafka Kerberos Info ################################################################canal.mq.kafka.kerberos.enable = false#canal.mq.kafka.kerberos.krb5FilePath = &quot;../conf/kerberos/krb5.conf&quot;#canal.mq.kafka.kerberos.jaasFilePath = &quot;../conf/kerberos/jaas.conf&quot; instance.properties 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859################################################### mysql serverId , v1.0.26+ will autoGen# canal.instance.mysql.slaveId=0# enable gtid use true/falsecanal.instance.gtidon=true# position infocanal.instance.master.address=172.18.8.200:3372canal.instance.master.journal.name=canal.instance.master.position=canal.instance.master.timestamp=canal.instance.master.gtid=# rds oss binlogcanal.instance.rds.accesskey=canal.instance.rds.secretkey=canal.instance.rds.instanceId=# table meta tsdb infocanal.instance.tsdb.enable=false#canal.instance.tsdb.url=jdbc:mysql://127.0.0.1:3306/canal_tsdb#canal.instance.tsdb.dbUsername=canal#canal.instance.tsdb.dbPassword=canal#canal.instance.standby.address =#canal.instance.standby.journal.name =#canal.instance.standby.position =#canal.instance.standby.timestamp =#canal.instance.standby.gtid=# username/passwordcanal.instance.dbUsername=canal_rcanal.instance.dbPassword=canal1234!@#$canal.instance.connectionCharset = UTF-8# enable druid Decrypt database passwordcanal.instance.enableDruid=false#canal.instance.pwdPublicKey=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALK4BUxdDltRRE5/zXpVEVPUgunvscYFtEip3pmLlhrWpacX7y7GCMo2/JM6LeHmiiNdH1FWgGCpUfircSwlWKUCAwEAAQ==# table regexcanal.instance.filter.regex=fanboshi\\\\..*# table black regexcanal.instance.filter.black.regex=# table field filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)#canal.instance.filter.field=test1.t_product:id/subject/keywords,test2.t_company:id/name/contact/ch# table field black filter(format: schema1.tableName1:field1/field2,schema2.tableName2:field1/field2)#canal.instance.filter.black.field=test1.t_product:subject/product_image,test2.t_company:id/name/contact/ch# mq configcanal.mq.topic=#canal.mq.topic=cherry_default# dynamic topic route by schema or table regex#canal.mq.dynamicTopic=mytest1.user,mytest2\\\\..*,.*\\\\..*canal.mq.dynamicTopic= cherry:fanboshi#canal.mq.partition=0# hash partition config#canal.mq.partitionsNum=3#canal.mq.partitionHash=test.table:id^name,.*\\\\..*#################################################","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Canal","slug":"Canal","permalink":"http://fuxkdb.com/tags/Canal/"}]},{"title":"è¯‘æ–‡ Streaming MySQL Backups with Percona XtraBackup â€“ Another Alternative","slug":"2020-01-09-è¯‘æ–‡-Streaming-MySQL-Backups-with-Percona-XtraBackup-â€“-Another-Alternative","date":"2020-01-09T02:01:00.000Z","updated":"2021-01-09T02:01:55.650Z","comments":true,"path":"2020/01/09/2020-01-09-è¯‘æ–‡-Streaming-MySQL-Backups-with-Percona-XtraBackup-â€“-Another-Alternative/","link":"","permalink":"http://fuxkdb.com/2020/01/09/2020-01-09-%E8%AF%91%E6%96%87-Streaming-MySQL-Backups-with-Percona-XtraBackup-%E2%80%93-Another-Alternative/","excerpt":"Streaming MySQL Backups with Percona XtraBackup â€“ Another Alternativeä½¿ç”¨Percona XtraBackupæµå¼ä¼ è¾“MySQLå¤‡ä»½-å¦ä¸€ç§é€‰æ‹© ä»Šå¤©æˆ‘å°†å‘ä½ ä»‹ç»å¦ä¸€ç§ä½¿ç”¨Percona XtraBackupåœ¨æœåŠ¡å™¨é—´åˆ›å»ºå¹¶ä¼ é€’å¤‡ä»½çš„æ–¹å¼. è¿™ä¸ªæ–¹æ³•å’Œç½‘ä¸Šçš„å…¶ä»–æ–¹æ³•æœ‰ä»€ä¹ˆä¸åŒå—? å…¶å®å¹¶æ²¡æœ‰å¾ˆå¤§ä¸åŒ, ä½†æ˜¯åœ¨æ€§èƒ½å’Œå¯ç”¨æ€§æ–¹é¢å¾ˆæœ‰è¶£. æˆ‘ä»¬å°†xbstreamå®ç”¨ç¨‹åºä¸pigzå’Œsocatçš„åŠŸèƒ½ç»“åˆåœ¨ä¸€èµ·, ä»¥åœ¨æ‹¥æœ‰å¤šä¸ªå¤„ç†å™¨çš„æƒ…å†µä¸‹åˆ©ç”¨å¤šå¤„ç†åŠŸèƒ½, åŒæ—¶åœ¨æ­¤ç»„ä»¶æˆä¸ºç“¶é¢ˆçš„æƒ…å†µä¸‹, å‡å°‘å¯¹ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨. å› æ­¤, è®©æˆ‘ä»¬è§£é‡Šæ¯ä¸ªç»„ä»¶: socat: ä»£è¡¨SOcket CAT. å®ƒæ˜¯ä¸€ä¸ªç”¨äºåœ¨ä¸¤ä¸ªåœ°å€ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“çš„å®ç”¨ç¨‹åº. ä½¿socatå¦‚æ­¤é€šç”¨çš„åŸå› æ˜¯åœ°å€å¯ä»¥ä»£è¡¨ç½‘ç»œå¥—æ¥å­—, ä»»ä½•æ–‡ä»¶æè¿°ç¬¦, UnixåŸŸæ•°æ®æŠ¥æˆ–æµå¥—æ¥å­—, TCPå’ŒUDPï¼ˆåœ¨IPv4å’ŒIPv6ä¸Šï¼‰, åœ¨IPv4 / IPv6ä¸Šçš„SOCKS 4 / 4a, SCTP , PTY, æ•°æ®æŠ¥å’Œæµå¥—æ¥å­—, å‘½åç®¡é“å’Œæœªå‘½åç®¡é“, åŸå§‹IPå¥—æ¥å­—, OpenSSL, æˆ–è€…åœ¨Linuxä¸Šç”šè‡³ä»»ä½•ä»»æ„ç½‘ç»œè®¾å¤‡ä¸Š Pigz: å®ƒä»£è¡¨gzipçš„å¹¶è¡Œå®ç°, å®ƒæ˜¯gzipçš„å…¨åŠŸèƒ½æ›¿ä»£å“, åœ¨å‹ç¼©æ•°æ®æ—¶åˆ©ç”¨äº†å¤šä¸ªå¤„ç†å™¨å’Œå¤šä¸ªå†…æ ¸. xbstream : ï¼ˆå…·æœ‰å¹¶è¡Œæ€§ï¼‰å¹¶è¡Œå¤„ç†å¤šä¸ªæ–‡ä»¶. æ‰€éœ€è½¯ä»¶åŒ…: pigz, socat, å½“ç„¶è¿˜æœ‰ Percona XtraBackup","text":"Streaming MySQL Backups with Percona XtraBackup â€“ Another Alternativeä½¿ç”¨Percona XtraBackupæµå¼ä¼ è¾“MySQLå¤‡ä»½-å¦ä¸€ç§é€‰æ‹© ä»Šå¤©æˆ‘å°†å‘ä½ ä»‹ç»å¦ä¸€ç§ä½¿ç”¨Percona XtraBackupåœ¨æœåŠ¡å™¨é—´åˆ›å»ºå¹¶ä¼ é€’å¤‡ä»½çš„æ–¹å¼. è¿™ä¸ªæ–¹æ³•å’Œç½‘ä¸Šçš„å…¶ä»–æ–¹æ³•æœ‰ä»€ä¹ˆä¸åŒå—? å…¶å®å¹¶æ²¡æœ‰å¾ˆå¤§ä¸åŒ, ä½†æ˜¯åœ¨æ€§èƒ½å’Œå¯ç”¨æ€§æ–¹é¢å¾ˆæœ‰è¶£. æˆ‘ä»¬å°†xbstreamå®ç”¨ç¨‹åºä¸pigzå’Œsocatçš„åŠŸèƒ½ç»“åˆåœ¨ä¸€èµ·, ä»¥åœ¨æ‹¥æœ‰å¤šä¸ªå¤„ç†å™¨çš„æƒ…å†µä¸‹åˆ©ç”¨å¤šå¤„ç†åŠŸèƒ½, åŒæ—¶åœ¨æ­¤ç»„ä»¶æˆä¸ºç“¶é¢ˆçš„æƒ…å†µä¸‹, å‡å°‘å¯¹ç½‘ç»œå¸¦å®½çš„ä½¿ç”¨. å› æ­¤, è®©æˆ‘ä»¬è§£é‡Šæ¯ä¸ªç»„ä»¶: socat: ä»£è¡¨SOcket CAT. å®ƒæ˜¯ä¸€ä¸ªç”¨äºåœ¨ä¸¤ä¸ªåœ°å€ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“çš„å®ç”¨ç¨‹åº. ä½¿socatå¦‚æ­¤é€šç”¨çš„åŸå› æ˜¯åœ°å€å¯ä»¥ä»£è¡¨ç½‘ç»œå¥—æ¥å­—, ä»»ä½•æ–‡ä»¶æè¿°ç¬¦, UnixåŸŸæ•°æ®æŠ¥æˆ–æµå¥—æ¥å­—, TCPå’ŒUDPï¼ˆåœ¨IPv4å’ŒIPv6ä¸Šï¼‰, åœ¨IPv4 / IPv6ä¸Šçš„SOCKS 4 / 4a, SCTP , PTY, æ•°æ®æŠ¥å’Œæµå¥—æ¥å­—, å‘½åç®¡é“å’Œæœªå‘½åç®¡é“, åŸå§‹IPå¥—æ¥å­—, OpenSSL, æˆ–è€…åœ¨Linuxä¸Šç”šè‡³ä»»ä½•ä»»æ„ç½‘ç»œè®¾å¤‡ä¸Š Pigz: å®ƒä»£è¡¨gzipçš„å¹¶è¡Œå®ç°, å®ƒæ˜¯gzipçš„å…¨åŠŸèƒ½æ›¿ä»£å“, åœ¨å‹ç¼©æ•°æ®æ—¶åˆ©ç”¨äº†å¤šä¸ªå¤„ç†å™¨å’Œå¤šä¸ªå†…æ ¸. xbstream : ï¼ˆå…·æœ‰å¹¶è¡Œæ€§ï¼‰å¹¶è¡Œå¤„ç†å¤šä¸ªæ–‡ä»¶. æ‰€éœ€è½¯ä»¶åŒ…: pigz, socat, å½“ç„¶è¿˜æœ‰ Percona XtraBackup ä»¥ä¸‹ç¤ºä¾‹æ“ä½œä¸­çš„ç¯å¢ƒä¿¡æ¯Source: è¿›è¡Œå¤‡ä»½çš„æ¥æºæ•°æ®åº“(MySQL 5.7 installed on CentOS 7.8) Target: å¤‡ä»½å°†å‘é€åˆ°çš„ç›®çš„åœ°(MySQL 5.7 installed on CentOS 7.8) æ­¥éª¤ åœ¨Sourceå’ŒTargetå®‰è£…ä¾èµ–åŒ… 12Source # yum install -y pigz socatTarget # yum install -y pigz socat å¦‚æœä½ å°šæœªåœ¨æºç«¯å’Œç›®æ ‡ç«¯å®‰è£…Percona XtraBackup, è¯·å‚ç…§ä»¥ä¸‹æ­¥éª¤https://www.percona.com/doc/percona-xtrabackup/2.4/index.html#installation ç¡®ä¿æ‚¨æ‹¥æœ‰ä¸€ä¸ªå…·æœ‰é€‚å½“ç‰¹æƒçš„ç”¨æˆ·, å¯ä»¥åœ¨æºæ•°æ®åº“ä¸Šè¿›è¡Œå¤‡ä»½: 12345+---------------------------------------------------------------------------+| Grants for bkpuser@localhost |+---------------------------------------------------------------------------+| GRANT RELOAD, PROCESS, REPLICATION CLIENT ON *.* TO &#x27;bkpuser&#x27;@&#x27;localhost&#x27; |+---------------------------------------------------------------------------+ åœ¨Targetæ‰§è¡Œ: åœæ­¢å½“å‰çš„æ•°æ®åº“æœåŠ¡(å¦‚æœæœ‰): 1Target # systemctl stop mysqld åˆ é™¤datadirå†…å®¹ï¼ˆå‡è®¾å®ƒå·²ä½¿ç”¨é»˜è®¤è®¾ç½®å®‰è£…ï¼‰, å¹¶ç¡®ä¿æ‚¨å·²ç™»å½•åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼ 1Target # rm -rf /var/lib/mysql/* æœ€å, æˆ‘ä»¬å°†æ‰§è¡Œå‘½ä»¤ä»¥ä»æºï¼ˆSourceï¼‰æ¥æ”¶å¤‡ä»½: 1Target # socat -u TCP-LISTEN:4444,reuseaddr stdio | pigz -dc -p 4 - | xbstream â€”p 4 -x -C /var/lib/mysql åœ¨Sourceæ‰§è¡Œå‘½ä»¤ä»¥å°†å¤‡ä»½å‘é€åˆ°ç›®æ ‡ï¼ˆTargetï¼‰. 1Source # xtrabackup --defaults-file=/etc/my.cnf --backup --user=bkpuser --password=Bkpuser123! --stream=xbstream --parallel 4 --no-timestamp --target-dir=/tmp | pigz -k -1 -p4 - | socat -u stdio TCP:Target:4444 æ‚¨å°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡º: 12345678910111213141516171819202122232425xtrabackup: recognized server arguments: --datadir=/var/lib/mysql --server-id=1 --log_bin=/var/lib/mysql/mysql-bin --innodb_log_file_size=200M --innodb_log_files_in_group=2 --open_files_limit=65535 --parallel=4xtrabackup: recognized client arguments: --backup=1 --user=bkpuser --password=* --stream=xbstream --target-dir=/tmp200822 11:10:16 version_check Connecting to MySQL server with DSN &#x27;dbi:mysql:;mysql_read_default_group=xtrabackup&#x27; as &#x27;bkpuser&#x27; (using password: YES).200822 11:10:16 version_check Connected to MySQL server200822 11:10:16 version_check Executing a version check against the server...200822 11:10:16 version_check Done.200822 11:10:16 Connecting to MySQL server host: localhost, user: bkpuser, password: set, port: not set, socket: not setUsing server version 5.7.30-logxtrabackup version 2.4.20 based on MySQL server 5.7.26 Linux (x86_64) (revision id: c8b4056)xtrabackup: uses posix_fadvise().xtrabackup: cd to /var/lib/mysqlxtrabackup: open files limit requested 65535, set to 65535xtrabackup: using the following InnoDB configuration:xtrabackup: innodb_data_home_dir = .xtrabackup: innodb_data_file_path = ibdata1:12M:autoextendxtrabackup: innodb_log_group_home_dir = ./xtrabackup: innodb_log_files_in_group = 2xtrabackup: innodb_log_file_size = 209715200InnoDB: Number of pools: 1200822 11:10:16 &gt;&gt; log scanned up to (6724690490)xtrabackup: Generating a list of tablespacesInnoDB: Allocated tablespace ID 2 for mysql/plugin, old maximum was 0xtrabackup: Starting 4 threads for parallel data files transfer200822 11:10:16 [01] Streaming ./ibdata1...etc å®Œæˆç¬¬3æ­¥å, æ‚¨å°†åœ¨TargetèŠ‚ç‚¹ä¸Šçœ‹åˆ°å¦‚ä¸‹è¾“å‡º: 12345678...MySQL binlog position: filename &#x27;mysql-bin.000091&#x27;, position &#x27;102205647&#x27;200822 11:10:21 [00] Streaming &lt;STDOUT&gt;200822 11:10:21 [00] ...done200822 11:10:21 [00] Streaming &lt;STDOUT&gt;200822 11:10:21 [00] ...donextrabackup: Transaction log of lsn (4308505553) to (4308505562) was copied.200822 11:10:21 completed OK! ç¬¬2æ­¥ä¹Ÿå°†å®Œæˆ, å› æ­¤æ‚¨å¿…é¡»åœ¨TargetèŠ‚ç‚¹ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤: 1Target # xtrabackup --prepare --use-memory=1G --target-dir=/var/lib/mysql/ ä»æ–‡æ¡£ä¸­: ä½¿ç”¨xtrabackup â€“backupé€‰é¡¹è¿›è¡Œå¤‡ä»½å, é¦–å…ˆéœ€è¦å‡†å¤‡å®ƒä»¥è¿›è¡Œè¿˜åŸ. åœ¨å‡†å¤‡å¥½æ•°æ®æ–‡ä»¶ä¹‹å‰, å®ƒä»¬åœ¨æ—¶é—´ç‚¹ä¸Šæ˜¯ä¸ä¸€è‡´çš„, å› ä¸ºå®ƒä»¬æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶åœ¨ä¸åŒçš„æ—¶é—´å¤åˆ¶çš„, å¹¶ä¸”åœ¨æ­¤è¿‡ç¨‹ä¸­å®ƒä»¬å¯èƒ½å·²è¢«æ›´æ”¹. å¦‚æœæ‚¨å°è¯•ä½¿ç”¨è¿™äº›æ•°æ®æ–‡ä»¶å¯åŠ¨InnoDB, å®ƒå°†æ£€æµ‹åˆ°æŸåå¹¶è‡ªèº«å´©æºƒ, ä»¥é˜²æ­¢æ‚¨åœ¨æŸåçš„æ•°æ®ä¸Šè¿è¡Œ. è¯¥xtrabackup -prepareæ­¥éª¤ä½¿å¾—æ–‡ä»¶åœ¨å•ä¸ªæ—¶é—´ç¬é—´å®Œå…¨ä¸€è‡´, è¿™æ ·ä½ å°±å¯ä»¥åœ¨ä¸Šé¢è¿è¡Œçš„InnoDB. 12Target # chown -R mysql:mysql /var/lib/mysql/*Target # systemctl start mysqld æ‚¨å·²ç»å…‹éš†äº†ä¸€ä¸ªæ–°æ•°æ®åº“ï¼ å½“ç„¶, æ‚¨å¯ä»¥å°†æ–°æ•°æ®åº“è®¾ç½®ä¸ºå‰¯æœ¬, å¹¶åœ¨ç›®æ ‡èŠ‚ç‚¹ä¸­æ‰§è¡Œä»¥ä¸‹é™„åŠ æ­¥éª¤: æŸ¥çœ‹æ–‡ä»¶xtrabackup_binlog_infoçš„å†…å®¹, å®ƒå°†ç±»ä¼¼äº: 123Target # cat /var/lib/mysql/xtrabackup_binlog_infomysql-bin.000091 102205647 ï¼ˆæˆ‘ä»¬å‡è®¾åœ¨æºæ•°æ®åº“ä¸­åˆ›å»ºäº†ä»¥ä¸‹ç”¨æˆ·/æˆæƒ, å¦‚æœæ²¡æœ‰, è¯·åˆ›å»ºå®ƒï¼‰ 123456mysql&gt; show grants for replicator;+----------------------------------------------------+| Grants for replicator@% |+----------------------------------------------------+| GRANT REPLICATION SLAVE ON *.* TO &#x27;replicator&#x27;@&#x27;%&#x27; |+----------------------------------------------------+ è¿æ¥åˆ°æ•°æ®åº“, ç„¶åè¿è¡Œ: 1Target # mysql -u root -p 12mysql&gt; change master to master_host=&#x27;Source&#x27;,master_port=3306,master_user=&#x27;replicator&#x27;,master_password=&#x27;R3pl1c4t10n!&#x27;,master_log_file=&#x27;mysql-bin.000091&#x27;,master_log_pos=102205647;Query OK, 0 rows affected (0.00 sec) 12mysql&gt; start slave;Query OK, 0 rows affected (0.00 sec) 1mysql&gt; pager egrep -i &quot;Master_Host|Master_User|Master_Port|file|behind&quot; 12345678910111213mysql&gt; show slave status\\G Master_Host: master Master_User: replicator Master_Port: 3306 Master_Log_File: mysql-bin.000091 Relay_Log_File: relay.000001 Relay_Master_Log_File: mysql-bin.000091 Until_Log_File: Master_SSL_CA_File: Seconds_Behind_Master: 0 Master_Info_File: mysql.slave_master_info1 row in set (0.00 sec) å°±è¿™æ ·. ç›´æ’­æ„‰å¿«ï¼","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"TiDB Syncerä¸åŒè¡¨ååº“ååŒæ­¥ä¸”æ”¯æŒpt-oscæ”¹è¡¨","slug":"2019-12-12-TiDB-Syncerä¸åŒè¡¨ååº“ååŒæ­¥ä¸”æ”¯æŒpt-oscæ”¹è¡¨","date":"2019-12-12T13:55:00.000Z","updated":"2019-12-10T13:56:31.000Z","comments":true,"path":"2019/12/12/2019-12-12-TiDB-Syncerä¸åŒè¡¨ååº“ååŒæ­¥ä¸”æ”¯æŒpt-oscæ”¹è¡¨/","link":"","permalink":"http://fuxkdb.com/2019/12/12/2019-12-12-TiDB-Syncer%E4%B8%8D%E5%90%8C%E8%A1%A8%E5%90%8D%E5%BA%93%E5%90%8D%E5%90%8C%E6%AD%A5%E4%B8%94%E6%94%AF%E6%8C%81pt-osc%E6%94%B9%E8%A1%A8/","excerpt":"TiDB Syncerä¸åŒè¡¨ååº“ååŒæ­¥ä¸”æ”¯æŒpt-oscæ”¹è¡¨mysqlç«¯åº“åå«sysbench, è¡¨åsbtest11tidbç«¯åº“åptosc_sysbench,è¡¨åptosc_sbtest11 1234567891011121314151617181920[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;ptosc_sbtest11&quot;[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;~.*_sbtest11_new&quot;[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;~.*_sbtest11_old&quot;[[route-rules]]pattern-schema = &quot;sysbench&quot;pattern-table = &quot;sbtest11&quot;target-schema = &quot;ptosc_sysbench&quot;target-table = &quot;ptosc_sbtest11&quot;","text":"TiDB Syncerä¸åŒè¡¨ååº“ååŒæ­¥ä¸”æ”¯æŒpt-oscæ”¹è¡¨mysqlç«¯åº“åå«sysbench, è¡¨åsbtest11tidbç«¯åº“åptosc_sysbench,è¡¨åptosc_sbtest11 1234567891011121314151617181920[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;ptosc_sbtest11&quot;[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;~.*_sbtest11_new&quot;[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;~.*_sbtest11_old&quot;[[route-rules]]pattern-schema = &quot;sysbench&quot;pattern-table = &quot;sbtest11&quot;target-schema = &quot;ptosc_sysbench&quot;target-table = &quot;ptosc_sbtest11&quot; MySQLæ‰§è¡Œpt-osc 123456789101112131415161718192021222324252627282930313233343536373839404142#pt-online-schema-change --ask-pass --check-interval=1 --no-check-replication-filters --no-check-alter --no-version-check --chunk-size 3 --recursion-method=none --max-load=&#x27;Threads_running=200&#x27; --critical-load=&#x27;Threads_running=500&#x27; --recurse=0 --no-drop-old-table --alter=&quot;drop index c&quot; --print h=10.133.x.52,P=3308,u=fanboshi,D=sysbench,t=sbtest11,A=utf8 --executeEnter MySQL password: No slaves found. See --recursion-method if host node10-133-1-52 has slaves.Not checking slave lag because no slaves were found and --check-slave-lag was not specified.Operation, tries, wait: analyze_table, 10, 1 copy_rows, 10, 0.25 create_triggers, 10, 1 drop_triggers, 10, 1 swap_tables, 10, 1 update_foreign_keys, 10, 1Altering `sysbench`.`sbtest11`...Creating new table...CREATE TABLE `sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_binCreated new table sysbench._sbtest11_new OK.Altering new table...ALTER TABLE `sysbench`.`_sbtest11_new` drop index cAltered `sysbench`.`_sbtest11_new` OK.2019-12-04T22:32:44 Creating triggers...2019-12-04T22:32:44 Created triggers OK.2019-12-04T22:32:44 Copying approximately 3 rows...INSERT LOW_PRIORITY IGNORE INTO `sysbench`.`_sbtest11_new` (`id`, `k`, `c`, `pad`) SELECT `id`, `k`, `c`, `pad` FROM `sysbench`.`sbtest11` LOCK IN SHARE MODE /*pt-online-schema-change 11937 copy table*/2019-12-04T22:32:44 Copied rows OK.2019-12-04T22:32:44 Analyzing new table...2019-12-04T22:32:44 Swapping tables...RENAME TABLE `sysbench`.`sbtest11` TO `sysbench`.`__sbtest11_old`, `sysbench`.`_sbtest11_new` TO `sysbench`.`sbtest11`2019-12-04T22:32:44 Swapped original and new tables OK.Not dropping old table because --no-drop-old-table was specified.2019-12-04T22:32:44 Dropping triggers...DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_del`DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_upd`DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_ins`2019-12-04T22:32:44 Dropped triggers OK.Successfully altered `sysbench`.`sbtest11`. synceræ—¥å¿— 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381392019/12/04 22:32:05 syncer.go:754: [info] [query]CREATE TABLE `sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin [current pos](10523308-mysql-bin.000023, 557640598) [next pos](10523308-mysql-bin.000023, 557641108) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755555 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555562019/12/04 22:32:05 syncer.go:795: [info] [ddl][schema]sysbench [start]USE `ptosc_sysbench`; CREATE TABLE `ptosc_sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;2019/12/04 22:32:05 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557641108 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555562019/12/04 22:32:05 syncer.go:803: [info] [ddl][end]USE `ptosc_sysbench`; CREATE TABLE `ptosc_sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;2019/12/04 22:32:05 ddl.go:110: [warning] will split alter table statement: ALTER TABLE `sysbench`.`_sbtest11_new` drop index c2019/12/04 22:32:05 ast.go:521: [info] spec &amp;&#123;node:&#123;text:&#125; IfExists:false IfNotExists:false NoWriteToBinlog:false OnAllPartitions:false Tp:6 Name:c Constraint:&lt;nil&gt; Options:[] OrderByList:[] NewTable:&lt;nil&gt; NewColumns:[] NewConstraints:[] OldColumnName:&lt;nil&gt; NewColumnName:&lt;nil&gt; Position:&lt;nil&gt; LockType: Algorithm:DEFAULT Comment: FromKey: ToKey: Partition:&lt;nil&gt; PartitionNames:[] PartDefinitions:[] WithValidation:false Num:0 Visibility:0&#125;2019/12/04 22:32:05 ddl.go:114: [warning] splitted alter table statement: [ALTER TABLE `sysbench`.`_sbtest11_new` DROP INDEX `c`]2019/12/04 22:32:05 syncer.go:754: [info] [query]ALTER TABLE `sysbench`.`_sbtest11_new` drop index c [current pos](10523308-mysql-bin.000023, 557641108) [next pos](10523308-mysql-bin.000023, 557641303) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755556 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555572019/12/04 22:32:05 syncer.go:795: [info] [ddl][schema]sysbench [start]USE `ptosc_sysbench`; ALTER TABLE `ptosc_sysbench`.`_sbtest11_new` DROP INDEX `c`;2019/12/04 22:32:06 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557641303 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555572019/12/04 22:32:06 syncer.go:803: [info] [ddl][end]USE `ptosc_sysbench`; ALTER TABLE `ptosc_sysbench`.`_sbtest11_new` DROP INDEX `c`;2019/12/04 22:32:06 syncer.go:754: [info] [query]DROP TABLE IF EXISTS `_sbtest11_new` /* generated by server */ [current pos](10523308-mysql-bin.000023, 557641303) [next pos](10523308-mysql-bin.000023, 557641509) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755557 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555582019/12/04 22:32:06 syncer.go:795: [info] [ddl][schema]sysbench [start]USE `ptosc_sysbench`; DROP TABLE IF EXISTS `ptosc_sysbench`.`_sbtest11_new`;2019/12/04 22:32:07 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557641509 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555582019/12/04 22:32:07 syncer.go:803: [info] [ddl][end]USE `ptosc_sysbench`; DROP TABLE IF EXISTS `ptosc_sysbench`.`_sbtest11_new`;2019/12/04 22:32:30 syncer.go:955: [info] [syncer]total events = 4, tps = 0.100000, master-binlog = (10523308-mysql-bin.000023, 557641509), master-binlog-gtid=a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755558, syncer-binlog = (10523308-mysql-bin.000023, 557641509), syncer-binlog-gtid = a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555582019/12/04 22:32:44 syncer.go:754: [info] [query]CREATE TABLE `sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin [current pos](10523308-mysql-bin.000023, 557641509) [next pos](10523308-mysql-bin.000023, 557642019) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755558 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555592019/12/04 22:32:44 syncer.go:795: [info] [ddl][schema]sysbench [start]USE `ptosc_sysbench`; CREATE TABLE `ptosc_sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;2019/12/04 22:32:46 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557642019 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555592019/12/04 22:32:46 syncer.go:803: [info] [ddl][end]USE `ptosc_sysbench`; CREATE TABLE `ptosc_sysbench`.`_sbtest11_new` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) COLLATE utf8mb4_bin NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;2019/12/04 22:32:46 ddl.go:110: [warning] will split alter table statement: ALTER TABLE `sysbench`.`_sbtest11_new` drop index c2019/12/04 22:32:46 ast.go:521: [info] spec &amp;&#123;node:&#123;text:&#125; IfExists:false IfNotExists:false NoWriteToBinlog:false OnAllPartitions:false Tp:6 Name:c Constraint:&lt;nil&gt; Options:[] OrderByList:[] NewTable:&lt;nil&gt; NewColumns:[] NewConstraints:[] OldColumnName:&lt;nil&gt; NewColumnName:&lt;nil&gt; Position:&lt;nil&gt; LockType: Algorithm:DEFAULT Comment: FromKey: ToKey: Partition:&lt;nil&gt; PartitionNames:[] PartDefinitions:[] WithValidation:false Num:0 Visibility:0&#125;2019/12/04 22:32:46 ddl.go:114: [warning] splitted alter table statement: [ALTER TABLE `sysbench`.`_sbtest11_new` DROP INDEX `c`]2019/12/04 22:32:46 syncer.go:754: [info] [query]ALTER TABLE `sysbench`.`_sbtest11_new` drop index c [current pos](10523308-mysql-bin.000023, 557642019) [next pos](10523308-mysql-bin.000023, 557642214) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755559 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555602019/12/04 22:32:46 syncer.go:795: [info] [ddl][schema]sysbench [start]USE `ptosc_sysbench`; ALTER TABLE `ptosc_sysbench`.`_sbtest11_new` DROP INDEX `c`;2019/12/04 22:32:47 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557642214 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555602019/12/04 22:32:47 syncer.go:803: [info] [ddl][end]USE `ptosc_sysbench`; ALTER TABLE `ptosc_sysbench`.`_sbtest11_new` DROP INDEX `c`;2019/12/04 22:32:47 ddl.go:64: [error] encountered incompatible DDL in TiDB: CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest11_del` AFTER DELETE ON `sysbench`.`sbtest11` FOR EACH ROW DELETE IGNORE FROM `sysbench`.`_sbtest11_new` WHERE `sysbench`.`_sbtest11_new`.`id` &lt;=&gt; OLD.`id`please confirm your DDL statement is correct and needed.for TiDB compatible DDL, please see the docs: English version: https://github.com/pingcap/docs/blob/master/sql/ddl.md Chinese version: https://github.com/pingcap/docs-cn/blob/master/sql/ddl.mdif the DDL is not needed, you can modify the meta file and restart syncer to skip it.2019/12/04 22:32:47 syncer.go:745: [warning] [skip query event][schema]sysbench [sql]CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest11_del` AFTER DELETE ON `sysbench`.`sbtest11` FOR EACH ROW DELETE IGNORE FROM `sysbench`.`_sbtest11_new` WHERE `sysbench`.`_sbtest11_new`.`id` &lt;=&gt; OLD.`id` [current pos](10523308-mysql-bin.000023, 557642214) [next pos](10523308-mysql-bin.000023, 557642590) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755560 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555612019/12/04 22:32:47 ddl.go:64: [error] encountered incompatible DDL in TiDB: CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest11_upd` AFTER UPDATE ON `sysbench`.`sbtest11` FOR EACH ROW BEGIN DELETE IGNORE FROM `sysbench`.`_sbtest11_new` WHERE !(OLD.`id` &lt;=&gt; NEW.`id`) AND `sysbench`.`_sbtest11_new`.`id` &lt;=&gt; OLD.`id`;REPLACE INTO `sysbench`.`_sbtest11_new` (`id`, `k`, `c`, `pad`) VALUES (NEW.`id`, NEW.`k`, NEW.`c`, NEW.`pad`);ENDplease confirm your DDL statement is correct and needed.for TiDB compatible DDL, please see the docs: English version: https://github.com/pingcap/docs/blob/master/sql/ddl.md Chinese version: https://github.com/pingcap/docs-cn/blob/master/sql/ddl.mdif the DDL is not needed, you can modify the meta file and restart syncer to skip it.2019/12/04 22:32:47 syncer.go:745: [warning] [skip query event][schema]sysbench [sql]CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest11_upd` AFTER UPDATE ON `sysbench`.`sbtest11` FOR EACH ROW BEGIN DELETE IGNORE FROM `sysbench`.`_sbtest11_new` WHERE !(OLD.`id` &lt;=&gt; NEW.`id`) AND `sysbench`.`_sbtest11_new`.`id` &lt;=&gt; OLD.`id`;REPLACE INTO `sysbench`.`_sbtest11_new` (`id`, `k`, `c`, `pad`) VALUES (NEW.`id`, NEW.`k`, NEW.`c`, NEW.`pad`);END [current pos](10523308-mysql-bin.000023, 557642214) [next pos](10523308-mysql-bin.000023, 557643116) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755560 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555622019/12/04 22:32:47 ddl.go:64: [error] encountered incompatible DDL in TiDB: CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest11_ins` AFTER INSERT ON `sysbench`.`sbtest11` FOR EACH ROW REPLACE INTO `sysbench`.`_sbtest11_new` (`id`, `k`, `c`, `pad`) VALUES (NEW.`id`, NEW.`k`, NEW.`c`, NEW.`pad`)please confirm your DDL statement is correct and needed.for TiDB compatible DDL, please see the docs: English version: https://github.com/pingcap/docs/blob/master/sql/ddl.md Chinese version: https://github.com/pingcap/docs-cn/blob/master/sql/ddl.mdif the DDL is not needed, you can modify the meta file and restart syncer to skip it.2019/12/04 22:32:47 syncer.go:745: [warning] [skip query event][schema]sysbench [sql]CREATE DEFINER=`fanboshi`@`%` TRIGGER `pt_osc_sysbench_sbtest11_ins` AFTER INSERT ON `sysbench`.`sbtest11` FOR EACH ROW REPLACE INTO `sysbench`.`_sbtest11_new` (`id`, `k`, `c`, `pad`) VALUES (NEW.`id`, NEW.`k`, NEW.`c`, NEW.`pad`) [current pos](10523308-mysql-bin.000023, 557642214) [next pos](10523308-mysql-bin.000023, 557643506) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755560 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555632019/12/04 22:32:47 syncer.go:754: [info] [query]RENAME TABLE `sysbench`.`sbtest11` TO `sysbench`.`__sbtest11_old`, `sysbench`.`_sbtest11_new` TO `sysbench`.`sbtest11` [current pos](10523308-mysql-bin.000023, 557644557) [next pos](10523308-mysql-bin.000023, 557645022) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755564 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555662019/12/04 22:32:47 syncer.go:795: [info] [ddl][schema]sysbench [start]RENAME TABLE `ptosc_sysbench`.`ptosc_sbtest11` TO `ptosc_sysbench`.`__sbtest11_old`2019/12/04 22:32:48 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557644557 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555642019/12/04 22:32:48 syncer.go:803: [info] [ddl][end]RENAME TABLE `ptosc_sysbench`.`ptosc_sbtest11` TO `ptosc_sysbench`.`__sbtest11_old`2019/12/04 22:32:48 syncer.go:795: [info] [ddl][schema]sysbench [start]RENAME TABLE `ptosc_sysbench`.`_sbtest11_new` TO `ptosc_sysbench`.`ptosc_sbtest11`2019/12/04 22:32:49 meta.go:135: [info] save position to file, binlog-name:10523308-mysql-bin.000023 binlog-pos:557645022 binlog-gtid:a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555662019/12/04 22:32:49 syncer.go:803: [info] [ddl][end]RENAME TABLE `ptosc_sysbench`.`_sbtest11_new` TO `ptosc_sysbench`.`ptosc_sbtest11`2019/12/04 22:32:49 ddl.go:64: [error] encountered incompatible DDL in TiDB: DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_del`please confirm your DDL statement is correct and needed.for TiDB compatible DDL, please see the docs: English version: https://github.com/pingcap/docs/blob/master/sql/ddl.md Chinese version: https://github.com/pingcap/docs-cn/blob/master/sql/ddl.mdif the DDL is not needed, you can modify the meta file and restart syncer to skip it.2019/12/04 22:32:49 syncer.go:745: [warning] [skip query event][schema]sysbench [sql]DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_del` [current pos](10523308-mysql-bin.000023, 557645022) [next pos](10523308-mysql-bin.000023, 557645230) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755566 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555672019/12/04 22:32:49 ddl.go:64: [error] encountered incompatible DDL in TiDB: DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_upd`please confirm your DDL statement is correct and needed.for TiDB compatible DDL, please see the docs: English version: https://github.com/pingcap/docs/blob/master/sql/ddl.md Chinese version: https://github.com/pingcap/docs-cn/blob/master/sql/ddl.mdif the DDL is not needed, you can modify the meta file and restart syncer to skip it.2019/12/04 22:32:49 syncer.go:745: [warning] [skip query event][schema]sysbench [sql]DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_upd` [current pos](10523308-mysql-bin.000023, 557645022) [next pos](10523308-mysql-bin.000023, 557645438) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755566 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555682019/12/04 22:32:49 ddl.go:64: [error] encountered incompatible DDL in TiDB: DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_ins`please confirm your DDL statement is correct and needed.for TiDB compatible DDL, please see the docs: English version: https://github.com/pingcap/docs/blob/master/sql/ddl.md Chinese version: https://github.com/pingcap/docs-cn/blob/master/sql/ddl.mdif the DDL is not needed, you can modify the meta file and restart syncer to skip it.2019/12/04 22:32:49 syncer.go:745: [warning] [skip query event][schema]sysbench [sql]DROP TRIGGER IF EXISTS `sysbench`.`pt_osc_sysbench_sbtest11_ins` [current pos](10523308-mysql-bin.000023, 557645022) [next pos](10523308-mysql-bin.000023, 557645646) [current gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755566 [next gtid set]a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555692019/12/04 22:33:00 syncer.go:955: [info] [syncer]total events = 7, tps = 0.233333, master-binlog = (10523308-mysql-bin.000023, 557645646), master-binlog-gtid=a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755569, syncer-binlog = (10523308-mysql-bin.000023, 557645022), syncer-binlog-gtid = a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555662019/12/04 22:33:30 syncer.go:955: [info] [syncer]total events = 7, tps = 0.000000, master-binlog = (10523308-mysql-bin.000023, 557645646), master-binlog-gtid=a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755569, syncer-binlog = (10523308-mysql-bin.000023, 557645022), syncer-binlog-gtid = a5c0e0de-19bb-5df7-8be2-29248264cc14:1-7555662019/12/04 22:34:00 syncer.go:955: [info] [syncer]total events = 7, tps = 0.000000, master-binlog = (10523308-mysql-bin.000023, 557645646), master-binlog-gtid=a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755569, syncer-binlog = (10523308-mysql-bin.000023, 557645022), syncer-binlog-gtid = a5c0e0de-19bb-5df7-8be2-29248264cc14:1-755566 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869root@10.132.2.164 22:28:34 [ptosc_sysbench]&gt; show tables;+--------------------------+| Tables_in_ptosc_sysbench |+--------------------------+| __sbtest11_old || _sbtest11_old || ptosc_sbtest1 || ptosc_sbtest10 || ptosc_sbtest11 || ptosc_sbtest12 || ptosc_sbtest13 || ptosc_sbtest2 || ptosc_sbtest3 || ptosc_sbtest4 || ptosc_sbtest5 || ptosc_sbtest6 || ptosc_sbtest7 || ptosc_sbtest8 || ptosc_sbtest9 |+--------------------------+15 rows in set (0.01 sec)root@10.132.2.164 22:32:58 [ptosc_sysbench]&gt; show create table ptosc_sbtest11\\G*************************** 1. row *************************** Table: ptosc_sbtest11Create Table: CREATE TABLE `ptosc_sbtest11` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin AUTO_INCREMENT=300041 row in set (0.00 sec)root@10.132.2.164 22:33:07 [ptosc_sysbench]&gt; show create table __sbtest11_old\\G*************************** 1. row *************************** Table: __sbtest11_oldCreate Table: CREATE TABLE `__sbtest11_old` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `c` char(120) NOT NULL DEFAULT &#x27;&#x27;, `pad` char(60) NOT NULL DEFAULT &#x27;&#x27;, PRIMARY KEY (`id`), KEY `k_1` (`k`), KEY `c` (`c`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin AUTO_INCREMENT=300041 row in set (0.00 sec)root@10.132.2.164 22:33:12 [ptosc_sysbench]&gt; select * from ptosc_sbtest11;+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| id | k | c | pad |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| 1 | 250731 | 68487932199-96439406143-93774651418-41631865787-96406072701-20604855487-25459966574-28203206787-41238978918-19503783441 | 22195207048-70116052123-74140395089-76317954521-98694025897 || 2 | 251240 | 13241531885-45658403807-79170748828-69419634012-13605813761-77983377181-01582588137-21344716829-87370944992-02457486289 | 28733802923-10548894641-11867531929-71265603657-36546888392 || 3 | 249472 | 51185622598-89397522786-28007882305-52050087550-68686337807-48942386476-96555734557-05264042377-33586177817-31986479495 | 00592560354-80393027097-78244247549-39135306455-88936868384 |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+3 rows in set (0.00 sec)root@10.132.2.164 22:33:19 [ptosc_sysbench]&gt; select * from __sbtest11_old;+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| id | k | c | pad |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| 1 | 250731 | 68487932199-96439406143-93774651418-41631865787-96406072701-20604855487-25459966574-28203206787-41238978918-19503783441 | 22195207048-70116052123-74140395089-76317954521-98694025897 || 2 | 251240 | 13241531885-45658403807-79170748828-69419634012-13605813761-77983377181-01582588137-21344716829-87370944992-02457486289 | 28733802923-10548894641-11867531929-71265603657-36546888392 || 3 | 249472 | 51185622598-89397522786-28007882305-52050087550-68686337807-48942386476-96555734557-05264042377-33586177817-31986479495 | 00592560354-80393027097-78244247549-39135306455-88936868384 |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+3 rows in set (0.00 sec) MySQLæ‰§è¡Œ 123456789101112root@localhost 22:31:10 [sysbench]&gt; select * from sbtest11;+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| id | k | c | pad |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| 1 | 250731 | 68487932199-96439406143-93774651418-41631865787-96406072701-20604855487-25459966574-28203206787-41238978918-19503783441 | 22195207048-70116052123-74140395089-76317954521-98694025897 || 2 | 251240 | 13241531885-45658403807-79170748828-69419634012-13605813761-77983377181-01582588137-21344716829-87370944992-02457486289 | 28733802923-10548894641-11867531929-71265603657-36546888392 || 3 | 249472 | 51185622598-89397522786-28007882305-52050087550-68686337807-48942386476-96555734557-05264042377-33586177817-31986479495 | 00592560354-80393027097-78244247549-39135306455-88936868384 |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+3 rows in set (0.00 sec)root@localhost 22:31:14 [sysbench]&gt; delete from sbtest11 where id=2;Query OK, 1 row affected (0.00 sec) TIDBæŸ¥çœ‹ 12345678910111213141516171819root@10.132.2.164 22:33:19 [ptosc_sysbench]&gt; select * from __sbtest11_old;+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| id | k | c | pad |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| 1 | 250731 | 68487932199-96439406143-93774651418-41631865787-96406072701-20604855487-25459966574-28203206787-41238978918-19503783441 | 22195207048-70116052123-74140395089-76317954521-98694025897 || 2 | 251240 | 13241531885-45658403807-79170748828-69419634012-13605813761-77983377181-01582588137-21344716829-87370944992-02457486289 | 28733802923-10548894641-11867531929-71265603657-36546888392 || 3 | 249472 | 51185622598-89397522786-28007882305-52050087550-68686337807-48942386476-96555734557-05264042377-33586177817-31986479495 | 00592560354-80393027097-78244247549-39135306455-88936868384 |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+3 rows in set (0.00 sec)root@10.132.2.164 22:33:24 [ptosc_sysbench]&gt; select * from ptosc_sbtest11;+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| id | k | c | pad |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+| 1 | 250731 | 68487932199-96439406143-93774651418-41631865787-96406072701-20604855487-25459966574-28203206787-41238978918-19503783441 | 22195207048-70116052123-74140395089-76317954521-98694025897 || 3 | 249472 | 51185622598-89397522786-28007882305-52050087550-68686337807-48942386476-96555734557-05264042377-33586177817-31986479495 | 00592560354-80393027097-78244247549-39135306455-88936868384 |+----+--------+-------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------+2 rows in set (0.00 sec) å¦‚æœåªæ˜¯é…ç½® 12345678910[[replicate-do-table]]db-name = &quot;ptosc_sysbench&quot;tbl-name = &quot;ptosc_sbtest11&quot;[[route-rules]]pattern-schema = &quot;sysbench&quot;pattern-table = &quot;sbtest11&quot;target-schema = &quot;ptosc_sysbench&quot;target-table = &quot;ptosc_sbtest11&quot; ä¼šæŠ¥é”™ 12345678910112019/12/03 11:39:13 syncer.go:754: [info] [query]RENAME TABLE `sale_risk_log`.`t_risk_third_request_log` TO `sale_risk_log`.`_t_risk_third_request_log_old`, `sale_risk_log`.`_t_risk_third_request_log_new` TO `sale_risk_log`.`t_risk_third_request_log` [current pos](0022263310-mysql-bin.003273, 481842042) [next pos](0022263310-mysql-bin.003273, 481842397) [current gtid set]2fb23bcc-e5b3-5f84-88ce-15271019b97d:1-2550946489,38f8425e-9182-5934-b32a-7e4317fe4a04:270797037-273174391:5392264317-5392487512,ce9be252-2b71-11e6-b8f4-00212844f856:909572082-909633988:913857848-913889001 [next gtid set]ce9be252-2b71-11e6-b8f4-00212844f856:909572082-909633988:913857848-913889001,2fb23bcc-e5b3-5f84-88ce-15271019b97d:1-2550946490,38f8425e-9182-5934-b32a-7e4317fe4a04:270797037-273174391:5392264317-53924875122019/12/03 11:39:13 syncer.go:795: [info] [ddl][schema]sale_risk_log [start]RENAME TABLE `tidb_sale_risk_log`.`tidb_t_risk_third_request_log` TO `tidb_sale_risk_log`.`_t_risk_third_request_log_old`2019/12/03 11:39:13 db.go:143: [warning] [exec][sql]RENAME TABLE `tidb_sale_risk_log`.`tidb_t_risk_third_request_log` TO `tidb_sale_risk_log`.`_t_risk_third_request_log_old`[args][][error]Error 1050: Table &#x27;tidb_sale_risk_log._t_risk_third_request_log_old&#x27; already exists2019/12/03 11:39:13 db.go:115: [error] [exec][sql][RENAME TABLE `tidb_sale_risk_log`.`tidb_t_risk_third_request_log` TO `tidb_sale_risk_log`.`_t_risk_third_request_log_old`][args][[]][error]Error 1050: Table &#x27;tidb_sale_risk_log._t_risk_third_request_log_old&#x27; already exists2019/12/03 11:39:13 syncer.go:491: [warning] [ignore ddl error][sql]RENAME TABLE `tidb_sale_risk_log`.`tidb_t_risk_third_request_log` TO `tidb_sale_risk_log`.`_t_risk_third_request_log_old`[args][][error]Error 1050: Table &#x27;tidb_sale_risk_log._t_risk_third_request_log_old&#x27; already exists2019/12/03 11:39:13 meta.go:135: [info] save position to file, binlog-name:0022263310-mysql-bin.003273 binlog-pos:481842042 binlog-gtid:ce9be252-2b71-11e6-b8f4-00212844f856:909572082-909633988:913857848-913889001,2fb23bcc-e5b3-5f84-88ce-15271019b97d:1-2550946489,38f8425e-9182-5934-b32a-7e4317fe4a04:270797037-273174391:5392264317-53924875122019/12/03 11:39:13 syncer.go:803: [info] [ddl][end]RENAME TABLE `tidb_sale_risk_log`.`tidb_t_risk_third_request_log` TO `tidb_sale_risk_log`.`_t_risk_third_request_log_old`2019/12/03 11:39:13 syncer.go:795: [info] [ddl][schema]sale_risk_log [start]RENAME TABLE `tidb_sale_risk_log`.`_t_risk_third_request_log_new` TO `tidb_sale_risk_log`.`tidb_t_risk_third_request_log`2019/12/03 11:39:13 db.go:143: [warning] [exec][sql]RENAME TABLE `tidb_sale_risk_log`.`_t_risk_third_request_log_new` TO `tidb_sale_risk_log`.`tidb_t_risk_third_request_log`[args][][error]Error 1017: Can&#x27;t find file: &#x27;./tidb_sale_risk_log/_t_risk_third_request_log_new.frm&#x27;2019/12/03 11:39:13 db.go:115: [error] [exec][sql][RENAME TABLE `tidb_sale_risk_log`.`_t_risk_third_request_log_new` TO `tidb_sale_risk_log`.`tidb_t_risk_third_request_log`][args][[]][error]Error 1017: Can&#x27;t find file: &#x27;./tidb_sale_risk_log/_t_risk_third_request_log_new.frm&#x27;2019/12/03 11:39:13 syncer.go:489: [fatal] [error query event][error type]execution error [sql]RENAME TABLE `tidb_sale_risk_log`.`_t_risk_third_request_log_new` TO `tidb_sale_risk_log`.`tidb_t_risk_third_request_log` [schema]sale_risk_log [table]_t_risk_third_request_log_new [current pos](0022263310-mysql-bin.003273, 481842042) [next pos](0022263310-mysql-bin.003273, 481842397) [current gtid set]2fb23bcc-e5b3-5f84-88ce-15271019b97d:1-2550946489,38f8425e-9182-5934-b32a-7e4317fe4a04:270797037-273174391:5392264317-5392487512,ce9be252-2b71-11e6-b8f4-00212844f856:909572082-909633988:913857848-913889001 [next gtid set]ce9be252-2b71-11e6-b8f4-00212844f856:909572082-909633988:913857848-913889001,2fb23bcc-e5b3-5f84-88ce-15271019b97d:1-2550946490,38f8425e-9182-5934-b32a-7e4317fe4a04:270797037-273174391:5392264317-5392487512 [error message]Error 1017: Can&#x27;t find file: &#x27;./tidb_sale_risk_log/_t_risk_third_request_log_new.frm&#x27;","categories":[],"tags":[{"name":"TiDB","slug":"TiDB","permalink":"http://fuxkdb.com/tags/TiDB/"},{"name":"Syncer","slug":"Syncer","permalink":"http://fuxkdb.com/tags/Syncer/"}]},{"title":"Drainerä¸æ”¯æŒçš„DDL-1","slug":"2019-12-10-Drainerä¸æ”¯æŒçš„DDL-1","date":"2019-12-10T13:23:00.000Z","updated":"2019-12-10T13:52:12.000Z","comments":true,"path":"2019/12/10/2019-12-10-Drainerä¸æ”¯æŒçš„DDL-1/","link":"","permalink":"http://fuxkdb.com/2019/12/10/2019-12-10-Drainer%E4%B8%8D%E6%94%AF%E6%8C%81%E7%9A%84DDL-1/","excerpt":"Drainerä¸æ”¯æŒçš„DDL-1ç‰ˆæœ¬3.0.5 1.rename table t1 to b_db.b_t1å·²ç»åšå¥½TiDB-&gt;MySQLçš„åŒæ­¥, å¼€å¯äº†pump, drainer","text":"Drainerä¸æ”¯æŒçš„DDL-1ç‰ˆæœ¬3.0.5 1.rename table t1 to b_db.b_t1å·²ç»åšå¥½TiDB-&gt;MySQLçš„åŒæ­¥, å¼€å¯äº†pump, drainer é—®é¢˜å¤ç°åœ¨TiDBåˆ›å»ºfanboshiè¡¨ 12345678910111213141516171819202122232425262728293031323334353637383940root@10.152.x.150 17:53:27 [sysbench]&gt; show tables;ERROR 2006 (HY000): MySQL server has gone awayNo connection. Trying to reconnect...Connection id: 76Current database: sysbench+--------------------+| Tables_in_sysbench |+--------------------+| sbtest1 || sbtest10 || sbtest2 || sbtest3 || sbtest4 || sbtest5 || sbtest6 || sbtest7 || sbtest8 || sbtest9 |+--------------------+10 rows in set (0.01 sec)root@10.152.x.150 18:31:19 [sysbench]&gt; create table fanboshi like sbtest1;Query OK, 0 rows affected (0.13 sec)root@10.152.x.150 18:31:24 [sysbench]&gt; select count(*) from sbtest1;+----------+| count(*) |+----------+| 500456 |+----------+1 row in set (0.31 sec)root@10.152.x.150 18:31:42 [sysbench]&gt; select count(*) from sbtest1;+----------+| count(*) |+----------+| 500757 |+----------+1 row in set (0.30 sec) åœ¨ä¸‹æ¸¸MySQLæŸ¥çœ‹, åŒæ­¥æ²¡æœ‰é—®é¢˜ 12345678910111213141516171819202122232425root@localhost 18:59:35 [sysbench]&gt; show tables;+--------------------+| Tables_in_sysbench |+--------------------+| fanboshi || sbtest1 || sbtest10 || sbtest2 || sbtest3 || sbtest4 || sbtest5 || sbtest6 || sbtest7 || sbtest8 || sbtest9 |+--------------------+11 rows in set (0.00 sec)root@localhost 18:59:37 [sysbench]&gt; select count(*) from sbtest1;+----------+| count(*) |+----------+| 500757 |+----------+1 row in set (0.13 sec) åœ¨TiDBæ‰§è¡Œ 12345root@10.152.x.150 18:57:59 [sysbench]&gt; create database tidb_sysbench;Query OK, 0 rows affected (0.10 sec)root@10.152.x.150 18:58:09 [sysbench]&gt; rename table fanboshi to tidb_sysbench.tidb_fanboshi;Query OK, 0 rows affected (0.10 sec) DraineræŠ¥é”™é€€å‡º 123456789101112131415161718192021[2019/12/02 18:59:14.979 +08:00] [INFO] [collector.go:284] [&quot;get ddl job&quot;] [job=&quot;ID:79, Type:rename table, State:synced, SchemaState:public, SchemaID:77, TableID:75, RowCount:0, ArgLen:0, start time: 2019-12-02 18:59:14.012 +0800 CST, Err:&lt;nil&gt;, ErrCount:0, SnapshotVersion:0&quot;][2019/12/02 18:59:14.979 +08:00] [INFO] [syncer.go:400] [&quot;add ddl item to syncer, you can add this commit ts to `ignore-txn-commit-ts` to skip this ddl if needed&quot;] [sql=&quot;rename table fanboshi to tidb_sysbench.tidb_fanboshi&quot;] [&quot;commit ts&quot;=412951341698121738][2019/12/02 18:59:19.993 +08:00] [ERROR] [load.go:594] [&quot;exec failed&quot;] [sql=&quot;rename table fanboshi to tidb_sysbench.tidb_fanboshi&quot;] [error=&quot;Error 1017: Can&#x27;t find file: &#x27;./tidb_sysbench/fanboshi.frm&#x27; (errno: 2 - No such file or directory)&quot;] [errorVerbose=&quot;Error 1017: Can&#x27;t find file: &#x27;./tidb_sysbench/fanboshi.frm&#x27; (errno: 2 - No such file or directory)\\ngithub.com/pingcap/errors.AddStack\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/errors.go:174\\ngithub.com/pingcap/errors.Trace\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/juju_adaptor.go:15\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*loaderImpl).execDDL\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:337\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*batchManager).execDDL\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:592\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*batchManager).put\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:615\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*loaderImpl).Run\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:478\\ngithub.com/pingcap/tidb-binlog/drainer/sync.(*MysqlSyncer).run\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/drainer/sync/mysql.go:121\\nruntime.goexit\\n\\t/usr/local/go/src/runtime/asm_amd64.s:1337&quot;][2019/12/02 18:59:19.994 +08:00] [INFO] [load.go:435] [&quot;Run()... in Loader quit&quot;][2019/12/02 18:59:19.994 +08:00] [INFO] [load.go:715] [&quot;txnManager has been closed&quot;][2019/12/02 18:59:19.994 +08:00] [INFO] [load.go:659] [&quot;run()... in txnManager quit&quot;][2019/12/02 18:59:19.994 +08:00] [INFO] [mysql.go:117] [&quot;Successes chan quit&quot;][2019/12/02 18:59:19.994 +08:00] [INFO] [syncer.go:251] [&quot;write save point&quot;] [ts=412951341357334529][2019/12/02 18:59:19.994 +08:00] [ERROR] [syncer.go:416] [&quot;Failed to close syncer&quot;] [error=&quot;Error 1017: Can&#x27;t find file: &#x27;./tidb_sysbench/fanboshi.frm&#x27; (errno: 2 - No such file or directory)&quot;] [errorVerbose=&quot;Error 1017: Can&#x27;t find file: &#x27;./tidb_sysbench/fanboshi.frm&#x27; (errno: 2 - No such file or directory)\\ngithub.com/pingcap/errors.AddStack\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/errors.go:174\\ngithub.com/pingcap/errors.Trace\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/juju_adaptor.go:15\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*loaderImpl).execDDL\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:337\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*batchManager).execDDL\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:592\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*batchManager).put\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:615\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*loaderImpl).Run\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:478\\ngithub.com/pingcap/tidb-binlog/drainer/sync.(*MysqlSyncer).run\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/drainer/sync/mysql.go:121\\nruntime.goexit\\n\\t/usr/local/go/src/runtime/asm_amd64.s:1337&quot;][2019/12/02 18:59:19.996 +08:00] [INFO] [syncer.go:243] [&quot;handleSuccess quit&quot;][2019/12/02 18:59:19.996 +08:00] [ERROR] [server.go:270] [&quot;syncer exited abnormal&quot;] [error=&quot;Error 1017: Can&#x27;t find file: &#x27;./tidb_sysbench/fanboshi.frm&#x27; (errno: 2 - No such file or directory)&quot;] [errorVerbose=&quot;Error 1017: Can&#x27;t find file: &#x27;./tidb_sysbench/fanboshi.frm&#x27; (errno: 2 - No such file or directory)\\ngithub.com/pingcap/errors.AddStack\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/errors.go:174\\ngithub.com/pingcap/errors.Trace\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/juju_adaptor.go:15\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*loaderImpl).execDDL\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:337\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*batchManager).execDDL\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:592\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*batchManager).put\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:615\\ngithub.com/pingcap/tidb-binlog/pkg/loader.(*loaderImpl).Run\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/loader/load.go:478\\ngithub.com/pingcap/tidb-binlog/drainer/sync.(*MysqlSyncer).run\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/drainer/sync/mysql.go:121\\nruntime.goexit\\n\\t/usr/local/go/src/runtime/asm_amd64.s:1337&quot;][2019/12/02 18:59:19.997 +08:00] [INFO] [util.go:66] [Exit] [name=syncer][2019/12/02 18:59:19.997 +08:00] [INFO] [server.go:406] [&quot;begin to close drainer server&quot;][2019/12/02 18:59:20.001 +08:00] [INFO] [server.go:371] [&quot;has already update status&quot;] [id=knode10-152-1-166:8249][2019/12/02 18:59:20.001 +08:00] [INFO] [server.go:410] [&quot;commit status done&quot;][2019/12/02 18:59:20.001 +08:00] [INFO] [util.go:66] [Exit] [name=heartbeat][2019/12/02 18:59:20.001 +08:00] [INFO] [collector.go:130] [&quot;publishBinlogs quit&quot;][2019/12/02 18:59:20.001 +08:00] [INFO] [pump.go:72] [&quot;pump is closing&quot;] [id=knode10-152-1-166:8250][2019/12/02 18:59:20.001 +08:00] [INFO] [pump.go:72] [&quot;pump is closing&quot;] [id=knode10-152-1-150:8250][2019/12/02 18:59:20.001 +08:00] [INFO] [util.go:66] [Exit] [name=collect][2019/12/02 18:59:20.001 +08:00] [INFO] [main.go:73] [&quot;drainer exit&quot;] é—®é¢˜ä¿®å¤å‚è€ƒåŒæ­¥æ—¶å‡ºç°ä¸Šæ¸¸æ•°æ®åº“æ”¯æŒä½†æ˜¯ä¸‹æ¸¸æ•°æ®åº“æ‰§è¡Œä¼šå‡ºé”™çš„ DDLï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ) æ ¹æ®drainer.logä¸­çš„æ—¥å¿—ä¿¡æ¯æˆ‘ä»¬è·å–è¿™ä¸ªddlçš„commit tsä¸º412951341698121738 åœ¨ä¸­æ§æœºé…ç½®æ–‡ä»¶æˆ–è€…ç›´æ¥åœ¨draineræ‰€å±æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ä¸­ç›´æ¥ä¿®æ”¹éƒ½å¯ä»¥, æˆ‘è¿™é‡Œåœ¨ä¸­æ§æœºä¿®æ”¹, å› ä¸ºæˆ‘åªæœ‰ä¸€ä¸ªdrainer. å¦‚æœæœ‰å¤šä¸ªdrainerå»ºè®®åœ¨draineræœåŠ¡å™¨ä¿®æ”¹é…ç½®æ–‡ä»¶ 1.æ·»åŠ è¦å¿½ç•¥çš„commit-ts 12# ignore syncing the txn with specified commit ts to downstreamignore-txn-commit-ts = [412951341698121738] æ³¨æ„è¿™ä¸ªåº”è¯¥å¡«å†™integer, å¦‚æœå¡«å†™ä¸º&quot;412951341698121738&quot;drainerä¼šèµ·ä¸æ¥, è€Œä¸”ä½¿ç”¨systemctl start drainer-8249.serviceæ— ä»»ä½•é”™è¯¯æç¤º/DATA1/deploy/log/drainer_stderr.logæ—¥å¿—ä¸šåŠ¡å†…å®¹ 12345678910111213141516171819202122232425[root@knode10-152-1-166 deploy]# cat /etc/systemd/system/drainer-8249.service [Unit]Description=drainer-8249 serviceAfter=syslog.target network.target remote-fs.target nss-lookup.target[Service]LimitNOFILE=1000000#LimitCORE=infinityLimitSTACK=10485760User=tidbExecStart=/DATA1/deploy/scripts/run_drainer.shRestart=on-failureRestartSec=15sSendSIGKILL=no[Install]WantedBy=multi-user.target[root@knode10-152-1-166 deploy]# ./bin/drainer --addr=&quot;10.152.x.166:8249&quot; --pd-urls=&quot;http://10.152.x.152:2379,http://10.152.x.146:2379,http://10.152.x.147:2379&quot; --data-dir=&quot;/DATA1/deploy/data.drainer&quot; --log-file=&quot;/DATA1/deploy/log/drainer.log&quot; --config=conf/drainer.toml --initial-commit-ts=&quot;412950687779913731&quot; 2&gt;&gt; &quot;/DATA1/deploy/log/drainer_stderr.log&quot;[2019/12/02 19:17:35.996 +08:00] [FATAL] [main.go:39] [&quot;verifying flags failed, See &#x27;drainer --help&#x27;.&quot;] [error=&quot;toml: cannot load TOML value of type string into a Go integer&quot;] [errorVerbose=&quot;toml: cannot load TOML value of type string into a Go integer\\ngithub.com/pingcap/errors.AddStack\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/errors.go:174\\ngithub.com/pingcap/errors.Trace\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/errors@v0.11.4/juju_adaptor.go:15\\ngithub.com/pingcap/tidb-binlog/pkg/util.StrictDecodeFile\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/pkg/util/util.go:188\\ngithub.com/pingcap/tidb-binlog/drainer.(*Config).configFromFile\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/drainer/config.go:226\\ngithub.com/pingcap/tidb-binlog/drainer.(*Config).Parse\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/drainer/config.go:169\\nmain.main\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/cmd/drainer/main.go:38\\nruntime.main\\n\\t/usr/local/go/src/runtime/proc.go:200\\nruntime.goexit\\n\\t/usr/local/go/src/runtime/asm_amd64.s:1337&quot;] [stack=&quot;github.com/pingcap/log.Fatal\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/pkg/mod/github.com/pingcap/log@v0.0.0-20190715063458-479153f07ebd/global.go:59\\nmain.main\\n\\t/home/jenkins/agent/workspace/release_tidb_3.0/go/src/github.com/pingcap/tidb-binlog/cmd/drainer/main.go:39\\nruntime.main\\n\\t/usr/local/go/src/runtime/proc.go:200&quot;]æŸ¥çœ‹æ—¥å¿—æ— å†…å®¹[root@knode10-152-1-166 deploy]# cat /DATA1/deploy/log/drainer_stderr.log[root@knode10-152-1-166 deploy]# 2.åœ¨MySQLæ‰‹åŠ¨æ‰§è¡Œå¤±è´¥çš„DDLè¯­å¥ 12root@localhost 19:09:27 [sysbench]&gt; rename table fanboshi to tidb_sysbench.tidb_fanboshi;Query OK, 0 rows affected (0.00 sec) 3.å¯åŠ¨drainer 1234567891011121314151617181920212223242526272829systemctl start drainer-8249.service [2019/12/02 19:19:26.473 +08:00] [INFO] [version.go:50] [&quot;Welcome to Drainer&quot;] [&quot;Release Version&quot;=v3.0.5] [&quot;Git Commit Hash&quot;=88e58f165b6556ba084761c35b4be6db164a5c06] [&quot;Build TS&quot;=&quot;2019-10-25 03:24:55&quot;] [&quot;Go Version&quot;=go1.12] [&quot;Go OS/Arch&quot;=linux/amd64][2019/12/02 19:19:26.474 +08:00] [INFO] [main.go:46] [&quot;start drainer...&quot;] [config=&quot;&#123;\\&quot;log-level\\&quot;:\\&quot;info\\&quot;,\\&quot;node-id\\&quot;:\\&quot;\\&quot;,\\&quot;addr\\&quot;:\\&quot;http://10.152.x.166:8249\\&quot;,\\&quot;advertise-addr\\&quot;:\\&quot;http://10.152.x.166:8249\\&quot;,\\&quot;data-dir\\&quot;:\\&quot;/DATA1/deploy/data.drainer\\&quot;,\\&quot;detect-interval\\&quot;:10,\\&quot;pd-urls\\&quot;:\\&quot;http://10.152.x.152:2379,http://10.152.x.146:2379,http://10.152.x.147:2379\\&quot;,\\&quot;log-file\\&quot;:\\&quot;/DATA1/deploy/log/drainer.log\\&quot;,\\&quot;initial-commit-ts\\&quot;:412950687779913731,\\&quot;sycner\\&quot;:&#123;\\&quot;sql-mode\\&quot;:null,\\&quot;ignore-txn-commit-ts\\&quot;:[412951341698121738],\\&quot;ignore-schemas\\&quot;:\\&quot;INFORMATION_SCHEMA,PERFORMANCE_SCHEMA,mysql\\&quot;,\\&quot;ignore-table\\&quot;:null,\\&quot;txn-batch\\&quot;:20,\\&quot;worker-count\\&quot;:4,\\&quot;to\\&quot;:&#123;\\&quot;host\\&quot;:\\&quot;10.133.1.52\\&quot;,\\&quot;user\\&quot;:\\&quot;drainer\\&quot;,\\&quot;password\\&quot;:\\&quot;drainer123\\&quot;,\\&quot;port\\&quot;:3308,\\&quot;checkpoint\\&quot;:&#123;\\&quot;schema\\&quot;:\\&quot;\\&quot;&#125;,\\&quot;dir\\&quot;:\\&quot;\\&quot;,\\&quot;time-limit\\&quot;:\\&quot;\\&quot;,\\&quot;size-limit\\&quot;:\\&quot;\\&quot;,\\&quot;zookeeper-addrs\\&quot;:\\&quot;\\&quot;,\\&quot;kafka-addrs\\&quot;:\\&quot;\\&quot;,\\&quot;kafka-version\\&quot;:\\&quot;\\&quot;,\\&quot;kafka-max-messages\\&quot;:0,\\&quot;topic-name\\&quot;:\\&quot;\\&quot;&#125;,\\&quot;replicate-do-table\\&quot;:null,\\&quot;replicate-do-db\\&quot;:null,\\&quot;db-type\\&quot;:\\&quot;mysql\\&quot;,\\&quot;disable-dispatch\\&quot;:false,\\&quot;safe-mode\\&quot;:false,\\&quot;disable-detect\\&quot;:false&#125;,\\&quot;security\\&quot;:&#123;\\&quot;ssl-ca\\&quot;:\\&quot;\\&quot;,\\&quot;ssl-cert\\&quot;:\\&quot;\\&quot;,\\&quot;ssl-key\\&quot;:\\&quot;\\&quot;&#125;,\\&quot;synced-check-time\\&quot;:5,\\&quot;compressor\\&quot;:\\&quot;\\&quot;,\\&quot;EtcdTimeout\\&quot;:5000000000,\\&quot;MetricsAddr\\&quot;:\\&quot;\\&quot;,\\&quot;MetricsInterval\\&quot;:15&#125;&quot;][2019/12/02 19:19:26.474 +08:00] [INFO] [client.go:144] [&quot;[pd] create pd client with endpoints&quot;] [pd-address=&quot;[http://10.152.x.146:2379,http://10.152.x.147:2379,http://10.152.x.152:2379]&quot;][2019/12/02 19:19:26.483 +08:00] [INFO] [client.go:252] [&quot;[pd] switch leader&quot;] [new-leader=http://10.152.x.152:2379] [old-leader=][2019/12/02 19:19:26.484 +08:00] [INFO] [client.go:163] [&quot;[pd] init cluster id&quot;] [cluster-id=6751370831202615818][2019/12/02 19:19:26.484 +08:00] [INFO] [server.go:111] [&quot;get cluster id from pd&quot;] [id=6751370831202615818][2019/12/02 19:19:26.491 +08:00] [INFO] [checkpoint.go:65] [&quot;initialize checkpoint&quot;] [name=mysql] [checkpoint=412951341357334529] [cfg=&quot;&#123;\\&quot;Db\\&quot;:&#123;\\&quot;host\\&quot;:\\&quot;10.133.1.52\\&quot;,\\&quot;user\\&quot;:\\&quot;drainer\\&quot;,\\&quot;password\\&quot;:\\&quot;drainer123\\&quot;,\\&quot;port\\&quot;:3308&#125;,\\&quot;Schema\\&quot;:\\&quot;tidb_binlog\\&quot;,\\&quot;Table\\&quot;:\\&quot;checkpoint\\&quot;,\\&quot;ClusterID\\&quot;:6751370831202615818,\\&quot;InitialCommitTS\\&quot;:412950687779913731,\\&quot;dir\\&quot;:\\&quot;/DATA1/deploy/data.drainer/savepoint\\&quot;&#125;&quot;][2019/12/02 19:19:26.491 +08:00] [INFO] [store.go:69] [&quot;new store&quot;] [path=&quot;tikv://10.152.x.146:2379,10.152.x.147:2379,10.152.x.152:2379?disableGC=true&quot;][2019/12/02 19:19:26.491 +08:00] [INFO] [client.go:144] [&quot;[pd] create pd client with endpoints&quot;] [pd-address=&quot;[10.152.x.146:2379,10.152.x.147:2379,10.152.x.152:2379]&quot;][2019/12/02 19:19:26.495 +08:00] [INFO] [client.go:252] [&quot;[pd] switch leader&quot;] [new-leader=http://10.152.x.152:2379] [old-leader=][2019/12/02 19:19:26.496 +08:00] [INFO] [client.go:163] [&quot;[pd] init cluster id&quot;] [cluster-id=6751370831202615818][2019/12/02 19:19:26.497 +08:00] [INFO] [store.go:75] [&quot;new store with retry success&quot;][2019/12/02 19:19:26.517 +08:00] [INFO] [store.go:69] [&quot;new store&quot;] [path=&quot;tikv://10.152.x.146:2379,10.152.x.147:2379,10.152.x.152:2379?disableGC=true&quot;][2019/12/02 19:19:26.518 +08:00] [INFO] [client.go:144] [&quot;[pd] create pd client with endpoints&quot;] [pd-address=&quot;[10.152.x.146:2379,10.152.x.147:2379,10.152.x.152:2379]&quot;][2019/12/02 19:19:26.521 +08:00] [INFO] [client.go:252] [&quot;[pd] switch leader&quot;] [new-leader=http://10.152.x.152:2379] [old-leader=][2019/12/02 19:19:26.521 +08:00] [INFO] [client.go:163] [&quot;[pd] init cluster id&quot;] [cluster-id=6751370831202615818][2019/12/02 19:19:26.522 +08:00] [INFO] [store.go:75] [&quot;new store with retry success&quot;][2019/12/02 19:19:26.533 +08:00] [INFO] [server.go:246] [&quot;register success&quot;] [&quot;drainer node id&quot;=knode10-152-1-166:8249][2019/12/02 19:19:26.533 +08:00] [INFO] [server.go:296] [&quot;start to server request&quot;] [addr=http://10.152.x.166:8249][2019/12/02 19:19:26.537 +08:00] [INFO] [merge.go:222] [&quot;merger add source&quot;] [&quot;source id&quot;=knode10-152-1-150:8250][2019/12/02 19:19:26.537 +08:00] [INFO] [merge.go:222] [&quot;merger add source&quot;] [&quot;source id&quot;=knode10-152-1-166:8250][2019/12/02 19:19:26.537 +08:00] [INFO] [pump.go:133] [&quot;pump create pull binlogs client&quot;] [id=knode10-152-1-166:8250][2019/12/02 19:19:26.537 +08:00] [INFO] [pump.go:133] [&quot;pump create pull binlogs client&quot;] [id=knode10-152-1-150:8250][2019/12/02 19:19:27.545 +08:00] [INFO] [collector.go:284] [&quot;get ddl job&quot;] [job=&quot;ID:79, Type:rename table, State:synced, SchemaState:public, SchemaID:77, TableID:75, RowCount:0, ArgLen:0, start time: 2019-12-02 18:59:14.012 +0800 CST, Err:&lt;nil&gt;, ErrCount:0, SnapshotVersion:0&quot;][2019/12/02 19:19:27.545 +08:00] [WARN] [syncer.go:317] [&quot;skip txn&quot;] [binlog=&quot;tp:Commit start_ts:412951341698121737 commit_ts:412951341698121738 prewrite_key:\\&quot;mDB:43\\\\000\\\\000\\\\000\\\\374\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000H\\&quot; ddl_query:\\&quot;rename table fanboshi to tidb_sysbench.tidb_fanboshi\\&quot; ddl_job_id:79 &quot;][2019/12/02 19:19:30.855 +08:00] [INFO] [syncer.go:251] [&quot;write save point&quot;] [ts=412951660163760129] 5.éªŒè¯åŒæ­¥ 123456789101112131415[root@node10-133-1-59 fanboshi]# sh sysbench_tidb_run.sh sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)Running the test with following options:Number of threads: 4Report intermediate results every 5 second(s)Initializing random number generator from current timeInitializing worker threads...Threads started![ 5s ] thds: 4 tps: 130.27 qps: 2613.67 (r/w/o: 1830.43/133.87/649.37) lat (ms,95%): 38.94 err/s: 0.00 reconn/s: 0.00[ 10s ] thds: 4 tps: 136.41 qps: 2733.37 (r/w/o: 1913.32/141.41/678.64) lat (ms,95%): 37.56 err/s: 0.00 reconn/s: 0.00 TiDB 1234567root@10.152.x.150 19:20:43 [sysbench]&gt; select count(*) from sbtest1;+----------+| count(*) |+----------+| 500882 |+----------+1 row in set (0.27 sec) ä¸‹æ¸¸MySQL 123456789101112131415root@localhost 19:20:08 [sysbench]&gt; select count(*) from sbtest1;+----------+| count(*) |+----------+| 500757 |+----------+1 row in set (0.12 sec)root@localhost 19:20:13 [sysbench]&gt; select count(*) from sbtest1;+----------+| count(*) |+----------+| 500882 |+----------+1 row in set (0.11 sec) åŒæ­¥æ¢å¤","categories":[],"tags":[{"name":"TiDB","slug":"TiDB","permalink":"http://fuxkdb.com/tags/TiDB/"},{"name":"Drainer","slug":"Drainer","permalink":"http://fuxkdb.com/tags/Drainer/"}]},{"title":"MGRå‚æ•°ä¹‹group_replication_ip_whitelist","slug":"2019-12-10-MGRå‚æ•°ä¹‹group_replication_ip_whitelist","date":"2019-12-10T09:45:00.000Z","updated":"2019-12-10T09:46:24.000Z","comments":true,"path":"2019/12/10/2019-12-10-MGRå‚æ•°ä¹‹group_replication_ip_whitelist/","link":"","permalink":"http://fuxkdb.com/2019/12/10/2019-12-10-MGR%E5%8F%82%E6%95%B0%E4%B9%8Bgroup_replication_ip_whitelist/","excerpt":"å°è¯•å°†10.133.1.46åŠ å…¥192.168.2.224çš„é›†ç¾¤å¤±è´¥ éœ€è¦è®¾ç½®å‚æ•°group_replication_ip_whitelist æ­¤å‚æ•°è™½ç„¶æ˜¯åŠ¨æ€å‚æ•°, ä½†æ˜¯è¦ä½¿ä¹‹ç”Ÿæ•ˆéœ€è¦èŠ‚ç‚¹é‡æ–°åŠ å…¥é›†ç¾¤ To specify a whitelist manually, use the group_replication_ip_whitelist option. You cannot change the whitelist on a server while it is an active member of a replication group. If the member is active, you must issue a STOP GROUP_REPLICATION statement before changing the whitelist, and a START GROUP_REPLICATION statement afterwards.","text":"å°è¯•å°†10.133.1.46åŠ å…¥192.168.2.224çš„é›†ç¾¤å¤±è´¥ éœ€è¦è®¾ç½®å‚æ•°group_replication_ip_whitelist æ­¤å‚æ•°è™½ç„¶æ˜¯åŠ¨æ€å‚æ•°, ä½†æ˜¯è¦ä½¿ä¹‹ç”Ÿæ•ˆéœ€è¦èŠ‚ç‚¹é‡æ–°åŠ å…¥é›†ç¾¤ To specify a whitelist manually, use the group_replication_ip_whitelist option. You cannot change the whitelist on a server while it is an active member of a replication group. If the member is active, you must issue a STOP GROUP_REPLICATION statement before changing the whitelist, and a START GROUP_REPLICATION statement afterwards. 1234set global group_replication_ip_whitelist = &#x27;192.168.0.0/16,10.0.0.0/8&#x27;;my.cnf æ·»åŠ loose_group_replication_ip_whitelist = &#x27;192.168.0.0/16,10.0.0.0/8&#x27; Aç±»IPåœ°å€çš„é»˜è®¤å­ç½‘æ©ç ä¸º255.0.0.0ï¼ˆç”±äº255ç›¸å½“äºäºŒè¿›åˆ¶çš„8ä½1ï¼Œæ‰€ä»¥ä¹Ÿç¼©å†™æˆâ€œ/8â€ï¼Œè¡¨ç¤ºç½‘ç»œå·å äº†8ä½ï¼‰;Bç±»çš„ä¸º255.255.0.0ï¼ˆ/16ï¼‰;Cç±»çš„ä¸º255.255.255.0(/24)ã€‚/30å°±æ˜¯255.255.255.252ã€‚32å°±æ˜¯255.255.255.255. æ³¨æ„è¿™é‡Œçš„16, 24ä¸æ˜¯çœ‹ip aé‡Œçš„å€¼ 123set global group_replication_ip_whitelist = &#x27;192.168.0.0/16,10.0.0.0/8&#x27;; 10.x.x.xéƒ½å¯ä»¥set global group_replication_ip_whitelist = &#x27;192.168.0.0/16,10.133.0.0/16&#x27;; 10.133.x.xéƒ½å¯ä»¥set global group_replication_ip_whitelist = &#x27;192.168.0.0/16,10.133.1.0/24&#x27;; 10.133.1.xéƒ½å¯ä»¥ ç›¸å…³å¼‚å¸¸ 123456 [ERROR] Plugin group_replication reported: &#x27;[GCS] The member was unable to join the group. Local port: 23307&#x27; 2019-12-09T08:18:18.804055Z 0 [Warning] Plugin group_replication reported: &#x27;[GCS] Connection attempt from IP address 10.133.1.37 refused. Address is not in the IP whitelist.&#x27;2019-12-09T08:18:18.804092Z 0 [ERROR] Plugin group_replication reported: &#x27;[GCS] Error connecting to the local group communication engine instance.&#x27;2019-12-09T08:18:18.922608Z 0 [ERROR] Plugin group_replication reported: &#x27;[GCS] The member was unable to join the group. Local port: 23307&#x27; æ³¨æ„è¦åŠ å…¥çš„èŠ‚ç‚¹çš„group_replication_group_seedsä¸€å®šè¦æŠŠè®¾ç½®å¥½group_replication_ip_whitelistçš„èŠ‚ç‚¹å†™åœ¨æœ€å‰é¢,æˆ–è€…åˆ æ‰æ²¡æœ‰è®¾ç½®å¥½group_replication_ip_whitelistçš„èŠ‚ç‚¹, å¦åˆ™ä¼šä¸€ç›´æŠ¥é”™ 1[ERROR] Plugin group_replication reported: &#x27;[GCS] The member was unable to join the group. Local port: 23307&#x27; ä¸¾ä¾‹å­ 123192.168.2.224 group_replication_ip_whitelist=&#x27;&#x27;;192.168.2.225 group_replication_ip_whitelist=&#x27;192.168.0.0/16,10.133.0.0/16&#x27;;192.168.2.226 group_replication_ip_whitelist=&#x27;192.168.0.0/16,10.133.0.0/16&#x27;; è¦æŠŠ10.133.1.46åŠ å…¥é›†ç¾¤, è€Œå®ƒçš„group_replication_group_seedsä¸º192.168.2.224:23310,192.168.2.225:23310,192.168.2.226:23310 é‚£ä¹ˆå®ƒä¼šä¸€ç›´æŠ¥é”™æ— æ³•åŠ å…¥é›†ç¾¤ åŒæ—¶192.168.2.224ä¼šæŠ¥ åŸå› å°±æ˜¯224æ˜¯10.133.1.46çš„group_replication_group_seedsçš„ç¬¬ä¸€ä¸ªâ€¦","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MGR","slug":"MGR","permalink":"http://fuxkdb.com/tags/MGR/"}]},{"title":"TiDB Binlogéƒ¨ç½²","slug":"2019-12-02-TiDB-Binlogéƒ¨ç½²","date":"2019-12-02T11:31:00.000Z","updated":"2019-12-02T11:36:03.000Z","comments":true,"path":"2019/12/02/2019-12-02-TiDB-Binlogéƒ¨ç½²/","link":"","permalink":"http://fuxkdb.com/2019/12/02/2019-12-02-TiDB-Binlog%E9%83%A8%E7%BD%B2/","excerpt":"TiDB Binlogéƒ¨ç½²ç¯å¢ƒä¿¡æ¯ä¸­æ§æœºæ˜¯10.152.x.133 123456789101112131415161718192021222324252627282930313233[tidb_servers]10.152.x.1010.152.x.1110.152.x.12[tikv_servers]10.152.x.1010.152.x.1110.152.x.12[pd_servers]10.152.x.1010.152.x.1110.152.x.12## Monitoring Part# prometheus and pushgateway servers[monitoring_servers]10.152.x.133[grafana_servers]10.152.x.133# node_exporter and blackbox_exporter servers[monitored_servers]10.152.x.1010.152.x.1110.152.x.1210.152.x.133[alertmanager_servers]10.152.x.133","text":"TiDB Binlogéƒ¨ç½²ç¯å¢ƒä¿¡æ¯ä¸­æ§æœºæ˜¯10.152.x.133 123456789101112131415161718192021222324252627282930313233[tidb_servers]10.152.x.1010.152.x.1110.152.x.12[tikv_servers]10.152.x.1010.152.x.1110.152.x.12[pd_servers]10.152.x.1010.152.x.1110.152.x.12## Monitoring Part# prometheus and pushgateway servers[monitoring_servers]10.152.x.133[grafana_servers]10.152.x.133# node_exporter and blackbox_exporter servers[monitored_servers]10.152.x.1010.152.x.1110.152.x.1210.152.x.133[alertmanager_servers]10.152.x.133 å…ˆé€ ç‚¹æ•°æ® 12345678yum install sysbench -ymysql -uroot -p -h10.152.x.10 -P4000 -e&quot;create database sysbench&quot;sysbench /usr/share/sysbench/oltp_read_write.lua --mysql-user=root --mysql-password=supersecret --mysql-port=4000 \\--mysql-host=10.152.x.10 \\--mysql-db=sysbench --tables=10 --table-size=5000 --threads=4 \\--events=5000 --report-interval=5 --db-driver=mysql prepare éƒ¨ç½²Pump1.ä¿®æ”¹ tidb-ansible/inventory.ini æ–‡ä»¶ è®¾ç½® enable_binlog = Trueï¼Œè¡¨ç¤º TiDB é›†ç¾¤å¼€å¯ binlog 12## binlog triggerenable_binlog = True 2.ä¸º pump_servers ä¸»æœºç»„æ·»åŠ éƒ¨ç½²æœºå™¨ IP 1234[pump_serverspump1 ansible_host=10.152.x.10pump2 ansible_host=10.152.x.11pump3 ansible_host=10.152.x.12 å¦‚æœæƒ³è¦ä¸ºpumpä¸“é—¨æŒ‡å®šç›®å½•, å¯ä»¥ä½¿ç”¨deploy_dir 123pump1 ansible_host=10.152.x.10 deploy_dir=/data1/pumppump2 ansible_host=10.152.x.11 deploy_dir=/data2/pumppump3 ansible_host=10.152.x.12 deploy_dir=/data3/pump é»˜è®¤ Pump ä¿ç•™ 7 å¤©æ•°æ®ï¼Œå¦‚éœ€ä¿®æ”¹å¯ä¿®æ”¹ tidb-ansible/conf/pump.ymlï¼ˆTiDB 3.0.2 åŠä¹‹å‰ç‰ˆæœ¬ä¸­ä¸º tidb-ansible/conf/pump-cluster.ymlï¼‰æ–‡ä»¶ä¸­ gc å˜é‡å€¼ï¼Œå¹¶å–æ¶ˆæ³¨é‡Šã€‚ 1234global: # an integer value to control the expiry date of the binlog data, which indicates for how long (in days) the binlog data would be stored # must be bigger than 0 # gc: 7 3.éƒ¨ç½² pump_servers å’Œ node_exporters 1ansible-playbook deploy.yml --tags=pump -l pump1,pump2,pump3 å¦‚æœæ²¡æœ‰ä¸ºpumpæŒ‡å®šåˆ«ååˆ™ä¸º ansible-playbook deploy.yml â€“tags=pump -l 10.152.x.10,10.152.x.11,10.152.x.12 ä»¥ä¸Šå‘½ä»¤ä¸­ï¼Œé€—å·åä¸è¦åŠ ç©ºæ ¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ 4.å¯åŠ¨ pump_servers 1ansible-playbook start.yml --tags=pump æŸ¥çœ‹ä¸€ä¸‹ 123# ps -ef| grep pumptidb 26199 1 0 21:05 ? 00:00:00 bin/pump --addr=0.0.0.0:8250 --advertise-addr=pump1:8250 --pd-urls=http://10.152.x.10:2379,http://10.152.x.11:2379,http://10.152.x.12:2379 --data-dir=/DATA1/home/tidb/deploy/data.pump --log-file=/DATA1/home/tidb/deploy/log/pump.log --config=conf/pump.toml 5.æ›´æ–°å¹¶é‡å¯ tidb_servers ä¸ºäº†è®©enable_binlog = Trueç”Ÿæ•ˆ 12ansible-playbook rolling_update.yml --tags=tidb 6.æ›´æ–°ç›‘æ§ä¿¡æ¯ 12ansible-playbook rolling_update_monitor.yml --tags=prometheus 7.æŸ¥çœ‹ Pump æœåŠ¡çŠ¶æ€ ä½¿ç”¨ binlogctl æŸ¥çœ‹ Pump æœåŠ¡çŠ¶æ€ï¼Œpd-urls å‚æ•°è¯·æ›¿æ¢ä¸ºé›†ç¾¤ PD åœ°å€ï¼Œç»“æœ State ä¸º online è¡¨ç¤º Pump å¯åŠ¨æˆåŠŸ 12345$resources/bin/binlogctl -pd-urls=http://10.152.x.10:2379 -cmd pumps[2019/12/01 21:11:47.655 +08:00] [INFO] [nodes.go:49] [&quot;query node&quot;] [type=pump] [node=&quot;&#123;NodeID: knode10-152-x-12:8250, Addr: pump3:8250, State: online, MaxCommitTS: 412930776489787394, UpdateTime: 2019-12-01 21:11:45 +0800 CST&#125;&quot;][2019/12/01 21:11:47.655 +08:00] [INFO] [nodes.go:49] [&quot;query node&quot;] [type=pump] [node=&quot;&#123;NodeID: knode10-152-x-10:8250, Addr: pump1:8250, State: online, MaxCommitTS: 412930776463572993, UpdateTime: 2019-12-01 21:11:45 +0800 CST&#125;&quot;][2019/12/01 21:11:47.655 +08:00] [INFO] [nodes.go:49] [&quot;query node&quot;] [type=pump] [node=&quot;&#123;NodeID: knode10-152-x-11:8250, Addr: pump2:8250, State: online, MaxCommitTS: 412930776489787393, UpdateTime: 2019-12-01 21:11:45 +0800 CST&#125;&quot;] æˆ–è€…ç™»é™†TiDBä½¿ç”¨show pump statusæŸ¥çœ‹çŠ¶æ€ 12345678910root@10.152.x.10 21:10:32 [(none)]&gt; show pump status;+-----------------------+------------+--------+--------------------+---------------------+| NodeID | Address | State | Max_Commit_Ts | Update_Time |+-----------------------+------------+--------+--------------------+---------------------+| knode10-152-x-10:8250 | pump1:8250 | online | 412930792991752193 | 2019-12-01 21:12:48 || knode10-152-x-11:8250 | pump2:8250 | online | 412930793017966593 | 2019-12-01 21:12:48 || knode10-152-x-12:8250 | pump3:8250 | online | 412930793017966594 | 2019-12-01 21:12:48 |+-----------------------+------------+--------+--------------------+---------------------+3 rows in set (0.01 sec) éƒ¨ç½²Draineréƒ¨ç½²Drainerå°†MySQLä½œä¸ºTiDBä»åº“1.ä¸‹è½½tidb-enterprise-toolså®‰è£…åŒ… 123wget http://download.pingcap.org/tidb-enterprise-tools-latest-linux-amd64.tar.gztar -zxvf tidb-enterprise-tools-latest-linux-amd64 2.ä½¿ç”¨TiDB Mydumperå¤‡ä»½TiDBæ•°æ® 1234567891011121314151617181920212223242526272829303132333435363738394041424344$sudo ./tidb-enterprise-tools-latest-linux-amd64/bin/mydumper --ask-password -h 10.152.x.10 -P 4000 -u root --threads=4 --chunk-filesize=64 --skip-tz-utc --regex &#x27;^(?!(mysql\\.|information_schema\\.|performance_schema\\.))&#x27; -o /mfw_rundata/dump/ --verbose=3Enter MySQL Password: ** Message: 21:30:17.767: Server version reported as: 5.7.25-TiDB-v3.0.5** Message: 21:30:17.767: Connected to a TiDB server** Message: 21:30:17.771: Skipping locks because of TiDB** Message: 21:30:17.772: Set to tidb_snapshot &#x27;412931068452667405&#x27;** Message: 21:30:17.782: Started dump at: 2019-12-01 21:30:17** Message: 21:30:17.782: Written master status** Message: 21:30:17.784: Thread 1 connected using MySQL connection ID 20** Message: 21:30:17.794: Thread 1 set to tidb_snapshot &#x27;412931068452667405&#x27;** Message: 21:30:17.796: Thread 2 connected using MySQL connection ID 21** Message: 21:30:17.807: Thread 2 set to tidb_snapshot &#x27;412931068452667405&#x27;** Message: 21:30:17.809: Thread 3 connected using MySQL connection ID 22** Message: 21:30:17.819: Thread 3 set to tidb_snapshot &#x27;412931068452667405&#x27;** Message: 21:30:17.820: Thread 4 connected using MySQL connection ID 23** Message: 21:30:17.832: Thread 4 set to tidb_snapshot &#x27;412931068452667405&#x27;** Message: 21:30:17.843: Thread 2 dumping data for `sysbench`.`sbtest1`** Message: 21:30:17.844: Non-InnoDB dump complete, unlocking tables** Message: 21:30:17.843: Thread 3 dumping data for `sysbench`.`sbtest2`** Message: 21:30:17.843: Thread 1 dumping data for `sysbench`.`sbtest10`** Message: 21:30:17.843: Thread 4 dumping data for `sysbench`.`sbtest3`** Message: 21:30:17.882: Thread 4 dumping data for `sysbench`.`sbtest4`** Message: 21:30:17.883: Thread 2 dumping data for `sysbench`.`sbtest5`** Message: 21:30:17.887: Thread 3 dumping data for `sysbench`.`sbtest6`** Message: 21:30:17.890: Thread 1 dumping data for `sysbench`.`sbtest7`** Message: 21:30:17.911: Thread 4 dumping data for `sysbench`.`sbtest8`** Message: 21:30:17.925: Thread 1 dumping data for `sysbench`.`sbtest9`** Message: 21:30:17.938: Thread 4 dumping schema for `sysbench`.`sbtest1`** Message: 21:30:17.939: Thread 4 dumping schema for `sysbench`.`sbtest10`** Message: 21:30:17.941: Thread 4 dumping schema for `sysbench`.`sbtest2`** Message: 21:30:17.942: Thread 4 dumping schema for `sysbench`.`sbtest3`** Message: 21:30:17.943: Thread 4 dumping schema for `sysbench`.`sbtest4`** Message: 21:30:17.944: Thread 4 dumping schema for `sysbench`.`sbtest5`** Message: 21:30:17.945: Thread 4 dumping schema for `sysbench`.`sbtest6`** Message: 21:30:17.946: Thread 4 dumping schema for `sysbench`.`sbtest7`** Message: 21:30:17.947: Thread 4 dumping schema for `sysbench`.`sbtest8`** Message: 21:30:17.948: Thread 4 dumping schema for `sysbench`.`sbtest9`** Message: 21:30:17.949: Thread 4 shutting down** Message: 21:30:18.079: Thread 2 shutting down** Message: 21:30:18.084: Thread 3 shutting down** Message: 21:30:18.087: Thread 1 shutting down** Message: 21:30:18.087: Finished dump at: 2019-12-01 21:30:18 è·å–tsoå€¼ 123456789101112$sudo cat /mfw_rundata/dump/metadataStarted dump at: 2019-12-01 21:30:17SHOW MASTER STATUS: Log: tidb-binlog Pos: 412931068452667405 GTID:Finished dump at: 2019-12-01 21:30:18tsoä¸º 412931068452667405 ä¸ºä¸‹æ¸¸MySQLåˆ›å»ºDrainerä¸“ç”¨åŒæ­¥è´¦å· 1234CREATE USER IF NOT EXISTS &#x27;drainer&#x27;@&#x27;%&#x27;;ALTER USER &#x27;drainer&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;drainer_supersecret&#x27;;GRANT INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, EXECUTE, INDEX, SELECT ON *.* TO &#x27;drainer&#x27;@&#x27;%&#x27;; å¯¼å…¥æ•°æ®åˆ°MySQL 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869$sudo ./tidb-enterprise-tools-latest-linux-amd64/bin/loader -d /mfw_rundata/dump/ -h 10.132.2.143 -u drainer -p drainer_supersecret -P 3308 -t 2 -m &#x27;&#x27; -status-addr &#x27;:8723&#x27;2019/12/01 22:12:55 printer.go:52: [info] Welcome to loader2019/12/01 22:12:55 printer.go:53: [info] Release Version: v1.0.0-76-gad009d92019/12/01 22:12:55 printer.go:54: [info] Git Commit Hash: ad009d917b2cdc2a9cc26bc4e7046884c1ff43e72019/12/01 22:12:55 printer.go:55: [info] Git Branch: master2019/12/01 22:12:55 printer.go:56: [info] UTC Build Time: 2019-10-21 06:22:032019/12/01 22:12:55 printer.go:57: [info] Go Version: go version go1.12 linux/amd642019/12/01 22:12:55 main.go:51: [info] config: &#123;&quot;log-level&quot;:&quot;info&quot;,&quot;log-file&quot;:&quot;&quot;,&quot;status-addr&quot;:&quot;:8723&quot;,&quot;pool-size&quot;:2,&quot;dir&quot;:&quot;/mfw_rundata/dump/&quot;,&quot;db&quot;:&#123;&quot;host&quot;:&quot;10.132.2.143&quot;,&quot;user&quot;:&quot;drainer&quot;,&quot;port&quot;:3308,&quot;sql-mode&quot;:&quot;&quot;,&quot;max-allowed-packet&quot;:67108864&#125;,&quot;checkpoint-schema&quot;:&quot;tidb_loader&quot;,&quot;config-file&quot;:&quot;&quot;,&quot;route-rules&quot;:null,&quot;do-table&quot;:null,&quot;do-db&quot;:null,&quot;ignore-table&quot;:null,&quot;ignore-db&quot;:null,&quot;rm-checkpoint&quot;:false&#125;2019/12/01 22:12:55 loader.go:532: [info] [loader] prepare takes 0.000565 seconds2019/12/01 22:12:55 checkpoint.go:207: [info] calc checkpoint finished. finished tables (map[])2019/12/01 22:12:55 loader.go:715: [info] [loader][run db schema]/mfw_rundata/dump//sysbench-schema-create.sql[start]2019/12/01 22:12:55 loader.go:720: [info] [loader][run db schema]/mfw_rundata/dump//sysbench-schema-create.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest10-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest10-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest3-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest3-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest9-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest9-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest2-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest2-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest4-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest4-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest5-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest5-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest7-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest7-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest6-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest6-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest8-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest8-schema.sql[finished]2019/12/01 22:12:55 loader.go:736: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest1-schema.sql[start]2019/12/01 22:12:55 loader.go:741: [info] [loader][run table schema]/mfw_rundata/dump//sysbench.sbtest1-schema.sql[finished]2019/12/01 22:12:55 loader.go:715: [info] [loader][run db schema]/mfw_rundata/dump//test-schema-create.sql[start]2019/12/01 22:12:55 loader.go:720: [info] [loader][run db schema]/mfw_rundata/dump//test-schema-create.sql[finished]2019/12/01 22:12:55 loader.go:773: [info] [loader] create tables takes 0.334379 seconds2019/12/01 22:12:55 loader.go:788: [info] [loader] all data files have been dispatched, waiting for them finished 2019/12/01 22:12:55 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest3.sql[start]2019/12/01 22:12:55 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest8.sql[start]2019/12/01 22:12:55 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest8.sql scanned finished.2019/12/01 22:12:55 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest3.sql scanned finished.2019/12/01 22:12:56 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest8.sql[finished]2019/12/01 22:12:56 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest9.sql[start]2019/12/01 22:12:56 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest3.sql[finished]2019/12/01 22:12:56 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest4.sql[start]2019/12/01 22:12:56 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest9.sql scanned finished.2019/12/01 22:12:56 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest4.sql scanned finished.2019/12/01 22:12:56 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest4.sql[finished]2019/12/01 22:12:56 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest7.sql[start]2019/12/01 22:12:56 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest9.sql[finished]2019/12/01 22:12:56 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest6.sql[start]2019/12/01 22:12:56 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest7.sql scanned finished.2019/12/01 22:12:56 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest6.sql scanned finished.2019/12/01 22:12:56 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest7.sql[finished]2019/12/01 22:12:56 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest1.sql[start]2019/12/01 22:12:57 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest6.sql[finished]2019/12/01 22:12:57 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest10.sql[start]2019/12/01 22:12:57 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest1.sql scanned finished.2019/12/01 22:12:57 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest10.sql scanned finished.2019/12/01 22:12:57 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest10.sql[finished]2019/12/01 22:12:57 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest2.sql[start]2019/12/01 22:12:57 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest1.sql[finished]2019/12/01 22:12:57 loader.go:158: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest5.sql[start]2019/12/01 22:12:57 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest2.sql scanned finished.2019/12/01 22:12:57 loader.go:216: [info] data file /mfw_rundata/dump/sysbench.sbtest5.sql scanned finished.2019/12/01 22:12:57 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest2.sql[finished]2019/12/01 22:12:57 loader.go:165: [info] [loader][restore table data sql]/mfw_rundata/dump//sysbench.sbtest5.sql[finished]2019/12/01 22:12:57 loader.go:791: [info] [loader] all data files has been finished, takes 2.037124 seconds2019/12/01 22:12:57 main.go:88: [info] loader stopped and exits 3.ä¿®æ”¹ tidb-ansible/inventory.ini æ–‡ä»¶ ä¸º drainer_servers ä¸»æœºç»„æ·»åŠ éƒ¨ç½²æœºå™¨ IPï¼Œinitial_commit_ts è¯·è®¾ç½®ä¸ºè·å–çš„ initial_commit_tsï¼Œä»…ç”¨äº Drainer ç¬¬ä¸€æ¬¡å¯åŠ¨ 123[drainer_servers]drainer_mysql ansible_host=10.152.x.12 initial_commit_ts=&quot;412931068452667405&quot; ä¿®æ”¹é…ç½®æ–‡ä»¶ 12345678910111213[tidb@knode10-152-x-133 21:33:21 ~/tidb-ansible]$cp conf/drainer.toml conf/drainer_mysql_drainer.tomlvim conf/drainer_mysql_drainer.tomldb-type = &quot;mysql&quot;[syncer.to]host = &quot;10.132.2.143&quot;user = &quot;drainer&quot;password = &quot;drainer_supersecret&quot;port = 3308 4.éƒ¨ç½²Drainer 12ansible-playbook deploy_drainer.yml 5.å¯åŠ¨ Drainer 123ansible-playbook start_drainer.yml 6.æŸ¥çœ‹DrainerçŠ¶æ€ 12345678910111213root@10.152.x.10 22:06:49 [(none)]&gt; show drainer status;+-----------------------+------------------+--------+--------------------+---------------------+| NodeID | Address | State | Max_Commit_Ts | Update_Time |+-----------------------+------------------+--------+--------------------+---------------------+| knode10-152-x-12:8249 | 10.152.x.12:8249 | online | 412931643727675393 | 2019-12-01 22:06:52 |+-----------------------+------------------+--------+--------------------+---------------------+1 row in set (0.00 sec)$resources/bin/binlogctl -pd-urls=http://10.152.x.10:2379 -cmd drainers[2019/12/01 22:07:27.531 +08:00] [INFO] [nodes.go:49] [&quot;query node&quot;] [type=drainer] [node=&quot;&#123;NodeID: knode10-152-x-12:8249, Addr: 10.152.x.12:8249, State: online, MaxCommitTS: 412931651605102594, UpdateTime: 2019-12-01 22:07:26 +0800 CST&#125;&quot;]","categories":[],"tags":[{"name":"TiDB","slug":"TiDB","permalink":"http://fuxkdb.com/tags/TiDB/"},{"name":"Binlog","slug":"Binlog","permalink":"http://fuxkdb.com/tags/Binlog/"}]},{"title":"ProxySQLå¹³æ»‘ä¸‹çº¿èŠ‚ç‚¹","slug":"2019-11-12-ProxySQLå¹³æ»‘ä¸‹çº¿èŠ‚ç‚¹","date":"2019-11-12T13:57:00.000Z","updated":"2019-11-13T15:19:00.000Z","comments":true,"path":"2019/11/12/2019-11-12-ProxySQLå¹³æ»‘ä¸‹çº¿èŠ‚ç‚¹/","link":"","permalink":"http://fuxkdb.com/2019/11/12/2019-11-12-ProxySQL%E5%B9%B3%E6%BB%91%E4%B8%8B%E7%BA%BF%E8%8A%82%E7%82%B9/","excerpt":"ProxySQLå¹³æ»‘ä¸‹çº¿èŠ‚ç‚¹å› ä¸ºMGRå¤šä¸»DDLå’ŒDMLä¸èƒ½å¹¶å‘åœ¨ä¸åŒèŠ‚ç‚¹æ‰§è¡Œ, è€Œæˆ‘ä»¬åˆå­˜åœ¨å³é€šè¿‡KOåˆé€šè¿‡ProxySQLè®¿é—®çš„æ•°æ®åº“çš„æƒ…å†µ, ä¸ºäº†é¿å…åœ¨å‘ç”Ÿæ•…éšœ, æˆ‘ä»¬å†³å®šå°†ProxySQLä¸­é…ç½®çš„é›†ç¾¤çœŸå®ipåˆ é™¤, æ”¹ä¸ºä½¿ç”¨KOçš„vip.æœ¬æ–‡ä»‹ç»å¦‚ä½•å¹³æ»‘ä¸‹çº¿ProxySQLèŠ‚ç‚¹, ä»è€Œåšåˆ°å¯¹ä¸šåŠ¡æ— æ„ŸçŸ¥. KOæˆ‘å¸è‡ªç ”phpä¸­é—´ä»¶ ç¯å¢ƒä»‹ç» 10.133.x.59 è·‘sysbench 10.133.x.52:3307 æµ‹è¯•é›†ç¾¤èŠ‚ç‚¹ 10.133.x.53:3307 æµ‹è¯•é›†ç¾¤èŠ‚ç‚¹ 10.133.x.54:3307 æµ‹è¯•é›†ç¾¤èŠ‚ç‚¹ VIP è®¿é—®ç±»å‹ æ‰€åœ¨æœåŠ¡å™¨ 10.133.x.202 KO 10.133.x.202 10.133.x.203 ProxySQL 10.133.x.203 ProxySQLç‰ˆæœ¬1234567admin@127.0.0.1 23:12:02 [(none)]&gt; select version();+-------------------+| version() |+-------------------+| 2.0.8-67-g877cab1 |+-------------------+1 row in set (0.00 sec)MySQLç‰ˆæœ¬1234567root@localhost 23:17:56 [(none)]&gt; select version();+------------+| version() |+------------+| 5.7.26-log |+------------+1 row in set (0.00 sec)","text":"ProxySQLå¹³æ»‘ä¸‹çº¿èŠ‚ç‚¹å› ä¸ºMGRå¤šä¸»DDLå’ŒDMLä¸èƒ½å¹¶å‘åœ¨ä¸åŒèŠ‚ç‚¹æ‰§è¡Œ, è€Œæˆ‘ä»¬åˆå­˜åœ¨å³é€šè¿‡KOåˆé€šè¿‡ProxySQLè®¿é—®çš„æ•°æ®åº“çš„æƒ…å†µ, ä¸ºäº†é¿å…åœ¨å‘ç”Ÿæ•…éšœ, æˆ‘ä»¬å†³å®šå°†ProxySQLä¸­é…ç½®çš„é›†ç¾¤çœŸå®ipåˆ é™¤, æ”¹ä¸ºä½¿ç”¨KOçš„vip.æœ¬æ–‡ä»‹ç»å¦‚ä½•å¹³æ»‘ä¸‹çº¿ProxySQLèŠ‚ç‚¹, ä»è€Œåšåˆ°å¯¹ä¸šåŠ¡æ— æ„ŸçŸ¥. KOæˆ‘å¸è‡ªç ”phpä¸­é—´ä»¶ ç¯å¢ƒä»‹ç» 10.133.x.59 è·‘sysbench 10.133.x.52:3307 æµ‹è¯•é›†ç¾¤èŠ‚ç‚¹ 10.133.x.53:3307 æµ‹è¯•é›†ç¾¤èŠ‚ç‚¹ 10.133.x.54:3307 æµ‹è¯•é›†ç¾¤èŠ‚ç‚¹ VIP è®¿é—®ç±»å‹ æ‰€åœ¨æœåŠ¡å™¨ 10.133.x.202 KO 10.133.x.202 10.133.x.203 ProxySQL 10.133.x.203 ProxySQLç‰ˆæœ¬1234567admin@127.0.0.1 23:12:02 [(none)]&gt; select version();+-------------------+| version() |+-------------------+| 2.0.8-67-g877cab1 |+-------------------+1 row in set (0.00 sec)MySQLç‰ˆæœ¬1234567root@localhost 23:17:56 [(none)]&gt; select version();+------------+| version() |+------------+| 5.7.26-log |+------------+1 row in set (0.00 sec) é”™è¯¯çš„ä¸‹çº¿æ–¹å¼1.59è·‘å‹æµ‹1234567891011121314# cat sysbench_by_proxysql.sh sysbench /usr/share/sysbench/oltp_read_write.lua --mysql-user=sysbench_user --mysql-password=superSecret --mysql-port=16034 \\--mysql-host=10.133.x.203 \\--mysql-db=sysbench --tables=10 --table-size=5000000 --threads=$1 \\--events=5000000 --report-interval=5 --db-driver=mysql --time=$2 run# sh sysbench_by_proxysql.sh 16 1800[ 5s ] thds: 16 tps: 1125.70 qps: 22546.06 (r/w/o: 15787.64/4503.82/2254.61) lat (ms,95%): 15.55 err/s: 0.00 reconn/s: 0.00[ 10s ] thds: 16 tps: 1125.31 qps: 22516.34 (r/w/o: 15762.30/4503.43/2250.61) lat (ms,95%): 15.55 err/s: 0.00 reconn/s: 0.00[ 15s ] thds: 16 tps: 1127.13 qps: 22542.62 (r/w/o: 15778.83/4509.72/2254.06) lat (ms,95%): 15.55 err/s: 0.00 reconn/s: 0.00[ 20s ] thds: 16 tps: 1130.82 qps: 22613.98 (r/w/o: 15829.67/4522.48/2261.84) lat (ms,95%): 15.55 err/s: 0.00 reconn/s: 0.00... æŸ¥çœ‹ProxySQL vipæ‰€åœ¨èŠ‚ç‚¹çš„ProxySQLé…ç½®1234567891011121314151617admin@127.0.0.1 17:58:46 [(none)]&gt; select * from runtime_mysql_servers;+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+| 10 | 10.133.x.53 | 3307 | 0 | ONLINE | 3 | 0 | 1000 | 0 | 0 | 0 | || 11 | 10.133.x.54 | 3307 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | || 11 | 10.133.x.52 | 3307 | 0 | ONLINE | 2 | 0 | 1000 | 0 | 0 | 0 | |+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+admin@127.0.0.1 18:00:31 [(none)]&gt; select * from mysql_servers;+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+| 10 | 10.133.x.53 | 3307 | 0 | ONLINE | 3 | 0 | 1000 | 0 | 0 | 0 | || 11 | 10.133.x.52 | 3307 | 0 | ONLINE | 2 | 0 | 1000 | 0 | 0 | 0 | || 11 | 10.133.x.54 | 3307 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | |+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+æˆ‘ä»¬æ‰“ç®—æ·»åŠ KO vipåˆ°mysql serverä¸­, æ‰€ä»¥ä¸€å¼€å§‹æˆ‘å°è¯•åˆ é™¤mysql serversæ‰€æœ‰é…ç½®, ç„¶åæ’å…¥10.133.x.202:33071234567891011121314[2019-11-12 18:01:37]admin@127.0.0.1 18:00:49 [(none)]&gt; delete from mysql_servers;[2019-11-12 18:01:37]Query OK, 3 rows affected (0.00 sec)[2019-11-12 18:01:37][2019-11-12 18:03:16]admin@127.0.0.1 18:01:37 [(none)]&gt; insert into mysql_servers values(10,&#x27;10.133.x.202&#x27;,3307,0,&#x27;ONLINE&#x27;,10,0,1000,0,0,0,&#x27;&#x27;);[2019-11-12 18:03:16]Query OK, 1 row affected (0.00 sec)[2019-11-12 18:03:16][2019-11-12 18:03:19]admin@127.0.0.1 18:03:16 [(none)]&gt; select * from mysql_servers;[2019-11-12 18:03:19]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:19]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 18:03:19]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:19]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 10 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 18:03:19]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:19]1 row in set (0.00 sec)[2019-11-12 18:03:19]åŠ è½½é…ç½®åˆ°runtime, ä½¿é…ç½®çœŸæ­£ç”Ÿæ•ˆ123456789101112131415161718192021222324252627[2019-11-12 18:03:43]admin@127.0.0.1 18:03:19 [(none)]&gt; load mysql servers to runtime;[2019-11-12 18:03:43]Query OK, 0 rows affected (0.00 sec)[2019-11-12 18:03:43][2019-11-12 18:03:44]admin@127.0.0.1 18:03:43 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 18:03:44]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:44]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 18:03:44]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:44]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 10 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 18:03:44]| 11 | 10.133.x.54 | 3307 | 0 | OFFLINE_HARD | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 18:03:44]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:44]2 rows in set (0.00 sec)[2019-11-12 18:03:44][2019-11-12 18:03:45]admin@127.0.0.1 18:03:44 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 18:03:45]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:45]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 18:03:45]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:45]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 10 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 18:03:45]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:45]1 row in set (0.00 sec)[2019-11-12 18:03:45][2019-11-12 18:03:46]admin@127.0.0.1 18:03:45 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 18:03:46]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:46]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 18:03:46]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:46]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 10 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 18:03:46]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 18:03:46]1 row in set (0.01 sec) æ­¤æ—¶æŸ¥çœ‹sysbench, å‘ç°åœ¨é…ç½®åŠ è½½å, è¿æ¥ç«‹é©¬æŠ¥é”™.æ˜¾ç„¶, å¦‚æœä»¥è¿™ç§æ–¹å¼åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹çº¿èŠ‚ç‚¹, ä¸šåŠ¡è‚¯å®šæ˜¯ä¸å¯ä»¥æ¥å—çš„12345678910111213141516171819202122232425262728293031[2019-11-12 18:03:40][ 180s ] thds: 16 tps: 1134.87 qps: 22716.96 (r/w/o: 15904.95/4542.07/2269.94) lat (ms,95%): 15.55 err/s: 0.00 reconn/s: 0.00[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest7 WHERE id=?&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;COMMIT&#x27;[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT DISTINCT c FROM sbtest3 WHERE id BETWEEN ? AND ? ORDER BY c&#x27;[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest6 WHERE id BETWEEN ? AND ?&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:409: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest8 WHERE id=?&#x27;[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest6 WHERE id=?&#x27;[2019-11-12 18:03:43](last message repeated 2 times)[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;UPDATE sbtest8 SET c=? WHERE id=?&#x27;[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest2 WHERE id=?&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43](last message repeated 3 times)[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:469: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest1 WHERE id BETWEEN ? AND ?&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;COMMIT&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:409: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT DISTINCT c FROM sbtest8 WHERE id BETWEEN ? AND ? ORDER BY c&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT c FROM sbtest8 WHERE id=?&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:419: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;DELETE FROM sbtest2 WHERE id=?&#x27;[2019-11-12 18:03:43]FATAL: mysql_stmt_execute() returned error 2013 (Lost connection to MySQL server during query) for query &#x27;SELECT DISTINCT c FROM sbtest1 WHERE id BETWEEN ? AND ? ORDER BY c&#x27;[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:432: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:43]FATAL: `thread_run&#x27; function failed: /usr/share/sysbench/oltp_common.lua:487: SQL error, errno = 2013, state = &#x27;HY000&#x27;: Lost connection to MySQL server during query[2019-11-12 18:03:48]Error in my_thread_global_end(): 16 threads didn&#x27;t exit æ­£ç¡®çš„ä¸‹çº¿æ–¹å¼1.59è·‘sysbench123456789101112131415161718192021[2019-11-12 21:33:03][root@node10-133-1-59 fanboshi]# sh sysbench_by_proxysql.sh 4 1800[2019-11-12 21:33:03]sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)[2019-11-12 21:33:03][2019-11-12 21:33:03]Running the test with following options:[2019-11-12 21:33:03]Number of threads: 4[2019-11-12 21:33:03]Report intermediate results every 5 second(s)[2019-11-12 21:33:03]Initializing random number generator from current time[2019-11-12 21:33:03][2019-11-12 21:33:03][2019-11-12 21:33:03]Initializing worker threads...[2019-11-12 21:33:03][2019-11-12 21:33:03]Threads started![2019-11-12 21:33:03][2019-11-12 21:33:08][ 5s ] thds: 4 tps: 329.27 qps: 6592.58 (r/w/o: 4615.37/1317.88/659.34) lat (ms,95%): 13.95 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:33:13][ 10s ] thds: 4 tps: 339.83 qps: 6799.25 (r/w/o: 4760.65/1358.93/679.66) lat (ms,95%): 12.98 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:33:18][ 15s ] thds: 4 tps: 338.36 qps: 6768.12 (r/w/o: 4736.98/1354.42/676.71) lat (ms,95%): 13.22 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:33:23][ 20s ] thds: 4 tps: 335.65 qps: 6714.51 (r/w/o: 4700.84/1342.38/671.29) lat (ms,95%): 13.22 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:33:28][ 25s ] thds: 4 tps: 336.79 qps: 6734.32 (r/w/o: 4713.01/1347.94/673.37) lat (ms,95%): 13.46 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:33:33][ 30s ] thds: 4 tps: 340.61 qps: 6812.86 (r/w/o: 4770.58/1360.85/681.43) lat (ms,95%): 12.98 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:33:38][ 35s ] thds: 4 tps: 339.20 qps: 6779.83 (r/w/o: 4745.02/1356.41/678.40) lat (ms,95%): 13.46 err/s: 0.00 reconn/s: 0.00... 1.52æ’å…¥KO VIP, ä¿®æ”¹å…¶ä»–èŠ‚ç‚¹çŠ¶æ€ä¸ºOFFLINE_SOFT1234567891011121314151617181920212223242526272829303132333435363738394041424344454647[2019-11-12 21:33:58]admin@127.0.0.1 21:33:28 [(none)]&gt; insert into mysql_servers values(10,&#x27;10.133.x.202&#x27;,3307,0,&#x27;ONLINE&#x27;,100,0,1000,0,0,0,&#x27;&#x27;);[2019-11-12 21:33:58]Query OK, 1 row affected (0.00 sec)[2019-11-12 21:33:58][2019-11-12 21:34:03]admin@127.0.0.1 21:33:58 [(none)]&gt; select * from mysql_servers; [2019-11-12 21:34:03]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:03]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:34:03]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:03]| 10 | 10.133.x.53 | 3307 | 0 | ONLINE | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:03]| 11 | 10.133.x.52 | 3307 | 0 | ONLINE | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:03]| 11 | 10.133.x.54 | 3307 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:03]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:03]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:03]4 rows in set (0.00 sec)[2019-11-12 21:34:03][2019-11-12 21:34:08]admin@127.0.0.1 21:34:04 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 21:34:08]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:08]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:34:08]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:08]| 10 | 10.133.x.53 | 3307 | 0 | ONLINE | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:08]| 11 | 10.133.x.54 | 3307 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:08]| 11 | 10.133.x.52 | 3307 | 0 | ONLINE | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:08]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:08]3 rows in set (0.00 sec)[2019-11-12 21:34:08][2019-11-12 21:34:14]admin@127.0.0.1 21:34:08 [(none)]&gt; update mysql_servers set status=&#x27;OFFLINE_SOFT&#x27; where hostname!=&#x27;10.133.x.202&#x27;;[2019-11-12 21:34:14]Query OK, 3 rows affected (0.00 sec)[2019-11-12 21:34:14][2019-11-12 21:34:18]admin@127.0.0.1 21:34:14 [(none)]&gt; select * from mysql_servers; [2019-11-12 21:34:18]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:18]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:34:18]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:18]| 10 | 10.133.x.53 | 3307 | 0 | OFFLINE_SOFT | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:18]| 11 | 10.133.x.52 | 3307 | 0 | OFFLINE_SOFT | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:18]| 11 | 10.133.x.54 | 3307 | 0 | OFFLINE_SOFT | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:18]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:18]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:18]4 rows in set (0.00 sec)[2019-11-12 21:34:18][2019-11-12 21:34:22]admin@127.0.0.1 21:34:18 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 21:34:22]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:22]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:34:22]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:22]| 10 | 10.133.x.53 | 3307 | 0 | ONLINE | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:22]| 11 | 10.133.x.54 | 3307 | 0 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:22]| 11 | 10.133.x.52 | 3307 | 0 | ONLINE | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:34:22]+--------------+-------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:34:22]3 rows in set (0.00 sec)åŠ è½½é…ç½®åˆ°runtime1234567891011121314[2019-11-12 21:34:47]admin@127.0.0.1 21:34:28 [(none)]&gt; load mysql servers to runtime; [2019-11-12 21:34:47]Query OK, 0 rows affected (0.00 sec)[2019-11-12 21:34:47][2019-11-12 21:35:01]admin@127.0.0.1 21:34:47 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 21:35:01]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:35:01]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:35:01]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:35:01]| 10 | 10.133.x.53 | 3307 | 0 | OFFLINE_SOFT | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:35:01]| 11 | 10.133.x.54 | 3307 | 0 | OFFLINE_SOFT | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:35:01]| 11 | 10.133.x.52 | 3307 | 0 | OFFLINE_SOFT | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:35:01]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:35:01]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:35:01]4 rows in set (0.00 sec)[2019-11-12 21:35:01] æŸ¥çœ‹sysbench, æ­£å¸¸è¿è¡Œè¿æ¥æ— å¼‚å¸¸1234[2019-11-12 21:34:23][ 80s ] thds: 4 tps: 332.59 qps: 6646.37 (r/w/o: 4651.64/1329.75/664.98) lat (ms,95%): 12.98 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:34:28][ 85s ] thds: 4 tps: 339.42 qps: 6798.35 (r/w/o: 4759.64/1359.67/679.03) lat (ms,95%): 12.98 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:34:33][ 90s ] thds: 4 tps: 338.40 qps: 6763.76 (r/w/o: 4734.57/1352.39/676.80) lat (ms,95%): 12.98 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:34:38][ 95s ] thds: 4 tps: 337.20 qps: 6742.19 (r/w/o: 4719.79/1348.00/674.40) lat (ms,95%): 13.46 err/s: 0.00 reconn/s: 0.00 æŸ¥çœ‹proxysqlè½¬å°ä¿¡æ¯, å‘ç°statusä¸ºOFFLINE_SOFT, è¿æ¥ä»ç„¶åœ¨10.133.x.53ä¸Š1234567891011121314151617[2019-11-12 21:35:10]admin@127.0.0.1 21:35:01 [(none)]&gt; SELECT hostgroup hg, srv_host, status, ConnUsed, ConnFree, ConnOK, ConnERR FROM stats_mysql_connection_pool WHERE ConnUsed+ConnFree &gt; 0 ORDER BY hg, srv_host;[2019-11-12 21:35:10]+----+-------------+--------------+----------+----------+--------+---------+[2019-11-12 21:35:10]| hg | srv_host | status | ConnUsed | ConnFree | ConnOK | ConnERR |[2019-11-12 21:35:10]+----+-------------+--------------+----------+----------+--------+---------+[2019-11-12 21:35:10]| 10 | 10.133.x.53 | OFFLINE_SOFT | 4 | 0 | 26 | 0 |[2019-11-12 21:35:10]+----+-------------+--------------+----------+----------+--------+---------+[2019-11-12 21:35:10]1 row in set (0.01 sec)[2019-11-12 21:35:10][2019-11-12 21:35:16]admin@127.0.0.1 21:35:10 [(none)]&gt; select * from stats_mysql_processlist;[2019-11-12 21:35:16]+----------+-----------+------------+----------+-------------+----------+-----------+-------------+------------+-------------+----------+---------+---------+---------------------------------------------------------------------+--------------+---------------+[2019-11-12 21:35:16]| ThreadID | SessionID | user | db | cli_host | cli_port | hostgroup | l_srv_host | l_srv_port | srv_host | srv_port | command | time_ms | info | status_flags | extended_info |[2019-11-12 21:35:16]+----------+-----------+------------+----------+-------------+----------+-----------+-------------+------------+-------------+----------+---------+---------+---------------------------------------------------------------------+--------------+---------------+[2019-11-12 21:35:16]| 10 | 15664 | sysbench_user | sysbench | 10.133.x.59 | 60008 | 10 | 10.133.x.52 | 60207 | 10.133.x.53 | 3307 | Execute | 0 | COMMIT | 0 | NULL |[2019-11-12 21:35:16]| 5 | 15665 | sysbench_user | sysbench | 10.133.x.59 | 60012 | 10 | 10.133.x.52 | 28221 | 10.133.x.53 | 3307 | Execute | 0 | SELECT c FROM sbtest8 WHERE id=? | 0 | NULL |[2019-11-12 21:35:16]| 19 | 15666 | sysbench_user | sysbench | 10.133.x.59 | 60014 | 10 | 10.133.x.52 | 25673 | 10.133.x.53 | 3307 | Execute | 0 | SELECT DISTINCT c FROM sbtest10 WHERE id BETWEEN ? AND ? ORDER BY c | 0 | NULL |[2019-11-12 21:35:16]| 4 | 15667 | sysbench_user | sysbench | 10.133.x.59 | 60010 | 10 | 10.133.x.52 | 28223 | 10.133.x.53 | 3307 | Execute | 0 | SELECT c FROM sbtest3 WHERE id BETWEEN ? AND ? | 0 | NULL |[2019-11-12 21:35:16]+----------+-----------+------------+----------+-------------+----------+-----------+-------------+------------+-------------+----------+---------+---------+---------------------------------------------------------------------+--------------+---------------+ æˆ‘ä»¬æ‰‹åŠ¨åœæ­¢sysbench, é‡å¯sysbench1234567891011121314151617182019-11-12 21:35:37][root@node10-133-1-59 fanboshi]# sh sysbench_by_proxysql.sh 4 1800[2019-11-12 21:35:37]sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)[2019-11-12 21:35:37][2019-11-12 21:35:37]Running the test with following options:[2019-11-12 21:35:37]Number of threads: 4[2019-11-12 21:35:37]Report intermediate results every 5 second(s)[2019-11-12 21:35:37]Initializing random number generator from current time[2019-11-12 21:35:37][2019-11-12 21:35:37][2019-11-12 21:35:37]Initializing worker threads...[2019-11-12 21:35:37][2019-11-12 21:35:37]Threads started![2019-11-12 21:35:37][2019-11-12 21:35:42][ 5s ] thds: 4 tps: 432.41 qps: 8659.34 (r/w/o: 6062.50/1731.23/865.61) lat (ms,95%): 11.24 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:35:47][ 10s ] thds: 4 tps: 433.20 qps: 8661.86 (r/w/o: 6064.24/1731.21/866.41) lat (ms,95%): 11.24 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:35:52][ 15s ] thds: 4 tps: 433.79 qps: 8676.81 (r/w/o: 6074.06/1735.16/867.58) lat (ms,95%): 11.24 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:35:57][ 20s ] thds: 4 tps: 436.80 qps: 8736.88 (r/w/o: 6114.46/1748.82/873.61) lat (ms,95%): 11.24 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:36:02][ 25s ] thds: 4 tps: 434.99 qps: 8701.31 (r/w/o: 6092.20/1739.14/869.97) lat (ms,95%): 11.45 err/s: 0.00 reconn/s: 0.00 å†æ¬¡æŸ¥çœ‹è¿æ¥çŠ¶å†µ123456789101112131415161718[2019-11-12 21:35:41]admin@127.0.0.1 21:35:25 [(none)]&gt; SELECT hostgroup hg, srv_host, status, ConnUsed, ConnFree, ConnOK, ConnERR FROM stats_mysql_connection_pool WHERE ConnUsed+ConnFree &gt; 0 ORDER BY hg, srv_host;[2019-11-12 21:35:41]+----+--------------+--------+----------+----------+--------+---------+[2019-11-12 21:35:41]| hg | srv_host | status | ConnUsed | ConnFree | ConnOK | ConnERR |[2019-11-12 21:35:41]+----+--------------+--------+----------+----------+--------+---------+[2019-11-12 21:35:41]| 10 | 10.133.x.202 | ONLINE | 4 | 0 | 4 | 0 |[2019-11-12 21:35:41]+----+--------------+--------+----------+----------+--------+---------+[2019-11-12 21:35:41]1 row in set (0.00 sec)[2019-11-12 21:35:41][2019-11-12 21:35:50]admin@127.0.0.1 21:35:42 [(none)]&gt; select * from stats_mysql_processlist;[2019-11-12 21:35:50]+----------+-----------+------------+----------+-------------+----------+-----------+--------------+------------+--------------+----------+---------+---------+--------------------------------------------------------------------+--------------+---------------+[2019-11-12 21:35:50]| ThreadID | SessionID | user | db | cli_host | cli_port | hostgroup | l_srv_host | l_srv_port | srv_host | srv_port | command | time_ms | info | status_flags | extended_info |[2019-11-12 21:35:50]+----------+-----------+------------+----------+-------------+----------+-----------+--------------+------------+--------------+----------+---------+---------+--------------------------------------------------------------------+--------------+---------------+[2019-11-12 21:35:50]| 2 | 15731 | sysbench_user | sysbench | 10.133.x.59 | 60330 | 10 | 10.133.x.202 | 15300 | 10.133.x.202 | 3307 | Sleep | 0 | NULL | 0 | NULL |[2019-11-12 21:35:50]| 4 | 15732 | sysbench_user | sysbench | 10.133.x.59 | 60334 | 10 | 10.133.x.202 | 15304 | 10.133.x.202 | 3307 | Sleep | 0 | NULL | 0 | NULL |[2019-11-12 21:35:50]| 7 | 15733 | sysbench_user | sysbench | 10.133.x.59 | 60336 | 10 | 10.133.x.202 | 15302 | 10.133.x.202 | 3307 | Execute | 0 | COMMIT | 0 | NULL |[2019-11-12 21:35:50]| 6 | 15734 | sysbench_user | sysbench | 10.133.x.59 | 60332 | 10 | 10.133.x.202 | 15306 | 10.133.x.202 | 3307 | Execute | 0 | SELECT DISTINCT c FROM sbtest9 WHERE id BETWEEN ? AND ? ORDER BY c | 0 | NULL |[2019-11-12 21:35:50]+----------+-----------+------------+----------+-------------+----------+-----------+--------------+------------+--------------+----------+---------+---------+--------------------------------------------------------------------+--------------+---------------+[2019-11-12 21:35:50]4 rows in set (0.01 sec)å¯ä»¥çœ‹åˆ°è¿æ¥å·²ç»è½¬å‘åˆ°äº†10.133.x.202ä¸Š åˆ é™¤æ— ç”¨é…ç½®12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152[2019-11-12 21:36:18]admin@127.0.0.1 21:35:50 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 21:36:18]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:18]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:36:18]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:18]| 10 | 10.133.x.53 | 3307 | 0 | OFFLINE_SOFT | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:18]| 11 | 10.133.x.54 | 3307 | 0 | OFFLINE_SOFT | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:18]| 11 | 10.133.x.52 | 3307 | 0 | OFFLINE_SOFT | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:18]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:18]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:18]4 rows in set (0.01 sec)[2019-11-12 21:36:18][2019-11-12 21:36:23]admin@127.0.0.1 21:36:18 [(none)]&gt; select * from mysql_servers;[2019-11-12 21:36:23]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:23]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:36:23]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:23]| 10 | 10.133.x.53 | 3307 | 0 | OFFLINE_SOFT | 3 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:23]| 11 | 10.133.x.52 | 3307 | 0 | OFFLINE_SOFT | 2 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:23]| 11 | 10.133.x.54 | 3307 | 0 | OFFLINE_SOFT | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:23]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:23]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:23]4 rows in set (0.00 sec)[2019-11-12 21:36:23][2019-11-12 21:36:29]admin@127.0.0.1 21:36:23 [(none)]&gt; delete from mysql_servers where hostname!=&#x27;10.133.x.202&#x27;;[2019-11-12 21:36:29]Query OK, 3 rows affected (0.00 sec)[2019-11-12 21:36:29][2019-11-12 21:36:31]admin@127.0.0.1 21:36:29 [(none)]&gt; select * from mysql_servers;[2019-11-12 21:36:31]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:31]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:36:31]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:31]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:31]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:31]1 row in set (0.00 sec)[2019-11-12 21:36:31][2019-11-12 21:36:42]admin@127.0.0.1 21:36:31 [(none)]&gt; load mysql servers to runtime;[2019-11-12 21:36:42]Query OK, 0 rows affected (0.00 sec)[2019-11-12 21:36:42][2019-11-12 21:36:49]admin@127.0.0.1 21:36:42 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 21:36:49]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:49]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:36:49]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:49]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:49]| 11 | 10.133.x.54 | 3307 | 0 | OFFLINE_HARD | 1 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:49]+--------------+--------------+------+-----------+--------------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:49]2 rows in set (0.00 sec)[2019-11-12 21:36:49][2019-11-12 21:36:55]admin@127.0.0.1 21:36:49 [(none)]&gt; select * from runtime_mysql_servers;[2019-11-12 21:36:55]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:55]| hostgroup_id | hostname | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |[2019-11-12 21:36:55]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:55]| 10 | 10.133.x.202 | 3307 | 0 | ONLINE | 100 | 0 | 1000 | 0 | 0 | 0 | |[2019-11-12 21:36:55]+--------------+--------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+[2019-11-12 21:36:55]1 row in set (0.00 sec) è¿æ¥æ— å¼‚å¸¸1234[2019-11-12 21:36:37][ 60s ] thds: 4 tps: 418.79 qps: 8379.26 (r/w/o: 5866.30/1675.37/837.59) lat (ms,95%): 11.45 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:36:42][ 65s ] thds: 4 tps: 421.60 qps: 8433.50 (r/w/o: 5904.67/1685.62/843.21) lat (ms,95%): 11.45 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:36:47][ 70s ] thds: 4 tps: 416.80 qps: 8334.11 (r/w/o: 5832.93/1667.58/833.59) lat (ms,95%): 11.45 err/s: 0.00 reconn/s: 0.00[2019-11-12 21:36:52][ 75s ] thds: 4 tps: 413.81 qps: 8273.84 (r/w/o: 5790.77/1655.45/827.62) lat (ms,95%): 11.65 err/s: 0.00 reconn/s: 0.00 å…³äºOFFLINE_SOFTè¯¦è§https://github.com/sysown/proxysql/wiki/Main-(runtime)#mysql_servers status: ONLINE - backend server is fully operational SHUNNED - backend sever is temporarily taken out of use because of either too many connection errors in a time that was too short, or replication lag exceeded the allowed threshold OFFLINE_SOFT - when a server is put into OFFLINE_SOFT mode, new incoming connections arenâ€™t accepted anymore, while the existing connections are kept until they became inactive. In other words, connections are kept in use until the current transaction is completed. This allows to gracefully detach a backend OFFLINE_HARD - when a server is put into OFFLINE_HARD mode, the existing connections are dropped, while new incoming connections arenâ€™t accepted either. This is equivalent to deleting the server from a hostgroup, or temporarily taking it out of the hostgroup for maintenance work","categories":[],"tags":[{"name":"ProxySQL","slug":"ProxySQL","permalink":"http://fuxkdb.com/tags/ProxySQL/"}]},{"title":"å¦‚ä½•è‡ªå·±åˆ¶ä½œæœºæ¢°é”®ç›˜","slug":"2019-10-21-å¦‚ä½•è‡ªå·±åˆ¶ä½œæœºæ¢°é”®ç›˜","date":"2019-10-21T13:57:00.000Z","updated":"2019-11-03T11:07:40.000Z","comments":true,"path":"2019/10/21/2019-10-21-å¦‚ä½•è‡ªå·±åˆ¶ä½œæœºæ¢°é”®ç›˜/","link":"","permalink":"http://fuxkdb.com/2019/10/21/2019-10-21-%E5%A6%82%E4%BD%95%E8%87%AA%E5%B7%B1%E5%88%B6%E4%BD%9C%E6%9C%BA%E6%A2%B0%E9%94%AE%E7%9B%98/","excerpt":"å¦‚ä½•è‡ªå·±åˆ¶ä½œæœºæ¢°é”®ç›˜æœ¬æ–‡è®°å½•è‡ªå·±çš„åˆæ¬¡â€å®¢åˆ¶åŒ–â€ç»å†, é”®åœˆå¤§ä½¬è¯·ç•¥è¿‡, é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£, è£…é€¼çŠ¯è‡ªåŠ¨å¿½è§†~ ææ–™å‡†å¤‡è½´ä½“è½´ä½“è¿™é‡Œå°±ä¸åšä»‹ç»äº†, å¦‚æœä½ ä¹Ÿæ˜¯èŒæ–°çš„è¯, å°±å…ˆäº†è§£è¿™å››ç§è½´å§: é’è½´ èŒ¶è½´ çº¢è½´ é»‘è½´","text":"å¦‚ä½•è‡ªå·±åˆ¶ä½œæœºæ¢°é”®ç›˜æœ¬æ–‡è®°å½•è‡ªå·±çš„åˆæ¬¡â€å®¢åˆ¶åŒ–â€ç»å†, é”®åœˆå¤§ä½¬è¯·ç•¥è¿‡, é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£, è£…é€¼çŠ¯è‡ªåŠ¨å¿½è§†~ ææ–™å‡†å¤‡è½´ä½“è½´ä½“è¿™é‡Œå°±ä¸åšä»‹ç»äº†, å¦‚æœä½ ä¹Ÿæ˜¯èŒæ–°çš„è¯, å°±å…ˆäº†è§£è¿™å››ç§è½´å§: é’è½´ èŒ¶è½´ çº¢è½´ é»‘è½´ å°±æˆ‘ä¸ªäººæ¥è¯´, å…¥å‘ç¬¬ä¸€æŠŠé”®ç›˜æ˜¯G80-3000, åé¢ä¹Ÿä¹°è¿‡å›½äº§é’è½´å’ŒåŠä»·Filco(é…·å†·è‡³å°Š), ä¹Ÿä¹°è¿‡Filcoå¥¶é…ªç»¿. 16å¹´åŒ11åœ¨KDBFanså…¥äº†é˜¿ç±³æ´›Va87mçº¢è½´åå°±åªè®¤çº¿æ€§è½´äº†, é˜¿ç±³æ´›çº¢è½´æ˜¯æˆ‘ä¹°è¿‡ç”¨è¿‡çš„é‡äº§é‡Œè®¤ä¸ºæ‰‹æ„Ÿæœ€å¥½çš„, æŸupä¸»ä¹Ÿæœ‰è¿‡ç±»ä¼¼çš„è¨€è®º, åœ¨æ­¤ä¹‹å‰æˆ‘è¿˜ä¸€ç›´ä»¥ä¸ºæ˜¯è‡ªå·±çš„é”™è§‰â€¦ å…¶ä»–è½´ä½“ä¿¡æ¯è¯·å‚è€ƒä¸‹é¢çš„æ–‡ç« : åƒåœ¾ä½¬åœ¨zFæ‚è°ˆç¯‡â€”â€”å„ç§è½´ä½“çš„ä¸å‡†ç¡®èµ„æ–™ å®¢åˆ¶åŒ–é€æ˜è½´ä½“ç›˜ç‚¹ å…³äºç›®å‰å¸‚é¢ä¸Šçš„æœºæ¢°é”®ç›˜è½´ä½“çš„æ±‡æ€»ä¸ä»‹ç» List of all keyboard switches å¤§è‡´æ¥è¯´, å•é¢—è½´ä½“ä»·æ ¼åœ¨å‡ æ¯›åˆ°åå‡ å—é’±è¿™ä¸ªèŒƒå›´å†…å§, ä¾‹å¦‚: GATERONä½³è¾¾éš†KS-3X1 â€“ 0.98ä¸€é¢— Cherryçº¢è½´ â€“ 2.5å·¦å³ä¸€é¢— GATERONæœºæ¢°é”®ç›˜è½´ä½“Tiffany â€“ 6.8å·¦å³ä¸€é¢— è€Œä¸”ç›®å‰æ¥è¯´, è²Œä¼¼ä¹Ÿä¸æ˜¯Cherryç¬¬ä¸€äº†~, æ¯”å¦‚Tiffanyè½´å°±å¤‡å—å¥½è¯„. æ—¢ç„¶æ˜¯è‡ªå·±ç»„ä¸€æŠŠ, é‚£è‚¯å®šè¦ç”¨å¥½çš„ å¤–å£³æƒ³å¥½è‡ªå·±æƒ³è¦64, 68, 84, 87, 104è¿˜æ˜¯å…¶ä»–é…åˆ—. é‡äº§é”®ç›˜æœ€å¤šçš„å°±æ˜¯87å’Œ104.å¤–å£³ä»·æ ¼å‡ åè‡³å‡ åƒä¸ç­‰, è€Œä¸”å¾ˆå¤šéœ€è¦è·Ÿå›¢ä¸Šè½¦æ‰èƒ½ä¹°åˆ°, å¦‚æœæ²¡ä¸Šè½¦å¯èƒ½å°±åªèƒ½é—²é±¼äº†.å’±å°±åšè¿™ä¸ª64é…åˆ— PCBæ¿å°±æ˜¯ç”µè·¯æ¿äº†, è¦æŠŠè½´ç„Šæ¥åˆ°æ¿å­ä¸Š, ä¹Ÿæœ‰çƒ­æ’æ‹”çš„, å°±æ˜¯ä¸ç”¨ç„Šæ¥, å¯ä»¥éšæ—¶æ›´æ¢è½´ä½“. æƒ³äº†å¾ˆä¹…è¿˜æ˜¯å†³å®šä¹°çƒ­æ’æ‹”çš„, ç„Šçš„è¯å¤ªéº»çƒ¦äº†, è€Œä¸”è‡ªå·±ä¹Ÿæ²¡ç”¨è¿‡çƒ­æ’æ‹”çš„é”®ç›˜(å¹¶ä¸æ˜¯ä¸ä¼š, æˆ‘å°å­¦ä¸‰å¹´çº§å°±åœ¨å°‘å¹´å®«ç„Šæ”¶éŸ³æœºäº†ğŸ¤£)è´­ä¹°å‰å¯ä»¥å’Œå®¢æœç¡®è®¤ä¸€ä¸‹æ˜¯å¦æ”¯æŒè‡ªå·±æƒ³è¦çš„é…åˆ—. ç¯çš„è¯, å°±é€‰pcbä¸Šæœ‰ç¯çš„å°±å¥½, åˆ†æ¸…æ¥šåº•ç¯å’Œè½´ç¯(åº•ç¯å°±æ˜¯ä¸‹é¢äº®, è½´ç¯å°±æ˜¯ä¸Šé¢äº®..). æœ‰äº›é…åˆ—è¿˜éœ€è¦è‡ªå·±åˆ·æœº. æˆ‘ä¹°çš„ç›´æ¥å°±æ˜¯æˆ‘è¦çš„é…åˆ—, æ‰€ä»¥è¿™ä¸€æ­¥ä¹Ÿå…äº† QMKç³»åˆ—åˆ·æœºç½‘å€ï¼š https://config.qmk.fm/ QMKç³»åˆ—åˆ·æœºè½¯ä»¶ä¸‹è½½åœ°å€ï¼š https://pan.baidu.com/s/1GMQGlyg3091JWQRYFl7s3A RGBçš„æŒ‡å¯¼è§†é¢‘ https://www.ixigua.com/i6710847720807989260/ éRGBçš„æŒ‡å¯¼è§†é¢‘ https://www.ixigua.com/i6710847016513044492/ ç¤ºä¾‹ éœ€è¦ç„Šæ¥çš„(æœ¬ä¾‹åªæœ‰åº•ç¯):æ­£é¢èƒŒé¢ çƒ­æ’æ‹”çš„(æœ¬ä¾‹åªæœ‰è½´ç¯)æ­£é¢èƒŒé¢ å®šä½æ¿æ¯ä¸ªé”®è½´æœ‰å›ºå®šçš„ä½ç½®å¡åœ¨å®šä½æ¿ä¸Šï¼Œé”®è½´å†ç„Šæ¥åˆ°ä¸»æ¿ä¸Šï¼Œå¯ä»¥å®ç°é”®è½´çš„ç¨³å›ºå’Œæ’åˆ—æ•´é½ç­‰ã€‚æœ‰ä¸åŒæè´¨å’Œä¸åŒé…åˆ—å¯ä¾›é€‰æ‹©ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€‰ç”¨çš„å®šä½æ¿çš„é…åˆ—è¦æ˜¯ä¸»æ¿èƒ½å¤Ÿæ”¯æŒçš„é…åˆ—^1 å®šä½æ¿æœ‰ç¢³çº¤ç»´çš„, é“çš„, é“œçš„, ä¸åŒæè´¨å¯èƒ½æ‰‹æ„Ÿä¹Ÿä¸åŒ. å«æ˜Ÿè½´å«æ˜Ÿè½´ä¹Ÿæœ‰å¾ˆå¤šç±»å‹..(æ‡’å¾—æŸ¥èµ„æ–™å†™äº†æ€ä¹ˆåŠğŸ˜¥) ä¸»è¦ç”¨æ¥å¹³è¡¡å¤§é”®å«æ˜Ÿè½´è²Œä¼¼åˆ†ä¸¤ç±»å§: å®šä½æ¿å«æ˜Ÿè½´ pcbå«æ˜Ÿè½´å¸¸è§çš„æ˜¯é æ’å¤´å›ºå®šè¿˜æœ‰é èºä¸å›ºå®šçš„ æˆ‘è¿™æ¬¡å°±é€‰GMKèºä¸å«æ˜Ÿè½´äº†, æ›´ç¨³å›ºäº›. é”®å¸½è¯·çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ã€ç§‘æ™®ã€‘é…åˆ—ã€é”®å¸½é«˜åº¦ä»¥åŠå¸¸è§çš„é”®å¸½å€æ•°è¯†åˆ«æ€»çš„æ¥è¯´é”®å¸½ä¹Ÿæ˜¯å‡ åè‡³å‡ åƒä»·æ ¼ä¸ç­‰. å›½å¤–çš„GMK, SPéƒ½å¾ˆè´µ, è€Œä¸”éƒ½éœ€è¦å›¢è´­, ç­‰å¾…æœŸå¾ˆé•¿, å›½å†…çš„ä¹Ÿæœ‰äº›ä¸é”™çš„, æ¯”å¦‚MelGeek. æ’éª¨çš„, å¿†å…‰ç­‰ç­‰å»ºè®®çœ‹ä¸€ä¸‹è¿™ä¸ªè§†é¢‘ã€èµ¤ç³ã€‘0-9999å…ƒé”®å¸½æ¨èï¼Œæˆ‘å…¨éƒ½è¦ï¼ï¼ï¼ è¿™æ¬¡æˆ‘ä¹°ARCæ­»çµ, è¢«è¿™ä¸ªæ¯’åˆ°äº† å…¶ä»– åå£é’³(å«æ˜Ÿè½´å‰ªè„š) èºä¸åˆ€(å»ºè®®å¸¦ç£å¤´, æˆ‘ä¹°çš„è¿™ä¸ªæ²¡æœ‰..) æ¶¦æ»‘è„‚(æœé‚¦çš„æ¶¦è½´, 22058æ¶¦å«æ˜Ÿè½´é’¢ä¸) é•Šå­ ç¬”åˆ·(åˆ·æ¶¦æ»‘è„‚) æ•°æ®çº¿ ç‰¹æ°Ÿé¾™èƒ¶å¸¦(æˆ–ç”¨åˆ›å£è´´æ›¿ä»£) å®‰è£…å› ä¸ºæ˜¯çƒ­æ’æ‹”, å®‰è£…å¾ˆç®€å•, æˆ‘æ„Ÿè§‰éƒ½æ²¡å¿…è¦å†™äº†.., å‚è€ƒè¿™ä¸ªè§†é¢‘å§, åªä¸è¿‡ä»–æ²¡ç”¨å®šä½æ¿(è²Œä¼¼æˆäº†ä¸€ä¸ªé“¾æ¥æ±‡æ€»æ–‡ç« äº†..ğŸ˜…)ã€é”®ç›˜å®¢åˆ¶åŒ–ã€‘ç»„è£…ä¸€ä¸ªGD64å·¦ç§»é…åˆ—çƒ­æ’æ‹”RGBå…‰æ±¡æŸ“æœºæ¢°é”®ç›˜å†çœ‹ä¸€ä¸‹å¦‚ä½•è°ƒæ•™å¤§é”®, ä¸»è¦å°±æ˜¯å‰ªè„šå’Œæ¶¦ç„•, çœ‹è§†é¢‘å³å¯ä»æ­¤å¤§é”®ä¸å†è‚‰ï¼æœºæ¢°é”®ç›˜å«æ˜Ÿè½´è°ƒæ ¡æ•™ç¨‹æœºæ¢°é”®ç›˜åƒåœ¾å¤§é”®çš„æ¶å¿ƒè‚‰æ„Ÿå’ŒæŠ“ç‹‚é’¢ä¸å£°æ•™ä½ è§£å†³å®ƒï¼æ¶¦æ»‘è½´ä½“å°‘å¹´ï¼Œæ¶¦æ»‘ä¸€ä¸‹å—ï¼Ÿæœºæ¢°é”®ç›˜è½´ä½“æ¶¦æ»‘æŒ‡å— ç»éªŒæ•™è®­1.æˆ‘çš„pcbä¹°çš„æ˜¯GK64, GK64æ²¡æœ‰ç»™å·¦shiftå¼€pcbå«æ˜Ÿè½´çš„å­”(2u shiftæ˜¯ä¸‰ä¸ªèŠèŠ±çš„), æ‰€ä»¥å¦‚æœä¹°çš„æ˜¯è¿™ç§å®šä½æ¿å°±æ²¡æ³•ä¸Šå«æ˜Ÿè½´äº†.è¦ä¹°è¿™ç§å®šä½æ¿(ç”¨å®šä½æ¿å«æ˜Ÿè½´) å¸¦å«æ˜Ÿè½´å®šä½æ¿ xd64 / dz60/64 / è²Œä¼¼éƒ½å¼€äº†å­”, ä½†ä¸æ˜¯çƒ­æ’æ‹”GD64 ä¹Ÿå¼€äº†å­”, ä½†æ²¡æœ‰ç°è´§, éœ€è¦ç­‰ä¸Šè½¦, ä¸”ä¹Ÿä¸æ”¯æŒé˜¶æ¢¯capslock dz64è²Œä¼¼å³shiftä¸èƒ½åˆ†è£‚ ä¸è¿‡æ’ä¸Šé”®å¸½è¯•äº†ä¸‹ä¹Ÿè¿˜å¥½, å°±è¿™æ ·å§ åŒ—ç“œçš„å®šä½æ¿(å¸¦å«æ˜Ÿè½´, å–å®¶è¯´æ”¯æŒlc60, Tofuå¤–å£³, æˆ‘æ²¡è¯•è¿‡) 2.GK64åªæ”¯æŒæ™®é€šcapslock, å¦‚æœæƒ³è¦ä¸Šé¢æ­»çµé‚£ä¸ªé˜¶æ¢¯capslock, xd64 / dz60/64 éƒ½å¯ä»¥. å­¦ä¼šçœ‹è¿™ä¸ªå›¾ å®šä½æ¿è¿˜ç”¨è¿™ä¸ªå°±è¡Œcaslockå¼€å£å¯ä»¥å‘å·¦ç§»åŠ¨çš„, ä¸»è¦çœ‹pcbæ”¯æŒä¸æ”¯æŒäº†ä¾¿å®œçš„ä¸é”ˆé’¢éå·¦ç§»å®šä½æ¿(æ”¯æŒxd/dz 64) 3.GK64çƒ­æ’æ‹”é•¿åº¦ 29.5å˜ç±³ æ”¾ä¸è¿›å»LC60â€¦â€¦åæ¥åˆä¹°äº†ä¸€å—ymdk64(æ”¯æŒé˜¶æ¢¯capslock) é•¿åº¦29.2å˜ç±³, å°±èƒ½æ”¾è¿›å»äº†.. å°±å·®3æ¯«ç±³ æœ€åçš„æˆå“ToFu + è’‚èŠ™å°¼è½´ Typing sound è´­ç‰©æ¸…å• è’‚èŠ™å°¼è½´ Tofu 60%å¤–å£³-ç”µæ³³ç™½ å¿†å…‰GK64RGBæœºæ¢°é”®ç›˜çƒ­æ’æ‹”PCBä¸»æ¿å£°æ§ä¸»æ¿ GH60æœºæ¢°é”®ç›˜DZ60é“œå®šä½æ¿åˆ†è£‚2U shift 60%å¸ƒå±€64é…åˆ— GMKèºä¸å«æ˜Ÿè½´ ARCæ­»çµé”®å¸½ åå£é’³ ä¸–è¾¾å·¥å…·sata pen æœé‚¦GPL105,205æ··åˆåŠæµä½“æ¶¦æ»‘è„‚ Permatexå¤ªé˜³ç‰Œ22058æ²¹è„‚ é•Šå­ ç¬”åˆ· æ•°æ®çº¿ ç‰¹æ°Ÿé¾™èƒ¶å¸¦ ä¸æœ¬æ¬¡æ— å…³çš„å…¶ä»– ä¸Šæ²¹æ¿ å¼€è½´å™¨ æ— é“…99%ç„Šé”¡ å¸é”¡å™¨ ç”µçƒ™é“ çƒ™é“æ¶ é˜²çƒ«å«","categories":[],"tags":[{"name":"ç”Ÿæ´»","slug":"ç”Ÿæ´»","permalink":"http://fuxkdb.com/tags/%E7%94%9F%E6%B4%BB/"},{"name":"å…´è¶£çˆ±å¥½","slug":"å…´è¶£çˆ±å¥½","permalink":"http://fuxkdb.com/tags/%E5%85%B4%E8%B6%A3%E7%88%B1%E5%A5%BD/"}]},{"title":"MySQL Error logç›‘æ§","slug":"2019-07-21-MySQL-Error-logç›‘æ§","date":"2019-07-21T01:59:00.000Z","updated":"2019-07-23T10:40:47.000Z","comments":true,"path":"2019/07/21/2019-07-21-MySQL-Error-logç›‘æ§/","link":"","permalink":"http://fuxkdb.com/2019/07/21/2019-07-21-MySQL-Error-log%E7%9B%91%E6%8E%A7/","excerpt":"MySQL Error logç›‘æ§å‘Šè­¦æ—¥å¿—ç›‘æ§å…¶å®æ¯”è¾ƒç®€å•äº†, æ€ä¹ˆåšéƒ½è¡Œ. ç›®å‰æˆ‘ä»¬è¿™é‡Œæ˜¯ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•FileBeaté‡‡é›†æ—¥å¿— -&gt; Kafka -&gt; è‡ªå·±å†™è„šæœ¬æ¶ˆè´¹å‡ºæ¥ -&gt; ä¼ä¸šå¾®ä¿¡æœºå™¨äººå‘Šè­¦æ•ˆæœå¦‚ä¸‹","text":"MySQL Error logç›‘æ§å‘Šè­¦æ—¥å¿—ç›‘æ§å…¶å®æ¯”è¾ƒç®€å•äº†, æ€ä¹ˆåšéƒ½è¡Œ. ç›®å‰æˆ‘ä»¬è¿™é‡Œæ˜¯ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•FileBeaté‡‡é›†æ—¥å¿— -&gt; Kafka -&gt; è‡ªå·±å†™è„šæœ¬æ¶ˆè´¹å‡ºæ¥ -&gt; ä¼ä¸šå¾®ä¿¡æœºå™¨äººå‘Šè­¦æ•ˆæœå¦‚ä¸‹ è¿™é‡Œç»™å‡ºFileBeaté…ç½®, å¾ˆç®€å•12345678910111213141516171819202122232425262728293031323334353637383940414243444546[root@node002142 filebeat-7.2.0-dba]# cat filebeat.ymllogging: level: warning json: truefilebeat.config.inputs: enabled: true path: configs/*.yml reload.enabled: true reload.period: 10shttp: enabled: true host: &quot;0.0.0.0&quot; port: 5066processors: - drop_fields: fields: [&quot;beat.name&quot;, &quot;beat.version&quot;, &quot;input_type&quot;, &quot;offset&quot;] - add_host_metadata: netinfo.enabled: trueoutput.kafka: hosts: [&quot;192.168.x.xx:9092&quot;,&quot;192.168.x.xx:9092&quot;,&quot;192.168.x.xx:9092&quot;] topic: &#x27;%&#123;[kafka_topic]&#125;&#x27; partition.round_robin: reachable_only: true required_acks: 1 max_message_bytes: 8388608 compression: gzip bulk_max_size: 2048 worker: 6 keep_alive: 600 channel_buffer_size: 2560 version: 2.0.0 --filebeat7.2æ‰æ”¯æŒæœ€æ–°ç‰ˆæœ¬çš„kafka, è™½ç„¶æˆ‘ä»¬çš„kafkaæ˜¯2.1.2 ä½†æ˜¯è¿™é‡Œä¹Ÿå¾—å†™2.0.0[root@node002142 configs]# lltotal 8-rw-r--r-- 1 root root 247 Jul 15 18:40 mysql_error_log.yml[root@node002142 filebeat-7.2.0-dba]# cat configs/mysql_error_log.yml- type: log paths: - /data/mysql_*/logs/*.err fields: type: mysql_error_log format: plain kafka_topic: log_mysql_error_log fields_under_root: true max_backoff: 3så†™å…¥Kafkaçš„æ¶ˆæ¯å¦‚ä¸‹:12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849&#123; &quot;@timestamp&quot;: &quot;2019-07-21T01:43:22.091Z&quot;, &quot;@metadata&quot;: &#123; &quot;beat&quot;: &quot;filebeat&quot;, &quot;type&quot;: &quot;_doc&quot;, &quot;version&quot;: &quot;7.2.0&quot;, &quot;topic&quot;: &quot;log_mysql_error_log&quot; &#125;, &quot;input&quot;: &#123; &quot;type&quot;: &quot;log&quot; &#125;, &quot;kafka_topic&quot;: &quot;log_mysql_error_log&quot;, &quot;type&quot;: &quot;mysql_error_log&quot;, &quot;format&quot;: &quot;plain&quot;, &quot;host&quot;: &#123; &quot;name&quot;: &quot;node00xxx&quot;, &quot;id&quot;: &quot;ea3afe477be14c22abf234dd3cb80f55&quot;, &quot;containerized&quot;: false, &quot;ip&quot;: [&quot;10.1.x.xx, &quot;fe80::xx:xx:xx&quot;, &quot;192.168.x.xx&quot;, &quot;fe80::xx:xx:xx&quot;], &quot;mac&quot;: [&quot;80:18:xx:xx:xx&quot;, &quot;80:18:xx:xx:xx&quot;, &quot;80:18:44:xx:xx:xx&quot;, &quot;80:18:44:xx:xx:xx&quot;], &quot;hostname&quot;: &quot;node002111&quot;, &quot;architecture&quot;: &quot;x86_64&quot;, &quot;os&quot;: &#123; &quot;platform&quot;: &quot;centos&quot;, &quot;version&quot;: &quot;7 (Core)&quot;, &quot;family&quot;: &quot;redhat&quot;, &quot;name&quot;: &quot;CentOS Linux&quot;, &quot;kernel&quot;: &quot;4.15.9-1.el7.elrepo.x86_64&quot;, &quot;codename&quot;: &quot;Core&quot; &#125; &#125;, &quot;agent&quot;: &#123; &quot;ephemeral_id&quot;: &quot;c97d819c-c456-42d0-xxxx-xxxxxxxxx&quot;, &quot;hostname&quot;: &quot;node00xxx&quot;, &quot;id&quot;: &quot;359f6ddb-de27-42c9-9ce1-1624205d6af0&quot;, &quot;version&quot;: &quot;7.2.0&quot;, &quot;type&quot;: &quot;filebeat&quot; &#125;, &quot;log&quot;: &#123; &quot;offset&quot;: 2585741, &quot;file&quot;: &#123; &quot;path&quot;: &quot;/data/mysql_3306/logs/node00xxxx.err&quot; &#125; &#125;, &quot;message&quot;: &quot;2019-07-21T01:43:21.585528Z 4345026 [Note] Access denied for user &#x27;user&#x27;@&#x27;192.168.x.xx&#x27; (using password: YES)&quot;, &quot;ecs&quot;: &#123; &quot;version&quot;: &quot;1.0.0&quot; &#125;&#125;Pythonè„šæœ¬123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195# -*- coding: utf8 -*-# __author__ = &#x27;Fan()&#x27;# Date: 2019-07-18import timeimport jsonimport pytzimport requestsimport datetimeimport loggingfrom utils.conn_db import Fandbfrom utils.config import *from confluent_kafka import Consumer, KafkaError, TopicPartition, OFFSET_END, OFFSET_BEGINNING, Producerclass MyRequest(): @staticmethod def get(url, params=None, timeout=(2, 5)): response = requests.get(url=url, params=params, timeout=timeout) if response.status_code == requests.codes.ok: return response.json() else: response.raise_for_status() @staticmethod def post(url, data=None, json=None, timeout=(5)): response = requests.post(url=url, data=data, json=json, timeout=timeout) if response.status_code == requests.codes.ok: return response.json() else: response.raise_for_status()def confLog(logfile): logging.basicConfig(level=logging.INFO, format=&#x27;%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s&#x27;, datefmt=&#x27;%Y-%m-%d %H:%M:%S&#x27;, filename=logfile, filemode=&#x27;a&#x27;)def _on_send_response(err, partations): pt = partations[0] if isinstance(err, KafkaError): print(&#x27;Topic &#123;&#125; åç§»é‡ &#123;&#125; æäº¤å¼‚å¸¸. &#123;&#125;&#x27;.format(pt.topic, pt.offset, err)) logging.error(&#x27;Topic &#123;&#125; åç§»é‡ &#123;&#125; æäº¤å¼‚å¸¸. &#123;&#125;&#x27;.format(pt.topic, pt.offset, err)) # raise Exception(err)def getConsumer(topic_name, bootstrap_servers, offset_end=True): config = &#123;&#x27;bootstrap.servers&#x27;: bootstrap_servers, &quot;group.id&quot;: topic_name, &#x27;enable.auto.commit&#x27;: True, &quot;fetch.wait.max.ms&quot;: 3000, &quot;max.poll.interval.ms&quot;: 60000, &#x27;session.timeout.ms&#x27;: 60000, &quot;on_commit&quot;: _on_send_response, &quot;default.topic.config&quot;: &#123;&quot;auto.offset.reset&quot;: &quot;latest&quot;&#125;&#125; consumer = Consumer(config) offset = OFFSET_END if offset_end else OFFSET_BEGINNING pt = TopicPartition(topic_name, 0, offset) # åŠ¨æ€è·å– ä¸€çº§kafkaçš„ topic consumer.assign([pt]) # consumer.seek(pt) try: while True: ret = consumer.consume(num_messages=10, timeout=0.1) if ret is None: print(&quot;No message Continue!&quot;) continue for msg in ret: if msg.error() is None: # print(&quot;Received message:&#123;&#125;&quot;.format(msg.value().decode(&quot;utf-8&quot;))) yield msg.value().decode(&quot;utf-8&quot;) elif msg.error(): if msg.error().code() == KafkaError._PARTITION_EOF: continue else: raise Exception(msg.error()) except Exception as e: print(e) consumer.close() except KeyboardInterrupt: consumer.close()def utc_to_local(utc_time_str, utc_format=&#x27;%Y-%m-%dT%H:%M:%S.%fZ&#x27;): local_tz = pytz.timezone(&#x27;Asia/Chongqing&#x27;) local_format = &quot;%Y-%m-%d %H:%M:%S&quot; utc_dt = datetime.datetime.strptime(utc_time_str, utc_format) local_dt = utc_dt.replace(tzinfo=pytz.utc).astimezone(local_tz) time_str = local_dt.strftime(local_format) return time_strdef get_mysql_ip(ips, hostname): last_ip = str(int(hostname[-3:])) for i in ips: x = i.split(&#x27;.&#x27;) if len(x) == 4: # è¿‡æ»¤æ‰æœ¬æœºvip if x[3] == last_ip and x[2] not in (&#x27;3&#x27;, &#x27;8&#x27;, &#x27;16&#x27;) and x[0] == &#x27;192&#x27;: return idef get_mysql_port(error_log_file): spliter = &#x27;mysql_&#x27; mysql_port = error_log_file.split(spliter)[1].split(&#x27;/&#x27;)[0] if mysql_port == &#x27;&#x27;: mysql_port = 3306 return mysql_portdef sendWechatBot(send_message): web_hoot_address = &#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=ä½ çš„æœºå™¨äººkey&#x27; body = &#123; &quot;msgtype&quot;: &quot;markdown&quot;, &quot;markdown&quot;: &#123; &quot;content&quot;: &#x27;&#x27;&#x27;&lt;font color=\\&quot;warning\\&quot;&gt;æ•è·å‘Šè­¦æ—¥å¿—æŠ¥é”™ä¿¡æ¯:&lt;/font&gt;\\n&gt;äº§å“çº¿:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;product_name&#125;&lt;/font&gt;&gt;é¡¹ç›®åç§°:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;project_name&#125;&lt;/font&gt;&gt;é«˜å¯ç”¨ç»„:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;ha_group_name&#125;&lt;/font&gt;&gt;IP:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;ip_app&#125;&lt;/font&gt;&gt;PORT:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;port&#125;&lt;/font&gt;&gt;èŠ‚ç‚¹è§’è‰²:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;role_name&#125;&lt;/font&gt;&gt;å‘Šè­¦æ—¶é—´:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;error_timestamp&#125;&lt;/font&gt;&gt;æ•è·æ—¶é—´:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;catch_timestamp&#125;&lt;/font&gt;&gt;ä¸‹å‘æ—¶é—´:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;send_timestamp&#125;&lt;/font&gt;å‘Šè­¦å†…å®¹:&lt;font color=\\&quot;comment\\&quot;&gt;&#123;error_message&#125;&lt;/font&gt;\\n&#x27;&#x27;&#x27;.format(**send_message) &#125; &#125; data = MyRequest.post(web_hoot_address, json=body) return datadef get_mysql_info(mysql_ip, mysql_port): conn = Fandb(cmdb_host, cmdb_port, cmdb_user, cmdb_pass, cmdb_schema, dic=True) sql = &#x27;ä¸€ä¸ªæ ¹æ®ipç«¯å£æŸ¥è¯¢æ•°æ®åº“å®ä¾‹æƒ³å…³ä¿¡æ¯çš„SQL&#x27; res = conn.dql(sql) conn.close() return res[0]if __name__ == &#x27;__main__&#x27;: verbose = 1 logfile = &#x27;/tools/mysql_error_log_watchdog.log&#x27; confLog(logfile) topic = &#x27;log_mysql_error_log&#x27; bootstrap_servers = &quot;192.168.x.xxx:9092,192.168.x.xxx:9092,192.168.x.xxx:9092&quot; consumer = getConsumer(topic, bootstrap_servers) for message in consumer: message_dict = json.loads(message) if verbose &gt;= 3: print(message_dict) catch_timestamp = utc_to_local(message_dict[&#x27;@timestamp&#x27;]) error_log_file = message_dict[&#x27;log&#x27;][&#x27;file&#x27;][&#x27;path&#x27;] hostname = message_dict[&#x27;host&#x27;][&#x27;hostname&#x27;] ips = message_dict[&#x27;host&#x27;][&#x27;ip&#x27;] mysql_ip = get_mysql_ip(ips, hostname) mysql_port = get_mysql_port(error_log_file) error_log_message = message_dict[&#x27;message&#x27;] if &#x27;[ERROR]&#x27; in error_log_message: try: catch_timestamp = utc_to_local(message_dict[&#x27;@timestamp&#x27;]) error_log_file = message_dict[&#x27;log&#x27;][&#x27;file&#x27;][&#x27;path&#x27;] hostname = message_dict[&#x27;host&#x27;][&#x27;hostname&#x27;] ips = message_dict[&#x27;host&#x27;][&#x27;ip&#x27;] mysql_ip = get_mysql_ip(ips, hostname) mysql_port = get_mysql_port(error_log_file) error_timestamp = utc_to_local(error_log_message.split(&#x27; &#x27;)[0]) error_message = &#x27; &#x27;.join(message_dict[&#x27;message&#x27;].split(&#x27; &#x27;)[2:]) send_message_dict = get_mysql_info(mysql_ip, mysql_port) send_message_dict[&#x27;catch_timestamp&#x27;] = catch_timestamp send_message_dict[&#x27;error_timestamp&#x27;] = error_timestamp send_message_dict[&#x27;send_timestamp&#x27;] = datetime.datetime.now().strftime(&quot;%Y-%m-%d %H:%M:%S&quot;) send_message_dict[&#x27;error_message&#x27;] = error_message logging.info(send_message_dict) sendWechatBot(send_message_dict) time.sleep(3) #ä¼ä¸šå¾®ä¿¡æœºå™¨äººé™åˆ¶3ç§’ä¸€æ¡ except Exception as e: logging.exception(e) logging.exception(error_log_message) å¦‚æœè§‰å¾—ä¸Šé¢çš„å¤ªéº»çƒ¦,å…¶å®ä¸€ä¸ªshellè„šæœ¬ä¹Ÿå¯ä»¥æ, å°±æ˜¯å¾—åœ¨æ¯ä¸ªæœºå™¨éƒ¨ç½²è¿è¡Œ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192#!/bin/bash# Oracleè­¦å‘Šæ—¥å¿—æ–‡ä»¶ç›‘æ§è„šæœ¬# 2015/4/14 King.# å‘é€é‚®ä»¶sendMail()&#123; echo &quot;$1&quot; mailTo=$(echo $mailTo | sed &#x27;s/,/ /g&#x27;) echo &quot;$1&quot; | /usr/bin/mutt -s &quot;$(date +&quot;%Y-%m-%d %H:%M:%S&quot;) è­¦å‘Šæ—¥å¿—é”™è¯¯&quot; -b $&#123;mailTo&#125; -c $&#123;mailCc&#125;&#125;# åˆ¤æ–­é”™è¯¯ä¿¡æ¯ä¸­æ˜¯å¦æœ‰æœªæ‰«æçš„è¡ŒcheckHis()&#123; tag=0 hisLine=$(cat $errLineNumFile) for i in $hisLine do if [ &quot;$1&quot; == &quot;$i&quot; ]; then tag=1 fi done return $tag &#125;#scriptDir=`pwd $0`scriptName=`basename $0`logDir=$scriptDir/logslogfile=$logDir/alert_error.logerrLineNumFile=$logDir/.alert_errLineNum#è®¾ç½®è­¦å‘Šæ—¥æ—¥å¿—æ–‡ä»¶è·¯å¾„alertFilePath=&quot;/data/mysql_3306/logs/nodexx.err&quot;# è®¾ç½®é‚®ä»¶æ¥æ”¶è€…ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”mailTo=&quot;xx@163.com&quot;# è®¾ç½®é‚®ä»¶æŠ„é€è€…ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”mailCc=&quot;a@163.com,b@163.com&quot;[ ! -f $alertFilePath ] &amp;&amp; echo &quot;[Error]: $alertFilePath no such file or directory.&quot; &amp;&amp; exit 1[ ! -d $logDir ] &amp;&amp; mkdir -p $logDirtouch $errLineNumFileecho &quot;æ­£åœ¨ç›‘æ§ $alertFilePath... &quot;while truedo arrayNum=() isError=false # å–å‡ºè­¦å‘Šæ—¥å¿—ä¸­ â€ORA?â€œå…³é”®å­—æ‰€åœ¨çš„è¡Œ errNum=$(cat $alertFilePath | grep -n -i &quot;[ERROR]]&quot;) n=0 if [ &quot;x$errNum&quot; != &quot;x&quot; ]; then # å–å‡ºé”™è¯¯è¡Œå· errLineNum=$(echo &quot;$errNum&quot; | awk -F: &#x27;&#123;print $1&#125;&#x27;) for num in $errLineNum do #åˆ¤æ–­è¯¥è¡Œé”™è¯¯ä¿¡æ¯æ˜¯å¦å·²æ‰«æ if [ &quot;x$errLineNum&quot; != &quot;x&quot; ]; then checkHis &quot;$num&quot; if [ $? -eq 0 ]; then # å¦‚æœè¯¥è¡Œé”™è¯¯æœªæ‰«æï¼Œè®°å½•è¯¥è¡Œä¿¡æ¯ isError=true echo $num &gt;&gt; $errLineNumFile arrayNum[$n]=$num let n++ fi else #å¦‚æœæ²¡æœ‰é”™è¯¯ä¼‘çœ 10såé‡æ–°æ‰«æ sleep 10s break fi donefi # å¦‚æœå‘ç°æœªæ‰«æçš„é”™è¯¯ä¿¡æ¯åˆ™æ ¹æ®è¡Œå·å–å‡ºè¯¥è¡Œä¿¡æ¯è®°å½•æ—¥å¿—ï¼Œå¹¶ä¸”å‘é€é‚®ä»¶ if [ &quot;$isError&quot; == &quot;true&quot; ] then echo &quot;-------------------------------- $(date +&quot;%Y-%m-%d %H:%M:%S&quot;) ---------------------------------------&quot; &gt;&gt; $logfile i=0 errMsg=$( while [ $i -lt $&#123;#arrayNum[@]&#125; ]; do echo &quot;$errNum&quot; | grep &quot;^$&#123;arrayNum[$i]&#125;:&quot; let i++ done) echo &quot;$errMsg&quot; &gt;&gt; $logfile sendMail &quot;$errMsg&quot; fi #æ¯10sï¼Œæ‰«æä¸€æ¬¡è­¦å‘Šæ—¥å¿—æ–‡ä»¶ sleep 10sdone","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLç›‘æ§","slug":"MySQLç›‘æ§","permalink":"http://fuxkdb.com/tags/MySQL%E7%9B%91%E6%8E%A7/"}]},{"title":"è®°ä¸€æ¬¡PMMå®¹å™¨è¢«è¯¯åˆ é™¤çš„æ¢å¤","slug":"2019-07-20-è®°ä¸€æ¬¡PMMå®¹å™¨è¢«è¯¯åˆ é™¤çš„æ¢å¤","date":"2019-07-20T06:01:00.000Z","updated":"2019-07-20T06:02:08.000Z","comments":true,"path":"2019/07/20/2019-07-20-è®°ä¸€æ¬¡PMMå®¹å™¨è¢«è¯¯åˆ é™¤çš„æ¢å¤/","link":"","permalink":"http://fuxkdb.com/2019/07/20/2019-07-20-%E8%AE%B0%E4%B8%80%E6%AC%A1PMM%E5%AE%B9%E5%99%A8%E8%A2%AB%E8%AF%AF%E5%88%A0%E9%99%A4%E7%9A%84%E6%81%A2%E5%A4%8D/","excerpt":"è®°ä¸€æ¬¡PMMå®¹å™¨è¢«è¯¯åˆ é™¤çš„æ¢å¤æ˜¨å¤©PMM Data Containerå’ŒPMM Server Container éƒ½ä¸å°å¿ƒè¢«è¯¯åˆ äº†, è¿˜å¥½æ˜¯ä½¿ç”¨çš„docker rm container_idåˆ çš„, æ²¡æœ‰åŠ -v. æœ¬äººdockeræ¸£æ¸£, åæ¥æ‰¾è¿ç»´åŒæ—¶å¸®å¿™ç»ˆäºæ¢å¤äº†é¦–å…ˆæ‰¾åˆ°å®¿ä¸»æœºvolumesè·¯å¾„1234567891011121314[root@node1 volumes]# pwd/var/lib/docker/volumes[root@node1 volumes]# lltotal 32drwxr-xr-x 3 root root 26 Aug 3 2018 4430beeb61fbc26802dc1b31d9fe3a02772482d8ae31bd50110957f16256f02edrwxr-xr-x 3 root root 26 Jul 19 18:29 47ce712fd5e32abcf60e9650f349ac1304e0c20d062bd54724123f6cb700a79edrwxr-xr-x 3 root root 26 Aug 3 2018 6ecf1c674f9f8e6f3dda7f7da352b70860125147b4489c6a8fe00fa59892436fdrwxr-xr-x 3 root root 26 Aug 3 2018 83db182943136c354bf95c0b4d07a8272017fd1698557d27b97dae49c82a8e76drwxr-xr-x 3 root root 26 Jul 19 18:29 c9e3a964fd76dcad88ac992933ca97ac920c41239f9807f1ca91f939bd71ea03drwxr-xr-x 3 root root 26 Jul 19 18:29 e92a37881c9b378bc4b00094b3f7e38ace3ae3655c33677a79da1be5652a318adrwxr-xr-x 3 root root 26 Aug 3 2018 fcddf90d2cb64035c8c69165f69c5d7a780ac580c991f02af801bc65fa2ca609-rw------- 1 root root 65536 Jul 19 18:29 metadata.dbdrwxr-xr-x 3 root root 26 Jul 19 18:26 sentry-datadrwxr-xr-x 3 root root 26 Jul 19 18:26 sentry-postgres","text":"è®°ä¸€æ¬¡PMMå®¹å™¨è¢«è¯¯åˆ é™¤çš„æ¢å¤æ˜¨å¤©PMM Data Containerå’ŒPMM Server Container éƒ½ä¸å°å¿ƒè¢«è¯¯åˆ äº†, è¿˜å¥½æ˜¯ä½¿ç”¨çš„docker rm container_idåˆ çš„, æ²¡æœ‰åŠ -v. æœ¬äººdockeræ¸£æ¸£, åæ¥æ‰¾è¿ç»´åŒæ—¶å¸®å¿™ç»ˆäºæ¢å¤äº†é¦–å…ˆæ‰¾åˆ°å®¿ä¸»æœºvolumesè·¯å¾„1234567891011121314[root@node1 volumes]# pwd/var/lib/docker/volumes[root@node1 volumes]# lltotal 32drwxr-xr-x 3 root root 26 Aug 3 2018 4430beeb61fbc26802dc1b31d9fe3a02772482d8ae31bd50110957f16256f02edrwxr-xr-x 3 root root 26 Jul 19 18:29 47ce712fd5e32abcf60e9650f349ac1304e0c20d062bd54724123f6cb700a79edrwxr-xr-x 3 root root 26 Aug 3 2018 6ecf1c674f9f8e6f3dda7f7da352b70860125147b4489c6a8fe00fa59892436fdrwxr-xr-x 3 root root 26 Aug 3 2018 83db182943136c354bf95c0b4d07a8272017fd1698557d27b97dae49c82a8e76drwxr-xr-x 3 root root 26 Jul 19 18:29 c9e3a964fd76dcad88ac992933ca97ac920c41239f9807f1ca91f939bd71ea03drwxr-xr-x 3 root root 26 Jul 19 18:29 e92a37881c9b378bc4b00094b3f7e38ace3ae3655c33677a79da1be5652a318adrwxr-xr-x 3 root root 26 Aug 3 2018 fcddf90d2cb64035c8c69165f69c5d7a780ac580c991f02af801bc65fa2ca609-rw------- 1 root root 65536 Jul 19 18:29 metadata.dbdrwxr-xr-x 3 root root 26 Jul 19 18:26 sentry-datadrwxr-xr-x 3 root root 26 Jul 19 18:26 sentry-postgres æ‰¾åˆ°å¯¹åº”çš„ç›®å½•1234567891011121314151617181920prometheus[root@node1 volumes]# ls /var/lib/docker/volumes/6ecf1c674f9f8e6f3dda7f7da352b70860125147b4489c6a8fe00fa59892436f/_data00 06 0c 12 18 1e 24 2a 30 36 3c 42 48 4e 54 5a 60 66 6c 72 78 7e 84 8a 90 96 9c a2 a8 ae b2 b8 be c4 ca d0 d6 dc e1 e7 ed f3 f9 ff01 07 0d 13 19 1f 25 2b 31 37 3d 43 49 4f 55 5b 61 67 6d 73 79 7f 85 8b 91 97 9d a3 a9 af b3 b9 bf c5 cb d1 d7 dd e2 e8 ee f4 fa heads.db02 08 0e 14 1a 20 26 2c 32 38 3e 44 4a 50 56 5c 62 68 6e 74 7a 80 86 8c 92 98 9e a4 aa archived_fingerprint_to_metric b4 ba c0 c6 cc d2 d8 de e3 e9 ef f5 fb labelname_to_labelvalues03 09 0f 15 1b 21 27 2d 33 39 3f 45 4b 51 57 5d 63 69 6f 75 7b 81 87 8d 93 99 9f a5 ab archived_fingerprint_to_timerange b5 bb c1 c7 cd d3 d9 df e4 ea f0 f6 fc labelpair_to_fingerprints04 0a 10 16 1c 22 28 2e 34 3a 40 46 4c 52 58 5e 64 6a 70 76 7c 82 88 8e 94 9a a0 a6 ac b0 b6 bc c2 c8 ce d4 da DIRTY e5 eb f1 f7 fd mappings.db05 0b 11 17 1d 23 29 2f 35 3b 41 47 4d 53 59 5f 65 6b 71 77 7d 83 89 8f 95 9b a1 a7 ad b1 b7 bd c3 c9 cf d5 db e0 e6 ec f2 f8 fe VERSIONconsul[root@node1 volumes]# ls /var/lib/docker/volumes/fcddf90d2cb64035c8c69165f69c5d7a780ac580c991f02af801bc65fa2ca609/_datacheckpoint-signature node-id raft serfmysql[root@node1 volumes]# ls /var/lib/docker/volumes/4430beeb61fbc26802dc1b31d9fe3a02772482d8ae31bd50110957f16256f02e/_dataibdata1 ib_logfile0 ib_logfile1 mysql mysql.sock orchestrator performance_schema pmm pmm@002dmanaged RPM_UPGRADE_HISTORY RPM_UPGRADE_MARKER-LAST testgrafana[root@node1 volumes]# ls /var/lib/docker/volumes/83db182943136c354bf95c0b4d07a8272017fd1698557d27b97dae49c82a8e76/_datagrafana.db PERCONA_DASHBOARDS_VERSION plugins png sessions é‡æ–°åˆ›å»ºdata container123456docker create --name pmm-data2 \\-v /var/lib/docker/volumes/6ecf1c674f9f8e6f3dda7f7da352b70860125147b4489c6a8fe00fa59892436f/_data:/opt/prometheus/data \\-v /var/lib/docker/volumes/fcddf90d2cb64035c8c69165f69c5d7a780ac580c991f02af801bc65fa2ca609/_data:/opt/consul-data \\-v /var/lib/docker/volumes/4430beeb61fbc26802dc1b31d9fe3a02772482d8ae31bd50110957f16256f02e/_data:/var/lib/mysql \\-v /var/lib/docker/volumes/83db182943136c354bf95c0b4d07a8272017fd1698557d27b97dae49c82a8e76/_data:/var/lib/grafana \\percona/pmm-server:latest /bin/tureé‡æ–°åˆ›å»ºserver1234567891011docker run -d \\ -p 8080:80 \\ --volumes-from pmm-data2 \\ --name pmm-server \\ -e SERVER_USER=username \\ -e SERVER_PASSWORD=password \\ -e METRICS_RETENTION=720h \\ -e METRICS_RESOLUTION=5s \\ -e DISABLE_TELEMETRY=true \\ --restart always \\ percona/pmm-server:latest ä¹‹åPMMé¡µé¢å°±å¯ä»¥è®¿é—®äº†, ä¸è¿‡å¦‚æœä½ åšäº†ä¸€äº›é¢å¤–é…ç½®, æ¯”å¦‚æˆ‘å†prometheus.ymlä¸­åŠ äº†canalç›‘æ§, é‚£å°±éœ€è¦é‡æ–°æ·»åŠ äº†.","categories":[],"tags":[{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"MySQLæ…¢æŸ¥è¯¢å¹³å°æ¶æ„æ–¹æ¡ˆ","slug":"2019-07-20-MySQLæ…¢æŸ¥è¯¢å¹³å°æ¶æ„æ–¹æ¡ˆ","date":"2019-07-20T05:23:00.000Z","updated":"2019-07-20T05:34:45.000Z","comments":true,"path":"2019/07/20/2019-07-20-MySQLæ…¢æŸ¥è¯¢å¹³å°æ¶æ„æ–¹æ¡ˆ/","link":"","permalink":"http://fuxkdb.com/2019/07/20/2019-07-20-MySQL%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E6%96%B9%E6%A1%88/","excerpt":"MySQLæ…¢æŸ¥è¯¢å¹³å°æ¶æ„æ–¹æ¡ˆæ–¹æ¡ˆ1 Filebeatè¯»å–slow log åˆ°kafka , logstashä»kafkaæ¶ˆè´¹åè§£ææˆå‡ºå„ä¸ªåˆ—, ç„¶åå†™å…¥MySQL, ä½†æ˜¯è¿™æ ·çš„é—®é¢˜æ˜¯æŸ¥è¯¢è¯­å¥æ˜¯è¿™æ ·çš„select * from A where id=1. è€Œæˆ‘ä»¬éœ€è¦å»é™¤è°“è¯çš„SQL, ä¹Ÿå°±æ˜¯select * from A where id=? è¿™æ ·çš„, è¿™æ ·æ‰å¥½å¯¹SQLè¿›è¡Œèšåˆåˆ†æäºæ˜¯ç”¨Canalæ‹‰binlog, å†å†™åˆ°kafka, ç„¶åpythonæ¶ˆè´¹, è·å–id, sqlæ–‡æœ¬, ä½¿ç”¨pt-fingerprintå»é™¤è°“è¯åå†æ›´æ–°å›å». è¿™ä¸ªæ¶æ„çœ‹èµ·æ¥è›®é«˜å¤§ä¸Š æƒ³äº†æƒ³è¿˜æ˜¯å¤æ‚äº†å†™, ç¯èŠ‚å¤ªäº›, å®¹æ˜“å‡ºé—®é¢˜. ä¼˜ç‚¹: æ…¢æŸ¥è¯¢å‡†å®æ—¶è·å–(ä½†å¯èƒ½æ˜¯ä¼ªéœ€æ±‚) ç¼ºç‚¹: æ¶æ„å¤åˆ¶æ˜“å‡ºé”™, MySQLç‰ˆæœ¬å‡çº§å¦‚æœslow logæ ¼å¼å‘ç”Ÿå˜åŒ–, ç»´æŠ¤logstashçš„grokä¼šå¾ˆéº»çƒ¦ æœ‰äººè¯´ä¸ºä»€ä¹ˆä¸ç”¨Filebeat ingestç›´æ¥åˆ°ES, è¿™è¦å›¾æ ‡ç”¨Kibanaå°±å¥½äº†. æˆ‘çš„è€ƒè™‘æ˜¯:1.è¿˜è¦åšè°“è¯å»é™¤2.è¿™æ ·åšå‡ºçš„å›¾æ²¡æ³•å’Œæˆ‘ä»¬ä¸šåŠ¡çš„æœåŠ¡æ•°å…³è”, ä¸šåŠ¡äººå‘˜æŸ¥è¯¢å°±å¿…é¡»çŸ¥é“æ•°æ®åº“çš„IPç«¯å£è¯¦ç»†æ–¹æ¡ˆå¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡æ¡£ https://www.jianshu.com/p/f3be9cce9b77https://www.jianshu.com/p/3cf0e2a8d23d","text":"MySQLæ…¢æŸ¥è¯¢å¹³å°æ¶æ„æ–¹æ¡ˆæ–¹æ¡ˆ1 Filebeatè¯»å–slow log åˆ°kafka , logstashä»kafkaæ¶ˆè´¹åè§£ææˆå‡ºå„ä¸ªåˆ—, ç„¶åå†™å…¥MySQL, ä½†æ˜¯è¿™æ ·çš„é—®é¢˜æ˜¯æŸ¥è¯¢è¯­å¥æ˜¯è¿™æ ·çš„select * from A where id=1. è€Œæˆ‘ä»¬éœ€è¦å»é™¤è°“è¯çš„SQL, ä¹Ÿå°±æ˜¯select * from A where id=? è¿™æ ·çš„, è¿™æ ·æ‰å¥½å¯¹SQLè¿›è¡Œèšåˆåˆ†æäºæ˜¯ç”¨Canalæ‹‰binlog, å†å†™åˆ°kafka, ç„¶åpythonæ¶ˆè´¹, è·å–id, sqlæ–‡æœ¬, ä½¿ç”¨pt-fingerprintå»é™¤è°“è¯åå†æ›´æ–°å›å». è¿™ä¸ªæ¶æ„çœ‹èµ·æ¥è›®é«˜å¤§ä¸Š æƒ³äº†æƒ³è¿˜æ˜¯å¤æ‚äº†å†™, ç¯èŠ‚å¤ªäº›, å®¹æ˜“å‡ºé—®é¢˜. ä¼˜ç‚¹: æ…¢æŸ¥è¯¢å‡†å®æ—¶è·å–(ä½†å¯èƒ½æ˜¯ä¼ªéœ€æ±‚) ç¼ºç‚¹: æ¶æ„å¤åˆ¶æ˜“å‡ºé”™, MySQLç‰ˆæœ¬å‡çº§å¦‚æœslow logæ ¼å¼å‘ç”Ÿå˜åŒ–, ç»´æŠ¤logstashçš„grokä¼šå¾ˆéº»çƒ¦ æœ‰äººè¯´ä¸ºä»€ä¹ˆä¸ç”¨Filebeat ingestç›´æ¥åˆ°ES, è¿™è¦å›¾æ ‡ç”¨Kibanaå°±å¥½äº†. æˆ‘çš„è€ƒè™‘æ˜¯:1.è¿˜è¦åšè°“è¯å»é™¤2.è¿™æ ·åšå‡ºçš„å›¾æ²¡æ³•å’Œæˆ‘ä»¬ä¸šåŠ¡çš„æœåŠ¡æ•°å…³è”, ä¸šåŠ¡äººå‘˜æŸ¥è¯¢å°±å¿…é¡»çŸ¥é“æ•°æ®åº“çš„IPç«¯å£è¯¦ç»†æ–¹æ¡ˆå¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡æ¡£ https://www.jianshu.com/p/f3be9cce9b77https://www.jianshu.com/p/3cf0e2a8d23d æ–¹æ¡ˆ2 è¿™ä¸ªæ–¹æ¡ˆå…³é”®ç‚¹åœ¨äºå°†log_outputå‚æ•°è®¾ç½®ä¸º&#39;FILE,TABLE&#39;, é‚£ä¹ˆMySQLä¼šåœ¨mysql.slow_logè¡¨ä¸­è®°å½•æ…¢æŸ¥è¯¢ä¿¡æ¯ è€Œè¿™ä¸æ˜¯æ­£æ˜¯æ–¹æ¡ˆ1ä¸­æˆ‘ä»¬è´¹äº†åŠå¤©åŠ²ç”¨logstashæƒ³è¦è¾¾åˆ°çš„ç»“æœå—? è€Œmysql.slow_logåˆæ°å¥½æ˜¯ä¸€ä¸ªcsvå¼•æ“çš„è¡¨ æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿°, csvè¿™ä¸ªæ ¼å¼å¯ä»¥è¯»,ç”šè‡³å¯ä»¥å†™. é‚£å®ƒå…¶å®å°±æ˜¯ä¸ªæ–‡æœ¬å•Š, æˆ‘ä»¬ç”¨Filebeatè¯»å®ƒå‘—. è¿™ä¸ªæ¶æ„æ„æ€å·§å¦™, æˆ‘éƒ½ä½©æœæˆ‘è‡ªå·±äº†, ä½†æ˜¯ä¸ºå•¥ä¸šç•Œæ²¡äººç”¨å‘¢? ä¼˜ç‚¹: æ¶æ„ç®€å•æ˜“å®ç°, æ—¥å¿—å®æ—¶è·å– ç¼ºç‚¹: éœ€è¦æµ‹è¯•,ä¸ºå•¥æ²¡äººç”¨?å¯èƒ½æœ‰å‘ æ–¹æ¡ˆ3è€è·¯å­ å¾ˆç®€å•çš„æ¶æ„, å¯¹æŠ€æœ¯æ°´å¹³è¦æ±‚å¾ˆä½, åˆçº§DBAå°±å¯ä»¥å®ç°çš„æ–¹æ¡ˆåŸç†æ˜¯åœ¨æ¯ä¸ªMySQLæœåŠ¡å™¨éƒ¨ç½²å®šæ—¶ä»»åŠ¡, æ‰§è¡Œpt-query-digest1/bin/pt-query-digest --user=slow_query_w --password=$FUCK --review h=192.168.2.142,D=db_slow_query,t=t_$&#123;ha_group_name&#125;_query_review --history h=192.168.2.142,D=db_slow_query,t=t_$&#123;ha_group_name&#125;_query_review_history --no-report --limit=0% --filter=&quot; \\$event-&gt;&#123;Bytes&#125; = length(\\$event-&gt;&#123;arg&#125;) and \\$event-&gt;&#123;hostname&#125;=\\&quot;$HOSTNAME\\&quot;&quot; $slow_log-`date +%Y%m%d`pt-query-digest ä¼šåˆ†æslow log, å°†ç»“æœæ’å…¥æ•°æ®åº“è¿™ä¸ªç»“æœå°±æ˜¯å°±åŒ…å«äº†å»é™¤è°“è¯çš„SQL è¿™ä¸ªæ–¹æ¡ˆå…¶å®æ˜¯æ¯”è¾ƒè€ä¹Ÿæ¯”è¾ƒç®€å•ç»å…¸çš„æ–¹æ¡ˆ, Anemometer, Query-Digest-UIéƒ½æ˜¯è¿™ä¹ˆåšçš„. æœ€å¼€å§‹è®¨è®ºæ–¹æ¡ˆæ—¶, å…¶å®æˆ‘ä¸ªäººæ˜¯ç”±äºä¸æƒ³é‡å¤è€è·¯å­æ‰æ²¡é€‰è¿™ä¸ªæ–¹æ¡ˆ ä¼˜ç‚¹: æ¶æ„ç®€å•æ˜“äºå®ç°ä¸ç»´æŠ¤ ç¼ºç‚¹: å®æ—¶æ€§è¾ƒå·®, é€¼æ ¼ä½","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLç›‘æ§","slug":"MySQLç›‘æ§","permalink":"http://fuxkdb.com/tags/MySQL%E7%9B%91%E6%8E%A7/"}]},{"title":"è®°å½•ä¸€äº›æœ‰ç”¨çš„pt-query-digest filter","slug":"2019-07-03-è®°å½•ä¸€äº›æœ‰ç”¨çš„pt-query-digest-filter","date":"2019-07-03T15:03:33.000Z","updated":"2019-07-03T15:10:45.000Z","comments":true,"path":"2019/07/03/2019-07-03-è®°å½•ä¸€äº›æœ‰ç”¨çš„pt-query-digest-filter/","link":"","permalink":"http://fuxkdb.com/2019/07/03/2019-07-03-%E8%AE%B0%E5%BD%95%E4%B8%80%E4%BA%9B%E6%9C%89%E7%94%A8%E7%9A%84pt-query-digest-filter/","excerpt":"è‡ªå·±å†™äº†ä¸€äº›å’Œæ•´ç†äº†äº›filter, ç™¾åº¦æ˜¯æœä¸åˆ°çš„å“ˆ, é™¤äº†æœ€åé‚£ä¿©anemometerçš„ ä¸è¾“å‡ºDatabase ä¸º mysql|performance_schema|information_schema|sys|db_monitor çš„æŸ¥è¯¢1((\\$event-&gt;&#123;db&#125; || &#x27;&#x27;) =~ m/^(?!(mysql|performance_schema|information_schema|sys|db_monitor))/","text":"è‡ªå·±å†™äº†ä¸€äº›å’Œæ•´ç†äº†äº›filter, ç™¾åº¦æ˜¯æœä¸åˆ°çš„å“ˆ, é™¤äº†æœ€åé‚£ä¿©anemometerçš„ ä¸è¾“å‡ºDatabase ä¸º mysql|performance_schema|information_schema|sys|db_monitor çš„æŸ¥è¯¢1((\\$event-&gt;&#123;db&#125; || &#x27;&#x27;) =~ m/^(?!(mysql|performance_schema|information_schema|sys|db_monitor))/ ä¸è¾“å‡º Users ä¸º pmm|mysqlcheck|dbms_monitor_r ç”¨æˆ·çš„æŸ¥è¯¢1(\\$event-&gt;&#123;user&#125; || &#x27;&#x27;) =~ m/^(?!(pmm|mysqlcheck|dbms_monitor_r|proxysql))/i ä¸è¾“å‡ºcheksum=â€™64EF0EA126730002088884A136067321â€™çš„ ä¹Ÿå°±æ˜¯throttle: 396 â€˜index not usedâ€™ warning(s) suppressed.\\G1\\$event-&gt;&#123;fingerprint&#125; &amp;&amp; make_checksum(\\$event-&gt;&#123;fingerprint&#125;) ne &#x27;64EF0EA126730002088884A136067321&#x27; \\$event-&gt;{Bytes} = length(\\$event-&gt;{arg}) å’Œ \\$event-&gt;{hostname}=\\â€$HOSTNAME\\â€ å¢åŠ  Bytes å’Œ hostname å†…å®¹123456789101112131415161718192021222324252627282930313233343536373839# Query 19: 0 QPS, 0x concurrency, ID 0xE3B736208C9A5A96A9D7E7DFF3BEF268 at byte 2298558# This item is included in the report because it matches --limit.# Scores: V/M = 0.00# Time range: all events occurred at 2019-07-03T03:09:30# Attribute pct total min max avg 95% stddev median# ============ === ======= ======= ======= ======= ======= ======= =======# Count 0 1# Exec time 0 448us 448us 448us 448us 448us 0 448us# Lock time 0 132us 132us 132us 132us 132us 0 132us# Rows sent 0 10 10 10 10 10 0 10# Rows examine 0 172 172 172 172 172 0 172# Query size 0 117 117 117 117 117 0 117# Bytes 0 117 117 117 117 117 0 117 --å¢åŠ çš„# String:# Databases mydb# Hosts 192.168.x.110# hostname node00xxx --å¢åŠ çš„# Users xxx# Query_time distribution...å¯¹æ¯”æ²¡æœ‰ä½¿ç”¨# Query 5: 0.00 QPS, 0.00x concurrency, ID 0x39226EA9FD5344CDD6F89A75B34D97F3 at byte 2168772# Scores: V/M = 0.00# Time range: 2019-07-02T22:54:11 to 2019-07-03T14:58:30# Attribute pct total min max avg 95% stddev median# ============ === ======= ======= ======= ======= ======= ======= =======# Count 0 157# Exec time 1 11s 60ms 94ms 70ms 75ms 5ms 68ms# Lock time 0 15ms 48us 321us 95us 167us 42us 84us# Rows sent 0 157 1 1 1 1 0 1# Rows examine 31 29.50M 192.11k 192.78k 192.42k 192.13k 339 192.13k# Query size 0 12.42k 80 81 80.99 80.10 0.43 80.10# String:# Databases mydb# Hosts 192.168.x.50 (90/57%), 192.168.x.211 (67/42%)# Users xxx# Query_time distribution... æœ€ç»ˆ1/bin/pt-query-digest --limit=0% --filter=&quot; \\$event-&gt;&#123;Bytes&#125; = length(\\$event-&gt;&#123;arg&#125;) and \\$event-&gt;&#123;hostname&#125;=\\&quot;$HOSTNAME\\&quot; and ((\\$event-&gt;&#123;db&#125; || &#x27;&#x27;) =~ m/^(?!(mysql|performance_schema|information_schema|sys|db_monitor))/ and (\\$event-&gt;&#123;user&#125; || &#x27;&#x27;) =~ m/^(?!(pmm|mysqlcheck|dbms_monitor_r|proxysql))/i and \\$event-&gt;&#123;fingerprint&#125; &amp;&amp; make_checksum(\\$event-&gt;&#123;fingerprint&#125;) ne &#x27;64EF0EA126730002088884A136067321&#x27; )&quot; slow-queries.logä¸è¿‡ä¸Šé¢çš„å‘½ä»¤ä¸èƒ½ç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œ, åªèƒ½å†™åˆ°shellè„šæœ¬é‡Œå†å»æ‰§è¡Œè„šæœ¬","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Percona Toolkit","slug":"Percona-Toolkit","permalink":"http://fuxkdb.com/tags/Percona-Toolkit/"}]},{"title":"MySQLå¤§è¡¨ä¼ è¾“è¡¨ç©ºé—´çš„å‘","slug":"2019-06-22-MySQLå¤§è¡¨ä¼ è¾“è¡¨ç©ºé—´çš„å‘","date":"2019-06-22T11:23:00.000Z","updated":"2020-12-08T02:26:13.721Z","comments":true,"path":"2019/06/22/2019-06-22-MySQLå¤§è¡¨ä¼ è¾“è¡¨ç©ºé—´çš„å‘/","link":"","permalink":"http://fuxkdb.com/2019/06/22/2019-06-22-MySQL%E5%A4%A7%E8%A1%A8%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4%E7%9A%84%E5%9D%91/","excerpt":"MySQLå¤§è¡¨ä¼ è¾“è¡¨ç©ºé—´çš„å‘ æœ€è¿‘åˆšå¸®ä¸šåŠ¡çº¿æ‹†åˆ†å®Œæ•°æ®åº“, æºç¯å¢ƒé—ç•™äº†ä¸€å¼ 700Gçš„å¤§è¡¨, è™½è¯´ç°åœ¨ä¸ç”¨äº†, ä½†æ˜¯ä¸šåŠ¡æ–¹è¿˜æ˜¯ä¸å¸Œæœ›åˆ æ‰, äºæ˜¯æ‰“ç®—æŠŠè¿™å¼ è¡¨è¿ç§»åˆ°å½’æ¡£åº“, è¿™æ ·æœ‰éœ€è¦æ˜¯è¿˜å¯ä»¥æŸ¥è¯¢. 700Gçš„è¡¨æƒ³äº†æƒ³, å¦‚æœæ˜¯é€»è¾‘å¯¼å‡ºå†å¯¼å…¥çš„è¯, æ„Ÿè§‰ä¼šå¾ˆæ…¢. äºæ˜¯å†³å®šä½¿ç”¨ä¼ è¾“è¡¨ç©ºé—´æ–¹å¼æ¢å¤åˆ°å½’æ¡£åº“ä¸­ æºåº“å’Œå½’æ¡£åº“å‡ä¸ºMGRé›†ç¾¤ Multi-Primary Mode. æ¢å¤å¤‡ä»½è¿‡ç¨‹ç®€å•å†™, å¹¶éæœ¬æ–‡é‡ç‚¹12345xbstream -vx --parallel=10 &lt; mysql_backup_20190618.xbstream -C /rundata/backup/ &gt; /tmp/xb.log 2&gt;&amp;1 &amp;cd /rundata/backup/datadirrm é™¤è¿™å¼ 700gè¡¨Açš„æ‰€æœ‰å…¶ä»–è¡¨çš„qpæ–‡ä»¶xtrabackup --decompress --parallel=10 --remove-original --target-dir=/rundata/backup/innobackupex --apply-log --export /rundata/backup/","text":"MySQLå¤§è¡¨ä¼ è¾“è¡¨ç©ºé—´çš„å‘ æœ€è¿‘åˆšå¸®ä¸šåŠ¡çº¿æ‹†åˆ†å®Œæ•°æ®åº“, æºç¯å¢ƒé—ç•™äº†ä¸€å¼ 700Gçš„å¤§è¡¨, è™½è¯´ç°åœ¨ä¸ç”¨äº†, ä½†æ˜¯ä¸šåŠ¡æ–¹è¿˜æ˜¯ä¸å¸Œæœ›åˆ æ‰, äºæ˜¯æ‰“ç®—æŠŠè¿™å¼ è¡¨è¿ç§»åˆ°å½’æ¡£åº“, è¿™æ ·æœ‰éœ€è¦æ˜¯è¿˜å¯ä»¥æŸ¥è¯¢. 700Gçš„è¡¨æƒ³äº†æƒ³, å¦‚æœæ˜¯é€»è¾‘å¯¼å‡ºå†å¯¼å…¥çš„è¯, æ„Ÿè§‰ä¼šå¾ˆæ…¢. äºæ˜¯å†³å®šä½¿ç”¨ä¼ è¾“è¡¨ç©ºé—´æ–¹å¼æ¢å¤åˆ°å½’æ¡£åº“ä¸­ æºåº“å’Œå½’æ¡£åº“å‡ä¸ºMGRé›†ç¾¤ Multi-Primary Mode. æ¢å¤å¤‡ä»½è¿‡ç¨‹ç®€å•å†™, å¹¶éæœ¬æ–‡é‡ç‚¹12345xbstream -vx --parallel=10 &lt; mysql_backup_20190618.xbstream -C /rundata/backup/ &gt; /tmp/xb.log 2&gt;&amp;1 &amp;cd /rundata/backup/datadirrm é™¤è¿™å¼ 700gè¡¨Açš„æ‰€æœ‰å…¶ä»–è¡¨çš„qpæ–‡ä»¶xtrabackup --decompress --parallel=10 --remove-original --target-dir=/rundata/backup/innobackupex --apply-log --export /rundata/backup/ å¼€å§‹ä¼ è¾“è¡¨ç©ºé—´1.åœ¨å½’æ¡£åº“åˆ›å»ºè¯¥è¡¨1mysql&gt; create table A3.åœ¨å½’æ¡£åº“å†™èŠ‚ç‚¹æ‰§è¡Œ1mysql&gt; alter table A discard tablespace;3.å°†ä¸Šä¸€æ­¥äº§ç”Ÿçš„ A.ibd A.cfg ä¼ è¾“åˆ°å½’æ¡£åº“MGRé›†ç¾¤æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„datadirç›®å½•ä¸‹12chown mysql:mysql A.*mysql&gt; alter table A import tablespace; æ‹·è´åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„åŸå› è¯¦è§ ä¸»ä»ä¼ è¾“è¡¨ç©ºé—´çš„å‘ æ­¤æ—¶å‘ç°import tablespaceå¡ä½äº†Stateä¸ºSystem lock, æŸ¥çœ‹processlist1234567891011121314151617+----------+----------------+----------------------+----------+-------------+----------+---------------------------------------------------------------+-------------------------------------------------------+| Id | User | Host | db | Command | Time | State | Info |+----------+----------------+----------------------+----------+-------------+----------+---------------------------------------------------------------+-------------------------------------------------------+| 370 | system user | | NULL | Connect | 26094679 | executing | NULL || 373 | system user | | NULL | Connect | 3703683 | Slave has read all relay log; waiting for more updates | NULL || 374 | system user | | NULL | Connect | 26094679 | Waiting for an event from Coordinator | NULL || 375 | system user | | NULL | Connect | 19086256 | Waiting for an event from Coordinator | NULL || 376 | system user | | NULL | Connect | 19086744 | Waiting for an event from Coordinator | NULL || 377 | system user | | NULL | Connect | 19086744 | Waiting for an event from Coordinator | NULL || 378 | system user | | NULL | Connect | 19086744 | Waiting for an event from Coordinator | NULL || 379 | system user | | NULL | Connect | 19086894 | Waiting for an event from Coordinator | NULL || 380 | system user | | NULL | Connect | 19086894 | Waiting for an event from Coordinator | NULL || 381 | system user | | NULL | Connect | 19086903 | Waiting for an event from Coordinator | NULL || 33199176 | dbms_monitor_r | 192.168.X.81:38804 | NULL | Binlog Dump | 7696834 | Master has sent all binlog to slave; waiting for more updates | NULL || 58758525 | root | localhost | archive | Query | 1598 | System lock | ALTER TABLE A IMPORT TABLESPACE || 58764027 | root | localhost | NULL | Query | 0 | starting | show processlist |+----------+----------------+----------------------+----------+-------------+----------+---------------------------------------------------------------+-------------------------------------------------------+æŸ¥çœ‹error log, å‘ç°åœ¨é˜¶æ®µ1 Update all pages122019-06-22T06:34:14.173468Z 58758525 [Note] InnoDB: Importing tablespace for table &#x27;origin_db/A&#x27; that was exported from host &#x27;Hostname unknown&#x27;2019-06-22T06:34:14.173672Z 58758525 [Note] InnoDB: Phase I - Update all pagesåˆç­‰äº†ä¸€ä¼š, å‘ç°ç›‘æ§ä»»åŠ¡æ‰§è¡Œçš„SQLè¢«é˜»å¡äº†.12345678910111213141516171819+----------+----------------+----------------------+--------------------+-------------+----------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+| Id | User | Host | db | Command | Time | State | Info |+----------+----------------+----------------------+--------------------+-------------+----------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+| 370 | system user | | NULL | Connect | 26094907 | executing | NULL || 373 | system user | | NULL | Connect | 3703911 | Slave has read all relay log; waiting for more updates | NULL || 374 | system user | | NULL | Connect | 26094907 | Waiting for an event from Coordinator | NULL || 375 | system user | | NULL | Connect | 19086484 | Waiting for an event from Coordinator | NULL || 376 | system user | | NULL | Connect | 19086972 | Waiting for an event from Coordinator | NULL || 377 | system user | | NULL | Connect | 19086972 | Waiting for an event from Coordinator | NULL || 378 | system user | | NULL | Connect | 19086972 | Waiting for an event from Coordinator | NULL || 379 | system user | | NULL | Connect | 19087122 | Waiting for an event from Coordinator | NULL || 380 | system user | | NULL | Connect | 19087122 | Waiting for an event from Coordinator | NULL || 381 | system user | | NULL | Connect | 19087131 | Waiting for an event from Coordinator | NULL || 33199176 | dbms_monitor_r | 192.168.X.81:38804 | NULL | Binlog Dump | 7697062 | Master has sent all binlog to slave; waiting for more updates | NULL || 58758525 | root | localhost | archive | Query | 1826 | System lock | ALTER TABLE A IMPORT TABLESPACE || 58764075 | dbms_monitor_r | 192.168.X.142:41144 | information_schema | Query | 214 | Waiting for table metadata lock | select * from tables || 58764750 | dbms_monitor_r | 192.168.X.142:25374 | mysql | Query | 18 | Waiting for table metadata lock | select * from information_schema.tables where table_schema not in (&#x27;mysql&#x27;,&#x27;information_schema&#x27;,&#x27;sys || 58764840 | root | localhost | NULL | Query | 0 | starting | show processlist |+----------+----------------+----------------------+--------------------+-------------+----------+---------------------------------------------------------------+------------------------------------------------------------------------------------------------------+ æŸ¥çœ‹innodb status12345678910111213141516171819[2019-06-22 14:35:11]root@localhost 14:35:02 [(none)]&gt; show engine innodb status\\G[2019-06-22 14:35:11]------------[2019-06-22 14:35:11]TRANSACTIONS[2019-06-22 14:35:11]------------[2019-06-22 14:35:11]Trx id counter 3747414252[2019-06-22 14:35:11]Purge done for trx&#x27;s n:o &lt; 3747414158 undo n:o &lt; 0 state: running but idle[2019-06-22 14:35:11]History list length 1[2019-06-22 14:35:11]LIST OF TRANSACTIONS FOR EACH SESSION:[2019-06-22 14:35:11]---TRANSACTION 422073426655200, not started...[2019-06-22 14:35:11]0 lock struct(s), heap size 1136, 0 row lock(s)[2019-06-22 14:35:11]MySQL thread id 58758525, OS thread handle 140583989245696, query id 6550373059 localhost root System lock[2019-06-22 14:35:11]ALTER TABLE sales_sku_operation_log IMPORT TABLESPACE[2019-06-22 14:35:11]---TRANSACTION 3747414146, ACTIVE 57 sec importing tablespace[2019-06-22 14:35:11]mysql tables in use 1, locked 1[2019-06-22 14:35:11]1 lock struct(s), heap size 1136, 0 row lock(s)[2019-06-22 14:35:11]MySQL thread id 58758525, OS thread handle 140583989245696, query id 6550373059 localhost root System lock[2019-06-22 14:35:11]ALTER TABLE sales_sku_operation_log IMPORT TABLESPACEè™½ç„¶innodb statusæˆ‘å·²ç»åŸºæœ¬ä¸ä¼šçœ‹äº†, ä½†æ˜¯ä»TRANSACTIONSè¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°IMPORT TABLESPACEè¯­å¥å¹¶æ²¡æœ‰è¢«ä»€ä¹ˆé”é˜»å¡ å½“æ—¶æƒ³ä¸æ˜ç™½ä¸ºå•¥import tablespaceä¼šè¿™ä¹ˆæ…¢, ä»¥ä¸ºè¢«MGRå¤åˆ¶çš„ç›¸å…³çº¿ç¨‹é˜»å¡äº†,æˆ–è€…æœ‰ä»€ä¹ˆbugä¹‹ç±»çš„, æ€•å½±å“ä¸šåŠ¡(è™½è¯´æ˜¯å½’æ¡£åº“). äºæ˜¯æˆ‘killäº†è¿™ä¸ªimport tablespaceè¯­å¥,1kill 58758525;åœ¨è¿™ä¹‹åå¦‚æœæƒ³é‡æ–°æ‰§è¡ŒALTER TABLE A IMPORT TABLESPACEä¼šæŠ¥é”™12root@localhost 15:11:53 [mafengwo]&gt; ALTER TABLE sales_sku_operation_log IMPORT TABLESPACE;ERROR 1815 (HY000): Internal error: Cannot reset LSNs in table `mafengwo`.`sales_sku_operation_log` : Data structure corruptionè§‚å¯Ÿé›†ç¾¤ä¸‰ä¸ªèŠ‚ç‚¹çš„æ–‡ä»¶çŠ¶æ€å‘ç°, æ‰§è¡ŒALTER TABLE A IMPORT TABLESPACEè¯­å¥çš„èŠ‚ç‚¹çš„A.ibdæ–‡ä»¶ä¿®æ”¹æ—¶é—´å˜äº†(è€Œå…¶ä»–èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–).12345[root@node001189 mafengwo]# ll | grep A-rw-r--r-- 1 mysql mysql 1091 Jun 21 13:20 A.cfg-rw-r----- 1 mysql mysql 16384 Jun 21 13:20 A.exp-rw-r----- 1 mysql mysql 9094 Jun 22 14:11 A.frm-rw-r--r-- 1 mysql mysql 799329484800 Jun 21 13:20 A.ibdæ‰§è¡ŒALTERå1234[root@node001189 mafengwo]# ll | grep A -rw-r--r-- 1 mysql mysql 1091 Jun 21 13:20 A.cfg-rw-r----- 1 mysql mysql 16384 Jun 21 13:20 A.exp-rw-r--r-- 1 mysql mysql 799329484800 Jun 22 15:12 A.ibd --å˜äº† ä¸ºä»€ä¹ˆIMPORT TABLESPACEä¼šå¡ä½?æ­£å¸¸çš„importæµç¨‹,æ—¥å¿—ä¸­ä¼šæœ‰å¦‚ä¸‹è¾“å‡º1234562013-07-18 15:15:01 34960 [Note] InnoDB: Importing tablespace for table &#x27;test/t&#x27; that was exported from host &#x27;ubuntu&#x27;2013-07-18 15:15:01 34960 [Note] InnoDB: Phase I - Update all pages2013-07-18 15:15:01 34960 [Note] InnoDB: Sync to disk2013-07-18 15:15:01 34960 [Note] InnoDB: Sync to disk - done!2013-07-18 15:15:01 34960 [Note] InnoDB: Phase III - Flush changes to disk2013-07-18 15:15:01 34960 [Note] InnoDB: Phase IV - Flush completeæˆ‘è§‰å¾—é—®é¢˜å…³é”®åœ¨äºInnoDB: Phase I - Update all pagesåˆ°åº•åšäº†ä»€ä¹ˆ, å› ä¸ºäº‹å®ä¸Šimportè¿‡ç¨‹ä¸€ç›´å¡åœ¨è¿™é‡Œ, æ²¡æœ‰è¿›å…¥ä¸‹ä¸€æ­¥googleäº†ä¸€åœˆå‘ç°ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜, ä½†æ˜¯å¹¶æ²¡æœ‰ç­”æ¡ˆ(ç°åœ¨æœ‰äº†æ˜¯æˆ‘å›ç­”çš„)https://dba.stackexchange.com/questions/165147/import-tablespace-is-hanging-in-the-system-lock-state/241182#241182 æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£https://dev.mysql.com/doc/refman/8.0/en/tablespace-copying.htmlWhen ALTER TABLE â€¦ IMPORT TABLESPACE is run on the destination instance, the import algorithm performs the following operations for each tablespace being imported: Each tablespace page is checked for corruption. The space ID and log sequence numbers (LSNs) on each page are updated Flags are validated and LSN updated for the header page. Btree pages are updated. The page state is set to dirty so that it is written to disk. æŸ¥çœ‹workloghttps://dev.mysql.com/worklog/task/?id=552212345678910111213141516171819202122232425262728293031Import algorithm================We scan the blocks in extents and modify individual blocks rather than using logical index structure.foreach page in tablespace &#123; 1. Check each page for corruption. 2. Update the space id and LSN on every page --I think this is what &quot;InnoDB: Phase I - Update all pages&quot; does * For the header page - Validate the flags - Update the LSN 3. On Btree pages * Set the index id * Update the max trx id * In a cluster index, update the system columns * In a cluster index, update the BLOB ptr, set the space id * Purge delete marked records, but only if they can be easily removed from the page * Keep a counter of number of rows, ie. non-delete-marked rows * Keep a counter of number of delete marked rows * Keep a counter of number of purge failure * If a page is stamped with an index id that isn&#x27;t in the .cfg file we assume it is deleted and the page can be ignored. * We can&#x27;t tell free pages from allocated paes (for now). Therefore the assumption is that the free pages are either empty or are logically consistent. TODO: Cache the extent bitmap and check free pages. 4. Set the page state to dirty so that it will be written to disk.&#125; è¿˜æœ‰ä¸€ä¸ªæ–‡æ¡£, ä¸è¿‡æ„Ÿè§‰ä¸å¦‚ä¸Šé¢ä¸¤ä¸ªè¯´çš„æ˜ç™½https://bugs.mysql.com/bug.php?id=75706 çœ‹åˆ°è¿™é‡Œæˆ‘è®¤ä¸ºInnoDB: Phase I - Update all pages é˜¶æ®µæ‰§è¡Œçš„å°±æ˜¯ (æŒ‰extendæ‰«ææ•´ä¸ªè¡¨, ä¿®æ”¹æ¯ä¸ªpageçš„LSNç­‰)12342. Update the space id and LSN on every page * For the header page - Validate the flags - Update the LSNè¿™ä¸€æ­¥ä¸€å®šå¾ˆè€—æ—¶, æŸ¥çœ‹ç›‘æ§, ä¹Ÿç¡®å®å‘ç°æ‰§è¡ŒALTER TABLE A IMPORT TABLESPACEçš„èŠ‚ç‚¹å†è¿™ä¸ªæ—¶é—´æ®µIOæœ‰æ˜æ˜¾ä¸Šå‡ å…¶ä»–èŠ‚ç‚¹ æ‰€ä»¥è¿™ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜?ä¼šå¯¼è‡´å¤åˆ¶å»¶è¿Ÿæ— è®ºä¸»ä»å¤åˆ¶, PXC è¿˜æ˜¯ MGR ,æœ¬è´¨éƒ½æ˜¯åº”ç”¨binlog ç¤ºä¾‹, ä¸ä¹‹å‰çš„æ“ä½œæ— å…³123456789101112131415161718/usr/local/mysql-5.7.23-linux-glibc2.12-x86_64/bin/mysqlbinlog -vv --base64-output=decode-rows 0242133310-relay-bin-group_replication_applier.000002|lessSET @@SESSION.GTID_NEXT= &#x27;88f93f74-ed3a-50c0-bc63-beb926cedcb5:1033040&#x27;/*!*/;# at 15134136#190621 10:45:09 server id 242123310 end_log_pos 126 Query thread_id=4948397 exec_time=0 error_code=0SET TIMESTAMP=1561085109/*!*/;alter table t_monitor_sync_delay DISCARD TABLESPACE/*!*/;# at 15134262#190227 16:34:38 server id 242123310 end_log_pos 61 GTID last_committed=196812 sequence_number=196813 rbr_only=noSET @@SESSION.GTID_NEXT= &#x27;88f93f74-ed3a-50c0-bc63-beb926cedcb5:1033041&#x27;/*!*/;# at 15134323#190621 10:46:21 server id 242123310 end_log_pos 125 Query thread_id=4948487 exec_time=0 error_code=0SET TIMESTAMP=1561085181/*!*/;alter table t_monitor_sync_delay import tablespace/*!*/;# at 15134448#190227 16:34:38 server id 242123310 end_log_pos 61 GTID last_committed=198535 sequence_number=198536 rbr_only=noå¯ä»¥çœ‹åˆ°binlogä¸­å…¶å®åªè®°å½•äº†alter table t_monitor_sync_delay DISCARD TABLESPACE å’Œ alter table t_monitor_sync_delay import tablespaceä¸¤ä¸ªè¯­å¥, å¹¶æ²¡æœ‰å¯¹è¿™å¼ è¡¨çš„INSERTè¯­å¥ æˆ‘ä»¬å‡è®¾å‘èµ·import tablespaceçš„èŠ‚ç‚¹æœ€ç»ˆèŠ±è´¹1å°æ—¶æ›´æ–°äº†æ‰€æœ‰Aè¡¨pagesçš„LSNå’Œå…¶ä»–ä¿¡æ¯, æˆåŠŸçš„è·‘å®Œäº†import tablespaceè¯­å¥. å½“å…¶ä»–èŠ‚ç‚¹åº”ç”¨åˆ°è¿™ä¸ªimport tablespaceè¯­å¥æ˜¯å°±ä¹Ÿè¦èŠ±è´¹1å°æ—¶å»åšç›¸åŒçš„æ“ä½œ, é‚£é¢åé¢çš„äº‹åŠ¡æ˜¯å¦å°±éœ€è¦ç­‰å¾…è¿™ä¸ªimport tablespaceæ‰§è¡Œå®Œæ¯•å‘¢? æ‰€ä»¥åº”è¯¥å¦‚ä½•å¯¼å…¥?ä»¥ä¸‰èŠ‚ç‚¹MGRä¸ºä¾‹å…ˆå»ºè¡¨1create table Aç„¶åä¸€ä¸ªä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œ1234567stop group_replicationset read_only=1, ç¡®ä¿æ²¡æœ‰æ•°æ®å†™å…¥set sql_log_bin=0alter table A discard tablespacealter table A import tablespaceset sql_log_bin=1start group_replication","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"ä¼ è¾“è¡¨ç©ºé—´","slug":"ä¼ è¾“è¡¨ç©ºé—´","permalink":"http://fuxkdb.com/tags/%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4/"}]},{"title":"é™åˆ¶å¤‡ä»½é€Ÿåº¦é˜²æ­¢ç½‘å¡æ‰“æ»¡","slug":"é™åˆ¶å¤‡ä»½é€Ÿåº¦é˜²æ­¢ç½‘å¡æ‰“æ»¡","date":"2019-06-11T20:00:00.000Z","updated":"2019-06-11T19:51:02.000Z","comments":true,"path":"2019/06/12/é™åˆ¶å¤‡ä»½é€Ÿåº¦é˜²æ­¢ç½‘å¡æ‰“æ»¡/","link":"","permalink":"http://fuxkdb.com/2019/06/12/%E9%99%90%E5%88%B6%E5%A4%87%E4%BB%BD%E9%80%9F%E5%BA%A6%E9%98%B2%E6%AD%A2%E7%BD%91%E5%8D%A1%E6%89%93%E6%BB%A1/","excerpt":"","text":"é™åˆ¶å¤‡ä»½é€Ÿåº¦é˜²æ­¢ç½‘å¡æ‰“æ»¡æœ€è¿‘åœ¨åšæ‹†åº“, äºæ˜¯å°±åšäº†å¾ˆå¤šè¡¨è¿ç§»å·¥ä½œ, éœ€è¦ä½¿ç”¨mysqldumpè¿œç¨‹å¤‡ä»½æ•°æ®, ç„¶åå‘ç°å¤‡ä»½æ—¶å¾ˆå®¹æ˜“å°±æŠŠæºåº“ç½‘å¡æ‰“æ»¡äº†. æƒ³è¿‡ç”¨tcå‘½ä»¤é™é€Ÿ, å‘ç°æœ‰ç‚¹å¤æ‚. ä»Šå¤©æ— æ„é—´çœ‹xtrabackupæ–‡æ¡£å‘ç°ä¸€ä¸ªæ–¹æ³• Throttling the throughput to 10MB/sec. This requires the â€˜pvâ€™ tools; you can find them at the official site or install it from the distribution package (â€œapt-get install pvâ€)12$ innobackupex --stream=tar ./ | pv -q -L10m \\| ssh user@desthost &quot;cat - &gt; /data/backups/backup.tar&quot; Make a Streaming Backuphttps://www.percona.com/doc/percona-xtrabackup/2.4/howtos/recipes_ibkx_stream.html æŸ¥çœ‹pvçš„ä»‹ç», ä¸»è¦æ˜¯è¾…åŠ©æŸ¥çœ‹ä¸€äº›è¿›åº¦ progressbar ETAä»€ä¹ˆçš„: å¦‚ä½•ä½¿ç”¨ pv å‘½ä»¤ç›‘æ§ linux å‘½ä»¤çš„æ‰§è¡Œè¿›åº¦ å¦‚ä½•ä½¿ç”¨â€œpvâ€å‘½ä»¤ç›‘è§†ï¼ˆå¤åˆ¶/å¤‡ä»½/å‹ç¼©ï¼‰æ•°æ®çš„è¿›åº¦ - Howtoingè¿ç»´æ•™ç¨‹ pvå‘½ä»¤ä»‹ç» åœ¨googleæœç´¢mysqldump pv åŸºæœ¬ä¹Ÿæ˜¯äº›æŸ¥çœ‹è¿›åº¦çš„æ–‡ç«  http://landcareweb.com/questions/6489/you-mei-you-ban-fa-rang-mysqldumpjin-du-tiao-xian-shi-yong-hu-de-bei-fen-zhuang-taihttps://www.2cto.com/database/201310/248423.htmlhttps://stackoverflow.com/questions/4852933/does-mysqldump-support-a-progress-bar æˆ‘ä»¬è¿™é‡Œä¸»è¦ç›®çš„æ˜¯é™é€Ÿ, ç…§çŒ«ç”»è™, å¯ä»¥è¿™æ ·å®ç°å¯¼å‡ºé™é€Ÿ1mysqldump | pv -q -L10m &gt; xx.sqlé™é€Ÿå¯¼å…¥1cat xx.sql | pv -q -L10m | mysqlå¯¼å…¥æŸ¥çœ‹è¿›åº¦1pv xx.sql | mysql","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"ä¿®æ”¹sysbenchè¾“å‡ºæ ¼å¼ä¸ºcsvæˆ–json, æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡","slug":"ä¿®æ”¹sysbenchè¾“å‡ºæ ¼å¼ä¸ºcsvæˆ–json æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡","date":"2019-03-12T09:53:00.000Z","updated":"2019-03-12T10:44:02.000Z","comments":true,"path":"2019/03/12/ä¿®æ”¹sysbenchè¾“å‡ºæ ¼å¼ä¸ºcsvæˆ–json æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡/","link":"","permalink":"http://fuxkdb.com/2019/03/12/%E4%BF%AE%E6%94%B9sysbench%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F%E4%B8%BAcsv%E6%88%96json%20%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E6%A0%87/","excerpt":"ä¿®æ”¹sysbenchè¾“å‡ºæ ¼å¼ä¸ºcsvæˆ–json, æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡åœ¨oltp_common.luaæ·»åŠ (äºŒé€‰ä¸€) 12345678910111213141516171819-- è¾“å‡ºcsv-- function sysbench.hooks.report_intermediate(stat)-- sysbench.report_csv(stat)-- end-- è¾“å‡ºjson-- function sysbench.hooks.report_intermediate(stat)-- sysbench.report_json(stat)-- end è‡ªå·±å»æ‰ -- æ³¨é‡Š","text":"ä¿®æ”¹sysbenchè¾“å‡ºæ ¼å¼ä¸ºcsvæˆ–json, æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡åœ¨oltp_common.luaæ·»åŠ (äºŒé€‰ä¸€) 12345678910111213141516171819-- è¾“å‡ºcsv-- function sysbench.hooks.report_intermediate(stat)-- sysbench.report_csv(stat)-- end-- è¾“å‡ºjson-- function sysbench.hooks.report_intermediate(stat)-- sysbench.report_json(stat)-- end è‡ªå·±å»æ‰ -- æ³¨é‡Š åŠ hook 123456789101112131415161718192021sysbench.hooks.report_intermediate = function (stat) if con == nil then con = assert(sysbench.sql.driver():connect()) end sysbench.report_default(stat) create_time, node_219, node_220 = con:query_row([[select create_time,(select delay from test.test_mgr_delay_detail where ip=&#x27;192.168.2.219&#x27; order by create_time desc limit 1) as &#x27;node_219&#x27;,(select delay from test.test_mgr_delay_detail where ip=&#x27;192.168.2.220&#x27; order by create_time desc limit 1) as &#x27;node_220&#x27; from test.test_mgr_delay_detail order by create_time desc limit 1;]]) print(&quot;create_time: &quot;..create_time..&quot; node_219: &quot;..node_219..&quot; node_220: &quot;..node_220)end è¿™æ ·çš„æ•ˆæœå°±æ˜¯ 123456[ 5s ] thds: 30 tps: 73.76 qps: 1538.67 (r/w/o: 1084.35/300.82/153.51) lat (ms,95%): 733.00 err/s: 0.00 reconn/s: 0.00create_time: 2018-01-01 10:10:00 node_219: 10 node_220: 20[ 10s ] thds: 30 tps: 75.80 qps: 1519.27 (r/w/o: 1062.85/304.81/151.61) lat (ms,95%): 590.56 err/s: 0.00 reconn/s: 0.00create_time: 2018-01-01 10:15:00 node_219: 10 node_220: 20[ 15s ] thds: 30 tps: 58.39 qps: 1183.57 (r/w/o: 831.24/235.55/116.78) lat (ms,95%): 926.33 err/s: 0.00 reconn/s: 0.00create_time: 2018-01-01 10:20:00 node_219: 10 node_220: 20 æ€»ä¹‹å°±æ˜¯ä½ å¯ä»¥è‡ªå®šä»¥ä¸€äº›sqlæŸ¥è¯¢æˆ–è€…ç³»ç»Ÿå‘½ä»¤å»å¢åŠ ä¸€äº›æŒ‡æ ‡. æˆ‘è¿™é‡Œå°±æ˜¯æƒ³çœ‹ä¸åŒXXä¸‹å¯¹ä»åº“å¤åˆ¶å»¶è¿Ÿçš„å½±å“","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Sysbench","slug":"Sysbench","permalink":"http://fuxkdb.com/tags/Sysbench/"}]},{"title":"ä½¿confluent_kafkaæ”¯æŒSASL_PLAINTEXT","slug":"ä½¿confluent_kafkaæ”¯æŒSASL_PLAINTEXT","date":"2019-03-08T10:53:00.000Z","updated":"2019-03-10T05:21:48.000Z","comments":true,"path":"2019/03/08/ä½¿confluent_kafkaæ”¯æŒSASL_PLAINTEXT/","link":"","permalink":"http://fuxkdb.com/2019/03/08/%E4%BD%BFconfluent_kafka%E6%94%AF%E6%8C%81SASL_PLAINTEXT/","excerpt":"","text":"åŒäº‹ä¹‹å‰ä¸€ç›´ä½¿ç”¨kafka-pythonå¼€å‘. ä¸Šäº†ACLä»¥åå‘ç°kafka-pythonå±…ç„¶ä¸æ”¯æŒSASL_PLAINTEXT https://kafka-python.readthedocs.io/en/master/apidoc/KafkaProducer.htmlsasl_mechanism (str) â€“ string picking sasl mechanism when security_protocol is SASL_PLAINTEXT or SASL_SSL. Currently only PLAIN is supported. Default: None çœ‹äº†ä¸€ä¸‹confluent-kafkaæ˜¯æ”¯æŒçš„ä½†éœ€è¦é‡æ–°ç¼–è¯‘librdkafkaå¦åˆ™ä¼šæŠ¥é”™:1KafkaException: KafkaError&#123;code=_INVALID_ARG,val=-186,str=&quot;Failed to create producer: No provider for SASL mechanism GSSAPI: recompile librdkafka with libsasl2 or openssl support. Current build options: PLAIN SASL_SCRAM&quot;&#125; å®‰è£…confluent-kafka1234pip install confluent-kafkaCollecting confluent-kafka Downloading https://files.pythonhosted.org/packages/2a/ba/dccb27376453f91ad8fa57f75a7ba5dc188023700c1789273dec976477b2/confluent_kafka-0.11.6-cp37-cp37m-manylinux1_x86_64.whl (3.9MB) 100% |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3.9MB 984kB/s å®‰è£…librdkafkaå…‹éš†ä¸‹æ¥123456789[root@node004110 18:21:05 /tmp]git clone https://github.com/edenhill/librdkafka.gitCloning into &#x27;librdkafka&#x27;...remote: Enumerating objects: 213, done.remote: Counting objects: 100% (213/213), done.remote: Compressing objects: 100% (111/111), done.remote: Total 18133 (delta 133), reused 149 (delta 98), pack-reused 17920Receiving objects: 100% (18133/18133), 11.15 MiB | 946.00 KiB/s, done.Resolving deltas: 100% (13758/13758), done.æ£€æŸ¥ä¾èµ–1234rpm -qa| grep opensslopenssl-1.0.2k-16.el7.x86_64openssl-libs-1.0.2k-16.el7.x86_64openssl-devel-1.0.2k-16.el7.x86_64 The GNU toolchainGNU makepthreadszlib-dev (optional, for gzip compression support)libssl-dev (optional, for SSL and SASL SCRAM support) â€“è¿™ä¸ªå¯¹äºcentos openssl-devellibsasl2-dev (optional, for SASL GSSAPI support)libzstd-dev (optional, for ZStd compression support)å®‰è£…12./configuremake &amp;&amp; make installæ³¨æ„ä¸‹makeçš„æ—¶å€™è¿™é‡Œæ˜¯okå°±è¡Œ12checking for libssl (by pkg-config)... okchecking for libssl (by compile)... ok (cached) æ›¿æ¢åº“æ–‡ä»¶æŸ¥æ‰¾12find / -name &quot;librdkafka*&quot; /root/.pyenv/versions/3.7.2/lib/python3.7/site-packages/confluent_kafka/.libs/librdkafka.so.1æ›¿æ¢1234567891011121314151617181920212223242526#cd /root/.pyenv/versions/3.7.2/lib/python3.7/site-packages/confluent_kafka/.libs/[root@node004110 18:24:03 ~/.pyenv/versions/3.7.2/lib/python3.7/site-packages/confluent_kafka/.libs]#lltotal 10316-rwxr-xr-x 1 root root 2903144 Mar 8 18:20 libcrypto-4c524931.so.1.0.0-rwxr-xr-x 1 root root 6944424 Mar 8 18:20 librdkafka.so.1-rwxr-xr-x 1 root root 584072 Mar 8 18:20 libssl-01b7eff1.so.1.0.0-rwxr-xr-x 1 root root 87848 Mar 8 18:20 libz-a147dcb0.so.1.2.3-rw-r--r-- 1 root root 35336 Mar 8 18:20 monitoring-interceptor.so[root@node004110 18:24:04 ~/.pyenv/versions/3.7.2/lib/python3.7/site-packages/confluent_kafka/.libs]#mv librdkafka.so.1 librdkafka.so.1.bak[root@node004110 18:24:11 ~/.pyenv/versions/3.7.2/lib/python3.7/site-packages/confluent_kafka/.libs]#ln -s /usr/local/lib/librdkafka.so.1 librdkafka.so.1[root@node004110 18:24:23 ~/.pyenv/versions/3.7.2/lib/python3.7/site-packages/confluent_kafka/.libs]#lltotal 10316-rwxr-xr-x 1 root root 2903144 Mar 8 18:20 libcrypto-4c524931.so.1.0.0lrwxrwxrwx 1 root root 30 Mar 8 18:24 librdkafka.so.1 -&gt; /usr/local/lib/librdkafka.so.1-rwxr-xr-x 1 root root 6944424 Mar 8 18:20 librdkafka.so.1.bak-rwxr-xr-x 1 root root 584072 Mar 8 18:20 libssl-01b7eff1.so.1.0.0-rwxr-xr-x 1 root root 87848 Mar 8 18:20 libz-a147dcb0.so.1.2.3-rw-r--r-- 1 root root 35336 Mar 8 18:20 monitoring-interceptor.so éªŒè¯12345678910111213141516171819202122#pythonPython 3.7.2 (default, Mar 4 2019, 16:55:21) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] on linuxType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.&gt;&gt;&gt; from confluent_kafka import Producer &gt;&gt;&gt; p = Producer(&#123;&#x27;bootstrap.servers&#x27;: &#x27;192.168.4.114:9092&#x27;, &#x27;security.protocol&#x27;: &#x27;SASL_PLAINTEXT&#x27;, &#x27;sasl.mechanism&#x27;:&#x27;SCRAM-SHA-256&#x27;,&#x27;sasl.username&#x27;:&#x27;admin&#x27;,&#x27;sasl.password&#x27;:&#x27;your-admin-pass&#x27;&#125;) &gt;&gt;&gt; def delivery_report(err, msg):... if err is not None:... print(&#x27;Message delivery failed: &#123;&#125;&#x27;.format(err))... else:... print(&#x27;Message delivered to &#123;&#125; [&#123;&#125;]&#x27;.format(msg.topic(), msg.partition()))... &gt;&gt;&gt; for data in [&#x27;hello&#x27;,&#x27;word&#x27;]: ... p.produce(&#x27;test_acl&#x27;, data.encode(&#x27;utf-8&#x27;), callback=delivery_report)... &gt;&gt;&gt; p.poll(10) Message delivered to test_acl [0]Message delivered to test_acl [0]1&gt;&gt;&gt; p.flush()0&gt;&gt;&gt; quit() æˆåŠŸæ”¶åˆ°æ¶ˆæ¯123[root@node004114 kafka]# bin/kafka-console-consumer.sh --bootstrap-server 192.168.4.114:9092 --topic test_acl --consumer.config config/client-sasl.properties --from-beginninghelloword","categories":[],"tags":[{"name":"Kafka","slug":"Kafka","permalink":"http://fuxkdb.com/tags/Kafka/"}]},{"title":"å‡å¦‚Kafkaé›†ç¾¤ä¸­ä¸€ä¸ªbrokerå®•æœºæ— æ³•æ¢å¤, åº”è¯¥å¦‚ä½•å¤„ç†?","slug":"2019-02-22-å‡å¦‚Kafkaé›†ç¾¤ä¸­ä¸€ä¸ªbrokerå®•æœºæ— æ³•æ¢å¤,-åº”è¯¥å¦‚ä½•å¤„ç†","date":"2019-02-22T03:58:00.000Z","updated":"2019-02-22T03:58:58.000Z","comments":true,"path":"2019/02/22/2019-02-22-å‡å¦‚Kafkaé›†ç¾¤ä¸­ä¸€ä¸ªbrokerå®•æœºæ— æ³•æ¢å¤,-åº”è¯¥å¦‚ä½•å¤„ç†/","link":"","permalink":"http://fuxkdb.com/2019/02/22/2019-02-22-%E5%81%87%E5%A6%82Kafka%E9%9B%86%E7%BE%A4%E4%B8%AD%E4%B8%80%E4%B8%AAbroker%E5%AE%95%E6%9C%BA%E6%97%A0%E6%B3%95%E6%81%A2%E5%A4%8D,-%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86/","excerpt":"å‡å¦‚Kafkaé›†ç¾¤ä¸­ä¸€ä¸ªbrokerå®•æœºæ— æ³•æ¢å¤, åº”è¯¥å¦‚ä½•å¤„ç†?ååœ°é“æ—¶æƒ³åˆ°è¿™ä¸ªé—®é¢˜, å°è±¡ä¸­ä¹¦ä¸­è¯´æ·»åŠ æ–°çš„broker, æ˜¯ä¸ä¼šè‡ªåŠ¨åŒæ­¥æ—§æ•°æ®çš„. ç¬¨åŠæ³•ç¯å¢ƒä»‹ç»ä¸‰ä¸ªbrokerçš„é›†ç¾¤, zk,kafkaè£…åœ¨ä¸€èµ·12345| broker | IP | broker.id ||---------|---------------|-----------|| broker1 | 172.18.12.211 | 211 || broker2 | 172.18.12.212 | 212 || broker3 | 172.18.12.213 | 213 |","text":"å‡å¦‚Kafkaé›†ç¾¤ä¸­ä¸€ä¸ªbrokerå®•æœºæ— æ³•æ¢å¤, åº”è¯¥å¦‚ä½•å¤„ç†?ååœ°é“æ—¶æƒ³åˆ°è¿™ä¸ªé—®é¢˜, å°è±¡ä¸­ä¹¦ä¸­è¯´æ·»åŠ æ–°çš„broker, æ˜¯ä¸ä¼šè‡ªåŠ¨åŒæ­¥æ—§æ•°æ®çš„. ç¬¨åŠæ³•ç¯å¢ƒä»‹ç»ä¸‰ä¸ªbrokerçš„é›†ç¾¤, zk,kafkaè£…åœ¨ä¸€èµ·12345| broker | IP | broker.id ||---------|---------------|-----------|| broker1 | 172.18.12.211 | 211 || broker2 | 172.18.12.212 | 212 || broker3 | 172.18.12.213 | 213 | åˆ›å»ºæµ‹è¯•topic12#./bin/kafka-topics.sh --zookeeper 172.18.12.212:2181 --create --topic test1 --replication-factor 3 --partitions 1Created topic &quot;test1&quot;. æŸ¥çœ‹123#./bin/kafka-topics.sh --zookeeper 172.18.12.212:2181 --describe --topic test1Topic:test1 PartitionCount:1 ReplicationFactor:3 Configs: Topic: test1 Partition: 0 Leader: 213 Replicas: 213,212,211 Isr: 213,212,211æ³¨æ„å½“å‰Replicas: 213,212,211Isr: 213,212,211 é€ ä¸€äº›æ¶ˆæ¯1234#./bin/kafka-console-producer.sh --broker-list 172.18.12.212:9092 --topic test1&gt;1&gt;2&gt;3 kill broker2123456[root@node024212 ~]# ps -ef| grep kafkaroot 17633 1 1 Feb17 ? 00:55:18 /usr/local/java/bin/java -server -Xmx2g -Xms2g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:G1HeapRegionSize=16M -XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=85 -server -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+ExplicitGCInvokesConcurrent -Djava.awt.headless=true -Xloggc:/usr/local/kafka/bin/../logs/kafkaServer-gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=9966 -Dkafka.logs.dir=/usr/local/kafka/bin/../logs -Dlog4j.configuration=file:./bin/../config/log4j.properties -cp .:/usr/local/java/lib:/usr/local/java/jre/lib:/usr/local/kafka/bin/../libs/activation-1.1.1.jar:/usr/local/kafka/bin/../libs/aopalliance-repackaged-2.5.0-b42.jar:/usr/local/kafka/bin/../libs/argparse4j-0.7.0.jar:/usr/local/kafka/bin/../libs/audience-annotations-0.5.0.jar:/usr/local/kafka/bin/../libs/commons-lang3-3.5.jar:/usr/local/kafka/bin/../libs/compileScala.mapping:/usr/local/kafka/bin/../libs/compileScala.mapping.asc:/usr/local/kafka/bin/../libs/connect-api-2.1.0.jar:/usr/local/kafka/bin/../libs/connect-basic-auth-extension-2.1.0.jar:/usr/local/kafka/bin/../libs/connect-file-2.1.0.jar:/usr/local/kafka/bin/../libs/connect-json-2.1.0.jar:/usr/local/kafka/bin/../libs/connect-runtime-2.1.0.jar:/usr/local/kafka/bin/../libs/connect-transforms-2.1.0.jar:/usr/local/kafka/bin/../libs/guava-20.0.jar:/usr/local/kafka/bin/../libs/hk2-api-2.5.0-b42.jar:/usr/local/kafka/bin/../libs/hk2-locator-2.5.0-b42.jar:/usr/local/kafka/bin/../libs/hk2-utils-2.5.0-b42.jar:/usr/local/kafka/bin/../libs/jackson-annotations-2.9.7.jar:/usr/local/kafka/bin/../libs/jackson-core-2.9.7.jar:/usr/local/kafka/bin/../libs/jackson-databind-2.9.7.jar:/usr/local/kafka/bin/../libs/jackson-jaxrs-base-2.9.7.jar:/usr/local/kafka/bin/../libs/jackson-jaxrs-json-provider-2.9.7.jar:/usr/local/kafka/bin/../libs/jackson-module-jaxb-annotations-2.9.7.jar:/usr/local/kafka/bin/../libs/javassist-3.22.0-CR2.jar:/usr/local/kafka/bin/../libs/javax.annotation-api-1.2.jar:/usr/local/kafka/bin/../libs/javax.inject-1.jar:/usr/local/kafka/bin/../libs/javax.inject-2.5.0-b42.jar:/usr/local/kafka/bin/../libs/javax.servlet-api-3.1.0.jar:/usr/local/kafka/bin/../libs/javax.ws.rs-api-2.1.1.jar:/usr/local/kafka/bin/../libs/javax.ws.rs-api-2.1.jar:/usr/local/kafka/bin/../libs/jaxb-api-2.3.0.jar:/usr/local/kafka/bin/../libs/jersey-client-2.27.jar:/usr/local/kafka/bin/../libs/jersey-common-2.27.jar:/usr/local/kafka/bin/../libs/jersey-container-servlet-2.27.jar:/usr/local/kafka/bin/../libs/jersey-container-servlet-core-2.27.jar:/usr/local/kafka/bin/../libs/jersey-hk2-2.27.jar:/usr/local/kafka/bin/../libs/jersey-media-jaxb-2.27.jar:/usr/local/kafka/bin/../libs/jersey-server-2.27.jar:/usr/local/kafka/bin/../libs/jetty-client-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-continuation-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-http-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-io-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-security-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-server-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-servlet-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-servlets-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jetty-util-9.4.12.v20180830.jar:/usr/local/kafka/bin/../libs/jopt-simple-5.0.4.jar:/usr/local/kafka/bin/../libs/kafka_2.12-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka_2.12-2.1.0-sources.jar:/usr/local/kafka/bin/../libs/kafka-clients-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka-log4j-appender-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka-streams-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka-streams-examples-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka-streams-scala_2.12-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka-streams-test-utils-2.1.0.jar:/usr/local/kafka/bin/../libs/kafka-tools-2.1.0.jar:/usr/local/kafka/bin/../libs/log4j-1.2.17.jar:/usr/local/kafka/bin/../libs/lz4-java-1.5.0.jar:/usr/local/kafka/bin/../libs/maven-artifact-3.5.4.jar:/usr/local/kafka/bin/../libs/metrics-core-2.2.0.jar:/usr/local/kafka/bin/../libs/osgi-resource-locator-1.0.1.jar:/usr/local/kafka/bin/../libs/plexus-utils-3.1.0.jar:/usr/local/kafka/bin/../libs/reflections-0.9.11.jar:/usr/local/kafka/bin/../libs/rocksdbjni-5.14.2.jar:/usr/local/kafka/bin/../libs/scala-library-2.12.7.jar:/usr/local/kafka/bin/../libs/scala-logging_2.12-3.9.0.jar:/usr/local/kafka/bin/../libs/scala-reflect-2.12.7.jar:/usr/local/kafka/bin/../libs/slf4j-api-1.7.25.jar:/usr/local/kafka/bin/../libs/slf4j-log4j12-1.7.25.jar:/usr/local/kafka/bin/../libs/snappy-java-1.1.7.2.jar:/usr/local/kafka/bin/../libs/validation-api-1.1.0.Final.jar:/usr/local/kafka/bin/../libs/zkclient-0.10.jar:/usr/local/kafka/bin/../libs/zookeeper-3.4.13.jar:/usr/local/kafka/bin/../libs/zstd-jni-1.3.5-4.jar kafka.Kafka config/server.propertiesroot 21806 21651 0 11:27 pts/2 00:00:00 grep --color=auto kafka[root@node024212 ~]# kill -9 17633[root@node024212 ~]# ps -ef| grep kafkaroot 21875 21651 0 11:27 pts/2 00:00:00 grep --color=auto kafka ç¨ç­‰ä¸€ä¼š, å†æ¬¡describe test1123#./bin/kafka-topics.sh --zookeeper 172.18.12.212:2181 --describe --topic test1Topic:test1 PartitionCount:1 ReplicationFactor:3 Configs: Topic: test1 Partition: 0 Leader: 213 Replicas: 213,212,211 Isr: 213,211å¯çœ‹åˆ°å‰¯æœ¬ä»ç„¶æ˜¯Replicas: 213,212,211ISRå·²ç»å˜ä¸ºIsr: 213,211 åœ¨212å¯åŠ¨æ–°brokeråˆ›å»ºä¸€ä»½æ–°çš„é…ç½®æ–‡ä»¶, è‡ªåŠ¨ä¸€ä¸ªæ–°çš„broker12345# cp server.properties server2.properties # vim server2.properties åªä¿®æ”¹è¿™ä¸¤ä¸ªå‚æ•°broker.id=218log.dirs=/DATA21/kafka/kafka-logs,/DATA22/kafka/kafka-logs,/DATA23/kafka/kafka-logs,/DATA24/kafka/kafka-logsåˆ›å»ºç›¸åº”ç›®å½•1234mkdir -p /DATA21/kafka/kafka-logsmkdir -p /DATA22/kafka/kafka-logsmkdir -p /DATA23/kafka/kafka-logsmkdir -p /DATA24/kafka/kafka-logså¯åŠ¨æ–°broker1./bin/kafka-server-start.sh -daemon config/server2.properties ç¨ç­‰, æŸ¥çœ‹ test1 çŠ¶æ€ 123#./bin/kafka-topics.sh --zookeeper 172.18.12.212:2181 --describe --topic test1Topic:test1 PartitionCount:1 ReplicationFactor:3 Configs: Topic: test2 Partition: 0 Leader: 213 Replicas: 213,212,211 Isr: 213,218,211 å¯ä»¥çœ‹åˆ° test1 å‰¯æœ¬ä»ç„¶æ˜¯Replicas: 213,212,211ISRä¸ºIsr: 213,218,211. ä¹Ÿå°±æ˜¯è¯´ç¼ºå¤±çš„å‰¯æœ¬ä¸ä¼šè‡ªåŠ¨è¿ç§»åˆ°æ–°brokerä¸Š. ä½¿ç”¨kafka-reassign-partitions.shé‡åˆ†é…åˆ†åŒºå°†212åˆ é™¤,æ·»åŠ 21812345678910111213141516[root@node024211 12:04:48 /usr/local/kafka]#echo &#x27;&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;test1&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[211,213,218]&#125;]&#125;&#x27; &gt; increase-replication-factor.json[root@node024211 12:58:30 /usr/local/kafka]#./bin/kafka-reassign-partitions.sh --zookeeper 172.18.12.211:2181 --reassignment-json-file increase-replication-factor.json --executeCurrent partition replica assignment&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;test1&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[213,212,211],&quot;log_dirs&quot;:[&quot;any&quot;,&quot;any&quot;,&quot;any&quot;]&#125;]&#125;Save this to use as the --reassignment-json-file option during rollbackSuccessfully started reassignment of partitions.[root@node024211 12:58:49 /usr/local/kafka]#./bin/kafka-reassign-partitions.sh --zookeeper 172.18.12.211:2181 --reassignment-json-file increase-replication-factor.json --verifyStatus of partition reassignment: Reassignment of partition test1-0 completed successfullyæŸ¥çœ‹topicä¿¡æ¯1234#./bin/kafka-topics.sh --zookeeper 172.18.12.212:2181 --describe --topic test1Topic:test1 PartitionCount:1 ReplicationFactor:3 Configs: Topic: test1 Partition: 0 Leader: 213 Replicas: 211,213,218 Isr: 213,211,218 éªŒè¯218æ˜¯å¦æœ‰å…¨éƒ¨æ•°æ®è™½ç„¶çœ‹å‰¯æœ¬ä¿¡æ¯ä¸­å·²ç»æœ‰äº†218, ä½†æ˜¯218æ˜¯å¦åŒ…å«æ—§æ¶ˆæ¯å‘¢?æˆ‘çš„åŠæ³•æ˜¯, kill 211,213, ç„¶åâ€“from-beginning æ¶ˆè´¹218æ•°æ®, å®é™…æµ‹è¯•ä¹Ÿæ˜¯å¯ä»¥çš„12345678910111213#./bin/kafka-console-consumer.sh --bootstrap-server 172.18.12.212:9092 --topic test1 --from-beginning123456789101111çœ‹äº†ä¸‹211 218çš„logæ–‡ä»¶å¤§å°ä¹Ÿæ˜¯ä¸€æ ·çš„123456[2019-02-21 13:29:19]#ls -l /DATA22/kafka/kafka-logs/test1-0/[2019-02-21 13:29:19]total 8[2019-02-21 13:29:19]-rw-r--r--. 1 root root 10485760 Feb 21 12:58 00000000000000000000.index[2019-02-21 13:29:19]-rw-r--r--. 1 root root 381 Feb 21 13:00 00000000000000000000.log[2019-02-21 13:29:19]-rw-r--r--. 1 root root 10485756 Feb 21 12:58 00000000000000000000.timeindex[2019-02-21 13:29:19]-rw-r--r--. 1 root root 16 Feb 21 13:00 leader-epoch-checkpoint æ›´ç®€å•çš„åŠæ³•é€šè¿‡é˜…è¯»æ–‡æ¡£å‘ç°https://cwiki.apache.org/confluence/display/KAFKA/FAQ#FAQ-Howtoreplaceafailedbroker? How to replace a failed broker?When a broker fails, Kafka doesnâ€™t automatically re-replicate the data on the failed broker to other brokers. This is because in the common case, one brings down a broker to apply code or config changes, and will bring up the broker quickly afterward. Re-replicating the data in this case will be wasteful. In the rarer case that a broker fails completely, one will need to bring up another broker with the same broker id on a new server. The new broker will automatically replicate the missing data. è¿™ä¸Šé¢è¯´çš„,å¦‚æœæœåŠ¡å™¨çœŸçš„åäº†, åªéœ€è¦æ–°å¯åŠ¨ä¸€ä¸ªbroker, æŠŠbroker.idè®¾ç½®ä¸º æŸåçš„é‚£ä¸ªbrokerçš„id, å°±ä¼šè‡ªåŠ¨å¤åˆ¶è¿‡å»ä¸¢å¤±çš„æ•°æ® æˆ‘å®é™…æµ‹è¯•äº†ä¸€ä¸‹, ç¡®å®å¯ä»¥æ¢å¤","categories":[],"tags":[{"name":"Kafka","slug":"Kafka","permalink":"http://fuxkdb.com/tags/Kafka/"}]},{"title":"Kafka SASL_SCRAM+ACLå®ç°åŠ¨æ€åˆ›å»ºç”¨æˆ·åŠæƒé™æ§åˆ¶","slug":"2019-01-26-Kafka-SASL_SCRAM+ACLå®ç°åŠ¨æ€åˆ›å»ºç”¨æˆ·åŠæƒé™æ§åˆ¶","date":"2019-01-26T14:01:00.000Z","updated":"2019-03-08T07:39:20.000Z","comments":true,"path":"2019/01/26/2019-01-26-Kafka-SASL_SCRAM+ACLå®ç°åŠ¨æ€åˆ›å»ºç”¨æˆ·åŠæƒé™æ§åˆ¶/","link":"","permalink":"http://fuxkdb.com/2019/01/26/2019-01-26-Kafka-SASL_SCRAM+ACL%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%8F%8A%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6/","excerpt":"SASL_SCRAM+ACLå®ç°åŠ¨æ€åˆ›å»ºç”¨æˆ·åŠæƒé™æ§åˆ¶&nbsp;&nbsp;ç ”ç©¶äº†ä¸€æ®µæ—¶é—´Kafkaçš„æƒé™æ§åˆ¶. ä¹‹å‰ä¸€ç›´çœ‹SASL_PLAINTEXT, ç»“æœå‘ç°è¿™ç©æ„ä¸èƒ½åŠ¨æ€åˆ›å»ºç”¨æˆ·. ä»Šå¤©æ²¡æ­»å¿ƒåˆæŸ¥äº†æŸ¥,å‘ç°è¿™ä¸ªäººä¹Ÿé—®äº†è¿™ä¸ªé—®é¢˜https://stackoverflow.com/questions/54147460/kafka-adding-sasl-users-dynamically-without-cluster-restartäºæ˜¯ç ”ç©¶äº†ä¸‹SCRAM. å†™äº†è¿™ç¯‡å®Œæ•´çš„æ–‡æ¡£ æœ¬ç¯‡æ–‡æ¡£ä¸­ä½¿ç”¨çš„æ˜¯è‡ªå·±éƒ¨ç½²çš„zookeeper, zookeeperæ— éœ€åšä»»ä½•ç‰¹æ®Šé…ç½®","text":"SASL_SCRAM+ACLå®ç°åŠ¨æ€åˆ›å»ºç”¨æˆ·åŠæƒé™æ§åˆ¶&nbsp;&nbsp;ç ”ç©¶äº†ä¸€æ®µæ—¶é—´Kafkaçš„æƒé™æ§åˆ¶. ä¹‹å‰ä¸€ç›´çœ‹SASL_PLAINTEXT, ç»“æœå‘ç°è¿™ç©æ„ä¸èƒ½åŠ¨æ€åˆ›å»ºç”¨æˆ·. ä»Šå¤©æ²¡æ­»å¿ƒåˆæŸ¥äº†æŸ¥,å‘ç°è¿™ä¸ªäººä¹Ÿé—®äº†è¿™ä¸ªé—®é¢˜https://stackoverflow.com/questions/54147460/kafka-adding-sasl-users-dynamically-without-cluster-restartäºæ˜¯ç ”ç©¶äº†ä¸‹SCRAM. å†™äº†è¿™ç¯‡å®Œæ•´çš„æ–‡æ¡£ æœ¬ç¯‡æ–‡æ¡£ä¸­ä½¿ç”¨çš„æ˜¯è‡ªå·±éƒ¨ç½²çš„zookeeper, zookeeperæ— éœ€åšä»»ä½•ç‰¹æ®Šé…ç½® ä½¿ç”¨SASL / SCRAMè¿›è¡Œèº«ä»½éªŒè¯è¯·å…ˆåœ¨ä¸é…ç½®ä»»ä½•èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹å¯åŠ¨Kafka 1. åˆ›å»ºSCRAM CredentialsKafkaä¸­çš„SCRAMå®ç°ä½¿ç”¨Zookeeperä½œä¸ºå‡­è¯(credential)å­˜å‚¨ã€‚ å¯ä»¥ä½¿ç”¨kafka-configs.shåœ¨Zookeeperä¸­åˆ›å»ºå‡­æ®ã€‚ å¯¹äºå¯ç”¨çš„æ¯ä¸ªSCRAMæœºåˆ¶ï¼Œå¿…é¡»é€šè¿‡æ·»åŠ å…·æœ‰æœºåˆ¶åç§°çš„é…ç½®æ¥åˆ›å»ºå‡­è¯ã€‚ å¿…é¡»åœ¨å¯åŠ¨Kafka brokerä¹‹å‰åˆ›å»ºä»£ç†é—´é€šä¿¡çš„å‡­æ®ã€‚ å¯ä»¥åŠ¨æ€åˆ›å»ºå’Œæ›´æ–°å®¢æˆ·ç«¯å‡­è¯ï¼Œå¹¶ä½¿ç”¨æ›´æ–°çš„å‡­è¯æ¥éªŒè¯æ–°è¿æ¥ã€‚ åˆ›å»ºbrokerå»ºé€šä¿¡ç”¨æˆ·(æˆ–ç§°è¶…çº§ç”¨æˆ·)1bin/kafka-configs.sh --zookeeper 192.168.2.229:2182 --alter --add-config &#x27;SCRAM-SHA-256=[password=admin-secret],SCRAM-SHA-512=[password=admin-secret]&#x27; --entity-type users --entity-name admin åˆ›å»ºå®¢æˆ·ç«¯ç”¨æˆ·fanboshi1bin/kafka-configs.sh --zookeeper 192.168.2.229:2182 --alter --add-config &#x27;SCRAM-SHA-256=[iterations=8192,password=fanboshi],SCRAM-SHA-512=[password=fanboshi]&#x27; --entity-type users --entity-name fanboshi æŸ¥çœ‹SCRAMè¯ä¹¦12[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --describe --entity-type users --entity-name fanboshiConfigs for user-principal &#x27;fanboshi&#x27; are SCRAM-SHA-512=salt=MWwwdWJqcjBncmUwdzY1Mzdoa2NwNXppd3A=,stored_key=mGCJy5k3LrE2gs6Dp4ALRhgy37l1WYPUIdoOncCF+B3Ti3wL2sQNmzg8oEz3tUs9DFsclFCygjbysb0S0BU9bA==,server_key=iTyX0U0Jt02dkddUm6QrVwNf3lJk72dBNs9EDHTqe8kLlNGIp9ypzRkcgkc+WVMd1bkAF3cg8vk9Q1LrJ/2i/A==,iterations=4096,SCRAM-SHA-256=salt=ZDg5MHVlYW40dW9jbXJ6MndvZDVlazd3ag==,stored_key=cgX1ldpXnDL1+TlLHJ3IHn7tAQS/7pQ7BVZUtECpQ3A=,server_key=i7Mcnb5sPUqfIFs6qKWWHZ2ortoKiRc7oabHOV5dawI=,iterations=8192 åˆ é™¤SCRAMè¯ä¹¦è¿™é‡Œåªæ¼”ç¤º,ä¸æ“ä½œ1[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --alter --delete-config &#x27;SCRAM-SHA-512&#x27; --entity-type users --entity-name fanboshi 2. é…ç½®Kafka Brokers åœ¨æ¯ä¸ªKafka brokerçš„configç›®å½•ä¸­æ·»åŠ ä¸€ä¸ªç±»ä¼¼ä¸‹é¢çš„JAASæ–‡ä»¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºkafka_server_jaas.confï¼š123456[root@node002229 config]# cat kafka_server_jaas.confKafkaServer &#123; org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;admin&quot; password=&quot;admin-secret&quot;;&#125;; æ³¨æ„ä¸è¦å°‘å†™äº†åˆ†å· å°†JAASé…ç½®æ–‡ä»¶ä½ç½®ä½œä¸ºJVMå‚æ•°ä¼ é€’ç»™æ¯ä¸ªKafka brokerï¼šä¿®æ”¹ /usr/local/kafka/bin/kafka-server-start.shå°†exec $base_dir/kafka-run-class.sh $EXTRA_ARGS kafka.Kafka &quot;$@&quot; æ³¨é‡Š, å¢åŠ ä¸‹é¢çš„å†…å®¹ 12#exec $base_dir/kafka-run-class.sh $EXTRA_ARGS kafka.Kafka &quot;$@&quot;exec $base_dir/kafka-run-class.sh $EXTRA_ARGS -Djava.security.auth.login.config=$base_dir/../config/kafka_server_jaas.conf kafka.Kafka &quot;$@&quot; æˆ–è€…ä¸ä¿®æ”¹kafka-server-start.shè„šæœ¬, è€Œæ˜¯å°†ä¸‹é¢çš„å†…å®¹æ·»åŠ åˆ°~/.bashrc 12export KAFKA_PLAIN_PARAMS=&quot;-Djava.security.auth.login.config=/usr/local/kafka/config/kafka_server_jaas.conf&quot;export KAFKA_OPTS=&quot;$KAFKA_PLAIN_PARAMS $KAFKA_OPTS&quot; å¦‚æ­¤å¤„æ‰€è¿°ï¼Œåœ¨server.propertiesä¸­é…ç½®SASLç«¯å£å’ŒSASLæœºåˆ¶ã€‚ ä¾‹å¦‚ï¼š 12345678910# è®¤è¯é…ç½®listeners=SASL_PLAINTEXT://node002229:9092security.inter.broker.protocol=SASL_PLAINTEXTsasl.mechanism.inter.broker.protocol=SCRAM-SHA-256sasl.enabled.mechanisms=SCRAM-SHA-256# ACLé…ç½®allow.everyone.if.no.acl.found=falsesuper.users=User:adminauthorizer.class.name=kafka.security.auth.SimpleAclAuthorizer åœ¨å®˜æ–¹æ–‡æ¡£ä¸­å†™çš„æ˜¯ 12listeners=SASL_SSL://host.name:portsecurity.inter.broker.protocol=SASL_SSL è¿™é‡Œå…¶å®æ²¡å¿…è¦å†™æˆSASL_SSL , æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©SSLæˆ–PLAINTEXT, æˆ‘è¿™é‡Œé€‰æ‹©PLAINTEXTä¸åŠ å¯†æ˜æ–‡ä¼ è¾“, çœäº‹, æ€§èƒ½ä¹Ÿç›¸å¯¹å¥½ä¸€äº› é‡å¯ZK/Kafkaé‡å¯ZK / KafkaæœåŠ¡. æ‰€æœ‰brokeråœ¨è¿æ¥ä¹‹å‰éƒ½ä¼šå¼•ç”¨â€™kafka_server_jaas.confâ€™.Zookeeperæ‰€æœ‰èŠ‚ç‚¹ 12345678[root@node002229 zookeeper]# zkServer.sh stop /usr/local/zookeeper/bin/../conf/zoo.cfg ZooKeeper JMX enabled by defaultUsing config: /usr/local/zookeeper/bin/../conf/zoo1.cfgStopping zookeeper ... STOPPED[root@node002229 zookeeper]# zkServer.sh start /usr/local/zookeeper/bin/../conf/zoo.cfg ZooKeeper JMX enabled by defaultUsing config: /usr/local/zookeeper/bin/../conf/zoo1.cfg Kafkaæ‰€æœ‰Broker12cd /usr/local/kafka/;bin/kafka-server-stop.shcd /usr/local/kafka/;bin/kafka-server-start.sh -daemon config/server.properties å®¢æˆ·ç«¯é…ç½®å…ˆä½¿ç”¨kafka-console-producer å’Œ kafka-console-consumer æµ‹è¯•ä¸€ä¸‹ kafka-console-producer åˆ›å»º config/client-sasl.properties æ–‡ä»¶123[root@node002229 kafka]# vim config/client-sasl.propertiessecurity.protocol=SASL_PLAINTEXTsasl.mechanism=SCRAM-SHA-256 åˆ›å»ºconfig/kafka_client_jaas_admin.confæ–‡ä»¶123456[root@node002229 kafka]# vim config/kafka_client_jaas_admin.conf KafkaClient &#123; org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;admin&quot; password=&quot;admin-secret&quot;;&#125;; ä¿®æ”¹kafka-console-producer.shè„šæœ¬è¿™é‡Œæˆ‘å¤åˆ¶ä¸€ä»½,å†æ”¹1234cp bin/kafka-console-producer.sh bin/kafka-console-producer-admin.shvim bin/kafka-console-producer-admin.sh#exec $(dirname $0)/kafka-run-class.sh kafka.tools.ConsoleProducer &quot;$@&quot;exec $(dirname $0)/kafka-run-class.sh -Djava.security.auth.login.config=$(dirname $0)/../config/kafka_client_jaas_admin.conf kafka.tools.ConsoleProducer &quot;$@&quot; åˆ›å»ºæµ‹è¯•topic1bin/kafka-topics.sh --create --zookeeper localhost:2182 --partitions 1 --replication-factor 1 --topic test æµ‹è¯•ç”Ÿäº§æ¶ˆæ¯123bin/kafka-console-producer-admin.sh --broker-list 192.168.2.229:9092 --topic test --producer.config config/client-sasl.properties&gt;1&gt; å¯ä»¥çœ‹åˆ°adminç”¨æˆ·æ— éœ€é…ç½®ACLå°±å¯ä»¥ç”Ÿæˆæ¶ˆæ¯ æµ‹è¯•fanboshiç”¨æˆ·å¦‚æ³•ç‚®åˆ¶, æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªbin/kafka-console-producer-fanboshi.shæ–‡ä»¶, åªæ˜¯ä¿®æ”¹å…¶ä¸­çš„kafka_client_jaas_admin.conf ä¸º kafka_client_jaas_fanboshi.conf 12345678910vim config/kafka_client_jaas_fanboshi.conf KafkaClient &#123; org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;fanboshi&quot; password=&quot;fanboshi&quot;;&#125;;cp bin/kafka-console-producer-admin.sh bin/kafka-console-producer-fanboshi.shvi bin/kafka-console-producer-fanboshi.shexec $(dirname $0)/kafka-run-class.sh -Djava.security.auth.login.config=$(dirname $0)/../config/kafka_client_jaas_fanboshi.conf kafka.tools.ConsoleProducer &quot;$@&quot; ç”Ÿäº§æ¶ˆæ¯12345[root@node002229 kafka]# bin/kafka-console-producer-fanboshi.sh --broker-list 192.168.2.229:9092 --topic test --producer.config config/client-sasl.properties&gt;1[2019-01-26 18:07:50,099] WARN [Producer clientId=console-producer] Error while fetching metadata with correlation id 1 : &#123;test=TOPIC_AUTHORIZATION_FAILED&#125; (org.apache.kafka.clients.NetworkClient)[2019-01-26 18:07:50,100] ERROR Error when sending message to topic test with key: null, value: 1 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)org.apache.kafka.common.errors.TopicAuthorizationException: Not authorized to access topics: [test] å¯ä»¥çœ‹åˆ°æŠ¥é”™äº†, å› ä¸ºfanboshiç”¨æˆ·è¿˜æ²¡æœ‰æƒé™ kafka-console-consumer åˆ›å»º config/consumer-fanboshi.properties æ–‡ä»¶1234[root@node002229 kafka]# vim config/consumer-fanboshi.propertiessecurity.protocol=SASL_PLAINTEXTsasl.mechanism=SCRAM-SHA-256group.id=fanboshi-group åˆ›å»º bin/kafka-console-consumer-fanboshi.sh æ–‡ä»¶1234cp bin/kafka-console-consumer.sh bin/kafka-console-consumer-fanboshi.shvim bin/kafka-console-consumer-fanboshi.sh#exec $(dirname $0)/kafka-run-class.sh kafka.tools.ConsoleConsumer &quot;$@&quot;exec $(dirname $0)/kafka-run-class.sh -Djava.security.auth.login.config=$(dirname $0)/../config/kafka_client_jaas_fanboshi.conf kafka.tools.ConsoleConsumer &quot;$@&quot; æµ‹è¯•æ¶ˆè´¹è€…1bin/kafka-console-consumer-fanboshi.sh --bootstrap-server 192.168.2.229:9092 --topic test --consumer.config config/consumer-fanboshi.properties --from-beginning å…¶å®ä¹Ÿä¼šæŠ¥é”™çš„, æŠ¥é”™å†…å®¹å°±ä¸è´´äº† ACLé…ç½®æˆäºˆfanboshiç”¨æˆ·å¯¹test topic å†™æƒé™, åªå…è®¸ 192.168.2.* ç½‘æ®µ1bin/kafka-acls.sh --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=localhost:2182 --add --allow-principal User:fanboshi --operation Write --topic test --allow-host 192.168.2.* æˆäºˆfanboshiç”¨æˆ·å¯¹test topic è¯»æƒé™, åªå…è®¸ 192.168.2.* ç½‘æ®µ1bin/kafka-acls.sh --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=localhost:2182 --add --allow-principal User:fanboshi --operation Read --topic test --allow-host 192.168.2.* æˆäºˆfanboshiç”¨æˆ·, fanboshi-group æ¶ˆè´¹è€…ç»„ å¯¹test topic è¯»æƒé™, åªå…è®¸ 192.168.2.* ç½‘æ®µ1bin/kafka-acls.sh --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=localhost:2182 --add --allow-principal User:fanboshi --operation Read --group fanboshi-group --allow-host 192.168.2.* æŸ¥çœ‹aclé…ç½®1234567[root@node002229 kafka]# bin/kafka-acls.sh --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=localhost:2182 --listCurrent ACLs for resource `Group:LITERAL:fanboshi-group`: User:fanboshi has Allow permission for operations: Read from hosts: * Current ACLs for resource `Topic:LITERAL:test`: User:fanboshi has Allow permission for operations: Write from hosts: * User:fanboshi has Allow permission for operations: Read from hosts: * åˆ é™¤é…ç½®1bin/kafka-acls.sh --authorizer kafka.security.auth.SimpleAclAuthorizer --authorizer-properties zookeeper.connect=localhost:2182 --remove --allow-principal User:bob --operation Read --topic example10 --allow-host 192.168.1.158 å†æ¬¡æµ‹è¯•ç”Ÿäº§è€…123456[root@node002229 kafka]# bin/kafka-console-producer-fanboshi.sh --broker-list 192.168.2.229:9092 --topic test --producer.config config/client-sasl.properties&gt;1[2019-01-26 18:07:50,099] WARN [Producer clientId=console-producer] Error while fetching metadata with correlation id 1 : &#123;test=TOPIC_AUTHORIZATION_FAILED&#125; (org.apache.kafka.clients.NetworkClient)[2019-01-26 18:07:50,100] ERROR Error when sending message to topic test with key: null, value: 1 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)org.apache.kafka.common.errors.TopicAuthorizationException: Not authorized to access topics: [test]&gt;1æ¶ˆè´¹è€…123[root@node002229 kafka]# bin/kafka-console-consumer-fanboshi.sh --bootstrap-server 192.168.2.229:9092 --topic test --consumer.config config/consumer-fanboshi.properties --from-beginning11éƒ½æ²¡é—®é¢˜äº† å¦‚ä½•æŸ¥çœ‹æˆ‘ä»¬åˆ›å»ºäº†å“ªäº›â€ç”¨æˆ·â€å¥½åƒåªèƒ½å»zookeeperçœ‹?123zkCli.sh -server node002229:2182ls /config/users[admin, alice, fanboshi]å°è¯•åˆ é™¤alice12345678910[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --describe --entity-type users --entity-name aliceConfigs for user-principal &#x27;alice&#x27; are SCRAM-SHA-512=salt=MWt1OHRhZnd3cWZvZ2I4bXcwdTM0czIyaTQ=,stored_key=JYeud1Cx5Z2+FaJgJsZGbMcIi63B9XtA9Wyc+KEm2gXK8+2IxxAVvi1CfSjlkqeupfeIMFJ7/EUkOw+zqvYz6w==,server_key=O4NIgjleroia7puK01/ZZoagFeoxh+zHzckGXXooBsWTdx/7Shb0pMHniMu4IY2jb5orWB2t9K8MZkxCliJDsg==,iterations=4096,SCRAM-SHA-256=salt=MTJ3bXRod3EyN3FtZWdsNHk0NXoyeWdlNjE=,stored_key=chQX35reoBYtfg/U5HBtkzvBAk+gSCgskNzUiScOrUE=,server_key=rRTbUzAehwVMUDTMuoOMumGEuvc7wDecKcqK6yYlbWY=,iterations=8192[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --alter --delete-config &#x27;SCRAM-SHA-512&#x27; --entity-type users --entity-name aliceCompleted Updating config for entity: user-principal &#x27;alice&#x27;.[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --describe --entity-type users --entity-name alice Configs for user-principal &#x27;alice&#x27; are SCRAM-SHA-256=salt=MTJ3bXRod3EyN3FtZWdsNHk0NXoyeWdlNjE=,stored_key=chQX35reoBYtfg/U5HBtkzvBAk+gSCgskNzUiScOrUE=,server_key=rRTbUzAehwVMUDTMuoOMumGEuvc7wDecKcqK6yYlbWY=,iterations=8192[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --alter --delete-config &#x27;SCRAM-SHA-256&#x27; --entity-type users --entity-name alice Completed Updating config for entity: user-principal &#x27;alice&#x27;.[root@node002229 kafka]# bin/kafka-configs.sh --zookeeper localhost:2182 --describe --entity-type users --entity-name alice Configs for user-principal &#x27;alice&#x27; are å»ZKæŸ¥çœ‹12[zk: node002229:2182(CONNECTED) 0] ls /config/users[admin, alice, fanboshi]è¿˜æ˜¯æœ‰, éš¾é“åªèƒ½åœ¨ZKæ‰‹åŠ¨åˆ é™¤? å‚è€ƒæ–‡çŒ®http://kafka.apache.org/documentation/#security_sasl_scramhttps://sharebigdata.wordpress.com/category/kafka/kafka-sasl-scram-with-w-o-ssl/https://developer.ibm.com/opentech/2017/05/31/kafka-acls-in-practice/https://developer.ibm.com/tutorials/kafka-authn-authz/Kafkaå¹¶ä¸éš¾å­¦! å…¥é—¨ã€è¿›é˜¶ã€å•†ä¸šå®æˆ˜","categories":[],"tags":[{"name":"Kafka","slug":"Kafka","permalink":"http://fuxkdb.com/tags/Kafka/"}]},{"title":"MGR vs PXC Benchmark","slug":"MGR vs PXC Benchmark","date":"2018-09-11T14:23:00.000Z","updated":"2020-03-17T07:42:49.117Z","comments":true,"path":"2018/09/11/MGR vs PXC Benchmark/","link":"","permalink":"http://fuxkdb.com/2018/09/11/MGR%20vs%20PXC%20Benchmark/","excerpt":"MGR vs PXC Benchmarkæœ¬æ¬¡æµ‹è¯•å°†MGRä¸PXCè¿›è¡Œå¯¹æ¯”, æ„åœ¨æ¯”è¾ƒMGRè‡ªèº«ä¸åŒæµæ§é˜ˆå€¼ä¸‹æ€§èƒ½è¡¨ç°ä»¥åŠè§‚å¯ŸMGRä¸PXCç›¸åŒè´Ÿè½½ä¸‹çš„æ€§èƒ½è¡¨ç°. æµ‹è¯•å·¥å…·ä½¿ç”¨sysbench 1.1.0-431660d åŸºç¡€ç¯å°†ä¿¡æ¯å¦‚ä¸‹è¡¨æ‰€ç¤º, åœ¨ä¸‰ä¸ªæµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²äº†3306, 3307ä¸¤å¥—é›†ç¾¤ Host IP MGR PXC data-191 192.168.8.191 3306 3307 data-219 192.168.8.219 3306 3307 data-220 192.168.8.220 3306 3307","text":"MGR vs PXC Benchmarkæœ¬æ¬¡æµ‹è¯•å°†MGRä¸PXCè¿›è¡Œå¯¹æ¯”, æ„åœ¨æ¯”è¾ƒMGRè‡ªèº«ä¸åŒæµæ§é˜ˆå€¼ä¸‹æ€§èƒ½è¡¨ç°ä»¥åŠè§‚å¯ŸMGRä¸PXCç›¸åŒè´Ÿè½½ä¸‹çš„æ€§èƒ½è¡¨ç°. æµ‹è¯•å·¥å…·ä½¿ç”¨sysbench 1.1.0-431660d åŸºç¡€ç¯å°†ä¿¡æ¯å¦‚ä¸‹è¡¨æ‰€ç¤º, åœ¨ä¸‰ä¸ªæµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²äº†3306, 3307ä¸¤å¥—é›†ç¾¤ Host IP MGR PXC data-191 192.168.8.191 3306 3307 data-219 192.168.8.219 3306 3307 data-220 192.168.8.220 3306 3307 è¿™é‡Œæˆ‘ä»¬ä¸å…³å¿ƒbuffer sizeå’Œiops æœ¬æ¬¡æµ‹è¯•ä¸€ä¸ªä¸ä¸¥è°¨çš„åœ°æ–¹æ˜¯,pxcä½¿ç”¨percona server5.7.20, MGRä½¿ç”¨mysql server5.7.22 ä¸‹æ–‡å°†å±•ç¤ºæµ‹è¯•ç»“æœå’Œè¯´æ˜æµ‹è¯•æ–¹æ³•, å°½é‡å®¢è§‚å±•ç¤ºæµ‹è¯•äº‹å®(è¯­æ–‡ä¸å¤ªå¥½, è§è°…) ä¸‹æ–‡ä¸­: 25000è¡¨ç¤ºMGRé»˜è®¤æµæ§é˜ˆå€¼ä¸‹çš„æµ‹è¯•æƒ…å†µ 50000è¡¨ç¤ºMGRé»˜è®¤æµæ§é˜ˆå€¼ä¸€å€ä¸‹çš„æµ‹è¯•æƒ…å†µ one_node_threshold_50000è¡¨ç¤ºé˜ˆå€¼5Wå…³é—­ä¸€ä¸ªèŠ‚ç‚¹çš„æµæ§ä¸‹çš„æµ‹è¯•æƒ…å†µ threshold_disableè¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹å…³é—­æµæ§ä¸‹çš„æµ‹è¯•æƒ…å†µ OLTP_WRITE_ONLYæ¨¡å¼ä¸åŒæµæ§é˜ˆå€¼ä¸‹MGRè¡¨ç° OLTP_WRITE_ONLYæ¨¡å¼ä¸‹æ¯ä¸ªäº‹åŠ¡åŒ…å« 1ä¸ª index_updates UPDATE sbtest%u SET k=k+1 WHERE id=? 1ä¸ª non_index_updates UPDATE sbtest%u SET c=? WHERE id=? 1ä¸ª deletes DELETE FROM sbtest%u WHERE id=? 1ä¸ª inserts INSERT INTO sbtest%u (id, k, c, pad) VALUES (?, ?, ?, ?) 16çº¿ç¨‹å‹åŠ›ä¸‹, å››ç§æµæ§é˜ˆå€¼åœºæ™¯ä¸‹qpsç›¸å·®ä¸å¤š, å“åº”æ—¶é—´åœ¨é˜ˆå€¼25000æ—¶è¾ƒé«˜, è¿™ä¹Ÿç¬¦åˆé¢„æœŸ 32 qpsæ¥è¿‘6W 64çº¿ç¨‹. å¯ä»¥çœ‹åˆ°å…³é—­æµæ§å’Œåªå…³é—­ä¸€ä¸ªèŠ‚ç‚¹çš„æµæ§çš„æƒ…å†µä¸‹qpså·®ä¸å¤š, å¯¹äº25000å’Œ5000å¯ä»¥çœ‹åˆ°qpsä¸€ç›´åœ¨ä¸Šä¸‹èµ·ä¼éœ‡è¡ 128çº¿ç¨‹. å—å†…å­˜æˆ–iopsçš„é™åˆ¶å¯ä»¥çœ‹åˆ°å¯¹æ¯”64çº¿ç¨‹one_node_threshold_50000å’Œthreshold_disabled qpså¹¶æ²¡æœ‰å†å¢é«˜,å“åº”æ—¶é—´ç¨æœ‰å¢é«˜. è§‚å¯Ÿ25000å’Œ5000å¯ä»¥å‘ç°åœ¨å‹æµ‹å¼€å§‹æ—¶,ä¸¤è€…qpséƒ½èƒ½è¾¾åˆ°10W, ç”±äºæµæ§, qpsè¿…é€Ÿä¸‹é™,ç„¶åå°±ä¸€ç›´åœ¨5Wå·¦å³éœ‡è¡ 256çº¿ç¨‹. one_node_threshold_50000å’Œthreshold_disabled qpså¹¶æ²¡æœ‰å†å¢é«˜,è§‚å¯Ÿ25000å’Œ5000å¯ä»¥å‘ç°åœ¨å‹æµ‹å¼€å§‹æ—¶,ä¸¤è€…qpséƒ½èƒ½è¾¾åˆ°10W(æ¯”å‰ä¸¤è€…çš„è¿˜é«˜)ä¹‹ååˆç”±äºæµæ§, qpsè¿…é€Ÿä¸‹é™,ç„¶åå°±ä¸€ç›´åœ¨5Wå·¦å³éœ‡è¡ å¯¹äºå“åº”æ—¶é—´one_node_threshold_disabledå’Œthreshold_disabledåœ¨20mså·¦å³è€Œ25000å’Œ5000å‡ ä¸ªæ³¢å³°è¾¾åˆ°äº†800ms+ è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡, 16-256çš„å„ä¸ªè´Ÿè½½ä¸‹qpsæ³¢è°·æœ‰é‡åˆ, è¿™ä¸ªç›®å‰è¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„ OLTP_READ_WRITE æ¨¡å¼MGRä¸PXCæ€§èƒ½å¯¹æ¯” ä»…ä»qpsä¸Šçœ‹, MGRè¢«å®Œè™ ä»…ä»å“åº”æ—¶é—´ä¸Šçœ‹, MGRè¢«å®Œè™ OLTP_WRITE_ONLYæ¨¡å¼MGR PXCæ€§èƒ½å¯¹æ¯” qpsè¿˜æ˜¯pxcç¨³ä¸€äº› å“åº”æ—¶é—´ä¸ŠMGRæŒ½å›äº†ä¸€äº›é¢œé¢, çº¿å¾ˆç¨³, ä½†åŸå› æ˜¯å› ä¸ºMGRå…³äº†æµæ§ é›†ç¾¤ä¸­æœ‰çŸ­æ¿èŠ‚ç‚¹åœºæ™¯ä¸‹çš„æµ‹è¯•è¿™é‡Œä½¿ç”¨sysbenchåœ¨220èŠ‚ç‚¹è·‘ioå‹æµ‹, åˆ¶é€ çŸ­æ¿èŠ‚ç‚¹, åœ¨è¿›è¡Œä¸€è½®æµ‹è¯•. OLTP_WRITE_ONLYæ¨¡å¼ä¸åŒæµæ§é˜ˆå€¼ä¸‹MGRè¡¨ç° å¯ä»¥çœ‹åˆ°,ä¸æ²¡æœ‰çŸ­æ¿æ—¶ä¸åŒçš„æ˜¯å…³é—­æµæ§æ—¶æ€§èƒ½æ˜æ˜¾ä¼˜äºå…¶ä»–ä¸‰ç§æµæ§é˜ˆå€¼åœºæ™¯ ä½†éšç€å¹¶å‘æ•°å¢åŠ , å…³é—­æµæ§æ—¶æ³¢è°·è¶Šæ¥è¶Šå¤§, å…¶ä»–ä¸‰ç§æµæ§é˜ˆå€¼åœºæ™¯çš„qpsä¹Ÿè¶Šæ¥è¶Šä½ å“åº”æ—¶é—´æ–¹é¢ ,16çº¿ç¨‹æ—¶, å…³é—­æµæ§å“åº”æ—¶é—´å´æ¯”å…¶ä»–ä¸‰ç§æµæ§é˜ˆå€¼åœºæ™¯éƒ½é«˜, ä¹‹åéšç€å¹¶å‘å¢å¤§, å¯ä»¥çœ‹åˆ°å…³é—­æµæ§åå“åº”æ—¶é—´éå¸¸ç¨³å®š, è€Œå…¶ä»–ä¸‰ç§æµæ§é˜ˆå€¼åœºæ™¯å“åº”æ—¶é—´åŸºæœ¬åœ¨1så·¦å³ å¯¹äºå¤åˆ¶å»¶è¿Ÿ, éšç€æµæ§é˜ˆå€¼è¶Šæ¥è¶Šå¤§, å»¶è¿Ÿæ¶¨å¹…ä¹Ÿè¶Šæ¥è¶Šå¤§ 128çº¿ç¨‹æ—¶qpsæœ€é«˜, æ¥è¿‘10W. æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„çš„æ˜¯å³ä¾¿å…³äº†æµæ§, è¿˜æ˜¯å‘¨æœŸæ€§ä¼šæœ‰ä¸€äº›æ˜æ˜¾çš„æ³¢è°·, åŸå› è¿˜ä¸ç¡®å®šå¯èƒ½éœ€è¦é’ˆå¯¹æ€§è¿›ä¸€æ­¥æµ‹è¯• OLTP_READ_WRITE æ¨¡å¼MGRä¸PXCæ€§èƒ½å¯¹æ¯” å¯çœ‹åˆ°,æœ‰çŸ­æ¿çš„åœºæ™¯ä¸‹, PXCçš„qpsç•¥ä½äºMGR, ä½†æ˜¯æŠ–åŠ¨è¾ƒå°, å½“ç„¶æœ€å¹³ç¨³çš„è¿˜æ˜¯å…³é—­æµæ§çš„MGR PXCå“åº”æ—¶é—´ç•¥é«˜äºå…³é—­äº†æµæ§çš„MGR å¤åˆ¶å»¶è¿Ÿæ–¹é¢, ä¸æ˜¯PXCæ€§èƒ½å¥½, æ˜¯PXCæµæ§é™åˆ¶äº†qps, æ‰€ä»¥æ²¡å»¶è¿Ÿ OLTP_WRITE_ONLYæ¨¡å¼MGR PXCæ€§èƒ½å¯¹æ¯”åŸºæœ¬å’Œread writeå·®ä¸å¤šäº† ç»“è®º? å¯èƒ½æ˜¯ä¼ªç»“è®º åªæœ‰åœ¨æœ‰æ˜æ˜¾çŸ­æ¿æ—¶, å…³é—­äº†æµæ§çš„MGRæ€§èƒ½ä¼˜äºPXC. ä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹å…³é—­æµæ§, çŸ­æ¿èŠ‚ç‚¹å°±ä¸èƒ½ä½œä¸ºè¯»èŠ‚ç‚¹äº†, å¤åˆ¶å»¶è¿Ÿè¶Šæ¥è¶Šå¤§, ä¼˜ç‚¹æ˜¯ä¸ä¼šå› ä¸ºçŸ­æ¿è€Œå½±å“æ•´ä¸ªé›†ç¾¤. è€ŒPXCå¦‚æœé‡åˆ°çŸ­æ¿èŠ‚ç‚¹å½±å“äº†æ•´ä¸ªé›†ç¾¤çš„èŠ‚ç‚¹æ€ä¹ˆåŠå‘¢?åªèƒ½å…³é—­è¿™ä¸ªæ‹–åè…¿çš„èŠ‚ç‚¹äº†. å½“é—®é¢˜è§£å†³æƒ³è¦å†æ¬¡é‡æ–°åŠ å…¥é›†ç¾¤æ—¶å°±å¯èƒ½éœ€è¦åšSST æ€§èƒ½æ–¹é¢æ˜¯ä¸Šé¢çš„æƒ…å†µ, é‚£ä¹ˆå¯¹äºè¿ç»´æ–¹é¢å‘¢? ä¼˜ç§€çš„æ•°æ®åº“å› å½“æ—¶ç¨³å®šçš„, å¯æ§çš„, å¯è¯Šæ–­çš„. ä»è¿™ä¸‰ç‚¹æ¥çœ‹: ç¨³å®š: PXCæœ‰å¹´å¤´äº†, æœ‰å¾ˆå¤šæ¡ˆä¾‹äº†. MGRè¿˜éœ€è¦æ—¶é—´éªŒè¯ å¯æ§: å¯¹æµæ§çš„å¤„ç†, MGRæ˜¾ç„¶ä¼˜äºPXC, å¯ä»¥å…³é—­æµæ§ å¢åŠ èŠ‚ç‚¹, DBAåªéœ€æ‹¿ä¸€ä¸ªmy.cnfå¯åŠ¨æ–°èŠ‚ç‚¹æŒ‡å®šdonerå³å¯, å‰©ä¸‹çš„äº‹äº¤ç»™PXCè‡ªå·±å»åšSST. è€Œå¯¹äºMGR, éœ€è¦DBAè‡ªå·±å»æ‹¿å¤‡ä»½æ¢å¤(å¥½åƒä¹Ÿä¸èƒ½æ˜ç¡®æŒ‡å®šä¸€ä¸ªdoner?) å¯è¯Šæ–­: MGR(5.7)çš„ç›¸å…³è§†å›¾,statusçš„è¿˜å¤ªå°‘, æ¯”å¦‚è§¦å‘æµæ§æ—¶,æ˜¯æ²¡æœ‰statusæˆ–æ—¥å¿—ä¿¡æ¯çš„ æ€»ä¹‹, è¿˜éœ€è¦å†å¤šæµ‹æµ‹. æœ¬æ¬¡æµ‹è¯•çš„æ•°æ®åŸå§‹æ•°æ®å’Œå›¾è¡¨è‡ªå–: é“¾æ¥:https://pan.baidu.com/s/1WwXjG34uxN-eZG42bwRWXQ å¯†ç :nu0m","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"æ€§èƒ½æµ‹è¯•","slug":"æ€§èƒ½æµ‹è¯•","permalink":"http://fuxkdb.com/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"}]},{"title":"MySQL Group Replication- understanding Flow Control[è¯‘æ–‡]","slug":"MySQL Group Replication- understanding Flow Control[è¯‘æ–‡]","date":"2018-08-26T15:05:00.000Z","updated":"2018-08-26T15:06:46.000Z","comments":true,"path":"2018/08/26/MySQL Group Replication- understanding Flow Control[è¯‘æ–‡]/","link":"","permalink":"http://fuxkdb.com/2018/08/26/MySQL%20Group%20Replication-%20understanding%20Flow%20Control[%E8%AF%91%E6%96%87]/","excerpt":"","text":"MySQL Group Replication: understanding Flow Controlä½¿ç”¨MySQL Group Replicationæ—¶ï¼ŒæŸäº›æˆå‘˜å¯èƒ½è½åäºè¯¥ç»„ã€‚ ç”±äºè´Ÿè½½ï¼Œç¡¬ä»¶é™åˆ¶ç­‰åŸå› â€¦è¿™ç§æ»åå¯èƒ½ä¼šå¯¼è‡´ä¸èƒ½ä¿æŒè‰¯å¥½çš„æ€§èƒ½è®¤è¯è¡Œä¸ºå’Œä¸èƒ½å°½å¯èƒ½é™ä½è®¤è¯å¤±è´¥æ¬¡æ•°.åº”ç”¨é˜Ÿåˆ—(applying queue)è¶Šå¤§, ä¸å°šæœªåº”ç”¨çš„äº‹åŠ¡å‘ç”Ÿå†²çªçš„é£é™©å°±è¶Šå¤§ï¼ˆè¿™åœ¨Multi-Primary Groupsä¸Šæ˜¯æœ‰é—®é¢˜çš„ï¼‰ã€‚ Galeraç”¨æˆ·å·²ç»ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µ(è¯‘æ³¨: æŒ‡æµæ§çš„æ¦‚å¿µ). MySQL Group Replicationçš„å®ç°ä¸Galeraæœ‰ä¸¤ä¸ªä¸»è¦ä¸åŒç‚¹: the Group is never totally stalled(è¯‘æ³¨: Groupä¸ä¼šå½»åº•åœæ­¢æ¥æ”¶å†™è¯·æ±‚) the node having issues doesnâ€™t send flow control messages to the rest of the group asking for slowing down(è¯‘æ³¨: çŸ­æ¿èŠ‚ç‚¹ä¸ä¼šå‘Groupçš„å…¶ä»–èŠ‚ç‚¹å‘é€flow controlæ¶ˆæ¯æ¥è¦æ±‚é›†ç¾¤å‡é€Ÿ) å®é™…ä¸Šï¼Œè¯¥ç»„çš„æ¯ä¸ªæˆå‘˜éƒ½ä¼šå‘å…¶ä»–æˆå‘˜å‘é€æœ‰å…³å…¶é˜Ÿåˆ—ï¼ˆapplier queue and certification queueï¼‰çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ã€‚ ç„¶åï¼Œå¦‚æœæ¯ä¸ªèŠ‚ç‚¹æ„è¯†åˆ°ä¸€ä¸ªèŠ‚ç‚¹è¾¾åˆ°äº†å…¶ä¸­ä¸€ä¸ªé˜Ÿåˆ—çš„é˜ˆå€¼ï¼Œåˆ™å†³å®šæ˜¯å¦å‡é€Ÿï¼š 12345group_replication_flow_control_applier_threshold (default is 25000)group_replication_flow_control_certifier_threshold (default is 25000) å› æ­¤ï¼Œå¦‚æœåœ¨èŠ‚ç‚¹ä¸Šå°†group_replication_flow_control_modeè®¾ç½®ä¸ºQUOTAï¼Œå¹¶ä¸”çœ‹åˆ°è¯¥é›†ç¾¤çš„å…¶ä»–æˆå‘˜ä¹‹ä¸€è½åï¼ˆè¾¾åˆ°é˜ˆå€¼ï¼‰ï¼Œåˆ™ä¼šå°†å†™å…¥æ“ä½œé™åˆ¶ä¸ºæœ€å°é…é¢ã€‚ æ­¤é…é¢æ˜¯æ ¹æ®æœ€åä¸€ç§’ä¸­åº”ç”¨çš„transactionsæ•°è®¡ç®—çš„ï¼Œç„¶åé€šè¿‡å‡å»ä¸Šä¸€ä¸ªå‘¨æœŸçš„â€œover the quotaâ€æ¶ˆæ¯æ¥å‡å°‘ã€‚ and then it is reduced below that by subtracting the â€œover the quotaâ€ messages from the last period. è¿™æ„å‘³ç€ä¸Galeraç›¸åï¼ŒGaleraçš„(flow control)é˜ˆå€¼æ˜¯æœ‰çŸ­æ¿èŠ‚ç‚¹å†³å®šçš„ï¼Œå¯¹äºæˆ‘ä»¬åœ¨MySQLç»„å¤åˆ¶ä¸­ï¼Œç¼–å†™äº‹åŠ¡çš„èŠ‚ç‚¹(è¯‘æ³¨: å†™èŠ‚ç‚¹)æ£€æŸ¥å…¶é˜ˆå€¼æµé‡æ§åˆ¶å€¼å¹¶å°†å®ƒä»¬ä¸æ¥è‡ªå…¶ä»–èŠ‚ç‚¹çš„ç»Ÿè®¡æ•°æ®è¿›è¡Œæ¯”è¾ƒä»¥å†³å®šæ˜¯å¦è¿›è¡Œflow controlã€‚ æ‚¨å¯ä»¥åœ¨Vitorçš„æ–‡ç« Zooming-in on Group Replication Performanceä¸€æ–‡ä¸­æ‰¾åˆ°æœ‰å…³ç»„å¤åˆ¶æµæ§åˆ¶çš„æ›´å¤šä¿¡æ¯","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MGR","slug":"MGR","permalink":"http://fuxkdb.com/tags/MGR/"}]},{"title":"å¦‚ä½•ç¡®å®šSingle-Primaryæ¨¡å¼ä¸‹çš„MGRä¸»èŠ‚ç‚¹","slug":"å¦‚ä½•ç¡®å®šSingle-Primaryæ¨¡å¼ä¸‹çš„MGRä¸»èŠ‚ç‚¹","date":"2018-08-25T15:00:00.000Z","updated":"2018-08-25T15:05:16.000Z","comments":true,"path":"2018/08/25/å¦‚ä½•ç¡®å®šSingle-Primaryæ¨¡å¼ä¸‹çš„MGRä¸»èŠ‚ç‚¹/","link":"","permalink":"http://fuxkdb.com/2018/08/25/%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9ASingle-Primary%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84MGR%E4%B8%BB%E8%8A%82%E7%82%B9/","excerpt":"","text":"å¦‚ä½•ç¡®å®šSingle-Primaryæ¨¡å¼ä¸‹çš„MGRä¸»èŠ‚ç‚¹(æ–‡æ¡£ ID 2214438.1)MySQL 5.7å¯ä»¥é€šè¿‡global status group_replication_primary_memberç¡®å®š123456789mysql&gt; SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME = &#x27;group_replication_primary_member&#x27;;+--------------------------------------+| VARIABLE_VALUE |+--------------------------------------+| 9d7f8c28-c02c-11e6-9829-08002715584a |+--------------------------------------+1 row in set (0.00 sec) å¦‚æœæ˜¯Multi-Primaryé»˜è®¤åˆ™ç»“æœä¸ºç©º å¯ä»¥ç»“åˆperformance_schema.replication_group_membersè¡¨ è·å–ä¸»æœºåå’Œç«¯å£ä¿¡æ¯:1234567891011121314151617SELECT MEMBER_HOST, MEMBER_PORTFROM performance_schema.replication_group_membersWHERE MEMBER_ID = (SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME = &#x27;group_replication_primary_member&#x27;);+-------------+-------------+| MEMBER_HOST | MEMBER_PORT |+-------------+-------------+| ol7 | 3306 |+-------------+-------------+1 row in set (0.00 sec)æˆ–è€…è·å–å…¨éƒ¨æˆå‘˜ä¿¡æ¯:123456789101112131415161718192021SELECT MEMBER_ID, MEMBER_HOST, MEMBER_PORT, MEMBER_STATE, IF(global_status.VARIABLE_NAME IS NOT NULL, &#x27;PRIMARY&#x27;, &#x27;SECONDARY&#x27;) AS MEMBER_ROLEFROM performance_schema.replication_group_members LEFT JOIN performance_schema.global_status ON global_status.VARIABLE_NAME = &#x27;group_replication_primary_member&#x27; AND global_status.VARIABLE_VALUE = replication_group_members.MEMBER_ID;+--------------------------------------+-------------+-------------+--------------+-------------+| MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE |+--------------------------------------+-------------+-------------+--------------+-------------+| 9d7f8c28-c02c-11e6-9829-08002715584a | ol7 | 3306 | ONLINE | PRIMARY || f2bbb11d-c0c4-11e6-98ec-08002715584a | ol7 | 3308 | ONLINE | SECONDARY || f5bb7d78-c02c-11e6-9c56-08002715584a | ol7 | 3307 | ONLINE | SECONDARY |+--------------------------------------+-------------+-------------+--------------+-------------+3 rows in set (0.00 sec) MySQL 8.0.2 and LaterMySQL 8.0.2å¼€å§‹, Performance Schemaè¢«æ‰©å±•123456789mysql&gt; SELECT MEMBER_HOST, MEMBER_PORT FROM performance_schema.replication_group_members WHERE MEMBER_ROLE = &#x27;PRIMARY&#x27;;+-------------+-------------+| MEMBER_HOST | MEMBER_PORT |+-------------+-------------+| ol7 | 3306 |+-------------+-------------+1 row in set (0.00 sec)æˆ–è€…è·å–å…¨éƒ¨æˆå‘˜ä¿¡æ¯:12345678910mysql&gt; SELECT MEMBER_ID, MEMBER_HOST, MEMBER_PORT, MEMBER_STATE, MEMBER_ROLE, MEMBER_VERSION FROM performance_schema.replication_group_members;+--------------------------------------+-------------+-------------+--------------+-------------+----------------+| MEMBER_ID | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |+--------------------------------------+-------------+-------------+--------------+-------------+----------------+| 33565eab-731f-11e7-8e94-08002715584a | ol7 | 3307 | ONLINE | SECONDARY | 8.0.2 || 86034b0a-731f-11e7-9f33-08002715584a | ol7 | 3308 | ONLINE | SECONDARY | 8.0.2 || a45d3804-731e-11e7-9003-08002715584a | ol7 | 3306 | ONLINE | PRIMARY | 8.0.2 |+--------------------------------------+-------------+-------------+--------------+-------------+----------------+3 rows in set (0.00 sec) Referenceshttps://dev.mysql.com/doc/refman/en/group-replication-find-primary.htmlhttps://dev.mysql.com/doc/refman/en/group-replication-options.html#sysvar_group_replication_single_primary_modehttps://dev.mysql.com/doc/refman/en/replication-group-members-table.htmlhttp://mysqlhighavailability.com/group-replication-extending-group-replication-performance_schema-tables/http://lefred.be/content/mysql-group-replication-who-is-the-primary-master-updated/","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MGR","slug":"MGR","permalink":"http://fuxkdb.com/tags/MGR/"}]},{"title":"æ‰§è¡Œsqlæ–‡ä»¶é™åˆ¶é¢‘ç‡é¿å…æµæ§","slug":"æ‰§è¡Œsqlæ–‡ä»¶é™åˆ¶é¢‘ç‡é¿å…æµæ§","date":"2018-08-20T15:04:00.000Z","updated":"2018-08-20T15:05:06.000Z","comments":true,"path":"2018/08/20/æ‰§è¡Œsqlæ–‡ä»¶é™åˆ¶é¢‘ç‡é¿å…æµæ§/","link":"","permalink":"http://fuxkdb.com/2018/08/20/%E6%89%A7%E8%A1%8Csql%E6%96%87%E4%BB%B6%E9%99%90%E5%88%B6%E9%A2%91%E7%8E%87%E9%81%BF%E5%85%8D%E6%B5%81%E6%8E%A7/","excerpt":"","text":"é¿å…æµæ§å¯¹äºpxc, ä¸ºäº†é¿å…æµæ§, å¯ä»¥åœ¨å¯¼å…¥.sqlæ–‡ä»¶æ—¶, å…ˆå¯¹æ–‡ä»¶åšå¤„ç†1awk &#x27;1;NR%1000==0&#123;print &quot;select sleep(1);&quot;&#125;&#x27; xxx.sql &gt; xxx_dba.sqlä¸Šé¢çš„å‘½ä»¤æ¯1000è¡Œå¢åŠ ä¸€è¡Œselect sleep(1);, è¿™æ ·æ‰§è¡Œé¢‘ç‡æ˜¯1k/s å¯¹äºmysqldumpäº§ç”Ÿçš„sqlæ–‡ä»¶, åˆ™éœ€è¦åœ¨å¯¼å‡ºæ˜¯æŒ‡å®š1mysqldump --skip-extended-insertæ¯è¡Œä¸€ä¸ªinsertè¯­å¥, ä¹‹åå†ä½¿ç”¨awkå¤„ç† ä½¿ç”¨pt-fifo-split 12345678910111213141516171819FLAT_FILE=&quot;/tmp/big_file.txt&quot;FIFO_PATH=&quot;$&#123;FLAT_FILE&#125;.fifo&quot;LOAD_FILE=&quot;$&#123;FLAT_FILE&#125;.load&quot;CHUNK_SIZE=1000 # Split the filept-fifo-split --force --lines $&#123;CHUNK_SIZE&#125; $&#123;FLAT_FILE&#125; --fifo $&#123;FIFO_PATH&#125; &amp;# Sleep 10 seconds to assure $&#123;FIFO_PATH&#125; exists before entering loopsleep 10while [ -e $&#123;FIFO_PATH&#125; ]do # Write chunk to disk cat $&#123;FIFO_PATH&#125; &gt; $&#123;LOAD_FILE&#125; # Load chunk into table mysql --database=test \\ --show-warnings \\ -vv &lt; $&#123;LOAD_FILE&#125; sleep 1done","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"Write-set Cache(GCache)","slug":"Write-set Cache(GCache)","date":"2018-06-02T05:23:00.000Z","updated":"2018-06-15T09:26:09.000Z","comments":true,"path":"2018/06/02/Write-set Cache(GCache)/","link":"","permalink":"http://fuxkdb.com/2018/06/02/Write-set%20Cache(GCache)/","excerpt":"","text":"Write-set Cache(GCache)Galear Clusterå°†write-setså­˜å‚¨åœ¨ä¸€ä¸ªç§°ä¸ºWrite-set Cache(æˆ–ç§°ä¸ºGCache)çš„ç‰¹æ®Šçš„cacheä¸­. GCache cache is a memory allocator for write-sets.ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æœ€å¤§é™åº¦åœ°å‡å°‘RAMä¸Šçš„write-setfootprint. Galeraé›†ç¾¤é€šè¿‡å°†å¸è½½å†™å…¥é›†å­˜å‚¨åˆ°ç£ç›˜æ¥æ”¹å–„æ­¤é—®é¢˜. GCacheé‡‡ç”¨ä¸‰ç§ç±»å‹çš„å­˜å‚¨ï¼š Permanent In-Memory Store Here write-sets allocate using the default memory allocator for the operating system. This is useful in systems that have spare RAM. The store has a hard size limit. By default it is disabled. è¿™ä¸ªå°±æ˜¯è¯´å¯ä»¥ç”¨æ“ä½œç³»ç»Ÿçš„å†…å­˜ç©ºé—´, å¯¹äºæœ‰ç©ºé—²å†…å­˜çš„ç³»ç»Ÿæ¯”è¾ƒåˆé€‚. è¿™ä¸ªç©ºé—´å¤§å°æœ‰ä¸€ä¸ªç¡¬æ€§çš„é™åˆ¶, è²Œä¼¼æ˜¯è¿™ä¸ªå‚æ•°gcache.mem_size=0[^1] é»˜è®¤ä¸ä½¿ç”¨å†…å­˜. Permanent Ring-Buffer File Here write-sets pre-allocate to disk during cache initialization. This is intended as the main write-set store. è¿™ä¸€ä¸ªå—å¾ªç¯ä½¿ç”¨çš„åŒºåŸŸ, æ˜¯å†™åˆ°ç£ç›˜ä¸Šçš„ , è²Œä¼¼æ˜¯è¿™ä¸ªå‚æ•°gcache.size = 128M^2 On-Demand Page Store è¿™é‡Œå†™é›†æ ¹æ®éœ€è¦åœ¨è¿è¡Œæ—¶åˆ†é…ç»™å†…å­˜æ˜ å°„çš„é¡µé¢æ–‡ä»¶ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå…¶å¤§å°ä¸º128Mb(gcache.page_size[^3])ï¼Œä½†å¦‚æœéœ€è¦å­˜å‚¨æ›´å¤§çš„å†™å…¥é›†ï¼Œåˆ™å¯èƒ½ä¼šæ›´å¤§ã€‚é¡µé¢å­˜å‚¨çš„å¤§å°å—å¯ç”¨ç£ç›˜ç©ºé—´çš„é™åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒGalera Clusterä¼šåœ¨ä¸ä½¿ç”¨æ—¶åˆ é™¤é¡µé¢æ–‡ä»¶ï¼Œä½†æ‚¨å¯ä»¥å¯¹è¦ä¿ç•™çš„é¡µé¢æ–‡ä»¶çš„æ€»å¤§å°è®¾ç½®é™åˆ¶ã€‚ When all other stores are disabled, at least one page file remains present on disk. Galeraé›†ç¾¤ä½¿ç”¨åˆ†é…ç®—æ³•ï¼Œå°è¯•æŒ‰ä¸Šè¿°é¡ºåºå­˜å‚¨å†™å…¥é›†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒé¦–å…ˆå°è¯•ä½¿ç”¨æ°¸ä¹…æ€§å†…å­˜å­˜å‚¨ã€‚å¦‚æœå†™å…¥é›†æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œå®ƒå°†å°è¯•å­˜å‚¨åˆ°æ°¸ä¹…ç¯å½¢ç¼“å†²åŒºæ–‡ä»¶ã€‚é¡µé¢å­˜å‚¨æ€»æ˜¯æˆåŠŸï¼Œé™¤éå†™å…¥é›†å¤§äºå¯ç”¨ç£ç›˜ç©ºé—´ã€‚ Galera Cluster uses an allocation algorithm that attempts to store write-sets in the above order. That is, first it attempts to use permanent in-memory store. If there is not enough space for the write-set, it attempts to store to the permanent ring-buffer file. The page store always succeeds, unless the write-set is larger than the available disk space. é»˜è®¤æƒ…å†µä¸‹ï¼Œå†™é›†ç¼“å­˜åˆ†é…è¿›ç¨‹å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨gcache.dirå‚æ•°æŒ‡å®šå†™å…¥é›†ç¼“å­˜çš„ä¸“ç”¨ä½ç½®. [^1]: Deprecated in 5.6.22-25.8 . This variable has been deprecated and shouldnâ€™t be used as it could cause a node to crash. å½“èŠ‚ç‚¹æ¥æ”¶çŠ¶æ€ä¼ è¾“æ—¶ï¼Œå®ƒä»¬ä¸èƒ½å¤„ç†ä¼ å…¥çš„å†™é›†ï¼Œç›´åˆ°å®ƒä»¬å®ŒæˆçŠ¶æ€æ›´æ–°ã€‚åœ¨æŸäº›æ–¹æ³•ä¸‹ï¼Œå‘é€çŠ¶æ€è½¬ç§»çš„èŠ‚ç‚¹ä¹Ÿè¢«é˜»å¡ã€‚ä¸ºé˜²æ­¢æ•°æ®åº“è¿›ä¸€æ­¥è½åï¼ŒGCacheå°†å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„ä¼ å…¥å†™å…¥é›†ä¿å­˜åˆ°ç£ç›˜ã€‚ æ­¤å‚æ•°å®šä¹‰è¦ä¸ºå½“å‰ç¯å½¢ç¼“å†²åŒºå­˜å‚¨åˆ†é…çš„ç£ç›˜ç©ºé—´é‡ã€‚èŠ‚ç‚¹åœ¨å¯åŠ¨æ•°æ®åº“æœåŠ¡å™¨æ—¶åˆ†é…æ­¤ç©ºé—´ã€‚ [^3]: This variable can be used to specify the size of the page files in the page storage.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PXC","slug":"PXC","permalink":"http://fuxkdb.com/tags/PXC/"}]},{"title":"Want IST Not SST for Node Rejoins? We Have a Solution!","slug":"gcache.freeze_purge_at_seqno","date":"2018-06-02T04:23:00.000Z","updated":"2018-06-15T09:26:20.000Z","comments":true,"path":"2018/06/02/gcache.freeze_purge_at_seqno/","link":"","permalink":"http://fuxkdb.com/2018/06/02/gcache.freeze_purge_at_seqno/","excerpt":"","text":"Want IST Not SST for Node Rejoins? We Have a Solution!Krunal Bauskar | February 13, 2018 | Posted In: High-availability, MySQL, Percona XtraDB Cluster å¦‚æœæˆ‘ä»¬å‘Šè¯‰ä½ ï¼Œæœ‰ä¸€ç§ç¡®å®šçš„æ–¹æ³•å¯ä»¥è®©èŠ‚ç‚¹rejoinä½¿ç”¨ISTè€Œä¸æ˜¯SSTï¼Ÿæ‚¨å¯ä»¥ä¿è¯æ–°èŠ‚ç‚¹ä½¿ç”¨ISTé‡æ–°åŠ å…¥. å¬èµ·æ¥å¾ˆæœ‰è¶£ï¼Ÿè¯·ç»§ç»­é˜…è¯». é€šå¸¸å½“ä¸€ä¸ªèŠ‚ç‚¹è„±ç¦»é›†ç¾¤ä¸€æ®µæ—¶é—´(å¤„äºç»´æŠ¤ç›®çš„æˆ–å°±æ˜¯shutdownäº†), é›†ç¾¤ä¸Šå…¶ä»–èŠ‚ç‚¹çš„gcacheå°†ç”¨æ¥åœ¨å‰è€…é‡æ–°åŠ å…¥é›†ç¾¤æ—¶æä¾›å‰è€…åœ¨è„±ç¦»æœŸé—´ç¼ºå¤±çš„write-set(s). å¦‚æœæ‚¨é…ç½®äº†è¾ƒå¤§çš„gcache, æˆ–downtimeè¶³å¤Ÿæ®µ, åˆ™æ­¤æ–¹æ³•å¯è¡Œ. å¯¹äºç”Ÿäº§ç¯å¢ƒæ¥è¯´, æ— è®ºæ˜¯è®¾ç½®è¾ƒå¤§çš„gcacheæˆ–è€…ç¼©çŸ­åœæœºçª—å£éƒ½ä¸å¤Ÿå¥½. åœ¨åœæœºä¹‹å‰åœ¨æ½œåœ¨çš„DONORèŠ‚ç‚¹ä¸Šé‡æ–°é…ç½®gcacheéœ€è¦å…³é—­èŠ‚ç‚¹.(gcacheä¸èƒ½åŠ¨æ€è°ƒæ•´å¤§å°), Restoring it back to original size needs another shutdown. So â€œthree shutdownsâ€ for a single downtime. *No way â€¦â€¦ not acceptable with busy production clusters and the possibility of more errors.* Introducing â€œgcache.freeze_purge_at_seqnoâ€åŸºäºä»¥ä¸Šç—›ç‚¹, æˆ‘ä»¬åœ¨Percona XtraDB Cluster 5.7.20å¼•å…¥äº†gcache.freeze_purge_at_seqno.è¿™å°†æ§åˆ¶æ¸…é™¤gcache, ä»è€Œåœ¨èŠ‚ç‚¹é‡æ–°åŠ å…¥æ—¶ä¿ç•™æ›´å¤šçš„æ•°æ®ä»¥ä¿ƒè¿›IST. Galeraé›†ç¾¤ä¸–ç•Œä¸­çš„æ‰€æœ‰äº‹åŠ¡éƒ½è¢«åˆ†é…äº†å”¯ä¸€çš„å…¨å±€åºåˆ—å·ï¼ˆseqnoï¼‰.è·Ÿè¸ªäº‹æƒ…å‘ç”Ÿä½¿ç”¨æ­¤seqnoï¼ˆå¦‚wsrep_last_appliedï¼Œwsrep_last_committedï¼Œwsrep_replicatedï¼Œwsrep_local_cached_downtoç­‰^1ï¼‰.wsrep_local_cached_downtoè¡¨ç¤ºgcacheå·²è¢«æ¸…é™¤çš„åºåˆ—å·ã€‚å‡è®¾wsrep_local_cached_downto = Nï¼Œé‚£ä¹ˆgcacheå…·æœ‰æ¥è‡ª[Nï¼Œwsrep_replicated]çš„æ•°æ®, å¹¶æ¸…é™¤äº†[1ï¼ŒN)æ•°æ®ã€‚ gcache.freeze_purge_at_seqno takes three values: 1. -1(é»˜è®¤å€¼): no freeze, the purge operates as normal. 2. **x (should be valid seqno in gcache):** freeze purge of write-sets &gt;= x. The best way to select x is to use the wsrep_last_applied value as an indicator from the node that you plan to shut down. (wsrep_applied * 0.09. Retain this extra 10% to trick the [safety gap heuristic algorithm of IST](https://www.percona.com/blog/2017/11/15/understanding-ist-donor-selected/).) 3. **now:** freeze purge of write-sets &amp;gt;= smallest seqno currently in gcache. Instant freeze of gcache-purge. (If tracing x (above) is difficult, simply use â€œnowâ€ and you are good). åœ¨é›†ç¾¤çš„ç°æœ‰èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¾ç½®ï¼ˆè¿™å°†ç»§ç»­ä½œä¸ºé›†ç¾¤çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶å¯ä»¥å……å½“æ½œåœ¨çš„æåŠ©è€…ï¼‰ã€‚è¯¥èŠ‚ç‚¹ç»§ç»­ä¿ç•™å†™é›†ï¼Œä»è€Œå…è®¸é‡å¯èŠ‚ç‚¹ä½¿ç”¨ISTé‡æ–°åŠ å…¥ã€‚ ï¼ˆæ‚¨å¯ä»¥åœ¨é‡å¯éœ€è¦rejoinçš„èŠ‚ç‚¹æ—¶é€šè¿‡æŒ‡å®šâ€”wsrep_sst_donorå°†è¯¥èŠ‚ç‚¹ä½œä¸ºé¦–é€‰DONORè¿›è¡Œæä¾›ï¼‰ Set this on an existing node of the cluster (that will continue to be part of the cluster and can act as potential DONOR). This node continues to retain the write-sets, thereby allowing the restarting node to rejoin using IST. (You can feed the said node as a preferred DONOR through wsrep_sst_donor while restarting the said rejoining node.) è¯·è®°ä½ï¼Œä¸€æ—¦èŠ‚ç‚¹é‡æ–°åŠ å…¥ï¼Œè¯·å°†å…¶è®¾å›-1ã€‚è¿™å¯ä»¥é¿å…è¶…å‡ºä¸Šè¿°æ—¶é—´è¡¨çš„DONORä¸Šçš„å ç”¨ç©ºé—´ã€‚åœ¨ä¸‹ä¸€ä¸ªæ¸…é™¤å‘¨æœŸä¸­ï¼Œæ‰€æœ‰æ—§çš„ä¿ç•™å†™å…¥é›†ä¹Ÿä¼šè¢«é‡Šæ”¾ï¼ˆå›æ”¶ç©ºé—´å›åˆ°åŸå§‹çŠ¶æ€ï¼‰. Note: 12345To find out existing value of gcache.freeze_purge_at_seqno query wsrep_provider_options.select @@wsrep_provider_options;To set gcache.freeze_purge_at_seqnoset global wsrep_provider_options=&quot;gcache.freeze_purge_at_seqno = now&quot;; Why should you use it? gcacheåŠ¨æ€å¢é•¿ï¼ˆä½¿ç”¨ç°æœ‰çš„é¡µé¢å­˜å‚¨æœºåˆ¶ï¼‰ï¼Œå¹¶åœ¨ç”¨æˆ·å°†å…¶è®¾ç½®å›-1æ—¶æ”¶ç¼©ã€‚è¿™æ„å‘³ç€æ‚¨åªåœ¨éœ€è¦æ—¶ä½¿ç”¨(æ›´å¤šçš„)ç£ç›˜ç©ºé—´. ä¸éœ€è¦é‡æ–°å¯åŠ¨. ç”¨æˆ·åªéœ€ä¸“æ³¨äºéœ€è¦ç»´æŠ¤çš„èŠ‚ç‚¹. No complex math or understanding of seqno involved (simply use â€œnowâ€). Less prone to error, as SST is one of the major error-prone areas with the cluster. So why wait? Give it a try! It is part of Percona XtraDB Cluster 5.7.20 onwards, and helps you get IST not SST for node rejoins Note: If you need more information about gcache, check here and here","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PXC","slug":"PXC","permalink":"http://fuxkdb.com/tags/PXC/"}]},{"title":"[è¯‘]PXC7ä¸­æ•…éšœåœºæ™¯åŠæ¢å¤æ–¹æ³•","slug":"PXC7ç§æ•…éšœåœºæ™¯åŠæ¢å¤æ–¹æ³•","date":"2018-05-29T04:23:00.000Z","updated":"2018-06-08T13:35:54.000Z","comments":true,"path":"2018/05/29/PXC7ç§æ•…éšœåœºæ™¯åŠæ¢å¤æ–¹æ³•/","link":"","permalink":"http://fuxkdb.com/2018/05/29/PXC7%E7%A7%8D%E6%95%85%E9%9A%9C%E5%9C%BA%E6%99%AF%E5%8F%8A%E6%81%A2%E5%A4%8D%E6%96%B9%E6%B3%95/","excerpt":"ä¸æ ‡å‡†çš„MySQLå¤åˆ¶ä¸åŒï¼ŒPXCç¾¤é›†å°±åƒä¸€ä¸ªé€»è¾‘å®ä½“ï¼Œå®ƒè´Ÿè´£å…³æ³¨æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å’Œä¸€è‡´æ€§ä»¥åŠç¾¤é›†çŠ¶æ€ã€‚è¿™æ ·å¯ä»¥ä¿æŒæ›´å¥½çš„æ•°æ®å®Œæ•´æ€§ï¼Œç„¶åæ‚¨å¯ä»¥ä»ä¼ ç»Ÿçš„å¼‚æ­¥å¤åˆ¶ä¸­è·ç›Šï¼ŒåŒæ—¶å…è®¸åœ¨åŒä¸€æ—¶é—´åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œå®‰å…¨å†™å…¥. å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªPXCé›†ç¾¤åŒ…å«3ä¸ªèŠ‚ç‚¹ æƒ…æ™¯1 èŠ‚ç‚¹Aæ­£å¸¸åœæ­¢, ä¾‹å¦‚éœ€è¦åœåº“åšä¸€äº›ç»´æŠ¤, é…ç½®å˜æ›´ç­‰æ“ä½œ. åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…¶ä»–èŠ‚ç‚¹ä»è¯¥èŠ‚ç‚¹æ¥æ”¶â€good byeâ€æ¶ˆæ¯, å› æ­¤é›†ç¾¤å¤§å°å°†ä¼šç¼©å°(åœ¨è¿™ä¸ªä¾‹å­ä¸­ç¼©å°ä¸º2), å¹¶ä¸”æŸäº›å±æ€§å¦‚quorum caculationå’Œauto increment(æˆ‘ç†è§£ä¸ºauto_increment_incrementå’Œauto_increment_offsetä¼šç”±äºé›†ç¾¤æ‰©ç¼©åŠ¨æ€è°ƒæ•´). ä¸€æ—¦æˆ‘ä»¬é‡æ–°å¼€å§‹çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒä¼šæ ¹æ®å®ƒçš„my.cnfä¸­wsrep_cluster_addressè®¾ç½®åŠ å…¥ç¾¤é›†. è¿™ä¸ªè¿‡ç¨‹ä¸æ™®é€šçš„å¤åˆ¶æœ‰å¾ˆå¤§çš„ä¸åŒ - åœ¨AèŠ‚ç‚¹å†æ¬¡ä¸é›†ç¾¤å®Œå…¨åŒæ­¥ä¹‹å‰ï¼ŒAèŠ‚ç‚¹ä¸ä¼šæ¥å—ä¾›ä»»ä½•è¯·æ±‚ï¼Œå› æ­¤ä»…ä»…æ˜¯ä¸é›†ç¾¤å»ºç«‹è¿æ¥æ˜¯ä¸å¤Ÿçš„ï¼Œè€Œæ˜¯å¿…é¡»è¦å…ˆå®Œæˆstate transfer. å¦‚æœBæˆ–CèŠ‚ç‚¹çš„writeset cache (gcache.size), ä»ç„¶æœ‰æ¢å¤AèŠ‚ç‚¹æ‰€éœ€çš„æ‰€æœ‰äº‹åŠ¡, é‚£ä¹ˆå°†ä½¿ç”¨IST å¦åˆ™ä½¿ç”¨ SST . å› æ­¤ï¼Œå¦‚æœ¬æ–‡æ‰€ç¤ºï¼Œç¡®å®šæœ€ä½³donorå¾ˆé‡è¦. å¦‚æœç”±äºdonorçš„gcacheä¸­ç¼ºå°‘äº¤æ˜“è€Œå¯¼è‡´ISTä¸å¯ç”¨ï¼Œåˆ™ç”±donorä½œå‡ºå›é€€å†³å®šï¼Œè€ŒSSTè‡ªåŠ¨å¯åŠ¨ã€‚","text":"ä¸æ ‡å‡†çš„MySQLå¤åˆ¶ä¸åŒï¼ŒPXCç¾¤é›†å°±åƒä¸€ä¸ªé€»è¾‘å®ä½“ï¼Œå®ƒè´Ÿè´£å…³æ³¨æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å’Œä¸€è‡´æ€§ä»¥åŠç¾¤é›†çŠ¶æ€ã€‚è¿™æ ·å¯ä»¥ä¿æŒæ›´å¥½çš„æ•°æ®å®Œæ•´æ€§ï¼Œç„¶åæ‚¨å¯ä»¥ä»ä¼ ç»Ÿçš„å¼‚æ­¥å¤åˆ¶ä¸­è·ç›Šï¼ŒåŒæ—¶å…è®¸åœ¨åŒä¸€æ—¶é—´åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œå®‰å…¨å†™å…¥. å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªPXCé›†ç¾¤åŒ…å«3ä¸ªèŠ‚ç‚¹ æƒ…æ™¯1 èŠ‚ç‚¹Aæ­£å¸¸åœæ­¢, ä¾‹å¦‚éœ€è¦åœåº“åšä¸€äº›ç»´æŠ¤, é…ç½®å˜æ›´ç­‰æ“ä½œ. åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå…¶ä»–èŠ‚ç‚¹ä»è¯¥èŠ‚ç‚¹æ¥æ”¶â€good byeâ€æ¶ˆæ¯, å› æ­¤é›†ç¾¤å¤§å°å°†ä¼šç¼©å°(åœ¨è¿™ä¸ªä¾‹å­ä¸­ç¼©å°ä¸º2), å¹¶ä¸”æŸäº›å±æ€§å¦‚quorum caculationå’Œauto increment(æˆ‘ç†è§£ä¸ºauto_increment_incrementå’Œauto_increment_offsetä¼šç”±äºé›†ç¾¤æ‰©ç¼©åŠ¨æ€è°ƒæ•´). ä¸€æ—¦æˆ‘ä»¬é‡æ–°å¼€å§‹çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒä¼šæ ¹æ®å®ƒçš„my.cnfä¸­wsrep_cluster_addressè®¾ç½®åŠ å…¥ç¾¤é›†. è¿™ä¸ªè¿‡ç¨‹ä¸æ™®é€šçš„å¤åˆ¶æœ‰å¾ˆå¤§çš„ä¸åŒ - åœ¨AèŠ‚ç‚¹å†æ¬¡ä¸é›†ç¾¤å®Œå…¨åŒæ­¥ä¹‹å‰ï¼ŒAèŠ‚ç‚¹ä¸ä¼šæ¥å—ä¾›ä»»ä½•è¯·æ±‚ï¼Œå› æ­¤ä»…ä»…æ˜¯ä¸é›†ç¾¤å»ºç«‹è¿æ¥æ˜¯ä¸å¤Ÿçš„ï¼Œè€Œæ˜¯å¿…é¡»è¦å…ˆå®Œæˆstate transfer. å¦‚æœBæˆ–CèŠ‚ç‚¹çš„writeset cache (gcache.size), ä»ç„¶æœ‰æ¢å¤AèŠ‚ç‚¹æ‰€éœ€çš„æ‰€æœ‰äº‹åŠ¡, é‚£ä¹ˆå°†ä½¿ç”¨IST å¦åˆ™ä½¿ç”¨ SST . å› æ­¤ï¼Œå¦‚æœ¬æ–‡æ‰€ç¤ºï¼Œç¡®å®šæœ€ä½³donorå¾ˆé‡è¦. å¦‚æœç”±äºdonorçš„gcacheä¸­ç¼ºå°‘äº¤æ˜“è€Œå¯¼è‡´ISTä¸å¯ç”¨ï¼Œåˆ™ç”±donorä½œå‡ºå›é€€å†³å®šï¼Œè€ŒSSTè‡ªåŠ¨å¯åŠ¨ã€‚ æƒ…æ™¯2 èŠ‚ç‚¹Aå’ŒBæ­£å¸¸åœæ­¢. ä¸ä¹‹å‰çš„æƒ…å†µç±»ä¼¼, é›†ç¾¤sizeç¼©å°è‡³1, å› æ­¤å³ä½¿å•ä¸ªå‰©ä½™çš„èŠ‚ç‚¹Cä¹Ÿæ˜¯ä¸»è¦ç»„ä»¶å¹¶ä¸”æ­£åœ¨æœåŠ¡äºå®¢æˆ·ç«¯è¯·æ±‚. ä¸ºäº†è®©èŠ‚ç‚¹å›åˆ°é›†ç¾¤ä¸­ï¼Œä½ åªéœ€è¦å¯åŠ¨å®ƒä»¬. ç„¶è€Œï¼ŒèŠ‚ç‚¹Cå°†è¢«åˆ‡æ¢åˆ°â€œDonor/Desyncedâ€çŠ¶æ€ï¼Œå› ä¸ºå®ƒå°†ä¸å¾—ä¸å‘è‡³å°‘ç¬¬ä¸€åŠ å…¥èŠ‚ç‚¹æä¾›state transferã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒä»ç„¶å¯ä»¥è¯»/å†™ï¼Œä½†å®ƒå¯èƒ½ä¼šæ…¢å¾—å¤šï¼Œè¿™å–å†³äºå®ƒéœ€è¦å‘é€å¤šå¤§çš„state transfer. Also some load balancers may consider the donor node as not operational and remove it from the pool. So it is best to avoid situation when only one node is up. ä½†è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨æŒ‰é¡ºåºé‡æ–°å¯åŠ¨Aç„¶åBï¼Œåˆ™å¯èƒ½éœ€è¦ç¡®ä¿Bä¸ä¼šä½¿ç”¨Aä½œä¸ºçŠ¶æ€è½¬ç§»æåŠ©è€…ï¼Œå› ä¸ºAå¯èƒ½æ²¡æœ‰åœ¨å®ƒçš„gcacheä¸­åŒ…å«æ‰€æœ‰éœ€è¦çš„å†™å…¥é›†ã€‚å› æ­¤ï¼Œåªéœ€ä»¥è¿™ç§æ–¹å¼å°†CèŠ‚ç‚¹æŒ‡å®šä¸ºæåŠ©è€…å³å¯ï¼ˆâ€œnodeCâ€åç§°æ˜¯æ‚¨ä½¿ç”¨wsrep_node_nameå˜é‡æŒ‡å®šçš„åç§°ï¼‰ï¼š 1service mysql start --wsrep_sst_donor=nodeC æƒ…æ™¯3 ä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ­£å¸¸åœæ­¢. æ•´ä¸ªé›†ç¾¤å·²ç»ä¸å¯ç”¨äº†. ç°åœ¨çš„é—®é¢˜æ˜¯, å¦‚ä½•é‡æ–°initializeé›†ç¾¤. æœ‰ä¸€ä¸ªå…³é”®ç‚¹éœ€è¦çŸ¥é“çš„æ˜¯, åœ¨clean shutdownçš„è¿‡ç¨‹ä¸­, PXCèŠ‚ç‚¹ä¼šå°†è‡ªå·±æœ€åæ‰§è¡Œçš„ä½ç½®è®°å½•åˆ°grastate.datæ–‡ä»¶ä¸­. é€šè¿‡å¯¹æ¯”grastate.datä¸­çš„seqno, å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°the most advanced one(æœ€æœ‰å¯èƒ½çš„æ˜¯æœ€åä¸€ä¸ªåœæ­¢çš„èŠ‚ç‚¹). é›†ç¾¤å¿…é¡» bootstrapped using this node, æ¢è¨€ä¹‹, seqnoæœ€å¤§çš„èŠ‚ç‚¹éœ€è¦æ‰§è¡Œfull SSTç»™å…¶ä»–joiner. To bootstrap the first node, invoke the startup script like this: 1/etc/init.d/mysql bootstrap-pxc æˆ– 1service mysql bootstrap-pxc æˆ– 1service mysql start --wsrep_new_cluster æˆ– 1service mysql start --wsrep-cluster-address=&quot;gcomm://&quot; or in packages using systemd service manager (Centos7 at the moment): 1systemctl start mysql@bootstrap.service In older PXC versions, to bootstrap cluster, you had to edit my.cnf and replace previous wsrep_cluster_address line with empty value like this: wsrep_cluster_address=gcomm:// and start mysql normally. More details to be found here. Please note that even if you bootstrap from the most advanced node, so the other nodes have lower sequence number, they will have to still join via full-SST because the Galera Cache is not retained on restart. For that reason, it is recommended to stop writes to the cluster before itâ€™s full shutdown, so that all nodes stop in the same position. Edit: This changes since Galera 3.19 thanks to gcache-recover option æƒ…æ™¯ 4 èŠ‚ç‚¹Aä»é›†ç¾¤ä¸­æ¶ˆå¤±(æ–­ç”µ, ç¡¬ä»¶æ•…éšœ, kernel panic, mysqld crash, kill -9 on mysqld pid, OOMkiller). B/CèŠ‚ç‚¹æ„è¯†åˆ°ä¸AèŠ‚ç‚¹è¿æ¥ä¸­æ–­, ä¼šå°è¯•é‡è¿. é‡è¿è¶…æ—¶å, both agree that node A is really down and remove it â€œofficiallyâ€ from the cluster. Quorum is saved ( 2 out of 3 nodes are up), so no service disruption happens. After restarting, A will join automatically the same way as in scenario 1. æƒ…æ™¯5 A,BèŠ‚ç‚¹å‡ä»é›†ç¾¤ä¸­æ¶ˆå¤±. The node C is not able to form the quorum alone, é›†ç¾¤åˆ‡æ¢åˆ°non-primaryæ¨¡å¼, æ‹’ç»æ‰€æœ‰åº”ç”¨è¯·æ±‚. åœ¨è¿™ç§æƒ…æ™¯ä¸‹, CèŠ‚ç‚¹çš„mysqldè¿›ç¨‹ä»åœ¨è¿è¡Œ, ä½ å¯ä»¥è¿æ¥åˆ°CèŠ‚ç‚¹çš„mysql, ä½†æ˜¯æ‰§è¡Œä»»ä½•è¯­å¥éƒ½å°†å¤±è´¥ 12mysql&gt; select * from test.t1;ERROR 1047 (08S01): Unknown command äº‹å®ä¸Š, A,BèŠ‚ç‚¹æ¶ˆå¤±åˆæ—¶, Cå‡ ç‚¹ä»ç„¶å¯ä¹Ÿä»¥å®ŒæˆæŸ¥è¯¢ä¸€äº›è¯·æ±‚, ä½†å½“Cå‡ ç‚¹æ„è¯†åˆ°æ— æ³•è¿æ¥A,BèŠ‚ç‚¹å, å°±æ— æ³•å®ŒæˆæŸ¥è¯¢è¯·æ±‚äº†. è€Œå†™å…¥è¯·æ±‚åœ¨certification based replicationä¿éšœä¸‹åˆ™ä¼šåœ¨A,Bæ¶ˆå¤±æ—¶å°±ç«‹å³è¢«æ‹’ç». This is what we are going to see in the remaining nodeâ€™s log: 123456140814 0:42:13 [Note] WSREP: commit failed for reason: 3140814 0:42:13 [Note] WSREP: conflict state: 0140814 0:42:13 [Note] WSREP: cluster conflict due to certification failure for threads:140814 0:42:13 [Note] WSREP: Victim thread:THD: 7, mode: local, state: executing, conflict: cert failure, seqno: -1SQL: insert into t values (1) ç„¶åå•ä¸ªèŠ‚ç‚¹Cç­‰å¾…å®ƒçš„å¯¹ç­‰ä½“å†æ¬¡å‡ºç°ï¼Œå¹¶ä¸”åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¾‹å¦‚å½“ç½‘ç»œä¸­æ–­å’Œè¿™äº›èŠ‚ç‚¹ä¸€ç›´éƒ½åœ¨è¿è¡Œæ—¶ï¼Œç¾¤é›†å°†è‡ªåŠ¨å†æ¬¡å½¢æˆ. åŒæ ·ï¼Œå¦‚æœèŠ‚ç‚¹Bå’ŒCåˆšåˆšä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ–­å¼€ç½‘ç»œï¼Œä½†å®ƒä»¬ä»ç„¶å¯ä»¥åˆ°è¾¾å¯¹æ–¹ï¼Œé‚£ä¹ˆå®ƒä»¬å°†ç»§ç»­è¿è¡Œï¼Œå› ä¸ºå®ƒä»¬ä»ç„¶æ„æˆæ³•å®šäººæ•°ã€‚å¦‚æœAå’ŒBç”±äºåœç”µè€Œå´©æºƒï¼ˆç”±äºæ•°æ®ä¸ä¸€è‡´ï¼Œé”™è¯¯ç­‰ï¼‰æˆ–å…³é—­ï¼Œæ‚¨éœ€è¦æ‰§è¡Œæ‰‹åŠ¨æ“ä½œæ‰èƒ½åœ¨CèŠ‚ç‚¹ä¸Šå¯ç”¨primary component ï¼Œbefore you can bring A and B backã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å‘Šè¯‰CèŠ‚ç‚¹â€œå˜¿ï¼Œä½ ç°åœ¨å¯ä»¥å•ç‹¬å½¢æˆä¸€ä¸ªæ–°çš„ç¾¤é›†ï¼Œå¿˜è®°Aå’ŒBï¼â€ã€‚æ‰§è¡Œæ­¤æ“ä½œçš„å‘½ä»¤æ˜¯^1ï¼š 1SET GLOBAL wsrep_provider_options=&#x27;pc.bootstrap=true&#x27;; However, you should double check in order to be very sure the other nodes are really down before doing that! Otherwise, you will most likely end up with two clusters having different data. æƒ…æ™¯6 æ‰€æœ‰èŠ‚ç‚¹æ„å¤–å®•æœº(All nodes went down without proper shutdown procedure) è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ä¾‹å¦‚æ•°æ®ä¸­å¿ƒæŒ‚äº†, æˆ–è€…é‡ä¸Šäº†MySQLæˆ–Galera bugå¯¼è‡´æ‰€æœ‰èŠ‚ç‚¹crash. ä½†ä¹Ÿç”±äºæ•°æ®ä¸€è‡´æ€§çš„å½±å“ï¼Œé›†ç¾¤æ£€æµ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸åŒçš„æ•°æ®å¯¼è‡´æ‰€æœ‰èŠ‚ç‚¹æŒ‚äº†. In each of those cases, the grastate.dat file is not updated and does not contain valid sequence number (seqno). It may look like this: 123456cat /var/lib/mysql/grastate.dat# GALERA saved stateversion: 2.1uuid: 220dcdcb-1629-11e4-add3-aec059ad3734seqno: -1cert_index: åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ç¡®å®šæ‰€æœ‰èŠ‚ç‚¹æ˜¯å¦å½¼æ­¤ä¸€è‡´ï¼Œå› æ­¤æ‰¾åˆ°æœ€å…ˆè¿›(most advanced one )çš„èŠ‚ç‚¹ä»¥ä¾¿ä½¿ç”¨å®ƒæ¥boostrapç¾¤é›†è‡³å…³é‡è¦ã€‚åœ¨ä»»ä½•èŠ‚ç‚¹ä¸Šå¯åŠ¨mysqlå®ˆæŠ¤è¿›ç¨‹ä¹‹å‰ï¼Œæ‚¨å¿…é¡»é€šè¿‡æ£€æŸ¥å®ƒçš„äº‹åŠ¡çŠ¶æ€æ¥æå–æœ€åä¸€ä¸ªåºåˆ—å·ã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š 123456[root@percona3 ~]# mysqld_safe --wsrep-recover140821 15:57:15 mysqld_safe Logging to &#x27;/var/lib/mysql/percona3_error.log&#x27;.140821 15:57:15 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql140821 15:57:15 mysqld_safe WSREP: Running position recovery with --log_error=&#x27;/var/lib/mysql/wsrep_recovery.6bUIqM&#x27; --pid-file=&#x27;/var/lib/mysql/percona3-recover.pid&#x27;140821 15:57:17 mysqld_safe WSREP: Recovered position 4b83bbe6-28bb-11e4-a885-4fc539d5eb6a:2140821 15:57:19 mysqld_safe mysqld from pid file /var/lib/mysql/percona3.pid ended å› æ­¤ï¼Œæ­¤èŠ‚ç‚¹ä¸Šæœ€åæäº¤çš„äº‹åŠ¡åºåˆ—å·ä¸º2.ç°åœ¨ï¼Œæ‚¨åªéœ€é¦–å…ˆä»æœ€æ–°èŠ‚ç‚¹å¼•å¯¼ï¼Œç„¶åå¯åŠ¨å…¶ä»–èŠ‚ç‚¹ã€‚ So the last committed transaction sequence number on this node was 2. Now you just need to bootstrap from the latest node first and then start the others. However, the above procedure wonâ€™t be needed in the recent Galera versions (3.6+?), available since PXC 5.6.19. There is a new option â€“ pc.recovery (enabled by default), which saves the cluster state into a file named gvwstate.dat on each member node. As the variable name says (pc â€“ primary component), it saves only a cluster being in PRIMARY state. An example content of that file may look like this: 123456789cat /var/lib/mysql/gvwstate.datmy_uuid: 76de8ad9-2aac-11e4-8089-d27fd06893b9#vwbegview_id: 3 6c821ecc-2aac-11e4-85a5-56fe513c651f 3bootstrap: 0member: 6c821ecc-2aac-11e4-85a5-56fe513c651f 0member: 6d80ec1b-2aac-11e4-8d1e-b2b2f6caf018 0member: 76de8ad9-2aac-11e4-8089-d27fd06893b9 0#vwend We can see three node cluster above with all members being up. Thanks to this new feature, in the case of power outage in our datacenter, after power is back, the nodes will read the last state on startup and will try to restore primary component once all the members again start to see each other. This makes the PXC cluster to automatically recover from being powered down without any manual intervention! In the logs we will see: 1234567891011121314151617181920212223242526272829303132333435363738140823 15:28:55 [Note] WSREP: restore pc from disk successfully(...)140823 15:29:59 [Note] WSREP: declaring 6c821ecc at tcp://192.168.90.3:4567 stable140823 15:29:59 [Note] WSREP: declaring 6d80ec1b at tcp://192.168.90.4:4567 stable140823 15:29:59 [Warning] WSREP: no nodes coming from prim view, prim not possible140823 15:29:59 [Note] WSREP: New COMPONENT: primary = no, bootstrap = no, my_idx = 2, memb_num = 3140823 15:29:59 [Note] WSREP: Flow-control interval: [28, 28]140823 15:29:59 [Note] WSREP: Received NON-PRIMARY.140823 15:29:59 [Note] WSREP: New cluster view: global state: 4b83bbe6-28bb-11e4-a885-4fc539d5eb6a:11, view# -1: non-Primary, number of nodes: 3, my index: 2, protocol version -1140823 15:29:59 [Note] WSREP: wsrep_notify_cmd is not defined, skipping notification.140823 15:29:59 [Note] WSREP: promote to primary component140823 15:29:59 [Note] WSREP: save pc into disk140823 15:29:59 [Note] WSREP: New COMPONENT: primary = yes, bootstrap = yes, my_idx = 2, memb_num = 3140823 15:29:59 [Note] WSREP: STATE EXCHANGE: Waiting for state UUID.140823 15:29:59 [Note] WSREP: clear restored view(...)140823 15:29:59 [Note] WSREP: Bootstrapped primary 00000000-0000-0000-0000-000000000000 found: 3.140823 15:29:59 [Note] WSREP: Quorum results:version = 3,component = PRIMARY,conf_id = -1,members = 3/3 (joined/total),act_id = 11,last_appl. = -1,protocols = 0/6/2 (gcs/repl/appl),group UUID = 4b83bbe6-28bb-11e4-a885-4fc539d5eb6a140823 15:29:59 [Note] WSREP: Flow-control interval: [28, 28]140823 15:29:59 [Note] WSREP: Restored state OPEN -&gt; JOINED (11)140823 15:29:59 [Note] WSREP: New cluster view: global state: 4b83bbe6-28bb-11e4-a885-4fc539d5eb6a:11, view# 0: Primary, number of nodes: 3, my index: 2, protocol version 2140823 15:29:59 [Note] WSREP: wsrep_notify_cmd is not defined, skipping notification.140823 15:29:59 [Note] WSREP: REPL Protocols: 6 (3, 2)140823 15:29:59 [Note] WSREP: Service thread queue flushed.140823 15:29:59 [Note] WSREP: Assign initial position for certification: 11, protocol version: 3140823 15:29:59 [Note] WSREP: Service thread queue flushed.140823 15:29:59 [Note] WSREP: Member 1.0 (percona3) synced with group.140823 15:29:59 [Note] WSREP: Member 2.0 (percona1) synced with group.140823 15:29:59 [Note] WSREP: Shifting JOINED -&gt; SYNCED (TO: 11)140823 15:29:59 [Note] WSREP: Synchronized with group, ready for connections è¿™ä¸ªæ˜¯è¯´PXC 5.6.19ä»¥å, æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªgvwstate.dat æ–‡ä»¶è®°å½•è‡ªå·±æŒ‚ä¹‹å‰çš„æ‰§è¡Œè¿›åº¦, æˆ‘çš„å®éªŒkillä¸€ä¸ªèŠ‚ç‚¹å,è¿™ä¸ªèŠ‚ç‚¹ 12345678910[root@namenode-2 data]# cat gvwstate.dat my_uuid: 4db0c1c2-5fe0-11e8-9709-0be9bc3897c1#vwbegview_id: 3 3561356d-5f11-11e8-bba0-82ddca1badfc 16bootstrap: 0member: 3561356d-5f11-11e8-bba0-82ddca1badfc 0member: 4db0c1c2-5fe0-11e8-9709-0be9bc3897c1 0member: 57b4144b-5f11-11e8-b442-47001a216bae 0member: 6af280fd-5f0f-11e8-9deb-9fe0e283dd49 0#vwend å…¶ä»–æ­£å¸¸èŠ‚ç‚¹ 123456789[root@datanode-1 data]# cat gvwstate.dat my_uuid: 6af280fd-5f0f-11e8-9deb-9fe0e283dd49#vwbegview_id: 3 3561356d-5f11-11e8-bba0-82ddca1badfc 17bootstrap: 0member: 3561356d-5f11-11e8-bba0-82ddca1badfc 0member: 57b4144b-5f11-11e8-b442-47001a216bae 0member: 6af280fd-5f0f-11e8-9deb-9fe0e283dd49 0#vwend æƒ…æ™¯7 Cluster lost itâ€™s primary state due to split brain situation.ä¸ºäº†ä¸¾ä¾‹, æˆ‘ä»¬å‡è®¾ç”±å¶æ•°ä¸ªèŠ‚ç‚¹å½¢æˆ- 6ä¸ª, ABCåœ¨ä¸€ä¸ªæœºæˆ¿, DEFåœ¨å¦ä¸€ä¸ªæœºæˆ¿, ä¸¤ä¸ªæœºæˆ¿ä¹‹é—´çš„ç½‘ç»œä¸­æ–­äº†. å½“ç„¶æœ€å¥½çš„æ–¹æ¡ˆæ˜¯é¿å…è¿™ç§æ‹“æ‰‘ç»“æ„, å¦‚æœæ²¡æœºå™¨äº†å®åœ¨ä¸è¡Œè¿˜å¯ä»¥ç”¨arbitrator (garbd) nodeæˆ–è€…è°ƒæ•´pc.weightå‚æ•°.ä½†æ˜¯ï¼Œå½“åˆ†è£‚å¤§è„‘ä»¥ä»»ä½•æ–¹å¼å‘ç”Ÿæ—¶ï¼Œæ‰€æœ‰åˆ†ç¦»çš„ç»„éƒ½ä¸èƒ½ç»´æŒæ³•å®šäººæ•° - æ‰€æœ‰èŠ‚ç‚¹éƒ½å¿…é¡»åœæ­¢æä¾›è¯·æ±‚ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªéƒ¨åˆ†åªæ˜¯ä¸æ–­å°è¯•é‡æ–°è¿æ¥ã€‚å¦‚æœè¦åœ¨æ¢å¤ç½‘ç»œé“¾æ¥ä¹‹å‰æ¢å¤æœåŠ¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸æ–¹æ¡ˆ5ä¸­ç›¸åŒçš„å‘½ä»¤ä½¿å…¶ä¸­ä¸€ä¸ªç»„å†æ¬¡æˆä¸ºä¸»æœåŠ¡å™¨ï¼š 1SET GLOBAL wsrep_provider_options=&#x27;pc.bootstrap=true&#x27;; After that, you are able to work on the manually restored part of the cluster, and the second half should be able to automatically re-join using incremental state transfer (IST) once the network link is restored. But beware: if you set the bootstrap option on both the separated parts, you will end up with two living cluster instances, with data likely diverging away from each other. Restoring network link in that case wonâ€™t make them to re-join until nodes are restarted and try to re-connect to members specified in configuration file. Then, as Galera replication model truly cares about data consistency â€“ once the inconsistency will be detected, nodes that cannot execute row change statement due to different data â€“ will perform emergency shutdown and the only way to bring them back to the cluster will be via full SST. I hope I covered most of the possible failure scenarios of Galera-based clusters, and made the recovery procedures bit more clear. https://www.percona.com/blog/2014/09/01/galera-replication-how-to-recover-a-pxc-cluster/","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PXC","slug":"PXC","permalink":"http://fuxkdb.com/tags/PXC/"}]},{"title":"å¦‚ä½•åšå¥½MySQLçš„å¤‡ä»½","slug":"å¦‚ä½•åšå¥½MySQLçš„å¤‡ä»½","date":"2018-04-27T16:23:00.000Z","updated":"2018-05-03T08:37:41.000Z","comments":true,"path":"2018/04/28/å¦‚ä½•åšå¥½MySQLçš„å¤‡ä»½/","link":"","permalink":"http://fuxkdb.com/2018/04/28/%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BDMySQL%E7%9A%84%E5%A4%87%E4%BB%BD/","excerpt":"å¦‚ä½•åšå¥½MySQLçš„å¤‡ä»½ç‰©ç†å¤‡ä»½è¿˜æ˜¯é€»è¾‘å¤‡ä»½?å…¶å®ç‰©ç†å¤‡ä»½å’Œé€»è¾‘å¤‡ä»½å¹¶æ²¡æœ‰å¥½åä¹‹åˆ†, å…³é”®æ˜¯è¦é€‚åˆä½ çš„åœºæ™¯. ä¸¤ç§å¤‡ä»½æ–¹å¼çš„å¤‡ä»½å·¥å…·æœ‰: é€»è¾‘å¤‡ä»½å·¥å…·: [mysqldump, mysqlpump, mydumper, select into out file] ç‰©ç†å¤‡ä»½å·¥å…·: [xtrabackup, TokuBackup, Tokudb-xtrabackup] ä¸¤ç§å¤‡ä»½æ–¹å¼çš„å¯¹æ¯”å¦‚ä¸‹ å¤‡ä»½é€Ÿåº¦ ç‰©ç†å¤‡ä»½æ¯”é€»è¾‘å¤‡ä»½å¿«å—? ä¸è¦æƒ³å½“ç„¶, è‡³å°‘æˆ‘çš„æµ‹è¯•ç»“æœå¹¶ä¸æ˜¯è¿™æ · æ¢å¤é€Ÿåº¦ ç‰©ç†å¤‡ä»½æ¢å¤å®é™…å°±æ˜¯mvæ“ä½œ(ä½¿ç”¨xtrabackup,åœ¨å¤‡ä»½æœºåšprepare), è€Œé€»è¾‘å¤‡ä»½åˆ™æ˜¯æ¼«é•¿çš„å¯¼å…¥. åŒæœºå™¨ 1.5Tåº“, é€»è¾‘å¤‡ä»½å¤§å°151G, åšæ¢å¤éœ€è¦27å°æ—¶å·¦å³, è€Œç‰©ç†å¤‡ä»½æ¢å¤åˆ™å®Œå…¨å–å†³äºç£ç›˜iops, ä¸ç”¨æµ‹ä¹ŸçŸ¥é“è¦æ¯”é€»è¾‘å¤‡ä»½å¿«å¾ˆå¤š å¤‡ä»½é›†å¤§å° å®é™…æµ‹è¯•1Tçš„åº“(å¤§éƒ¨åˆ†ä¸ºInnoDBè¡¨), é€»è¾‘å¤‡ä»½é›†å¤§å°ä¸º46G, è€Œç‰©ç†å¤‡ä»½ä¸º255G æ ¹æ®ä»¥ä¸Šä¸‰ç‚¹, å°±å¯ä»¥é€‰æ‹©å¤‡ä»½æ–¹å¼äº†å—? æˆ‘è®¤ä¸ºä¸èƒ½. è¿˜æœ‰ä¸€ç‚¹æ˜¯æ•°æ®åº“æœåŠ¡å™¨å’Œå¤‡ä»½æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œæƒ…å†µ, å’Œä½ æœŸæœ›çš„æ¢å¤æ—¶é—´æ˜¯å¤šä¹…","text":"å¦‚ä½•åšå¥½MySQLçš„å¤‡ä»½ç‰©ç†å¤‡ä»½è¿˜æ˜¯é€»è¾‘å¤‡ä»½?å…¶å®ç‰©ç†å¤‡ä»½å’Œé€»è¾‘å¤‡ä»½å¹¶æ²¡æœ‰å¥½åä¹‹åˆ†, å…³é”®æ˜¯è¦é€‚åˆä½ çš„åœºæ™¯. ä¸¤ç§å¤‡ä»½æ–¹å¼çš„å¤‡ä»½å·¥å…·æœ‰: é€»è¾‘å¤‡ä»½å·¥å…·: [mysqldump, mysqlpump, mydumper, select into out file] ç‰©ç†å¤‡ä»½å·¥å…·: [xtrabackup, TokuBackup, Tokudb-xtrabackup] ä¸¤ç§å¤‡ä»½æ–¹å¼çš„å¯¹æ¯”å¦‚ä¸‹ å¤‡ä»½é€Ÿåº¦ ç‰©ç†å¤‡ä»½æ¯”é€»è¾‘å¤‡ä»½å¿«å—? ä¸è¦æƒ³å½“ç„¶, è‡³å°‘æˆ‘çš„æµ‹è¯•ç»“æœå¹¶ä¸æ˜¯è¿™æ · æ¢å¤é€Ÿåº¦ ç‰©ç†å¤‡ä»½æ¢å¤å®é™…å°±æ˜¯mvæ“ä½œ(ä½¿ç”¨xtrabackup,åœ¨å¤‡ä»½æœºåšprepare), è€Œé€»è¾‘å¤‡ä»½åˆ™æ˜¯æ¼«é•¿çš„å¯¼å…¥. åŒæœºå™¨ 1.5Tåº“, é€»è¾‘å¤‡ä»½å¤§å°151G, åšæ¢å¤éœ€è¦27å°æ—¶å·¦å³, è€Œç‰©ç†å¤‡ä»½æ¢å¤åˆ™å®Œå…¨å–å†³äºç£ç›˜iops, ä¸ç”¨æµ‹ä¹ŸçŸ¥é“è¦æ¯”é€»è¾‘å¤‡ä»½å¿«å¾ˆå¤š å¤‡ä»½é›†å¤§å° å®é™…æµ‹è¯•1Tçš„åº“(å¤§éƒ¨åˆ†ä¸ºInnoDBè¡¨), é€»è¾‘å¤‡ä»½é›†å¤§å°ä¸º46G, è€Œç‰©ç†å¤‡ä»½ä¸º255G æ ¹æ®ä»¥ä¸Šä¸‰ç‚¹, å°±å¯ä»¥é€‰æ‹©å¤‡ä»½æ–¹å¼äº†å—? æˆ‘è®¤ä¸ºä¸èƒ½. è¿˜æœ‰ä¸€ç‚¹æ˜¯æ•°æ®åº“æœåŠ¡å™¨å’Œå¤‡ä»½æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œæƒ…å†µ, å’Œä½ æœŸæœ›çš„æ¢å¤æ—¶é—´æ˜¯å¤šä¹… é€‰æ‹©ä»€ä¹ˆæ ·çš„å¤‡ä»½å–å†³äºä½ æœŸæœ›çš„MTTRå€¼å’Œä½ çš„æ•°æ®åº“ä½“ç§¯ä»¥ç›®å‰æˆ‘ç®¡ç†çš„æ•°æ®åº“ä¸ºä¾‹, æœ‰ä¸‰å°å¤‡ä»½æœåŠ¡å™¨ç”¨äºå­˜å‚¨å¤‡ä»½, æˆ‘ä»¬çš„åº“éƒ½æ˜¯å»ºåœ¨ECSä¸Š, å„ç§äº‘éƒ½æœ‰.å¦‚æœæ•°æ®åº“æœåŠ¡å™¨å’Œå¤‡æœåŠ¡å™¨å¯ä»¥é€šè¿‡å†…ç½‘æ¥ä¼ è¾“å¤‡ä»½, é‚£ä¹ˆå¤§æ¦‚100å¤šGçš„å¤‡ä»½è¦ä¼ 2å°æ—¶(å¤§æ¦‚100M/s), å¦‚æœä½ çš„åº“å°±æ˜¯è¿™ä¹ˆå¤§, é‚£ä¹ˆæ— è®ºä½ é€‰æ‹©å“ªç§æ–¹å¼å¤‡ä»½, éƒ½åšä¸åˆ°å¿«é€Ÿæ¢å¤. æ›´åˆ«æå¾ˆå¤šæ•°æ®åº“æœåŠ¡å™¨å’Œå¤‡ä»½æœåŠ¡å™¨è¿˜åªèƒ½ç”¨å¤–ç½‘ä¼ è¾“å¤‡ä»½äº† å¦‚æœå¯ä»¥ä¸¥æ ¼æ§åˆ¶æ•°æ®åº“å¤§å°, åŒæ—¶æ®åº“æœåŠ¡å™¨å’Œå¤‡æœåŠ¡å™¨é—´ä½¿ç”¨ä¸‡å…†ç½‘å¡ä¼ è¾“å¤‡ä»½, é‚£ä¹ˆæ— ç–‘, ç‰©ç†å¤‡ä»½æ˜¯æœ€å¥½çš„, å› ä¸ºæ¢å¤å¿« å¦‚æœæ— æ³•æ§åˆ¶æ•°æ®åº“å¤§å°(ä¸è®¨è®ºä¸ºä»€ä¹ˆæ— æ³•æ§åˆ¶), åŒæ—¶æ®åº“æœåŠ¡å™¨å’Œå¤‡æœåŠ¡å™¨é—´ç½‘ç»œåƒåœ¾, é‚£ä¹ˆä»»ä½•ä¸€ç§å¤‡ä»½æ–¹å¼éƒ½æ— æ³•åšåˆ°å¿«é€Ÿæ¢å¤, æ­¤æ—¶ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨å¤‡ä»½é›†è¾ƒå°çš„æ–¹å¼è¿›è¡Œå¤‡ä»½. æ— è®ºé‚£ç§å¤‡ä»½æ–¹å¼, éƒ½ä¸æ˜¯ç”¨æ¥åšæ•…éšœæ¢å¤çš„, å‡ºæ•…éšœäº†è¯·åšåˆ‡æ¢, æå‰åšå¥½é«˜å¯ç”¨, è¿™äº›å¤‡ä»½æ˜¯ç”¨æ¥æ­å»ºä»åº“, æ¢å¤éƒ¨åˆ†æ•°æ® å’Œ åšæ•°æ®çš„æœ€åä¸€é“ä¿éšœç”¨çš„. é€‰æ‹©å¥½äº†å¤‡ä»½æ–¹å¼, å¦‚å’Œç”¨å¥½/é¿å…è¸©å‘?å¼€æºçš„ä¸œè¥¿, æ²¡æœ‰ä»€ä¹ˆæ˜¯100%é è°±çš„, å°±åœ¨åˆšæ‰, Mydumperä½œè€…è¿˜å¤„ç†äº†æˆ‘æçš„ä¸€ä¸ªissue ç°åœ¨ç½‘ä¸Šå¤§éƒ¨åˆ†çš„mydumperæ–‡æ¡£éƒ½æ˜¯é”™çš„, å› ä¸ºå®˜æ–¹READMEå°±æ˜¯é”™çš„, å¹¶ä¸”ä»–ä»¬çœ¼é«˜æ‰‹ä½æ²¡æœ‰å®é™…æµ‹è¯• â€‹ æ— è®ºä½¿ç”¨å“ªç§å¤‡ä»½æ–¹å¼è¯·å…ˆææ‡‚å¤‡ä»½åŸç†, è‡ªå·±å¼€General Logè§‚å¯Ÿåˆ†æ, åŸºæœ¬ä¸Šè¿™æ ·å·²ç»èƒ½ç ”ç©¶ä¸ªå…«ä¹åäº†, ç„¶åå¯ä»¥çœ‹å¤§ç¥çš„æ–‡ç« :mysqldumpä¸innobackupexå¤‡ä»½è¿‡ç¨‹çŸ¥å¤šå°‘ï¼ˆä¸€ï¼‰mysqldumpä¸innobackupexå¤‡ä»½è¿‡ç¨‹çŸ¥å¤šå°‘ï¼ˆäºŒï¼‰mysqldumpä¸innobackupexå¤‡ä»½è¿‡ç¨‹çŸ¥å¤šå°‘ï¼ˆä¸‰ï¼‰mysqldumpä¸innobackupexå¤‡ä»½è¿‡ç¨‹çŸ¥å¤šå°‘ï¼ˆå®Œç»“ç¯‡ï¼‰ é€»è¾‘å¤‡ä»½æ·±å‘! mysqldump ä¸é”éäº‹åŠ¡è¡¨å¦‚æœä½ ä»¬æ•°æ®åº“æœ‰å¾ˆå¤šMyISAMè¡¨, é‚£çœŸçš„æ˜¯ä¸åº”è¯¥å•Š, å·²ç»æ˜¯è¢«æ—¶ä»£æŠ›å¼ƒçš„å¼•æ“äº†mysqldumpåœ¨å¤‡ä»½MyISAMè¡¨æ—¶, æ˜¯ä¸é”DMLçš„ ,ä¹Ÿå°±æ˜¯è¯´å¦‚æœå¤‡ä»½æœŸé—´å¯¹MyISAMè¡¨æœ‰DMLæ“ä½œçš„è¯, é‚£ä¹ˆæ•´ä¸ªå¤‡ä»½é›†æ˜¯ä¸èƒ½ä¿è¯ä¸€è‡´æ€§çš„, è¯¦è§mysqldumpä¸mysqldumpä¸innobackupexå¤‡ä»½è¿‡ç¨‹çŸ¥å¤šå°‘ï¼ˆä¸‰ï¼‰ä¸­çš„å‘ä¸€ å¤‡ä»½æœŸé—´å½“å¿ƒDDLè¿™ä¸ªå‘ä½¿ç”¨å®˜æ–¹å‘å‹ç‰ˆæœ¬çš„MySQLæ•°æ®åº“æ—¶, æ— è®ºä½¿ç”¨xtrabackupè¿˜æ˜¯mysqldumpè¿˜æ˜¯mydumperéƒ½æœ‰å¯èƒ½å‘ç”Ÿå…·ä½“å°±æ˜¯ä½¿ç”¨START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */;è¯­å¥æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ä¹‹åï¼Œè¯¥äº‹åŠ¡æ‰§è¡Œselectä¹‹å‰ï¼Œè¯¥è¡¨è¢«å…¶ä»–ä¼šè¯æ‰§è¡Œäº†DDLä¹‹åæ— æ³•æŸ¥è¯¢æ•°æ® è¯¦è§mysqldumpä¸mysqldumpä¸innobackupexå¤‡ä»½è¿‡ç¨‹çŸ¥å¤šå°‘ï¼ˆä¸‰ï¼‰ä¸­çš„å‘äºŒ Aä¼šè¯ 123456789101112root@localhost 10:52: [test1]&gt; show create table fan;+-------+------------------------------------------------------------------------------------------+| Table | Create Table |+-------+------------------------------------------------------------------------------------------+| fan | CREATE TABLE `fan` ( `id` int(11) DEFAULT NULL) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |+-------+------------------------------------------------------------------------------------------+1 row in set (0.00 sec)root@localhost 10:52: [test1]&gt; START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */;Query OK, 0 rows affected (0.00 sec) Bä¼šè¯ æ‰§è¡ŒDDLè¯­å¥å¢åŠ ä¸€åˆ— 123root@localhost 10:53: [test1]&gt; alter table fan add col1 varchar(10);Query OK, 0 rows affected (0.34 sec)Records: 0 Duplicates: 0 Warnings: 0 Aä¼šè¯å†å»æŸ¥è¯¢æ•°æ®, æŠ¥é”™ 12root@localhost 10:52: [test1]&gt; select * from fan;ERROR 1412 (HY000): Table definition has changed, please retry transaction Xtrabackupä¼šæŠ›å‡ºå¼‚å¸¸æ—¥å¿— 1[FATAL] InnoDB: An optimized(without redo logging) DDLoperation has been performed. All modified pages may not have been flushed to the disk yet. è€Œmysqldumpå’Œmydumperè²Œä¼¼ä¸ä¼š? å¿˜äº†. æ€»ä¹‹, è¿™ä¼šå¯¼è‡´å¤‡ä»½ä¸å®Œæ•´. Perconaç‰ˆæœ¬é€šè¿‡LOCK TABLES FOR BACKUPè§£å†³äº†è¿™ä¸ªé—®é¢˜ LOCK TABLES FOR BACKUPä½¿ç”¨æ–°çš„MDLé”ç±»å‹æ¥é˜»æ­¢æ›´æ–°éäº‹åŠ¡è¡¨å’Œæ‰€æœ‰è¡¨çš„å’ŒDDLè¯­å¥. æ›´å…·ä½“åœ°è¯´ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ´»åŠ¨çš„LOCK TABLES FOR BACKUPé”ï¼Œæ‰€æœ‰DDLè¯­å¥ä»¥åŠå¯¹MyISAMï¼ŒCSVï¼ŒMEMORYå’ŒARCHIVEè¡¨çš„æ‰€æœ‰æ›´æ–°å°†è¢«é˜»æ­¢,å¹¶åœ¨PERFORMANCE_SCHEMAæˆ–PROCESSLISTä»¥Waiting for backup lockçš„çŠ¶æ€æ˜¾ç¤º. é’ˆå¯¹æ‰€æœ‰è¡¨çš„SELECTæŸ¥è¯¢å’Œé’ˆå¯¹InnoDBï¼ŒBlackholeå’ŒFederatedè¡¨çš„INSERT / REPLACE / UPDATE / DELETEä¸å—LOCK TABLES FOR BACKUPçš„å½±å“ã€‚Blackholeè¡¨æ˜¾ç„¶ä¸å¤‡ä»½æ— å…³ï¼Œå¹¶ä¸”Federatedè¡¨è¢«é€»è¾‘å’Œç‰©ç†å¤‡ä»½å·¥å…·å¿½ç•¥ ä½¿ç”¨Perconaç‰ˆæœ¬æ—¶ mysqldumpå¢åŠ äº†--lock-for-backupé€‰é¡¹, è€Œmydumperä¼šè‡ªåŠ¨æŸ¥çœ‹have_backup_lockså‚æ•°æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨LOCK TABLES FOR BACKUPé” 1234567891011121314151617181920if (!no_locks) &#123; // Percona Backup Locks if(!no_backup_locks)&#123; mysql_query(conn,&quot;SELECT @@have_backup_locks&quot;); MYSQL_RES *rest = mysql_store_result(conn); if(rest != NULL &amp;&amp; mysql_num_rows(rest))&#123; mysql_free_result(rest); g_message(&quot;Using Percona Backup Locks&quot;); have_backup_locks=1; &#125; &#125; if(have_backup_locks)&#123; if(mysql_query(conn, &quot;LOCK TABLES FOR BACKUP&quot;)) &#123; g_critical(&quot;Couldn&#x27;t acquire LOCK TABLES FOR BACKUP, snapshots will not be consistent: %s&quot;,mysql_error(conn)); errors++; &#125; if(mysql_query(conn, &quot;LOCK BINLOG FOR BACKUP&quot;)) &#123; g_critical(&quot;Couldn&#x27;t acquire LOCK BINLOG FOR BACKUP, snapshots will not be consistent: %s&quot;,mysql_error(conn)); errors++; &#125; å½“å¿ƒtimestampç±»å‹å­—æ®µå…·ä½“è§mysqldumpå¯¼å‡ºæ³¨æ„timestampç±»å‹ â€‹ SELECT INTO OUT FILEè¿™è´§æœ‰ä»€ä¹ˆç”¨?ä¸€ä¸ªDELETEæ²¡æœ‰å†™whereæ¡ä»¶çš„é…¸çˆ½ä½ å¯æ›¾ä½“ä¼š?ä½ è¯´, æˆ‘æœ‰binlog2sqlå¤§æ³•æˆ‘è¯´, å˜»å˜», æˆ‘ä»¬è¿˜åœ¨ç”¨Statementæ ¼å¼æ‚²å‰§çš„æˆ‘, è¿˜æœ‰ä¸€æ ¹ç¨»è‰, é‚£å°±æ˜¯SELECT INTO OUT FILEå¤§æ³•å‡è®¾ä½ è¦æ‰§è¡Œä¸‹é¢è¿™æ›´æ–° 1update important_db.important_table set col1=&#x27;abc&#x27; where id&lt;1000 é‚£å¯å¾—å…ˆ 1select id,col1 from important_db.important_table where id&lt;1000 into outfile &#x27;/tmp/fan.sql&#x27;; çœŸçš„å‡ºäº†é—®é¢˜, å¯ä»¥è¿™æ ·æ¢å¤ 12cat fan.sql | awk &#x27;&#123;print &quot;update important_db.important_table set col1=&quot;$2,&quot; where id=&quot;$1&quot;;&quot;&#125;&#x27; &gt; roll_back.sqlmysql important_db important_tableoll_back.sql TokuDBå¼•æ“è¡¨å’‹å¤‡ä»½?é€»è¾‘å¤‡ä»½mydumper,mysqldumpéƒ½å¯ä»¥, åè€…æ— æ³•ä¿è¯éäº‹åŠ¡è¡¨ä¸€è‡´æ€§ç‰©ç†å¤‡ä»½, Xtrabackupä¸æ”¯æŒ, TokuBackupæ²¡è¯•è¿‡, å¯ä»¥ä½¿ç”¨Tokudb-xtrabackupTokudb-xtrabackupå®‰è£…ä¸è¿‡ä½¿ç”¨Tokudb-xtrabackupå¤‡ä»½, åŸºæœ¬æ˜¯ä½ çš„Tokudbè¡¨å¤šå¤§,å¤‡ä»½å°±æ˜¯å¤šå¤§äº†, ä½ æœ‰1Tçš„ tokudbè¡¨, ç‰©ç†å¤‡å‡ºæ¥åŸºæœ¬å°±æ˜¯1Täº†â€¦. æ‰€ä»¥è¿˜æ˜¯é€»è¾‘å¤‡ä»½å§, èµ·ç å¤‡ä»½é›†å° é‡ä¸­ä¹‹é‡, binlogå¤‡ä»½ä¼—æ‰€å‘¨çŸ¥,Binlogä¸­è®°å½•äº†æ•°æ®åº“çš„æ‰€æœ‰å˜åŒ–, é€šè¿‡å¤‡ä»½ + é‡æ¼”binlog, å¯ä»¥å°†å¤‡ä»½æ¢å¤åˆ°ä»»æ„æ—¶é—´ç‚¹è¿˜åœ¨ç”¨rsyncåŒæ­¥binlogå—? ä½ Outäº†åœ¨5.7ç‰ˆæœ¬, mysqlbinlogå‘½ä»¤å¢åŠ ä¸€ä¸ªæ–°åŠŸèƒ½, å¯ä»¥ä¼ªè£…æˆä»åº“æŒç»­åŒæ­¥ä¸»åº“çš„binlogæ–‡ä»¶è¯¦è§Using mysqlbinlog to Back Up Binary Log Files ç›®å‰çº¿ä¸Šä½¿ç”¨äº†æˆ‘å†™çš„è„šæœ¬åšäº†ä¸€æ¬¡å°è£…Binlog_Server åºŸè¯è¿™ä¹ˆå¤š, å¦‚ä½•ç®¡ç†å¥½ä½ çš„å¤‡ä»½?æ•°æ®åº“ä¼—å¤š, æˆ‘æ¥æ‰‹å‰, å¤‡ä»½é€šè¿‡crontabè°ƒç”¨shellè„šæœ¬å®ç°, å¤‡ä»½å®Œæˆåå†å‘é€åˆ°å¤‡ä»½æœº.è¿™æ ·åšçš„å‡ ç‚¹ä¸è¶³: å¤‡ä»½å¤±è´¥äº†æ²¡å‘Šè­¦, å†å†™ä¸€ä¸ªç›‘æ§è„šæœ¬ç›‘æ§æ—¥å¿—è¾“å‡º? å¤ªLOW äººè„‘çœŸçš„è®°ä¸ä½è¿™ä¹ˆå¤šå¤‡ä»½ä¸å¤‡ä»½æœåŠ¡å™¨çš„mappingå…³ç³», æ¯æ¬¡éƒ½ç™»å½•æœåŠ¡å™¨å»æŸ¥å—? æ•ˆç‡å¤ªä½ ä½ èƒ½è¯´å‡ºæ¯ä¸ªåº“å¤‡ä»½å¤šå¤§å—? å¤‡ä»½ç”¨äº†å¤šä¹…? rsyncç”¨äº†å¤šä¹…? è¿™äº›æŒ‡æ ‡å¼‚å¸¸èƒ½ååº”å‡ºä»€ä¹ˆé—®é¢˜ å¤‡ä»½éœ€è¦å®šæœŸæ ¡éªŒå¯ç”¨æ€§, æ‰‹å·¥æ ¡éªŒè´¹æ—¶è´¹åŠ› åŸºäºä»¥ä¸ŠåŸå› , æˆ‘åšäº†æ”¹è¿›, ç¼–å†™äº†ä¸€ä¸ªå¤‡ä»½å·¥å…·pybackup pybackupæºè‡ªäºå¯¹çº¿ä¸Šå¤‡ä»½è„šæœ¬çš„æ”¹è¿›å’Œå¯¹å¤‡ä»½æƒ…å†µçš„ç›‘æ§éœ€æ±‚.åŸæœ¬ç”Ÿäº§åº“çš„å¤‡ä»½æ˜¯é€šè¿‡shellè„šæœ¬è°ƒç”¨mydumper,ä¹‹åå†å°†å¤‡ä»½é€šè¿‡rsyncä¼ è¾“åˆ°å¤‡ä»½æœº.æƒ³è¦è·å–å¤‡ä»½çŠ¶æ€,æ—¶é—´,rsyncä¼ è¾“æ—¶é—´ç­‰ä¿¡æ¯åªèƒ½é€šè¿‡è§£ææ—¥å¿—.pybackupç”±pythonç¼–å†™,è°ƒç”¨mydumperå’Œrsync,å°†å¤‡ä»½ä¿¡æ¯å­˜å…¥æ•°æ®åº“ä¸­,åæœŸå¯ä»¥é€šè¿‡grafanaå›¾å½¢åŒ–å±•ç¤ºå’Œç›‘æ§å¤‡ä»½pybackup æä¾›äº†validate-backupå‘½ä»¤ ,ç›®å‰æˆ‘å†å¤‡ä»½æœåŠ¡å™¨ä¸Šéƒ½å®‰è£…äº†MySQL, é€šè¿‡å®šæ—¶ä»»åŠ¡, pybackupä¼šä»catalogå…ƒæ•°æ®ä¸­è·å–éœ€è¦è¿›è¡Œæ ¡éªŒçš„å¤‡ä»½è‡ªåŠ¨æ ¡éªŒå¤‡ä»½ å¤‡ä»½ä¿¡æ¯ä¸€è§ˆæ— é— 123456789101112131415161718192021222324252627root@localhost 23:49: [catalogdb]&gt; select * from user_backup where tag=&#x27;BI_Dota_2&#x27; order by id desc limit 1\\G*************************** 1. row *************************** id: 2151 bk_id: b591ccc4-4a16-11e8-953f-005056b106c0 bk_server: xx.xx.xx.xx start_time: 2018-04-27 20:30:03 end_time: 2018-04-27 22:54:50 elapsed_time: 8687 backuped_db: BI,mysql,sys,test,test1 is_complete: Y bk_size: 116G bk_dir: /data3/backup_db/2018-04-27/b591ccc4-4a16-11e8-953f-005056b106c0/ transfer_start: 2018-04-27 22:54:51 transfer_end: 2018-04-27 23:21:27transfer_elapsed: 1596transfer_complete: Y remote_dest: platform@xx.xx.xx.xx/db_backup4/xx.xx.xx.xx/ master_status: mysql-bin.000016,63744177, slave_status: mysql-bin.002559,915074196, tool_version: mydumper 0.9.2, built against MySQL 5.5.53 server_version: 5.7.21-20-logpybackup_version: pybackup 0.10.11.0 bk_command: mydumper --password=supersecrect --user=root --socket=/data/mysqldata/3306/mysql.sock --outputdir=/data3/backup_db/2018-04-27/b591ccc4-4a16-11e8-953f-005056b106c0/ --verbose=3 --compress --threads=6 --triggers --events --routines --use-savepoints --regex=&quot;^(BI\\.|mysql\\.|sys\\.|test\\.|test1\\.)&quot; tag: BI_Dota_2 is_deleted: Nvalidate_status: N/A1 row in set (0.00 sec) å¤‡ä»½åœ¨å“ªä¸€æŸ¥å°±çŸ¥é“ 123456789root@localhost 23:51: [catalogdb]&gt; select * from user_backup_path;+----+-----------------+----------------+--------------------------------------------+--------------------------------+------------+| id | bk_server | remote_server | real_path | tag | is_offline |+----+-----------------+----------------+--------------------------------------------+--------------------------------+------------+| 1 | 120.27.136.24 | 116.3.130.8 | /data1/backup/db_backup/120.27.16.247/ | å›½å†…å¹³å°ä»1 | N || 2 | 101.37.164.13 | 116.3.130.8 | /data2/backup/db_backup/101.37.14.13/ | å›½å†…å¹³å°ä¸»2 | N || 3 | 120.27.139.12 | 116.3.130.8 | /data2/backup/db_backup/120.27.19.126/ | å›½å†…æ—¥å¿—ä¸»1 | N |23 rows in set (0.00 sec) æ¢å¤ç”¨æ—¶, å¿ƒé‡Œæœ‰æ•° 12345678910111213root@localhost 23:52: [catalogdb]&gt; select * from user_recover_info limit 1\\G*************************** 1. row *************************** id: 36 bk_id: 073836be-e8e5-11e7-b163-00163e0007f1 tag: å›½å†…sdkä»1 backup_path: /data2/backup/db_backup/120.55.74.93/2017-12-25/073836be-e8e5-11e7-b163-00163e0007f1/ db: dadian start_time: 2017-12-26 13:59:13 end_time: 2017-12-26 14:20:12elapsed_time: 1258recover_status: sucessvalidate_time: 2017-12-26 16:04:041 row in set (0.00 sec) â€‹ pybackupè¿˜éœ€è¦å®Œå–„, æ¯”å¦‚å¯¹äºå¤‡ä»½æ ¡éªŒçš„æ”¹è¿›, å¹¶ä¸”ç›®å‰ä¹Ÿæ²¡æœ‰åšå¯¹xtrabackupçš„æ”¯æŒ 2018.04.27 æƒ³äº†ä¸‹å¯èƒ½åº”è¯¥æ¢å¤å®Œæˆå, é¦–å…ˆå»åšæºåº“çš„ä»åº“, åŒæ­¥ä¹‹åçœ‹æœ‰æ²¡æœ‰æŠ¥é”™, å†å®Œå–„ç‚¹, åˆ™æ˜¯è¦åšpt-table-checksumæ ¡éªŒ, æœ€è¿‘æ²¡æ—¶é—´, åé¢å†åšå§ æˆ‘ä»¬å¦‚ä½•å¤‡ä»½?å¤§æ‹¿å¦‚ä½•å¤‡ä»½?è¯´äº†è¿™ä¹ˆå¤š, é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨æ˜¯å¦‚ä½•å¤‡ä»½çš„å‘¢? ç›®å‰çº¿ä¸Šç”¨pybackupè°ƒç”¨mydumper, ç›¸æ¯”xtrabackupå¤‡ä»½é›†å°, ç›¸æ¯”mysqldumpä¸€è‡´æ€§æ›´æœ‰ä¿è¯, é€Ÿåº¦æ›´å¿«(mydumperå¯ä»¥å¹¶å‘,mysqldumpåªèƒ½å•çº¿ç¨‹) å‚åŠ è¿‡ä¸€æ¬¡æŠ€æœ¯å¤§ä¼š, å°è±¡ä¸­Facebook æ˜¯ä½¿ç”¨mysqldumpå¤‡ä»½çš„, ä¸ºä»€ä¹ˆ? è¿™é‡Œè¦è¯´é“ä¸€ä¸‹Facebookæœ‰äº”ä¸ªè¶³çƒåœºå¤§çš„æœºæˆ¿?(å¯èƒ½è®°é”™äº†) , æ€»ä¹‹æ•°æ®åº“ä¼—å¤š, ä»–ä»¬æ›´åœ¨æ„å¤‡ä»½é›†å¾—å¤§å°(é«˜å¯ç”¨ç©çš„6, å­˜å‚¨è¦é’±å•Š)Facebook çš„DBAä¸¥æ ¼é™åˆ¶å•ä¸ªæ•°æ®åº“çš„å¤§å°ä¸º200G, è¿™æ ·mysqldumpå¤‡ä»½æ—¶é—´å¿«, åŒæ—¶æ˜“äºç®¡ç†. Facebook DBAæ”¹è¿›äº†å¤‡ä»½æ–¹æ¡ˆ, ä»–ä»¬å¤§è‡´æ˜¯å‘¨ä¸€ä¸€ä¸ªmysqldumpå…¨å¤‡, ä¹‹åæ¯å¤©å¤‡ä»½binlog, å¹¶åˆ†æbinlogå¯¹å…¶è¿›è¡Œåˆå¹¶å‹ç¼©ä¸¾ä¸ªä¾‹å­: å‘¨ä¸€å»ºäº†ä¸€ä¸ªè¡¨t1, å‘¨äºŒåˆ æ‰äº†, æˆ–è€…å‘¨ä¸€insert t2çš„æ•°æ®A, å‘¨äºŒåˆdeleteæ‰äº† é‚£ä¹ˆå¯¹äºæ¢å¤åˆ°å‘¨äºŒçš„éœ€æ±‚, å°±å¯ä»¥å°†binlogæ—¥å¿—å°±åˆå¹¶, çœç•¥æ‰t1è¡¨ç›¸å…³çš„æ‰€æœ‰è¯­å¥, å’Œå¯¹t2 insert delete Aè®°å½•çš„æ—¥å¿—, é€šè¿‡å¤„ç†çš„æ—¥å¿—, åœ¨å¤‡ä»½ä¸Šåº”ç”¨, ç›´æ¥é€šè¿‡ç¨‹åºæ„é€ ä¸€ä»½å‘¨äºŒçš„å¤‡ä»½æˆ‘åªèƒ½è¯´, ç‰›æ‰¹!ğŸ‚ğŸ‚ğŸ‚ å¦‚æœå¯¹æ­¤æ–‡ç« æœ‰ä½•ç–‘é—®æˆ–æ”¹è¿›å»ºè®®, æ¬¢è¿äº¤æµ","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"Load dataå¥‡æ€ªçš„é—®é¢˜","slug":"Load-dataå¥‡æ€ªçš„é—®é¢˜","date":"2018-03-03T07:26:00.000Z","updated":"2018-05-03T08:38:16.000Z","comments":true,"path":"2018/03/03/Load-dataå¥‡æ€ªçš„é—®é¢˜/","link":"","permalink":"http://fuxkdb.com/2018/03/03/Load-data%E5%A5%87%E6%80%AA%E7%9A%84%E9%97%AE%E9%A2%98/","excerpt":"Load dataå¥‡æ€ªçš„é—®é¢˜å…¬å¸ä¸€å¥—æ‰€è°“çš„BIåº“(5.5 innodbå¼•æ“),ç”±äºå¤ªå¤§äº†,è€ƒè™‘è½¬ç”¨TokuDBå¼•æ“,æœ€è¿‘åœ¨æµ‹è¯•,ç›´æ¥åœ¨ä¸€ä¸ªæ–°ç¯å¢ƒå®‰è£…Percona5.7.21,ç„¶åæ¢å¤å¤‡ä»½,è½¬æ¢ä¸ºTokuDBè¡¨, å†åšä»åº“å’ŒåŸ5.5åº“åŒæ­¥(5.5 æ˜¯statementæ ¼å¼)å‡†å¤‡åŒæ­¥ä¸Š,ç„¶åè¿™å¥—ç¯å¢ƒéƒ¨ç½²ä¸€ä¸‹åº”ç”¨,å†å…¨é¢çš„æµ‹ä¸€ä¸‹.ç»“æœå‘ç°åŒæ­¥æŠ¥é”™äº†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960root@localhost 10:42: [test]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: xx.xx.xx.xx Master_User: slave Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.010346 Read_Master_Log_Pos: 715054772 Relay_Log_File: mysql-relay.000010 Relay_Log_Pos: 376792000 Relay_Master_Log_File: mysql-bin.010288 Slave_IO_Running: Yes Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: mysql.%,information_schema.%,performance_schema.%,union_log%.%,test.% Last_Errno: 1300 Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.010288, end_log_pos 378517485. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Skip_Counter: 0 Exec_Master_Log_Pos: 376791811 Relay_Log_Space: 74984691638 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 1300 Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.010288, end_log_pos 378517485. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Replicate_Ignore_Server_Ids: Master_Server_Id: 12 Master_UUID: Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 180402 00:07:09 Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: a3f4b929-31a0-11e8-9714-f8bc123346cc:1-864 Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)","text":"Load dataå¥‡æ€ªçš„é—®é¢˜å…¬å¸ä¸€å¥—æ‰€è°“çš„BIåº“(5.5 innodbå¼•æ“),ç”±äºå¤ªå¤§äº†,è€ƒè™‘è½¬ç”¨TokuDBå¼•æ“,æœ€è¿‘åœ¨æµ‹è¯•,ç›´æ¥åœ¨ä¸€ä¸ªæ–°ç¯å¢ƒå®‰è£…Percona5.7.21,ç„¶åæ¢å¤å¤‡ä»½,è½¬æ¢ä¸ºTokuDBè¡¨, å†åšä»åº“å’ŒåŸ5.5åº“åŒæ­¥(5.5 æ˜¯statementæ ¼å¼)å‡†å¤‡åŒæ­¥ä¸Š,ç„¶åè¿™å¥—ç¯å¢ƒéƒ¨ç½²ä¸€ä¸‹åº”ç”¨,å†å…¨é¢çš„æµ‹ä¸€ä¸‹.ç»“æœå‘ç°åŒæ­¥æŠ¥é”™äº†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960root@localhost 10:42: [test]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: xx.xx.xx.xx Master_User: slave Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.010346 Read_Master_Log_Pos: 715054772 Relay_Log_File: mysql-relay.000010 Relay_Log_Pos: 376792000 Relay_Master_Log_File: mysql-bin.010288 Slave_IO_Running: Yes Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: mysql.%,information_schema.%,performance_schema.%,union_log%.%,test.% Last_Errno: 1300 Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.010288, end_log_pos 378517485. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Skip_Counter: 0 Exec_Master_Log_Pos: 376791811 Relay_Log_Space: 74984691638 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 1300 Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.010288, end_log_pos 378517485. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Replicate_Ignore_Server_Ids: Master_Server_Id: 12 Master_UUID: Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 180402 00:07:09 Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: a3f4b929-31a0-11e8-9714-f8bc123346cc:1-864 Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)æŸ¥çœ‹å‘Šè­¦æ—¥å¿—12342018-04-02T00:06:53.815565+08:00 5 [Note] Multi-threaded slave statistics for channel &#x27;&#x27;: seconds elapsed = 151; events assigned = 7924737; worker queues filled over overrun level = 0; waited due a Worker queue full = 0; waited due the total size = 375; waited at clock conflicts = 0 waited (count) when Workers occupied = 0 waited when Workers occupied = 02018-04-02T00:07:09.876177+08:00 6 [ERROR] Slave SQL for channel &#x27;&#x27;: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.010288, end_log_pos 378517485; Error &#x27;Invalid utf8 character string: &#x27;&#x27;&#x27; on query. Default database: &#x27;BI&#x27;. Query: &#x27;LOAD DATA INFILE &#x27;/data/mysqldata/3306/tmp/SQL_LOAD-a3f4b929-31a0-11e8-9714-f8bc123346cc-11-12025.data&#x27; IGNORE INTO TABLE `520054_all_role` CHARACTER SET utf8 FIELDS TERMINATED BY &#x27;,&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; ESCAPED BY &#x27;&quot;&#x27; LINES TERMINATED BY &#x27;\\n&#x27; (`openid`, `clientid`, `roleid`, `rolename`, `school`, `IP`, `snid`, `rolelogin_time`, `amount`, `val`, `consume_sum`, `own_after`, `first_payment_time`, `last_payment_time`, `last_login_time`, `first_pay_level`, `level`, `vip_level`, `first_pay_amount`, `mission_id`)&#x27;, Error_code: 13002018-04-02T00:07:09.876335+08:00 5 [Warning] Slave SQL for channel &#x27;&#x27;: ... The slave coordinator and worker threads are stopped, possibly leaving data in inconsistent state. A restart should restore consistency automatically, although using non-transactional storage for data or info tables or DDL queries could lead to problems. In such cases you have to examine your data (see documentation for details). Error_code: 17562018-04-02T00:07:09.876385+08:00 5 [Note] Slave SQL thread for channel &#x27;&#x27; exiting, replication stopped in log &#x27;mysql-bin.010288&#x27; at position 376791811æ€»ä¹‹å°±æ˜¯Load data è¿™ä¸ªæ–‡ä»¶/data/mysqldata/3306/tmp/SQL_LOAD-a3f4b929-31a0-11e8-9714-f8bc123346cc-11-12025.dataå‡ºé—®é¢˜äº†å‘— äºæ˜¯æˆ‘æ‰‹åŠ¨æ‰§è¡Œ(è¿™é‡Œæ‹·è´äº†ä¸€ä¸‹æ–‡ä»¶åˆ°/tmp)123#mysql --default-character-set=utf8 --socket=/data/mysqldata/3306/mysql.sock -uroot -p&quot;&quot; --show-warnings test -e &quot;LOAD DATA local INFILE &#x27;/tmp/SQL_LOAD-a3f4b929-31a0-11e8-9714-f8bc123346cc-11-12025.data&#x27; IGNORE INTO TABLE 520054_all_role CHARACTER SET utf8 FIELDS TERMINATED BY &#x27;,&#x27; OPTIONALLY ENCLOSED BY &#x27;\\&quot;&#x27; ESCAPED BY &#x27;\\&quot;&#x27; LINES TERMINATED BY &#x27;\\n&#x27; (openid, clientid, roleid, rolename, school, IP, snid, rolelogin_time, amount, val, consume_sum, own_after, first_payment_time, last_payment_time, last_login_time, first_pay_level, level, vip_level, first_pay_amount, mission_id)&quot;mysql: [Warning] Using a password on the command line interface can be insecure.ERROR 1300 (HY000) at line 1: Invalid utf8 character string: &#x27;&#x27;æŠ¥é”™çœ‹æ–‡ä»¶ä¹Ÿæ²¡çœ‹å‡ºå•¥, æˆ‘å°±å¥½å¥‡äº†, æ€ä¹ˆåœ¨5.5ä¸»åº“æ²¡é—®é¢˜,åœ¨è¿™å°±æœ‰é—®é¢˜å‘¢, äºæ˜¯æˆ‘æŠŠæ–‡ä»¶scpåˆ°ä¸»åº“, åœ¨teståº“å»ºåŒä¸€ä¸ªè¡¨,ç»§ç»­æ‰‹åŠ¨Load data, æ²¡æŠ¥é”™ å¯¼å…¥æˆåŠŸäº†.. ä¸€å¼€å§‹æˆ‘æ€€ç–‘æ˜¯SQL_MODE ,æŸ¥äº†ä¸‹ä¸¤è¾¹éƒ½æ˜¯SQL_MODE=&#39;&#39; (æˆ‘å°±ä¸è´´å‡ºæ¥è¯æ˜äº†)æˆ‘åˆæ€€ç–‘å­—ç¬¦é›†é—®é¢˜, æŸ¥äº†ä¸‹ä¸¤è¾¹ä¹Ÿéƒ½ä¸€æ ·.. è¿™ä¸‹å°´å°¬äº†, æˆ‘æ¯”è¾ƒlow,æ²¡æƒ³åˆ°å•¥å¥½æ–¹æ³•, åªèƒ½äººè‚‰æŠ˜åŠæŸ¥æ‰¾æ³•, æŠŠè¿™ä¸ªæ–‡ä»¶/data/mysqldata/3306/tmp/SQL_LOAD-a3f4b929-31a0-11e8-9714-f8bc123346cc-11-12025.data å…ˆåˆ ä¸€åŠ,LOADçœ‹æŠ¥é”™ä¸, æŠ¥é”™è¯´æ˜æœ‰é—®é¢˜çš„æ•°æ®å°±åœ¨è¿™åŠéƒ¨åˆ†,æ²¡æŠ¥é”™è¯´æ˜åœ¨åˆ é™¤çš„é‚£åŠéƒ¨åˆ†, å¦‚æ­¤å¾€å¤,æœ€åç»ˆäºæ‰¾åˆ°äº†,è¯·çœ‹!12#less /tmp/SQL_LOAD-a3f4b929-31a0-11e8-9714-f8bc123346cc-11-12025.data.final 2001_74148261,1000032,3JM30C2EN,&lt;U+1F602&gt;&lt;U+1F602&gt;&lt;U+1F602&gt;,,124.152.204.12,2001.0,1510191299.0,,,29216.0,58.0,,,1520993335.0,,0.0,0.0,,å°±è¿™ä¸€è¡Œ,5.5èƒ½å¯¼è¿›å»,5.7ä¸è¡Œä½ ä»¬çŒœ&lt;U+1F602&gt;æ˜¯å•¥? æ˜¯è¿™ä¸ªè¡¨æƒ…ğŸ˜‚ğŸ˜‚ğŸ˜‚,å§äº†ä¸ªæ§½ çœ‹ä¸‹å»ºæ ‡è¯­å¥123456789101112131415161718192021222324252627282930root@localhost 10:42: [test]&gt; show create table 520054_all_role\\G*************************** 1. row *************************** Table: 520054_all_roleCreate Table: CREATE TABLE `520054_all_role` ( `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT, `openid` varchar(100) NOT NULL COMMENT &#x27;ç”¨æˆ·å¹³å°è´¦å·&#x27;, `clientid` int(11) NOT NULL COMMENT &#x27;åŒºæœID&#x27;, `roleid` varchar(64) NOT NULL COMMENT &#x27;ç”¨æˆ·åŒºæœå”¯ä¸€è´¦å·&#x27;, `rolename` varchar(100) DEFAULT NULL, `school` varchar(64) DEFAULT NULL COMMENT &#x27;è§’è‰²é—¨æ´¾&#x27;, `IP` varchar(64) DEFAULT NULL, `snid` int(11) NOT NULL COMMENT &#x27;å¹³å°ID&#x27;, `rolelogin_time` int(11) NOT NULL COMMENT &#x27;å»ºè§’æ—¶é—´&#x27;, `amount` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;é‡‘é¢&#x27;, `val` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;è´­ä¹°çš„æ¸¸æˆå¸(å…ƒå® ã€é’»çŸ³)æ•°é‡&#x27;, `consume_sum` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ¶ˆè€—é’»çŸ³æ•°&#x27;, `own_after` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ¶ˆè€—åå‰©ä½™é’»çŸ³æ•°&#x27;, `first_payment_time` int(11) DEFAULT NULL COMMENT &#x27;æœ€åˆæ”¯ä»˜æ—¶é—´æˆ³&#x27;, `last_payment_time` int(11) DEFAULT NULL COMMENT &#x27;æœ€åæ”¯ä»˜æ—¶é—´æˆ³&#x27;, `last_login_time` int(11) DEFAULT NULL COMMENT &#x27;æœ€åæ´»è·ƒæ—¶é—´æˆ³&#x27;, `first_pay_level` smallint(6) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;é¦–æ¬¡ä»˜è´¹ç­‰çº§&#x27;, `level` smallint(6) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å½“å‰ç­‰çº§&#x27;, `vip_level` smallint(6) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å½“å‰vipç­‰çº§&#x27;, `first_pay_amount` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æœ€åˆä»˜è´¹é‡‘é¢&#x27;, `mission_id` varchar(50) DEFAULT NULL COMMENT &#x27;æœ€é«˜å…³å¡ID&#x27;, PRIMARY KEY (`id`), UNIQUE KEY `openid_clientid` (`openid`,`clientid`), KEY `amount_snid` (`amount`,`snid`)) ENGINE=InnoDB AUTO_INCREMENT=32227 DEFAULT CHARSET=utf8 COMMENT=&#x27;æ‰€æœ‰è§’è‰²è¡¨&#x27;1 row in set (0.00 sec)DEFAULT CHARSET=utf8 5.5èƒ½æŠŠè¿™ä¸ªemojiè¡¨æƒ…å¯¼è¿›å»(æ•°æ®æœ‰æ²¡æœ‰é—®é¢˜å¦è¯´),5.7ä¸è¡Œ æœ€åæˆ‘å†5.7æŠŠè¿™ä¸ªè¡¨å»ºæˆutf8mb4,ç„¶åé‡æ–°å¯¼å…¥12#mysql --default-character-set=utf8mb4 --socket=/data/mysqldata/3306/mysql.sock -uroot -p&quot;&quot; --show-warnings fan -e &quot;LOAD DATA local INFILE &#x27;/tmp/SQL_LOAD-a3f4b929-31a0-11e8-9714-f8bc123346cc-11-12025.data&#x27; IGNORE INTO TABLE 520054_all_role CHARACTER SET utf8mb4 FIELDS TERMINATED BY &#x27;,&#x27; OPTIONALLY ENCLOSED BY &#x27;\\&quot;&#x27; ESCAPED BY &#x27;\\&quot;&#x27; LINES TERMINATED BY &#x27;\\n&#x27; (openid, clientid, roleid, rolename, school, IP, snid, rolelogin_time, amount, val, consume_sum, own_after, first_payment_time, last_payment_time, last_login_time, first_pay_level, level, vip_level, first_pay_amount, mission_id)&quot;mysql: [Warning] Using a password on the command line interface can be insecure.ç»ˆäºä¸æŠ¥é”™äº†","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"5.5.xå‡çº§5.7.21æ­¥éª¤","slug":"5.5.xå‡çº§5.7.21æ­¥éª¤","date":"2018-02-11T03:22:00.000Z","updated":"2018-02-11T08:36:59.000Z","comments":true,"path":"2018/02/11/5.5.xå‡çº§5.7.21æ­¥éª¤/","link":"","permalink":"http://fuxkdb.com/2018/02/11/5.5.x%E5%8D%87%E7%BA%A75.7.21%E6%AD%A5%E9%AA%A4/","excerpt":"5.5.xå‡çº§5.7.21æ­¥éª¤ç¯å¢ƒå‡†å¤‡ä¸Šä¼ è½¯ä»¶åŒ…æ ¹æ®å®˜æ–¹æ–‡æ¡£è¯´æ˜ Upgrading to the latest release is recommended before upgrading to the next version å½“å‰ç‰ˆæœ¬5.5.46,éœ€è¦ä¸Šä¼ ä¸‰ä¸ªåŒ… 123mysql-5.5.59-linux-glibc2.12-x86_64.tar.gzmysql-5.6.39-linux-glibc2.12-x86_64.tar.gzmysql-5.7.21-linux-glibc2.12-x86_64.tar.gz åˆ›å»ºç›®å½• 1mkdir /usr/local/&#123;mysql-5.5.59,mysql-5.6.39,mysql-5.7.21&#125; è§£å‹ 123tar -zxvf mysql-5.5.59-linux-glibc2.12-x86_64.tar.gz -C /usr/local/mysql-5.5.59/tar -zxvf mysql-5.6.39-linux-glibc2.12-x86_64.tar.gz -C /usr/local/mysql-5.6.39/tar -zxvf mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz -C /usr/local/mysql-5.7.21/ è®¾ç½®ç¯å¢ƒå˜é‡ 123456789101112zst_ps1()&#123; Date=$(date +%F) Time=$(date +%H:%M:%S) PS1=&quot;\\\\n\\[\\e[1;37m[\\e[m\\]\\[\\e[1;33m\\u\\e[m\\]\\[\\e[1;33m@\\h\\e[m\\]\\[\\e[1;35m $Time \\e[m\\]\\e[1;36m\\w\\e[m\\e[1;37m]\\e[m\\n\\\\$&quot;&#125;PROMPT_COMMAND=zst_ps1export PATH=/usr/local/mysql/bin:$PATHexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/mysql/lib","text":"5.5.xå‡çº§5.7.21æ­¥éª¤ç¯å¢ƒå‡†å¤‡ä¸Šä¼ è½¯ä»¶åŒ…æ ¹æ®å®˜æ–¹æ–‡æ¡£è¯´æ˜ Upgrading to the latest release is recommended before upgrading to the next version å½“å‰ç‰ˆæœ¬5.5.46,éœ€è¦ä¸Šä¼ ä¸‰ä¸ªåŒ… 123mysql-5.5.59-linux-glibc2.12-x86_64.tar.gzmysql-5.6.39-linux-glibc2.12-x86_64.tar.gzmysql-5.7.21-linux-glibc2.12-x86_64.tar.gz åˆ›å»ºç›®å½• 1mkdir /usr/local/&#123;mysql-5.5.59,mysql-5.6.39,mysql-5.7.21&#125; è§£å‹ 123tar -zxvf mysql-5.5.59-linux-glibc2.12-x86_64.tar.gz -C /usr/local/mysql-5.5.59/tar -zxvf mysql-5.6.39-linux-glibc2.12-x86_64.tar.gz -C /usr/local/mysql-5.6.39/tar -zxvf mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz -C /usr/local/mysql-5.7.21/ è®¾ç½®ç¯å¢ƒå˜é‡ 123456789101112zst_ps1()&#123; Date=$(date +%F) Time=$(date +%H:%M:%S) PS1=&quot;\\\\n\\[\\e[1;37m[\\e[m\\]\\[\\e[1;33m\\u\\e[m\\]\\[\\e[1;33m@\\h\\e[m\\]\\[\\e[1;35m $Time \\e[m\\]\\e[1;36m\\w\\e[m\\e[1;37m]\\e[m\\n\\\\$&quot;&#125;PROMPT_COMMAND=zst_ps1export PATH=/usr/local/mysql/bin:$PATHexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/mysql/lib åœå¤åˆ¶,è®°å½•ä½ç½®1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859[root@iZ23pn0u8g5Z tmp]# /data/bin/login_db.sh Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 9500936Server version: 5.5.46-log MySQL Community Server (GPL) by RemiCopyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &#x27;help;&#x27; or &#x27;\\h&#x27; for help. Type &#x27;\\c&#x27; to clear the current input statement.root@localhost 14:53: [dbe8je6i4c3gjd50]&gt; stop slave;Query OK, 0 rows affected (0.03 sec)root@localhost 14:53: [dbe8je6i4c3gjd50]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Master_Host: 10.31.124.23 Master_User: slave Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.007611 Read_Master_Log_Pos: 669126117 Relay_Log_File: mysqld-relay-bin.021406 Relay_Log_Pos: 669125856 Relay_Master_Log_File: mysql-bin.007611 Slave_IO_Running: No Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: mysql.%,information_schema.%,performance_schema.%,union_log%.%,test.% Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 669125710 Relay_Log_Space: 669124929 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 321 row in set (0.00 sec) å…³åº“12[root@iZ23pn0u8g5Z tmp]# /usr/bin/mysql --default-character-set=utf8 --socket=/data/mysql/mysql.sock -uroot -p&quot;password&quot; -e&quot;set global innodb_fast_shutdown=0&quot;[root@iZ23pn0u8g5Z tmp]# /data/bin/stop_db.sh åˆ›å»ºè½¯è¿æ¥123ln -s /usr/local/mysql-5.5.59/mysql-5.5.59-linux-glibc2.12-x86_64/ /usr/local/mysqlchown mysql:mysql -R /usr/local/mysql-5.5.59/chown mysql:mysql -R /usr/local/mysql my.cnfæ·»åŠ skip_slave_start,sql_mode=â€â€å¦åˆ™å¯åŠ¨æ•°æ®åº“åä¼šè‡ªåŠ¨å¼€å§‹åŒæ­¥ sql_mode=â€â€æ˜¯ä¸ºäº†é¿å…ä¸‹ä¸€æ­¥å‡ºç° 123456789101112131415161718192021222324252627dbe8je6i4c3gjd50.adminerror : Table rebuild required. Please do &quot;ALTER TABLE `admin` FORCE&quot; or dump/reload to fix it! CREATE TABLE `admin` ( `userid` int(11) NOT NULL DEFAULT &#x27;0&#x27;, `username` varchar(200) NOT NULL COMMENT &#x27;ç®¡ç†å‘˜ç”¨æˆ·å&#x27;, `password` varchar(32) NOT NULL COMMENT &#x27;å¯†ç &#x27;, `realname` varchar(200) NOT NULL COMMENT &#x27;ç®¡ç†å‘˜å§“å&#x27;, `createtime` datetime NOT NULL DEFAULT &#x27;0000-00-00 00:00:00&#x27; COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;, `status` tinyint(1) NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;çŠ¶æ€ 0 å°ç¦ 1æ­£å¸¸&#x27;, `myprivate` text NOT NULL COMMENT &#x27;æƒé™&#x27;, `mygame` text NOT NULL COMMENT &#x27;æ¸¸æˆæƒé™&#x27;, `myunion` text NOT NULL COMMENT &#x27;æ¨å¹¿æŸ¥çœ‹æƒé™&#x27;, `department_id` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;éƒ¨é—¨id&#x27;, `job_number` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;å‘¼å«ä¸­å¿ƒçš„å·¥å·&#x27;, `yesorno` varchar(200) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦æœ‰xxxæƒé™&#x27;, `myrows` text NOT NULL COMMENT &#x27;åˆ—æƒé™&#x27;, `email` varchar(200) NOT NULL COMMENT &#x27;é‚®ç®±&#x27;, `bkemail` varchar(200) NOT NULL COMMENT &#x27;å¤‡ç”¨é‚®ç®±&#x27;, `leaderid` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;ä¸Šçº§ID&#x27;, `myaccount` text NOT NULL COMMENT &#x27;è´¦å·æƒé™&#x27;, `img` varchar(1000) DEFAULT NULL COMMENT &#x27;å¤´åƒ&#x27;, `nickname` varchar(200) DEFAULT NULL COMMENT &#x27;æ˜µç§°&#x27;, KEY `username` (`username`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&#x27;ç®¡ç†å‘˜è¡¨&#x27;è¿™æ˜¯ç”±äºcreatetimeåˆ—defaultå€¼ä¸º&#x27;0000-00-00 00:00:00&#x27; è¿åäº†é»˜è®¤çš„sql_mode å¯åŠ¨æ•°æ®åº“,æ‰§è¡Œmysql_upgrade123456789101112131415161718192021222324252627282930313233343536373839404142434445464748source ~/.bash_profile/data/bin/start_db.sh mysql_upgrade --socket=/data/mysql/mysql.sock -uroot -p&quot;password&quot;mysql_upgrade: [Warning] Using a password on the command line interface can be insecure.Checking if update is needed.Checking server version.Running queries to upgrade MySQL server.Checking system database.mysql.columns_priv OKmysql.db OKmysql.engine_cost OKmysql.event OKmysql.func OKmysql.general_log OKmysql.gtid_executed OKmysql.help_category OKmysql.help_keyword OKmysql.help_relation OKmysql.help_topic OKmysql.host OKmysql.innodb_index_stats OKmysql.innodb_table_stats OKmysql.ndb_binlog_index OKmysql.plugin OKmysql.proc OKmysql.procs_priv OKmysql.proxies_priv OKmysql.server_cost OKmysql.servers OKmysql.slave_master_info OKmysql.slave_relay_log_info OKmysql.slave_worker_info OKmysql.slow_log OKmysql.tables_priv OKmysql.time_zone OKmysql.time_zone_leap_second OKmysql.time_zone_name OKmysql.time_zone_transition OKmysql.time_zone_transition_type OKmysql.user OKUpgrading the sys schema.Checking databases.dbe8je6i4c3gjd50.adlist OKdbe8je6i4c3gjd50.adlist_bk OKdbe8je6i4c3gjd50.adminerror : Table rebuild required. Please do &quot;ALTER TABLE `admin` FORCE&quot; or dump/reload to fix it!å‡çº§æ—¶ç•™æ„æœ‰æ²¡æœ‰error å…³é—­æ•°æ®åº“12345mysql --default-character-set=utf8 --socket=/data/mysql/mysql.sock -uroot -p&quot;password&quot; -e&quot;set global innodb_fast_shutdown=0&quot;/data/bin/stop_db.sh åˆ é™¤è½¯è¿æ¥rm /usr/local/mysql é‡å¤ä¹‹å‰çš„æ­¥éª¤ç»§ç»­å‡çº§5.6.39å‡çº§åª5.7.21ä¿®æ”¹é…ç½®æ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175[client]user=rootpassword=socket=/data/mysql/mysql.sock[mysqld]########basic settings########server-id = 853306port = 3306autocommit = 1transaction_isolation = REPEATABLE-READcharacter_set_server=utf8skip_name_resolve = 1secure_file_priv=/var/lib/mysql-files/#è¿æ¥max_connections = 800max_connect_errors = 1000back_log=512socket=/data/mysql/mysql.sockpid-file=/data/run/mysqld.pidbasedir=/usr/local/mysqldatadir = /data/mysqltmpdir = /data/tmpdirexplicit_defaults_for_timestamp = 1#memthread_stack = 512Kthread_cache_size = 1024table_open_cache = 1024table_definition_cache = 1024join_buffer_size = 134217728tmp_table_size = 67108864read_buffer_size = 16777216read_rnd_buffer_size = 33554432sort_buffer_size = 33554432tmp_table_size = 32Mmax_heap_table_size = 32M#bulk_insert_buffer_size = 64M é»˜è®¤8M#myisam_sort_buffer_size = 128M é»˜è®¤8Mmax_prepared_stmt_count=50000query_cache_size = 0query_cache_type = 0query_cache_limit =0max_allowed_packet = 128M#sql_mode = &quot;STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER&quot;#é»˜è®¤å°±æ˜¯ONLY_FULL_GROUP_BY STRICT_TRANS_TABLES NO_ZERO_IN_DATE NO_ZERO_DATE ERROR_FOR_DIVISION_BY_ZERO NO_AUTO_CREATE_USER NO_ENGINE_SUBSTITUTIONsql_mode=&quot;&quot;interactive_timeout = 1800wait_timeout = 1800#optimizer_switch=&quot;index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on&quot;auto_increment_offset = 1auto_increment_increment = 2########log settings########log_output=FILElog_error = /data/mysql/error.logslow_query_log = 1slow_query_log_file = /data/mysql/slow-queries.loglog_queries_not_using_indexes = 1log_slow_admin_statements = 1log_slow_slave_statements = 1log_throttle_queries_not_using_indexes = 10long_query_time = 0.8min_examined_row_limit = 100general_log=0general_log_file=/data/mysql/general_query.logexpire_logs_days=7########replication settings########master_info_repository = TABLErelay_log_info_repository = TABLElog_bin = mysql-binsync_binlog = 10innodb_flush_log_at_trx_commit = 2#gtid_mode = on#enforce_gtid_consistency = 1log_slave_updates=1binlog_format = row relay_log = mysqld-relay-binrelay_log_recovery = 1 #å¯ç”¨è¿™ä¸ªå‚æ•°éœ€è¦repository=TABLE,å®˜æ–¹æ–‡æ¡£æ²¡æœ‰æ˜ç¡®è¦æ±‚,è€å´è¿™ä¹ˆè¯´åº”è¯¥æ˜¯ä¸ºäº†ä¸€è‡´æ€§å§#Enabling the --relay-log-recovery option when relay-log-purge is disabled risks reading the relay log from files that were not purged, leading to data inconsistency.relay_log_purge=1 binlog_gtid_simple_recovery = 1slave_skip_errors = ddl_exist_errorsslave_parallel_type=LOGICAL_CLOCKslave_parallel_workers=8slave_preserve_commit_order = 1skip_slave_start=1#ZST#1M - 2Mbinlog_cache_size = 2M #max_binlog_size #é»˜è®¤1G, å»ºè®®ç”Ÿæˆé—´éš”2åˆ†é’Ÿä»¥ä¸Š æ¨è128M æˆ– 256M è¿™æ ·ç”¨mysqlbinlogè§£ææ›´å¿«äº›log_bin_trust_function_creators=1 #å¼€å¯binlogæ—¶,æ˜¯å¦å…è®¸åˆ›å»ºå­˜å‚¨è¿‡ç¨‹(é™¤éæœ‰superæƒé™,ä¸”æŒ‡å®šdeterministic, reads sql data,no sql)#max_binlog_cache_size #binlogæœ€å¤§çš„cache size,æœ‰å¤§SQLå†™å…¥æ—¶éœ€è¦ç”¨åˆ°,æˆ–è€…å¤§æ•°æ®LOAD DATAæ—¶. é»˜è®¤1Gå§,åŸºæœ¬ä¸ç”¨æ”¹#binlog_stmt_cache_size #å¤§é‡prepare statementæ—¶.åŠ å¤§#binglog_direct_non_transactional_update#relay_log_purge=1 #relay logä½¿ç”¨å®Œå°±åˆ æ‰replicate-wild-ignore-table=mysql.%replicate-wild-ignore-table=information_schema.%replicate-wild-ignore-table=performance_schema.%replicate-wild-ignore-table=union_log%.%replicate-wild-ignore-table=test.%########innodb settings#########innodb_page_size = 8192innodb_buffer_pool_size = 45Ginnodb_buffer_pool_instances = 8innodb_buffer_pool_load_at_startup = 1innodb_buffer_pool_dump_at_shutdown = 1#æ­¤å€¼= innodb_io_capacity/innodb_buffer_pool_instancesinnodb_lru_scan_depth = 1000innodb_lock_wait_timeout = 5# æ ¹æ®æ‚¨çš„æœåŠ¡å™¨IOPSèƒ½åŠ›é€‚å½“è°ƒæ•´# ä¸€èˆ¬é…æ™®é€šSSDç›˜çš„è¯ï¼Œå¯ä»¥è°ƒæ•´åˆ° 10000 - 20000# é…ç½®é«˜ç«¯PCIe SSDå¡çš„è¯ï¼Œåˆ™å¯ä»¥è°ƒæ•´çš„æ›´é«˜ï¼Œæ¯”å¦‚ 50000 - 80000innodb_io_capacity = 1000innodb_io_capacity_max = 2000innodb_flush_method = O_DIRECTinnodb_file_format = Barracudainnodb_file_format_max = Barracudainnodb_log_files_in_group = 3innodb_log_group_home_dir = /data/mysql/innodb_undo_directory = /data/mysql/innodb_undo_logs = 128innodb_undo_tablespaces = 3innodb_flush_neighbors = 1innodb_log_file_size = 1Ginnodb_log_buffer_size = 16777216innodb_purge_threads = 4innodb_large_prefix = 1innodb_thread_concurrency = 128innodb_print_all_deadlocks = 1innodb_strict_mode = 1innodb_sort_buffer_size = 67108864 innodb_write_io_threads = 8innodb_read_io_threads = 8innodb_data_file_path=ibdata1:1024M:autoextend########semi sync replication settings#########plugin_dir=/usr/local/mysql/lib/plugin#plugin_load = &quot;rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so&quot;#loose_rpl_semi_sync_master_enabled = 1#loose_rpl_semi_sync_slave_enabled = 1#loose_rpl_semi_sync_master_timeout = 5000#######performance schema#######performance_schema = 1performance_schema_instrument=&#x27;memory/%=COUNTED&#x27;performance_schema_digests_size = 40000performance_schema_max_table_instances = 40000performance_schema_max_sql_text_length = 4096performance_schema_max_digest_length = 4096#innodb monitorinnodb_monitor_enable=module_innodb,module_dml,module_ddl,module_trx,module_os,module_purge,module_log,module_lock,module_buffer,module_index,module_ibuf_system,module_buffer_page,module_adaptive_hash[mysqld-5.7]innodb_buffer_pool_dump_pct = 40innodb_page_cleaners = 8#innodb_undo_log_truncate = 1#innodb_max_undo_log_size = 2Ginnodb_purge_rseg_truncate_frequency = 128binlog_gtid_simple_recovery=1log_timestamps=system#transaction_write_set_extraction=MURMUR32show_compatibility_56=on[mysql]no-auto-rehashprompt=&quot;\\u@\\h \\R:\\m:\\s [\\d]&gt; &quot; åˆ›å»ºæ–‡ä»¶å¤¹ 12mkdir -p /var/lib/mysql-files/chown mysql:mysql /var/lib/mysql-files åˆ›å»ºè½¯è¿æ¥ 123ln -s /usr/local/mysql-5.7.21/mysql-5.7.21-linux-glibc2.12-x86_64/ /usr/local/mysqlchown mysql:mysql -R /usr/local/mysql-5.7.21/chown mysql:mysql -R /usr/local/mysql mysql_upgrade 1mysql_upgrade -uroot -pmysql -S /data1/mysqldata/3306/mysql.sock 5.7.21ç”±äºä¸€äº›æ•°æ®ç±»å‹å­˜å‚¨èŒƒå¼æœ‰æ”¹å˜æ¯”å¦‚ TIME3 bytes3 bytes + fractional seconds storage DATETIME8 bytes5 bytes + fractional seconds storage TIMESTAMP4 bytes4 bytes + fractional seconds storage éœ€è¦é‡æ–°å»ºæ ‡,æ‰€ä»¥å¯èƒ½ä¼šå¾ˆæ…¢ å¯ä»¥ä½¿ç”¨--upgrade-system-tablesåªå‡çº§æ•°æ®å­—å…¸,æ ¹æ®peconaçš„æ–‡ç« ä¹Ÿä¸å½±å“DMLå’Œå¤åˆ¶ https://www.percona.com/blog/2016/04/27/upgrading-to-mysql-5-7-focusing-on-temporal-types/ éœ€è¦æ³¨æ„çš„å‚æ•°1234567891011121314151617ä¸‹é¢ä¸‰ä¸ªå‚æ•°æ²¡æœ‰äº†table_cachethread_concurrencykey_bufferinnodb_additional_mem_pool_sizeç‹¬ç«‹undoå¿…é¡»æ˜¯MySQL5.6.3å¼•å…¥çš„,éœ€è¦åˆå§‹åŒ–æ•°æ®åº“æ—¶å°±å¯ç”¨,ç”±äºè¿™é‡Œæ˜¯5.5å‡çº§è‡³5.7æ‰€ä»¥ä¹Ÿæ²¡æ³•ç”¨äº†innodb_undo_tablespacesinnodb_undo_directoryinnodb_undo_log_truncateinnodb_max_undo_log_sizeè¿™ä¸ªæ˜¯ç”±äºçº¿ä¸Šä¸»åº“è¿˜æ˜¯åŸºäºpositionçš„,å¦‚æœå¼€äº†å°±æ²¡æ³•å»ºç«‹åŒæ­¥äº†gtid_mode = offenforce_gtid_consistency = 0","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå‡çº§","slug":"MySQLå‡çº§","permalink":"http://fuxkdb.com/tags/MySQL%E5%8D%87%E7%BA%A7/"}]},{"title":"MySQL 5.5.Xå‡çº§è‡³5.7.21é‡åˆ°çš„å‘(ä¸€)","slug":"MySQL-5.5.Xå‡çº§è‡³5.7.21é‡åˆ°çš„å‘(ä¸€)","date":"2018-02-10T12:23:00.000Z","updated":"2018-02-11T01:24:30.000Z","comments":true,"path":"2018/02/10/MySQL-5.5.Xå‡çº§è‡³5.7.21é‡åˆ°çš„å‘(ä¸€)/","link":"","permalink":"http://fuxkdb.com/2018/02/10/MySQL-5.5.X%E5%8D%87%E7%BA%A7%E8%87%B35.7.21%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91(%E4%B8%80)/","excerpt":"MySQL 5.5.Xå‡çº§è‡³5.7.21é‡åˆ°çš„å‘(ä¸€)å‘ç°é—®é¢˜å°†ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒçš„5.5.xå‡çº§åˆ°5.7.21å,æ‰“ç®—å°†5.7.21ä½œä¸ºä»åº“,å¼€å§‹åŒæ­¥ä¸»åº“æ•°æ®(binlog_format=statement),ç»“æœåˆšä¸€start slaveå°±æŠ¥é”™1Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.000004, end_log_pos 812. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.æŸ¥çœ‹error log12345678910111213142018-02-10T19:52:52.347979+08:00 3 [Warning] Slave I/O for channel &#x27;&#x27;: Notifying master by SET @master_binlog_checksum= @@global.binlog_checksum failed with error: Unknown system variable &#x27;binlog_checksum&#x27;, Error_code: 11932018-02-10T19:52:52.348080+08:00 3 [Warning] Slave I/O for channel &#x27;&#x27;: Unknown system variable &#x27;SERVER_UUID&#x27; on master. A probable cause is that the variable is not supported on the master (version: 5.5.59-log), even though it is on the slave (version: 5.7.21-log), Error_code: 11932018-02-10T19:52:52.445947+08:00 5 [ERROR] Slave SQL for channel &#x27;&#x27;: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log , end_log_pos 2651; Error &#x27;You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;&#x27; at line 1&#x27; on query. Default database: &#x27;fandb&#x27;. Query: &#x27;INSERT INTO postlog ( USERNAME, TIME, IP, GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;api&#x27;, &#x27;ajaxGetServers&#x27; )&#x27;, Error_code: 10642018-02-10T19:52:52.446217+08:00 4 [Warning] Slave SQL for channel &#x27;&#x27;: ... The slave coordinator and worker threads are stopped, possibly leaving data in inconsistent state. A restart should restore consistency automatically, although using non-transactional storage for data or info tables or DDL queries could lead to problems. In such cases you have to examine your data (see documentation for details). Error_code: 17562018-02-10T19:52:52.446235+08:00 4 [Note] Slave SQL thread for channel &#x27;&#x27; exiting, replication stopped in log &#x27;mysql-bin.000003&#x27; at position 23132018-02-10T19:53:15.708058+08:00 7 [Note] Slave SQL thread for channel &#x27;&#x27; initialized, starting replication in log &#x27;mysql-bin.000003&#x27; at position 2313, relay log &#x27;./mysql-relay.000009&#x27; position: 304 æ‰¾å‡ºåŸå› å¤´ä¸¤ä¸ªWarningæ˜¯ç”±äºä¸»åº“æ²¡æœ‰binlog_checksumå‚æ•°ï¼Œä¹Ÿæ²¡æœ‰SERVER_UUIDå‚æ•°(çœ‹æ¥ä»åº“å¼€å§‹åŒæ­¥æ—¶è¦å…ˆå»ä¸»åº“æŸ¥è¯¢è¿™ä¸¤ä¸ªå‚æ•°)æ¥ç€çš„ERRORæŠ¥çš„é”™è¯¯ç«Ÿç„¶æ˜¯error in your SQL syntaxè¯­æ³•é”™è¯¯. è§£æbinlogåæŸ¥åˆ°SQLè¯­å¥ä¸º1INSERT INTO postlog ( USERNAME, TIME, IP, GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;api&#x27;, &#x27;ajaxGetServers&#x27; );æˆ‘ä¾æ¬¡åœ¨5.5å’Œ5.7çš„ç¯å¢ƒæ‰§è¡Œè¿™ä¸ªSQLå‘ç°è¯¥SQLåœ¨5.5å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œè€Œåœ¨5.7æ‰§è¡Œå°±ä¼šæŠ¥é”™è¯­æ³•é”™è¯¯äºæ˜¯ä¸€ç‚¹ä¸€ç‚¹åˆ†æè¿™ä¸ªSQLå“ªæœ‰é—®é¢˜ï¼Œè¯´å®è¯è‚‰çœ¼çœŸæ²¡çœ‹å‡ºæ¥åªå¥½åœ¨5.7ä¸€ç‚¹ä¸€ç‚¹æ‰§è¡Œ1INSERT INTO postlog ( USERNAME, TIME, IP) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414);æ²¡é—®é¢˜å¯ä»¥æ‰§è¡Œ1INSERT INTO postlog ( USERNAME, TIME, IP, GET) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;);æŠ¥é”™äº†ï¼,é‚£æ˜¾ç„¶å°±æ˜¯GETæœ‰é—®é¢˜ã€‚ æ€€ç–‘æ˜¯ä¿ç•™å­—ï¼Ÿ","text":"MySQL 5.5.Xå‡çº§è‡³5.7.21é‡åˆ°çš„å‘(ä¸€)å‘ç°é—®é¢˜å°†ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒçš„5.5.xå‡çº§åˆ°5.7.21å,æ‰“ç®—å°†5.7.21ä½œä¸ºä»åº“,å¼€å§‹åŒæ­¥ä¸»åº“æ•°æ®(binlog_format=statement),ç»“æœåˆšä¸€start slaveå°±æŠ¥é”™1Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.000004, end_log_pos 812. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any.æŸ¥çœ‹error log12345678910111213142018-02-10T19:52:52.347979+08:00 3 [Warning] Slave I/O for channel &#x27;&#x27;: Notifying master by SET @master_binlog_checksum= @@global.binlog_checksum failed with error: Unknown system variable &#x27;binlog_checksum&#x27;, Error_code: 11932018-02-10T19:52:52.348080+08:00 3 [Warning] Slave I/O for channel &#x27;&#x27;: Unknown system variable &#x27;SERVER_UUID&#x27; on master. A probable cause is that the variable is not supported on the master (version: 5.5.59-log), even though it is on the slave (version: 5.7.21-log), Error_code: 11932018-02-10T19:52:52.445947+08:00 5 [ERROR] Slave SQL for channel &#x27;&#x27;: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log , end_log_pos 2651; Error &#x27;You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;&#x27; at line 1&#x27; on query. Default database: &#x27;fandb&#x27;. Query: &#x27;INSERT INTO postlog ( USERNAME, TIME, IP, GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;api&#x27;, &#x27;ajaxGetServers&#x27; )&#x27;, Error_code: 10642018-02-10T19:52:52.446217+08:00 4 [Warning] Slave SQL for channel &#x27;&#x27;: ... The slave coordinator and worker threads are stopped, possibly leaving data in inconsistent state. A restart should restore consistency automatically, although using non-transactional storage for data or info tables or DDL queries could lead to problems. In such cases you have to examine your data (see documentation for details). Error_code: 17562018-02-10T19:52:52.446235+08:00 4 [Note] Slave SQL thread for channel &#x27;&#x27; exiting, replication stopped in log &#x27;mysql-bin.000003&#x27; at position 23132018-02-10T19:53:15.708058+08:00 7 [Note] Slave SQL thread for channel &#x27;&#x27; initialized, starting replication in log &#x27;mysql-bin.000003&#x27; at position 2313, relay log &#x27;./mysql-relay.000009&#x27; position: 304 æ‰¾å‡ºåŸå› å¤´ä¸¤ä¸ªWarningæ˜¯ç”±äºä¸»åº“æ²¡æœ‰binlog_checksumå‚æ•°ï¼Œä¹Ÿæ²¡æœ‰SERVER_UUIDå‚æ•°(çœ‹æ¥ä»åº“å¼€å§‹åŒæ­¥æ—¶è¦å…ˆå»ä¸»åº“æŸ¥è¯¢è¿™ä¸¤ä¸ªå‚æ•°)æ¥ç€çš„ERRORæŠ¥çš„é”™è¯¯ç«Ÿç„¶æ˜¯error in your SQL syntaxè¯­æ³•é”™è¯¯. è§£æbinlogåæŸ¥åˆ°SQLè¯­å¥ä¸º1INSERT INTO postlog ( USERNAME, TIME, IP, GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;api&#x27;, &#x27;ajaxGetServers&#x27; );æˆ‘ä¾æ¬¡åœ¨5.5å’Œ5.7çš„ç¯å¢ƒæ‰§è¡Œè¿™ä¸ªSQLå‘ç°è¯¥SQLåœ¨5.5å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œè€Œåœ¨5.7æ‰§è¡Œå°±ä¼šæŠ¥é”™è¯­æ³•é”™è¯¯äºæ˜¯ä¸€ç‚¹ä¸€ç‚¹åˆ†æè¿™ä¸ªSQLå“ªæœ‰é—®é¢˜ï¼Œè¯´å®è¯è‚‰çœ¼çœŸæ²¡çœ‹å‡ºæ¥åªå¥½åœ¨5.7ä¸€ç‚¹ä¸€ç‚¹æ‰§è¡Œ1INSERT INTO postlog ( USERNAME, TIME, IP) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414);æ²¡é—®é¢˜å¯ä»¥æ‰§è¡Œ1INSERT INTO postlog ( USERNAME, TIME, IP, GET) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;);æŠ¥é”™äº†ï¼,é‚£æ˜¾ç„¶å°±æ˜¯GETæœ‰é—®é¢˜ã€‚ æ€€ç–‘æ˜¯ä¿ç•™å­—ï¼Ÿ æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£,å‘ç°è¿˜çœŸæ˜¯https://dev.mysql.com/doc/refman/5.7/en/keywords.html æ–°çš„é—®é¢˜è¿™ä¸ªä¿ç•™å­—çš„é—®é¢˜è¿˜çœŸè›‹ç–¼ï¼Œè¯´æ˜å¼€å‘ä¸è§„èŒƒå‘—ï¼Œåªèƒ½è®©å¼€å‘æ”¹äº†.ç›®å‰ç”±äºæ˜¯æµ‹è¯•ï¼Œæƒ³è¦å…ˆè·³è¿‡è¿™ä¸ªè¡¨ï¼Œäºæ˜¯ä½¿ç”¨5.7çš„æ–°ç‰¹æ€§åŠ¨æ€æ›´æ”¹replication filter1change replication filter REPLICATE_WILD_IGNORE_TABLE=(&#x27;mysql.%&#x27;,&#x27;information_schema.%&#x27;,&#x27;performance_schema.%&#x27;,&#x27;union_log%.%&#x27;,&#x27;test.%&#x27;,&#x27;fandb.postlog&#x27;);ç„¶åè·³è¿‡è¿™ä¸ªé”™è¯¯ç»“æœè¿˜æ˜¯æŠ¥é”™å¥‡æ€ªäº†ï¼Œæˆ‘ä¸€åº¦æ€€ç–‘è‡ªå·±çš„å¤åˆ¶è¿‡æ»¤è§„åˆ™æœ‰é—®é¢˜ã€‚ç„¶ååˆæ­å»ºäº†ä¸€å¥—5.7å’Œä¸€å¥—5.5æµ‹è¯•åŒæ ·çš„å¤åˆ¶è¿‡æ»¤è§„åˆ™éƒ½ç®¡ç”¨äºæ˜¯æ€€ç–‘ 5.5åšä¸»5.7åšä»æœ¬èº«æœ‰é—®é¢˜ï¼Œå¤åˆ¶è¿‡æ»¤è§„åˆ™ä¸èµ·ä½œç”¨ å¤åˆ¶è¿‡æ»¤è§„åˆ™èµ·ä½œç”¨ï¼Œä½†æ˜¯æœ‰åˆ«çš„é—®é¢˜ 5.5ä¸»åº“123456789101112131415161718192021222324252627root@localhost 19:54: [fandb]&gt; show create table postlog\\GERROR 2006 (HY000): MySQL server has gone awayNo connection. Trying to reconnect...Connection id: 5Current database: fandb*************************** 1. row *************************** Table: postlogCreate Table: CREATE TABLE `postlog` ( `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &#x27;è‡ªå¢ID&#x27;, `username` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;ç®¡ç†å‘˜è´¦å·&#x27;, `time` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ—¶é—´&#x27;, `ip` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;IP&#x27;, `get` text NOT NULL COMMENT &#x27;GET&#x27;, `post` text NOT NULL COMMENT &#x27;POST&#x27;, `file` text NOT NULL COMMENT &#x27;FILE&#x27;, `class` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;CLASS&#x27;, `method` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;METHOD&#x27;, PRIMARY KEY (`id`), KEY `username` (`username`), KEY `c_m` (`class`,`method`), KEY `time` (`time`)) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8 COMMENT=&#x27;æäº¤æ—¥å¿—è¡¨&#x27;1 row in set (0.00 sec)root@localhost 19:59: [fandb]&gt; select * from postlog;Empty set (0.00 sec)5.7.21ä»åº“123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263root@localhost 19:58: [fandb]&gt; select * from postlog;Empty set (0.00 sec)root@localhost 19:59: [fandb]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.105.118.10 Master_User: repl Master_Port: 3308 Connect_Retry: 60 Master_Log_File: mysql-bin.000004 Read_Master_Log_Pos: 1028 Relay_Log_File: mysql-relay.000010 Relay_Log_Pos: 1217 Relay_Master_Log_File: mysql-bin.000004 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: mysql.%,information_schema.%,performance_schema.%,union_log%.%,test.%,fandb.postlog Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 1028 Relay_Log_Space: 2296 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 323308 Master_UUID: Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: 3b6f4462-0190-11e8-ac03-525400a44d53:1-37445291 Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) 5.5ä¸»åº“ä»¥å…¼å®¹çš„æ–¹å¼æ’å…¥12345678910root@localhost 19:59: [fandb]&gt; INSERT INTO postlog ( USERNAME, TIME, IP, `GET`, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;api&#x27;, &#x27;ajaxGetServers&#x27; );Query OK, 1 row affected, 1 warning (0.00 sec)root@localhost 20:00: [fandb]&gt; select * from postlog;+----+-----------+------------+------------+-----------+------+------+-------+----------------+| id | username | time | ip | get | post | file | class | method |+----+-----------+------------+------------+-----------+------+------+-------+----------------+| 11 | maokaixin | 1518159802 | 2147483647 | gameid:0; | | | api | ajaxGetServers |+----+-----------+------------+------------+-----------+------+------+-------+----------------+1 row in set (0.00 sec) 5.7.21ä»åº“æŸ¥çœ‹æ²¡æœ‰æ’å…¥æ•°æ®,å¤åˆ¶è§„å¾‹è§„åˆ™ç”Ÿæ•ˆ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364root@localhost 19:59: [fandb]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.105.118.10 Master_User: repl Master_Port: 3308 Connect_Retry: 60 Master_Log_File: mysql-bin.000004 Read_Master_Log_Pos: 1395 Relay_Log_File: mysql-relay.000010 Relay_Log_Pos: 1584 Relay_Master_Log_File: mysql-bin.000004 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: mysql.%,information_schema.%,performance_schema.%,union_log%.%,test.%,fandb.postlog Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 1395 Relay_Log_Space: 2663 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 323308 Master_UUID: Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: 3b6f4462-0190-11e8-ac03-525400a44d53:1-37445291 Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)root@localhost 20:00: [fandb]&gt; select * from postlog;Empty set (0.00 sec) 5.5ä¸»åº“ä»¥éå…¼å®¹æ–¹å¼æ’å…¥1234567891011root@localhost 20:01: [fandb]&gt; INSERT INTO postlog ( USERNAME, TIME, IP, GET, POST, FILE, CLASS, METHOD ) VALUES ( &#x27;maokaixin&#x27;, 1518159802, 3395959414, &#x27;gameid:0;&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;api&#x27;, &#x27;ajaxGetServers&#x27; );Query OK, 1 row affected, 1 warning (0.00 sec)root@localhost 20:02: [fandb]&gt; select * from postlog;+----+-----------+------------+------------+-----------+------+------+-------+----------------+| id | username | time | ip | get | post | file | class | method |+----+-----------+------------+------------+-----------+------+------+-------+----------------+| 11 | maokaixin | 1518159802 | 2147483647 | gameid:0; | | | api | ajaxGetServers || 13 | maokaixin | 1518159802 | 2147483647 | gameid:0; | | | api | ajaxGetServers |+----+-----------+------------+------------+-----------+------+------+-------+----------------+2 rows in set (0.00 sec)5.7.21ä»åº“å¤åˆ¶sql threadæŠ¥é”™123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960root@localhost 20:02: [fandb]&gt; show slave status\\G*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 10.105.118.10 Master_User: repl Master_Port: 3308 Connect_Retry: 60 Master_Log_File: mysql-bin.000004 Read_Master_Log_Pos: 1760 Relay_Log_File: mysql-relay.000010 Relay_Log_Pos: 1584 Relay_Master_Log_File: mysql-bin.000004 Slave_IO_Running: Yes Slave_SQL_Running: No Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: mysql.%,information_schema.%,performance_schema.%,union_log%.%,test.%,fandb.postlog Last_Errno: 1064 Last_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.000004, end_log_pos 1733. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Skip_Counter: 0 Exec_Master_Log_Pos: 1395 Relay_Log_Space: 3028 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULLMaster_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 1064 Last_SQL_Error: Coordinator stopped because there were error(s) in the worker(s). The most recent failure being: Worker 1 failed executing transaction &#x27;ANONYMOUS&#x27; at master log mysql-bin.000004, end_log_pos 1733. See error log and/or performance_schema.replication_applier_status_by_worker table for more details about this failure or others, if any. Replicate_Ignore_Server_Ids: Master_Server_Id: 323308 Master_UUID: Master_Info_File: mysql.slave_master_info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: 180210 20:02:04 Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: 3b6f4462-0190-11e8-ac03-525400a44d53:1-37445291 Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec)ç”±æ­¤æ¨æ–­,å¤åˆ¶è¿‡æ»¤è§„åˆ™æ²¡æœ‰é—®é¢˜,æ˜¯ç”Ÿæ•ˆçš„ä½†æ˜¯åˆ¤æ–­æ—¶éœ€è¦å…ˆè§£æsql,å½“è§£ææ—¶å‘ç°sqlè¯­æ³•é”™è¯¯(å®é™…ä¸ºgetä¸ºMySQL5.7ä¿ç•™å­—),å¯¼è‡´sql threadæŠ¥é”™","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå‡çº§","slug":"MySQLå‡çº§","permalink":"http://fuxkdb.com/tags/MySQL%E5%8D%87%E7%BA%A7/"}]},{"title":"","slug":"python2 yum module is needed for this  module","date":"2018-02-09T06:00:17.000Z","updated":"2018-02-09T06:01:01.000Z","comments":true,"path":"2018/02/09/python2 yum module is needed for this  module/","link":"","permalink":"http://fuxkdb.com/2018/02/09/python2%20yum%20module%20is%20needed%20for%20this%20%20module/","excerpt":"","text":"pyenvè£…çš„2.7.14 æ— æ³•ç”¨ansible yum.(å…¶å®ä¸æ˜¯pyenvçš„åŸå› ,è‡ªå·±ç¼–è¯‘å®‰è£…çš„2.7.14ä¹Ÿä¸è¡Œ) 123456789101112131415161718192021222324#ansible OA* -m yum -a&quot;name=mutt state=present&quot; OA_P | FAILED! =&gt; &#123; &quot;changed&quot;: false, &quot;msg&quot;: &quot;python2 yum module is needed for this module&quot;&#125;OA_S | FAILED! =&gt; &#123; &quot;changed&quot;: false, &quot;msg&quot;: &quot;python2 yum module is needed for this module&quot;&#125;#ansible OA* -m shell -a &quot;which python pip&quot;OA_P | SUCCESS | rc=0 &gt;&gt;/root/.pyenv/versions/2.7.14/bin/python/root/.pyenv/versions/2.7.14/bin/pipOA_S | SUCCESS | rc=0 &gt;&gt;/root/.pyenv/versions/2.7.14/bin/python/root/.pyenv/versions/2.7.14/bin/pip#vi /etc/ansible/hosts/oa [OA]OA_P ansible_connection=localOA_S ansible_ssh_host=172.16.200.209 [OA:vars]ansible_python_interpreter=/root/.pyenv/shims/python ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„pythonä½œä¸ºè§£é‡Šå™¨å¯ä»¥ä½¿ç”¨yumæ¨¡å—123456789101112131415161718192021222324252627[root@OA_P 13:04:15 /etc/ansible/roles]#ansible OA* -m yum -a&quot;name=mutt state=present&quot; OA_P | FAILED! =&gt; &#123; &quot;changed&quot;: false, &quot;msg&quot;: &quot;python2 bindings for rpm are needed for this module. python2 yum module is needed for this module&quot;&#125;OA_S | FAILED! =&gt; &#123; &quot;changed&quot;: false, &quot;msg&quot;: &quot;python2 bindings for rpm are needed for this module. python2 yum module is needed for this module&quot;&#125;^C[root@OA_P 13:04:28 /etc/ansible/roles]#ansible OA* -m yum -a&quot;name=mutt state=present&quot; -e &quot;ansible_python_interpreter=/usr/bin/python&quot;OA_S | SUCCESS =&gt; &#123; &quot;changed&quot;: false, &quot;msg&quot;: &quot;&quot;, &quot;rc&quot;: 0, &quot;results&quot;: [ &quot;5:mutt-1.5.20-8.20091214hg736b6a.el6.x86_64 providing mutt is already installed&quot; ]&#125;OA_P | FAILED! =&gt; &#123; &quot;changed&quot;: false, &quot;msg&quot;: &quot;The following packages have pending transactions: mutt-x86_64&quot;, &quot;rc&quot;: 125, &quot;results&quot;: []&#125;è¿™æ˜¯å› ä¸º2.6å¯ä»¥import yumè€Œ2.7ä¸è¡Œ1234567891011121314#pythonPython 2.7.14 (default, Dec 15 2017, 23:08:56) [GCC 4.4.7 20120313 (Red Hat 4.4.7-18)] on linux2Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.&gt;&gt;&gt; import yumTraceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;ImportError: No module named yum#python2.6Python 2.6.6 (r266:84292, Aug 18 2016, 15:13:37) [GCC 4.4.7 20120313 (Red Hat 4.4.7-17)] on linux2Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.&gt;&gt;&gt; import yum ç›®å‰æˆ‘çš„è§£å†³æ–¹æ³•æ˜¯, åœ¨yumä¹‹å‰å…ˆset facts, ä¹‹ååœ¨setå›æ¥123456789101112131415- set_fact: ansible_python_default_interpreter: &quot;&#123;&#123; ansible_python_interpreter &#125;&#125;&quot; ansible_python_interpreter: &quot;/usr/bin/python&quot;- name: å®‰è£…ä¾èµ–åŒ… yum: name: &quot;&#123;&#123; item.line &#125;&#125;&quot; state: present with_items: - &#123; line: &#x27;openssl&#x27; &#125; - &#123; line: &#x27;openssl-devel&#x27; &#125; - &#123; line: &#x27;mutt&#x27; &#125;- set_fact: ansible_python_interpreter: &quot;&#123;&#123; ansible_python_default_interpreter &#125;&#125;&quot; å‚è€ƒ https://github.com/openshift/openshift-ansible/issues/855https://stackoverflow.com/questions/29711514/no-module-named-yum-error-with-python2-7-when-using-ansible-on-fedora/36138921#36138921","categories":[],"tags":[]},{"title":"","slug":"CONFIG REWRITEå‘½ä»¤","date":"2018-01-19T03:09:11.000Z","updated":"2018-01-19T03:34:30.000Z","comments":true,"path":"2018/01/19/CONFIG REWRITEå‘½ä»¤/","link":"","permalink":"http://fuxkdb.com/2018/01/19/CONFIG%20REWRITE%E5%91%BD%E4%BB%A4/","excerpt":"","text":"CONFIG REWRITE Available since 2.8.0. CONFIG REWRITEå‘½ä»¤ç”¨äºé‡å†™redis serverå¯åŠ¨æ—¶ä½¿ç”¨çš„é…ç½®æ–‡ä»¶,ä»¥æœ€å°çš„å˜åŠ¨åæ˜ å½“å‰serverçš„å®é™…é…ç½®,å½“å‰çš„å®é™…é…ç½®å¯èƒ½ä¼šç”±äºCONFIG SETçš„ä½¿ç”¨è€Œä¸å¯åŠ¨æ—¶çš„é…ç½®æ–‡ä»¶ä¸åŒ. ç±»ä¼¼ scope=spfile é‡å†™ä»¥éå¸¸ä¿å®ˆçš„æ–¹å¼æ‰§è¡Œ: å°½å¯èƒ½ä¿ç•™åŸå§‹redis.confçš„æ³¨é‡Šå’Œæ•´ä½“ç»“æ„. å¦‚æœä¸€ä¸ªé€‰é¡¹å·²ç»å­˜åœ¨äºæ—§çš„redis.confæ–‡ä»¶ä¸­,å®ƒå°†è¢«åŸåœ°æ›´æ–°. å¦‚æœæŸä¸ªé€‰é¡¹å°šä¸å­˜åœ¨,ä½†è®¾ç½®ä¸ºå…¶é»˜è®¤å€¼,åˆ™ä¸ä¼šç”±é‡å†™è¿‡ç¨‹æ·»åŠ . å¦‚æœæŸä¸ªé€‰é¡¹å°šä¸å­˜åœ¨,ä½†å®ƒè¢«è®¾ç½®ä¸ºéé»˜è®¤å€¼,åˆ™ä¼šå°†å…¶é™„åŠ åˆ°æ–‡ä»¶æœ«å°¾. Non used lines are blanked. For instance if you used to have multiple save directives, but the current configuration has fewer or none as you disabled RDB persistence, all the lines will be blanked. æœªä½¿ç”¨çš„è¡Œå°†è¢«åˆ é™¤.ä¾‹å¦‚,å¦‚æœæ‚¨æ›¾ç»è®¾ç½®å¤šä¸ªsave,ä½†æ˜¯åæ¥å´é€šè¿‡config setåªè®¾ç½®äº†æ›´å°‘çš„æˆ–è€…config set save â€˜â€™,é‚£ä¹ˆæ‰€æœ‰çš„æœªä½¿ç”¨saveå°†è¢«åˆ é™¤ 123456789101112131415161718192021222324252627282930313233343536[root@cn_mu_binlog_backup ~]# redis-cli -p 6379 config get save1) &quot;save&quot;2) &quot;&quot;[root@cn_mu_binlog_backup ~]# cat /usr/local/redis/etc/6379_redis.conf|grep save# save &lt;seconds&gt; &lt;changes&gt;# Will save the DB if both the given number of seconds and the given# In the example below the behaviour will be to save:# Note: you can disable saving completely by commenting out all &quot;save&quot; lines.# It is also possible to remove all the previously configured save# points by adding a save directive with a single empty string argument# save &quot;&quot;save 900 1save 300 10save 60 10000...é‡å†™[root@cn_mu_binlog_backup ~]# redis-cli -p 6379 config rewriteOK[root@cn_mu_binlog_backup ~]# cat /usr/local/redis/etc/6379_redis.conf|grep save# save &lt;seconds&gt; &lt;changes&gt;# Will save the DB if both the given number of seconds and the given# In the example below the behaviour will be to save:# Note: you can disable saving completely by commenting out all &quot;save&quot; lines.# It is also possible to remove all the previously configured save# points by adding a save directive with a single empty string argument# save &quot;&quot;# (at least one save point) and the latest background save failed.stop-writes-on-bgsave-error yes# If you want to save some CPU in the saving child set it to &#x27;no&#x27; but# algorithms (in order to save memory), so you can tune it for speed or# the configured save points).# saving process (a background save or AOF log background rewriting) is# Lists are also encoded in a special way to save a lot of space.# order to save a lot of space. This encoding is only used when the length and å¦‚æœç”±äºæŸç§åŸå› åŸæ¥çš„é…ç½®æ–‡ä»¶ä¸å†å­˜åœ¨,CONFIG REWRITEä¹Ÿå¯ä»¥é‡å†™é…ç½®æ–‡ä»¶. ä½†æ˜¯,å¦‚æœæœåŠ¡å™¨å¯åŠ¨æ—¶æ²¡æœ‰é…ç½®æ–‡ä»¶,CONFIG REWRITEå°†åªè¿”å›ä¸€ä¸ªé”™è¯¯. åŸå­é‡å†™è¿‡ç¨‹In order to make sure the redis.conf file is always consistent, that is, on errors or crashes you always end with the old file, or the new one, the rewrite is performed with a single write(2) call that has enough content to be at least as big as the old file. Sometimes additional padding in the form of comments is added in order to make sure the resulting file is big enough, and later the file gets truncated to remove the padding at the end. ä¸ºäº†ç¡®ä¿redis.confæ–‡ä»¶å§‹ç»ˆä¿æŒä¸€è‡´,å³åœ¨å‡ºç°é”™è¯¯æˆ–å´©æºƒæ—¶æ€»æ˜¯ä»¥æ—§æ–‡ä»¶æˆ–æ–°æ–‡ä»¶ç»“æŸ,é‡å†™å°†ä½¿ç”¨å…·æœ‰è¶³å¤Ÿå†…å®¹çš„å•æ¬¡å†™å…¥(2)è°ƒç”¨æ¥æ‰§è¡Œ è‡³å°‘ä¸æ—§æ–‡ä»¶ä¸€æ ·å¤§. æœ‰æ—¶ä¼šæ·»åŠ æ³¨é‡Šå½¢å¼çš„å…¶ä»–å¡«å……ä»¥ç¡®ä¿ç”Ÿæˆçš„æ–‡ä»¶è¶³å¤Ÿå¤§,ç„¶åæ–‡ä»¶è¢«æˆªæ–­ä»¥åˆ é™¤æœ€åçš„å¡«å……. è¿”å›å€¼Simple string reply: OK å½“é…ç½®è¢«æ­£ç¡®é‡å†™. å¦åˆ™,è¿”å›é”™è¯¯","categories":[],"tags":[]},{"title":"redis-cli,Rediså‘½ä»¤è¡Œç•Œé¢","slug":"redis-cli","date":"2018-01-17T16:00:00.000Z","updated":"2018-01-18T12:04:24.000Z","comments":true,"path":"2018/01/18/redis-cli/","link":"","permalink":"http://fuxkdb.com/2018/01/18/redis-cli/","excerpt":"redis-cli,Rediså‘½ä»¤è¡Œç•Œé¢redis-cliæ˜¯Rediså‘½ä»¤è¡Œç•Œé¢ï¼Œä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œå…è®¸å‘Rediså‘é€å‘½ä»¤ï¼Œå¹¶ç›´æ¥ä»ç»ˆç«¯è¯»å–æœåŠ¡å™¨å‘é€çš„å›å¤ã€‚ å®ƒæœ‰ä¸¤ç§ä¸»è¦çš„æ¨¡å¼ï¼šä¸€ç§æ˜¯äº¤äº’æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·è¾“å…¥å‘½ä»¤å¹¶è·å¾—å›å¤çš„REPLï¼ˆRead Eval Print Loopï¼‰å¦ä¸€ç§æ¨¡å¼æ˜¯å°†å‘½ä»¤ä½œä¸ºredis-cliçš„å‚æ•°å‘é€ï¼Œæ‰§è¡Œå¹¶æ‰“å°åœ¨æ ‡å‡†è¾“å‡ºä¸Šã€‚ åœ¨äº¤äº’æ¨¡å¼ä¸‹ï¼Œredis-cliå…·æœ‰åŸºæœ¬çš„è¡Œç¼–è¾‘åŠŸèƒ½ï¼Œå¯ä»¥æä¾›è‰¯å¥½çš„æ‰“å­—ä½“éªŒã€‚ ä½†æ˜¯ï¼Œredis-cliä¸åªæ˜¯è¿™ä¸€ç‚¹ã€‚æœ‰äº›é€‰é¡¹å¯ä»¥ç”¨æ¥å¯åŠ¨ç¨‹åºï¼Œä»¥ä¾¿å°†å…¶æ”¾å…¥ç‰¹æ®Šæ¨¡å¼ï¼Œä»¥ä¾¿redis-cliå¯ä»¥å®Œæˆæ›´å¤æ‚çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ¨¡æ‹Ÿslaveå¹¶æ‰“å°ä»masteræ¥æ”¶åˆ°çš„å¤åˆ¶æµï¼ŒæŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿï¼Œå¹¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼Œç”šè‡³ä¸€ä¸ªASCIIè‰ºæœ¯é¢‘è°±å›¾çš„å»¶è¿Ÿæ ·æœ¬å’Œé¢‘ç‡ï¼Œä»¥åŠè®¸å¤šå…¶ä»–äº‹æƒ…ã€‚ æœ¬æŒ‡å—å°†æ¶µç›–redis-cliçš„ä¸åŒæ–¹é¢ï¼Œç”±ç®€å…¥ç¹ã€‚ å¦‚æœæ‚¨è¦å¹¿æ³›ä½¿ç”¨Redisï¼Œæˆ–è€…æ‚¨å·²ç»è¿™ä¹ˆåšäº†ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šç¢°å·§ä½¿ç”¨redis-cliã€‚èŠ±ä¸€äº›æ—¶é—´æ¥ç†Ÿæ‚‰å®ƒå¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸»æ„ï¼Œä¸€æ—¦ä½ çŸ¥é“äº†å‘½ä»¤è¡Œç•Œé¢çš„æ‰€æœ‰æŠ€å·§ï¼Œä½ å°±ä¼šçœ‹åˆ°ä½ å°†æ›´æœ‰æ•ˆåœ°ä½¿ç”¨Redisã€‚ å‘½ä»¤è¡Œç”¨æ³•å¦‚ä¸‹å¯ä»¥ç›´æ¥éäº¤äº’æ¨¡å¼æ‰§è¡Œå‘½ä»¤å¹¶åœ¨æ ‡å‡†è¾“å‡ºè·å–è¿”å›ç»“æœ12redis-cli incr mycounter(integer) 7 â€˜()â€™å†…ä¸ºè¿”å›ç»“æœçš„ç±»å‹.å½“æˆ‘ä»¬éœ€è¦è·å–è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥,æˆ–è€…å¸Œæœ›å°†ç»“æœé‡å®šå‘åˆ°æ–‡ä»¶ä¸­æ—¶,æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦æ˜¾ç¤ºç±»å‹ä¿¡æ¯.å®é™…ä¸Š,redis-cliä¼šè‡ªåŠ¨æ£€æµ‹,å½“å®ƒæ£€æµ‹åˆ°æ ‡å‡†è¾“å‡ºæ˜¯ä¸€ä¸ªtty(a terminal basically)æ—¶,å®ƒä¼šæ˜¾ç¤ºç±»å‹ä¿¡æ¯æ¥æå‡å¯è¯»æ€§,å¦åˆ™å®ƒä¼šå¯ç”¨åŸå§‹è¾“å‡ºæ¨¡å¼,å¦‚ä¸‹æ‰€ç¤º:123$ redis-cli incr mycounter &gt; /tmp/output.txt$ cat /tmp/output.txt8è¿™ä¸€æ¬¡å½“CLIæ£€æµ‹åˆ°è¾“å‡ºä¸åœ¨å†™å…¥terminalå,(integer)è¢«åˆ é™¤äº†ä¸å†æ˜¾ç¤º. ä½ å¯ä»¥ä½¿ç”¨--rawé€‰é¡¹æ¥å¼ºåˆ¶è¾“å‡ºåˆ°ç»ˆç«¯çš„å†…å®¹ä¹Ÿä¸æ˜¾ç¤ºç±»å‹ä¿¡æ¯12$ redis-cli --raw incr mycounter9 åŒæ ·çš„,ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨--no-rawå¼ºåˆ¶éttyè¾“å‡ºä¹Ÿæ˜¾ç¤ºç±»å‹ä¿¡æ¯12345678910[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 incr no(integer) 1[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 --raw incr no2[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 incr no &gt; res.txt[root@cn_mu_binlog_backup ~]# cat res.txt 3[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 --no-raw incr no &gt; res.txt[root@cn_mu_binlog_backup ~]# cat res.txt (integer) 4","text":"redis-cli,Rediså‘½ä»¤è¡Œç•Œé¢redis-cliæ˜¯Rediså‘½ä»¤è¡Œç•Œé¢ï¼Œä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œå…è®¸å‘Rediså‘é€å‘½ä»¤ï¼Œå¹¶ç›´æ¥ä»ç»ˆç«¯è¯»å–æœåŠ¡å™¨å‘é€çš„å›å¤ã€‚ å®ƒæœ‰ä¸¤ç§ä¸»è¦çš„æ¨¡å¼ï¼šä¸€ç§æ˜¯äº¤äº’æ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·è¾“å…¥å‘½ä»¤å¹¶è·å¾—å›å¤çš„REPLï¼ˆRead Eval Print Loopï¼‰å¦ä¸€ç§æ¨¡å¼æ˜¯å°†å‘½ä»¤ä½œä¸ºredis-cliçš„å‚æ•°å‘é€ï¼Œæ‰§è¡Œå¹¶æ‰“å°åœ¨æ ‡å‡†è¾“å‡ºä¸Šã€‚ åœ¨äº¤äº’æ¨¡å¼ä¸‹ï¼Œredis-cliå…·æœ‰åŸºæœ¬çš„è¡Œç¼–è¾‘åŠŸèƒ½ï¼Œå¯ä»¥æä¾›è‰¯å¥½çš„æ‰“å­—ä½“éªŒã€‚ ä½†æ˜¯ï¼Œredis-cliä¸åªæ˜¯è¿™ä¸€ç‚¹ã€‚æœ‰äº›é€‰é¡¹å¯ä»¥ç”¨æ¥å¯åŠ¨ç¨‹åºï¼Œä»¥ä¾¿å°†å…¶æ”¾å…¥ç‰¹æ®Šæ¨¡å¼ï¼Œä»¥ä¾¿redis-cliå¯ä»¥å®Œæˆæ›´å¤æ‚çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ¨¡æ‹Ÿslaveå¹¶æ‰“å°ä»masteræ¥æ”¶åˆ°çš„å¤åˆ¶æµï¼ŒæŸ¥çœ‹å¤åˆ¶å»¶è¿Ÿï¼Œå¹¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼Œç”šè‡³ä¸€ä¸ªASCIIè‰ºæœ¯é¢‘è°±å›¾çš„å»¶è¿Ÿæ ·æœ¬å’Œé¢‘ç‡ï¼Œä»¥åŠè®¸å¤šå…¶ä»–äº‹æƒ…ã€‚ æœ¬æŒ‡å—å°†æ¶µç›–redis-cliçš„ä¸åŒæ–¹é¢ï¼Œç”±ç®€å…¥ç¹ã€‚ å¦‚æœæ‚¨è¦å¹¿æ³›ä½¿ç”¨Redisï¼Œæˆ–è€…æ‚¨å·²ç»è¿™ä¹ˆåšäº†ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šç¢°å·§ä½¿ç”¨redis-cliã€‚èŠ±ä¸€äº›æ—¶é—´æ¥ç†Ÿæ‚‰å®ƒå¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸»æ„ï¼Œä¸€æ—¦ä½ çŸ¥é“äº†å‘½ä»¤è¡Œç•Œé¢çš„æ‰€æœ‰æŠ€å·§ï¼Œä½ å°±ä¼šçœ‹åˆ°ä½ å°†æ›´æœ‰æ•ˆåœ°ä½¿ç”¨Redisã€‚ å‘½ä»¤è¡Œç”¨æ³•å¦‚ä¸‹å¯ä»¥ç›´æ¥éäº¤äº’æ¨¡å¼æ‰§è¡Œå‘½ä»¤å¹¶åœ¨æ ‡å‡†è¾“å‡ºè·å–è¿”å›ç»“æœ12redis-cli incr mycounter(integer) 7 â€˜()â€™å†…ä¸ºè¿”å›ç»“æœçš„ç±»å‹.å½“æˆ‘ä»¬éœ€è¦è·å–è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥,æˆ–è€…å¸Œæœ›å°†ç»“æœé‡å®šå‘åˆ°æ–‡ä»¶ä¸­æ—¶,æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦æ˜¾ç¤ºç±»å‹ä¿¡æ¯.å®é™…ä¸Š,redis-cliä¼šè‡ªåŠ¨æ£€æµ‹,å½“å®ƒæ£€æµ‹åˆ°æ ‡å‡†è¾“å‡ºæ˜¯ä¸€ä¸ªtty(a terminal basically)æ—¶,å®ƒä¼šæ˜¾ç¤ºç±»å‹ä¿¡æ¯æ¥æå‡å¯è¯»æ€§,å¦åˆ™å®ƒä¼šå¯ç”¨åŸå§‹è¾“å‡ºæ¨¡å¼,å¦‚ä¸‹æ‰€ç¤º:123$ redis-cli incr mycounter &gt; /tmp/output.txt$ cat /tmp/output.txt8è¿™ä¸€æ¬¡å½“CLIæ£€æµ‹åˆ°è¾“å‡ºä¸åœ¨å†™å…¥terminalå,(integer)è¢«åˆ é™¤äº†ä¸å†æ˜¾ç¤º. ä½ å¯ä»¥ä½¿ç”¨--rawé€‰é¡¹æ¥å¼ºåˆ¶è¾“å‡ºåˆ°ç»ˆç«¯çš„å†…å®¹ä¹Ÿä¸æ˜¾ç¤ºç±»å‹ä¿¡æ¯12$ redis-cli --raw incr mycounter9 åŒæ ·çš„,ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨--no-rawå¼ºåˆ¶éttyè¾“å‡ºä¹Ÿæ˜¾ç¤ºç±»å‹ä¿¡æ¯12345678910[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 incr no(integer) 1[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 --raw incr no2[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 incr no &gt; res.txt[root@cn_mu_binlog_backup ~]# cat res.txt 3[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 --no-raw incr no &gt; res.txt[root@cn_mu_binlog_backup ~]# cat res.txt (integer) 4 Host, port, password and databaseredis-clié»˜è®¤ä¼šè¿æ¥127.0.0.1,6379ç«¯å£.å¯ä»¥ä½¿ç”¨-h å’Œ -pé€‰é¡¹æ›´æ”¹hostå’Œport12$ redis-cli -h redis15.localnet.org -p 6390 pingPONGå¦‚æœä½ çš„instanceè®¾ç½®äº†å¯†ç ,å¯ä»¥ä½¿ç”¨-aé€‰é¡¹12$ redis-cli -a myUnguessablePazzzzzword123 pingPONG å¯ä»¥ä½¿ç”¨-né€‰é¡¹ä¿®æ”¹database12345678$ redis-cli flushallOK$ redis-cli -n 1 incr a(integer) 1$ redis-cli -n 1 incr a(integer) 2$ redis-cli -n 2 incr a(integer) 1 Some or all of this information can also be provided by using the -u option and a valid URI:12$ redis-cli -u redis://p%40ssw0rd@redis-16379.hosted.com:16379/0 pingPONG 3.2.9æ²¡è¿™ä¸ª Getting input from other programsæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥ä½¿ç”¨redis-cliæ¥è·å¾—æ¥è‡ªå…¶ä»–å‘½ä»¤çš„è¾“å…¥.ä¸€ç§æ˜¯ä»æ ‡å‡†è¾“å…¥stdinè¯»å–æœ€åä¸€ä¸ªargument.ä¾‹å¦‚,set ä¸€ä¸ªkeyçš„å€¼ä¸º/etc/services12345678910111213141516171819202122232425262728[root@cn_mu_binlog_backup ~]# less /etc/services# /etc/services:# $Id: services,v 1.48 2009/11/11 14:32:31 ovasik Exp $## Network services, Internet style# IANA services version: last updated 2009-11-10## Note that it is presently the policy of IANA to assign a single well-known# port number for both TCP and UDP; hence, most entries here have two entries# even if the protocol doesn&#x27;t support UDP operations.# Updated from RFC 1700, ``Assigned Numbers&#x27;&#x27; (October 1994). Not all ports# are included, only the more common ones.## The latest IANA port assignments can be gotten from# http://www.iana.org/assignments/port-numbers# The Well Known Ports are those from 0 through 1023.# The Registered Ports are those from 1024 through 49151# The Dynamic and/or Private Ports are those from 49152 through 65535## Each line describes one service, and is of the form:## service-name port/protocol [aliases ...] [# comment]tcpmux 1/tcp # TCP port service multiplexertcpmux 1/udp # TCP port service multiplexerrje 5/tcp # Remote Job Entryrje 5/udp # Remote Job Entryecho 7/tcpå¯ä»¥ä½¿ç”¨-xé€‰é¡¹1234[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 -x set foo &lt; /etc/services OK[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 getrange foo 0 50&quot;# /etc/services:\\n# $Id: services,v 1.48 2009/11/11 &quot; æ­£å¦‚ä½ å¯ä»¥åœ¨ä¸Šé¢çš„ä¼šè¯çš„ç¬¬ä¸€è¡Œçœ‹åˆ°çš„é‚£æ ·,æ²¡æœ‰æŒ‡å®šSETå‘½ä»¤çš„æœ€åä¸€ä¸ªå‚æ•°.è€Œæ˜¯æŒ‡å®š-xé€‰é¡¹,å¹¶å°†æ–‡ä»¶é‡å®šå‘åˆ°CLIçš„æ ‡å‡†è¾“å…¥. æ‰€ä»¥è¾“å…¥è¢«è¯»å–,å¹¶è¢«ç”¨ä½œå‘½ä»¤çš„æœ€åä¸€ä¸ªå‚æ•°. è¿™å¯¹ç¼–å†™è„šæœ¬å¾ˆæœ‰ç”¨. ä¸€ä¸ªä¸åŒçš„æ–¹æ³•æ˜¯å‘redis-cliæä¾›ä¸€ä¸ªå†™åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­çš„å‘½ä»¤åˆ—è¡¨:12345678910111213141516171819202122$ cat /tmp/commands.txtset foo 100incr fooappend foo xxxget foo$ cat /tmp/commands.txt | redis-cliOK(integer) 101(integer) 6&quot;101xxx&quot;$ cat /tmp/commands.txtset foo 100incr fooappend foo xxxget foo$ cat /tmp/commands.txt | redis-cliOK(integer) 101(integer) 6&quot;101xxx&quot; ä¸­é—´æœ‰é”™è¯¯ä¼šç»§ç»­æ‰§è¡Œ æŒç»­è¿è¡Œç›¸åŒçš„å‘½ä»¤-r Execute specified command N times. -i When -r is used, waits seconds per command.It is possible to specify sub-second times like -i 0.1. 123456[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 -r 5 -i 1 pingPONGPONGPONGPONG... ä½¿ç”¨redis-cliæ‰¹é‡æ’å…¥æ•°æ®ä½¿ç”¨redis-cliè¿›è¡Œæ‰¹é‡æ’å…¥ä¼šè¢«åˆ†ç¦»å‡ºæ¥ï¼Œå› ä¸ºå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªæœ‰ä»·å€¼çš„è¯é¢˜ã€‚ è¯·å‚é˜…æˆ‘ä»¬çš„æ‰¹é‡æ’å…¥æŒ‡å—. CSVæ ¼å¼è¾“å‡º--csv Output in CSV format. 1234$ redis-cli lpush mylist a b c d(integer) 4$ redis-cli --csv lrange mylist 0 -1&quot;d&quot;,&quot;c&quot;,&quot;b&quot;,&quot;a&quot; æ‰§è¡Œluaè„šæœ¬redis-cliå¯¹ä½¿ç”¨Luaè„šæœ¬çš„æ–°Luaè°ƒè¯•å·¥å…·æä¾›äº†å¹¿æ³›çš„æ”¯æŒï¼Œä»Redis 3.2å¼€å§‹ã€‚ æœ‰å…³æ­¤åŠŸèƒ½ï¼Œè¯·å‚é˜…Redis Luaè°ƒè¯•å™¨æ–‡æ¡£ã€‚ ä½†æ˜¯ï¼Œå³ä½¿ä¸ä½¿ç”¨è°ƒè¯•å™¨ï¼Œä¸ä»¥äº¤äº’æ–¹å¼å°†è„šæœ¬é”®å…¥åˆ°shellæˆ–ä½œä¸ºå‚æ•°ç›¸æ¯”ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨redis-cliä»¥æ›´èˆ’é€‚çš„æ–¹å¼ä»æ–‡ä»¶è¿è¡Œè„šæœ¬ï¼š123456789$ cat /tmp/script.luareturn redis.call(&#x27;set&#x27;,KEYS[1],ARGV[1])$ redis-cli --eval /tmp/script.lua foo , barOK[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 --eval ./script.lua foo , bar # fooç©ºæ ¼,ç©ºæ ¼barOK[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 get foo&quot;bar&quot; Interactive mode äº¤äº’æ¨¡å¼åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ¢è®¨äº†å¦‚ä½•ä½¿ç”¨Redis CLIä½œä¸ºå‘½ä»¤è¡Œç¨‹åºã€‚ è¿™å¯¹äºè„šæœ¬å’ŒæŸäº›ç±»å‹çš„æµ‹è¯•éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å¤§å¤šæ•°äººå°†å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨ä½¿ç”¨äº¤äº’æ¨¡å¼çš„redis-cliä¸Šã€‚ åœ¨äº¤äº’æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·åœ¨æç¤ºç¬¦ä¸‹é”®å…¥Rediså‘½ä»¤ã€‚ è¯¥å‘½ä»¤è¢«å‘é€åˆ°æœåŠ¡å™¨ï¼Œè¿›è¡Œå¤„ç†ï¼Œå›å¤è¢«è§£æå¹¶å‘ˆç°ä¸ºæ›´ç®€å•çš„å½¢å¼æ¥è¯»å–ã€‚ åœ¨äº¤äº’æ¨¡å¼ä¸‹è¿è¡ŒCLIå¹¶ä¸éœ€è¦ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ - åªè¦åœ¨æ²¡æœ‰ä»»ä½•äº‰è®ºçš„æƒ…å†µä¸‹è¿›è¡Œåˆé¤å°±å¯ä»¥äº†ï¼š 123$ redis-cli127.0.0.1:6379&gt; pingPONG 127.0.0.1:6379&gt;æ˜¯æç¤ºç¬¦,æç¤ºä½ è¿æ¥serverå’Œdatabase. å½“æ”¹å˜serveræˆ–é€‰æ‹©å…¶ä»–é0databaseæ—¶æç¤ºç¬¦ä¼šæ”¹å˜ 12345678127.0.0.1:6379&gt; select 2OK127.0.0.1:6379[2]&gt; dbsize(integer) 1127.0.0.1:6379[2]&gt; select 0OK127.0.0.1:6379&gt; dbsize(integer) 503 å¤„ç†è¿æ¥å’Œé‡æ–°è¿æ¥connectå‘½ä»¤,æŒ‡å®šhostnameå’Œportå³å¯è¿æ¥å¦ä¸€ä¸ªinstance123[root@cn_mu_binlog_backup ~]# redis-cli -p 6381127.0.0.1:6381&gt; connect 127.0.0.1 6380127.0.0.1:6380&gt; æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„æç¤ºç›¸åº”åœ°æ”¹å˜ã€‚ å¦‚æœç”¨æˆ·å°è¯•è¿æ¥åˆ°ä¸å¯è®¿é—®çš„å®ä¾‹ï¼Œåˆ™redis-cliå°†è¿›å…¥æ–­å¼€è¿æ¥æ¨¡å¼ï¼Œå¹¶å°è¯•åœ¨æ‰§è¡Œæ¯ä¸ªæ–°å‘½ä»¤æ—¶é‡æ–°è¿æ¥ï¼š1234567127.0.0.1:6380&gt; connect 127.0.0.1 9999Could not connect to Redis at 127.0.0.1:9999: Connection refusednot connected&gt; pingCould not connect to Redis at 127.0.0.1:9999: Connection refusednot connected&gt; pingCould not connect to Redis at 127.0.0.1:9999: Connection refusednot connected&gt; é€šå¸¸åœ¨æ£€æµ‹åˆ°æ–­å¼€è¿æ¥åï¼ŒCLIå§‹ç»ˆå°è¯•é‡æ–°è¿æ¥ï¼šå¦‚æœå°è¯•å¤±è´¥ï¼Œåˆ™æ˜¾ç¤ºé”™è¯¯å¹¶è¿›å…¥æ–­å¼€è¿æ¥çŠ¶æ€ã€‚ ä»¥ä¸‹æ˜¯æ–­å¼€å’Œé‡æ–°è¿æ¥çš„ç¤ºä¾‹ï¼š12345127.0.0.1:6379&gt; debug restartCould not connect to Redis at 127.0.0.1:6379: Connection refusednot connected&gt; pingPONG127.0.0.1:6379&gt; (now we are connected again) é‡æ–°è¿æ¥æ—¶ï¼Œredis-cliä¼šè‡ªåŠ¨é‡æ–°é€‰æ‹©æœ€åä¸€ä¸ªé€‰æ‹©çš„æ•°æ®åº“ç¼–å·ã€‚ ç„¶è€Œï¼Œå…³äºè¿æ¥çš„æ‰€æœ‰å…¶ä»–çŠ¶æ€éƒ½ä¼šä¸¢å¤±ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å¤„äºä¸­é—´çŠ¶æ€ï¼Œ12345678910$ redis-cli127.0.0.1:6379&gt; multi --æ ‡è®°ä¸€ä¸ªäº‹ç‰©å¼€å§‹OK127.0.0.1:6379&gt; pingQUEUED( here the server is manually restarted )127.0.0.1:6379&gt; exec(error) ERR EXEC without MULTI åœ¨äº¤äº’æ¨¡å¼ä¸‹ä½¿ç”¨CLIè¿›è¡Œæµ‹è¯•æ—¶ï¼Œè¿™é€šå¸¸ä¸æ˜¯é—®é¢˜ï¼Œä½†æ‚¨åº”è¯¥çŸ¥é“è¿™ä¸ªé™åˆ¶ã€‚ Editing, history and completionç”±äºredis-cliä½¿ç”¨linenoiseè¡Œç¼–è¾‘åº“ï¼Œå› æ­¤å®ƒæ€»æ˜¯å…·æœ‰è¡Œç¼–è¾‘åŠŸèƒ½ï¼Œè€Œä¸ä¾èµ–libreadlineæˆ–å…¶ä»–å¯é€‰åº“ã€‚ æ‚¨å¯ä»¥è®¿é—®å·²æ‰§è¡Œçš„å‘½ä»¤çš„å†å²è®°å½•ï¼Œä»¥ä¾¿é€šè¿‡æŒ‰æ–¹å‘é”®ï¼ˆå‘ä¸Šå’Œå‘ä¸‹ï¼‰æ¥é¿å…é‡å¤è¾“å…¥å®ƒä»¬ã€‚ åœ¨é€šè¿‡HOMEç¯å¢ƒå˜é‡æŒ‡å®šçš„ç”¨æˆ·ä¸»ç›®å½•å†…çš„.rediscli_historyæ–‡ä»¶ä¸­ï¼ŒCLIçš„é‡æ–°å¯åŠ¨ä¹‹é—´ä¿å­˜å†å²è®°å½•ã€‚ å¯ä»¥é€šè¿‡è®¾ç½®REDISCLI_HISTFILEç¯å¢ƒå˜é‡æ¥ä½¿ç”¨ä¸åŒçš„å†å²æ–‡ä»¶åï¼Œå¹¶é€šè¿‡å°†å…¶è®¾ç½®ä¸º/dev/nullæ¥ç¦ç”¨å®ƒã€‚ CLIä¹Ÿå¯ä»¥é€šè¿‡æŒ‰TABé”®æ‰§è¡Œå‘½ä»¤è¡¥å…¨ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š123127.0.0.1:6379&gt; Z&lt;TAB&gt;127.0.0.1:6379&gt; ZADD&lt;TAB&gt;127.0.0.1:6379&gt; ZCARD&lt;TAB&gt; Running the same command N timeså¯ä»¥é€šè¿‡åœ¨å‘½ä»¤åå‰æ·»åŠ ä¸€ä¸ªæ•°å­—æ¥å¤šæ¬¡è¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼š123456127.0.0.1:6379&gt; 5 incr mycounter(integer) 1(integer) 2(integer) 3(integer) 4(integer) 5 Showing help about Redis commandsRedis has a number of commands and sometimes, as you test things, you may not remember the exact order of arguments. redis-cli provides online help for most Redis commands, using the help command. The command can be used in two forms: help @ shows all the commands about a given category. The categories are: @generic, @list, @set, @sorted_set, @hash, @pubsub, @transactions, @connection, @server, @scripting, @hyperloglog.help shows specific help for the command given as argument.For example in order to show help for the PFADD command, use: 127.0.0.1:6379&gt; help PFADD PFADD key element [element â€¦] summary: Adds the specified elements to the specified HyperLogLog. since: 2.8.9 Note that help supports TAB completion as well. 123456789101112131415161718127.0.0.1:6381&gt; help @set SADD key member [member ...] summary: Add one or more members to a set since: 1.0.0 SCARD key summary: Get the number of members in a set since: 1.0.0 SDIFF key [key ...] summary: Subtract multiple sets since: 1.0.0 SDIFFSTORE destination key [key ...] summary: Subtract multiple sets and store the resulting set in a key since: 1.0.0... Clearing the terminal screen æ¸…å±1clear ç‰¹æ®Šçš„æ“ä½œæ¨¡å¼è‡³æ­¤æˆ‘ä»¬è§è¯†äº†redis-cliçš„ä¸¤ç§ä¸»è¦æ¨¡å¼ Rediså‘½ä»¤çš„å‘½ä»¤è¡Œæ‰§è¡Œã€‚ äº¤äº’å¼çš„â€œç±»ä¼¼REPLâ€çš„ç”¨æ³•ã€‚ However the CLI performs other auxiliary tasks related to Redis that are explained in the next sections: Monitoring tool to show continuous stats about a Redis server. ç›‘æ§å·¥å…· Scanning a Redis database for very large keys. æ‰«ædatabaseæ‰¾å‡ºvery large key Key space scanner with pattern matching. æ¨¡å¼åŒ¹é…æ‰«æ Acting as a Pub/Sub client to subscribe to channels. ä½œä¸ºPub/Sub clientè®¢é˜…é¢‘é“ Monitoring the commands executed into a Redis instance. ç›‘è§†æ‰§è¡Œåˆ°Rediså®ä¾‹ä¸­çš„å‘½ä»¤ Checking the latency of a Redis server in different ways. ä»¥ä¸åŒçš„æ–¹å¼æ£€æŸ¥RedisæœåŠ¡å™¨çš„å»¶è¿Ÿ Checking the scheduler latency of the local computer. æ£€æŸ¥æœ¬åœ°è®¡ç®—æœºçš„è°ƒåº¦ç¨‹åºå»¶è¿Ÿ Transferring RDB backups from a remote Redis server locally. ä»è¿œç¨‹RedisæœåŠ¡å™¨ä¼ è¾“RDBå¤‡ä»½åˆ°æœ¬åœ° Acting as a Redis slave for showing what a slave receives. æ‰®æ¼”Redisçš„slave,å±•ç¤ºslaveæ‰€æ¥å—çš„ä¸œè¥¿ Simulating LRU workloads for showing stats about keys hits. æ¨¡æ‹ŸLRUå·¥ä½œè´Ÿè½½æ˜¾ç¤ºæœ‰å…³keyså‘½ä¸­çš„ç»Ÿè®¡ä¿¡æ¯ A client for the Lua debugger. Continuous stats modeè¿™å¯èƒ½æ˜¯redis-cliçš„ä¸€ä¸ªé²œä¸ºäººçŸ¥çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå¹¶ä¸”ä¸ºäº†å®æ—¶ç›‘æ§Rediså®ä¾‹éå¸¸æœ‰ç”¨ã€‚ è¦å¯ç”¨æ­¤æ¨¡å¼ï¼Œä½¿ç”¨--staté€‰é¡¹ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒCLIçš„è¡Œä¸ºè¾“å‡ºå†…å®¹æ˜¾è€Œæ˜“è§ï¼š1234567891011$ redis-cli --stat------- data ------ --------------------- load -------------------- - child -keys mem clients blocked requests connections506 1015.00K 1 0 24 (+0) 7506 1015.00K 1 0 25 (+1) 7506 3.40M 51 0 60461 (+60436) 57506 3.40M 51 0 146425 (+85964) 107507 3.40M 51 0 233844 (+87419) 157507 3.40M 51 0 321715 (+87871) 207508 3.40M 51 0 408642 (+86927) 257508 3.40M 51 0 497038 (+88396) 257 åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¯ç§’é’Ÿéƒ½ä¼šæ‰“å°ä¸€è¡Œæ–°çš„ä¿¡æ¯ï¼Œå¹¶æ˜¾ç¤ºæ—§æ•°æ®ç‚¹ä¹‹é—´çš„å·®å¼‚ã€‚ æ‚¨å¯ä»¥è½»æ¾äº†è§£å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œè¿æ¥çš„å®¢æˆ·ç«¯ç­‰æƒ…å†µã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ-i &lt;é—´éš”&gt;é€‰é¡¹ä½œä¸ºä¿®æ”¹intervalã€‚ é»˜è®¤æ˜¯ä¸€ç§’é’Ÿã€‚ Scanning for big keysåœ¨è¿™ä¸ªç‰¹æ®Šçš„æ¨¡å¼ä¸‹ï¼Œredis-cliä½œä¸ºä¸€ä¸ªå…³é”®çš„ç©ºé—´åˆ†æå™¨ã€‚ å®ƒæ‰«æå¤§é”®çš„æ•°æ®é›†ï¼Œä½†ä¹Ÿæä¾›æœ‰å…³æ•°æ®é›†ç»„æˆçš„æ•°æ®ç±»å‹çš„ä¿¡æ¯ã€‚ ä½¿ç”¨--bigkeysé€‰é¡¹å¯ç”¨æ­¤æ¨¡å¼ï¼Œå¹¶ç”Ÿæˆç›¸å½“è¯¦ç»†çš„è¾“å‡ºï¼š12345678910111213141516171819202122232425$ redis-cli --bigkeys# Scanning the entire keyspace to find biggest keys as well as# average sizes per key type. You can use -i 0.1 to sleep 0.1 sec# per 100 SCAN commands (not usually needed).[00.00%] Biggest string found so far &#x27;key-419&#x27; with 3 bytes[05.14%] Biggest list found so far &#x27;mylist&#x27; with 100004 items[35.77%] Biggest string found so far &#x27;counter:__rand_int__&#x27; with 6 bytes[73.91%] Biggest hash found so far &#x27;myobject&#x27; with 3 fields-------- summary -------Sampled 506 keys in the keyspace!Total key length in bytes is 3452 (avg len 6.82)Biggest string found &#x27;counter:__rand_int__&#x27; has 6 bytesBiggest list found &#x27;mylist&#x27; has 100004 itemsBiggest hash found &#x27;myobject&#x27; has 3 fields504 strings with 1403 bytes (99.60% of keys, avg size 2.78)1 lists with 100004 items (00.20% of keys, avg size 100004.00)0 sets with 0 members (00.00% of keys, avg size 0.00)1 hashs with 3 fields (00.20% of keys, avg size 3.00)0 zsets with 0 members (00.00% of keys, avg size 0.00)åœ¨è¾“å‡ºçš„ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼ŒæŠ¥å‘Šæ¯ä¸ªå¤§äºå‰ä¸€ä¸ªè¾ƒå¤§é”®ï¼ˆç›¸åŒç±»å‹ï¼‰çš„æ–°é”®ã€‚ æ‘˜è¦éƒ¨åˆ†æä¾›æœ‰å…³Rediså®ä¾‹å†…æ•°æ®çš„ä¸€èˆ¬ç»Ÿè®¡ä¿¡æ¯ã€‚ è¯¥ç¨‹åºä½¿ç”¨SCANå‘½ä»¤ï¼Œå› æ­¤å¯ä»¥åœ¨ç¹å¿™çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œè€Œä¸ä¼šå½±å“æ“ä½œï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨-ié€‰é¡¹æ¥é™åˆ¶æ‰€è¯·æ±‚çš„æ¯ä¸ª100ä¸ªé”®çš„æŒ‡å®šç§’æ•°çš„æ‰«æè¿›ç¨‹ã€‚ ä¾‹å¦‚ï¼Œ-i 0.1ä¼šå‡æ…¢ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦ï¼Œä½†ä¹Ÿä¼šå°†æœåŠ¡å™¨ä¸Šçš„è´Ÿè½½å‡å°‘åˆ°å¾ˆå°çš„æ•°é‡ã€‚ è¯·æ³¨æ„ï¼Œæ‘˜è¦è¿˜ä¼šä»¥æ›´æ¸…æ™°çš„å½¢å¼æŠ¥å‘Šæ¯æ¬¡å‘ç°çš„æœ€å¤§å¯†é’¥ã€‚ å¦‚æœå¯¹ä¸€ä¸ªéå¸¸å¤§çš„æ•°æ®é›†è¿è¡Œï¼Œæœ€åˆçš„è¾“å‡ºåªæ˜¯æä¾›ä¸€äº›æœ‰è¶£çš„ä¿¡æ¯ã€‚ Getting a list of keysä¹Ÿå¯ä»¥æ‰«ækeyç©ºé—´ï¼Œå†æ¬¡ä»¥ä¸é˜»å¡RedisæœåŠ¡å™¨çš„æ–¹å¼ï¼ˆå½“æ‚¨ä½¿ç”¨è¯¸å¦‚KEYS *ä¹‹ç±»çš„å‘½ä»¤æ—¶å‘ç”Ÿè¿™ç§æƒ…å†µï¼‰ï¼Œæ‰“å°æ‰€æœ‰çš„é”®åï¼Œæˆ–è€…å¯¹ç‰¹å®šçš„æ¨¡å¼è¿›è¡Œè¿‡æ»¤ã€‚ ä¸-bigkeysé€‰é¡¹ä¸€æ ·ï¼Œæ­¤æ¨¡å¼ä½¿ç”¨SCANå‘½ä»¤ï¼Œå› æ­¤ï¼Œå¦‚æœæ•°æ®é›†æ­£åœ¨æ›´æ”¹ï¼Œå¯èƒ½ä¼šå¤šæ¬¡æŠ¥å‘Šé”®ï¼Œä½†æ˜¯å¦‚æœä»è¿­ä»£å¼€å§‹ä»¥æ¥å­˜åœ¨è¯¥é”®ï¼Œåˆ™ä¸ä¼šä¸¢å¤±é”®ã€‚ ç”±äºå®ƒä½¿ç”¨è¿™ä¸ªé€‰é¡¹çš„å‘½ä»¤å«åš--scanã€‚ 1234567891011$ redis-cli --scan | head -10key-419key-71key-236key-50key-38key-458key-453key-499key-446key-371 --patternæ¨¡å¼åŒ¹é…123456789101112$ redis-cli --scan --pattern &#x27;*-11*&#x27;key-114key-117key-118key-113key-115key-112key-119key-11key-111key-110key-116 Piping the output through the wc command can be used to count specific kind of objects, by key name:12$ redis-cli --scan --pattern &#x27;user:*&#x27; | wc -l3829433 Pub/sub modeThe CLI is able to publish messages in Redis Pub/Sub channels just using the PUBLISH command. This is expected since the PUBLISH command is very similar to any other command. Subscribing to channels in order to receive messages is different - in this case we need to block and wait for messages, so this is implemented as a special mode in redis-cli. Unlike other special modes this mode is not enabled by using a special option, but simply by using the SUBSCRIBE or PSUBSCRIBE command, both in interactive or non interactive mode: 123456789101112131415161718192021222324252627282930[root@cn_mu_binlog_backup ~]# redis-cli -p 6381 psubscribe &#x27;*&#x27;Reading messages... (press Ctrl-C to quit)1) &quot;psubscribe&quot;2) &quot;*&quot;3) (integer) 11) &quot;pmessage&quot;2) &quot;*&quot;3) &quot;__sentinel__:hello&quot;4) &quot;127.0.0.1,26381,3ad32fcf6646f1e65f75f1309fe858a66237a590,3,mymaster,127.0.0.1,6381,3&quot;1) &quot;pmessage&quot;2) &quot;*&quot;3) &quot;__sentinel__:hello&quot;4) &quot;127.0.0.1,26379,6db624d52ea9a46b76c996532de0d3b874011aef,3,mymaster,127.0.0.1,6381,3&quot;1) &quot;pmessage&quot;2) &quot;*&quot;3) &quot;__sentinel__:hello&quot;4) &quot;127.0.0.1,26380,55b2bbd5f4ca70d5bbb8fb019b645eaf39fb5e66,3,mymaster,127.0.0.1,6381,3&quot;1) &quot;pmessage&quot;2) &quot;*&quot;3) &quot;__sentinel__:hello&quot;4) &quot;127.0.0.1,26381,3ad32fcf6646f1e65f75f1309fe858a66237a590,3,mymaster,127.0.0.1,6381,3&quot;1) &quot;pmessage&quot;2) &quot;*&quot;3) &quot;__sentinel__:hello&quot;4) &quot;127.0.0.1,26379,6db624d52ea9a46b76c996532de0d3b874011aef,3,mymaster,127.0.0.1,6381,3&quot;1) &quot;pmessage&quot;2) &quot;*&quot;3) &quot;__sentinel__:hello&quot;4) &quot;127.0.0.1,26380,55b2bbd5f4ca70d5bbb8fb019b645eaf39fb5e66,3,mymaster,127.0.0.1,6381,3&quot;^C This is very useful for debugging Pub/Sub issues. To exit the Pub/Sub mode just process CTRL-C. Monitoring commands executed in RedisSimilarly to the Pub/Sub mode, the monitoring mode is entered automatically once you use the MONITOR mode. It will print all the commands received by a Redis instance:1234$ redis-cli monitorOK1460100081.165665 [0 127.0.0.1:51706] &quot;set&quot; &quot;foo&quot; &quot;bar&quot;1460100083.053365 [0 127.0.0.1:51707] &quot;get&quot; &quot;foo&quot; Monitoring the latency of Redis instancesRedisç»å¸¸ç”¨åœ¨å»¶è¿Ÿéå¸¸å…³é”®çš„ç¯å¢ƒä¸­ã€‚ å»¶è¿Ÿæ¶‰åŠåº”ç”¨ç¨‹åºä¸­çš„å¤šä¸ªç§»åŠ¨éƒ¨åˆ†ï¼Œä»å®¢æˆ·ç«¯åº“åˆ°ç½‘ç»œå †æ ˆï¼Œç›´åˆ°Rediså®ä¾‹æœ¬èº«ã€‚ CLIå…·æœ‰å¤šä¸ªå·¥å…·æ¥ç ”ç©¶Rediså®ä¾‹çš„å»¶è¿Ÿï¼Œå¹¶äº†è§£å»¶è¿Ÿçš„æœ€å¤§å€¼ï¼Œå¹³å‡å€¼å’Œåˆ†å¸ƒã€‚ åŸºæœ¬çš„å»¶è¿Ÿæ£€æŸ¥å·¥å…·æ˜¯â€“latencyé€‰é¡¹ã€‚ ä½¿ç”¨æ­¤é€‰é¡¹ï¼ŒCLIè¿è¡Œä¸€ä¸ªå¾ªç¯ï¼Œå°†PINGå‘½ä»¤å‘é€åˆ°Rediså®ä¾‹ï¼Œå¹¶æµ‹é‡è·å¾—ç­”å¤çš„æ—¶é—´ã€‚ è¿™ç§æƒ…å†µæ¯ç§’å‘ç”Ÿ100æ¬¡ï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨æ§åˆ¶å°ä¸­å®æ—¶æ›´æ–°ï¼š12$ redis-cli --latencymin: 0, max: 1, avg: 0.19 (427 samples) ç»Ÿè®¡æ•°æ®ä»¥æ¯«ç§’æä¾›ã€‚ é€šå¸¸ï¼Œç”±äºè¿è¡Œredis-cliæœ¬èº«çš„ç³»ç»Ÿçš„å†…æ ¸è°ƒåº¦ç¨‹åºå¯¼è‡´å»¶è¿Ÿï¼Œæ‰€ä»¥ä¸€ä¸ªéå¸¸å¿«çš„å®ä¾‹çš„å¹³å‡å»¶è¿Ÿå¾€å¾€è¢«é«˜ä¼°äº†ä¸€ç‚¹ï¼Œæ‰€ä»¥0.19ä»¥ä¸Šçš„å¹³å‡å»¶è¿Ÿå¯èƒ½å¾ˆå®¹æ˜“ä¸º0.01æˆ–æ›´å°ã€‚ ç„¶è€Œï¼Œè¿™é€šå¸¸ä¸æ˜¯ä¸€ä¸ªå¤§é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬å¯¹å‡ æ¯«ç§’ç”šè‡³æ›´é•¿æ—¶é—´çš„äº‹ä»¶æ„Ÿå…´è¶£ã€‚ æœ‰æ—¶ç ”ç©¶æœ€å¤§å’Œå¹³å‡æ½œä¼æœŸå¦‚ä½•æ¼”å˜æ˜¯æœ‰ç”¨çš„ã€‚ --latency-historyé€‰é¡¹ç”¨äºæ­¤ç›®çš„ï¼šå®ƒçš„å·¥ä½œæ–¹å¼ä¸â€“latencyå®Œå…¨ç›¸åŒï¼Œä½†æ˜¯æ¯15ç§’ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰å°†ä»å¤´å¼€å§‹ä¸€ä¸ªæ–°çš„é‡‡æ ·ä¼šè¯ï¼š1234$ redis-cli --latency-historymin: 0, max: 1, avg: 0.14 (1314 samples) -- 15.01 seconds rangemin: 0, max: 1, avg: 0.18 (1299 samples) -- 15.00 seconds rangemin: 0, max: 1, avg: 0.20 (113 samples)^C æ‚¨å¯ä»¥ä½¿ç”¨-i &lt;é—´éš”&gt;é€‰é¡¹æ›´æ”¹é‡‡æ ·ä¼šè¯çš„é•¿åº¦ã€‚ æœ€å…ˆè¿›çš„ç­‰å¾…æ—¶é—´ç ”ç©¶å·¥å…·ï¼Œå¯¹äºæ²¡æœ‰ç»éªŒçš„ç”¨æˆ·æ¥è¯´ä¹Ÿæœ‰ç‚¹éš¾è§£é‡Šï¼Œæ˜¯ä½¿ç”¨å½©è‰²ç»ˆç«¯æ˜¾ç¤ºä¸€ç³»åˆ—ç­‰å¾…æ—¶é—´çš„èƒ½åŠ›ã€‚ æ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ªå½©è‰²è¾“å‡ºï¼ŒæŒ‡ç¤ºä¸åŒç™¾åˆ†æ¯”çš„æ ·æœ¬ï¼Œä»¥åŠæŒ‡ç¤ºä¸åŒå»¶è¿Ÿæ•°å­—çš„ä¸åŒASCIIå­—ç¬¦ã€‚ è¯¥æ¨¡å¼ä½¿ç”¨â€“latency-disté€‰é¡¹å¯ç”¨ï¼š åœ¨redis-cliä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸ä¸å¯»å¸¸çš„å»¶è¿Ÿå·¥å…·ã€‚ å®ƒä¸ä¼šæ£€æŸ¥Rediså®ä¾‹çš„å»¶è¿Ÿï¼Œè€Œæ˜¯æ£€æŸ¥è¿è¡Œredis-cliçš„è®¡ç®—æœºçš„å»¶è¿Ÿã€‚ ä½ å¯èƒ½ä¼šé—®ä»€ä¹ˆå»¶è¿Ÿï¼Ÿ å†…æ ¸è°ƒåº¦ç¨‹åºå›ºæœ‰çš„å»¶è¿Ÿï¼Œè™šæ‹ŸåŒ–å®ä¾‹æƒ…å†µä¸‹çš„ç®¡ç†ç¨‹åºç­‰ç­‰ã€‚ æˆ‘ä»¬ç§°ä¹‹ä¸ºå†…éƒ¨å»¶è¿Ÿï¼Œå› ä¸ºå¤§å¤šæ•°ç¨‹åºå‘˜å¯¹å®ƒæ˜¯ä¸é€æ˜çš„ã€‚ å¦‚æœæ‚¨çš„Rediså®ä¾‹çš„å»¶è¿Ÿæ—¶é—´å¾ˆé•¿ï¼Œè€Œä¸è€ƒè™‘æ‰€æœ‰å¯èƒ½çš„åŸå› ï¼Œé‚£ä¹ˆé€šè¿‡åœ¨è¿è¡ŒRedisæœåŠ¡å™¨çš„ç³»ç»Ÿä¸­ç›´æ¥è¿è¡Œæ­¤ç‰¹æ®Šæ¨¡å¼ä¸‹çš„redis-cliï¼Œå¯ä»¥æ£€æŸ¥ç³»ç»Ÿçš„æœ€ä½³æ€§èƒ½ã€‚ é€šè¿‡æµ‹é‡å†…åœ¨çš„å»¶è¿Ÿï¼Œä½ çŸ¥é“è¿™æ˜¯åŸºå‡†ï¼ŒRedisä¸èƒ½è¶…è¶Šä½ çš„ç³»ç»Ÿã€‚ ä¸ºäº†åœ¨æ­¤æ¨¡å¼ä¸‹è¿è¡ŒCLIï¼Œè¯·ä½¿ç”¨--intrinsic-latency &lt;test-time&gt;ã€‚ æµ‹è¯•çš„æ—¶é—´ä»¥ç§’ä¸ºå•ä½ï¼Œå¹¶æŒ‡å®šredis-cliåº”è¯¥æ£€æŸ¥å½“å‰æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿçš„å»¶è¿Ÿæ—¶é—´ã€‚1234567891011121314$ redis-cli --intrinsic-latency 5Max latency so far: 1 microseconds.Max latency so far: 7 microseconds.Max latency so far: 9 microseconds.Max latency so far: 11 microseconds.Max latency so far: 13 microseconds.Max latency so far: 15 microseconds.Max latency so far: 34 microseconds.Max latency so far: 82 microseconds.Max latency so far: 586 microseconds.Max latency so far: 739 microseconds.65433042 total runs (avg latency: 0.0764 microseconds / 764.14 nanoseconds per run).Worst run took 9671x longer than the average latency. é‡è¦ä¿¡æ¯ï¼šå¿…é¡»åœ¨è¦è¿è¡ŒRedisæœåŠ¡å™¨çš„è®¡ç®—æœºä¸Šæ‰§è¡Œæ­¤å‘½ä»¤ï¼Œè€Œä¸æ˜¯åœ¨ä¸åŒçš„ä¸»æœºä¸Šè¿è¡Œã€‚ å®ƒç”šè‡³ä¸è¿æ¥åˆ°Rediså®ä¾‹ï¼Œåªåœ¨æœ¬åœ°æ‰§è¡Œæµ‹è¯•ã€‚ åœ¨ä¸Šè¿°æƒ…å†µä¸‹ï¼Œæˆ‘çš„ç³»ç»Ÿä¸èƒ½æ¯”739å¾®ç§’çš„æœ€åæƒ…å†µå»¶è¿Ÿæ›´å¥½ï¼Œæ‰€ä»¥æˆ‘é¢„è®¡æŸäº›æŸ¥è¯¢å¯èƒ½ä¼šåœ¨ä¸åˆ°1æ¯«ç§’çš„æ—¶é—´å†…è¿è¡Œã€‚ Remote backups of RDB filesåœ¨Rediså¤åˆ¶çš„ç¬¬ä¸€æ¬¡åŒæ­¥æœŸé—´ï¼Œä¸»è®¾å¤‡å’Œä»è®¾å¤‡ä»¥RDBæ–‡ä»¶çš„å½¢å¼äº¤æ¢æ•´ä¸ªæ•°æ®é›†ã€‚ redis-cliåˆ©ç”¨æ­¤åŠŸèƒ½æ¥æä¾›è¿œç¨‹å¤‡ä»½åŠŸèƒ½ï¼Œå…è®¸ä»ä»»ä½•Rediså®ä¾‹å°†RDBæ–‡ä»¶ä¼ è¾“åˆ°è¿è¡Œredis-cliçš„æœ¬åœ°è®¡ç®—æœºã€‚ è¦ä½¿ç”¨æ­¤æ¨¡å¼ï¼Œè¯·ä½¿ç”¨--rdb &lt;dest-filename&gt;é€‰é¡¹è°ƒç”¨CLIï¼š123$ redis-cli --rdb /tmp/dump.rdbSYNC sent to master, writing 13256 bytes to &#x27;/tmp/dump.rdb&#x27;Transfer finished with success.è¿™æ˜¯ç¡®ä¿æ‚¨æ‹¥æœ‰Rediså®ä¾‹çš„ç¾éš¾æ¢å¤RDBå¤‡ä»½çš„ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œåœ¨è„šæœ¬æˆ–cronä½œä¸šä¸­ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œè¯·ç¡®ä¿æ£€æŸ¥å‘½ä»¤çš„è¿”å›å€¼ã€‚ å¦‚æœä¸ä¸ºé›¶ï¼Œåˆ™å‘ç”Ÿå¦‚ä¸‹ä¾‹æ‰€ç¤ºçš„é”™è¯¯ï¼š1234$ redis-cli --rdb /tmp/dump.rdbSYNC with master failed: -ERR Can&#x27;t SYNC while not connected with my master$ echo $?1 Slave modeCLIçš„slaveæ¨¡å¼æ˜¯ç”¨äºRediså¼€å‘äººå‘˜å’Œè°ƒè¯•æ“ä½œçš„é«˜çº§åŠŸèƒ½ 123456789è¿™è¾¹è·‘ç€,åŒæ—¶ä¸»åº“æ‰§è¡Œset foo bar$ redis-cli --slaveSYNC with master, discarding 13256 bytes of bulk transfer...SYNC done. Logging commands from master.&quot;PING&quot;&quot;SELECT&quot;,&quot;0&quot;&quot;set&quot;,&quot;foo&quot;,&quot;bar&quot;&quot;PING&quot;&quot;incr&quot;,&quot;mycounter&quot; è¯¥å‘½ä»¤é¦–å…ˆä¸¢å¼ƒç¬¬ä¸€ä¸ªåŒæ­¥çš„RDBæ–‡ä»¶ï¼Œç„¶åä»¥CSVæ ¼å¼è®°å½•æ¯ä¸ªæ”¶åˆ°çš„å‘½ä»¤ã€‚ å¦‚æœæ‚¨è®¤ä¸ºæŸäº›å‘½ä»¤åœ¨æ‚¨çš„ä»ç«™ä¸­æ²¡æœ‰è¢«æ­£ç¡®å¤åˆ¶ï¼Œé‚£ä¹ˆè¿™æ˜¯æ£€æŸ¥å‘ç”Ÿäº†ä»€ä¹ˆçš„å¥½æ–¹æ³•ï¼Œä¹Ÿæ˜¯æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä»¥ä¾¿æ”¹è¿›é”™è¯¯æŠ¥å‘Šã€‚ Performing an LRU simulationRedisé€šå¸¸ç”¨ä½œLRUé©±é€çš„ç¼“å­˜ã€‚æ ¹æ®keysçš„æ•°é‡å’Œä¸ºç¼“å­˜åˆ†é…çš„å†…å­˜é‡ï¼ˆé€šè¿‡maxmemoryæŒ‡ä»¤æŒ‡å®šï¼‰ï¼Œç¼“å­˜å‘½ä¸­å’Œæœªå‘½ä¸­çš„æ•°é‡å°†ä¼šæ”¹å˜ã€‚æœ‰æ—¶ï¼Œæ¨¡æ‹Ÿå‘½ä¸­ç‡å¯¹æ­£ç¡®è®¾ç½®ç¼“å­˜éå¸¸æœ‰ç”¨ã€‚ CLIæœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ¨¡å¼ï¼Œå®ƒæ‰§è¡ŒGETå’ŒSETæ“ä½œçš„æ¨¡æ‹Ÿï¼Œåœ¨è¯·æ±‚æ¨¡å¼ä¸­ä½¿ç”¨80-20ï¼…çš„å¹‚å¾‹åˆ†å¸ƒã€‚è¿™æ„å‘³ç€20ï¼…çš„keyså°†è¢«è¯·æ±‚80ï¼…çš„æ—¶é—´ï¼Œè¿™æ˜¯ç¼“å­˜åœºæ™¯ä¸­çš„æ™®éåˆ†å¸ƒã€‚ ä»ç†è®ºä¸Šè®²ï¼Œè€ƒè™‘åˆ°è¯·æ±‚åˆ†å¸ƒå’ŒRediså†…å­˜å¼€é”€ï¼Œåº”è¯¥å¯ä»¥ç”¨æ•°å­¦å…¬å¼åˆ†æè®¡ç®—å‘½ä¸­ç‡ã€‚ä½†æ˜¯ï¼ŒRediså¯ä»¥é…ç½®ä¸åŒçš„LRUè®¾ç½®ï¼ˆæ ·æœ¬æ•°é‡ï¼‰ï¼ŒLRUçš„å®ç°ï¼ˆåœ¨Redisä¸­è¿‘ä¼¼ï¼‰åœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´ä¼šå‘ç”Ÿå¾ˆå¤§çš„å˜åŒ–ã€‚ç±»ä¼¼çš„ï¼Œæ¯ä¸ªå†…å­˜çš„æ•°é‡å¯èƒ½ä¼šåœ¨ä¸åŒçš„ç‰ˆæœ¬ä¹‹é—´æ”¹å˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªå·¥å…·æ˜¯å»ºç«‹èµ·æ¥çš„ï¼šå®ƒçš„ä¸»è¦åŠ¨æœºæ˜¯æµ‹è¯•Redisçš„LRUå®ç°çš„è´¨é‡ï¼Œä½†æ˜¯ç°åœ¨ä¹Ÿå¯ä»¥ç”¨æ¥æµ‹è¯•ä¸€ä¸ªç»™å®šçš„ç‰ˆæœ¬å¦‚ä½•ä¸ä½ æƒ³è¦éƒ¨ç½²çš„æƒ³æ³•ä¸€è‡´ã€‚ ä¸ºäº†ä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œä½ éœ€è¦åœ¨æµ‹è¯•ä¸­æŒ‡å®škeysçš„æ•°é‡ã€‚æ‚¨è¿˜éœ€è¦é…ç½®ä¸€ä¸ªæœ‰æ„ä¹‰çš„maxmemoryè®¾ç½®ä½œä¸ºç¬¬ä¸€æ¬¡å°è¯•ã€‚ é‡è¦æ³¨æ„äº‹é¡¹ï¼šåœ¨Redisé…ç½®ä¸­é…ç½®maxmemoryè®¾ç½®æ˜¯è‡³å…³é‡è¦çš„ï¼šå¦‚æœæœ€å¤§å†…å­˜ä½¿ç”¨é‡æ²¡æœ‰ä¸Šé™ï¼Œåˆ™æœ€ç»ˆå‘½ä¸­ç‡å°†ä¸º100ï¼…ï¼Œå› ä¸ºæ‰€æœ‰çš„keyséƒ½å¯ä»¥å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚æˆ–è€…å¦‚æœä½ æŒ‡å®šäº†å¤ªå¤šçš„keyså¹¶ä¸”æ²¡æœ‰æœ€å¤§çš„å†…å­˜ï¼Œæœ€ç»ˆæ‰€æœ‰çš„è®¡ç®—æœºRAMéƒ½å°†è¢«ä½¿ç”¨ã€‚è¿˜éœ€è¦é…ç½®ä¸€ä¸ªé€‚å½“çš„maxmemoryç­–ç•¥ï¼Œå¤§å¤šæ•°æ—¶å€™ä½ æƒ³è¦çš„æ˜¯allkeys-lruã€‚ åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘é…ç½®äº†ä¸€ä¸ª100MBçš„å†…å­˜é™åˆ¶å’Œä¸€ä¸ª1000ä¸‡keysçš„LRUæ¨¡æ‹Ÿã€‚ è­¦å‘Šï¼šæµ‹è¯•ä½¿ç”¨æµæ°´çº¿å¹¶å°†å‹åŠ›æœåŠ¡å™¨ï¼Œä¸è¦ä¸ç”Ÿäº§å®ä¾‹ä¸€èµ·ä½¿ç”¨ã€‚123456789$ ./redis-cli --lru-test 10000000156000 Gets/sec | Hits: 4552 (2.92%) | Misses: 151448 (97.08%)153750 Gets/sec | Hits: 12906 (8.39%) | Misses: 140844 (91.61%)159250 Gets/sec | Hits: 21811 (13.70%) | Misses: 137439 (86.30%)151000 Gets/sec | Hits: 27615 (18.29%) | Misses: 123385 (81.71%)145000 Gets/sec | Hits: 32791 (22.61%) | Misses: 112209 (77.39%)157750 Gets/sec | Hits: 42178 (26.74%) | Misses: 115572 (73.26%)154500 Gets/sec | Hits: 47418 (30.69%) | Misses: 107082 (69.31%)151250 Gets/sec | Hits: 51636 (34.14%) | Misses: 99614 (65.86%)è¯¥ç¨‹åºæ¯ç§’æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ã€‚ å¦‚æ‚¨æ‰€è§ï¼Œåœ¨ç¬¬ä¸€ç§’é’Ÿå†…ç¼“å­˜å¼€å§‹è¢«å¡«å……ã€‚ åæ¥çš„å¤±è¯¯ç‡ç¨³å®šåœ¨æˆ‘ä»¬å¯ä»¥é¢„æœŸçš„å®é™…æ•°å­—ä¸Šï¼š1234120750 Gets/sec | Hits: 48774 (40.39%) | Misses: 71976 (59.61%)122500 Gets/sec | Hits: 49052 (40.04%) | Misses: 73448 (59.96%)127000 Gets/sec | Hits: 50870 (40.06%) | Misses: 76130 (59.94%)124250 Gets/sec | Hits: 50147 (40.36%) | Misses: 74103 (59.64%)å¯¹äºæˆ‘ä»¬çš„ç”¨ä¾‹ï¼Œ59ï¼…çš„æœªå‘½ä¸­ç‡å¯èƒ½æ˜¯ä¸å¯æ¥å—çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬çŸ¥é“100MBçš„å†…å­˜æ˜¯ä¸å¤Ÿçš„ã€‚ è®©æˆ‘ä»¬è¯•è¯•500Mã€‚ å‡ åˆ†é’Ÿåï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è¾“å‡ºç¨³å®šåˆ°ä»¥ä¸‹æ•°å­—ï¼š1234140000 Gets/sec | Hits: 135376 (96.70%) | Misses: 4624 (3.30%)141250 Gets/sec | Hits: 136523 (96.65%) | Misses: 4727 (3.35%)140250 Gets/sec | Hits: 135457 (96.58%) | Misses: 4793 (3.42%)140500 Gets/sec | Hits: 135947 (96.76%) | Misses: 4553 (3.24%)æ‰€ä»¥æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨500MBçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„å¯†é’¥æ•°é‡ï¼ˆ1000ä¸‡ï¼‰å’Œåˆ†å¸ƒï¼ˆ80-20æ ·å¼ï¼‰å·²ç»è¶³å¤Ÿå¥½äº†ã€‚","categories":[],"tags":[{"name":"Redis","slug":"Redis","permalink":"http://fuxkdb.com/tags/Redis/"},{"name":"redis-cli","slug":"redis-cli","permalink":"http://fuxkdb.com/tags/redis-cli/"}]},{"title":"è‡ªå®šä¹‰å‡½æ•°æ”¹è¡¨å…³è”ä¼˜åŒ–ä¸€ä¾‹","slug":"è‡ªå®šä¹‰å‡½æ•°æ”¹è¡¨å…³è”ä¼˜åŒ–ä¸€ä¾‹","date":"2017-12-28T10:05:00.000Z","updated":"2017-12-28T10:13:35.000Z","comments":true,"path":"2017/12/28/è‡ªå®šä¹‰å‡½æ•°æ”¹è¡¨å…³è”ä¼˜åŒ–ä¸€ä¾‹/","link":"","permalink":"http://fuxkdb.com/2017/12/28/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E6%94%B9%E8%A1%A8%E5%85%B3%E8%81%94%E4%BC%98%E5%8C%96%E4%B8%80%E4%BE%8B/","excerpt":"ä»Šå¤©æœ‹å‹ä¸¢æ¥ä¸€ä¸ªSQL,å«æˆ‘å¸®å¿™ä¼˜åŒ–ä¸€ä¸‹.å—è¿‡è½æ€»çœŸä¼ ,æˆ‘ç„äº†å‡ çœ¼å°±çŸ¥é“å’‹å›äº‹äº† 123456789101112131415161718192021222324252627282930313233343536SELECT ESS.PK_NO, HE.EMPID, HE.LOCAL_NAME, ESS.ITEM_NO ITEM_NO_NO, ESS.PERSON_ID, GET_DEPT_NAME(HE.DEPTNO, &#x27;zh&#x27;) DEPT_NAME, GET_GLOBAL_NAME(ESS.ITEM_NO, &#x27;zh&#x27;) ITEM_NAME, ESS.AR_DATE_STR, TO_CHAR(ESS.FROM_TIME, &#x27;HH24:MI&#x27;) FROM_TIME, TO_CHAR(ESS.TO_TIME, &#x27;HH24:MI&#x27;) TO_TIME, ESS.QUANTITY, ESS.REMARK, HE.EMPID, ESS.AR_DATE_STR, GET_GLOBAL_NAME(ESS.STATUS_CODE, &#x27;zh&#x27;) STATUS_CODE, GET_GLOBAL_NAME(ESS.ITEM_NO, &#x27;zh&#x27;) ITEM_NO, ESS.REMARK, ESS.LOCK_YN FROM AR_DETAIL_HYOSUNG_JX ESS, HR_EMPLOYEE HE WHERE ESS.PERSON_ID = HE.PERSON_ID AND ESS.PERSON_ID NOT LIKE &#x27;111111%&#x27; AND ESS.ITEM_NO IN (&#x27;141454&#x27;, &#x27;14015951&#x27;, &#x27;141445&#x27;, &#x27;141443&#x27;, &#x27;190000514&#x27;) AND EXISTS (SELECT B1.DEPTID FROM HR_DEPARTMENT B1 WHERE B1.DEPTNO = HE.DEPTNO START WITH B1.DEPTNO in (SELECT HRD.DEPTID FROM HR_DEPARTMENT HRD WHERE HRD.MANAGER_EMP_ID = &#x27;11111117&#x27;) CONNECT BY PRIOR B1.DEPTNO = B1.PARENT_DEPT_NO UNION SELECT AR_SUPERVISOR_INFO.DEPTNO FROM AR_SUPERVISOR_INFO WHERE AR_SUPERVISOR_INFO.DEPTNO = HE.DEPTNO AND AR_SUPERVISOR_INFO.PERSON_ID = &#x27;11111117&#x27;) ORDER BY ESS.AR_DATE_STR ASC, ESS.CREATE_DATE DESC, HE.DEPTNO, HE.EMPID æˆ‘è®©ä»–å…ˆæ‰§è¡Œä¸€ä¸‹SQL çœ‹çœ‹å‡ ç§’,ä»–è¯´6ç§’OK,å†æŠŠselect é‡Œé¢é‚£ä¿©è‡ªå®šä¹‰å‡½æ•°GET_DEPT_NAME,GET_GLOBAL_NAME æ³¨é‡Šæ‰æŸ¥ä¸€ä¸‹, ä»–è¯´1.5ç§’é‚£è¿™ä¸ªSQLå°±æ˜¯æ…¢åœ¨è¿™ä¿©è‡ªå®šä¹‰å‡½æ•°ä¸Šå‘—, è¿™ä¸ªæŸ¥è¯¢æ¯è¿”å›ä¸€è¡Œ,è¿™å‡½æ•°å°±è¦æ‰§è¡Œä¸€æ¬¡é‚£ä¹ˆå‡½æ•°å¯ä»¥æ”¹æˆ æ ‡é‡ , æ ‡é‡å¯ä»¥æ”¹æˆ letf join.","text":"ä»Šå¤©æœ‹å‹ä¸¢æ¥ä¸€ä¸ªSQL,å«æˆ‘å¸®å¿™ä¼˜åŒ–ä¸€ä¸‹.å—è¿‡è½æ€»çœŸä¼ ,æˆ‘ç„äº†å‡ çœ¼å°±çŸ¥é“å’‹å›äº‹äº† 123456789101112131415161718192021222324252627282930313233343536SELECT ESS.PK_NO, HE.EMPID, HE.LOCAL_NAME, ESS.ITEM_NO ITEM_NO_NO, ESS.PERSON_ID, GET_DEPT_NAME(HE.DEPTNO, &#x27;zh&#x27;) DEPT_NAME, GET_GLOBAL_NAME(ESS.ITEM_NO, &#x27;zh&#x27;) ITEM_NAME, ESS.AR_DATE_STR, TO_CHAR(ESS.FROM_TIME, &#x27;HH24:MI&#x27;) FROM_TIME, TO_CHAR(ESS.TO_TIME, &#x27;HH24:MI&#x27;) TO_TIME, ESS.QUANTITY, ESS.REMARK, HE.EMPID, ESS.AR_DATE_STR, GET_GLOBAL_NAME(ESS.STATUS_CODE, &#x27;zh&#x27;) STATUS_CODE, GET_GLOBAL_NAME(ESS.ITEM_NO, &#x27;zh&#x27;) ITEM_NO, ESS.REMARK, ESS.LOCK_YN FROM AR_DETAIL_HYOSUNG_JX ESS, HR_EMPLOYEE HE WHERE ESS.PERSON_ID = HE.PERSON_ID AND ESS.PERSON_ID NOT LIKE &#x27;111111%&#x27; AND ESS.ITEM_NO IN (&#x27;141454&#x27;, &#x27;14015951&#x27;, &#x27;141445&#x27;, &#x27;141443&#x27;, &#x27;190000514&#x27;) AND EXISTS (SELECT B1.DEPTID FROM HR_DEPARTMENT B1 WHERE B1.DEPTNO = HE.DEPTNO START WITH B1.DEPTNO in (SELECT HRD.DEPTID FROM HR_DEPARTMENT HRD WHERE HRD.MANAGER_EMP_ID = &#x27;11111117&#x27;) CONNECT BY PRIOR B1.DEPTNO = B1.PARENT_DEPT_NO UNION SELECT AR_SUPERVISOR_INFO.DEPTNO FROM AR_SUPERVISOR_INFO WHERE AR_SUPERVISOR_INFO.DEPTNO = HE.DEPTNO AND AR_SUPERVISOR_INFO.PERSON_ID = &#x27;11111117&#x27;) ORDER BY ESS.AR_DATE_STR ASC, ESS.CREATE_DATE DESC, HE.DEPTNO, HE.EMPID æˆ‘è®©ä»–å…ˆæ‰§è¡Œä¸€ä¸‹SQL çœ‹çœ‹å‡ ç§’,ä»–è¯´6ç§’OK,å†æŠŠselect é‡Œé¢é‚£ä¿©è‡ªå®šä¹‰å‡½æ•°GET_DEPT_NAME,GET_GLOBAL_NAME æ³¨é‡Šæ‰æŸ¥ä¸€ä¸‹, ä»–è¯´1.5ç§’é‚£è¿™ä¸ªSQLå°±æ˜¯æ…¢åœ¨è¿™ä¿©è‡ªå®šä¹‰å‡½æ•°ä¸Šå‘—, è¿™ä¸ªæŸ¥è¯¢æ¯è¿”å›ä¸€è¡Œ,è¿™å‡½æ•°å°±è¦æ‰§è¡Œä¸€æ¬¡é‚£ä¹ˆå‡½æ•°å¯ä»¥æ”¹æˆ æ ‡é‡ , æ ‡é‡å¯ä»¥æ”¹æˆ letf join. é™„ä¸Šé‚£ä¿©å‡½æ•°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109CREATE OR REPLACE FUNCTION &quot;GET_GLOBAL_NAME&quot; (IN_code_NO IN VARCHAR2,in_language VARCHAR2) RETURN VARCHAR2IS v_name VARCHAR2 (100);/****************************************************************************** NAME : -- GET_GLOBAL_NAME PURPOSE : -- ä¾æ®ä¼ å…¥é¡¹ç›®Oå’Œè¯­è¨€å‚æ•°æŸ¥æ‰¾å›½é™…åŒ–åç§° IMPUT : -- IN_code_NO code_no, in_language è¯­è¨€ OUTPUT : -- none Author : -- hj CreateDate : -- 2012-3-2******************************************************************************/BEGIN BEGIN SELECT a.CONTENT INTO v_name FROM sy_global_name a WHERE a.no = IN_code_NO AND a.LANGUAGE = in_language ; EXCEPTION WHEN NO_DATA_FOUND THEN v_name := &#x27;&#x27;; WHEN OTHERS THEN RAISE; END; RETURN v_name;END GET_GLOBAL_NAME;CREATE OR REPLACE FUNCTION &quot;GET_DEPT_NAME&quot;(in_deptno IN VARCHAR2, in_language VARCHAR2) RETURN VARCHAR2 IS out_department VARCHAR2(200); /****************************************************************************** NAME : -- GET_DEPT_NAME PURPOSE : -- ä¾æ®æ³•äººå‚æ•°å¾—åˆ°æ­¤éƒ¨é—¨ç¼–å·çš„éƒ¨é—¨åç§° IMPUT : -- in_deptno éƒ¨é—¨åç§° IN_CPNY_ID å…¬å¸D OUTPUT : -- none Author : -- system CreateDate : -- 2011-12-29 14:57:33 UpdateDate : -- å‡½æ•°æ›´æ”¹ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä½œè€…ã€æ—¶é—´ã€æ›´æ”¹å†…å®¹ç­‰ï¼‰ ******************************************************************************/BEGIN BEGIN IF in_language = &#x27;zh&#x27; then SELECT a.org_name_local INTO out_department FROM hr_department a WHERE a.deptno = in_deptno and rownum = 1; ELSIF in_language = &#x27;en&#x27; then SELECT a.org_name_eng INTO out_department FROM hr_department a WHERE a.deptno = in_deptno and rownum = 1; else SELECT a.org_name_ko INTO out_department FROM hr_department a WHERE a.deptno = in_deptno and rownum = 1; end if; EXCEPTION WHEN NO_DATA_FOUND THEN out_department := &#x27;0&#x27;; END; IF out_department = &#x27;0&#x27; THEN BEGIN IF in_language = &#x27;zh&#x27; then SELECT a.org_name_local INTO out_department FROM org_info a WHERE a.deptno = in_deptno and rownum = 1; ELSIF in_language = &#x27;en&#x27; then SELECT a.org_name_eng INTO out_department FROM org_info a WHERE a.deptno = in_deptno and rownum = 1; ELSE SELECT a.org_name_ko INTO out_department FROM org_info a WHERE a.deptno = in_deptno and rownum = 1; END IF; EXCEPTION WHEN NO_DATA_FOUND THEN out_department := &#x27;&#x27;; END; END IF; RETURN out_department;END get_dept_name; SELECT a.org_name_local INTO out_department FROM org_info a WHERE a.deptno = in_deptno and rownum = 1; æœ€åæ”¹å®Œ,0.4ç§’,äº¤å·®äº†1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859with t1 as (select deptno from (SELECT B1.DEPTNO DEPTNO FROM HR_DEPARTMENT B1 START WITH B1.DEPTNO in (SELECT HRD.DEPTID FROM HR_DEPARTMENT HRD WHERE HRD.MANAGER_EMP_ID = &#x27;11111117&#x27;) CONNECT BY PRIOR B1.DEPTNO = B1.PARENT_DEPT_NO UNION SELECT AR_SUPERVISOR_INFO.DEPTNO DEPTNO FROM AR_SUPERVISOR_INFO where AR_SUPERVISOR_INFO.PERSON_ID = &#x27;11111117&#x27;)),global as (select a.CONTENT, a.no from sy_global_name a where a.language = &#x27;zh&#x27;),department as (select max(org_name_local) org_name_local, deptno from hr_department group by deptno),info as (select max(org_name_local) org_name_local, deptno from org_info group by deptno)SELECT ESS.PK_NO, HE.EMPID, HE.LOCAL_NAME, ESS.ITEM_NO ITEM_NO_NO, ESS.PERSON_ID, coalesce(department.org_name_local, info.org_name_local, &#x27;&#x27;) DEPT_NAME, g1.content ITEM_NAME, ESS.AR_DATE_STR, TO_CHAR(ESS.FROM_TIME, &#x27;HH24:MI&#x27;) FROM_TIME, TO_CHAR(ESS.TO_TIME, &#x27;HH24:MI&#x27;) TO_TIME, ESS.QUANTITY, ESS.REMARK, HE.EMPID, ESS.AR_DATE_STR, g2.content STATUS_CODE, g3.content ITEM_NO, ESS.REMARK, ESS.LOCK_YN FROM AR_DETAIL_HYOSUNG_JX ESS inner join HR_EMPLOYEE HE on ESS.PERSON_ID = HE.PERSON_ID left join global g1 on ess.ITEM_NO = g1.no left join global g2 on ESS.STATUS_CODE = g2.no left join global g3 on ESS.ITEM_NO = g3.no left join department on HE.DEPTNO = department.deptno left join info on HE.DEPTNO = info.deptno where ESS.PERSON_ID NOT LIKE &#x27;111111%&#x27; AND ESS.ITEM_NO IN (&#x27;141454&#x27;, &#x27;14015951&#x27;, &#x27;141445&#x27;, &#x27;141443&#x27;, &#x27;190000514&#x27;) AND HE.DEPTNO in (select deptno from t1) ORDER BY ESS.AR_DATE_STR ASC, ESS.CREATE_DATE DESC, HE.DEPTNO, HE.EMPID","categories":[],"tags":[{"name":"Oracle","slug":"Oracle","permalink":"http://fuxkdb.com/tags/Oracle/"},{"name":"SQL Tuning","slug":"SQL-Tuning","permalink":"http://fuxkdb.com/tags/SQL-Tuning/"}]},{"title":"PMMä½¿ç”¨Grafanaå‘Šè­¦","slug":"PMMä½¿ç”¨Grafanaå‘Šè­¦","date":"2017-12-15T05:26:00.000Z","updated":"2017-12-15T05:59:47.000Z","comments":true,"path":"2017/12/15/PMMä½¿ç”¨Grafanaå‘Šè­¦/","link":"","permalink":"http://fuxkdb.com/2017/12/15/PMM%E4%BD%BF%E7%94%A8Grafana%E5%91%8A%E8%AD%A6/","excerpt":"PMMå¦‚ä½•å‘Šè­¦?ä»Grafana v4.0å¼€å§‹å¢åŠ äº†AltertingåŠŸèƒ½ ( PMM 1.0.7 ç‰ˆæœ¬æ—¶Grafanaç‰ˆæœ¬ä¸º4.0). è¿™ç¯‡æ–‡ç« å°†æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•é…ç½®ä½ çš„å‘Šè­¦ å¼€å§‹åˆ›å»ºAlertåœ¨PMMéƒ¨ç½²å®Œæˆå,ä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ æ­¤æ—¶ä½ å¯èƒ½éœ€è¦å¯¹Threads_connected / Threads_running æŒ‡æ ‡è¿›è¡Œç›‘æ§ ç‚¹å‡»å¯¹åº”çš„Graphæ ‡é¢˜,ç‚¹å‡»Edit æŒ‰ä¸‹å›¾æ–¹å¼ä¾æ¬¡ç‚¹å‡»ALert -&gt; Create Alert åˆ›å»ºå‘Šè­¦ ä¸å¹¸çš„æ˜¯,å½“ä½ å°è¯•å¯¹AæŒ‡æ ‡åˆ›å»ºå¦‚ä¸‹å‘Šè­¦æ—¶,Grafanaæç¤ºä¸€ä¸ªé”™è¯¯â€œTemplate variables are not supported in alert queries.â€ é¦–å…ˆAä»£è¡¨ä»€ä¹ˆå¯ä»¥ä»Metricsèœå•ä¸­çœ‹åˆ°,ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¯¹äºThreads_connectedå€¼çš„è·å–è¡¨è¾¾å¼ä¸­åŒ…å«äº†å˜é‡$host, è€Œ$hostæ˜¯ç®­å¤´æ‰€æŒ‡çš„Hostä¸‹æ‹‰èœå•ä¼ é€’çš„å¯¹äºä½¿ç”¨å˜é‡çš„Mertrics,æ— æ³•åˆ›å»ºAlert","text":"PMMå¦‚ä½•å‘Šè­¦?ä»Grafana v4.0å¼€å§‹å¢åŠ äº†AltertingåŠŸèƒ½ ( PMM 1.0.7 ç‰ˆæœ¬æ—¶Grafanaç‰ˆæœ¬ä¸º4.0). è¿™ç¯‡æ–‡ç« å°†æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•é…ç½®ä½ çš„å‘Šè­¦ å¼€å§‹åˆ›å»ºAlertåœ¨PMMéƒ¨ç½²å®Œæˆå,ä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ æ­¤æ—¶ä½ å¯èƒ½éœ€è¦å¯¹Threads_connected / Threads_running æŒ‡æ ‡è¿›è¡Œç›‘æ§ ç‚¹å‡»å¯¹åº”çš„Graphæ ‡é¢˜,ç‚¹å‡»Edit æŒ‰ä¸‹å›¾æ–¹å¼ä¾æ¬¡ç‚¹å‡»ALert -&gt; Create Alert åˆ›å»ºå‘Šè­¦ ä¸å¹¸çš„æ˜¯,å½“ä½ å°è¯•å¯¹AæŒ‡æ ‡åˆ›å»ºå¦‚ä¸‹å‘Šè­¦æ—¶,Grafanaæç¤ºä¸€ä¸ªé”™è¯¯â€œTemplate variables are not supported in alert queries.â€ é¦–å…ˆAä»£è¡¨ä»€ä¹ˆå¯ä»¥ä»Metricsèœå•ä¸­çœ‹åˆ°,ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¯¹äºThreads_connectedå€¼çš„è·å–è¡¨è¾¾å¼ä¸­åŒ…å«äº†å˜é‡$host, è€Œ$hostæ˜¯ç®­å¤´æ‰€æŒ‡çš„Hostä¸‹æ‹‰èœå•ä¼ é€’çš„å¯¹äºä½¿ç”¨å˜é‡çš„Mertrics,æ— æ³•åˆ›å»ºAlert å’‹åŠå‘¢?ç‚¹å‡»Graphæ ‡é¢˜ -&gt; Panel Jsonå¤åˆ¶jsonä»£ç æ–°å»ºDashboardsåˆ›å»ºä¸€ä¸ªGraphç‚¹å‡»Graphæ ‡é¢˜ -&gt; Panel Jsonç²˜è´´åˆšæ‰å¤åˆ¶çš„Json,æ›¿æ¢æ‰ç°æœ‰çš„æ­¤æ—¶Graphæ˜¯ä¸å¯ç”¨çš„,æ³¨æ„çº¢è‰²å¹å·å°†$host $interval æ›¿æ¢, duang~ å‡ºå›¾äº†ç°åœ¨å°±å¯ä»¥åˆ›å»ºAlertäº†è¿™é‡Œæˆ‘ä»¬ç›‘æ§Metrics Bä¹Ÿå°±æ˜¯Threads_runningç‚¹å‡»Notification,æ·»åŠ æ¥æ”¶å‘Šè­¦ç»„ å’Œ æ³¨é‡Šä¿¡æ¯è¿™ä¸ªDBAç»„æ˜¯å“ªæ¥çš„å‘¢?å…¶å®éœ€è¦æå‰å»ºå¥½çš„. çœ‹å›¾å°±å¥½,ä¸è§£é‡Šäº† åˆ°è¿™è¿˜æ²¡å®Œå¯ä»¥çœ‹åˆ°ä¸Šé¢æˆ‘ä»¬æ˜¯é€šè¿‡é‚®ä»¶å‘Šè­¦(å½“ç„¶Grafanaè¿˜æ”¯æŒå¾ˆå¤šæ–¹å¼) . é‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦é…ç½®Grafanaè®©å®ƒèƒ½å‘é‚®ä»¶è¿›å…¥å®¹å™¨,ç¼–è¾‘grafana.ini1234567891011[root@localhost ~]# docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESec8fd0553984 percona/pmm-server:1.5.2 &quot;/opt/entrypoint.sh&quot; 38 hours ago Up 38 hours 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server[root@localhost ~]# docker exec -it ec8fd0553984 /bin/bash[root@ec8fd0553984 opt]# vi /etc/grafana/grafana.ini åœ¨[smtp]åŒºå—ä¸‹æ·»åŠ ,ä»¥æˆ‘è¿™é‡Œä¸ºä¾‹enabled = Truehost = &quot;smtp.exmail.qq.com:465&quot;user = &quot;papapa@xxoo.com&quot;password = &quot;durex&quot;from_address = &quot;papapa@xxoo.com&quot;ä¿å­˜é€€å‡º,é‡å¯å®¹å™¨ é«˜å¤§ä¸Šçš„å‘Šè­¦é‚®ä»¶","categories":[],"tags":[{"name":"MySQLç›‘æ§","slug":"MySQLç›‘æ§","permalink":"http://fuxkdb.com/tags/MySQL%E7%9B%91%E6%8E%A7/"},{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"Pt-table-checksumåŸç†æµ…æ","slug":"Pt-table-checksumåŸç†æµ…æ","date":"2017-11-24T03:01:00.000Z","updated":"2017-11-24T03:01:53.000Z","comments":true,"path":"2017/11/24/Pt-table-checksumåŸç†æµ…æ/","link":"","permalink":"http://fuxkdb.com/2017/11/24/Pt-table-checksum%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/","excerpt":"Pt-table-checksumåŸç†æµ…æä¸»åº“å»ºä¸€ä¸ªè¡¨12345node1&gt; create table fan(id int) engine=innodb;Query OK, 0 rows affected (0.12 sec)node1&gt; insert into fan values(1);Query OK, 1 row affected (0.07 sec)ä»åº“åˆ¶é€ ä¸ä¸€è‡´123456789node2&gt; select * from fan;+------+| id |+------+| 1 |+------+1 row in set (0.00 sec)node2&gt; update fan set id=2;ä¸¤è¾¹æ‰“å¼€general log,ç„¶å123[root@node1 ~]# pt-table-checksum --nocheck-replication-filters --no-check-binlog-format h=172.16.83.17,u=root,p=mysql,P=3307 --replicate=percona.checksums --recursion-method=dsn=h=172.16.83.21,D=percona,t=dsns --databases=sysbench --tables=fan TS ERRORS DIFFS ROWS CHUNKS SKIPPED TIME TABLE11-06T05:12:58 0 1 1 1 0 0.344 sysbench.fan å…ˆçœ‹ä¸¤è¾¹çš„checksumsè¡¨1234567891011121314node1&gt; select * from `percona`.`checksums` where tbl=&#x27;fan&#x27;;+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| db | tbl | chunk | chunk_time | chunk_index | lower_boundary | upper_boundary | this_crc | this_cnt | master_crc | master_cnt | ts |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| sysbench | fan | 1 | 0.019798 | NULL | NULL | NULL | 42981178 | 1 | 42981178 | 1 | 2017-11-06 05:12:58 |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+node2&gt; select * from `percona`.`checksums` where tbl=&#x27;fan&#x27;;+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| db | tbl | chunk | chunk_time | chunk_index | lower_boundary | upper_boundary | this_crc | this_cnt | master_crc | master_cnt | ts |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| sysbench | fan | 1 | 0.019798 | NULL | NULL | NULL | 40deaf21 | 1 | 42981178 | 1 | 2017-11-06 05:12:58 |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+1 row in set (0.04 sec)","text":"Pt-table-checksumåŸç†æµ…æä¸»åº“å»ºä¸€ä¸ªè¡¨12345node1&gt; create table fan(id int) engine=innodb;Query OK, 0 rows affected (0.12 sec)node1&gt; insert into fan values(1);Query OK, 1 row affected (0.07 sec)ä»åº“åˆ¶é€ ä¸ä¸€è‡´123456789node2&gt; select * from fan;+------+| id |+------+| 1 |+------+1 row in set (0.00 sec)node2&gt; update fan set id=2;ä¸¤è¾¹æ‰“å¼€general log,ç„¶å123[root@node1 ~]# pt-table-checksum --nocheck-replication-filters --no-check-binlog-format h=172.16.83.17,u=root,p=mysql,P=3307 --replicate=percona.checksums --recursion-method=dsn=h=172.16.83.21,D=percona,t=dsns --databases=sysbench --tables=fan TS ERRORS DIFFS ROWS CHUNKS SKIPPED TIME TABLE11-06T05:12:58 0 1 1 1 0 0.344 sysbench.fan å…ˆçœ‹ä¸¤è¾¹çš„checksumsè¡¨1234567891011121314node1&gt; select * from `percona`.`checksums` where tbl=&#x27;fan&#x27;;+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| db | tbl | chunk | chunk_time | chunk_index | lower_boundary | upper_boundary | this_crc | this_cnt | master_crc | master_cnt | ts |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| sysbench | fan | 1 | 0.019798 | NULL | NULL | NULL | 42981178 | 1 | 42981178 | 1 | 2017-11-06 05:12:58 |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+node2&gt; select * from `percona`.`checksums` where tbl=&#x27;fan&#x27;;+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| db | tbl | chunk | chunk_time | chunk_index | lower_boundary | upper_boundary | this_crc | this_cnt | master_crc | master_cnt | ts |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+| sysbench | fan | 1 | 0.019798 | NULL | NULL | NULL | 40deaf21 | 1 | 42981178 | 1 | 2017-11-06 05:12:58 |+----------+-----+-------+------------+-------------+----------------+----------------+----------+----------+------------+------------+---------------------+1 row in set (0.04 sec)node1çš„checksumsè¡¨çš„this_crc,this_cntå’Œmaster_crc,master_cntè‚¯å®šæ˜¯ä¸€æ ·çš„å› ä¸º.è¿™è¾¹æ˜¯replace into select å…ˆè®¡ç®—this_crc,this_cnt .12REPLACE INTO `percona`.`checksums` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT &#x27;sysbench&#x27;, &#x27;fan&#x27;, &#x27;1&#x27;, NULL, NULL, NULL, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(&#x27;#&#x27;, `id`, CONCAT(ISNULL(`id`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `sysbench`.`fan` /*checksum table*/SHOW WARNINGSç„¶åå†è·å–this_crc, this_cntçš„å€¼1SELECT this_crc, this_cnt FROM `percona`.`checksums` WHERE db = &#x27;sysbench&#x27; AND tbl = &#x27;fan&#x27; AND chunk = &#x27;1&#x27;æœ€åæŠŠmaster_crc,master_cntæ›´æ–°æˆè¿™ä¸ªå€¼1UPDATE `percona`.`checksums` SET chunk_time = &#x27;0.019798&#x27;, master_crc = &#x27;42981178&#x27;, master_cnt = &#x27;1&#x27; WHERE db = &#x27;sysbench&#x27; AND tbl = &#x27;fan&#x27; AND chunk = &#x27;1&#x27;è€Œåˆ°äº†ä»åº“è¿™é‡Œ.ç”±äºä¸»åº“è®¾ç½®äº†binlog_format=statement æ‰€ä»¥replace into selectå¤åˆ¶è¿‡å»åˆ°ä»åº“è¿˜æ˜¯è¯­å¥,è€Œä¸æ˜¯å€¼.æ­¤æ—¶ä»åº“æ‰§è¡Œè¿™ä¸ªè¯­å¥,åœ¨è‡ªå·±çš„checksumsè¡¨ä¸­æ ¹æ®è‡ªå·±çš„å®é™…å€¼ç®—å‡ºäº†this_crc,this_cnt12REPLACE INTO `percona`.`checksums` (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT &#x27;sysbench&#x27;, &#x27;fan&#x27;, &#x27;1&#x27;, NULL, NULL, NULL, COUNT(*) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(&#x27;#&#x27;, `id`, CONCAT(ISNULL(`id`)))) AS UNSIGNED)), 10, 16)), 0) AS crc FROM `sysbench`.`fan` /*checksum table*/COMMIT /* implicit, from Xid_log_event */ç„¶åæ‹¿ä¸»åº“ä¼ è¿‡æ¥çš„ä¸»åº“çš„this_crc, this_cntçš„å€¼æ›´æ–°è‡ªå·±çš„master_crc,master_cnt123BEGINUPDATE `percona`.`checksums` SET chunk_time = &#x27;0.019798&#x27;, master_crc = &#x27;42981178&#x27;, master_cnt = &#x27;1&#x27; WHERE db = &#x27;sysbench&#x27; AND tbl = &#x27;fan&#x27; AND chunk = &#x27;1&#x27;COMMIT /* implicit, from Xid_log_event */è¿™æ ·,ä»åº“çš„checksumsè¡¨ä¸­å°±å­˜å‚¨äº†è‡ªå·±å’Œä¸»åº“çš„hashå€¼. æœ€åæŸ¥ä¸€æŠŠ,æŠŠç»“æœè¿”å›è¾“å‡ºåˆ°å±å¹•123456789SELECT MAX(chunk) FROM `percona`.`checksums` WHERE db=&#x27;sysbench&#x27; AND tbl=&#x27;fan&#x27; AND master_crc IS NOT NULLSELECT CONCAT(db, &#x27;.&#x27;, tbl) AS `table`, chunk, chunk_index, lower_boundary, upper_boundary, COALESCE(this_cnt-master_cnt, 0) AS cnt_diff, COALESCE(this_crc &lt;&gt; master_crc OR ISNULL(master_crc) &lt;&gt; ISNULL(this_crc), 0) AS crc_diff, this_cnt, master_cnt, this_crc, master_crc FROM `percona`.`checksums` WHERE (master_cnt &lt;&gt; this_cnt OR master_crc &lt;&gt; this_crc OR ISNULL(master_crc) &lt;&gt; ISNULL(this_crc)) AND (db=&#x27;sysbench&#x27; AND tbl=&#x27;fan&#x27;)è¿™ä¸ªç»“æœä¸ºæ‰‹åŠ¨æŸ¥è¯¢çš„. pt-table-checksumæ ¹æ®è¿™ä¸ªç»“æœè‡ªå·±æ•´ç†å¥½æ ¼å¼è¾“å‡ºåˆ°å±å¹•+--------------+-------+-------------+----------------+----------------+----------+----------+----------+------------+----------+------------+| table | chunk | chunk_index | lower_boundary | upper_boundary | cnt_diff | crc_diff | this_cnt | master_cnt | this_crc | master_crc |+--------------+-------+-------------+----------------+----------------+----------+----------+----------+------------+----------+------------+| sysbench.fan | 1 | NULL | NULL | NULL | 0 | 1 | 1 | 1 | 40deaf21 | 42981178 |+--------------+-------+-------------+----------------+----------------+----------+----------+----------+------------+----------+------------+ å…³äºä¸¤è¾¹æŸ¥è¯¢ä¸€è‡´æ€§çš„ä¿è¯pt-table-checksum ä¼šè®¾ç½®1SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READè¿™æ ·é¿å…å¹»è¯»,é€šè¿‡gap locké˜»å¡å…¶ä»–insert.ä¿è¯è‚¯å®šæ˜¯replace into selectå…ˆcommit;è¿™æ ·è‚¯å®šæ˜¯replace into selectå…ˆå¤åˆ¶åˆ°ä»åº“(binlogæ˜¯è°å…ˆæäº¤è®°å½•è°)12345678910111213141516171819202122232425262728293031323334353637383940414243node1&gt; select * from fan;+----+------+| id | name |+----+------+| 1 | fan || 5 | fan || 7 | fan || 9 | fan || 10 | fan || 11 | fan || 12 | fan || 13 | fan || 14 | fan || 15 | fan |+----+------+10 rows in set (0.00 sec)node1&gt; select * from fan2;+----+------+| id | name |+----+------+| 1 | duzi || 5 | duzi || 7 | duzi || 9 | duzi || 10 | duzi || 11 | duzi || 12 | duzi || 13 | duzi || 14 | duzi || 15 | duzi |+----+------+10 rows in set (0.00 sec)node1&gt; SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;Query OK, 0 rows affected (0.00 sec)node1&gt; begin;Query OK, 0 rows affected (0.00 sec)node1&gt; replace into fan2 select * from fan where id&lt;7;Query OK, 4 rows affected, 1 warning (0.01 sec)Records: 2 Duplicates: 2 Warnings: 1node2è¢«é”12345678node2&gt; SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;Query OK, 0 rows affected (0.00 sec)node2&gt; begin;Query OK, 0 rows affected (0.00 sec)node2&gt; insert into fan values(4,&#x27;ceshi&#x27;);ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transactionshow engine innodb status12345678910111213141516171819202122------------TRANSACTIONS------------Trx id counter 163F4Purge done for trx&#x27;s n:o &lt; 163F0 undo n:o &lt; 0History list length 662LIST OF TRANSACTIONS FOR EACH SESSION:---TRANSACTION 0, not startedMySQL thread id 46, OS thread handle 0x7f42f81bf700, query id 62676 localhost rootshow engine innodb status---TRANSACTION 163F3, ACTIVE 5 sec insertingmysql tables in use 1, locked 1LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)MySQL thread id 45, OS thread handle 0x7f42b44cd700, query id 62675 localhost root updateinsert into fan values(4,&#x27;ceshi&#x27;)------- TRX HAS BEEN WAITING 5 SEC FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 49 page no 3 n bits 80 index `PRIMARY` of table `sysbench`.`fan` trx id 163F3 lock_mode X locks gap before rec insert intention waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 4; compact format; info bits 00: len 4; hex 80000005; asc ;;1: len 6; hex 0000000163de; asc c ;;2: len 7; hex ac00000cc70110; asc ;;3: len 3; hex 66616e; asc fan;;1234567mysql&gt; select * from INNODB_TRX ;+--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-----------------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+| trx_id | trx_state | trx_started | trx_requested_lock_id | trx_wait_started | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state | trx_tables_in_use | trx_tables_locked | trx_lock_structs | trx_lock_memory_bytes | trx_rows_locked | trx_rows_modified | trx_concurrency_tickets | trx_isolation_level | trx_unique_checks | trx_foreign_key_checks | trx_last_foreign_key_error | trx_adaptive_hash_latched | trx_adaptive_hash_timeout |+--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-----------------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+| 163F3 | LOCK WAIT | 2017-11-06 05:56:40 | 163F3:49:3:3 | 2017-11-06 05:56:40 | 2 | 45 | insert into fan values(4,&#x27;ceshi&#x27;) | inserting | 1 | 1 | 2 | 376 | 1 | 0 | 0 | REPEATABLE READ | 1 | 1 | NULL | 0 | 10000 || 163F2 | RUNNING | 2017-11-06 05:56:29 | NULL | NULL | 6 | 47 | NULL | NULL | 0 | 0 | 4 | 1248 | 5 | 2 | 0 | REPEATABLE READ | 1 | 1 | NULL | 0 | 10000 |+--------+-----------+---------------------+-----------------------+---------------------+------------+---------------------+-----------------------------------+---------------------+-------------------+-------------------+------------------+-----------------------+-----------------+-------------------+-------------------------+---------------------+-------------------+------------------------+----------------------------+---------------------------+---------------------------+","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Percona Toolkit","slug":"Percona-Toolkit","permalink":"http://fuxkdb.com/tags/Percona-Toolkit/"}]},{"title":"pybackupä½¿ç”¨æ–‡æ¡£","slug":"pybackupä½¿ç”¨æ–‡æ¡£","date":"2017-11-12T14:04:00.000Z","updated":"2018-05-03T08:36:27.000Z","comments":true,"path":"2017/11/12/pybackupä½¿ç”¨æ–‡æ¡£/","link":"","permalink":"http://fuxkdb.com/2017/11/12/pybackup%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/","excerpt":"pybackupä½¿ç”¨æ–‡æ¡£https://github.com/Fanduzi/pybackuppybackupæºè‡ªäºå¯¹çº¿ä¸Šå¤‡ä»½è„šæœ¬çš„æ”¹è¿›å’Œå¯¹å¤‡ä»½æƒ…å†µçš„ç›‘æ§éœ€æ±‚.åŸæœ¬ç”Ÿäº§åº“çš„å¤‡ä»½æ˜¯é€šè¿‡shellè„šæœ¬è°ƒç”¨mydumper,ä¹‹åå†å°†å¤‡ä»½é€šè¿‡rsyncä¼ è¾“åˆ°å¤‡ä»½æœº.æƒ³è¦è·å–å¤‡ä»½çŠ¶æ€,æ—¶é—´,rsyncä¼ è¾“æ—¶é—´ç­‰ä¿¡æ¯åªèƒ½é€šè¿‡è§£ææ—¥å¿—.pybackupç”±pythonç¼–å†™,è°ƒç”¨mydumperå’Œrsync,å°†å¤‡ä»½ä¿¡æ¯å­˜å…¥æ•°æ®åº“ä¸­,åæœŸå¯ä»¥é€šè¿‡grafanaå›¾å½¢åŒ–å±•ç¤ºå’Œç›‘æ§å¤‡ä»½ç›®å‰ä¸æ”¯æŒ2.6,ä»…åœ¨2.7.14åšè¿‡æµ‹è¯• å‚æ•°è¯´æ˜å¸®åŠ©ä¿¡æ¯1234567891011121314151617181920[root@iZ23t8cwo3iZ backup_db]# python pybackup.py -hUsage: pybackup.py mydumper ARG_WITH_NO_--... (([--no-rsync] [--no-history]) | [--only-backup]) pybackup.py only-rsync [--backup-dir=&lt;DIR&gt;] [--bk-id=&lt;id&gt;] [--log-file=&lt;log&gt;] pybackup.py -h | --help pybackup.py --versionOptions: -h --help Show help information. --version Show version. --no-rsync Do not use rsync. --no-history Do not record backup history information. --only-backup Equal to use both --no-rsync and --no-history. --only-rsync When you backup complete, but rsync failed, use this option to rsync your backup. --backup-dir=&lt;DIR&gt; The directory where the backup files need to be rsync are located. [default: ./] --bk-id=&lt;id&gt; bk-id in table user_backup. --log-file=&lt;log&gt; log file [default: ./rsync.log]more help information in:https://github.com/Fanduzi 1pybackup.py mydumper ARG_WITH_NO_--... (([--no-rsync] [--no-history]) | [--only-backup]) é™¤äº†æœ€åä¸‰ä¸ªå‚æ•°,ä½¿ç”¨çš„æ‰€æœ‰å‚æ•°å’Œmydumper -hä¸­åˆ—å‡ºçš„å‚æ•°ç›¸åŒ. åªä¸è¿‡ç›®å‰åªæ”¯æŒé•¿é€‰é¡¹,å¹¶ä¸”ä¸å¸¦â€™â€“â€™","text":"pybackupä½¿ç”¨æ–‡æ¡£https://github.com/Fanduzi/pybackuppybackupæºè‡ªäºå¯¹çº¿ä¸Šå¤‡ä»½è„šæœ¬çš„æ”¹è¿›å’Œå¯¹å¤‡ä»½æƒ…å†µçš„ç›‘æ§éœ€æ±‚.åŸæœ¬ç”Ÿäº§åº“çš„å¤‡ä»½æ˜¯é€šè¿‡shellè„šæœ¬è°ƒç”¨mydumper,ä¹‹åå†å°†å¤‡ä»½é€šè¿‡rsyncä¼ è¾“åˆ°å¤‡ä»½æœº.æƒ³è¦è·å–å¤‡ä»½çŠ¶æ€,æ—¶é—´,rsyncä¼ è¾“æ—¶é—´ç­‰ä¿¡æ¯åªèƒ½é€šè¿‡è§£ææ—¥å¿—.pybackupç”±pythonç¼–å†™,è°ƒç”¨mydumperå’Œrsync,å°†å¤‡ä»½ä¿¡æ¯å­˜å…¥æ•°æ®åº“ä¸­,åæœŸå¯ä»¥é€šè¿‡grafanaå›¾å½¢åŒ–å±•ç¤ºå’Œç›‘æ§å¤‡ä»½ç›®å‰ä¸æ”¯æŒ2.6,ä»…åœ¨2.7.14åšè¿‡æµ‹è¯• å‚æ•°è¯´æ˜å¸®åŠ©ä¿¡æ¯1234567891011121314151617181920[root@iZ23t8cwo3iZ backup_db]# python pybackup.py -hUsage: pybackup.py mydumper ARG_WITH_NO_--... (([--no-rsync] [--no-history]) | [--only-backup]) pybackup.py only-rsync [--backup-dir=&lt;DIR&gt;] [--bk-id=&lt;id&gt;] [--log-file=&lt;log&gt;] pybackup.py -h | --help pybackup.py --versionOptions: -h --help Show help information. --version Show version. --no-rsync Do not use rsync. --no-history Do not record backup history information. --only-backup Equal to use both --no-rsync and --no-history. --only-rsync When you backup complete, but rsync failed, use this option to rsync your backup. --backup-dir=&lt;DIR&gt; The directory where the backup files need to be rsync are located. [default: ./] --bk-id=&lt;id&gt; bk-id in table user_backup. --log-file=&lt;log&gt; log file [default: ./rsync.log]more help information in:https://github.com/Fanduzi 1pybackup.py mydumper ARG_WITH_NO_--... (([--no-rsync] [--no-history]) | [--only-backup]) é™¤äº†æœ€åä¸‰ä¸ªå‚æ•°,ä½¿ç”¨çš„æ‰€æœ‰å‚æ•°å’Œmydumper -hä¸­åˆ—å‡ºçš„å‚æ•°ç›¸åŒ. åªä¸è¿‡ç›®å‰åªæ”¯æŒé•¿é€‰é¡¹,å¹¶ä¸”ä¸å¸¦â€™â€“â€™ ä¾‹:1./pybackup.py mydumper password=fanboshi database=fandb outputdir=/data4/recover/pybackup/2017-11-12 logfile=/data4/recover/pybackup/bak.log verbose=3å¯ä»¥ä½¿ç”¨./pybackup.py mydumper helpæŸ¥çœ‹mydumperå¸®åŠ©ä¿¡æ¯ â€“no-rsync ä¸ä½¿ç”¨rsyncä¼ è¾“ â€“no-history ä¸è®°å½•å¤‡ä»½ä¿¡æ¯åˆ°æ•°æ®åº“ â€“only-backup ç­‰ä»·äºåŒæ—¶ä½¿ç”¨â€“no-rsyncå’Œâ€“no-history . ä¸èƒ½ä¸â€“no-rsyncæˆ–â€“no-historyåŒæ—¶ä½¿ç”¨ 1pybackup.py only-rsync [--backup-dir=&lt;DIR&gt;] [--bk-id=&lt;id&gt;] [--log-file=&lt;log&gt;] å½“å¤‡ä»½æˆåŠŸrsyncå¤±è´¥æ—¶å¯ä»¥ä½¿ç”¨only-rsyncæ¥åŒæ­¥å¤‡ä»½æˆåŠŸçš„æ–‡ä»¶ â€“backup-dir éœ€è¦ä½¿ç”¨rsyncåŒæ­¥çš„å¤‡ä»½æ–‡ä»¶è·¯å¾„,å¦‚æœä¸æŒ‡å®š,åˆ™é»˜è®¤ä¸º./ â€“bk-id user_backupè¡¨ä¸­è®°å½•çš„å¤‡ä»½bk_id,å¦‚æœæŒ‡å®š,åˆ™ä¼šåœ¨rsyncåŒæ­¥å®Œæˆåæ›´æ–°æŒ‡å®šbk_idè¡Œçš„,ä¼ è¾“èµ·å§‹æ—¶é—´,è€—æ—¶,æ˜¯å¦æˆåŠŸç­‰ä¿¡æ¯.å¦‚æœä¸æŒ‡å®šåˆ™ä¸æ›´æ–°user_backupè¡¨ â€“log-file æœ¬æ¬¡rsyncæŒ‡å®šçš„æ—¥å¿—,å¦‚æœä¸æŒ‡å®š,åˆ™é»˜è®¤ä¸ºå½“å‰ç›®å½•rsync.logæ–‡ä»¶ é…ç½®æ–‡ä»¶è¯´æ˜é…ç½®æ–‡ä»¶ä¸ºpbackup.conf123456789101112131415161718192021[root@localhost pybackup]# less pybackup.conf [CATALOG] --å­˜å‚¨å¤‡ä»½ä¿¡æ¯çš„æ•°æ®åº“é…ç½®db_host=localhostdb_port=3306db_user=rootdb_passwd=fanboshidb_use=catalogdb[TDB] --éœ€è¦å¤‡ä»½çš„æ•°æ®åº“é…ç½®db_host=localhostdb_port=3306db_user=rootdb_passwd=fanboshidb_use=information_schemadb_consistency=True --0.7.0æ–°å¢option,å¯ä»¥ä¸å†™,ä¸å†™åˆ™ä¸ºFalse,åé¢ä¼šå¯¹è¿™ä¸ªoptionè¿›è¡Œè¯´æ˜db_list=test,fandb,union_log_ad_% --æŒ‡å®šéœ€è¦å¤‡ä»½çš„æ•°æ®åº“,å¯ä»¥ä½¿ç”¨mysqlæ”¯æŒçš„é€šé…ç¬¦. å¦‚æœæƒ³è¦å¤‡ä»½æ‰€æœ‰æ•°æ®åº“åˆ™å¡«å†™%[rsync]password_file=/data4/recover/pybackup/rsync.sec --ç­‰åŒäº--password-filedest=platform@xx.xx.xx.xx/db_backup/xx.xx.xx.xx --ä¼ è¾“åˆ°å“ªä¸ªç›®å½•address= --ä½¿ç”¨çš„ç½‘å¡.å¯ä»¥ä¸ºç©ºä¸æŒ‡å®šæ³¨æ„12345[TDB]db_list=fan,bo,shi ä»£è¡¨å¤‡ä»½fan,bo,shiä¸‰ä¸ªæ•°æ®åº“db_list=!fan,!bo,!shi ä»£è¡¨ä¸å¤‡ä»½fan,bo,shiä¸‰ä¸ªæ•°æ®åº“db_list=% ä»£è¡¨å¤‡ä»½æ‰€æœ‰æ•°æ®åº“db_list=!fan,bo ä¸æ”¯æŒè¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„,å³ä¾¿åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†db_listå‚æ•°,ä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œå¼ºåˆ¶æŒ‡å®šdatabase=xx / regex / tables-list,ä¾‹å¦‚1pybackup.py mydumper password=&quot;xx&quot; user=root socket=/data/mysql/mysql.sock outputdir=/data/backup_db/ verbose=3 compress threads=8 triggers events routines use-savepoints logfile=/data/backup_db/pybackup.log database=yourdbæ­¤æ—¶ä¼šåªå¤‡ä»½yourdbè€Œå¿½ç•¥é…ç½®æ–‡ä»¶ä¸­çš„å®šä¹‰ å¤‡ä»½ä¿¡æ¯ç¤ºä¾‹123456789101112131415161718192021*************************** 4. row *************************** id: 4 bk_id: bcd36dc6-c9e7-11e7-9e30-005056b15d9c bk_server: xx.xx.xx.xx start_time: 2017-11-15 17:31:20 end_time: 2017-11-15 17:32:07 elapsed_time: 47 backuped_db: fandb,test,union_log_ad_201710_db,union_log_ad_201711_db is_complete: Y,Y,Y,Y bk_size: 480M bk_dir: /data4/recover/pybackup/2017-11-15 transfer_start: 2017-11-15 17:32:07 transfer_end: 2017-11-15 17:33:36 transfer_elapsed: 89transfer_complete: Y remote_dest: platform@xx.xx.xx.xx/db_backup/xx.xx.xx.xx/ master_status: mysql-bin.000036,61286, slave_status: Not a slave tool_version: mydumper 0.9.2, built against MySQL 5.5.53 server_version: 5.7.18-log bk_command: mydumper --password=supersecrect --outputdir=/data4/recover/pybackup/2017-11-15 --verbose=3 --compress --triggers --events --routines --use-savepoints database=fandb,test,union_log_ad_201710_db,union_log_ad_201711_db å»ºåº“å»ºè¡¨è¯­å¥12345678910111213141516171819202122232425create database catalogdb;CREATE TABLE user_backup ( id INT AUTO_INCREMENT NOT NULL PRIMARY KEY, bk_id CHAR(36) NOT NULL UNIQUE KEY, bk_server VARCHAR(15) NOT NULL, start_time DATETIME NOT NULL, end_time DATETIME NOT NULL, elapsed_time INT NOT NULL, backuped_db VARCHAR(200) NOT NULL, is_complete VARCHAR(30) NOT NULL, bk_size VARCHAR(10) NOT NULL, bk_dir VARCHAR(200) NOT NULL, transfer_start DATETIME, transfer_end DATETIME, transfer_elapsed INT, transfer_complete VARCHAR(20) NOT NULL, remote_dest VARCHAR(200) NOT NULL, master_status VARCHAR(200) NOT NULL, slave_status VARCHAR(200) NOT NULL, tool_version VARCHAR(200) NOT NULL, server_version VARCHAR(200) NOT NULL, bk_command VARCHAR(400) NOT NULL, tag varchar(200) NOT NULL DEFAULT &#x27;N/A&#x27;, is_deleted char(1) NOT NULL DEFAULT &#x27;N&#x27;) ENGINE=INNODB CHARACTER SET UTF8 COLLATE UTF8_GENERAL_CI; å…³äºdb_consistency1./pybackup.py mydumper password=fanboshi database=fandb outputdir=/data4/recover/pybackup/2017-11-12 logfile=/data4/recover/pybackup/bak.log verbose=3 ä»¥ä¸Šé¢å‘½ä»¤ä¸ºä¾‹,é»˜è®¤è„šæœ¬é€»è¾‘å¯¹äºdb_listæŒ‡å®šçš„åº“é€šè¿‡forå¾ªç¯é€ä¸€ä½¿ç”¨mydumper â€“database=xx å¤‡ä»½å¦‚æœçŸ¥é“db_consistency=Trueåˆ™ä¼šæ›¿æ¢ä¸ºä½¿ç”¨ â€“regexå¤‡ä»½db_listä¸­æŒ‡å®šçš„æ‰€æœ‰æ•°æ®åº“, ä¿è¯äº†æ•°æ®åº“ä¹‹é—´çš„ä¸€è‡´æ€§ å¤‡ä»½è„šæœ¬ç¤ºä¾‹12345678910#!/bin/shDSERVENDAY=`date +%Y-%m-%d --date=&#x27;2 day ago&#x27;`DTODAY=`date +%Y-%m-%d`cd /data/backup_db/rm -rf $DTODAYrm -rf $DSERVENDAYmkdir $DTODAYsource ~/.bash_profilepython /data/backup_db/pybackup.py mydumper password=&quot;papapa&quot; user=root socket=/data/mysql/mysql.sock outputdir=/data/backup_db/$DTODAY verbose=3 compress threads=8 triggers events routines use-savepoints logfile=/data/backup_db/pybackup.log crontab10 4 * * * /data/backup_db/pybackup.sh&gt;&gt; /data/backup_db/pybackup_sh.log 2&gt;&amp;1 logroatateè„šæœ¬1234567891011121314151617/data/backup_db/pybackup.log &#123; daily rotate 7 missingok compress delaycompress copytruncate&#125;/data/backup_db/pybackup_sh.log &#123; daily rotate 7 missingok compress delaycompress copytruncate&#125;","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"ä¸ºä»€ä¹ˆåŒä¸»åªå»ºè®®å•èŠ‚ç‚¹å†™å…¥?","slug":"ä¸ºä»€ä¹ˆåŒä¸»å»ºè®®å•èŠ‚ç‚¹å†™å…¥","date":"2017-10-31T09:23:00.000Z","updated":"2017-11-01T01:51:56.000Z","comments":true,"path":"2017/10/31/ä¸ºä»€ä¹ˆåŒä¸»å»ºè®®å•èŠ‚ç‚¹å†™å…¥/","link":"","permalink":"http://fuxkdb.com/2017/10/31/%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%8C%E4%B8%BB%E5%BB%BA%E8%AE%AE%E5%8D%95%E8%8A%82%E7%82%B9%E5%86%99%E5%85%A5/","excerpt":"ä¸ºä»€ä¹ˆåŒä¸»åªå»ºè®®å•èŠ‚ç‚¹å†™å…¥é€šè¿‡ä¸‹é¢çš„æ¡ˆä¾‹,ä½ åº”è¯¥å¯ä»¥æ˜ç™½ä¸ºå•¥äº† é—®é¢˜æè¿°çº¿ä¸Šä¸€å¥—åŒä¸»ç¯å¢ƒ123456CentOS release 6.8 (Final)Server version: 5.5.56binlog_format : STATEMENTtx_isolation : REPEATABLE-READä¸»1 server_id : 32ä¸»2 server_id : 33æœ‰ä¸€ä¸ªè¡¨,æ¯åˆ†é’Ÿload data. ç”±äºä¸€å¤©ä¼šæ’å…¥è¿‘1äº¿è¡Œæ•°æ®,å¯¼è‡´ç£ç›˜ä½¿ç”¨ç‡å¢é•¿å¾ˆå¿«,æ‰€ä»¥ç°åœ¨ç”¨è®¡åˆ’ä»»åŠ¡æ¯å››å¤©åˆ‡æ¢ä¸€æ¬¡è¡¨12#mobile_ad_50è¡¨åˆ‡æ¢0 3 2,6,10,14,19,23,27 * * source /etc/profile;source /root/.bash_profile;sh /data/scripts/bin/mobile_ad_50.sh &gt;&gt;/data/scripts/log/mobile_ad_50.logåˆ‡æ¢é€»è¾‘æ˜¯,å…ˆrenameæºè¡¨,å†é‡å»ºè¡¨12345$&#123;DB_COMMAND&#125; dbe8je6i4c3gjd50 -ss -e &quot;drop table mobile_ad_50_20170531&quot;echo &quot;drop ok&quot;$&#123;DB_COMMAND&#125; dbe8je6i4c3gjd50 -ss -e &quot;rename table mobile_ad_50 to mobile_ad_50_20170531&quot;echo &quot;rename ok&quot;$&#123;DB_COMMAND&#125; dbe8je6i4c3gjd50 -ss -e &quot;CREATE TABLE mobile_ad_50 (è¡¨ç»“æ„1234567891011121314151617181920212223242526272829303132333435*************************** 1. row *************************** Table: mobile_ad_50Create Table: CREATE TABLE `mobile_ad_50` ( `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®&#x27;, `dtime` datetime NOT NULL DEFAULT &#x27;0000-00-00 00:00:00&#x27; COMMENT &#x27;æ—¶é—´æ®µ å¹´æœˆæ—¥æ—¶&#x27;, `union_id` int(11) unsigned NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;åª’ä½“ID&#x27;, `ad_id` varchar(100) DEFAULT NULL COMMENT &#x27;å¹¿å‘Šä½ID&#x27;, `ifa` varchar(50) NOT NULL COMMENT &#x27;ifa&#x27;, `mac` varchar(50) NOT NULL COMMENT &#x27;mac&#x27;, `cb_url` varchar(1000) NOT NULL COMMENT &#x27;å›è°ƒåœ°å€&#x27;, `state` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦æ¿€æ´»&#x27;, `domain` varchar(30) NOT NULL COMMENT &#x27;æ¸¸æˆåŸŸå&#x27;, `game_code` varchar(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;æ¸¸æˆç¼–ç &#x27;, `union_app_id` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;æ¸ é“å•†çš„appid&#x27;, `openudid` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;å¼€æºå¹¿å‘Šæ ‡ç¤ºç¬¦&#x27;, `is_send` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;åŒæ­¥æ¬¡æ•°a&#x27;, `ip` bigint(20) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;ç‚¹å‡»ip&#x27;, `actip` bigint(20) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ¿€æ´»ip&#x27;, `opentime` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ‰“å¼€æ—¶é—´&#x27;, `acttime` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ¿€æ´»æ—¶é—´&#x27;, `is_open` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦æ‰“å¼€&#x27;, PRIMARY KEY (`id`), KEY `ifa` (`ifa`), KEY `d_u_s` (`domain`,`union_id`,`state`), KEY `union_id` (`union_id`), KEY `mac` (`mac`), KEY `dtime` (`dtime`), KEY `ip` (`ip`), KEY `actip` (`actip`), KEY `union_app_id` (`union_app_id`), KEY `openudid` (`openudid`), KEY `state` (`state`), KEY `acttime` (`acttime`)) ENGINE=InnoDB AUTO_INCREMENT=6154739813 DEFAULT CHARSET=utf8 COMMENT=&#x27;æ‰‹æœºå¹¿å‘Š&#x27;1 row in set (0.00 sec)","text":"ä¸ºä»€ä¹ˆåŒä¸»åªå»ºè®®å•èŠ‚ç‚¹å†™å…¥é€šè¿‡ä¸‹é¢çš„æ¡ˆä¾‹,ä½ åº”è¯¥å¯ä»¥æ˜ç™½ä¸ºå•¥äº† é—®é¢˜æè¿°çº¿ä¸Šä¸€å¥—åŒä¸»ç¯å¢ƒ123456CentOS release 6.8 (Final)Server version: 5.5.56binlog_format : STATEMENTtx_isolation : REPEATABLE-READä¸»1 server_id : 32ä¸»2 server_id : 33æœ‰ä¸€ä¸ªè¡¨,æ¯åˆ†é’Ÿload data. ç”±äºä¸€å¤©ä¼šæ’å…¥è¿‘1äº¿è¡Œæ•°æ®,å¯¼è‡´ç£ç›˜ä½¿ç”¨ç‡å¢é•¿å¾ˆå¿«,æ‰€ä»¥ç°åœ¨ç”¨è®¡åˆ’ä»»åŠ¡æ¯å››å¤©åˆ‡æ¢ä¸€æ¬¡è¡¨12#mobile_ad_50è¡¨åˆ‡æ¢0 3 2,6,10,14,19,23,27 * * source /etc/profile;source /root/.bash_profile;sh /data/scripts/bin/mobile_ad_50.sh &gt;&gt;/data/scripts/log/mobile_ad_50.logåˆ‡æ¢é€»è¾‘æ˜¯,å…ˆrenameæºè¡¨,å†é‡å»ºè¡¨12345$&#123;DB_COMMAND&#125; dbe8je6i4c3gjd50 -ss -e &quot;drop table mobile_ad_50_20170531&quot;echo &quot;drop ok&quot;$&#123;DB_COMMAND&#125; dbe8je6i4c3gjd50 -ss -e &quot;rename table mobile_ad_50 to mobile_ad_50_20170531&quot;echo &quot;rename ok&quot;$&#123;DB_COMMAND&#125; dbe8je6i4c3gjd50 -ss -e &quot;CREATE TABLE mobile_ad_50 (è¡¨ç»“æ„1234567891011121314151617181920212223242526272829303132333435*************************** 1. row *************************** Table: mobile_ad_50Create Table: CREATE TABLE `mobile_ad_50` ( `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®&#x27;, `dtime` datetime NOT NULL DEFAULT &#x27;0000-00-00 00:00:00&#x27; COMMENT &#x27;æ—¶é—´æ®µ å¹´æœˆæ—¥æ—¶&#x27;, `union_id` int(11) unsigned NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;åª’ä½“ID&#x27;, `ad_id` varchar(100) DEFAULT NULL COMMENT &#x27;å¹¿å‘Šä½ID&#x27;, `ifa` varchar(50) NOT NULL COMMENT &#x27;ifa&#x27;, `mac` varchar(50) NOT NULL COMMENT &#x27;mac&#x27;, `cb_url` varchar(1000) NOT NULL COMMENT &#x27;å›è°ƒåœ°å€&#x27;, `state` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦æ¿€æ´»&#x27;, `domain` varchar(30) NOT NULL COMMENT &#x27;æ¸¸æˆåŸŸå&#x27;, `game_code` varchar(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;æ¸¸æˆç¼–ç &#x27;, `union_app_id` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;æ¸ é“å•†çš„appid&#x27;, `openudid` char(50) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;å¼€æºå¹¿å‘Šæ ‡ç¤ºç¬¦&#x27;, `is_send` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;åŒæ­¥æ¬¡æ•°a&#x27;, `ip` bigint(20) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;ç‚¹å‡»ip&#x27;, `actip` bigint(20) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ¿€æ´»ip&#x27;, `opentime` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ‰“å¼€æ—¶é—´&#x27;, `acttime` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ¿€æ´»æ—¶é—´&#x27;, `is_open` tinyint(1) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;æ˜¯å¦æ‰“å¼€&#x27;, PRIMARY KEY (`id`), KEY `ifa` (`ifa`), KEY `d_u_s` (`domain`,`union_id`,`state`), KEY `union_id` (`union_id`), KEY `mac` (`mac`), KEY `dtime` (`dtime`), KEY `ip` (`ip`), KEY `actip` (`actip`), KEY `union_app_id` (`union_app_id`), KEY `openudid` (`openudid`), KEY `state` (`state`), KEY `acttime` (`acttime`)) ENGINE=InnoDB AUTO_INCREMENT=6154739813 DEFAULT CHARSET=utf8 COMMENT=&#x27;æ‰‹æœºå¹¿å‘Š&#x27;1 row in set (0.00 sec)å¼€å‘è¯´loadåªåœ¨ä¸»1æ‰§è¡Œ,å¹¶ä¸”è¿™ä¸ªè¡¨æ•°æ®éƒ½æ˜¯é€šè¿‡loadè¿›æ¥çš„,ç„¶åæœ‰äº›update,å°±å†æ²¡æœ‰å…¶ä»–insertè¯­å¥äº†ç°åœ¨å‘ç°é—®é¢˜å°±æ˜¯å‘ç°auto_incrementå¼‚å¸¸å¢å¤§,è¡¨ä¸­æœ‰ä¸¤äº¿æ•°æ®æ—¶,auto_incrementåˆ—æœ‰51äº¿.1234567891011121314151617181920212223242526mysql&gt; select id,dtime from mobile_ad_50 order by id limit 0,20;+------------+---------------------+| id | dtime |+------------+---------------------+| 2 | 2017-10-29 03:00:56 || 4 | 2017-10-29 03:00:56 || 6 | 2017-10-29 03:00:56 || 8 | 2017-10-29 03:00:57 || 10 | 2017-10-29 03:00:57 || 12 | 2017-10-29 03:00:57 || 14 | 2017-10-29 03:00:57 || 16 | 2017-10-29 03:00:57 || 18 | 2017-10-29 03:00:57 || 20 | 2017-10-29 03:00:57 || 22 | 2017-10-29 03:00:57 || 43 | 0000-00-00 00:00:00 || 5135418110 | 2017-10-29 03:00:10 || 5135418111 | 2017-10-29 03:00:00 || 5135418113 | 2017-10-29 03:00:00 || 5135418115 | 2017-10-29 03:00:00 || 5135418117 | 2017-10-29 03:00:00 || 5135418119 | 2017-10-29 03:00:00 || 5135418121 | 2017-10-29 03:00:00 || 5135418123 | 2017-10-29 03:00:00 |+------------+---------------------+20 rows in set (0.00 sec)çœ‹ä¸Šé¢çš„æŸ¥è¯¢æ˜¯æŒ‰ç…§ä¸»é”®æ’åºçš„,id=43ä¸€ä¸‹å°±æ¶¨åˆ°51äº¿æˆ‘æ€€ç–‘æ˜¯å–åˆ°äº†renameä¹‹å‰çš„è¡¨çš„è‡ªå¢å€¼,æŸ¥çœ‹äº†ä¸€ä¸‹,è¿˜çœŸæ˜¯1234567mysql&gt; select max(id) from mobile_ad_50_20170531;+------------+| max(id) |+------------+| 5135418109 |+------------+1 row in set (0.00 sec)è‡ªå·±åˆ†æåŸå› ä¸€ç§æ˜¯æ’å…¥å¤§é‡æ•°æ®årollbackå¯¼è‡´è‡ªå¢ä¸¢å¤±,ä½†æ˜¯å®é™…ä¸€æ¬¡load dataæ–‡ä»¶ä¹Ÿå°±å‡ åƒè¡Œ,ä¸å¯èƒ½ä¸¢å¤±è¿™ä¹ˆå¤š.ç¬¬äºŒä¸ªå¯èƒ½çš„åŸå› æ˜¯innodb_autoinc_lock_mode=1å¯¼è‡´çš„bulk insertæ—¶è‡ªå¢ä¸¢å¤±,ä½†æ˜¯æˆ‘æ¨¡æ‹Ÿäº†load ä¸¤äº¿æ•°æ®,è‡ªå¢idä¹Ÿå°±2äº¿1åƒå¤šä¸‡,ä¹Ÿä¸å¯èƒ½ä¸¢å¤±åˆ°51äº¿æˆ‘è§‚å¯Ÿbinlog,æ‰¾2017-10-29 03:00:10å·¦å³çš„,æœç´¢5135418110,æ‰¾åˆ°12345678910111213BEGIN/*!*/;# at 119255971#171029 3:00:10 server id 33 end_log_pos 119255999 IntvarSET INSERT_ID=5135418110/*!*/;# at 119255999#171029 3:00:10 server id 33 end_log_pos 119256303 Query thread_id=227034786 exec_time=6 error_code=0SET TIMESTAMP=1509217210/*!*/;INSERT INTO mobile_ad_50 ( DTIME, UNION_ID, AD_ID, IFA, MAC, CB_URL, STATE, DOMAIN, GAME_CODE, OPENTIME, IS_OPEN ) VALUES ( &#x27;2017-10-29 03:00:10&#x27;, 14800, &#x27;&#x27;, &#x27;865166021645612&#x27;, &#x27;&#x27;, &#x27;&#x27;, 0, &#x27;520050&#x27;, &#x27;android&#x27;, 1509217210, 1 )/*!*/;# at 119256303#171029 3:00:10 server id 33 end_log_pos 119256330 Xid = 99754915507COMMIT/*!*/;è¿™æ¡ä¹‹å‰çš„ä¸€ä¸ªSET INSERT_IDæ˜¯9000å¤šä¸‡1234567891011121314151617BEGIN/*!*/;# at 119256931#171029 3:00:11 server id 33 end_log_pos 119257377 Query thread_id=227034792 exec_time=5 error_code=0SET TIMESTAMP=1509217211/*!*/;UPDATE wechat SET ACCESS_TOKEN=&#x27;oEBoeHxXah3WEPAm_pJbQ-E2dVR2WVTkXn0mQ7YfY20grgt3k29-e518F1OELmHepZumWfxjNuDO7agVyNZZnkfG_xao-yWbfRv90x1ZoN_uQ1ogvsyJazUIVygldMcBBGWdAHAIND&#x27;, ATOKEN_EXPIRES=&#x27;2017-10-29 04:58:11&#x27;, JSAPI_TICKET=&#x27;kgt8ON7yVITDhtdwci0qeXl3u2D35Jw6KZsyUHYlRNK5VfCPXbMWbtYLkPOWe2hDlrlrly_FyrO3yjhXqhSezg&#x27;, JSTICKET_EXPIRES=&#x27;2017-10-29 04:58:11&#x27; WHERE id = 20/*!*/;SET INSERT_ID=90238492/*!*/;# at 119254523#171029 3:00:08 server id 33 end_log_pos 119254827 Query thread_id=227034786 exec_time=8 error_code=0SET TIMESTAMP=1509217208/*!*/;INSERT INTO mobile_ad_55 ( DTIME, UNION_ID, AD_ID, IFA, MAC, CB_URL, STATE, DOMAIN, GAME_CODE, OPENTIME, IS_OPEN ) VALUES ( &#x27;2017-10-29 03:00:08&#x27;, 10332, &#x27;&#x27;, &#x27;863777021706899&#x27;, &#x27;&#x27;, &#x27;&#x27;, 0, &#x27;520055&#x27;, &#x27;android&#x27;, 1509217208, 1 )/*!*/;# at 119254827#171029 3:00:08 server id 33 end_log_pos 119254854 Xid = 99754915501COMMIT/*!*/;å¼€å‘ä¸æ˜¯è¯´æ²¡æœ‰å…¶ä»–çš„insertè¯­å¥äº†å—???æ€ä¹ˆè¿™é‡Œæœ‰ä¸€æ¡,çœ‹ä¸€ä¸‹server id 33è¿˜æ˜¯ä¸»2åŒæ­¥è¿‡æ¥çš„åœ¨åˆ†æä¸€ä¸‹ä¸¤è¾¹binlog1234567891011121314151617181920212223242526ä¸»1#171029 3:00:15 server id 32 end_log_pos 118195605 Query thread_id=2636976237 exec_time=0 error_code=0SET TIMESTAMP=1509217215/*!*/;rename table mobile_ad_50 to mobile_ad_50_20170531#171029 3:00:10 server id 33 end_log_pos 119255999 IntvarSET INSERT_ID=5135418110/*!*/;# at 119255999#171029 3:00:10 server id 33 end_log_pos 119256303 Query thread_id=227034786 exec_time=6 error_code=0SET TIMESTAMP=1509217210/*!*/;INSERT INTO mobile_ad_50 ( DTIME, UNION_ID, AD_ID, IFA, MAC, CB_URL, STATE, DOMAIN, GAME_CODE, OPENTIME, IS_OPEä¸»2SET TIMESTAMP=1509217215/*!*/;SET @@session.auto_increment_increment=2, @@session.auto_increment_offset=1/*!*/;rename table mobile_ad_50 to mobile_ad_50_20170531/*!*/;#171029 3:00:10 server id 33 end_log_pos 268758734 IntvarSET INSERT_ID=5135418110/*!*/;# at 268758734#171029 3:00:10 server id 33 end_log_pos 268759038 Query thread_id=227034786 exec_time=0 error_code=0SET TIMESTAMP=1509217210/*!*/; é—®é¢˜åŸå› ç°åœ¨åˆ†æä¸€ä¸‹3:00:10 ä¸»2 SET INSERT_ID=5135418110 insert mobile_ad_503:00:15 ä¸»1 rename table1234567891011121314151617181920213.00.10 ä¸»1 ä¸»2 SET INSERT_ID=5135418110 insert mobile_ad_50æº &lt;---é€šè¿‡binlogåŒæ­¥ç»™ä¸»1--- ç”±äºå¤åˆ¶å»¶è¿Ÿ,ä¸»1è¿™ä¸€æ¡insertè¿˜æ²¡æ‰§è¡Œ3.00.15 ä¸»1 ä¸»2 rename ---é€šè¿‡binlogåŒæ­¥ç»™ä¸»2---&gt; renameè¿™æ—¶ä¸»1æ‰æ‰§è¡ŒSET INSERT_ID=5135418110 insert mobile_ad_50,ä¸»1æ–°åˆ›å»ºçš„mobile_ad_50è¡¨&quot;ç»§æ‰¿äº†&quot;åŸæ¥çš„mobile_ad_50ä¹Ÿå°±æ˜¯mobile_ad_50_20170531è¡¨çš„ID,å¯¼è‡´äº†IDæš´å¢è¯æ®æ˜¯5135418110åœ¨ä¸»1çš„ mobile_ad_50ä¸­,è€Œä¸»2çš„mobile_ad_50ä¸­æ²¡æœ‰,å®é™…ä¸Š5135418110åœ¨ä¸»2çš„mobile_ad_50_20170531ä¸­mysql&gt; select id,dtime from mobile_ad_50 where id=5135418110;Empty set (0.00 sec)mysql&gt; select id,dtime from mobile_ad_50_20170531 where id=5135418110;+------------+---------------------+| id | dtime |+------------+---------------------+| 5135418110 | 2017-10-29 03:00:10 |+------------+---------------------+","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"Binlog Server pythonè„šæœ¬","slug":"Binlog-Server-pythonè„šæœ¬","date":"2017-10-18T09:23:00.000Z","updated":"2018-05-03T08:42:23.000Z","comments":true,"path":"2017/10/18/Binlog-Server-pythonè„šæœ¬/","link":"","permalink":"http://fuxkdb.com/2017/10/18/Binlog-Server-python%E8%84%9A%E6%9C%AC/","excerpt":"","text":"æœ‰é—®é¢˜å°±æ˜¯å¦‚æœnohup python binlog_server.py &amp; ,ç„¶åkill è¿™ä¸ªè„šæœ¬,èƒ½killæ‰,ä½†æ˜¯ps -ef | grep mysqlbinlog è¿˜æ˜¯åœ¨æ‰§è¡Œhè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜å°±æ˜¯å¦‚æœç›´æ¥ä»¥å‘½ä»¤è¡Œæ–¹å¼è¿è¡Œæ˜æ–‡æŒ‡å®šå¯†ç ,é‚£ä¹ˆé€šè¿‡ps -ef | grep mysqlbinlogä¼šç›´æ¥çœ‹åˆ°å¯†ç â€¦å¯†ç å†™åˆ°é…ç½®æ–‡ä»¶çš„è¯ä¹Ÿä¸å¤ªå®‰å…¨,æ€»ä¹‹,è¿˜éœ€è¦å®Œå–„ æŒ‡å®šä¸åŒçš„dbname,ä»ä¸åŒçš„æ•°æ®åº“æ‹‰binlog, dbnameå°±æ˜¯é…ç½®æ–‡ä»¶é‡Œçš„section åˆ›å»ºç”¨æˆ·1GRANT REPLICATION SLAVE ON *.* TO &#x27;binlog_backup&#x27;@&#x27;106.3.130.255&#x27; IDENTIFIED BY &#x27;xxx&#x27; fw.shæ·»åŠ 12#å¤‡ä»½binlog$IPTABLES -A INPUT -p tcp -s 106.3.130.255 --dport 3306 -j ACCEPT è„šæœ¬123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899&quot;&quot;&quot;Usage: binlog_server.py --user=&lt;username&gt; --password=&lt;password&gt; --host=&lt;remote_host&gt; --port=&lt;remote_port&gt; --backup-dir=&lt;backup_dir&gt; --log=&lt;log&gt; [--last-file=&lt;last-file&gt;] binlog_server.py -h | --help binlog_server.py --version binlog_server.py --config=&lt;config_file&gt; --dbname=&lt;database_name&gt; [--last-file=&lt;last-file&gt;]Options: -h --help Show help information. --version Show version. --user=&lt;username&gt; The user name used to connect to the remote server. --password=&lt;password&gt; The password used to connect to the remote server. --host=&lt;remote_host&gt; The remote host IP address. --port=&lt;remote_port&gt; The remote MySQL server port. --backup-dir=&lt;backup_dir&gt; The dest to store binlog. --log=&lt;log&gt; The log. --last-file=&lt;last-file&gt; Specify the starting binlog. --config=&lt;config_file&gt; Config file. --dbname=&lt;database_name&gt; Section name in config file.&quot;&quot;&quot;from docopt import docoptimport subprocessimport loggingimport timeimport ConfigParserimport osarguments = docopt(__doc__, version=&#x27;Binlog server 1.0&#x27;)if arguments[&#x27;--config&#x27;]: cf=ConfigParser.ConfigParser() cf.read(arguments[&#x27;--config&#x27;]) section_name = arguments[&#x27;--dbname&#x27;] db_host = cf.get(section_name, &quot;db_host&quot;) db_port = cf.get(section_name, &quot;db_port&quot;) db_user = cf.get(section_name, &quot;db_user&quot;) db_passwd = cf.get(section_name, &quot;db_passwd&quot;) backup_dir = cf.get(section_name, &quot;backup_dir&quot;) log = cf.get(section_name, &quot;log&quot;) logging.basicConfig(level=logging.DEBUG, format=&#x27;%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s&#x27;, datefmt=&#x27;%a, %d %b %Y %H:%M:%S&#x27;, filename=log, filemode=&#x27;a&#x27;)logging.basicConfig(level=logging.DEBUG, format=&#x27;%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s&#x27;, datefmt=&#x27;%a, %d %b %Y %H:%M:%S&#x27;, filename=arguments[&#x27;--log&#x27;], filemode=&#x27;a&#x27;)def dumpBinlog(user,password,host,port,backup_dir,log,last_file=&#x27;&#x27;): LOCAL_BACKUP_DIR=backup_dir if backup_dir[-1]!= &#x27;/&#x27;: os.exit() #BACKUP_LOG=&#x27;/data4/binlog_backup/120.27.136.247/BB.log&#x27; BACKUP_LOG=log[log.rfind(&#x27;/&#x27;)+1:] while True: if not last_file: cmd=&quot;ls -A &#123;LOCAL_BACKUP_DIR&#125; | grep -v &#123;BACKUP_LOG&#125; | grep -v nohup.out |wc -l&quot;.format(LOCAL_BACKUP_DIR=LOCAL_BACKUP_DIR,BACKUP_LOG=BACKUP_LOG) child=subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE) child.wait() wc_l=int(child.communicate()[0].strip()) if wc_l != 0: cmd=&quot;ls -l %s | grep -v %s | grep -v nohup.out |tail -n 1 |awk &#x27;&#123;print $9&#125;&#x27;&quot; % (LOCAL_BACKUP_DIR,BACKUP_LOG) child=subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE) child.wait() LAST_FILE=child.communicate()[0].strip() else: LAST_FILE=last_file logging.info(&#x27;Last File is %s&#x27; % (LAST_FILE)) mysqlbinlog=&#x27;mysqlbinlog --raw --read-from-remote-server --stop-never --host=&#123;REMOTE_HOST&#125; --port=&#123;REMOTE_PORT&#125; --user=&#123;REMOTE_USER&#125; --password=&#123;REMOTE_PASS&#125; --result-file=&#123;RESULT_FILE&#125; &#123;LAST_FILE&#125;&#x27;.format(REMOTE_HOST=host,REMOTE_PORT=port,REMOTE_USER=user,REMOTE_PASS=password,RESULT_FILE=LOCAL_BACKUP_DIR,LAST_FILE=LAST_FILE) subprocess.call(mysqlbinlog,shell=True) logging.info(&#x27;Binlog server stop!!!,reconnect after 10 seconds&#x27;) time.sleep(10)if __name__ == &#x27;__main__&#x27;: if arguments[&#x27;--config&#x27;]: lock_file=db_host+&quot;_binlog_server.lock&quot; else: lock_file=arguments[&#x27;--host&#x27;]+&quot;_binlog_server.lock&quot; child=subprocess.Popen(&#x27;ls /tmp|grep %s&#x27; % (lock_file),shell=True,stdout=subprocess.PIPE) child.wait() lock=child.communicate()[0].strip() if not lock: subprocess.call(&#x27;touch /tmp/%s&#x27; % (lock_file),shell=True) logging.info(&#x27;Get lock,Binlog server start!!!&#x27;) if not arguments[&#x27;--config&#x27;]: dumpBinlog(arguments[&#x27;--user&#x27;],arguments[&#x27;--password&#x27;],arguments[&#x27;--host&#x27;],arguments[&#x27;--port&#x27;],arguments[&#x27;--backup-dir&#x27;],arguments[&#x27;--log&#x27;],arguments[&#x27;--last-file&#x27;]) else: dumpBinlog(db_user,db_passwd,db_host,db_port,backup_dir,log,arguments[&#x27;--last-file&#x27;]) else: logging.info(&#x27;Binlog server already running!!!&#x27;) print(&#x27;Binlog server already running!!!,please check or reomove the lock file&#x27;) ç›‘æ§è„šæœ¬123456789101112#!/bin/bashnum_py=`ps -ef | grep binlog_server.py | grep -v grep | grep GN_PT_SLAVE1 | wc -l`num_mysqlbinlog=`ps -ef | grep mysqlbinlog | grep -v grep | grep 120.27.136.247 | wc -l`TO_MAIL=xoxoxo@papapa.comif [ $num_py -eq 0 ] &amp;&amp; [ $num_mysqlbinlog -eq 0 ];then #å‘é‚®ä»¶,GN_PT_SLAVE1 binlog serverå®•äº† #é‡å¯ nohup python /scripts/binlog_server.py --config=/tmp/binlog_server.cnf --dbname=GN_PT_SLAVE1 &amp; echo &quot;GN_PT_SLAVE1 binlog serverå®•äº†&quot; |/usr/bin/mutt -s &quot;Binlog serverç›‘æ§å‘Šè­¦&quot; $TO_MAILelif [ $num_py -eq 0 ] &amp;&amp; [ $num_mysqlbinlog -eq 1 ];then #å‘é‚®ä»¶,GN_PT_SLAVE1 pythonè„šæœ¬æŒ‚äº†,ä½†æ˜¯mysqlbinlogè¿˜åœ¨è·‘ echo &quot;GN_PT_SLAVE1 pythonè„šæœ¬æŒ‚äº†,ä½†æ˜¯mysqlbinlogè¿˜åœ¨è·‘&quot; |/usr/bin/mutt -s &quot;Binlog serverç›‘æ§å‘Šè­¦&quot; $TO_MAILfi é…ç½®æ–‡ä»¶12345678910111213141516[root@localhost 120.27.143.36]# less /scripts/binlog_server.cnf [GN_PT_SLAVE1]db_host=120.27.136.257db_port=3306db_user=binlog_backupdb_passwd=xxxbackup_dir=/data1/backup/db_backup/120.27.136.247/ --æ³¨æ„ä¸€å®šè¦ä»¥/ç»“å°¾log=/data1/backup/db_backup/120.27.136.247/BB.log[GN_LOG_MASTER2]db_host=120.27.143.256db_port=3306db_user=binlog_backupdb_passwd=xxxbackup_dir=/data2/backup/db_backup/120.27.143.36/ --æ³¨æ„ä¸€å®šè¦ä»¥/ç»“å°¾log=/data2/backup/db_backup/120.27.143.36/BB.log ä½¿ç”¨æ–¹æ³•ä¸¤ç§æ–¹å¼1.é€šè¿‡é…ç½®æ–‡ä»¶1python /scripts/binlog_server.py --config=/tmp/binlog_server.cnf --dbname=GN_PT_SLAVE12.å‘½ä»¤è¡ŒæŒ‡å®šæ³¨æ„backup-dirä¸€å®šè¦ä»¥â€™/â€˜ç»“å°¾1python binlog_server.py --user=binlog_backup --password=xxxx --host=xxxx --port=3306 --backup-dir=/data4/binlog_backup/ --log=/data4/binlog_backup/BB.logåœ¨è„šæœ¬ä¸­ åˆ›å»ºäº†/tmp/IP_binlog_server.lock æ–‡ä»¶,ä¸ºäº†é˜²æ­¢é‡å¤è¿è¡Œ.å¦‚æœæœ‰éœ€è¦åœæ­¢,éœ€è¦æ‰‹åŠ¨kill binlog_server.py å’Œ mysqlbinlog, å¹¶ä¸”åˆ é™¤/tmp/IP_binlog_server.lock æ–‡ä»¶,ä¸ç„¶ä¸‹æ¬¡èµ·ä¸æ¥","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"PMMå‡ºé—®é¢˜æ’æŸ¥","slug":"PMMå‡ºé—®é¢˜æ’æŸ¥","date":"2017-09-29T01:52:00.000Z","updated":"2017-12-15T05:31:18.000Z","comments":true,"path":"2017/09/29/PMMå‡ºé—®é¢˜æ’æŸ¥/","link":"","permalink":"http://fuxkdb.com/2017/09/29/PMM%E5%87%BA%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/","excerpt":"","text":"çœ‹å„ç§æ—¥å¿—monitoring service12345[root@node4 ~]# ll /var/log/pmm-*-rw-r--r--. 1 root root 1880 Sep 27 18:02 /var/log/pmm-linux-metrics-42000.log-rw-r--r--. 1 root root 783 Sep 27 18:02 /var/log/pmm-mysql-metrics-42002.log-rw-r--r--. 1 root root 7143 Sep 27 18:08 /var/log/pmm-mysql-queries-0.logdockeré‡Œçš„æ—¥å¿—12345678910111213141516[root@node4 log]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESe4916410b314 percona/pmm-server:latest &quot;/opt/entrypoint.sh&quot; 2 hours ago Up 31 minutes 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server948a9aeb047e percona/pmm-server:latest &quot;/bin/true&quot; 2 hours ago Created pmm-data[root@node4 log]# docker logs e4916410b3142017-09-27 08:39:47,175 CRIT Supervisor running as root (no user in config file)2017-09-27 08:39:47,175 WARN Included extra file &quot;/etc/supervisord.d/pmm.ini&quot; during parsingUnlinking stale socket /var/run/supervisor/supervisor.sock2017-09-27 08:39:47,527 INFO RPC interface &#x27;supervisor&#x27; initialized2017-09-27 08:39:47,528 INFO supervisord started with pid 12017-09-27 08:39:48,536 INFO spawned: &#x27;mysql&#x27; with pid 152017-09-27 08:39:48,543 INFO spawned: &#x27;consul&#x27; with pid 162017-09-27 08:39:48,552 INFO spawned: &#x27;grafana&#x27; with pid 172017-09-27 08:39:48,563 INFO spawned: &#x27;nginx&#x27; with pid 182017-09-27 08:39:48,610 INFO spawned: &#x27;cron&#x27; with pid 192017-09-27 08:39:48,612 INFO spawned: &#x27;qan-api&#x27; with pid 20è¿›å»å®¹å™¨çœ‹1234docker exec -it e4916410b314 /bin/bash/var/log ä¸‹é¢å„ç§æ—¥å¿—/var/log/grafana/grafana.log/var/log/prometheus.log pmm-admin listæ˜¯yesä¸ä»£è¡¨æ²¡é—®é¢˜,check-networkçœ‹çœ‹123456789101112131415161718192021222324252627282930313233[root@node4 ~]# pmm-admin check-networkPMM Network StatusServer Address | 172.16.83.103Client Address | 172.16.83.103 * System TimeNTP Server (0.pool.ntp.org) | 2017-09-27 17:13:58 +0800 CSTPMM Server | 2017-09-27 09:13:58 +0000 GMTPMM Client | 2017-09-27 17:13:58 +0800 CSTPMM Server Time Drift | OKPMM Client Time Drift | OKPMM Client to PMM Server Time Drift | OK* Connection: Client --&gt; Server-------------------- ------- SERVER SERVICE STATUS -------------------- ------- Consul API OKPrometheus API OKQuery Analytics API OKConnection duration | 551.133ÂµsRequest duration | 2.467879msFull round trip | 3.019012ms* Connection: Client &lt;-- Server-------------- ------ -------------------- ------- ---------- ---------SERVICE TYPE NAME REMOTE ENDPOINT STATUS HTTPS/TLS PASSWORD -------------- ------ -------------------- ------- ---------- ---------linux:metrics node4 172.16.83.103:42000 OK YES - mysql:metrics node4 172.16.83.103:42002 OK YES -","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLç›‘æ§","slug":"MySQLç›‘æ§","permalink":"http://fuxkdb.com/tags/MySQL%E7%9B%91%E6%8E%A7/"},{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"PMMè®¾ç½®grafanaç™»å½•ç”¨æˆ·","slug":"PMMè®¾ç½®grafanaç™»å½•ç”¨æˆ·","date":"2017-09-29T01:52:00.000Z","updated":"2018-05-03T08:33:05.000Z","comments":true,"path":"2017/09/29/PMMè®¾ç½®grafanaç™»å½•ç”¨æˆ·/","link":"","permalink":"http://fuxkdb.com/2017/09/29/PMM%E8%AE%BE%E7%BD%AEgrafana%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7/","excerpt":"å‰è¨€PMMä½¿ç”¨grafanaè¿›è¡Œå±•ç¤º,é»˜è®¤æ˜¯å…è®¸åŒ¿åç™»é™†çš„,ä¹Ÿå°±æ˜¯è¯´æ— éœ€å¡«å†™ç”¨æˆ·åå¯†ç å°±å¯ä»¥æŸ¥çœ‹,ä¿®æ”¹ä»ªè¡¨ç›˜ä½†æ˜¯é¢†å¯¼è¯´äº†,æ²¡ç”¨æˆ·å¯†ç å°±èƒ½è¿ä¸Šæ¥å’‹è¡Œå‘¢. è¿›å…¥å®¹å™¨123456[root@localhost ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESc74f5be8ed88 percona/pmm-server:latest &quot;/opt/entrypoint.sh&quot; 5 hours ago Up 32 minutes 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server28c991142e6d percona/pmm-server:latest &quot;/bin/true&quot; 5 hours ago Created pmm-data[root@localhost ~]# docker exec -it c74f5be8ed88 /bin/bash[root@c74f5be8ed88 opt]# æŸ¥çœ‹grafana.ini12345678[root@c74f5be8ed88 opt]# vi /etc/grafana/grafana.ini æ‰¾åˆ°è¿™é‡Œ#################################### Anonymous Auth ##########################[auth.anonymous]# enable anonymous access#enabled = TrueæŠŠenabled = Tureæ³¨é‡Šæ‰,è¿™æ ·æ—¢ç¦æ­¢åŒ¿åç”¨æˆ·ç™»é™†äº†ç°åœ¨å¦‚æœé‡å¯å®¹å™¨,å†æ‰“å¼€é¡µé¢,ä½ ä¼šå‘ç°è‡ªå·±è¿›ä¸å»äº†..å’‹åŠå‘¢ ä¿®æ”¹æ•°æ®åº“è¿›å…¥å®¹å™¨1234567891011ç™»å½•æ•°æ®åº“sqlite3 /var/lib/grafana/grafana.db ä¿®æ”¹userè¡¨,æŠŠadminå¯†ç æ”¹æˆadminupdate user set password = &#x27;59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6&#x27;, salt = &#x27;F3FAxVm33R&#x27; where login = &#x27;admin&#x27;å®‰å…¨èµ·è§,ä¹Ÿå¯ä»¥æŠŠadminå¯†ç æ”¹æˆTdPXP4sgupdate user set password=&#x27;11cf3a1ee21b046b939b5f0cdc9d92ab70ba66e4e53f301fb2456ee7b6a665d8abf0d5b387ae0ec53f5f5fc8e477bfbe073e&#x27;,salt=&#x27;AHxOW2Fn34&#x27;,name=&#x27;admin&#x27;,is_admin=1 where login=&#x27;admin&#x27;;åˆ›å»ºmonitorç”¨æˆ·å¯†ç mj8toYLBINSERT INTO &quot;user&quot; VALUES(3,0,&#x27;monitor&#x27;,&#x27;monitor@papapa.com&#x27;,&#x27;monitor&#x27;,&#x27;98c8e341360759e957ac43e2543fab4eef420a3521450d03ad79d5a1dd76dee233a9ec11870264c2e4dd7266d1a1f68681c2&#x27;,&#x27;erShkEJCWn&#x27;,&#x27;Y9TF6hFebE&#x27;,&#x27;&#x27;,1,0,0,&#x27;&#x27;,&#x27;2017-09-28 10:21:10&#x27;,&#x27;2017-09-28 10:21:10&#x27;,0);","text":"å‰è¨€PMMä½¿ç”¨grafanaè¿›è¡Œå±•ç¤º,é»˜è®¤æ˜¯å…è®¸åŒ¿åç™»é™†çš„,ä¹Ÿå°±æ˜¯è¯´æ— éœ€å¡«å†™ç”¨æˆ·åå¯†ç å°±å¯ä»¥æŸ¥çœ‹,ä¿®æ”¹ä»ªè¡¨ç›˜ä½†æ˜¯é¢†å¯¼è¯´äº†,æ²¡ç”¨æˆ·å¯†ç å°±èƒ½è¿ä¸Šæ¥å’‹è¡Œå‘¢. è¿›å…¥å®¹å™¨123456[root@localhost ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESc74f5be8ed88 percona/pmm-server:latest &quot;/opt/entrypoint.sh&quot; 5 hours ago Up 32 minutes 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server28c991142e6d percona/pmm-server:latest &quot;/bin/true&quot; 5 hours ago Created pmm-data[root@localhost ~]# docker exec -it c74f5be8ed88 /bin/bash[root@c74f5be8ed88 opt]# æŸ¥çœ‹grafana.ini12345678[root@c74f5be8ed88 opt]# vi /etc/grafana/grafana.ini æ‰¾åˆ°è¿™é‡Œ#################################### Anonymous Auth ##########################[auth.anonymous]# enable anonymous access#enabled = TrueæŠŠenabled = Tureæ³¨é‡Šæ‰,è¿™æ ·æ—¢ç¦æ­¢åŒ¿åç”¨æˆ·ç™»é™†äº†ç°åœ¨å¦‚æœé‡å¯å®¹å™¨,å†æ‰“å¼€é¡µé¢,ä½ ä¼šå‘ç°è‡ªå·±è¿›ä¸å»äº†..å’‹åŠå‘¢ ä¿®æ”¹æ•°æ®åº“è¿›å…¥å®¹å™¨1234567891011ç™»å½•æ•°æ®åº“sqlite3 /var/lib/grafana/grafana.db ä¿®æ”¹userè¡¨,æŠŠadminå¯†ç æ”¹æˆadminupdate user set password = &#x27;59acf18b94d7eb0694c61e60ce44c110c7a683ac6a8f09580d626f90f4a242000746579358d77dd9e570e83fa24faa88a8a6&#x27;, salt = &#x27;F3FAxVm33R&#x27; where login = &#x27;admin&#x27;å®‰å…¨èµ·è§,ä¹Ÿå¯ä»¥æŠŠadminå¯†ç æ”¹æˆTdPXP4sgupdate user set password=&#x27;11cf3a1ee21b046b939b5f0cdc9d92ab70ba66e4e53f301fb2456ee7b6a665d8abf0d5b387ae0ec53f5f5fc8e477bfbe073e&#x27;,salt=&#x27;AHxOW2Fn34&#x27;,name=&#x27;admin&#x27;,is_admin=1 where login=&#x27;admin&#x27;;åˆ›å»ºmonitorç”¨æˆ·å¯†ç mj8toYLBINSERT INTO &quot;user&quot; VALUES(3,0,&#x27;monitor&#x27;,&#x27;monitor@papapa.com&#x27;,&#x27;monitor&#x27;,&#x27;98c8e341360759e957ac43e2543fab4eef420a3521450d03ad79d5a1dd76dee233a9ec11870264c2e4dd7266d1a1f68681c2&#x27;,&#x27;erShkEJCWn&#x27;,&#x27;Y9TF6hFebE&#x27;,&#x27;&#x27;,1,0,0,&#x27;&#x27;,&#x27;2017-09-28 10:21:10&#x27;,&#x27;2017-09-28 10:21:10&#x27;,0);è¿™äº›å¯†ç æ˜¯ç»è¿‡å‡½æ•°è¿ç®—å‡ºæ¥çš„,æˆ‘ä¹Ÿä¸çŸ¥é“æ˜¯å•¥å‡½æ•°,ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å¼€å¯ç”¨æˆ·æ³¨å†Œ,è‡ªå·±åˆ›å»ºç”¨æˆ·,ç„¶åå†æŸ¥çœ‹userè¡¨çš„æ•°æ®æ¥è‡ªå·±å®šä¹‰å¯†ç (ä¸è¦å¿˜è®°saltåˆ—ä¹Ÿè¦æ›´æ–°)å¼€å¯ç”¨æˆ·æ³¨å†Œ12345#################################### Users ####################################[users]# disable user signup / registrationallow_sign_up = trueå–æ¶ˆallow_sign_up = trueæ³¨é‡Š sqlite312345æŸ¥çœ‹userè¡¨ç»“æ„select * from sqlite_master where type=&quot;table&quot; and name=&quot;user&quot;å¯¼å‡ºæˆsqlæ–‡ä»¶.output user.sql.dump user æˆ–è€…ä¿®æ”¹å¥½adminå¯†ç å°±å¯ä»¥ç™»å½•äº†,ç„¶åå¯ä»¥ä¿®æ”¹å…¶ä»–ç”¨æˆ·çš„å¯†ç æŠŠç›‘æ§ç”¨æˆ·åŠ å…¥ç»„,ä¸ç„¶æ²¡æœ‰ä»ªè¡¨ç›˜","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLç›‘æ§","slug":"MySQLç›‘æ§","permalink":"http://fuxkdb.com/tags/MySQL%E7%9B%91%E6%8E%A7/"},{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"MySQLå¿˜è®°å¯†ç å¤„ç†æ–¹æ³•,æ— éœ€é‡å¯","slug":"MySQLå¿˜è®°å¯†ç å¤„ç†æ–¹æ³•,æ— éœ€é‡å¯","date":"2017-09-12T07:18:00.000Z","updated":"2017-09-12T07:18:57.000Z","comments":true,"path":"2017/09/12/MySQLå¿˜è®°å¯†ç å¤„ç†æ–¹æ³•,æ— éœ€é‡å¯/","link":"","permalink":"http://fuxkdb.com/2017/09/12/MySQL%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95,%E6%97%A0%E9%9C%80%E9%87%8D%E5%90%AF/","excerpt":"æºåº“è¿™è¾¹è·‘ä¸€ä¸ªsysbench,ä¸ºäº†æµ‹è¯•ä¹‹åkill -HUPæ˜¯ä¸æ˜¯ä¼šæœ‰å½±å“1234567891011sysbench /usr/share/sysbench/oltp_read_write.lua --mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysqldata/3306/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 --threads=30 \\--events=5000000 --report-interval=5 --db-driver=mysql preparesysbench \\/usr/share/sysbench/oltp_read_write.lua \\--mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysqldata/3306/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 \\--threads=30 --report-interval=5 --time=7000 --db-driver=mysql run &gt; binlog_off.txt æŠŠå¿˜è®°å¯†ç çš„åº“çš„mysql.userè¡¨ä¼ åˆ°ä¸€ä¸ªçŸ¥é“å¯†ç çš„æµ‹è¯•åº“12345[root@uz22199 mysql]# scp -p user.* 10.4.3.100:/data/mysqldata/3306/data/fandb/root@10.4.3.100&#x27;s password: user.frm 100% 11KB 10.6KB/s 00:00 user.MYD 100% 736 0.7KB/s 00:00 user.MYI 100% 4096 4.0KB/s 00:00 ç”Ÿæˆä¸€ä¸‹insertè¯­å¥,åé¢ç”¨1234[root@test43100 ~]# mysqldump --user=root --password=&#x27;mysql&#x27; fandb user --where=&quot;host=&#x27;localhost&#x27; and user=&#x27;root&#x27;&quot; |grep INSERTmysqldump: [Warning] Using a password on the command line interface can be insecure.Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don&#x27;t want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. INSERT INTO `user` VALUES (&#x27;localhost&#x27;,&#x27;root&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,0,0,0,0,&#x27;mysql_native_password&#x27;,&#x27;*81F5E21E35407D884A6CD4A731AEBFB6AF209E1B&#x27;,&#x27;N&#x27;,&#x27;2017-08-04 08:12:53&#x27;,NULL,&#x27;N&#x27;);","text":"æºåº“è¿™è¾¹è·‘ä¸€ä¸ªsysbench,ä¸ºäº†æµ‹è¯•ä¹‹åkill -HUPæ˜¯ä¸æ˜¯ä¼šæœ‰å½±å“1234567891011sysbench /usr/share/sysbench/oltp_read_write.lua --mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysqldata/3306/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 --threads=30 \\--events=5000000 --report-interval=5 --db-driver=mysql preparesysbench \\/usr/share/sysbench/oltp_read_write.lua \\--mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysqldata/3306/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 \\--threads=30 --report-interval=5 --time=7000 --db-driver=mysql run &gt; binlog_off.txt æŠŠå¿˜è®°å¯†ç çš„åº“çš„mysql.userè¡¨ä¼ åˆ°ä¸€ä¸ªçŸ¥é“å¯†ç çš„æµ‹è¯•åº“12345[root@uz22199 mysql]# scp -p user.* 10.4.3.100:/data/mysqldata/3306/data/fandb/root@10.4.3.100&#x27;s password: user.frm 100% 11KB 10.6KB/s 00:00 user.MYD 100% 736 0.7KB/s 00:00 user.MYI 100% 4096 4.0KB/s 00:00 ç”Ÿæˆä¸€ä¸‹insertè¯­å¥,åé¢ç”¨1234[root@test43100 ~]# mysqldump --user=root --password=&#x27;mysql&#x27; fandb user --where=&quot;host=&#x27;localhost&#x27; and user=&#x27;root&#x27;&quot; |grep INSERTmysqldump: [Warning] Using a password on the command line interface can be insecure.Warning: A partial dump from a server that has GTIDs will by default include the GTIDs of all transactions, even those that changed suppressed parts of the database. If you don&#x27;t want to restore GTIDs, pass --set-gtid-purged=OFF. To make a complete dump, pass --all-databases --triggers --routines --events. INSERT INTO `user` VALUES (&#x27;localhost&#x27;,&#x27;root&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,0,0,0,0,&#x27;mysql_native_password&#x27;,&#x27;*81F5E21E35407D884A6CD4A731AEBFB6AF209E1B&#x27;,&#x27;N&#x27;,&#x27;2017-08-04 08:12:53&#x27;,NULL,&#x27;N&#x27;);æ–°ç”¨æˆ·å¯†ç mysql123456root@mysqldb 15:04: [(none)]&gt; select password(&#x27;mysql&#x27;);+-------------------------------------------+| password(&#x27;mysql&#x27;) |+-------------------------------------------+| *E74858DB86EBA20BC33D0AECAE8A8108C56B17FA |+-------------------------------------------+ æ–°æ’å…¥ä¸€ä¸ªç”¨æˆ·,æŠŠä¸Šé¢çš„insertæ”¹ä¸€ä¸‹1INSERT INTO `user` VALUES (&#x27;localhost&#x27;,&#x27;fanboshi&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;Y&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,0,0,0,0,&#x27;mysql_native_password&#x27;,&#x27;*E74858DB86EBA20BC33D0AECAE8A8108C56B17FA&#x27;,&#x27;N&#x27;,&#x27;2017-08-04 08:12:53&#x27;,NULL,&#x27;N&#x27;);å…³é—­è¡¨1root@mysqldb 15:05: [(none)]&gt; flush tables; ä¼ å›æºåº“12345[root@test43100 fandb]# scp -p user.* 10.4.1.45:/data/mysqldata/3306/data/mysql/root@10.4.1.45&#x27;s password: user.frm 100% 11KB 10.6KB/s 00:00 user.MYD 100% 864 0.8KB/s 00:00 user.MYI æ— æ³•ç™»é™†123[root@uz22199 ~]# mysql -ufanboshi -pmysqlmysql: [Warning] Using a password on the command line interface can be insecure.ERROR 1045 (28000): Access denied for user &#x27;fanboshi&#x27;@&#x27;localhost&#x27; (using password: YES) flush privileges123456789101112131415161718root@mysqldb 14:53: [mysql]&gt; flush privileges;Query OK, 0 rows affected (0.82 sec)[root@uz22199 ~]# mysql -ufanboshi -pmysqlmysql: [Warning] Using a password on the command line interface can be insecure.Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 44Server version: 5.7.18-log MySQL Community Server (GPL)Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &#x27;help;&#x27; or &#x27;\\h&#x27; for help. Type &#x27;\\c&#x27; to clear the current input statement.fanboshi@mysqldb 14:54: [(none)]&gt; quitflush privilegeså®Œäº†å°±å¯ä»¥ç™»é™†äº†,ä¸çŸ¥é“åªè¿™æ ·åšå¯ä»¥ä¸å¯ä»¥,è¿˜æ˜¯æŒ‰å´æ€»æ¥å§ çœ‹ä¸€ä¸‹ç°åœ¨mysqldè¿›ç¨‹å·12345[root@uz22199 ~]# ps -ef| grep mysqldroot 14676 1 0 Sep11 ? 00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --relay-log-recovery=0mysql 16188 14676 2 Sep11 ? 00:33:24 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/data/mysqldata/3306/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --relay-log-recovery=0 --log-error=/data/mysqldata/3306/data/../error.log --open-files-limit=65535 --pid-file=/data/mysqldata/3306/mysql.pid --socket=/data/mysqldata/3306/mysql.sock --port=3306root 23497 21466 1 13:49 pts/4 00:00:55 sysbench /usr/share/sysbench/oltp_read_write.lua --mysql-user=root --mysql-password=mysql --mysql-port=3306 --mysql-socket=/data/mysqldata/3306/mysql.sock --mysql-host=localhost --mysql-db=sysbenchtest --tables=10 --table-size=5000000 --threads=2 --report-interval=5 --time=7000 --db-driver=mysql runroot 23775 21421 0 14:54 pts/0 00:00:00 grep mysqld kill -HUP é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶1[root@uz22199 ~]# kill -HUP `pidof mysqld` çœ‹ä¸€ä¸‹mysqld pidæ²¡å˜12345[root@uz22199 ~]# ps -ef| grep mysqldroot 14676 1 0 Sep11 ? 00:00:00 /bin/sh /usr/local/mysql/bin/mysqld_safe --relay-log-recovery=0mysql 16188 14676 2 Sep11 ? 00:33:26 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql --datadir=/data/mysqldata/3306/data --plugin-dir=/usr/local/mysql/lib/plugin --user=mysql --relay-log-recovery=0 --log-error=/data/mysqldata/3306/data/../error.log --open-files-limit=65535 --pid-file=/data/mysqldata/3306/mysql.pid --socket=/data/mysqldata/3306/mysql.sock --port=3306root 23497 21466 1 13:49 pts/4 00:00:55 sysbench /usr/share/sysbench/oltp_read_write.lua --mysql-user=root --mysql-password=mysql --mysql-port=3306 --mysql-socket=/data/mysqldata/3306/mysql.sock --mysql-host=localhost --mysql-db=sysbenchtest --tables=10 --table-size=5000000 --threads=2 --report-interval=5 --time=7000 --db-driver=mysql runroot 23782 21421 0 14:55 pts/0 00:00:00 grep mysqldsysbenchæ²¡æœ‰æŠ¥é”™","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"MySQLä¸å®Œå…¨æ¢å¤","slug":"MySQLä¸å®Œå…¨æ¢å¤","date":"2017-09-11T10:16:00.000Z","updated":"2017-09-11T10:22:29.000Z","comments":true,"path":"2017/09/11/MySQLä¸å®Œå…¨æ¢å¤/","link":"","permalink":"http://fuxkdb.com/2017/09/11/MySQL%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%81%A2%E5%A4%8D/","excerpt":"ä¸å®Œå…¨æ¢å¤é€šè¿‡åšSlaveæ¢å¤æ‰¾åˆ°é—®é¢˜è¯­å¥çš„ä½ç½®,è¿™é‡Œæ˜¯131512345678910111213141516#170911 14:42:19 server id 330641 end_log_pos 2508 CRC32 0xf697b7bb Xid = 215COMMIT/*!*/;# at 2508#170911 14:50:56 server id 330641 end_log_pos 2573 CRC32 0x8309dea0 GTID last_committed=9 sequence_number=10SET @@SESSION.GTID_NEXT= &#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1315&#x27;/*!*/;# at 2573#170911 14:50:56 server id 330641 end_log_pos 2693 CRC32 0xb06b9074 Query thread_id=25 exec_time=1 error_code=0use `fandb`/*!*/;SET TIMESTAMP=1505112656/*!*/;DROP TABLE `users` /* generated by server *//*!*/;SET @@SESSION.GTID_NEXT= &#x27;AUTOMATIC&#x27; /* added by mysqlbinlog */ /*!*/;DELIMITER ;# End of log file/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/; é‚£ä¸€ä»½å¤‡ä»½,æ¢å¤å‡ºæ¥,å¯åŠ¨,reset slave all;ç„¶åchange master12345678910change master tomaster_host=&#x27;10.4.3.100&#x27;,master_user=&#x27;repl&#x27;,master_password=&#x27;repl&#x27;,master_port=3306,master_auto_position=1;é‡ç‚¹start slave sql_thread until SQL_BEFORE_GTIDS=&#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1315&#x27;;start slave io_thread;","text":"ä¸å®Œå…¨æ¢å¤é€šè¿‡åšSlaveæ¢å¤æ‰¾åˆ°é—®é¢˜è¯­å¥çš„ä½ç½®,è¿™é‡Œæ˜¯131512345678910111213141516#170911 14:42:19 server id 330641 end_log_pos 2508 CRC32 0xf697b7bb Xid = 215COMMIT/*!*/;# at 2508#170911 14:50:56 server id 330641 end_log_pos 2573 CRC32 0x8309dea0 GTID last_committed=9 sequence_number=10SET @@SESSION.GTID_NEXT= &#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1315&#x27;/*!*/;# at 2573#170911 14:50:56 server id 330641 end_log_pos 2693 CRC32 0xb06b9074 Query thread_id=25 exec_time=1 error_code=0use `fandb`/*!*/;SET TIMESTAMP=1505112656/*!*/;DROP TABLE `users` /* generated by server *//*!*/;SET @@SESSION.GTID_NEXT= &#x27;AUTOMATIC&#x27; /* added by mysqlbinlog */ /*!*/;DELIMITER ;# End of log file/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/; é‚£ä¸€ä»½å¤‡ä»½,æ¢å¤å‡ºæ¥,å¯åŠ¨,reset slave all;ç„¶åchange master12345678910change master tomaster_host=&#x27;10.4.3.100&#x27;,master_user=&#x27;repl&#x27;,master_password=&#x27;repl&#x27;,master_port=3306,master_auto_position=1;é‡ç‚¹start slave sql_thread until SQL_BEFORE_GTIDS=&#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1315&#x27;;start slave io_thread; ä¼ªMasteræ¢å¤æ‰¾ä¸€ä¸ªå¤‡ä»½,æ¢å¤,å¯åŠ¨1234567891011121314mysql-bin.000005 194 5c351518-78ec-11e7-8e7a-005056a610c3:1-1298innobackupex --copy-back .[root@uz22199 full]# mysqld_safe &amp;root@mysqldb 17:41: [(none)]&gt; reset slave all;Query OK, 0 rows affected (0.03 sec)root@mysqldb 17:43: [(none)]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000001 | 154 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1298 |+------------------+----------+--------------+------------------+---------------------------------------------+1 row in set (0.00 sec) éšä¾¿change masterä¸€ä¸‹,ç›®çš„è®©å®ƒçŸ¥é“è‡ªå·±æ˜¯ä»åº“(è¦ä¸æ²¡æœ‰relay log info)123456change master tomaster_host=&#x27;10.4.3.200&#x27;,master_user=&#x27;repl&#x27;,master_password=&#x27;repl&#x27;,master_port=3306;ä¸è¦åŠ master_auto_positionå…³åº“1shutdown ä¸»åº“binlogå‘è¿‡æ¥,æ”¹åå­—ä¸ºrelay1234567891011121314151617181920212223242526272829[root@test43100 bak]# scp relay.0000* 10.4.1.45:/data/mysqldata/3306/data/root@10.4.1.45&#x27;s password: relay.000005 100% 495 0.5KB/s 00:00 relay.000006 100% 476 0.5KB/s 00:00 relay.000007 100% 241 0.2KB/s 00:00 relay.000008 100% 1003 1.0KB/s 00:00 relay.000009 100% 241 0.2KB/s 00:00 relay.000010 100% 495 0.5KB/s 00:00 relay.000011 100% 495 0.5KB/s 00:00 relay.000012 100% 2693 2.6KB/s 00:00 You have mail in /var/spool/mail/rootfor i in `ls relay.0*` ; do echo &quot;./&quot;$i&gt;&gt;relay.index; done[root@uz22199 data]# &gt;relay.index [root@uz22199 data]# for i in `ls relay.0*` ; do echo &quot;./&quot;$i&gt;&gt;relay.index; done[root@uz22199 data]# more relay.index ./relay.000001./relay.000005./relay.000006./relay.000007./relay.000008./relay.000009./relay.000010./relay.000011./relay.000012[root@uz22199 data]# chown mysql:mysql relay.* å¯åŠ¨,æ³¨æ„â€“relay-log-recovery=0 å¦åˆ™æŠ¥é”™Error during â€“relay-log-recovery: Could not locate rotate event from the master. 1[root@uz22199 full]# mysqld_safe --relay-log-recovery=0 &amp; å†change masterä¸€æ¬¡,ç›®çš„å‘Šè¯‰ä»–relayæ–‡ä»¶å’Œä½ç½®1change master to relay_log_file=&#x27;relay.000001&#x27; , relay_log_pos=4; å¯åŠ¨sql_thread12345678root@mysqldb 17:52: [(none)]&gt; start slave sql_thread until SQL_BEFORE_GTIDS=&#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1315&#x27;;root@mysqldb 17:52: [(none)]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000003 | 4121 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1314 |+------------------+----------+--------------+------------------+---------------------------------------------+","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"å¤‡ä»½æ¢å¤","slug":"å¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"é€šè¿‡mysqlbinlog --skip-gtidsæ¢å¤åå†å¤‡ä»½å¯èƒ½é€ æˆçš„å‘","slug":"é€šè¿‡mysqlbinlog---skip-gtidsæ¢å¤åå†å¤‡ä»½å¯èƒ½é€ æˆçš„å‘","date":"2017-09-11T02:06:00.000Z","updated":"2017-09-29T02:05:33.000Z","comments":true,"path":"2017/09/11/é€šè¿‡mysqlbinlog---skip-gtidsæ¢å¤åå†å¤‡ä»½å¯èƒ½é€ æˆçš„å‘/","link":"","permalink":"http://fuxkdb.com/2017/09/11/%E9%80%9A%E8%BF%87mysqlbinlog---skip-gtids%E6%81%A2%E5%A4%8D%E5%90%8E%E5%86%8D%E5%A4%87%E4%BB%BD%E5%8F%AF%E8%83%BD%E9%80%A0%E6%88%90%E7%9A%84%E5%9D%91/","excerpt":"é€šè¿‡mysqlbinlog â€“skip-gtidsæ¢å¤åå†å¤‡ä»½å¯èƒ½é€ æˆçš„å‘ç‰ˆæœ¬12345678[root@uz22199 backup]# innobackupex --versioninnobackupex version 2.4.8 Linux (x86_64) (revision id: 97330f7)[root@uz22199 backup]# mysql -e&quot;select @@version&quot;+------------+| @@version |+------------+| 5.7.18-log |+------------+ æºåº“123456789101112131415161718192021222324252627282930313233è¡¨ç»“æ„ä¸æ•°æ®root@mysqldb 21:51: [fandb]&gt; show create table users\\G*************************** 1. row *************************** Table: usersCreate Table: CREATE TABLE `users` ( `email` varchar(10) DEFAULT NULL, UNIQUE KEY `email` (`email`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb41 row in set (0.00 sec)root@mysqldb 18:43: [fandb]&gt; select* from users;+-------+| email |+-------+| 1 || 10 || 20 || 30 || 5 |+-------+æ’å…¥ä¸€æ¡æ•°æ®insert into users values(50); --GTID=1297å†åˆ æ‰delete from users where email=50; ----GTID=1298å½“å‰Executed_Gtid_Setroot@mysqldb 18:35: [fandb]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000005 | 495 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1298 |+------------------+----------+--------------+------------------+---------------------------------------------+1 row in set (0.00 sec) æºåº“å†æ¬¡åº”ç”¨ä¸€ä¸‹å·²ç»æ‰§è¡Œè¿‡å¾—binlog, å†æ¬¡åº”ç”¨insert into users values(50); è¿™ä¸€æ¡ è¿™é‡Œå…ˆä¸è€ƒè™‘æœ‰æ²¡æœ‰å¯èƒ½è¿™æ ·å­å»æ¢å¤æ•°æ®,åªåšå®éªŒ","text":"é€šè¿‡mysqlbinlog â€“skip-gtidsæ¢å¤åå†å¤‡ä»½å¯èƒ½é€ æˆçš„å‘ç‰ˆæœ¬12345678[root@uz22199 backup]# innobackupex --versioninnobackupex version 2.4.8 Linux (x86_64) (revision id: 97330f7)[root@uz22199 backup]# mysql -e&quot;select @@version&quot;+------------+| @@version |+------------+| 5.7.18-log |+------------+ æºåº“123456789101112131415161718192021222324252627282930313233è¡¨ç»“æ„ä¸æ•°æ®root@mysqldb 21:51: [fandb]&gt; show create table users\\G*************************** 1. row *************************** Table: usersCreate Table: CREATE TABLE `users` ( `email` varchar(10) DEFAULT NULL, UNIQUE KEY `email` (`email`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb41 row in set (0.00 sec)root@mysqldb 18:43: [fandb]&gt; select* from users;+-------+| email |+-------+| 1 || 10 || 20 || 30 || 5 |+-------+æ’å…¥ä¸€æ¡æ•°æ®insert into users values(50); --GTID=1297å†åˆ æ‰delete from users where email=50; ----GTID=1298å½“å‰Executed_Gtid_Setroot@mysqldb 18:35: [fandb]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000005 | 495 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1298 |+------------------+----------+--------------+------------------+---------------------------------------------+1 row in set (0.00 sec) æºåº“å†æ¬¡åº”ç”¨ä¸€ä¸‹å·²ç»æ‰§è¡Œè¿‡å¾—binlog, å†æ¬¡åº”ç”¨insert into users values(50); è¿™ä¸€æ¡ è¿™é‡Œå…ˆä¸è€ƒè™‘æœ‰æ²¡æœ‰å¯èƒ½è¿™æ ·å­å»æ¢å¤æ•°æ®,åªåšå®éªŒ1234567891011121314151617181920[root@test43100 backup]# mysqlbinlog --skip-gtids --include-gtids=&#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1297&#x27; mysql-bin.000005 |mysqlroot@mysqldb 18:43: [fandb]&gt; select* from users;+-------+| email |+-------+| 1 || 10 || 20 || 30 || 5 || 50 |+-------+root@mysqldb 18:43: [fandb]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000005 | 617 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1299 |+------------------+----------+--------------+------------------+---------------------------------------------+æºåº“Executed_Gtid_Set å·²ç»åˆ°1299äº† å¤‡ä»½1234567891011innobackupex --user=backup --password=&#x27;backup&#x27; --stream=tar /tmp | gzip -&gt; full.tar.gz170907 18:45:15 Backup created in directory &#x27;/tmp/&#x27;MySQL binlog position: filename &#x27;mysql-bin.000005&#x27;, position &#x27;617&#x27;, GTID of the last change &#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1-1299&#x27;170907 18:45:15 [00] Streaming &lt;STDOUT&gt;170907 18:45:15 [00] ...done170907 18:45:15 [00] Streaming &lt;STDOUT&gt;170907 18:45:15 [00] ...donextrabackup: Transaction log of lsn (3112759) to (3112768) was copied.170907 18:45:16 completed OK!ä»å¤‡ä»½è¾“å‡ºä¿¡æ¯å’Œxtrabackup_binlog_infoéƒ½å¯ä»¥çœ‹åˆ°,è¿™ä¸ªå…¨å¤‡å¤‡ä»½äº†1-129912[root@uz22199 full2]# more xtrabackup_binlog_info mysql-bin.000005 617 5c351518-78ec-11e7-8e7a-005056a610c3:1-1299 æŠŠå¤‡ä»½éšä¾¿æåˆ°ä¸€ä¸ªåœ°æ–¹æ¢å¤å‡ºæ¥(æ¢å¤è¿‡ç¨‹çœç•¥)æŸ¥çœ‹æ¢å¤å‡ºæ¥çš„åº“çš„Executed_Gtid_Set123456789101112131415161718192021root@mysqldb 18:48: [(none)]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000001 | 154 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1298 |+------------------+----------+--------------+------------------+---------------------------------------------+1 row in set (0.00 sec)è™½ç„¶çœ‹èµ·æ¥åªæ‰§è¡Œåˆ°1298,ä½†æ˜¯50è¿™æ¡æ•°æ®å´æœ‰äº†root@mysqldb 18:43: [fandb]&gt; select* from users;+-------+| email |+-------+| 1 || 10 || 20 || 30 || 5 || 50 |+-------+å¦‚æœæ­¤æ—¶æˆ‘ä»¬ç›´æ¥å°†è¯¥åº“ä½œä¸ºä»åº“,change masteråˆ°æºåº“,é‚£ä¹ˆstart slaveä¼šæŠ¥é”™,1299ä¼šå†æ‰§è¡Œä¸€è¾¹insert 50,ä¼šæŠ¥1062é”™è¯¯. è€Œå¦‚æœæˆ‘ä»¬flush binary logsä¸€æ¬¡,å†åšå…¨å¤‡12345678910111213141516171819202122root@mysqldb 21:51: [fandb]&gt; flush binary logs;Query OK, 0 rows affected (0.19 sec)root@mysqldb 21:59: [fandb]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000006 | 194 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1299 |+------------------+----------+--------------+------------------+---------------------------------------------+1 row in set (0.00 sec)170907 22:00:58 Backup created in directory &#x27;/tmp/&#x27;MySQL binlog position: filename &#x27;mysql-bin.000006&#x27;, position &#x27;194&#x27;, GTID of the last change &#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1-1299&#x27;170907 22:00:58 [00] Streaming &lt;STDOUT&gt;170907 22:00:58 [00] ...done170907 22:00:58 [00] Streaming &lt;STDOUT&gt;170907 22:00:58 [00] ...donextrabackup: Transaction log of lsn (3115326) to (3115335) was copied.170907 22:00:58 completed OK![root@uz22199 full3]# more xtrabackup_binlog_info mysql-bin.000006 194 5c351518-78ec-11e7-8e7a-005056a610c3:1-1299 Executed_Gtid_Setä¾æ—§æ˜¯1-1299 å†æ¬¡å°†å¤‡ä»½æ¢å¤å‡ºæ¥,æŸ¥çœ‹æ–°æ¢å¤å‡ºæ¥çš„åº“123456root@mysqldb 22:02: [(none)]&gt; show master status;+------------------+----------+--------------+------------------+---------------------------------------------+| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+------------------+----------+--------------+------------------+---------------------------------------------+| mysql-bin.000001 | 154 | | | 5c351518-78ec-11e7-8e7a-005056a610c3:1-1299 |+------------------+----------+--------------+------------------+---------------------------------------------+æ­¤æ—¶æ¢å¤å‡ºæ¥çš„åº“Executed_Gtid_Setä¸º1-1299äº† æ€»ç»“é‚£ä¹ˆè¦ä¹ˆä»¥åé€šè¿‡mysqlbinlog â€“skip-gtids æ¢å¤æ•°æ®ä¹‹åflush ä¸€ä¸‹binary logs;è¦ä¹ˆæ¢å¤å‡ºæ¥çš„åº“éƒ½æ‰‹åŠ¨æ ¹æ®xtrabackup_binlog_infoå»set global gtid_purged","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"å¤‡ä»½æ¢å¤","slug":"å¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"åœ¨datadirå¤–åˆ›å»ºInnoDBè¡¨","slug":"åœ¨datadirå¤–åˆ›å»ºInnoDBè¡¨","date":"2017-09-06T03:20:00.000Z","updated":"2017-09-06T03:20:39.000Z","comments":true,"path":"2017/09/06/åœ¨datadirå¤–åˆ›å»ºInnoDBè¡¨/","link":"","permalink":"http://fuxkdb.com/2017/09/06/%E5%9C%A8datadir%E5%A4%96%E5%88%9B%E5%BB%BAInnoDB%E8%A1%A8/","excerpt":"","text":"åœ¨datadirå¤–åˆ›å»ºè¡¨è¦åœ¨MySQL datadirå¤–çš„ç‰¹å®šä½ç½®åˆ›å»ºæ–°çš„InnoDB file-per-table tablespace,è¯·åœ¨create tableæ—¶æŒ‡å®šDATA DIRECTORY = absolute_path_to_directoryå­å¥ æå‰è§„åˆ’å¥½ä½ç½®,å› ä¸ºæ— æ³•ä½¿ç”¨alterè¯­å¥ä¿®æ”¹ä¸€ä¸ªè¡¨çš„DATA DIRECTORYå±æ€§. MySQLä¼šåœ¨ç›®æ ‡ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå¯¹åº”äºæ•°æ®åº“åç§°çš„å­ç›®å½•,å¹¶åœ¨æ”¹ç›®å½•ä¸­åˆ›å»ºè¡¨çš„.ibdæ–‡ä»¶ç”¨äºå­˜å‚¨è¡¨æ•°æ®.åœ¨MySQL datadirç›®å½•ä¸‹çš„æ•°æ®åº“ç›®å½•ä¸­,MySQLåˆ›å»ºä¸€ä¸ªåŒ…å«è¡¨çš„è·¯å¾„åç§°çš„table_name.islæ–‡ä»¶. .islæ–‡ä»¶ç”±MySQLå¤„ç†,åƒä¸€ä¸ªç¬¦å·é“¾æ¥(ä¸è¿‡InnoDBè¡¨ä¸æ”¯æŒå®é™…çš„ç¬¦å·é“¾æ¥) ç¤ºä¾‹:123456789101112131415161718192021222324252627282930313233ç‰ˆæœ¬[root@test43100 ~]# cat /etc/redhat-release CentOS release 6.4 (Final)[root@test43100 ~]# mysql -e &quot;\\s&quot;--------------mysql Ver 14.14 Distrib 5.7.18, for linux-glibc2.5 (x86_64) using EditLine wrapperroot@mysqldb 11:00: [(none)]&gt; use fandbDatabase changedroot@mysqldb 11:00: [fandb]&gt; SHOW VARIABLES LIKE &#x27;innodb_file_per_table&#x27;;+-----------------------+-------+| Variable_name | Value |+-----------------------+-------+| innodb_file_per_table | ON |+-----------------------+-------+1 row in set (0.00 sec)root@mysqldb 11:00: [fandb]&gt; create table t_out(id int auto_increment primary key) data directory=&#x27;/data/outdir&#x27;;Query OK, 0 rows affected (0.37 sec)æŸ¥çœ‹ç›®æ ‡ç›®å½•[mysql@test43100 data]$ tree outdir/outdir/â””â”€â”€ fandb â””â”€â”€ t_out.ibdæŸ¥çœ‹datadir[root@test43100 fandb]# ls -lttotal 412-rw-r----- 1 mysql mysql 28 Sep 6 11:03 t_out.isl-rw-r----- 1 mysql mysql 8556 Sep 6 11:03 t_out.frmåŒ…å«.islå’Œ.frmæ–‡ä»¶ æ‚¨è¿˜å¯ä»¥å°†CREATE TABLE â€¦ TABLESPACEä¸DATA DIRECTORYå­å¥ç»“åˆä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨MySQLæ•°æ®ç›®å½•ä¹‹å¤–åˆ›å»ºä¸€ä¸ªfile-per-table tablespaceã€‚ ä¸ºæ­¤ï¼Œæ‚¨å¿…é¡»æŒ‡å®šinnodb_file_per_tableä½œä¸ºè¡¨ç©ºé—´åç§°ã€‚123456789101112131415root@mysqldb 11:03: [fandb]&gt; create table t_out2(id int auto_increment primary key) TABLESPACE = innodb_file_per_table data directory=&#x27;/data/outdir&#x27;;Query OK, 0 rows affected (0.42 sec)æŸ¥çœ‹ç›®æ ‡ç›®å½•[mysql@test43100 data]$ tree outdir/outdir/â””â”€â”€ fandb â”œâ”€â”€ t_out2.ibd â””â”€â”€ t_out.ibdæŸ¥çœ‹datadir[root@test43100 fandb]# ls -lttotal 428-rw-r----- 1 mysql mysql 29 Sep 6 11:08 t_out2.isl-rw-r----- 1 mysql mysql 8556 Sep 6 11:08 t_out2.frmä½¿ç”¨ç¬¬äºŒç« æ–¹æ³•æ— éœ€å¯ç”¨innodb_file_per_table ä½¿ç”¨è¯´æ˜ MySQLæœ€åˆä¿æŒ.ibdæ–‡ä»¶æ‰“å¼€ï¼Œé˜»æ­¢æ‚¨å¸è½½è®¾å¤‡ï¼Œä½†å¦‚æœæœåŠ¡å™¨æ­£å¿™ï¼Œæœ€ç»ˆå¯èƒ½ä¼šå…³é—­è¯¥è¡¨ã€‚ å½“MySQLè¿è¡Œæ—¶ï¼Œè¯·æ³¨æ„ä¸è¦æ„å¤–å¸è½½å¤–éƒ¨è®¾å¤‡ï¼Œæˆ–è€…åœ¨è®¾å¤‡æ–­å¼€è¿æ¥æ—¶å¯åŠ¨MySQLã€‚ å½“ç›¸å…³çš„.ibdæ–‡ä»¶ä¸¢å¤±æ—¶å°è¯•è®¿é—®è¡¨ä¼šå¯¼è‡´ä¸¥é‡çš„é”™è¯¯ï¼Œéœ€è¦é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚å¦‚æœ.ibdæ–‡ä»¶ä»ç„¶ä¸åœ¨é¢„æœŸè·¯å¾„ï¼ŒæœåŠ¡å™¨é‡æ–°å¯åŠ¨å¯èƒ½ä¼šå¤±è´¥ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤æ•°æ®åº“ç›®å½•ä¸­çš„table_name.islæ–‡ä»¶ï¼Œå¹¶åœ¨é‡æ–°å¯åŠ¨åæ‰§è¡ŒDROP TABLEä»¥åˆ é™¤.frmæ–‡ä»¶ï¼Œå¹¶ä»æ•°æ®å­—å…¸ä¸­åˆ é™¤æœ‰å…³è¯¥è¡¨çš„ä¿¡æ¯ã€‚ Before tables on an NFS-mounted volume, review potential issues outlined in Using NFS with MySQL. If you use an LVM snapshot, file copy, or other file-based mechanism to back up the .ibd file, always use the FLUSH TABLES â€¦ FOR EXPORT statement first to make sure all changes that were buffered in memory are flushed to disk before the backup occurs. DATA DIRECTORYå­å¥æ˜¯ä½¿ç”¨ç¬¦å·é“¾æ¥çš„ä¸€ä¸ªæ”¯æŒçš„æ›¿ä»£æ–¹æ³•.InnoDBç›´æ¥ä½¿ç”¨ç¬¦å·é“¾æ¥æ˜¯ä¸æ”¯æŒçš„","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"innobackupexé‡åˆ°çš„å‘","slug":"innobackupexé‡åˆ°çš„å‘","date":"2017-08-31T10:19:00.000Z","updated":"2017-08-31T10:21:25.000Z","comments":true,"path":"2017/08/31/innobackupexé‡åˆ°çš„å‘/","link":"","permalink":"http://fuxkdb.com/2017/08/31/innobackupex%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/","excerpt":"streamé€‰æ‹©ä½¿ç”¨taræ–¹å¼å‹ç¼©åˆ°æ—¶slave_infoä¿¡æ¯ä¸å®Œæ•´ç‰ˆæœ¬123456789101112131415161718192021222324252627282930313233343536[root@test1 backup]# innobackupex --versioninnobackupex version 2.4.8 Linux (x86_64) (revision id: 97330f7)[root@test1 backup]# cat /etc/redhat-release CentOS release 6.4 (Final)[root@test1 backup]# gzip --versiongzip 1.3.12Copyright (C) 2007 Free Software Foundation, Inc.Copyright (C) 1993 Jean-loup Gailly.This is free software. You may redistribute copies of it under the terms ofthe GNU General Public License &lt;http://www.gnu.org/licenses/gpl.html&gt;.There is NO WARRANTY, to the extent permitted by law.Written by Jean-loup Gailly.[root@test1 backup]# mysql -e&quot;\\s&quot;--------------mysql Ver 14.14 Distrib 5.7.18, for linux-glibc2.5 (x86_64) using EditLine wrapperConnection id: 11Current database:Current user: root@localhostSSL: Not in useCurrent pager: stdoutUsing outfile: &#x27;&#x27;Using delimiter: ;Server version: 5.7.18-log MySQL Community Server (GPL)Protocol version: 10Connection: Localhost via UNIX socketServer characterset: utf8mb4Db characterset: utf8mb4Client characterset: utf8mb4Conn. characterset: utf8mb4UNIX socket: /data/mysqldata/3306/mysql.sockUptime: 15 min 52 secThreads: 3 Questions: 61 Slow queries: 0 Opens: 116 Flush tables: 5 Open tables: 0 Queries per second avg: 0.064--------------å¤‡ä»½å‘½ä»¤1innobackupex --user=backup --password=&#x27;backup&#x27; --slave-info --stream=tar /tmp | gzip -&gt; /data/mysqldata/backup/xtra_full.tar.gzæœŸæœ›å¾—åˆ°çš„å®Œæ•´ä¿¡æ¯123[root@test1 slave_info]# more xtrabackup_slave_info SET GLOBAL gtid_purged=&#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1-1164&#x27;;CHANGE MASTER TO MASTER_AUTO_POSITION=1;","text":"streamé€‰æ‹©ä½¿ç”¨taræ–¹å¼å‹ç¼©åˆ°æ—¶slave_infoä¿¡æ¯ä¸å®Œæ•´ç‰ˆæœ¬123456789101112131415161718192021222324252627282930313233343536[root@test1 backup]# innobackupex --versioninnobackupex version 2.4.8 Linux (x86_64) (revision id: 97330f7)[root@test1 backup]# cat /etc/redhat-release CentOS release 6.4 (Final)[root@test1 backup]# gzip --versiongzip 1.3.12Copyright (C) 2007 Free Software Foundation, Inc.Copyright (C) 1993 Jean-loup Gailly.This is free software. You may redistribute copies of it under the terms ofthe GNU General Public License &lt;http://www.gnu.org/licenses/gpl.html&gt;.There is NO WARRANTY, to the extent permitted by law.Written by Jean-loup Gailly.[root@test1 backup]# mysql -e&quot;\\s&quot;--------------mysql Ver 14.14 Distrib 5.7.18, for linux-glibc2.5 (x86_64) using EditLine wrapperConnection id: 11Current database:Current user: root@localhostSSL: Not in useCurrent pager: stdoutUsing outfile: &#x27;&#x27;Using delimiter: ;Server version: 5.7.18-log MySQL Community Server (GPL)Protocol version: 10Connection: Localhost via UNIX socketServer characterset: utf8mb4Db characterset: utf8mb4Client characterset: utf8mb4Conn. characterset: utf8mb4UNIX socket: /data/mysqldata/3306/mysql.sockUptime: 15 min 52 secThreads: 3 Questions: 61 Slow queries: 0 Opens: 116 Flush tables: 5 Open tables: 0 Queries per second avg: 0.064--------------å¤‡ä»½å‘½ä»¤1innobackupex --user=backup --password=&#x27;backup&#x27; --slave-info --stream=tar /tmp | gzip -&gt; /data/mysqldata/backup/xtra_full.tar.gzæœŸæœ›å¾—åˆ°çš„å®Œæ•´ä¿¡æ¯123[root@test1 slave_info]# more xtrabackup_slave_info SET GLOBAL gtid_purged=&#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1-1164&#x27;;CHANGE MASTER TO MASTER_AUTO_POSITION=1;å®é™…å¾—åˆ°çš„12[root@test1 backup]# more xtrabackup_slave_info SET GLOBAL gtid_purged=&#x27;5c3å¦‚æœä½¿ç”¨stream=xbstreamåŒæ—¶æŒ‡å®šäº†â€“slave-info,åˆ™æ ¹æœ¬ä¸ä¼šæŒ‰ç…§æœŸæœ›çš„å¾—åˆ°full.xbstreamå‹ç¼©æ–‡ä»¶,è€Œæ˜¯ä¼šç›´æ¥å°†å¤‡ä»½è¾“å‡ºåˆ°timestampæ–‡ä»¶å¤¹,å¹¶äº§ç”Ÿä¸€ä¸ªemptyçš„full.xbstream. çœ‹ä¸‹é¢ä¾‹å­innobackupex â€“user=backup â€“password=â€™backupâ€™ \\â€“stream=xbstream ./ &gt; /data/mysqldata/backup/full.xbstream1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253170831 17:17:10 innobackupex: Starting the backup operationIMPORTANT: Please check that the backup run completes successfully. At the end of a successful backup run innobackupex prints &quot;completed OK!&quot;.170831 17:17:10 version_check Connecting to MySQL server with DSN &#x27;dbi:mysql:;mysql_read_default_group=xtrabackup;mysql_socket=/data/mysqldata/3306/mysql.sock&#x27; as &#x27;backup&#x27; (using password: YES).170831 17:17:10 version_check Connected to MySQL server170831 17:17:10 version_check Executing a version check against the server...170831 17:17:10 version_check Done.170831 17:17:10 Connecting to MySQL server host: localhost, user: backup, password: set, port: not set, socket: /data/mysqldata/3306/mysql.sockUsing server version 5.7.18-loginnobackupex version 2.4.8 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 97330f7)xtrabackup: uses posix_fadvise().xtrabackup: cd to /data/mysqldata/3306/dataxtrabackup: open files limit requested 65535, set to 65535xtrabackup: using the following InnoDB configuration:xtrabackup: innodb_data_home_dir = .xtrabackup: innodb_data_file_path = ibdata1:1024M:autoextendxtrabackup: innodb_log_group_home_dir = /data/mysqldata/3306/redologxtrabackup: innodb_log_files_in_group = 2xtrabackup: innodb_log_file_size = 134217728xtrabackup: using O_DIRECTInnoDB: Number of pools: 1170831 17:17:10 &gt;&gt; log scanned up to (2937521)InnoDB: Opened 3 undo tablespacesInnoDB: 0 undo tablespaces made activextrabackup: Generating a list of tablespacesInnoDB: Allocated tablespace ID 27 for sms/SMS_DETAIL_INFO, old maximum was 3170831 17:17:11 [01] Streaming ./ibdata1 170831 17:17:11 &gt;&gt; log scanned up to (2937521)170831 17:17:12 &gt;&gt; log scanned up to (2937521)...170831 17:17:40 [00] ...done170831 17:17:40 Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS...xtrabackup: The latest check point (for incremental): &#x27;2937512&#x27;xtrabackup: Stopping log copying thread..170831 17:17:40 &gt;&gt; log scanned up to (2937521)170831 17:17:41 Executing UNLOCK TABLES170831 17:17:41 All tables unlocked170831 17:17:41 [00] Streaming ib_buffer_pool to &lt;STDOUT&gt;170831 17:17:41 [00] ...done170831 17:17:41 Backup created in directory &#x27;/data/mysqldata/backup/&#x27; --æ³¨æ„ä¸€ä¼šå¯¹æ¯”è¿™é‡ŒMySQL binlog position: filename &#x27;mysql-bin.000002&#x27;, position &#x27;154&#x27;, GTID of the last change &#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1-1164&#x27;170831 17:17:41 [00] Streaming &lt;STDOUT&gt;170831 17:17:41 [00] ...done170831 17:17:41 [00] Streaming &lt;STDOUT&gt;170831 17:17:41 [00] ...donextrabackup: Transaction log of lsn (2937512) to (2937521) was copied.170831 17:17:41 completed OK!æ­£å¸¸çš„å¤‡ä»½,ç”Ÿæˆäº†.xbstreamæ–‡ä»¶123456[root@test1 backup]# lsfull.xbstream[root@test1 backup]# file full.xbstream full.xbstream: data[root@test1 backup]# rm full.xbstream rm: remove regular file `full.xbstream&#x27;? yåŠ ä¸Šâ€“slave-infoçš„innobackupex â€“user=backup â€“password=â€™backupâ€™ â€“slave-info\\ â€“stream=xbstream ./ &gt; /data/mysqldata/backup/full.xbstream12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152170831 17:18:43 innobackupex: Starting the backup operationIMPORTANT: Please check that the backup run completes successfully. At the end of a successful backup run innobackupex prints &quot;completed OK!&quot;.170831 17:18:43 version_check Connecting to MySQL server with DSN &#x27;dbi:mysql:;mysql_read_default_group=xtrabackup;mysql_socket=/data/mysqldata/3306/mysql.sock&#x27; as &#x27;backup&#x27; (using password: YES).170831 17:18:43 version_check Connected to MySQL server170831 17:18:43 version_check Executing a version check against the server...170831 17:18:43 version_check Done.170831 17:18:43 Connecting to MySQL server host: localhost, user: backup, password: set, port: not set, socket: /data/mysqldata/3306/mysql.sockUsing server version 5.7.18-loginnobackupex version 2.4.8 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 97330f7)xtrabackup: uses posix_fadvise().xtrabackup: cd to /data/mysqldata/3306/dataxtrabackup: open files limit requested 65535, set to 65535xtrabackup: using the following InnoDB configuration:xtrabackup: innodb_data_home_dir = .xtrabackup: innodb_data_file_path = ibdata1:1024M:autoextendxtrabackup: innodb_log_group_home_dir = /data/mysqldata/3306/redologxtrabackup: innodb_log_files_in_group = 2xtrabackup: innodb_log_file_size = 134217728xtrabackup: using O_DIRECTInnoDB: Number of pools: 1170831 17:18:43 &gt;&gt; log scanned up to (2937521)InnoDB: Opened 3 undo tablespacesInnoDB: 0 undo tablespaces made activextrabackup: Generating a list of tablespacesInnoDB: Allocated tablespace ID 27 for sms/SMS_DETAIL_INFO, old maximum was 3170831 17:18:44 [01] Copying ./ibdata1 to /data/mysqldata/backup/2017-08-31_17-18-43/ibdata1 --æ³¨æ„...170831 17:19:05 Finished backing up non-InnoDB tables and files170831 17:19:05 [00] Writing /data/mysqldata/backup/2017-08-31_17-18-43/xtrabackup_binlog_info --æ³¨æ„170831 17:19:05 [00] ...done170831 17:19:06 Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS...xtrabackup: The latest check point (for incremental): &#x27;2937512&#x27;xtrabackup: Stopping log copying thread..170831 17:19:06 &gt;&gt; log scanned up to (2937521)170831 17:19:06 Executing UNLOCK TABLES170831 17:19:06 All tables unlocked170831 17:19:06 [00] Copying ib_buffer_pool to /data/mysqldata/backup/2017-08-31_17-18-43/ib_buffer_pool170831 17:19:06 [00] ...done170831 17:19:06 Backup created in directory &#x27;/data/mysqldata/backup/2017-08-31_17-18-43/&#x27;MySQL binlog position: filename &#x27;mysql-bin.000002&#x27;, position &#x27;154&#x27;, GTID of the last change &#x27;5c351518-78ec-11e7-8e7a-005056a610c3:1-1164&#x27;170831 17:19:06 [00] Writing /data/mysqldata/backup/2017-08-31_17-18-43/backup-my.cnf170831 17:19:06 [00] ...done170831 17:19:06 [00] Writing /data/mysqldata/backup/2017-08-31_17-18-43/xtrabackup_info170831 17:19:06 [00] ...donextrabackup: Transaction log of lsn (2937512) to (2937521) was copied.170831 17:19:06 completed OK!ç”Ÿæˆä¸€ä¸ªæ—¶é—´æˆ³ç›®å½•,å’Œfull.xbstream,full.xbstreamæ˜¯ç©ºçš„1234[root@test1 backup]# ls2017-08-31_17-18-43 full.xbstream[root@test1 backup]# file full.xbstreamfull.xbstream: emptyå¹¶ä¸”2017-08-31_17-18-43ç›®å½•ä¸‹ä¹Ÿæ²¡æœ‰xtrabackup_slave_info123[root@test1 backup]# cd 2017-08-31_17-18-43[root@test1 2017-08-31_17-18-43]# lsbackup-my.cnf fandb ib_buffer_pool ibdata1 mysql performance_schema sms sys undo001 undo002 undo003 xtrabackup_binlog_info xtrabackup_checkpoints xtrabackup_info xtrabackup_logfile yydb","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"ä¸»ä»ä¼ è¾“è¡¨ç©ºé—´çš„å‘","slug":"ä¸»ä»ä¼ è¾“è¡¨ç©ºé—´çš„å‘","date":"2017-08-22T04:25:00.000Z","updated":"2017-08-22T04:26:34.000Z","comments":true,"path":"2017/08/22/ä¸»ä»ä¼ è¾“è¡¨ç©ºé—´çš„å‘/","link":"","permalink":"http://fuxkdb.com/2017/08/22/%E4%B8%BB%E4%BB%8E%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4%E7%9A%84%E5%9D%91/","excerpt":"ä¸»åº“import tablespaceåªä¼šåœ¨binlogä¸­è®°å½•alter table xxx import tablespaceè¯­å¥,è€Œä¸ä¼šè®°å½•è¡¨ä¸­çš„æ•°æ®çš„æ’å…¥è¯­å¥1234567891011121314151617181920212223242526[mysql@master2 ~]$ mysqlbinlog -vv --base64-output=decode-rows /data/mysqldata/3306/binlog/mysql-bin.000013 --start-position=694/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;DELIMITER /*!*/;# at 694#170713 7:46:11 server id 23306 end_log_pos 759 CRC32 0xfa604449 GTID last_committed=2 sequence_number=3SET @@SESSION.GTID_NEXT= &#x27;5691c701-382a-11e5-bbc4-000c293d13e1:19&#x27;/*!*/;# at 759#170713 7:46:11 server id 23306 end_log_pos 869 CRC32 0x35860c26 Query thread_id=8 exec_time=0 error_code=0use `fandb`/*!*/;SET TIMESTAMP=1499903171/*!*/;SET @@session.pseudo_thread_id=8/*!*/;SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;SET @@session.sql_mode=1075838976/*!*/;SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;/*!\\C utf8mb4 *//*!*/;SET @@session.character_set_client=45,@@session.collation_connection=45,@@session.collation_server=45/*!*/;SET @@session.lc_time_names=0/*!*/;SET @@session.collation_database=DEFAULT/*!*/;alter table dept import tablespace/*!*/;SET @@SESSION.GTID_NEXT= &#x27;AUTOMATIC&#x27; /* added by mysqlbinlog */ /*!*/;DELIMITER ;# End of log file/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;å‡å¦‚åœ¨æºç«¯flush table xxx for exportå,åªå°†xxx.{ibd,cfg}æ‹·è´åˆ°ä¸»åº“,é‚£ä¹ˆå½“ä¸»åº“alter table xxx discard tablespaceæ—¶,ä»åº“ä¹Ÿä¼šæ‰§è¡Œdiscard tablespaceè€Œå½“ä¸»åº“æ‰§è¡Œalter table xxx import tablespaceæ—¶,ç”±äºä¸»åº“æœ‰æ‹·è´è¿‡æ¥çš„xxx.{ibd,cfg},æ‰€ä»¥å¯ä»¥æ‰§è¡ŒæˆåŠŸ,è€Œä»åº“æ²¡æœ‰,ä¼šå¤±è´¥1232017-07-10T21:48:13.649264Z 25 [Warning] Slave: InnoDB: ALTER TABLE `fandb`.`dept4` IMPORT TABLESPACE failed with error 44 : &#x27;Tablespace not found&#x27; Error_code: 18162017-07-10T21:48:13.649293Z 25 [Warning] Slave: Tablespace is missing for table `fandb`.`dept4`. Error_code: 18122017-07-10T21:48:13.649321Z 25 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread with &quot;SLAVE START&quot;. We stopped at log &#x27;mysql-bin.000001&#x27; position 1015slaveä¼šåœæ­¢","text":"ä¸»åº“import tablespaceåªä¼šåœ¨binlogä¸­è®°å½•alter table xxx import tablespaceè¯­å¥,è€Œä¸ä¼šè®°å½•è¡¨ä¸­çš„æ•°æ®çš„æ’å…¥è¯­å¥1234567891011121314151617181920212223242526[mysql@master2 ~]$ mysqlbinlog -vv --base64-output=decode-rows /data/mysqldata/3306/binlog/mysql-bin.000013 --start-position=694/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;DELIMITER /*!*/;# at 694#170713 7:46:11 server id 23306 end_log_pos 759 CRC32 0xfa604449 GTID last_committed=2 sequence_number=3SET @@SESSION.GTID_NEXT= &#x27;5691c701-382a-11e5-bbc4-000c293d13e1:19&#x27;/*!*/;# at 759#170713 7:46:11 server id 23306 end_log_pos 869 CRC32 0x35860c26 Query thread_id=8 exec_time=0 error_code=0use `fandb`/*!*/;SET TIMESTAMP=1499903171/*!*/;SET @@session.pseudo_thread_id=8/*!*/;SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;SET @@session.sql_mode=1075838976/*!*/;SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;/*!\\C utf8mb4 *//*!*/;SET @@session.character_set_client=45,@@session.collation_connection=45,@@session.collation_server=45/*!*/;SET @@session.lc_time_names=0/*!*/;SET @@session.collation_database=DEFAULT/*!*/;alter table dept import tablespace/*!*/;SET @@SESSION.GTID_NEXT= &#x27;AUTOMATIC&#x27; /* added by mysqlbinlog */ /*!*/;DELIMITER ;# End of log file/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;å‡å¦‚åœ¨æºç«¯flush table xxx for exportå,åªå°†xxx.{ibd,cfg}æ‹·è´åˆ°ä¸»åº“,é‚£ä¹ˆå½“ä¸»åº“alter table xxx discard tablespaceæ—¶,ä»åº“ä¹Ÿä¼šæ‰§è¡Œdiscard tablespaceè€Œå½“ä¸»åº“æ‰§è¡Œalter table xxx import tablespaceæ—¶,ç”±äºä¸»åº“æœ‰æ‹·è´è¿‡æ¥çš„xxx.{ibd,cfg},æ‰€ä»¥å¯ä»¥æ‰§è¡ŒæˆåŠŸ,è€Œä»åº“æ²¡æœ‰,ä¼šå¤±è´¥1232017-07-10T21:48:13.649264Z 25 [Warning] Slave: InnoDB: ALTER TABLE `fandb`.`dept4` IMPORT TABLESPACE failed with error 44 : &#x27;Tablespace not found&#x27; Error_code: 18162017-07-10T21:48:13.649293Z 25 [Warning] Slave: Tablespace is missing for table `fandb`.`dept4`. Error_code: 18122017-07-10T21:48:13.649321Z 25 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread with &quot;SLAVE START&quot;. We stopped at log &#x27;mysql-bin.000001&#x27; position 1015slaveä¼šåœæ­¢ ä¿®å¤æ–¹æ³•æ˜¯,å°†xxx.{ibd,cfg}æ‹·è´åˆ°ä»åº“,ç„¶å12345678910111213141516set sql_log_bin=off;alter table xxx import tablespace;set sql_log_bin=on;(mysql@localhost) [fandb]&gt; set gtid_next=&#x27;5691c701-382a-11e5-bbc4-000c293d13e1:6&#x27;;Query OK, 0 rows affected (0.00 sec)(mysql@localhost) [fandb]&gt; begin;Query OK, 0 rows affected (0.00 sec)(mysql@localhost) [fandb]&gt; commit;Query OK, 0 rows affected (0.00 sec)(mysql@localhost) [fandb]&gt; set gtid_next=&#x27;automatic&#x27;;(mysql@localhost) [fandb]&gt; start slave sql_thread;","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"ä¼ è¾“è¡¨ç©ºé—´","slug":"ä¼ è¾“è¡¨ç©ºé—´","permalink":"http://fuxkdb.com/tags/%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4/"}]},{"title":"Transportable Tablespace Internals","slug":"Transportable-Tablespace-Internals","date":"2017-08-22T04:24:00.000Z","updated":"2017-08-22T04:31:05.000Z","comments":true,"path":"2017/08/22/Transportable-Tablespace-Internals/","link":"","permalink":"http://fuxkdb.com/2017/08/22/Transportable-Tablespace-Internals/","excerpt":"","text":"Transportable Tablespace Internalsä»¥ä¸‹ä¿¡æ¯æè¿°äº†InnoDBçš„ä¼ è¾“è¡¨ç©ºé—´å¤åˆ¶è¿‡ç¨‹çš„å†…éƒ¨åŸç†å’Œerror logä¸­è¾“å‡ºçš„ä¿¡æ¯ å½“åœ¨ç›®æ ‡ç«¯æ‰§è¡ŒALTER TABLE ... DISCARD TABLESPACEå‘½ä»¤æ—¶: The table is locked in X mode. è¡¨ç©ºé—´ä¼šä¸è¡¨åˆ†ç¦».The tablespace is detached from the table. å½“åœ¨æºç«¯æ‰§è¡ŒFLUSH TABLES ... FOR EXPORTå‘½ä»¤æ—¶: The table being flushed for export is locked in shared mode. æ¸…é™¤åè°ƒç¨‹åºçº¿ç¨‹å·²åœæ­¢The purge coordinator thread is stopped. è„å—ä¼šè¢«å†™å…¥ç£ç›˜ è¡¨çš„å…ƒæ•°æ®ä¿¡æ¯ä¼šè¢«å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶.cfgä¸­ æ­¤æ“ä½œçš„é¢„æœŸé”™è¯¯æ—¥å¿—æ¶ˆæ¯:12342013-09-24T13:10:19.903526Z 2 [Note] InnoDB: Sync to disk of &#x27;&quot;test&quot;.&quot;t&quot;&#x27; started.2013-09-24T13:10:19.903586Z 2 [Note] InnoDB: Stopping purge2013-09-24T13:10:19.903725Z 2 [Note] InnoDB: Writing table metadata to &#x27;./test/t.cfg&#x27;2013-09-24T13:10:19.904014Z 2 [Note] InnoDB: Table &#x27;&quot;test&quot;.&quot;t&quot;&#x27; flushed to disk å½“åœ¨æºç«¯æ‰§è¡ŒUNLOCK TABLESå‘½ä»¤æ—¶: äºŒè¿›åˆ¶æ–‡ä»¶.cfgä¼šè¢«åˆ é™¤ The shared lock on the table or tables being imported is released ,å¹¶ä¸”æ¸…é™¤åè°ƒç¨‹åºçº¿ç¨‹ä¼šé‡å¯purge coordinator thread is restarted. æ­¤æ“ä½œçš„é¢„æœŸé”™è¯¯æ—¥å¿—æ¶ˆæ¯:122013-09-24T13:10:21.181104Z 2 [Note] InnoDB: Deleting the meta-data file &#x27;./test/t.cfg&#x27;2013-09-24T13:10:21.181180Z 2 [Note] InnoDB: Resuming purge å½“åœ¨ç›®æ ‡ç«¯æ‰§è¡ŒALTER TABLE ... IMPORT TABLESPACEæ—¶,å¯¼å…¥ç®—æ³•ä¼šæ‰§è¡Œå¦‚ä¸‹æ“ä½œ: å°†æ£€æŸ¥æ¯ä¸ªè¡¨ç©ºé—´é¡µæ˜¯å¦æŸå. æ¯ä¸ªé¡µé¢ä¸Šçš„ç©ºé—´IDå’Œæ—¥å¿—åºåˆ—å·ï¼ˆLSNï¼‰éƒ½ä¼šæ›´æ–° æ ‡å¿—è¢«éªŒè¯,LSNè¢«æ›´æ–°ä¸ºå¤´é¡µ. Btreeé¡µé¢æ›´æ–°. é¡µé¢çŠ¶æ€è®¾ç½®ä¸ºdirty,ä»¥ä¾¿å®ƒå°†è¢«å†™å…¥ç£ç›˜. æ­¤æ“ä½œçš„é¢„æœŸé”™è¯¯æ—¥å¿—æ¶ˆæ¯:1234562013-07-18 15:15:01 34960 [Note] InnoDB: Importing tablespace for table &#x27;test/t&#x27; that was exported from host &#x27;ubuntu&#x27;2013-07-18 15:15:01 34960 [Note] InnoDB: Phase I - Update all pages2013-07-18 15:15:01 34960 [Note] InnoDB: Sync to disk2013-07-18 15:15:01 34960 [Note] InnoDB: Sync to disk - done!2013-07-18 15:15:01 34960 [Note] InnoDB: Phase III - Flush changes to disk2013-07-18 15:15:01 34960 [Note] InnoDB: Phase IV - Flush complete æ³¨æ„æ‚¨è¿˜å¯èƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªè­¦å‘Šï¼Œè¡¨æ˜ä¸¢å¼ƒäº†è¡¨ç©ºé—´ï¼ˆå¦‚æœæ‚¨ä¸¢å¼ƒäº†ç›®æ ‡è¡¨çš„è¡¨ç©ºé—´ï¼‰å’Œä¸€æ¡æ¶ˆæ¯ï¼ŒæŒ‡å‡ºç”±äºç¼ºå°‘.ibdæ–‡ä»¶è€Œæ— æ³•è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼š1232013-07-18 15:14:38 34960 [Warning] InnoDB: Table &quot;test&quot;.&quot;t&quot; tablespace is set as discarded.2013-07-18 15:14:38 7f34d9a37700 InnoDB: cannot calculate statistics for table &quot;test&quot;.&quot;t&quot; because the .ibd file is missing. For help, please refer tohttp://dev.mysql.com/doc/refman/5.7/en/innodb-troubleshooting.html","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"ä¼ è¾“è¡¨ç©ºé—´","slug":"ä¼ è¾“è¡¨ç©ºé—´","permalink":"http://fuxkdb.com/tags/%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4/"}]},{"title":"Transportable Tablespaceç¤ºä¾‹","slug":"Transportable-Tablespaceç¤ºä¾‹","date":"2017-08-22T04:24:00.000Z","updated":"2017-08-22T04:30:20.000Z","comments":true,"path":"2017/08/22/Transportable-Tablespaceç¤ºä¾‹/","link":"","permalink":"http://fuxkdb.com/2017/08/22/Transportable-Tablespace%E7%A4%BA%E4%BE%8B/","excerpt":"Transportable Tablespaceç¤ºä¾‹http://dev.mysql.com/doc/refman/5.7/en/innodb-transportable-tablespace-examples.html ä¾‹1:å°†InnoDBè¡¨ä»ä¸€ä¸ªæœåŠ¡å™¨å¤åˆ¶åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨æ­¤è¿‡ç¨‹æ¼”ç¤ºå¦‚ä½•å°†InnoDBè¡¨ä»æ­£åœ¨è¿è¡Œçš„MySQLæœåŠ¡å™¨å®ä¾‹å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®ä¾‹.ç»è¿‡ä¸€äº›å°è°ƒæ•´ç›¸åŒè¿‡ç¨‹å¯ç”¨äºåœ¨åŒä¸€å®ä¾‹ä¸Šæ‰§è¡Œå®Œæ•´è¡¨æ¢å¤.1.sourceç«¯1234567891011121314151617181920212223242526272829303132(mysql@localhost) [test]&gt; show table status like &#x27;dept&#x27;\\G*************************** 1. row *************************** Name: dept Engine: InnoDB Version: 10 Row_format: Compact Rows: 0 Avg_row_length: 0 Data_length: 16384Max_data_length: 0 Index_length: 0 Data_free: 0 Auto_increment: NULL Create_time: 2016-08-26 14:25:50 Update_time: NULL Check_time: NULL Collation: utf8_general_ci Checksum: NULL Create_options: Comment: 1 row in set (0.00 sec)(mysql@localhost) [test]&gt; select * from dept;+--------+------------+----------+| deptno | dname | loc |+--------+------------+----------+| 10 | ACCOUNTING | NEW YORK || 20 | RESEARCH | DALLAS || 30 | SALES | CHICAGO || 40 | OPERATIONS | BOSTON |+--------+------------+----------+4 rows in set (0.01 sec) 2.targetç«¯123456CREATE TABLE `dept` ( `deptno` int(11) NOT NULL, `dname` varchar(14) DEFAULT NULL, `loc` varchar(13) DEFAULT NULL, PRIMARY KEY (`deptno`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 3.åœ¨ç›®æ ‡ç«¯discard tablespace.Before a tablespace can be imported, InnoDB must discard the tablespace that is attached to the receiving table1mysql&gt; alter table dept discard tablespace;","text":"Transportable Tablespaceç¤ºä¾‹http://dev.mysql.com/doc/refman/5.7/en/innodb-transportable-tablespace-examples.html ä¾‹1:å°†InnoDBè¡¨ä»ä¸€ä¸ªæœåŠ¡å™¨å¤åˆ¶åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨æ­¤è¿‡ç¨‹æ¼”ç¤ºå¦‚ä½•å°†InnoDBè¡¨ä»æ­£åœ¨è¿è¡Œçš„MySQLæœåŠ¡å™¨å®ä¾‹å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®ä¾‹.ç»è¿‡ä¸€äº›å°è°ƒæ•´ç›¸åŒè¿‡ç¨‹å¯ç”¨äºåœ¨åŒä¸€å®ä¾‹ä¸Šæ‰§è¡Œå®Œæ•´è¡¨æ¢å¤.1.sourceç«¯1234567891011121314151617181920212223242526272829303132(mysql@localhost) [test]&gt; show table status like &#x27;dept&#x27;\\G*************************** 1. row *************************** Name: dept Engine: InnoDB Version: 10 Row_format: Compact Rows: 0 Avg_row_length: 0 Data_length: 16384Max_data_length: 0 Index_length: 0 Data_free: 0 Auto_increment: NULL Create_time: 2016-08-26 14:25:50 Update_time: NULL Check_time: NULL Collation: utf8_general_ci Checksum: NULL Create_options: Comment: 1 row in set (0.00 sec)(mysql@localhost) [test]&gt; select * from dept;+--------+------------+----------+| deptno | dname | loc |+--------+------------+----------+| 10 | ACCOUNTING | NEW YORK || 20 | RESEARCH | DALLAS || 30 | SALES | CHICAGO || 40 | OPERATIONS | BOSTON |+--------+------------+----------+4 rows in set (0.01 sec) 2.targetç«¯123456CREATE TABLE `dept` ( `deptno` int(11) NOT NULL, `dname` varchar(14) DEFAULT NULL, `loc` varchar(13) DEFAULT NULL, PRIMARY KEY (`deptno`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 3.åœ¨ç›®æ ‡ç«¯discard tablespace.Before a tablespace can be imported, InnoDB must discard the tablespace that is attached to the receiving table1mysql&gt; alter table dept discard tablespace;4.åœ¨æºç«¯, run FLUSH TABLES â€¦ FOR EXPORT to quiesce the table and create the .cfg metadata file:1234567(mysql@localhost) [test]&gt; flush tables dept for export;æŸ¥çœ‹error logæœ‰å¦‚ä¸‹æç¤º.mysqlä¼šå…ˆå°†deptè¡¨è„å—åˆ·æ–°åˆ°ç£ç›˜,ç„¶åç”Ÿæˆ.cfgæ–‡ä»¶.å¹¶ä¸”ä»¥æŸç§æ–¹å¼é”ä½deptè¡¨,é€šè¿‡information_schema.INNODB_TRXå’Œinformation_schema.INNODB_LOCKSè¡¨æŸ¥ä¸åˆ°ä¿¡æ¯2017-01-04 18:23:42 5174 [Note] InnoDB: Sync to disk of &#x27;&quot;test&quot;.&quot;dept&quot;&#x27; started.2017-01-04 18:23:42 5174 [Note] InnoDB: Stopping purge2017-01-04 18:23:42 5174 [Note] InnoDB: Writing table metadata to &#x27;./test/dept.cfg&#x27;2017-01-04 18:23:42 5174 [Note] InnoDB: Table &#x27;&quot;test&quot;.&quot;dept&quot;&#x27; flushed to diskæ­¤æ—¶æ— æ³•å¯¹deptè¡¨æ‰§è¡ŒDMLæ“ä½œ,åªèƒ½æ‰§è¡Œåªè¯»æ“ä½œ NoteFLUSH TABLES â€¦ FOR EXPORT is available as of MySQL 5.6.6. The statement ensures that changes to the named table have been flushed to disk so that a binary table copy can be made while the server is running. When FLUSH TABLES â€¦ FOR EXPORT is run, InnoDB produces a .cfg file in the same database directory as the table. The .cfg file contains metadata used for schema verification when importing the tablespace file. 5.æ‹·è´.ibdæ–‡ä»¶å’Œ.cfgå…ƒæ•°æ®æ–‡ä»¶åˆ°ç›®æ ‡ç«¯1cp /data/mysqldata/3306/data/test/dept.&#123;ibd,cfg&#125; /data/mysqldata/3307/data/testä¸€å®šè¦åœ¨shared locksé‡Šæ”¾ä¹‹å‰å®Œæˆæ‹·è´ 6.åœ¨æºç«¯æ‰§è¡ŒUNLOCK TABLESé‡Šæ”¾FLUASH TABLES .. FOR EXPORTäº§ç”Ÿçš„é”12345(mysql@localhost) [test]&gt; unlock tables;Query OK, 0 rows affected (0.00 sec)2017-01-04 18:34:28 5174 [Note] InnoDB: Deleting the meta-data file &#x27;./test/dept.cfg&#x27;2017-01-04 18:34:28 5174 [Note] InnoDB: Resuming purge 7.åœ¨ç›®æ ‡ç«¯,å¯¼å…¥è¡¨ç©ºé—´123456789101112131415161718192021mysql&gt; alter table dept import tablespace;Query OK, 0 rows affected (0.02 sec)mysql&gt; select * from dept;+--------+------------+----------+| deptno | dname | loc |+--------+------------+----------+| 10 | ACCOUNTING | NEW YORK || 20 | RESEARCH | DALLAS || 30 | SALES | CHICAGO || 40 | OPERATIONS | BOSTON |+--------+------------+----------+4 rows in set (0.00 sec)2017-01-04 18:35:46 16972 [Note] InnoDB: Importing tablespace for table &#x27;test/dept&#x27; that was exported from host &#x27;master&#x27;2017-01-04 18:35:46 16972 [Note] InnoDB: Phase I - Update all pages2017-01-04 18:35:46 16972 [Note] InnoDB: Sync to disk2017-01-04 18:35:46 16972 [Note] InnoDB: Sync to disk - done!2017-01-04 18:35:46 16972 [Note] InnoDB: Phase III - Flush changes to disk2017-01-04 18:35:46 16972 [Note] InnoDB: Phase IV - Flush completeå‘Šè­¦æ—¥å¿—é‡Œæ²¡æ˜¾ç¤ºé˜¶æ®µ2æ˜¯å•¥æ³¨æ„:ALTER TABLE â€¦ IMPORT TABLESPACEåŠŸèƒ½ä¸ä¼šå¯¹å¯¼å…¥çš„æ•°æ®å®æ–½å¤–é”®çº¦æŸã€‚ å¦‚æœè¡¨ä¹‹é—´å­˜åœ¨å¤–é”®çº¦æŸï¼Œåˆ™åº”åœ¨ç›¸åŒï¼ˆé€»è¾‘ï¼‰æ—¶é—´ç‚¹å¯¼å‡ºæ‰€æœ‰è¡¨ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å°†åœæ­¢æ›´æ–°è¡¨ï¼Œæäº¤æ‰€æœ‰äº‹åŠ¡ï¼Œè·å–è¡¨ä¸Šçš„å…±äº«é”ï¼Œç„¶åæ‰§è¡Œå¯¼å‡ºæ“ä½œã€‚","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"ä¼ è¾“è¡¨ç©ºé—´","slug":"ä¼ è¾“è¡¨ç©ºé—´","permalink":"http://fuxkdb.com/tags/%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4/"}]},{"title":"Transportable Tablespaces","slug":"Transportable-Tablespaces","date":"2017-08-22T04:23:00.000Z","updated":"2017-08-22T04:35:14.000Z","comments":true,"path":"2017/08/22/Transportable-Tablespaces/","link":"","permalink":"http://fuxkdb.com/2017/08/22/Transportable-Tablespaces/","excerpt":"è¿ç§»File-Per-Table TablespacesTransportable Tablespaceç¤ºä¾‹Transportable Tablespace Internalsæœ¬èŠ‚ä»‹ç»å¦‚ä½•å°†file-per-table tablespaceä»ä¸€ä¸ªserverè¿ç§»åˆ°å¦ä¸€ä¸ªserver,ä¹Ÿç§°ä¸ºå¯Transportable TablespacesåŠŸèƒ½ã€‚ åœ¨MySQL 5.7.4ä¹‹å‰,åªæ”¯æŒéåˆ†åŒºçš„InnoDBè¡¨ã€‚ ä»MySQL 5.7.4å¼€å§‹,è¿˜æ”¯æŒåˆ†åŒºçš„InnoDBè¡¨å’Œå„ä¸ªInnoDBè¡¨åˆ†åŒºå’Œå­åˆ†åŒºã€‚ There are many reasons why you might copy an InnoDB file-per-table tablespace to a different database server: ç”ŸæˆæŠ¥å‘Šè€Œä¸å½±å“ç”Ÿäº§åº“ ä¸ºå¤‡åº“åˆå§‹åŒ–æ•°æ® ç”¨äºæ•°æ®æ¢å¤ ç›¸å¯¹äºmysqldump,ä¼ è¾“è¡¨ç©ºé—´æœ‰ä¸ªæ›´å¿«çš„é€Ÿåº¦ å°†æ¯ä¸ªæ–‡ä»¶çš„è¡¨ç©ºé—´ç§»åŠ¨åˆ°å…·æœ‰æ›´é€‚åˆç³»ç»Ÿè¦æ±‚çš„å­˜å‚¨ä»‹è´¨çš„æœåŠ¡å™¨.ä¾‹å¦‚,æ‚¨å¯èƒ½å¸Œæœ›åœ¨SSDè®¾å¤‡ä¸Šæ‹¥æœ‰ç¹å¿™çš„è¡¨,æˆ–åœ¨å¤§å®¹é‡HDDè®¾å¤‡ä¸Šä½¿ç”¨å¤§å‹è¡¨. é™åˆ¶å’Œä½¿ç”¨æ³¨æ„äº‹é¡¹ ä»…å½“innodb_file_per_tableè®¾ç½®ä¸ºONï¼ˆè¿™æ˜¯MySQL 5.6.6çš„é»˜è®¤è®¾ç½®ï¼‰æ—¶ï¼Œä¼ è¾“è¡¨ç©ºé—´åŠŸèƒ½æ‰å¯ä»¥ä½¿ç”¨ã€‚ é©»ç•™åœ¨å…±äº«ç³»ç»Ÿè¡¨ç©ºé—´ä¸­çš„è¡¨ä¸èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­,åªæœ‰åªè¯»æ“ä½œå¯ä»¥æ‰§è¡Œ page sizeè¦ç›¸åŒ.When importing a tablespace, the page size must match the page size of the importing instance. Prior to MySQL 5.7.4, DISCARD TABLESPACE is not supported for partitioned tables meaning that transportable tablespaces is also unsupported. If you run ALTER TABLE â€¦ DISCARD TABLESPACE on a partitioned table, the following error is returned: ERROR 1031 (HY000): Table storage engine for â€˜partâ€™ doesnâ€™t have this option. As of MySQL 5.7.4, ALTER TABLE â€¦ DISCARD TABLESPACE is supported for partitioned InnoDB tables, and ALTER TABLE â€¦ DISCARD PARTITION â€¦ TABLESPACE is supported for InnoDB table partitions. å½“foreign_key_checksè®¾ç½®ä¸º1æ—¶ï¼Œå¯¹äºçˆ¶ - å­ï¼ˆä¸»é”® - å¤–é”®ï¼‰å…³ç³»çš„è¡¨ç©ºé—´ä¸æ”¯æŒDISCARD TABLESPACEã€‚åœ¨æ”¾å¼ƒçˆ¶å­è¡¨çš„è¡¨ç©ºé—´ä¹‹å‰ï¼Œè¯·è®¾ç½®foreign_key_checks = 0ã€‚ åˆ†åŒºçš„InnoDBè¡¨ä¸æ”¯æŒå¤–é”®ã€‚ ALTER TABLE â€¦ IMPORT TABLESPACEä¸ä¼šå¯¹å¯¼å…¥çš„æ•°æ®å®æ–½å¤–é”®çº¦æŸã€‚ å¦‚æœè¡¨ä¹‹é—´å­˜åœ¨å¤–é”®çº¦æŸï¼Œåˆ™åº”åœ¨ç›¸åŒï¼ˆé€»è¾‘ï¼‰æ—¶é—´ç‚¹å¯¼å‡ºæ‰€æœ‰è¡¨ã€‚ åˆ†åŒºçš„InnoDBè¡¨ä¸æ”¯æŒå¤–é”®ã€‚ ALTER TABLE â€¦ IMPORT TABLESPACEå’ŒALTER TABLE â€¦ IMPORT PARTITION â€¦ TABLESPACEä¸éœ€è¦.cfgå…ƒæ•°æ®æ–‡ä»¶æ¥å¯¼å…¥è¡¨ç©ºé—´ã€‚ ä½†æ˜¯ï¼Œåœ¨ä¸ä½¿ç”¨.cfgæ–‡ä»¶å¯¼å…¥æ—¶ï¼Œä¸ä¼šæ‰§è¡Œå…ƒæ•°æ®æ£€æŸ¥ï¼Œå¹¶ä¸”å°†å‘å‡ºç±»ä¼¼äºä»¥ä¸‹å†…å®¹çš„è­¦å‘Šï¼š 123Message: InnoDB: IO Read error: (2, No such file or directory) Error opening &#x27;.\\test\\t.cfg&#x27;, will attempt to import without schema verification1 row in set (0.00 sec) æ²¡æœ‰.cfgæ–‡ä»¶å¯¼å…¥çš„èƒ½åŠ›å¯èƒ½æ›´æ–¹ä¾¿ï¼Œå½“ä¸éœ€è¦æ¨¡å¼ä¸åŒ¹é…ã€‚ æ­¤å¤–ï¼Œæ— æ³•ä½¿ç”¨.cfgæ–‡ä»¶å¯¼å…¥çš„èƒ½åŠ›åœ¨æ— æ³•ä».ibdæ–‡ä»¶æ”¶é›†å…ƒæ•°æ®çš„å´©æºƒæ¢å¤æ–¹æ¡ˆä¸­å¾ˆæœ‰ç”¨ã€‚ The ability to import without a .cfg file may be more convenient when no schema mismatches are expected. Additionally, the ability to import without a .cfg file could be useful in crash recovery scenarios in which metadata cannot be collected from an .ibd file. ç”±äº.cfgå…ƒæ•°æ®æ–‡ä»¶é™åˆ¶ï¼Œåœ¨ä¸ºåˆ†åŒºè¡¨å¯¼å…¥è¡¨ç©ºé—´æ–‡ä»¶æ—¶ï¼Œä¸ä¼šæŠ¥å‘Šåˆ†åŒºç±»å‹æˆ–åˆ†åŒºå®šä¹‰å·®å¼‚çš„æ¨¡å¼ä¸åŒ¹é…ã€‚ä½†ä¼šæŠ¥å‘Šåˆ—å·®å¼‚ã€‚ åœ¨å­åˆ†åŒºè¡¨ä¸Šè¿è¡ŒALTER TABLE â€¦ DISCARD PARTITION â€¦ TABLESPACEå’ŒALTER TABLE â€¦ IMPORT PARTITION â€¦ TABLESPACEæ—¶ï¼Œå…è®¸ä½¿ç”¨åˆ†åŒºè¡¨å’Œå­åˆ†åŒºè¡¨åã€‚æŒ‡å®šåˆ†åŒºåç§°æ—¶ï¼Œè¯¥åˆ†åŒºçš„å­åˆ†åŒºå°†åŒ…æ‹¬åœ¨æ“ä½œä¸­ã€‚ åœ¨MySQL 5.6æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä¸¤ä¸ªæœåŠ¡å™¨éƒ½å…·æœ‰GAï¼ˆé€šç”¨å¯ç”¨æ€§ï¼‰çŠ¶æ€å¹¶ä¸”å®ƒä»¬çš„ç‰ˆæœ¬åœ¨åŒä¸€ç³»åˆ—ä¸­ï¼Œåˆ™ä»å¦ä¸€ä¸ªæœåŠ¡å™¨å¯¼å…¥è¡¨ç©ºé—´æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„ã€‚å¦åˆ™ï¼Œè¯¥æ–‡ä»¶å¿…é¡»åœ¨å¯¼å…¥å®ƒçš„æœåŠ¡å™¨ä¸Šåˆ›å»ºã€‚ åœ¨å¤åˆ¶æ–¹æ¡ˆä¸­ï¼Œåœ¨ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ä¸Šå¿…é¡»å°†innodb_file_per_tableè®¾ç½®ä¸ºONã€‚ åœ¨Windowsä¸Šï¼ŒInnoDBä»¥å°å†™å½¢å¼å†…éƒ¨å­˜å‚¨æ•°æ®åº“ï¼Œè¡¨ç©ºé—´å’Œè¡¨åã€‚è¦é¿å…åŒºåˆ†å¤§å°å†™æ“ä½œç³»ç»Ÿï¼ˆå¦‚Linuxå’ŒUNIXï¼‰ä¸Šçš„å¯¼å…¥é—®é¢˜ï¼Œè¯·ä½¿ç”¨å°å†™åç§°åˆ›å»ºæ‰€æœ‰æ•°æ®åº“ï¼Œè¡¨ç©ºé—´å’Œè¡¨ã€‚ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•æ˜¯åœ¨åˆ›å»ºæ•°æ®åº“ï¼Œè¡¨ç©ºé—´æˆ–è¡¨ä¹‹å‰ï¼Œåœ¨my.cnfæˆ–my.iniæ–‡ä»¶çš„[mysqld]èŠ‚ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š","text":"è¿ç§»File-Per-Table TablespacesTransportable Tablespaceç¤ºä¾‹Transportable Tablespace Internalsæœ¬èŠ‚ä»‹ç»å¦‚ä½•å°†file-per-table tablespaceä»ä¸€ä¸ªserverè¿ç§»åˆ°å¦ä¸€ä¸ªserver,ä¹Ÿç§°ä¸ºå¯Transportable TablespacesåŠŸèƒ½ã€‚ åœ¨MySQL 5.7.4ä¹‹å‰,åªæ”¯æŒéåˆ†åŒºçš„InnoDBè¡¨ã€‚ ä»MySQL 5.7.4å¼€å§‹,è¿˜æ”¯æŒåˆ†åŒºçš„InnoDBè¡¨å’Œå„ä¸ªInnoDBè¡¨åˆ†åŒºå’Œå­åˆ†åŒºã€‚ There are many reasons why you might copy an InnoDB file-per-table tablespace to a different database server: ç”ŸæˆæŠ¥å‘Šè€Œä¸å½±å“ç”Ÿäº§åº“ ä¸ºå¤‡åº“åˆå§‹åŒ–æ•°æ® ç”¨äºæ•°æ®æ¢å¤ ç›¸å¯¹äºmysqldump,ä¼ è¾“è¡¨ç©ºé—´æœ‰ä¸ªæ›´å¿«çš„é€Ÿåº¦ å°†æ¯ä¸ªæ–‡ä»¶çš„è¡¨ç©ºé—´ç§»åŠ¨åˆ°å…·æœ‰æ›´é€‚åˆç³»ç»Ÿè¦æ±‚çš„å­˜å‚¨ä»‹è´¨çš„æœåŠ¡å™¨.ä¾‹å¦‚,æ‚¨å¯èƒ½å¸Œæœ›åœ¨SSDè®¾å¤‡ä¸Šæ‹¥æœ‰ç¹å¿™çš„è¡¨,æˆ–åœ¨å¤§å®¹é‡HDDè®¾å¤‡ä¸Šä½¿ç”¨å¤§å‹è¡¨. é™åˆ¶å’Œä½¿ç”¨æ³¨æ„äº‹é¡¹ ä»…å½“innodb_file_per_tableè®¾ç½®ä¸ºONï¼ˆè¿™æ˜¯MySQL 5.6.6çš„é»˜è®¤è®¾ç½®ï¼‰æ—¶ï¼Œä¼ è¾“è¡¨ç©ºé—´åŠŸèƒ½æ‰å¯ä»¥ä½¿ç”¨ã€‚ é©»ç•™åœ¨å…±äº«ç³»ç»Ÿè¡¨ç©ºé—´ä¸­çš„è¡¨ä¸èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­,åªæœ‰åªè¯»æ“ä½œå¯ä»¥æ‰§è¡Œ page sizeè¦ç›¸åŒ.When importing a tablespace, the page size must match the page size of the importing instance. Prior to MySQL 5.7.4, DISCARD TABLESPACE is not supported for partitioned tables meaning that transportable tablespaces is also unsupported. If you run ALTER TABLE â€¦ DISCARD TABLESPACE on a partitioned table, the following error is returned: ERROR 1031 (HY000): Table storage engine for â€˜partâ€™ doesnâ€™t have this option. As of MySQL 5.7.4, ALTER TABLE â€¦ DISCARD TABLESPACE is supported for partitioned InnoDB tables, and ALTER TABLE â€¦ DISCARD PARTITION â€¦ TABLESPACE is supported for InnoDB table partitions. å½“foreign_key_checksè®¾ç½®ä¸º1æ—¶ï¼Œå¯¹äºçˆ¶ - å­ï¼ˆä¸»é”® - å¤–é”®ï¼‰å…³ç³»çš„è¡¨ç©ºé—´ä¸æ”¯æŒDISCARD TABLESPACEã€‚åœ¨æ”¾å¼ƒçˆ¶å­è¡¨çš„è¡¨ç©ºé—´ä¹‹å‰ï¼Œè¯·è®¾ç½®foreign_key_checks = 0ã€‚ åˆ†åŒºçš„InnoDBè¡¨ä¸æ”¯æŒå¤–é”®ã€‚ ALTER TABLE â€¦ IMPORT TABLESPACEä¸ä¼šå¯¹å¯¼å…¥çš„æ•°æ®å®æ–½å¤–é”®çº¦æŸã€‚ å¦‚æœè¡¨ä¹‹é—´å­˜åœ¨å¤–é”®çº¦æŸï¼Œåˆ™åº”åœ¨ç›¸åŒï¼ˆé€»è¾‘ï¼‰æ—¶é—´ç‚¹å¯¼å‡ºæ‰€æœ‰è¡¨ã€‚ åˆ†åŒºçš„InnoDBè¡¨ä¸æ”¯æŒå¤–é”®ã€‚ ALTER TABLE â€¦ IMPORT TABLESPACEå’ŒALTER TABLE â€¦ IMPORT PARTITION â€¦ TABLESPACEä¸éœ€è¦.cfgå…ƒæ•°æ®æ–‡ä»¶æ¥å¯¼å…¥è¡¨ç©ºé—´ã€‚ ä½†æ˜¯ï¼Œåœ¨ä¸ä½¿ç”¨.cfgæ–‡ä»¶å¯¼å…¥æ—¶ï¼Œä¸ä¼šæ‰§è¡Œå…ƒæ•°æ®æ£€æŸ¥ï¼Œå¹¶ä¸”å°†å‘å‡ºç±»ä¼¼äºä»¥ä¸‹å†…å®¹çš„è­¦å‘Šï¼š 123Message: InnoDB: IO Read error: (2, No such file or directory) Error opening &#x27;.\\test\\t.cfg&#x27;, will attempt to import without schema verification1 row in set (0.00 sec) æ²¡æœ‰.cfgæ–‡ä»¶å¯¼å…¥çš„èƒ½åŠ›å¯èƒ½æ›´æ–¹ä¾¿ï¼Œå½“ä¸éœ€è¦æ¨¡å¼ä¸åŒ¹é…ã€‚ æ­¤å¤–ï¼Œæ— æ³•ä½¿ç”¨.cfgæ–‡ä»¶å¯¼å…¥çš„èƒ½åŠ›åœ¨æ— æ³•ä».ibdæ–‡ä»¶æ”¶é›†å…ƒæ•°æ®çš„å´©æºƒæ¢å¤æ–¹æ¡ˆä¸­å¾ˆæœ‰ç”¨ã€‚ The ability to import without a .cfg file may be more convenient when no schema mismatches are expected. Additionally, the ability to import without a .cfg file could be useful in crash recovery scenarios in which metadata cannot be collected from an .ibd file. ç”±äº.cfgå…ƒæ•°æ®æ–‡ä»¶é™åˆ¶ï¼Œåœ¨ä¸ºåˆ†åŒºè¡¨å¯¼å…¥è¡¨ç©ºé—´æ–‡ä»¶æ—¶ï¼Œä¸ä¼šæŠ¥å‘Šåˆ†åŒºç±»å‹æˆ–åˆ†åŒºå®šä¹‰å·®å¼‚çš„æ¨¡å¼ä¸åŒ¹é…ã€‚ä½†ä¼šæŠ¥å‘Šåˆ—å·®å¼‚ã€‚ åœ¨å­åˆ†åŒºè¡¨ä¸Šè¿è¡ŒALTER TABLE â€¦ DISCARD PARTITION â€¦ TABLESPACEå’ŒALTER TABLE â€¦ IMPORT PARTITION â€¦ TABLESPACEæ—¶ï¼Œå…è®¸ä½¿ç”¨åˆ†åŒºè¡¨å’Œå­åˆ†åŒºè¡¨åã€‚æŒ‡å®šåˆ†åŒºåç§°æ—¶ï¼Œè¯¥åˆ†åŒºçš„å­åˆ†åŒºå°†åŒ…æ‹¬åœ¨æ“ä½œä¸­ã€‚ åœ¨MySQL 5.6æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä¸¤ä¸ªæœåŠ¡å™¨éƒ½å…·æœ‰GAï¼ˆé€šç”¨å¯ç”¨æ€§ï¼‰çŠ¶æ€å¹¶ä¸”å®ƒä»¬çš„ç‰ˆæœ¬åœ¨åŒä¸€ç³»åˆ—ä¸­ï¼Œåˆ™ä»å¦ä¸€ä¸ªæœåŠ¡å™¨å¯¼å…¥è¡¨ç©ºé—´æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„ã€‚å¦åˆ™ï¼Œè¯¥æ–‡ä»¶å¿…é¡»åœ¨å¯¼å…¥å®ƒçš„æœåŠ¡å™¨ä¸Šåˆ›å»ºã€‚ åœ¨å¤åˆ¶æ–¹æ¡ˆä¸­ï¼Œåœ¨ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ä¸Šå¿…é¡»å°†innodb_file_per_tableè®¾ç½®ä¸ºONã€‚ åœ¨Windowsä¸Šï¼ŒInnoDBä»¥å°å†™å½¢å¼å†…éƒ¨å­˜å‚¨æ•°æ®åº“ï¼Œè¡¨ç©ºé—´å’Œè¡¨åã€‚è¦é¿å…åŒºåˆ†å¤§å°å†™æ“ä½œç³»ç»Ÿï¼ˆå¦‚Linuxå’ŒUNIXï¼‰ä¸Šçš„å¯¼å…¥é—®é¢˜ï¼Œè¯·ä½¿ç”¨å°å†™åç§°åˆ›å»ºæ‰€æœ‰æ•°æ®åº“ï¼Œè¡¨ç©ºé—´å’Œè¡¨ã€‚ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•æ˜¯åœ¨åˆ›å»ºæ•°æ®åº“ï¼Œè¡¨ç©ºé—´æˆ–è¡¨ä¹‹å‰ï¼Œåœ¨my.cnfæˆ–my.iniæ–‡ä»¶çš„[mysqld]èŠ‚ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š 12[mysqld]lower_case_table_names=1 ALTER TABLE â€¦ DISCARD TABLESPACEå’ŒALTER TABLE â€¦ IMPORT TABLESPACEä¸æ”¯æŒgeneral tablespace ä»MySQL 5.7.9å¼€å§‹ï¼ŒInnoDBè¡¨çš„é»˜è®¤è¡Œæ ¼å¼å¯ä»¥ä½¿ç”¨innodb_default_row_formaté…ç½®é€‰é¡¹é…ç½®ã€‚å¦‚æœæºæœåŠ¡å™¨ä¸Šçš„innodb_default_row_formatè®¾ç½®ä¸ç›®æ ‡æœåŠ¡å™¨ä¸Šçš„è®¾ç½®ä¸åŒï¼Œåˆ™è¯•å›¾å¯¼å…¥æœªæ˜ç¡®å®šä¹‰è¡Œæ ¼å¼ï¼ˆROW_FORMATï¼‰æˆ–ä½¿ç”¨ROW_FORMAT = DEFAULTçš„è¡¨å¯èƒ½ä¼šå¯¼è‡´æ¨¡å¼ä¸åŒ¹é…é”™è¯¯ã€‚æœ‰å…³ç›¸å…³ä¿¡æ¯ï¼Œè¯·å‚è§ç¬¬15.11.2èŠ‚â€œæŒ‡å®šè¡¨çš„è¡Œæ ¼å¼â€ã€‚ innodb_default_row_formatThe innodb_default_row_format option, introduced in MySQL 5.7.9, defines the default row format for InnoDB tables (including user-created InnoDB temporary tables). The default setting is DYNAMIC. Other permitted values are COMPACT and REDUNDANT. The COMPRESSED row format, which is not supported for use in the system tablespace, cannot be defined as the default. Newly created tables use the row format defined by innodb_default_row_format when a ROW_FORMAT option is not specified explicitly or when ROW_FORMAT=DEFAULT is used. When a ROW_FORMAT option is not specified explicitly or when ROW_FORMAT=DEFAULT is used, any operation that rebuilds a table also silently changes the row format of the table to the format defined by innodb_default_row_format. For more information, see Section 15.11.2, â€œSpecifying the Row Format for a Tableâ€. Internal InnoDB temporary tables created by the server to process queries use the DYNAMIC row format, regardless of the innodb_default_row_format setting. In MySQL 5.7.8 and earlier, the default row format is COMPACT.REDUNDANTå’ŒCOMPACTè¡Œæ ¼å¼æ”¯æŒæœ€å¤§ç´¢å¼•å…³é”®å­—å‰ç¼€é•¿åº¦ä¸º767å­—èŠ‚ï¼Œè€ŒDYNAMICå’ŒCOMPRESSEDè¡Œæ ¼å¼æ”¯æŒç´¢å¼•å…³é”®å­—å‰ç¼€é•¿åº¦ä¸º3072å­—èŠ‚ï¼Œå¦‚æœinnodb_large_prefixé…ç½®é€‰é¡¹å¯ç”¨ã€‚ åœ¨å¤åˆ¶ç¯å¢ƒä¸­ï¼Œå¦‚æœinnodb_default_row_formatåœ¨ä¸»æœåŠ¡å™¨ä¸Šè®¾ç½®ä¸ºDYNAMICï¼Œå¹¶åœ¨ä»æœåŠ¡å™¨ä¸Šè®¾ç½®ä¸ºCOMPACTï¼Œåˆ™ä»¥ä¸‹æ²¡æœ‰æ˜¾å¼å®šä¹‰è¡Œæ ¼å¼çš„DDLè¯­å¥åœ¨ä¸»æœåŠ¡å™¨ä¸ŠæˆåŠŸï¼Œä½†åœ¨ä»æœåŠ¡å™¨ä¸Šå¤±è´¥ï¼šCREATE TABLE t1 (c1 INT PRIMARY KEY, c2 VARCHAR(5000), KEY i1(c2(3070)));è¦æŸ¥çœ‹è¡¨çš„è¡Œæ ¼å¼ï¼Œè¯·å‘å‡ºSHOW TABLE STATUSè¯­å¥æˆ–æŸ¥è¯¢INFORMATION_SCHEMA.TABLESã€‚SELECT * FROM INFORMATION_SCHEMA.INNODB_SYS_TABLES WHERE NAME LIKE &#39;test/t1&#39; \\G å½“å¯¼å‡ºä½¿ç”¨InnoDBè¡¨ç©ºé—´åŠ å¯†åŠŸèƒ½åŠ å¯†çš„è¡¨ç©ºé—´æ—¶ï¼ŒInnoDBé™¤äº†ç”Ÿæˆ.cfgå…ƒæ•°æ®æ–‡ä»¶å¤–è¿˜ä¼šç”Ÿæˆ.cfpæ–‡ä»¶ã€‚åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡ŒALTER TABLE â€¦ IMPORT TABLESPACEæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å°†.cfpæ–‡ä»¶ä¸.cfgæ–‡ä»¶å’Œè¡¨ç©ºé—´æ–‡ä»¶ä¸€èµ·å¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚ .cfpæ–‡ä»¶åŒ…å«ä¼ è¾“å¯†é’¥å’ŒåŠ å¯†çš„è¡¨ç©ºé—´å¯†é’¥ã€‚åœ¨å¯¼å…¥æ—¶ï¼ŒInnoDBä½¿ç”¨ä¼ è¾“å¯†é’¥æ¥è§£å¯†è¡¨ç©ºé—´å¯†é’¥ã€‚æœ‰å…³ç›¸å…³ä¿¡æ¯ï¼Œè¯·å‚è§ç¬¬15.7.10èŠ‚â€œInnoDBè¡¨ç©ºé—´åŠ å¯†â€ã€‚","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"ä¼ è¾“è¡¨ç©ºé—´","slug":"ä¼ è¾“è¡¨ç©ºé—´","permalink":"http://fuxkdb.com/tags/%E4%BC%A0%E8%BE%93%E8%A1%A8%E7%A9%BA%E9%97%B4/"}]},{"title":"è°ƒæ•´InnoDBç³»ç»Ÿè¡¨ç©ºé—´å¤§å°","slug":"è°ƒæ•´InnoDBç³»ç»Ÿè¡¨ç©ºé—´å¤§å°","date":"2017-08-11T02:57:00.000Z","updated":"2017-08-11T02:58:07.000Z","comments":true,"path":"2017/08/11/è°ƒæ•´InnoDBç³»ç»Ÿè¡¨ç©ºé—´å¤§å°/","link":"","permalink":"http://fuxkdb.com/2017/08/11/%E8%B0%83%E6%95%B4InnoDB%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4%E5%A4%A7%E5%B0%8F/","excerpt":"","text":"è°ƒæ•´InnoDBç³»ç»Ÿè¡¨ç©ºé—´å¤§å°æœ¬æ–‡ä»‹ç»å¦‚ä½•å¢å¤§æˆ–ç¼©å°InnoDB system tablespace å¢å¤§InnoDB system tablespaceæœ€ç®€å•çš„å¢å¤§InnoDB system tablespaceå¤§å°çš„æ–¹æ³•æ˜¯åœ¨ä¸€å¼€å§‹é…ç½®çš„æ—¶å€™å°±æŒ‡å®šä¸ºè‡ªåŠ¨æ‰©å±•. ä¸ºinnodb_data_file_pathå‚æ•°ä¸­çš„æœ€åä¸€ä¸ªæ•°æ®æ–‡ä»¶æŒ‡å®šautoextendé€‰é¡¹. InnoDBåœ¨ç©ºé—´ä¸è¶³æ—¶ä»¥64MBä¸ºå•ä½è‡ªåŠ¨å¢åŠ è¯¥æ–‡ä»¶çš„å¤§å°. å¯ä»¥é€šè¿‡è®¾ç½®innodb_autoextend_incrementç³»ç»Ÿå˜é‡çš„å€¼ï¼ˆä»¥å…†å­—èŠ‚ä¸ºå•ä½ï¼‰æ¥æ›´æ”¹å¢é‡å¤§å°. æ‚¨å¯ä»¥é€šè¿‡æ·»åŠ å¦ä¸€ä¸ªæ•°æ®æ–‡ä»¶æ¥æ‰©å±•ç³»ç»Ÿè¡¨ç©ºé—´ï¼š 1.å…³é—­MySQL2.å¦‚æœä¸Šä¸€ä¸ªæ•°æ®æ–‡ä»¶æ˜¯ä½¿ç”¨å…³é”®å­—autoextendå®šä¹‰çš„,åˆ™æ ¹æ®å®é™…å¢é•¿çš„å¤§å°å°†å…¶å®šä¹‰æ›´æ”¹ä¸ºä½¿ç”¨å›ºå®šå¤§å°. æ£€æŸ¥æ•°æ®æ–‡ä»¶çš„å¤§å°,å°†å…¶èˆå…¥åˆ°1024Ã—1024å­—èŠ‚ï¼ˆ= 1MBï¼‰çš„æœ€æ¥è¿‘çš„å€æ•°,å¹¶åœ¨innodb_data_file_pathä¸­æ˜¾å¼æŒ‡å®šèˆå…¥åçš„å¤§å°.3.å°†æ–°çš„æ•°æ®æ–‡ä»¶æ·»åŠ åˆ°innodb_data_file_pathçš„æœ«å°¾,å¯ä»¥æŒ‡å®šè¯¥æ–‡ä»¶ä¸ºè‡ªåŠ¨æ‰©å±•. æ³¨æ„,åªèƒ½å°†innodb_data_file_pathä¸­çš„æœ€åä¸€ä¸ªæ•°æ®æ–‡ä»¶æŒ‡å®šä¸ºè‡ªåŠ¨æ‰©å±•.4.å¯åŠ¨MySQL å®é™…ä¾‹å­: åˆå§‹åªæœ‰ä¸€ä¸ªibdata1,ç°åœ¨æˆ‘ä»¬æƒ³å¢åŠ ä¸€ä¸ªæ•°æ®æ–‡ä»¶ 12innodb_data_home_dir =innodb_data_file_path = /ibdata/ibdata1:10M:autoextend å‡è®¾ibdata1æ­¤æ—¶å·²ç»å¢é•¿åˆ°988M,é‚£ä¹ˆä¿®æ”¹é…ç½®ä¸º 12innodb_data_home_dir =innodb_data_file_path = /ibdata/ibdata1:988M;/disk2/ibdata2:50M:autoextend å¯åŠ¨MySQLå,ibdata2ä¼šè¢«åˆå§‹åŒ– 1232017-08-11T10:27:06.014446+08:00 0 [Note] InnoDB: Need to create a new innodb_system data file &#x27;ibdata2&#x27;.2017-08-11T10:27:06.014567+08:00 0 [Note] InnoDB: Setting file &#x27;./ibdata2&#x27; size to 50 MB. Physically writing the file full; Please wait ...2017-08-11T10:27:06.182464+08:00 0 [Note] InnoDB: File &#x27;./ibdata2&#x27; size is now 50 MB. ç¼©å°InnoDB system tablespaceæ‚¨ä¸èƒ½ä»ç³»ç»Ÿè¡¨ç©ºé—´ä¸­åˆ é™¤æ•°æ®æ–‡ä»¶. è¦å‡å°‘ç³»ç»Ÿè¡¨ç©ºé—´å¤§å°,è¯·ä½¿ç”¨ä»¥ä¸‹è¿‡ç¨‹ï¼š 1.ä½¿ç”¨mysqldumpæ¥è½¬å‚¨æ‰€æœ‰çš„InnoDBè¡¨,åŒ…æ‹¬ä½äºMySQLæ•°æ®åº“ä¸­çš„InnoDBè¡¨. 123456789101112131415161718192021222324mysql&gt; SELECT TABLE_NAME from INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=&#x27;mysql&#x27; and ENGINE=&#x27;InnoDB&#x27;;+---------------------------+| TABLE_NAME |+---------------------------+| engine_cost || gtid_executed || help_category || help_keyword || help_relation || help_topic || innodb_index_stats || innodb_table_stats || plugin || server_cost || servers || slave_master_info || slave_relay_log_info || slave_worker_info || time_zone || time_zone_leap_second || time_zone_name || time_zone_transition || time_zone_transition_type |+---------------------------+ 2.å…³é—­MySQL3.åˆ é™¤æ‰€æœ‰ç°æœ‰çš„è¡¨ç©ºé—´æ–‡ä»¶ï¼ˆ .ibdï¼‰,åŒ…æ‹¬ibdataå’Œib_logæ–‡ä»¶. ä¸è¦å¿˜è®°åˆ é™¤ä½äºMySQLæ•°æ®åº“ä¸­çš„è¡¨çš„ .ibdæ–‡ä»¶.4.åˆ é™¤InnoDBè¡¨çš„ä»»ä½•.frmæ–‡ä»¶.5.é…ç½®æ–°çš„è¡¨ç©ºé—´.6.é‡å¯MySQL7.å¯¼å…¥dumpæ–‡ä»¶ Noteå¦‚æœæ‚¨çš„æ•°æ®åº“ä»…ä½¿ç”¨InnoDBå¼•æ“,å¯èƒ½ä¼šæ›´å®¹æ˜“åœ°è½¬å‚¨æ‰€æœ‰æ•°æ®åº“,åœæ­¢æœåŠ¡å™¨,åˆ é™¤æ‰€æœ‰æ•°æ®åº“å’ŒInnoDBæ—¥å¿—æ–‡ä»¶,é‡æ–°å¯åŠ¨æœåŠ¡å™¨ä»¥åŠå¯¼å…¥è½¬å‚¨æ–‡ä»¶.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"MySQLæ•°æ®åº“è®¾è®¡è§„èŒƒ","slug":"MySQLæ•°æ®åº“è®¾è®¡è§„èŒƒ","date":"2017-08-10T08:00:00.000Z","updated":"2017-08-10T08:16:04.000Z","comments":true,"path":"2017/08/10/MySQLæ•°æ®åº“è®¾è®¡è§„èŒƒ/","link":"","permalink":"http://fuxkdb.com/2017/08/10/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/","excerpt":"MySQLæ•°æ®åº“è®¾è®¡è§„èŒƒMySQLæ•°æ®åº“ä¸Oracleã€sqlserverç­‰æ•°æ®åº“ç›¸æ¯”ï¼Œæœ‰å…¶å†…æ ¸ä¸Šçš„ä¼˜åŠ¿ä¸åŠ£åŠ¿ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨MySQLæ•°æ®åº“çš„æ—¶å€™éœ€è¦éµå¾ªä¸€å®šè§„èŒƒï¼Œæ‰¬é•¿é¿çŸ­ã€‚æœ¬è§„èŒƒæ—¨åœ¨å¸®åŠ©æˆ–æŒ‡å¯¼RDã€QAã€OPç­‰æŠ€æœ¯äººå‘˜åšå‡ºé€‚åˆçº¿ä¸Šä¸šåŠ¡çš„æ•°æ®åº“è®¾è®¡ã€‚åœ¨æ•°æ®åº“å˜æ›´å’Œå¤„ç†æµç¨‹ã€æ•°æ®åº“è¡¨è®¾è®¡ã€SQLç¼–å†™ç­‰æ–¹é¢äºˆä»¥è§„èŒƒï¼Œä»è€Œä¸ºå…¬å¸ä¸šåŠ¡ç³»ç»Ÿç¨³å®šã€å¥åº·åœ°è¿è¡Œæä¾›ä¿éšœã€‚ æ•°æ®åº“è®¾è®¡ä»¥ä¸‹æ‰€æœ‰è§„èŒƒä¼šæŒ‰ç…§ã€é«˜å±ã€‘ã€ã€å¼ºåˆ¶ã€‘ã€ã€å»ºè®®ã€‘ä¸‰ä¸ªçº§åˆ«è¿›è¡Œæ ‡æ³¨ï¼Œéµå®ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ã€‚å¯¹äºä¸æ»¡è¶³ã€é«˜å±ã€‘å’Œã€å¼ºåˆ¶ã€‘ä¸¤ä¸ªçº§åˆ«çš„è®¾è®¡ï¼ŒDBAä¼šå¼ºåˆ¶æ‰“å›è¦æ±‚ä¿®æ”¹ã€‚ åº“å1.ã€å¼ºåˆ¶ã€‘åº“çš„åç§°å¿…é¡»æ§åˆ¶åœ¨32ä¸ªå­—ç¬¦ä»¥å†…ï¼Œç›¸å…³æ¨¡å—çš„è¡¨åä¸è¡¨åä¹‹é—´å°½é‡æç°joinçš„å…³ç³»ï¼Œå¦‚userè¡¨å’Œuser_loginè¡¨ã€‚2.ã€å»ºè®®ã€‘åº“çš„åç§°æ ¼å¼ï¼šä¸šåŠ¡ç³»ç»Ÿåç§°å­ç³»ç»Ÿåï¼ŒåŒä¸€æ¨¡å—ä½¿ç”¨çš„è¡¨åå°½é‡ä½¿ç”¨ç»Ÿä¸€å‰ç¼€ã€‚**3.ã€å¼ºåˆ¶ã€‘ä¸€èˆ¬åˆ†åº“åç§°å‘½åæ ¼å¼æ˜¯â€œåº“é€šé…åç¼–å·â€ï¼Œç¼–å·ä»â€œ0â€å¼€å§‹é€’å¢ï¼Œæ¯”å¦‚â€œwenda001â€ **ä»¥æ—¶é—´è¿›è¡Œåˆ†åº“çš„åç§°æ ¼å¼æ˜¯â€œåº“é€šé…åæ—¶é—´â€4.ã€å¼ºåˆ¶ã€‘åˆ›å»ºæ•°æ®åº“æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†ï¼Œå¹¶ä¸”å­—ç¬¦é›†åªèƒ½æ˜¯utf8æˆ–è€…utf8mb4 åˆ›å»ºæ•°æ®åº“SQLä¸¾ä¾‹ï¼š 1Create database db1 default character set utf8; è¡¨ç»“æ„1.ã€å¼ºåˆ¶ã€‘è¡¨å’Œåˆ—çš„åç§°å¿…é¡»æ§åˆ¶åœ¨32ä¸ªå­—ç¬¦ä»¥å†…ï¼Œè¡¨ååªèƒ½ä½¿ç”¨å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸€å¾‹å°å†™ã€‚2.ã€å»ºè®®ã€‘è¡¨åè¦æ±‚æ¨¡å—åå¼ºç›¸å…³ï¼Œå¦‚å¸ˆèµ„ç³»ç»Ÿé‡‡ç”¨â€szâ€ä½œä¸ºå‰ç¼€ï¼Œæ¸ é“ç³»ç»Ÿé‡‡ç”¨â€qdâ€ä½œä¸ºå‰ç¼€ç­‰ã€‚3.ã€å¼ºåˆ¶ã€‘åˆ›å»ºè¡¨æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†ä¸ºutf8æˆ–utf8mb4ã€‚4.ã€å¼ºåˆ¶ã€‘åˆ›å»ºè¡¨æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šè¡¨å­˜å‚¨å¼•æ“ç±»å‹ï¼Œå¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€å¾‹ä¸ºInnoDBã€‚ å½“éœ€ä½¿ç”¨é™¤InnoDBä»¥å¤–çš„å­˜å‚¨å¼•æ“æ—¶,å¿…é¡»é€šè¿‡DBAå®¡æ ¸æ‰èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ å› ä¸ºInnodbè¡¨æ”¯æŒäº‹åŠ¡ã€è¡Œé”ã€å®•æœºæ¢å¤ã€MVCCç­‰å…³ç³»å‹æ•°æ®åº“é‡è¦ç‰¹æ€§ï¼Œä¸ºä¸šç•Œä½¿ç”¨æœ€å¤šçš„MySQLå­˜å‚¨å¼•æ“ã€‚è€Œè¿™æ˜¯å…¶ä»–å¤§å¤šæ•°å­˜å‚¨å¼•æ“ä¸å…·å¤‡çš„ï¼Œå› æ­¤é¦–æ¨InnoDB","text":"MySQLæ•°æ®åº“è®¾è®¡è§„èŒƒMySQLæ•°æ®åº“ä¸Oracleã€sqlserverç­‰æ•°æ®åº“ç›¸æ¯”ï¼Œæœ‰å…¶å†…æ ¸ä¸Šçš„ä¼˜åŠ¿ä¸åŠ£åŠ¿ã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨MySQLæ•°æ®åº“çš„æ—¶å€™éœ€è¦éµå¾ªä¸€å®šè§„èŒƒï¼Œæ‰¬é•¿é¿çŸ­ã€‚æœ¬è§„èŒƒæ—¨åœ¨å¸®åŠ©æˆ–æŒ‡å¯¼RDã€QAã€OPç­‰æŠ€æœ¯äººå‘˜åšå‡ºé€‚åˆçº¿ä¸Šä¸šåŠ¡çš„æ•°æ®åº“è®¾è®¡ã€‚åœ¨æ•°æ®åº“å˜æ›´å’Œå¤„ç†æµç¨‹ã€æ•°æ®åº“è¡¨è®¾è®¡ã€SQLç¼–å†™ç­‰æ–¹é¢äºˆä»¥è§„èŒƒï¼Œä»è€Œä¸ºå…¬å¸ä¸šåŠ¡ç³»ç»Ÿç¨³å®šã€å¥åº·åœ°è¿è¡Œæä¾›ä¿éšœã€‚ æ•°æ®åº“è®¾è®¡ä»¥ä¸‹æ‰€æœ‰è§„èŒƒä¼šæŒ‰ç…§ã€é«˜å±ã€‘ã€ã€å¼ºåˆ¶ã€‘ã€ã€å»ºè®®ã€‘ä¸‰ä¸ªçº§åˆ«è¿›è¡Œæ ‡æ³¨ï¼Œéµå®ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ã€‚å¯¹äºä¸æ»¡è¶³ã€é«˜å±ã€‘å’Œã€å¼ºåˆ¶ã€‘ä¸¤ä¸ªçº§åˆ«çš„è®¾è®¡ï¼ŒDBAä¼šå¼ºåˆ¶æ‰“å›è¦æ±‚ä¿®æ”¹ã€‚ åº“å1.ã€å¼ºåˆ¶ã€‘åº“çš„åç§°å¿…é¡»æ§åˆ¶åœ¨32ä¸ªå­—ç¬¦ä»¥å†…ï¼Œç›¸å…³æ¨¡å—çš„è¡¨åä¸è¡¨åä¹‹é—´å°½é‡æç°joinçš„å…³ç³»ï¼Œå¦‚userè¡¨å’Œuser_loginè¡¨ã€‚2.ã€å»ºè®®ã€‘åº“çš„åç§°æ ¼å¼ï¼šä¸šåŠ¡ç³»ç»Ÿåç§°å­ç³»ç»Ÿåï¼ŒåŒä¸€æ¨¡å—ä½¿ç”¨çš„è¡¨åå°½é‡ä½¿ç”¨ç»Ÿä¸€å‰ç¼€ã€‚**3.ã€å¼ºåˆ¶ã€‘ä¸€èˆ¬åˆ†åº“åç§°å‘½åæ ¼å¼æ˜¯â€œåº“é€šé…åç¼–å·â€ï¼Œç¼–å·ä»â€œ0â€å¼€å§‹é€’å¢ï¼Œæ¯”å¦‚â€œwenda001â€ **ä»¥æ—¶é—´è¿›è¡Œåˆ†åº“çš„åç§°æ ¼å¼æ˜¯â€œåº“é€šé…åæ—¶é—´â€4.ã€å¼ºåˆ¶ã€‘åˆ›å»ºæ•°æ®åº“æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†ï¼Œå¹¶ä¸”å­—ç¬¦é›†åªèƒ½æ˜¯utf8æˆ–è€…utf8mb4 åˆ›å»ºæ•°æ®åº“SQLä¸¾ä¾‹ï¼š 1Create database db1 default character set utf8; è¡¨ç»“æ„1.ã€å¼ºåˆ¶ã€‘è¡¨å’Œåˆ—çš„åç§°å¿…é¡»æ§åˆ¶åœ¨32ä¸ªå­—ç¬¦ä»¥å†…ï¼Œè¡¨ååªèƒ½ä½¿ç”¨å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸€å¾‹å°å†™ã€‚2.ã€å»ºè®®ã€‘è¡¨åè¦æ±‚æ¨¡å—åå¼ºç›¸å…³ï¼Œå¦‚å¸ˆèµ„ç³»ç»Ÿé‡‡ç”¨â€szâ€ä½œä¸ºå‰ç¼€ï¼Œæ¸ é“ç³»ç»Ÿé‡‡ç”¨â€qdâ€ä½œä¸ºå‰ç¼€ç­‰ã€‚3.ã€å¼ºåˆ¶ã€‘åˆ›å»ºè¡¨æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†ä¸ºutf8æˆ–utf8mb4ã€‚4.ã€å¼ºåˆ¶ã€‘åˆ›å»ºè¡¨æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šè¡¨å­˜å‚¨å¼•æ“ç±»å‹ï¼Œå¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€å¾‹ä¸ºInnoDBã€‚ å½“éœ€ä½¿ç”¨é™¤InnoDBä»¥å¤–çš„å­˜å‚¨å¼•æ“æ—¶,å¿…é¡»é€šè¿‡DBAå®¡æ ¸æ‰èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ å› ä¸ºInnodbè¡¨æ”¯æŒäº‹åŠ¡ã€è¡Œé”ã€å®•æœºæ¢å¤ã€MVCCç­‰å…³ç³»å‹æ•°æ®åº“é‡è¦ç‰¹æ€§ï¼Œä¸ºä¸šç•Œä½¿ç”¨æœ€å¤šçš„MySQLå­˜å‚¨å¼•æ“ã€‚è€Œè¿™æ˜¯å…¶ä»–å¤§å¤šæ•°å­˜å‚¨å¼•æ“ä¸å…·å¤‡çš„ï¼Œå› æ­¤é¦–æ¨InnoDB 5.ã€å¼ºåˆ¶ã€‘å»ºè¡¨å¿…é¡»æœ‰comment6.ã€å¼ºåˆ¶ã€‘è¡¨å¿…é¡»æœ‰ä¸»é”®,ä¸”ä¸»é”®åº”ä¸ºé¡ºåºå¢é•¿,å¦‚æ— ç‰¹æ®Šéœ€æ±‚,å»ºè®®ä¸»é”®ä¸ºid intæˆ–bigint unsigned,ä¸”ä¸ºauto_increment7.ã€å»ºè®®ã€‘æ ¸å¿ƒè¡¨ï¼ˆå¦‚ç”¨æˆ·è¡¨ï¼Œé‡‘é’±ç›¸å…³çš„è¡¨ï¼‰å¿…é¡»æœ‰è¡Œæ•°æ®çš„åˆ›å»ºæ—¶é—´å­—æ®µcreate_timeå’Œæœ€åæ›´æ–°æ—¶é—´å­—æ®µupdate_timeï¼Œä¾¿äºæŸ¥é—®é¢˜ã€‚8.ã€å»ºè®®ã€‘è¡¨ä¸­æ‰€æœ‰å­—æ®µå¿…é¡»éƒ½æ˜¯NOT NULLå±æ€§ï¼Œä¸šåŠ¡å¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰DEFAULTå€¼ã€‚å› ä¸ºä½¿ç”¨NULLå€¼ä¼šå­˜åœ¨æ¯ä¸€è¡Œéƒ½ä¼šå ç”¨é¢å¤–å­˜å‚¨ç©ºé—´ã€æ•°æ®è¿ç§»å®¹æ˜“å‡ºé”™ã€èšåˆå‡½æ•°è®¡ç®—ç»“æœåå·®ç­‰é—®é¢˜ã€‚9.ã€å»ºè®®ã€‘å»ºè®®å¯¹è¡¨é‡Œçš„blobã€textç­‰å¤§å­—æ®µï¼Œå‚ç›´æ‹†åˆ†åˆ°å…¶ä»–è¡¨é‡Œï¼Œä»…åœ¨éœ€è¦è¯»è¿™äº›å¯¹è±¡çš„æ—¶å€™æ‰å»selectã€‚10.ã€å»ºè®®ã€‘åèŒƒå¼è®¾è®¡ï¼šæŠŠç»å¸¸éœ€è¦joinæŸ¥è¯¢çš„å­—æ®µï¼Œåœ¨å…¶ä»–è¡¨é‡Œå†—ä½™ä¸€ä»½ã€‚å¦‚user_nameå±æ€§åœ¨user_accountï¼Œuser_loginlogç­‰è¡¨é‡Œå†—ä½™ä¸€ä»½ï¼Œå‡å°‘joinæŸ¥è¯¢ã€‚**11.ã€å¼ºåˆ¶ã€‘ä¸­é—´è¡¨ç”¨äºä¿ç•™ä¸­é—´ç»“æœé›†ï¼Œåç§°å¿…é¡»ä»¥â€œtmpâ€å¼€å¤´ã€‚å¤‡ä»½è¡¨ç”¨äºå¤‡ä»½æˆ–æŠ“å–æºè¡¨å¿«ç…§ï¼Œåç§°å¿…é¡»ä»¥â€œbak_â€å¼€å¤´ã€‚ä¸­é—´è¡¨å’Œå¤‡ä»½è¡¨å®šæœŸæ¸…ç†ã€‚ 12.ã€å¼ºåˆ¶ã€‘å¯¹äºè¶…è¿‡100Wè¡Œçš„å¤§è¡¨è¿›è¡Œalter tableï¼Œå¿…é¡»ç»è¿‡DBAå®¡æ ¸ï¼Œå¹¶åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œã€‚** å› ä¸ºalter tableä¼šäº§ç”Ÿè¡¨é”ï¼ŒæœŸé—´é˜»å¡å¯¹äºè¯¥è¡¨çš„æ‰€æœ‰å†™å…¥ï¼Œå¯¹äºä¸šåŠ¡å¯èƒ½ä¼šäº§ç”Ÿæå¤§å½±å“ã€‚ ä¸€ä¸ªè¾ƒä¸ºè§„èŒƒçš„å»ºè¡¨è¯­å¥ä¸ºï¼š 1234567891011121314151617181920CREATE TABLE user ( `id` bigint(11) NOT NULL AUTO_INCREMENT, `user_id` bigint(11) NOT NULL COMMENT â€˜ç”¨æˆ·idâ€™ `username` varchar(45) NOT NULL COMMENT &#x27;çœŸå®å§“å&#x27;, `email` varchar(30) NOT NULL COMMENT â€˜ç”¨æˆ·é‚®ç®±â€™, `nickname` varchar(45) NOT NULL COMMENT &#x27;æ˜µç§°&#x27;, `avatar` int(11) NOT NULL COMMENT &#x27;å¤´åƒ&#x27;, `birthday` date NOT NULL COMMENT &#x27;ç”Ÿæ—¥&#x27;, `sex` tinyint(4) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ€§åˆ«&#x27;, `short_introduce` varchar(150) DEFAULT NULL COMMENT &#x27;ä¸€å¥è¯ä»‹ç»è‡ªå·±ï¼Œæœ€å¤š50ä¸ªæ±‰å­—&#x27;, `user_resume` varchar(300) NOT NULL COMMENT &#x27;ç”¨æˆ·æäº¤çš„ç®€å†å­˜æ”¾åœ°å€&#x27;, `user_register_ip` int NOT NULL COMMENT â€˜ç”¨æˆ·æ³¨å†Œæ—¶çš„æºipâ€™, `create_time` timestamp NOT NULL COMMENT â€˜ç”¨æˆ·è®°å½•åˆ›å»ºçš„æ—¶é—´â€™, `update_time` timestamp NOT NULL COMMENT â€˜ç”¨æˆ·èµ„æ–™ä¿®æ”¹çš„æ—¶é—´â€™, `user_review_status` tinyint NOT NULL COMMENT â€˜ç”¨æˆ·èµ„æ–™å®¡æ ¸çŠ¶æ€ï¼Œ1ä¸ºé€šè¿‡ï¼Œ2ä¸ºå®¡æ ¸ä¸­ï¼Œ3ä¸ºæœªé€šè¿‡ï¼Œ4ä¸ºè¿˜æœªæäº¤å®¡æ ¸â€™, PRIMARY KEY (`id`), UNIQUE KEY `idx_user_id` (`user_id`), KEY `idx_username`(`username`), KEY `idx_create_time`(`create_time`,`user_review_status`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&#x27;ç½‘ç«™ç”¨æˆ·åŸºæœ¬ä¿¡æ¯&#x27;; åˆ—æ•°æ®ç±»å‹ä¼˜åŒ–1.ã€å»ºè®®ã€‘è¡¨ä¸­çš„è‡ªå¢åˆ—ï¼ˆauto_incrementå±æ€§ï¼‰ï¼Œæ¨èä½¿ç”¨bigintç±»å‹ã€‚å› ä¸ºæ— ç¬¦å·intå­˜å‚¨èŒƒå›´ä¸º-2147483648~2147483647ï¼ˆå¤§çº¦21äº¿å·¦å³ï¼‰ï¼Œæº¢å‡ºåä¼šå¯¼è‡´æŠ¥é”™ã€‚2.ã€å»ºè®®ã€‘ä¸šåŠ¡ä¸­é€‰æ‹©æ€§å¾ˆå°‘çš„çŠ¶æ€statusã€ç±»å‹typeç­‰å­—æ®µæ¨èä½¿ç”¨tinytintæˆ–è€…smallintç±»å‹èŠ‚çœå­˜å‚¨ç©ºé—´ã€‚3.ã€å»ºè®®ã€‘ä¸šåŠ¡ä¸­IPåœ°å€å­—æ®µæ¨èä½¿ç”¨intç±»å‹ï¼Œä¸æ¨èç”¨char(15)å› ä¸ºintåªå 4å­—èŠ‚ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹å‡½æ•°ç›¸äº’è½¬æ¢ï¼Œè€Œchar(15)å ç”¨è‡³å°‘15å­—èŠ‚ã€‚ä¸€æ—¦è¡¨æ•°æ®è¡Œæ•°åˆ°äº†1äº¿ï¼Œé‚£ä¹ˆè¦å¤šç”¨1.1Gå­˜å‚¨ç©ºé—´4.ã€å»ºè®®ã€‘ä¸æ¨èä½¿ç”¨enumï¼Œsetå› ä¸ºå®ƒä»¬æµªè´¹ç©ºé—´ï¼Œä¸”æšä¸¾å€¼å†™æ­»äº†ï¼Œå˜æ›´ä¸æ–¹ä¾¿ã€‚æ¨èä½¿ç”¨tinyintæˆ–smallint5.ã€å»ºè®®ã€‘ä¸æ¨èä½¿ç”¨blobï¼Œtextç­‰ç±»å‹å®ƒä»¬éƒ½æ¯”è¾ƒæµªè´¹ç¡¬ç›˜å’Œå†…å­˜ç©ºé—´ã€‚åœ¨åŠ è½½è¡¨æ•°æ®æ—¶ï¼Œä¼šè¯»å–å¤§å­—æ®µåˆ°å†…å­˜é‡Œä»è€Œæµªè´¹å†…å­˜ç©ºé—´ï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚å»ºè®®å’ŒPMã€RDæ²Ÿé€šï¼Œæ˜¯å¦çœŸçš„éœ€è¦è¿™ä¹ˆå¤§å­—æ®µï¼ŸInnodbä¸­å½“ä¸€è¡Œè®°å½•è¶…è¿‡8098å­—èŠ‚æ—¶ï¼Œä¼šå°†è¯¥è®°å½•ä¸­é€‰å–æœ€é•¿çš„ä¸€ä¸ªå­—æ®µå°†å…¶768å­—èŠ‚æ”¾åœ¨åŸå§‹pageé‡Œï¼Œè¯¥å­—æ®µä½™ä¸‹å†…å®¹æ”¾åœ¨overflow-pageé‡Œã€‚ä¸å¹¸çš„æ˜¯åœ¨compactè¡Œæ ¼å¼ä¸‹ï¼ŒåŸå§‹pageå’Œoverflow-pageéƒ½ä¼šåŠ è½½ã€‚6.ã€å»ºè®®ã€‘å­˜å‚¨é‡‘é’±çš„å­—æ®µï¼Œå»ºè®®ç”¨intï¼Œç¨‹åºç«¯ä¹˜ä»¥100å’Œé™¤ä»¥100è¿›è¡Œå­˜å–ã€‚å› ä¸ºintå ç”¨4å­—èŠ‚ï¼Œè€Œdoubleå ç”¨8å­—èŠ‚ï¼Œç©ºé—´æµªè´¹ã€‚7.ã€å»ºè®®ã€‘æ–‡æœ¬æ•°æ®å°½é‡ç”¨varcharå­˜å‚¨å› ä¸ºvarcharæ˜¯å˜é•¿å­˜å‚¨ï¼Œæ¯”charæ›´çœç©ºé—´ã€‚MySQL serverå±‚è§„å®šä¸€è¡Œæ‰€æœ‰æ–‡æœ¬æœ€å¤šå­˜65535å­—èŠ‚ï¼Œå› æ­¤åœ¨utf8å­—ç¬¦é›†ä¸‹æœ€å¤šå­˜21844ä¸ªå­—ç¬¦ï¼Œè¶…è¿‡ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºmediumtextå­—æ®µã€‚è€Œtextåœ¨utf8å­—ç¬¦é›†ä¸‹æœ€å¤šå­˜21844ä¸ªå­—ç¬¦ï¼Œmediumtextæœ€å¤šå­˜2^24/3ä¸ªå­—ç¬¦ï¼Œlongtextæœ€å¤šå­˜2^32ä¸ªå­—ç¬¦ã€‚ä¸€èˆ¬å»ºè®®ç”¨varcharç±»å‹ï¼Œå­—ç¬¦æ•°ä¸è¦è¶…è¿‡27008.ã€å»ºè®®ã€‘æ—¶é—´ç±»å‹å°½é‡é€‰å–timestampå› ä¸ºdatetimeå ç”¨8å­—èŠ‚ï¼Œtimestampä»…å ç”¨4å­—èŠ‚ï¼Œä½†æ˜¯èŒƒå›´ä¸º1970-01-01 00:00:01åˆ°2038-01-01 00:00:00ã€‚æ›´ä¸ºé«˜é˜¶çš„æ–¹æ³•ï¼Œé€‰ç”¨intæ¥å­˜å‚¨æ—¶é—´ï¼Œä½¿ç”¨SQLå‡½æ•°unix_timestamp()å’Œfrom_unixtime()æ¥è¿›è¡Œè½¬æ¢ã€‚9.ã€å»ºè®®ã€‘æ‰‹æœºå·ç”¨varchar(20)ç†ç”±ï¼šæ¶‰åŠåˆ°åŒºå·æˆ–è€…å›½å®¶ä»£å·ï¼Œå¯èƒ½å‡ºç°+-()ï¼›æ‰‹æœºå·ä¸ä¼šå»åšæ•°å­¦è¿ç®—ï¼›varcharå¯ ä»¥æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šlikeâ€œ138%â€ ç´¢å¼•è®¾è®¡1.ã€å¼ºåˆ¶ã€‘InnoDBè¡¨å¿…é¡»ä¸»é”®ä¸ºid int/bigint auto_increment,ä¸”ä¸»é”®å€¼ç¦æ­¢è¢«æ›´æ–°ã€‚2.ã€å»ºè®®ã€‘ä¸»é”®çš„åç§°ä»¥â€œpkâ€å¼€å¤´ï¼Œå”¯ä¸€é”®ä»¥â€œukâ€æˆ–â€œuqâ€å¼€å¤´ï¼Œæ™®é€šç´¢å¼•ä»¥â€œidxâ€å¼€å¤´ï¼Œä¸€å¾‹ä½¿ç”¨å°å†™æ ¼å¼ï¼Œä»¥è¡¨å/å­—æ®µçš„åç§°æˆ–ç¼©å†™ä½œä¸ºåç¼€ã€‚3.ã€å¼ºåˆ¶ã€‘å•ä¸ªç´¢å¼•ä¸­æ¯ä¸ªç´¢å¼•è®°å½•çš„é•¿åº¦ä¸èƒ½è¶…è¿‡64KB4.ã€å»ºè®®ã€‘å•ä¸ªè¡¨ä¸Šçš„ç´¢å¼•ä¸ªæ•°ä¸èƒ½è¶…è¿‡7ä¸ª5.ã€å»ºè®®ã€‘åœ¨å»ºç«‹ç´¢å¼•æ—¶ï¼Œå¤šè€ƒè™‘å»ºç«‹è”åˆç´¢å¼•ï¼Œå¹¶æŠŠé€‰æ‹©æ€§æœ€é«˜çš„å­—æ®µæ”¾åœ¨æœ€å‰é¢ã€‚å¦‚åˆ—useridçš„é€‰æ‹©æ€§å¯ç”±select count(distinct userid)è®¡ç®—å‡ºæ¥ã€‚ ä¸¾ä¾‹: èº«ä»½è¯å·çš„é€‰æ‹©æ€§ è¿œé«˜äº æ€§åˆ«çš„é€‰æ‹©æ€§ 6.ã€å¼ºåˆ¶ã€‘åœ¨å¤šè¡¨joinçš„SQLé‡Œï¼Œä¿è¯è¢«é©±åŠ¨è¡¨çš„è¿æ¥åˆ—ä¸Šæœ‰ç´¢å¼•ï¼Œè¿™æ ·joinæ‰§è¡Œæ•ˆç‡æœ€é«˜ã€‚7.ã€å»ºè®®ã€‘å»ºè¡¨æˆ–åŠ ç´¢å¼•æ—¶ï¼Œä¿è¯è¡¨é‡Œäº’ç›¸ä¸å­˜åœ¨å†—ä½™ç´¢å¼•ã€‚å¯¹äºMySQLæ¥è¯´ï¼Œå¦‚æœè¡¨é‡Œå·²ç»å­˜åœ¨key(a,b)ï¼Œåˆ™key(a)ä¸ºå†—ä½™ç´¢å¼•ï¼Œéœ€è¦åˆ é™¤ã€‚ åˆ†åº“åˆ†è¡¨ã€åˆ†åŒºè¡¨1.ã€å¼ºåˆ¶ã€‘åˆ†åŒºè¡¨çš„åˆ†åŒºå­—æ®µï¼ˆpartition-keyï¼‰å¿…é¡»æœ‰ç´¢å¼•ï¼Œæˆ–è€…æ˜¯ç»„åˆç´¢å¼•çš„é¦–åˆ—ã€‚2.ã€å¼ºåˆ¶ã€‘å•ä¸ªåˆ†åŒºè¡¨ä¸­çš„åˆ†åŒºï¼ˆåŒ…æ‹¬å­åˆ†åŒºï¼‰ä¸ªæ•°ä¸èƒ½è¶…è¿‡1024ã€‚3.ã€å¼ºåˆ¶ã€‘ä¸Šçº¿å‰RDæˆ–è€…DBAå¿…é¡»æŒ‡å®šåˆ†åŒºè¡¨çš„åˆ›å»ºã€æ¸…ç†ç­–ç•¥ã€‚4.ã€å¼ºåˆ¶ã€‘è®¿é—®åˆ†åŒºè¡¨çš„SQLå¿…é¡»åŒ…å«åˆ†åŒºé”®ã€‚5.ã€å»ºè®®ã€‘å•ä¸ªåˆ†åŒºæ–‡ä»¶ä¸è¶…è¿‡2Gï¼Œæ€»å¤§å°ä¸è¶…è¿‡50Gã€‚å»ºè®®æ€»åˆ†åŒºæ•°ä¸è¶…è¿‡20ä¸ªã€‚6.ã€å¼ºåˆ¶ã€‘å¯¹äºåˆ†åŒºè¡¨æ‰§è¡Œalter tableæ“ä½œï¼Œå¿…é¡»åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œã€‚7.ã€å¼ºåˆ¶ã€‘é‡‡ç”¨åˆ†åº“ç­–ç•¥çš„ï¼Œåº“çš„æ•°é‡ä¸èƒ½è¶…è¿‡10248.ã€å¼ºåˆ¶ã€‘é‡‡ç”¨åˆ†è¡¨ç­–ç•¥çš„ï¼Œè¡¨çš„æ•°é‡ä¸èƒ½è¶…è¿‡40969.ã€å»ºè®®ã€‘å•ä¸ªåˆ†è¡¨ä¸è¶…è¿‡500Wè¡Œï¼Œibdæ–‡ä»¶å¤§å°ä¸è¶…è¿‡2Gï¼Œè¿™æ ·æ‰èƒ½è®©æ•°æ®åˆ†å¸ƒå¼å˜å¾—æ€§èƒ½æ›´ä½³ã€‚10.ã€å»ºè®®ã€‘æ°´å¹³åˆ†è¡¨å°½é‡ç”¨å–æ¨¡æ–¹å¼ï¼Œæ—¥å¿—ã€æŠ¥è¡¨ç±»æ•°æ®å»ºè®®é‡‡ç”¨æ—¥æœŸè¿›è¡Œåˆ†è¡¨ã€‚ å­—ç¬¦é›†1.ã€å¼ºåˆ¶ã€‘æ•°æ®åº“æœ¬èº«åº“ã€è¡¨ã€åˆ—æ‰€æœ‰å­—ç¬¦é›†å¿…é¡»ä¿æŒä¸€è‡´ï¼Œä¸ºutf8æˆ–utf8mb4 utf8mb4å¯ä»¥å­˜å‚¨emojiè¡¨æƒ… 2.ã€å¼ºåˆ¶ã€‘å‰ç«¯ç¨‹åºå­—ç¬¦é›†æˆ–è€…ç¯å¢ƒå˜é‡ä¸­çš„å­—ç¬¦é›†ï¼Œä¸æ•°æ®åº“ã€è¡¨çš„å­—ç¬¦é›†å¿…é¡»ä¸€è‡´ï¼Œç»Ÿä¸€ä¸ºutf8 ç¨‹åºDAOå±‚è®¾è®¡å»ºè®®1.ã€å»ºè®®ã€‘æ–°çš„ä»£ç ä¸è¦ç”¨modelï¼Œæ¨èä½¿ç”¨æ‰‹åŠ¨æ‹¼SQL+ç»‘å®šå˜é‡ä¼ å…¥å‚æ•°çš„æ–¹å¼ã€‚å› ä¸ºmodelè™½ç„¶å¯ä»¥ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œdbï¼Œä½†æ˜¯å…¶ä½¿ç”¨ä¸å½“å¾ˆå®¹æ˜“é€ æˆç”Ÿæˆçš„SQLéå¸¸å¤æ‚ï¼Œä¸”modelå±‚è‡ªå·±åšçš„å¼ºåˆ¶ç±»å‹è½¬æ¢æ€§èƒ½è¾ƒå·®ï¼Œæœ€ç»ˆå¯¼è‡´æ•°æ®åº“æ€§èƒ½ä¸‹é™ã€‚2.ã€å»ºè®®ã€‘å‰ç«¯ç¨‹åºè¿æ¥MySQLæˆ–è€…redisï¼Œå¿…é¡»è¦æœ‰è¿æ¥è¶…æ—¶å’Œå¤±è´¥é‡è¿æœºåˆ¶ï¼Œä¸”å¤±è´¥é‡è¯•å¿…é¡»æœ‰é—´éš”æ—¶é—´ã€‚3.ã€å»ºè®®ã€‘å‰ç«¯ç¨‹åºæŠ¥é”™é‡Œå°½é‡èƒ½å¤Ÿæç¤ºMySQLæˆ–redisåŸç”Ÿæ€çš„æŠ¥é”™ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥é”™è¯¯ã€‚4.ã€å»ºè®®ã€‘å¯¹äºæœ‰è¿æ¥æ± çš„å‰ç«¯ç¨‹åºï¼Œå¿…é¡»æ ¹æ®ä¸šåŠ¡éœ€è¦é…ç½®åˆå§‹ã€æœ€å°ã€æœ€å¤§è¿æ¥æ•°ï¼Œè¶…æ—¶æ—¶é—´ä»¥åŠè¿æ¥å›æ”¶æœºåˆ¶ï¼Œå¦åˆ™ä¼šè€—å°½æ•°æ®åº“è¿æ¥èµ„æºï¼Œé€ æˆçº¿ä¸Šäº‹æ•…ã€‚5.ã€å»ºè®®ã€‘å¯¹äºlogæˆ–historyç±»å‹çš„è¡¨ï¼Œéšæ—¶é—´å¢é•¿å®¹æ˜“è¶Šæ¥è¶Šå¤§ï¼Œå› æ­¤ä¸Šçº¿å‰RDæˆ–è€…DBAå¿…é¡»å»ºç«‹è¡¨æ•°æ®æ¸…ç†æˆ–å½’æ¡£æ–¹æ¡ˆã€‚6.ã€å»ºè®®ã€‘ åœ¨åº”ç”¨ç¨‹åºè®¾è®¡é˜¶æ®µï¼ŒRDå¿…é¡»è€ƒè™‘å¹¶è§„é¿æ•°æ®åº“ä¸­ä¸»ä»å»¶è¿Ÿå¯¹äºä¸šåŠ¡çš„å½±å“ã€‚å°½é‡é¿å…ä»åº“çŸ­æ—¶å»¶è¿Ÿï¼ˆ20ç§’ä»¥å†…ï¼‰å¯¹ä¸šåŠ¡é€ æˆå½±å“ï¼Œå»ºè®®å¼ºåˆ¶ä¸€è‡´æ€§çš„è¯»å¼€å¯äº‹åŠ¡èµ°ä¸»åº“ï¼Œæˆ–æ›´æ–°åè¿‡ä¸€æ®µæ—¶é—´å†å»è¯»ä»åº“ã€‚7.ã€å»ºè®®ã€‘å¤šä¸ªå¹¶å‘ä¸šåŠ¡é€»è¾‘è®¿é—®åŒä¸€å—æ•°æ®ï¼ˆinnodbè¡¨ï¼‰æ—¶ï¼Œä¼šåœ¨æ•°æ®åº“ç«¯äº§ç”Ÿè¡Œé”ç”šè‡³è¡¨é”å¯¼è‡´å¹¶å‘ä¸‹é™ï¼Œå› æ­¤å»ºè®®æ›´æ–°ç±»SQLå°½é‡åŸºäºä¸»é”®å»æ›´æ–°ã€‚8.ã€å»ºè®®ã€‘ä¸šåŠ¡é€»è¾‘ä¹‹é—´åŠ é”é¡ºåºå°½é‡ä¿æŒä¸€è‡´ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»é”ã€‚9.ã€å»ºè®®ã€‘å¯¹äºå•è¡¨è¯»å†™æ¯”å¤§äº10:1çš„æ•°æ®è¡Œæˆ–å•ä¸ªåˆ—ï¼Œå¯ä»¥å°†çƒ­ç‚¹æ•°æ®æ”¾åœ¨ç¼“å­˜é‡Œï¼ˆå¦‚mecacheæˆ–redisï¼‰ï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦ï¼Œé™ä½MySQLå‹åŠ›ã€‚ SQLç¼–å†™å»ºè®®DMLè¯­å¥1.ã€å¼ºåˆ¶ã€‘SELECTè¯­å¥å¿…é¡»æŒ‡å®šå…·ä½“å­—æ®µåç§°ï¼Œç¦æ­¢å†™æˆâ€œ*â€å› ä¸ºselect ä¼šå°†ä¸è¯¥è¯»çš„æ•°æ®ä¹Ÿä»MySQLé‡Œè¯»å‡ºæ¥ï¼Œé€ æˆç½‘å¡å‹åŠ›ã€‚ä¸”è¡¨å­—æ®µä¸€æ—¦æ›´æ–°ï¼Œä½†modelå±‚æ²¡æœ‰æ¥å¾—åŠæ›´æ–°çš„è¯ï¼Œç³»ç»Ÿä¼šæŠ¥é”™ã€‚*2.ã€å¼ºåˆ¶ã€‘insertè¯­å¥æŒ‡å®šå…·ä½“å­—æ®µåç§°ï¼Œä¸è¦å†™æˆinsert into t1 values(â€¦)ï¼Œé“ç†åŒä¸Šã€‚3.ã€å»ºè®®ã€‘insert intoâ€¦values(XX),(XX),(XX).. è¿™é‡ŒXXçš„å€¼ä¸è¦è¶…è¿‡5000ä¸ªã€‚å€¼è¿‡å¤šè™½ç„¶ä¸Šçº¿å¾ˆå¾ˆå¿«ï¼Œä½†ä¼šå¼•èµ·ä¸»ä»åŒæ­¥å»¶è¿Ÿã€‚ æ³¨æ„:Oracleæ²¡æœ‰è¿™ç§è¯­æ³• 4.ã€å»ºè®®ã€‘èƒ½ä¸æ’åºå°±ä¸æ’åºã€‚å‡å°‘ä½¿ç”¨order byï¼Œå’Œä¸šåŠ¡æ²Ÿé€šèƒ½ä¸æ’åºå°±ä¸æ’åºï¼Œæˆ–å°†æ’åºæ”¾åˆ°ç¨‹åºç«¯å»åšã€‚Order byã€group byã€distinctè¿™äº›è¯­å¥è¾ƒä¸ºè€—è´¹CPUï¼Œæ•°æ®åº“çš„CPUèµ„æºæ˜¯æå…¶å®è´µçš„ã€‚æ³¨æ„Union ä¸ Union allçš„å´åˆ«,å‰è€…éœ€è¦æ’åº,åè€…ä¸éœ€è¦5.ã€å»ºè®®ã€‘inå€¼åˆ—è¡¨é™åˆ¶åœ¨500ä»¥å†…ã€‚ä¾‹å¦‚selectâ€¦ where userid in(â€¦.500ä¸ªä»¥å†…â€¦)ï¼Œè¿™ä¹ˆåšæ˜¯ä¸ºäº†å‡å°‘åº•å±‚æ‰«æï¼Œå‡è½»æ•°æ®åº“å‹åŠ›ä»è€ŒåŠ é€ŸæŸ¥è¯¢ã€‚6.ã€å»ºè®®ã€‘äº‹åŠ¡é‡Œæ‰¹é‡æ›´æ–°æ•°æ®éœ€è¦æ§åˆ¶æ•°é‡ï¼Œè¿›è¡Œå¿…è¦çš„sleepï¼Œåšåˆ°å°‘é‡å¤šæ¬¡ã€‚7.ã€å¼ºåˆ¶ã€‘äº‹åŠ¡æ¶‰åŠçš„è¡¨å¿…é¡»å…¨éƒ¨æ˜¯innodbè¡¨ã€‚å¦åˆ™ä¸€æ—¦å¤±è´¥ä¸ä¼šå…¨éƒ¨å›æ»šï¼Œä¸”æ˜“é€ æˆä¸»ä»åº“åŒæ­¥ä¸­æ–­ã€‚8.ã€å¼ºåˆ¶ã€‘å†™å…¥å’Œäº‹åŠ¡å‘å¾€ä¸»åº“ï¼Œå®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åªè¯»SQLå‘å¾€ä»åº“ã€‚9.ã€å¼ºåˆ¶ã€‘é™¤é™æ€è¡¨æˆ–å°è¡¨ï¼ˆ100è¡Œä»¥å†…ï¼‰ï¼ŒDMLè¯­å¥å¿…é¡»æœ‰whereæ¡ä»¶ï¼Œä¸”ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾ã€‚10.ã€å»ºè®®ã€‘ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨hintï¼Œå¦‚sql_no_cacheï¼Œforce indexï¼Œignore keyï¼Œstraight joinç­‰ã€‚å› ä¸ºhintæ˜¯ç”¨æ¥å¼ºåˆ¶SQLæŒ‰ç…§æŸä¸ªæ‰§è¡Œè®¡åˆ’æ¥æ‰§è¡Œï¼Œä½†éšç€æ•°æ®é‡å˜åŒ–æˆ‘ä»¬æ— æ³•ä¿è¯è‡ªå·±å½“åˆçš„é¢„åˆ¤æ˜¯æ­£ç¡®çš„ï¼Œå› æ­¤æˆ‘ä»¬è¦ç›¸ä¿¡MySQLä¼˜åŒ–å™¨ï¼11.ã€å¼ºåˆ¶ã€‘whereæ¡ä»¶é‡Œç­‰å·å·¦å³å­—æ®µç±»å‹å¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™æ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚ é¿å…éšå£«è½¬æ¢é€ æˆæ— æ³•ä½¿ç”¨ç´¢å¼• 12.ã€å»ºè®®ã€‘SELECT|UPDATE|DELETE|REPLACEè¦æœ‰WHEREå­å¥ï¼Œä¸”WHEREå­å¥çš„æ¡ä»¶å¿…éœ€ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾ã€‚13.ã€å¼ºåˆ¶ã€‘ç”Ÿäº§æ•°æ®åº“ä¸­å¼ºçƒˆä¸æ¨èå¤§è¡¨ä¸Šå‘ç”Ÿå…¨è¡¨æ‰«æï¼Œä½†å¯¹äº100è¡Œä»¥ä¸‹çš„é™æ€è¡¨å¯ä»¥å…¨è¡¨æ‰«æã€‚æŸ¥è¯¢æ•°æ®é‡ä¸è¦è¶…è¿‡è¡¨è¡Œæ•°çš„25%ï¼Œå¦åˆ™ä¸ä¼šåˆ©ç”¨ç´¢å¼•ã€‚14.ã€å¼ºåˆ¶ã€‘WHERE å­å¥ä¸­ç¦æ­¢åªä½¿ç”¨å…¨æ¨¡ç³Šçš„LIKEæ¡ä»¶è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¿…é¡»æœ‰å…¶ä»–ç­‰å€¼æˆ–èŒƒå›´æŸ¥è¯¢æ¡ä»¶ï¼Œå¦åˆ™æ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚15.ã€å»ºè®®ã€‘ç´¢å¼•åˆ—ä¸è¦ä½¿ç”¨å‡½æ•°æˆ–è¡¨è¾¾å¼ï¼Œå¦åˆ™æ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚å¦‚where length(name)=â€™Adminâ€™æˆ–where user_id+2=10023ã€‚16.ã€å»ºè®®ã€‘å‡å°‘ä½¿ç”¨orè¯­å¥ï¼Œå¯å°†orè¯­å¥ä¼˜åŒ–ä¸ºunionï¼Œç„¶ååœ¨å„ä¸ªwhereæ¡ä»¶ä¸Šå»ºç«‹ç´¢å¼•ã€‚å¦‚where a=1 or b=2ä¼˜åŒ–ä¸ºwhere a=1â€¦ union â€¦where b=2, key(a),key(b)17.ã€å»ºè®®ã€‘åˆ†é¡µæŸ¥è¯¢ï¼Œå½“limitèµ·ç‚¹è¾ƒé«˜æ—¶ï¼Œå¯å…ˆç”¨è¿‡æ»¤æ¡ä»¶è¿›è¡Œè¿‡æ»¤ã€‚å¦‚select a,b,c from t1 limit 10000,20;ä¼˜åŒ–ä¸º: Select a,b,c from t1 where id&gt;10000 limit 20; å¤šè¡¨è¿æ¥1.ã€å¼ºåˆ¶ã€‘ç¦æ­¢è·¨dbçš„joinè¯­å¥ã€‚å› ä¸ºè¿™æ ·å¯ä»¥å‡å°‘æ¨¡å—é—´è€¦åˆï¼Œä¸ºæ•°æ®åº“æ‹†åˆ†å¥ å®šåšå®åŸºç¡€ã€‚2.ã€å¼ºåˆ¶ã€‘ç¦æ­¢åœ¨ä¸šåŠ¡çš„æ›´æ–°ç±»SQLè¯­å¥ä¸­ä½¿ç”¨joinï¼Œæ¯”å¦‚update t1 join t2â€¦3.ã€å»ºè®®ã€‘ä¸å»ºè®®ä½¿ç”¨å­æŸ¥è¯¢ï¼Œå»ºè®®å°†å­æŸ¥è¯¢SQLæ‹†å¼€ç»“åˆç¨‹åºå¤šæ¬¡æŸ¥è¯¢ï¼Œæˆ–ä½¿ç”¨joinæ¥ä»£æ›¿å­æŸ¥è¯¢ã€‚4.ã€å»ºè®®ã€‘çº¿ä¸Šç¯å¢ƒï¼Œå¤šè¡¨joinä¸è¦è¶…è¿‡3ä¸ªè¡¨ã€‚5.ã€å»ºè®®ã€‘å¤šè¡¨è¿æ¥æŸ¥è¯¢æ¨èä½¿ç”¨åˆ«åï¼Œä¸”SELECTåˆ—è¡¨ä¸­è¦ç”¨åˆ«åå¼•ç”¨å­—æ®µï¼Œæ•°æ®åº“.è¡¨æ ¼å¼ï¼Œå¦‚select a from db1.table1 alias1 where â€¦6.ã€å»ºè®®ã€‘åœ¨å¤šè¡¨joinä¸­ï¼Œå°½é‡é€‰å–ç»“æœé›†è¾ƒå°çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œæ¥joinå…¶ä»–è¡¨ã€‚ äº‹åŠ¡1.ã€å»ºè®®ã€‘äº‹åŠ¡é‡ŒåŒ…å«SQLä¸è¶…è¿‡5ä¸ªï¼ˆæ”¯ä»˜ä¸šåŠ¡é™¤å¤–ï¼‰å› ä¸ºè¿‡é•¿çš„äº‹åŠ¡ä¼šå¯¼è‡´é”æ•°æ®è¾ƒä¹…ï¼ŒMySQLå†…éƒ¨ç¼“å­˜ã€è¿æ¥æ¶ˆè€—è¿‡å¤šç­‰é›ªå´©é—®é¢˜ã€‚2.ã€å»ºè®®ã€‘äº‹åŠ¡é‡Œæ›´æ–°è¯­å¥å°½é‡åŸºäºä¸»é”®æˆ–unique keyï¼Œå¦‚update â€¦ where id=XX;3.ã€å»ºè®®ã€‘å°½é‡æŠŠä¸€äº›å…¸å‹å¤–éƒ¨è°ƒç”¨ç§»å‡ºäº‹åŠ¡ï¼Œå¦‚è°ƒç”¨webserviceï¼Œè®¿é—®æ–‡ä»¶å­˜å‚¨ç­‰ï¼Œä»è€Œé¿å…äº‹åŠ¡è¿‡é•¿ã€‚4.ã€å»ºè®®ã€‘å¯¹äºMySQLä¸»ä»å»¶è¿Ÿä¸¥æ ¼æ•æ„Ÿçš„selectè¯­å¥ï¼Œè¯·å¼€å¯äº‹åŠ¡å¼ºåˆ¶è®¿é—®ä¸»åº“ã€‚ çº¿ä¸Šç¦æ­¢ä½¿ç”¨çš„SQLè¯­å¥1.ã€é«˜å±ã€‘ç¦ç”¨update|delete t1 â€¦ where a=XX limit XX;è¿™ç§å¸¦limitçš„æ›´æ–°è¯­å¥ã€‚å› ä¸ºä¼šå¯¼è‡´ä¸»ä»ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ•°æ®é”™ä¹±ã€‚å»ºè®®åŠ ä¸Šorder by PK2.ã€é«˜å±ã€‘ç¦æ­¢ä½¿ç”¨å…³è”å­æŸ¥è¯¢ï¼Œå¦‚update t1 set â€¦ where name in(select name from user whereâ€¦);æ•ˆç‡æå…¶ä½ä¸‹ã€‚3.ã€å¼ºåˆ¶ã€‘ç¦ç”¨procedureã€functionã€triggerã€viewsã€eventã€å¤–é”®çº¦æŸã€‚å› ä¸ºä»–ä»¬æ¶ˆè€—æ•°æ®åº“èµ„æºï¼Œé™ä½æ•°æ®åº“é›†ç¾¤å¯æ‰©å±•æ€§ã€‚æ¨èéƒ½åœ¨ç¨‹åºç«¯å®ç°ã€‚4.ã€å¼ºåˆ¶ã€‘ç¦ç”¨insert into â€¦on duplicate key updateâ€¦ åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä¼šé€ æˆä¸»ä»ä¸ä¸€è‡´ã€‚5.ã€å¼ºåˆ¶ã€‘ç¦æ­¢å…³è”è¡¨æ›´æ–°è¯­å¥ï¼Œå¦‚update t1,t2 where t1.id=t2.idâ€¦","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"æ•°æ®åˆ†å¸ƒä¸å‡åŒ€èµ°HASH JOINå¯¼è‡´çš„æ€§èƒ½é—®é¢˜","slug":"æ•°æ®åˆ†å¸ƒä¸å‡åŒ€èµ°HASH-JOINå¯¼è‡´çš„æ€§èƒ½é—®é¢˜","date":"2017-08-09T14:00:00.000Z","updated":"2017-08-09T07:35:57.000Z","comments":true,"path":"2017/08/09/æ•°æ®åˆ†å¸ƒä¸å‡åŒ€èµ°HASH-JOINå¯¼è‡´çš„æ€§èƒ½é—®é¢˜/","link":"","permalink":"http://fuxkdb.com/2017/08/09/%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E4%B8%8D%E5%9D%87%E5%8C%80%E8%B5%B0HASH-JOIN%E5%AF%BC%E8%87%B4%E7%9A%84%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98/","excerpt":"è¿™ä¸ªæ¡ˆä¾‹æ˜¯JAVAå¼€å‘è¯´ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹è·‘çš„å¾ˆæ…¢ï¼Œä¹‹åæˆ‘è·‘è¿™ä¸ªè¿‡ç¨‹ï¼Œç„¶åé€šè¿‡è„šæœ¬æŠ“å‡ºäº†æ…¢çš„SQLè¡¨å¤§å°123tb_user_channel --1Wtb_channel_info --1Wbase_data_login_info 19W å°±æ˜¯è¿™æ¡SQLï¼Œè·‘å®Œè¦7åˆ†é’Ÿã€‚base_data_login_infoæœ¬æ¥æ˜¯@db_linkï¼Œä½†æ˜¯æˆ‘åœ¨æœ¬åœ°å»ºäº†ä¸€ä¸ªåŒæ ·çš„è¡¨å‘ç°è¿˜æ˜¯7åˆ†é’Ÿå·¦å³ï¼Œæ‰€ä»¥æ’é™¤äº†å¯èƒ½æ˜¯ç”±äºdb_linké€ æˆé—®é¢˜çš„å¯èƒ½æ€§123456select count(distinct a.user_name),count(distinct a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform çœ‹ä¸€ä¸‹è¿™ä¸ªsqlè¿”å›å¤šå°‘è¡Œï¼Œç»“æœç§’æ€ï¼Œç¬é—´å°±å‡ºç»“æœäº†123456select count(*) from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform45122è¡Œä¹‹åå•ç‹¬è·‘123456select count(distinct a.user_name),count( a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platformæˆ–123456select count( a.user_name),count(distinct a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platforméƒ½æ˜¯ç§’æ€å•ç‹¬count distinct user_name æˆ– invest_id éƒ½å¾ˆå¿« ï¼Œä¸€èµ·count distinctå°±å¾ˆæ…¢äº†é‚£ä¹ˆè¿™æ—¶å€™å…¶å®å·²ç»å¯ä»¥é€šè¿‡æ”¹å†™SQLæç¤ºæ€§èƒ½äº†ï¼Œæ”¹å†™å¦‚ä¸‹","text":"è¿™ä¸ªæ¡ˆä¾‹æ˜¯JAVAå¼€å‘è¯´ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹è·‘çš„å¾ˆæ…¢ï¼Œä¹‹åæˆ‘è·‘è¿™ä¸ªè¿‡ç¨‹ï¼Œç„¶åé€šè¿‡è„šæœ¬æŠ“å‡ºäº†æ…¢çš„SQLè¡¨å¤§å°123tb_user_channel --1Wtb_channel_info --1Wbase_data_login_info 19W å°±æ˜¯è¿™æ¡SQLï¼Œè·‘å®Œè¦7åˆ†é’Ÿã€‚base_data_login_infoæœ¬æ¥æ˜¯@db_linkï¼Œä½†æ˜¯æˆ‘åœ¨æœ¬åœ°å»ºäº†ä¸€ä¸ªåŒæ ·çš„è¡¨å‘ç°è¿˜æ˜¯7åˆ†é’Ÿå·¦å³ï¼Œæ‰€ä»¥æ’é™¤äº†å¯èƒ½æ˜¯ç”±äºdb_linké€ æˆé—®é¢˜çš„å¯èƒ½æ€§123456select count(distinct a.user_name),count(distinct a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform çœ‹ä¸€ä¸‹è¿™ä¸ªsqlè¿”å›å¤šå°‘è¡Œï¼Œç»“æœç§’æ€ï¼Œç¬é—´å°±å‡ºç»“æœäº†123456select count(*) from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform45122è¡Œä¹‹åå•ç‹¬è·‘123456select count(distinct a.user_name),count( a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platformæˆ–123456select count( a.user_name),count(distinct a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platforméƒ½æ˜¯ç§’æ€å•ç‹¬count distinct user_name æˆ– invest_id éƒ½å¾ˆå¿« ï¼Œä¸€èµ·count distinctå°±å¾ˆæ…¢äº†é‚£ä¹ˆè¿™æ—¶å€™å…¶å®å·²ç»å¯ä»¥é€šè¿‡æ”¹å†™SQLæç¤ºæ€§èƒ½äº†ï¼Œæ”¹å†™å¦‚ä¸‹1234567with t1 as (select a.user_name, a.invest_id from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform)æŸ¥çœ‹æ”¹å†™åçš„æ‰§è¡Œè®¡åˆ’12345678910111213141516171819202122232425262728293031323334353637383940select (select count(distinct user_name) from t1),(select count(distinct invest_id) from t1) from dual;Plan hash value: 3790966246 -------------------------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes |TempSpc| Cost (%CPU)| Time | Inst |IN-OUT|-------------------------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 1 | | | 746 (1)| 00:00:09 | | || 1 | SORT AGGREGATE | | 1 | 27 | | | | | || 2 | VIEW | VM_NWVW_2 | 40660 | 1072K| | 1589 (1)| 00:00:20 | | || 3 | SORT GROUP BY | | 40660 | 1072K| 6752K| 1589 (1)| 00:00:20 | | || 4 | VIEW | | 190K| 5021K| | 878 (1)| 00:00:11 | | || 5 | TABLE ACCESS FULL | SYS_TEMP_0FD9D671E_EB8EA | 190K| 9M| | 878 (1)| 00:00:11 | | || 6 | SORT AGGREGATE | | 1 | 27 | | | | | || 7 | VIEW | VM_NWVW_3 | 41456 | 1093K| | 1593 (1)| 00:00:20 | | || 8 | SORT GROUP BY | | 41456 | 1093K| 6752K| 1593 (1)| 00:00:20 | | || 9 | VIEW | | 190K| 5021K| | 878 (1)| 00:00:11 | | || 10 | TABLE ACCESS FULL | SYS_TEMP_0FD9D671E_EB8EA | 190K| 9M| | 878 (1)| 00:00:11 | | || 11 | TEMP TABLE TRANSFORMATION | | | | | | | | || 12 | LOAD AS SELECT | SYS_TEMP_0FD9D671E_EB8EA | | | | | | | ||* 13 | HASH JOIN RIGHT SEMI | | 190K| 22M| | 744 (1)| 00:00:09 | | || 14 | VIEW | VW_NSO_1 | 11535 | 304K| | 258 (1)| 00:00:04 | | ||* 15 | HASH JOIN | | 11535 | 360K| | 258 (1)| 00:00:04 | | ||* 16 | TABLE ACCESS FULL | TB_USER_CHANNEL | 11535 | 157K| | 19 (0)| 00:00:01 | | || 17 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 11767 | 206K| | 238 (0)| 00:00:03 | | || 18 | REMOTE | BASE_DATA_LOGIN_INFO | 190K| 17M| | 486 (1)| 00:00:06 | AGENT | R-&gt;S || 19 | FAST DUAL | | 1 | | | 2 (0)| 00:00:01 | | |------------------------------------------------------------------------------------------------------------------------------- Predicate Information (identified by operation id):--------------------------------------------------- 13 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_RLAT&quot;) 15 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;B&quot;.&quot;CHANNEL_ID&quot;) 16 - filter(&quot;A&quot;.&quot;USER_ID&quot;=5002) Remote SQL Information (identified by operation id):---------------------------------------------------- 18 - SELECT &quot;USER_NAME&quot;,&quot;INVEST_ID&quot;,&quot;STR_DAY&quot;,&quot;CHANNEL_ID&quot;,&quot;PLATFORM&quot; FROM &quot;BASE_DATA_LOGIN_INFO&quot; &quot;A&quot; WHERE &quot;STR_DAY&quot;&lt;=&#x27;20160304&#x27; AND &quot;STR_DAY&quot;&gt;=&#x27;20160301&#x27; AND &quot;PLATFORM&quot; IS NOT NULL (accessing &#x27;AGENT&#x27; )ä¸ºäº†æ¢ç©¶æ€§èƒ½ç“¶é¢ˆæˆ‘ä»¬ç»§ç»­çœ‹æ…¢çš„æ‰§è¡Œè®¡åˆ’12345678910111213141516171819202122232425262728293031323334select count(distinct a.user_name),count(distinct a.invest_id) from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform Plan hash value: 2367445948 -------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | Inst |IN-OUT|-------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 1 | 130 | 754 (2)| 00:00:10 | | || 1 | SORT GROUP BY | | 1 | 130 | | | | ||* 2 | HASH JOIN | | 4067K| 504M| 754 (2)| 00:00:10 | | ||* 3 | HASH JOIN | | 11535 | 360K| 258 (1)| 00:00:04 | | ||* 4 | TABLE ACCESS FULL| TB_USER_CHANNEL | 11535 | 157K| 19 (0)| 00:00:01 | | || 5 | TABLE ACCESS FULL| TB_CHANNEL_INFO | 11767 | 206K| 238 (0)| 00:00:03 | | || 6 | REMOTE | BASE_DATA_LOGIN_INFO | 190K| 17M| 486 (1)| 00:00:06 | AGENT | R-&gt;S |------------------------------------------------------------------------------------------------------------- Predicate Information (identified by operation id):--------------------------------------------------- 2 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_RLAT&quot;) 3 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;B&quot;.&quot;CHANNEL_ID&quot;) 4 - filter(&quot;A&quot;.&quot;USER_ID&quot;=5002) Remote SQL Information (identified by operation id):---------------------------------------------------- 6 - SELECT &quot;USER_NAME&quot;,&quot;INVEST_ID&quot;,&quot;STR_DAY&quot;,&quot;CHANNEL_ID&quot;,&quot;PLATFORM&quot; FROM &quot;BASE_DATA_LOGIN_INFO&quot; &quot;A&quot; WHERE &quot;STR_DAY&quot;&lt;=&#x27;20160304&#x27; AND &quot;STR_DAY&quot;&gt;=&#x27;20160301&#x27; AND &quot;PLATFORM&quot; IS NOT NULL (accessing &#x27;AGENT&#x27; )å¿«çš„æ‰§è¡Œè®¡åˆ’123456789101112131415161718192021222324252627282930313233343536explain plan forselect count( a.user_name),count(distinct a.invest_id) from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platformPlan hash value: 4282421321 ------------------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes |TempSpc| Cost (%CPU)| Time | Inst |IN-OUT|------------------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 1 | 40 | | 2982 (1)| 00:00:36 | | || 1 | SORT AGGREGATE | | 1 | 40 | | | | | || 2 | VIEW | VW_DAG_0 | 41456 | 1619K| | 2982 (1)| 00:00:36 | | || 3 | HASH GROUP BY | | 41456 | 4250K| 20M| 2982 (1)| 00:00:36 | | ||* 4 | HASH JOIN RIGHT SEMI| | 190K| 19M| | 744 (1)| 00:00:09 | | || 5 | VIEW | VW_NSO_1 | 11535 | 80745 | | 258 (1)| 00:00:04 | | ||* 6 | HASH JOIN | | 11535 | 360K| | 258 (1)| 00:00:04 | | ||* 7 | TABLE ACCESS FULL| TB_USER_CHANNEL | 11535 | 157K| | 19 (0)| 00:00:01 | | || 8 | TABLE ACCESS FULL| TB_CHANNEL_INFO | 11767 | 206K| | 238 (0)| 00:00:03 | | || 9 | REMOTE | BASE_DATA_LOGIN_INFO | 190K| 17M| | 486 (1)| 00:00:06 | AGENT | R-&gt;S |------------------------------------------------------------------------------------------------------------------------ Predicate Information (identified by operation id):--------------------------------------------------- 4 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_RLAT&quot;) 6 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;B&quot;.&quot;CHANNEL_ID&quot;) 7 - filter(&quot;A&quot;.&quot;USER_ID&quot;=5002) Remote SQL Information (identified by operation id):---------------------------------------------------- 9 - SELECT &quot;USER_NAME&quot;,&quot;INVEST_ID&quot;,&quot;STR_DAY&quot;,&quot;CHANNEL_ID&quot;,&quot;PLATFORM&quot; FROM &quot;BASE_DATA_LOGIN_INFO&quot; &quot;A&quot; WHERE &quot;STR_DAY&quot;&lt;=&#x27;20160304&#x27; AND &quot;STR_DAY&quot;&gt;=&#x27;20160301&#x27; AND &quot;PLATFORM&quot; IS NOT NULL (accessing &#x27;AGENT&#x27; )æ³¨æ„åˆ°å¿«çš„æ‰§è¡Œè®¡åˆ’ç”¨çš„æ˜¯HASH JOIN SEMI è€Œ æ…¢çš„æ‰§è¡Œè®¡åˆ’ç”¨çš„æ˜¯ HASH JOINæˆ‘åˆè·‘æ…¢çš„SQLï¼Œæƒ³æŸ¥çœ‹ç­‰å¾…æ—¶é—´åˆ†æé—®é¢˜ï¼Œç»“æœç­‰å¾…äº‹ä»¶å´æ˜¯ SQLNet message to clientã€‚ã€‚ã€‚åšä¸ª100461234567891011121314151617181920212223242526272829303132333435363738alter session set events â€˜10046 trace name context forever, level 8â€™;alter session set tracefile_identifier=&#x27;fan&#x27;;alter session set max_dump_file_size=unlimited;alter session set events &#x27;10046 trace name context forever, level 8&#x27;;SQL&gt;.............alter session set events &#x27;10046 trace name context off&#x27;;tkprof channel_ora_4917_fan.trc hehe sys=no waits=yes selectcount(distinct a.user_name),count(distinct a.invest_id) from base_data_login_info a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platformcall count cpu elapsed disk query current rows------- ------ -------- ---------- ---------- ---------- ---------- ----------Parse 1 0.00 0.00 0 0 0 0Execute 1 0.00 0.00 0 0 0 0Fetch 2 1092.09 1236.55 0 3643 0 1------- ------ -------- ---------- ---------- ---------- ---------- ----------total 4 1092.09 1236.56 0 3643 0 1Misses in library cache during parse: 0Optimizer mode: ALL_ROWSParsing user id: 84 Number of plan statistics captured: 1Rows (1st) Rows (avg) Rows (max) Row Source Operation---------- ---------- ---------- --------------------------------------------------- 1 1 1 SORT GROUP BY (cr=3643 pr=0 pw=0 time=1236559678 us) 410996039 410996039 410996039 HASH JOIN (cr=3643 pr=0 pw=0 time=406365130 us cost=1006 size=66968010 card=458685) 11535 11535 11535 HASH JOIN (cr=945 pr=0 pw=0 time=199182 us cost=258 size=369120 card=11535) 11535 11535 11535 TABLE ACCESS FULL TB_USER_CHANNEL (cr=67 pr=0 pw=0 time=21452 us cost=19 size=161490 card=11535) 11771 11771 11771 TABLE ACCESS FULL TB_CHANNEL_INFO (cr=878 pr=0 pw=0 time=30291 us cost=238 size=211806 card=11767) 45122 45122 45122 TABLE ACCESS FULL BASE_DATA_LOGIN_INFO (cr=2698 pr=0 pw=0 time=218144 us cost=747 size=2447922 card=21473)Elapsed times include waiting on following events: Event waited on Times Max. Wait Total Waited ---------------------------------------- Waited ---------- ------------ SQL*Net message to client 2 0.00 0.00 SQL*Net message from client 2 50.71 50.71 æ³¨æ„æ‰§è¡Œè®¡åˆ’ç¬¬äºŒè¡Œ å˜æˆäº†40äº¿ï¼å…³è”åˆ—æ•°æ®åˆ†å¸ƒ19W è¡¨è¿æ¥åˆ—123456789101112131415161718192021222324SQL&gt; select channel_id,count(*) from base_data_login_info group by channel_id order by 2;CHANNEL_ID COUNT(*)-------------------------------------------------- ----------011a1 2003a1 3021a1 3006a1 12024h2 16013a1 19007a1 24012a1 25005a1 27EPT01 36028h2 109008a1 139029a1 841009a1 921014a1 1583000a1 1975a0001 2724004a1 5482001a1 16329026h2 16016220 rows selected.iné‡Œçš„1234567891011121314151617181920212223242526select channel_rlat,count(*) from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002 group by channel_rlat order by 2 desc channel_rlat count(*)026h2 10984024h2 7002h2 6023a2 2007s001022001 1007s001022002 1007s001024007 1007s001024009 1007s001022009 1001s001006 1001s001008 1001s001001001 1001s001001003 1001s001001007 1001s001001014 1007s001018003 1007s001018007 1007s001019005 1007s001019008 1001s001002011 1007s001011003 1007s001034 1007s001023005 1007s001011008 1 HASH JOIN åªé€‚åˆæ•°æ®åˆ†å¸ƒå‡åŒ€çš„åˆ—åšå…³è”ï¼Œè€Œè¿™ä¸ªå…³è”åˆ—æ•°æ®åˆ†å¸ƒæåº¦ä¸å‡è¡¡ï¼Œç›¸å½“äºä¸€ä¸ªå°ç¬›å¡å°”åŠï¼Œåœ¨bucketé‡Œæ‰¾æ­»äº†* ç»§ç»­æ·±å…¥ï¼Œä¸ºä»€ä¹ˆæœ¬æ¥æ˜¯åŠè¿æ¥ï¼ŒCBOç”¨äº†HASH JOINï¼Ÿå•ç‹¬è·‘è¿™ä¸ªæ˜¯å¾ˆå¿«çš„123456select a.user_name,a.invest_id from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform è¿™æ ·å°±æ…¢äº†ï¼Œå› ä¸ºè§†å›¾åˆå¹¶äº†1234567select count(distinct a.user_name),count(distinct a.invest_id) from (select a.user_name,a.invest_id from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform ) aCBOæŠŠå®ƒæ”¹å†™æˆäº†12345select count(distinct a.user_name),count(distinct a.invest_id) from base_data_login_info@agent a,(select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) b where a.channel_id=b.channel_rlat and a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27;åŠè¿æ¥æœ¬èº«å°±å¯ä»¥æ”¹å†™æˆinner join,ä½†æ˜¯iné‡Œçš„è¡¨è¦distinct,ä¸¾ä¸ªä¾‹å­123456select * from dept where deptno in (select deptno from emp) DEPTNO DNAME LOC---------- -------------- ------------- 10 ACCOUNTING NEW YORK 20 RESEARCH DALLAS 30 SALES CHICAGOå¯ä»¥æ”¹å†™ä¸º12select d.* from dept d inner join (select distinct deptno from emp ) e on d.deptno=e.deptno å¦åˆ™å¦‚æœä¸distinctç»“æœé›†å°±ä¼šæœ‰é—®é¢˜12345678910111213141516171819SQL&gt; select d.* from dept d inner join (select deptno from emp ) e 2 on d.deptno=e.deptno ; DEPTNO DNAME LOC---------- -------------- ------------- 10 ACCOUNTING NEW YORK 10 ACCOUNTING NEW YORK 10 ACCOUNTING NEW YORK 20 RESEARCH DALLAS 20 RESEARCH DALLAS 20 RESEARCH DALLAS 20 RESEARCH DALLAS 20 RESEARCH DALLAS 30 SALES CHICAGO 30 SALES CHICAGO 30 SALES CHICAGO 30 SALES CHICAGO 30 SALES CHICAGO 30 SALES CHICAGOå·²é€‰æ‹©14è¡Œã€‚ä½†æ˜¯å·§å°±å·§çš„æ˜¯ï¼Œæˆ‘è¿™ä¸ªSQLæ˜¯ count(distinct a.user_name),count(distinct a.invest_id)æ‰€ä»¥CBOæŠŠå®ƒæ”¹å†™æˆäº†inner join,è¿˜ä¸ç”¨æŠŠiné‡Œé¢å…ˆå»é‡ï¼ŒCBOçœŸTMèªæ˜ï¼Œå¯æƒœèªæ˜åè¢«èªæ˜è¯¯ã€‚æˆ‘ä»¬è¿™ä¸ªå…³è”åˆ—æ•°æ®åˆ†å¸ƒæåº¦ä¸å‡åŒ€é‚£æˆ‘ä»¬ä¸æƒ³è®©CBOæ”¹å†™å’‹åŠå‘¢ é‚£ä¹ˆæˆ‘ä»¬ä¸è®©è§†å›¾åˆå¹¶ç”¨ rownum&gt;01234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677select count(distinct a.user_name),count(distinct a.invest_id) from (select a.user_name,a.invest_id from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform and rownum&gt;0) aPlan hash value: 3295380261 -----------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | Inst |IN-OUT|-----------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 1 | 54 | 744 (1)| 00:00:09 | | || 1 | SORT GROUP BY | | 1 | 54 | | | | || 2 | VIEW | | 190K| 9M| 744 (1)| 00:00:09 | | || 3 | COUNT | | | | | | | ||* 4 | FILTER | | | | | | | ||* 5 | HASH JOIN RIGHT SEMI| | 190K| 22M| 744 (1)| 00:00:09 | | || 6 | VIEW | VW_NSO_1 | 11535 | 304K| 258 (1)| 00:00:04 | | ||* 7 | HASH JOIN | | 11535 | 360K| 258 (1)| 00:00:04 | | ||* 8 | TABLE ACCESS FULL| TB_USER_CHANNEL | 11535 | 157K| 19 (0)| 00:00:01 | | || 9 | TABLE ACCESS FULL| TB_CHANNEL_INFO | 11767 | 206K| 238 (0)| 00:00:03 | | || 10 | REMOTE | BASE_DATA_LOGIN_INFO | 190K| 17M| 486 (1)| 00:00:06 | AGENT | R-&gt;S |----------------------------------------------------------------------------------------------------------------- Predicate Information (identified by operation id):--------------------------------------------------- 4 - filter(ROWNUM&gt;0) 5 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_RLAT&quot;) 7 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;B&quot;.&quot;CHANNEL_ID&quot;) 8 - filter(&quot;A&quot;.&quot;USER_ID&quot;=5002) Remote SQL Information (identified by operation id):---------------------------------------------------- 10 - SELECT &quot;USER_NAME&quot;,&quot;INVEST_ID&quot;,&quot;STR_DAY&quot;,&quot;CHANNEL_ID&quot;,&quot;PLATFORM&quot; FROM &quot;BASE_DATA_LOGIN_INFO&quot; &quot;A&quot; WHERE &quot;STR_DAY&quot;&lt;=&#x27;20160304&#x27; AND &quot;STR_DAY&quot;&gt;=&#x27;20160301&#x27; AND &quot;PLATFORM&quot; IS NOT NULL (accessing &#x27;AGENT&#x27; )with t1 as (select /*+ materialize */ a.user_name, a.invest_id from base_data_login_info@agent a where a.str_day &lt;= &#x27;20160304&#x27; and a.str_day &gt;= &#x27;20160301&#x27; and a.channel_id in (select channel_rlat from tb_user_channel a, tb_channel_info b where a.channel_id = b.channel_id and a.user_id = 5002) and a.platform = a.platform)select count(distinct user_name) ,count(distinct invest_id) from t1;Plan hash value: 901326807 -----------------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time | Inst |IN-OUT|-----------------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 1 | 54 | 1621 (1)| 00:00:20 | | || 1 | TEMP TABLE TRANSFORMATION | | | | | | | || 2 | LOAD AS SELECT | SYS_TEMP_0FD9D6720_EB8EA | | | | | | ||* 3 | HASH JOIN RIGHT SEMI | | 190K| 22M| 744 (1)| 00:00:09 | | || 4 | VIEW | VW_NSO_1 | 11535 | 304K| 258 (1)| 00:00:04 | | ||* 5 | HASH JOIN | | 11535 | 360K| 258 (1)| 00:00:04 | | ||* 6 | TABLE ACCESS FULL | TB_USER_CHANNEL | 11535 | 157K| 19 (0)| 00:00:01 | | || 7 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 11767 | 206K| 238 (0)| 00:00:03 | | || 8 | REMOTE | BASE_DATA_LOGIN_INFO | 190K| 17M| 486 (1)| 00:00:06 | AGENT | R-&gt;S || 9 | SORT GROUP BY | | 1 | 54 | | | | || 10 | VIEW | | 190K| 9M| 878 (1)| 00:00:11 | | || 11 | TABLE ACCESS FULL | SYS_TEMP_0FD9D6720_EB8EA | 190K| 9M| 878 (1)| 00:00:11 | | |----------------------------------------------------------------------------------------------------------------------- Predicate Information (identified by operation id):--------------------------------------------------- 3 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_RLAT&quot;) 5 - access(&quot;A&quot;.&quot;CHANNEL_ID&quot;=&quot;B&quot;.&quot;CHANNEL_ID&quot;) 6 - filter(&quot;A&quot;.&quot;USER_ID&quot;=5002) Remote SQL Information (identified by operation id):---------------------------------------------------- 8 - SELECT &quot;USER_NAME&quot;,&quot;INVEST_ID&quot;,&quot;STR_DAY&quot;,&quot;CHANNEL_ID&quot;,&quot;PLATFORM&quot; FROM &quot;BASE_DATA_LOGIN_INFO&quot; &quot;A&quot; WHERE &quot;STR_DAY&quot;&lt;=&#x27;20160304&#x27; AND &quot;STR_DAY&quot;&gt;=&#x27;20160301&#x27; AND &quot;PLATFORM&quot; IS NOT NULL (accessing &#x27;AGENT&#x27; ) å†è§£é‡Šä¸€ä¸‹12345678910111213141516171819202122232425create table emp2 as select * from emp;insert into emp2 select * from emp2;create table emp4 as select * from emp2;SQL&gt; select count(distinct a.job),count(distinct a.ename) from emp2 a where a.deptno in (select deptno from emp4); COUNT(DISTINCTA.JOB) COUNT(DISTINCTA.ENAME)-------------------- ---------------------- 4 11ç­‰ä»· äºSQL&gt; select count(distinct a.job),count(distinct a.ename) from emp2 a,emp4 b where a.deptno=b.deptno;COUNT(DISTINCTA.JOB) COUNT(DISTINCTA.ENAME)-------------------- ---------------------- 4 11CBOæŠŠå®ƒæ”¹å†™æˆäº†è¿™ä¸ª a.deptno=b.deptno hash joinExecution Plan----------------------------------------------------------Plan hash value: 3097773013----------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes | Cost (%CPU)| Time |----------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 1 | 39 | 8 (13)| 00:00:01 || 1 | SORT GROUP BY | | 1 | 39 | | ||* 2 | HASH JOIN | | 242 | 9438 | 8 (13)| 00:00:01 || 3 | TABLE ACCESS FULL| EMP2 | 22 | 572 | 4 (0)| 00:00:01 || 4 | TABLE ACCESS FULL| EMP4 | 22 | 286 | 3 (0)| 00:00:01 |----------------------------------------------------------------------------","categories":[],"tags":[{"name":"Oracle","slug":"Oracle","permalink":"http://fuxkdb.com/tags/Oracle/"},{"name":"SQL Tuning","slug":"SQL-Tuning","permalink":"http://fuxkdb.com/tags/SQL-Tuning/"}]},{"title":"è§†å›¾åˆå¹¶ã€hash joinè¿æ¥åˆ—æ•°æ®åˆ†å¸ƒä¸å‡åŒ€å¼•å‘çš„æƒ¨æ¡ˆ","slug":"è§†å›¾åˆå¹¶ã€hash-joinè¿æ¥åˆ—æ•°æ®åˆ†å¸ƒä¸å‡åŒ€å¼•å‘çš„æƒ¨æ¡ˆ","date":"2017-08-09T14:00:00.000Z","updated":"2017-08-09T07:36:58.000Z","comments":true,"path":"2017/08/09/è§†å›¾åˆå¹¶ã€hash-joinè¿æ¥åˆ—æ•°æ®åˆ†å¸ƒä¸å‡åŒ€å¼•å‘çš„æƒ¨æ¡ˆ/","link":"","permalink":"http://fuxkdb.com/2017/08/09/%E8%A7%86%E5%9B%BE%E5%90%88%E5%B9%B6%E3%80%81hash-join%E8%BF%9E%E6%8E%A5%E5%88%97%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E4%B8%8D%E5%9D%87%E5%8C%80%E5%BC%95%E5%8F%91%E7%9A%84%E6%83%A8%E6%A1%88/","excerpt":"è¡¨å¤§å°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647SQL&gt; select count(*) from agent.TB_AGENT_INFO; COUNT(*)---------- 1751SQL&gt; select count(*) from TB_CHANNEL_INFO ; COUNT(*)---------- 1807SQL&gt; select count(*) from TB_USER_CHANNEL; COUNT(*)---------- 7269SQL&gt; select count(*) from OSS_USER_STATION; COUNT(*)---------- 2149SQL&gt; select count(*) from tb_user_zgy ; COUNT(*)---------- 43SQL&gt; select count(*) from act.tb_user_agent_relat; COUNT(*)---------- 29612SQL&gt; select count(*) from agent.base_data_user_info ; COUNT(*)---------- 30005SQL&gt; select count(*) from agent.base_data_invest_info; COUNT(*)---------- 3530163 æ…¢çš„sql123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108select a.city, a.agent_id, a.username, a.real_name, phone, zgy_name, login_count, user_count, count(distinct b.invest_id) user_invested, sum(b.order_amount / 100) invest_amount from (select a.city, a.agent_id, a.username, a.real_name, -- ä¸šä¸»å§“å a.phone, -- ä¸šä¸»æ‰‹æœºå· d.real_name zgy_name, -- æ‰€å±ä¸“ç®¡å‘˜ count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then c.login_name end) login_count, count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then decode(c.status, 1, c.invest_id, null) end) user_count from (select agent_id, city, username, real_name, phone from agent.TB_AGENT_INFO where agent_id in (SELECT agent_id FROM (SELECT distinct * FROM TB_CHANNEL_INFO t START WITH t.CHANNEL_ID in (select CHANNEL_ID from TB_USER_CHANNEL where USER_ID = 596) CONNECT BY PRIOR t.CHANNEL_ID = t.PARENT_CHANNEL_ID) WHERE agent_id IS NOT NULL)) a left join oss_user_station e on a.agent_id = e.agent_id and e.user_type = 0 left join tb_user_zgy d on e.username = d.username left join act.tb_user_agent_relat c on a.agent_id = c.agent_id group by a.city, a.username, a.real_name, a.phone, d.real_name, a.agent_id) a left join (select invest_id, order_amount, agent_id, str_day from agent.base_data_invest_info where str_day &gt;= &#x27;20150801&#x27; and str_day&lt;=&#x27;20160821&#x27;) b on a.agent_id = b.agent_id group by a.city, a.agent_id, a.username, a.real_name, a.phone, a.zgy_name, a.login_count, a.user_countè¿™ä¸ªæŸ¥è¯¢å¯ä»¥çœ‹æˆä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¸€å †å°è¡¨å…³è”çš„aå’Œå”¯ä¸€çš„ä¸€ä¸ªå¤§è¡¨å†åšå…³è”man----------------------------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes |TempSpc| Cost (%CPU)| Time |----------------------------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 55M| 6616M| | 3934K (1)| 13:06:52 || 1 | HASH GROUP BY | | 55M| 6616M| | 3934K (1)| 13:06:52 || 2 | VIEW | VW_DAG_1 | 55M| 6616M| | 3934K (1)| 13:06:52 || 3 | HASH GROUP BY | | 55M| 6301M| 7681M| 3934K (1)| 13:06:52 || 4 | VIEW | VM_NWVW_0 | 55M| 6301M| | 2456K (1)| 08:11:15 || 5 | SORT GROUP BY | | 55M| 10G| 11G| 2456K (1)| 08:11:15 ||* 6 | HASH JOIN RIGHT OUTER | | 55M| 10G| | 21643 (2)| 00:04:20 || 7 | TABLE ACCESS FULL | TB_USER_AGENT_RELAT | 27937 | 1200K| | 102 (0)| 00:00:02 ||* 8 | HASH JOIN OUTER | | 3374K| 511M| | 21392 (1)| 00:04:17 ||* 9 | HASH JOIN SEMI | | 1712 | 188K| | 2007 (1)| 00:00:25 ||* 10 | HASH JOIN RIGHT OUTER | | 1712 | 173K| | 32 (0)| 00:00:01 || 11 | TABLE ACCESS FULL | TB_USER_ZGY | 43 | 903 | | 3 (0)| 00:00:01 ||* 12 | HASH JOIN RIGHT OUTER | | 1712 | 138K| | 29 (0)| 00:00:01 ||* 13 | TABLE ACCESS FULL | OSS_USER_STATION | 1075 | 25800 | | 6 (0)| 00:00:01 || 14 | TABLE ACCESS FULL | TB_AGENT_INFO | 1712 | 98K| | 23 (0)| 00:00:01 || 15 | VIEW | VW_NSO_1 | 16271 | 143K| | 1975 (1)| 00:00:24 ||* 16 | VIEW | | 16271 | 143K| | 1975 (1)| 00:00:24 || 17 | HASH UNIQUE | | 16271 | 8882K| 10M| 1975 (1)| 00:00:24 ||* 18 | CONNECT BY WITHOUT FILTERING (UNIQUE)| | | | | | ||* 19 | HASH JOIN RIGHT SEMI | | 530 | 146K| | 29 (0)| 00:00:01 ||* 20 | TABLE ACCESS FULL | TB_USER_CHANNEL | 600 | 7800 | | 7 (0)| 00:00:01 || 21 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 1807 | 476K| | 22 (0)| 00:00:01 || 22 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 1807 | 476K| | 22 (0)| 00:00:01 ||* 23 | TABLE ACCESS FULL | BASE_DATA_INVEST_INFO | 3374K| 148M| | 19375 (1)| 00:03:53 |----------------------------------------------------------------------------------------------------------------------------------Predicate Information (identified by operation id):--------------------------------------------------- 6 - access(&quot;AGENT_ID&quot;=&quot;C&quot;.&quot;AGENT_ID&quot;(+)) 8 - access(&quot;AGENT_ID&quot;=&quot;AGENT_ID&quot;(+)) 9 - access(&quot;AGENT_ID&quot;=&quot;AGENT_ID&quot;) 10 - access(&quot;C&quot;.&quot;USERNAME&quot;=&quot;D&quot;.&quot;USERNAME&quot;(+)) 12 - access(&quot;AGENT_ID&quot;=&quot;C&quot;.&quot;AGENT_ID&quot;(+)) 13 - filter(&quot;C&quot;.&quot;USER_TYPE&quot;(+)=0) 16 - filter(&quot;AGENT_ID&quot; IS NOT NULL) 18 - access(&quot;T&quot;.&quot;PARENT_CHANNEL_ID&quot;=PRIOR &quot;T&quot;.&quot;CHANNEL_ID&quot;) 19 - access(&quot;T&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_ID&quot;) 20 - filter(&quot;USER_ID&quot;=596) 23 - filter(&quot;STR_DAY&quot;(+)&gt;=&#x27;20150801&#x27; AND &quot;STR_DAY&quot;(+)&lt;=&#x27;20160821&#x27;)","text":"è¡¨å¤§å°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647SQL&gt; select count(*) from agent.TB_AGENT_INFO; COUNT(*)---------- 1751SQL&gt; select count(*) from TB_CHANNEL_INFO ; COUNT(*)---------- 1807SQL&gt; select count(*) from TB_USER_CHANNEL; COUNT(*)---------- 7269SQL&gt; select count(*) from OSS_USER_STATION; COUNT(*)---------- 2149SQL&gt; select count(*) from tb_user_zgy ; COUNT(*)---------- 43SQL&gt; select count(*) from act.tb_user_agent_relat; COUNT(*)---------- 29612SQL&gt; select count(*) from agent.base_data_user_info ; COUNT(*)---------- 30005SQL&gt; select count(*) from agent.base_data_invest_info; COUNT(*)---------- 3530163 æ…¢çš„sql123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108select a.city, a.agent_id, a.username, a.real_name, phone, zgy_name, login_count, user_count, count(distinct b.invest_id) user_invested, sum(b.order_amount / 100) invest_amount from (select a.city, a.agent_id, a.username, a.real_name, -- ä¸šä¸»å§“å a.phone, -- ä¸šä¸»æ‰‹æœºå· d.real_name zgy_name, -- æ‰€å±ä¸“ç®¡å‘˜ count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then c.login_name end) login_count, count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then decode(c.status, 1, c.invest_id, null) end) user_count from (select agent_id, city, username, real_name, phone from agent.TB_AGENT_INFO where agent_id in (SELECT agent_id FROM (SELECT distinct * FROM TB_CHANNEL_INFO t START WITH t.CHANNEL_ID in (select CHANNEL_ID from TB_USER_CHANNEL where USER_ID = 596) CONNECT BY PRIOR t.CHANNEL_ID = t.PARENT_CHANNEL_ID) WHERE agent_id IS NOT NULL)) a left join oss_user_station e on a.agent_id = e.agent_id and e.user_type = 0 left join tb_user_zgy d on e.username = d.username left join act.tb_user_agent_relat c on a.agent_id = c.agent_id group by a.city, a.username, a.real_name, a.phone, d.real_name, a.agent_id) a left join (select invest_id, order_amount, agent_id, str_day from agent.base_data_invest_info where str_day &gt;= &#x27;20150801&#x27; and str_day&lt;=&#x27;20160821&#x27;) b on a.agent_id = b.agent_id group by a.city, a.agent_id, a.username, a.real_name, a.phone, a.zgy_name, a.login_count, a.user_countè¿™ä¸ªæŸ¥è¯¢å¯ä»¥çœ‹æˆä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¸€å †å°è¡¨å…³è”çš„aå’Œå”¯ä¸€çš„ä¸€ä¸ªå¤§è¡¨å†åšå…³è”man----------------------------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes |TempSpc| Cost (%CPU)| Time |----------------------------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 55M| 6616M| | 3934K (1)| 13:06:52 || 1 | HASH GROUP BY | | 55M| 6616M| | 3934K (1)| 13:06:52 || 2 | VIEW | VW_DAG_1 | 55M| 6616M| | 3934K (1)| 13:06:52 || 3 | HASH GROUP BY | | 55M| 6301M| 7681M| 3934K (1)| 13:06:52 || 4 | VIEW | VM_NWVW_0 | 55M| 6301M| | 2456K (1)| 08:11:15 || 5 | SORT GROUP BY | | 55M| 10G| 11G| 2456K (1)| 08:11:15 ||* 6 | HASH JOIN RIGHT OUTER | | 55M| 10G| | 21643 (2)| 00:04:20 || 7 | TABLE ACCESS FULL | TB_USER_AGENT_RELAT | 27937 | 1200K| | 102 (0)| 00:00:02 ||* 8 | HASH JOIN OUTER | | 3374K| 511M| | 21392 (1)| 00:04:17 ||* 9 | HASH JOIN SEMI | | 1712 | 188K| | 2007 (1)| 00:00:25 ||* 10 | HASH JOIN RIGHT OUTER | | 1712 | 173K| | 32 (0)| 00:00:01 || 11 | TABLE ACCESS FULL | TB_USER_ZGY | 43 | 903 | | 3 (0)| 00:00:01 ||* 12 | HASH JOIN RIGHT OUTER | | 1712 | 138K| | 29 (0)| 00:00:01 ||* 13 | TABLE ACCESS FULL | OSS_USER_STATION | 1075 | 25800 | | 6 (0)| 00:00:01 || 14 | TABLE ACCESS FULL | TB_AGENT_INFO | 1712 | 98K| | 23 (0)| 00:00:01 || 15 | VIEW | VW_NSO_1 | 16271 | 143K| | 1975 (1)| 00:00:24 ||* 16 | VIEW | | 16271 | 143K| | 1975 (1)| 00:00:24 || 17 | HASH UNIQUE | | 16271 | 8882K| 10M| 1975 (1)| 00:00:24 ||* 18 | CONNECT BY WITHOUT FILTERING (UNIQUE)| | | | | | ||* 19 | HASH JOIN RIGHT SEMI | | 530 | 146K| | 29 (0)| 00:00:01 ||* 20 | TABLE ACCESS FULL | TB_USER_CHANNEL | 600 | 7800 | | 7 (0)| 00:00:01 || 21 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 1807 | 476K| | 22 (0)| 00:00:01 || 22 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 1807 | 476K| | 22 (0)| 00:00:01 ||* 23 | TABLE ACCESS FULL | BASE_DATA_INVEST_INFO | 3374K| 148M| | 19375 (1)| 00:03:53 |----------------------------------------------------------------------------------------------------------------------------------Predicate Information (identified by operation id):--------------------------------------------------- 6 - access(&quot;AGENT_ID&quot;=&quot;C&quot;.&quot;AGENT_ID&quot;(+)) 8 - access(&quot;AGENT_ID&quot;=&quot;AGENT_ID&quot;(+)) 9 - access(&quot;AGENT_ID&quot;=&quot;AGENT_ID&quot;) 10 - access(&quot;C&quot;.&quot;USERNAME&quot;=&quot;D&quot;.&quot;USERNAME&quot;(+)) 12 - access(&quot;AGENT_ID&quot;=&quot;C&quot;.&quot;AGENT_ID&quot;(+)) 13 - filter(&quot;C&quot;.&quot;USER_TYPE&quot;(+)=0) 16 - filter(&quot;AGENT_ID&quot; IS NOT NULL) 18 - access(&quot;T&quot;.&quot;PARENT_CHANNEL_ID&quot;=PRIOR &quot;T&quot;.&quot;CHANNEL_ID&quot;) 19 - access(&quot;T&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_ID&quot;) 20 - filter(&quot;USER_ID&quot;=596) 23 - filter(&quot;STR_DAY&quot;(+)&gt;=&#x27;20150801&#x27; AND &quot;STR_DAY&quot;(+)&lt;=&#x27;20160821&#x27;)å°è¯•å•ç‹¬è·‘ a,å¾ˆå¿«12345678910111213141516171819202122232425262728293031323334353637383940(select a.city, a.agent_id, a.username, a.real_name, -- ä¸šä¸»å§“å a.phone, -- ä¸šä¸»æ‰‹æœºå· d.real_name zgy_name, -- æ‰€å±ä¸“ç®¡å‘˜ count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then c.login_name end) login_count, count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then decode(c.status, 1, c.invest_id, null) end) user_count from (select agent_id, city, username, real_name, phone from agent.TB_AGENT_INFO where agent_id in (SELECT agent_id FROM (SELECT distinct * FROM TB_CHANNEL_INFO t START WITH t.CHANNEL_ID in (select CHANNEL_ID from TB_USER_CHANNEL where USER_ID = 596) CONNECT BY PRIOR t.CHANNEL_ID = t.PARENT_CHANNEL_ID) WHERE agent_id IS NOT NULL)) a left join oss_user_station e on a.agent_id = e.agent_id and e.user_type = 0 left join tb_user_zgy d on e.username = d.username left join act.tb_user_agent_relat c on a.agent_id = c.agent_id group by a.city, a.username, a.real_name, a.phone, d.real_name, a.agent_id) aå•ç‹¬è·‘aå¾ˆå¿«ï¼Œå’Œbåˆåœ¨ä¸€èµ·å°±å¾ˆæ…¢ï¼Œé‚£ä¹ˆæ€€ç–‘æ˜¯ç”±äºè§†å›¾åˆå¹¶ï¼Œå¯¼è‡´äº†aå†…éƒ¨çš„è¡¨æå‰å»å’Œbå…³è”ï¼Œå¼•å‘äº†æ€§èƒ½é—®é¢˜ã€‚å°è¯•ç¦æ­¢è§†å›¾åˆå¹¶å¯ä»¥ä½¿ç”¨rownum&gt;0,æˆ–no_merge hint 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110select a.city, a.agent_id, a.username, a.real_name, phone, zgy_name, login_count, user_count, count(distinct b.invest_id) user_invested, sum(b.order_amount / 100) invest_amount from (select * from (select a.city, a.agent_id, a.username, a.real_name, -- ä¸šä¸»å§“å a.phone, -- ä¸šä¸»æ‰‹æœºå· d.real_name zgy_name, -- æ‰€å±ä¸“ç®¡å‘˜ count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then c.login_name end) login_count, count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then decode(c.status, 1, c.invest_id, null) end) user_count from (select agent_id, city, username, real_name, phone from agent.TB_AGENT_INFO where agent_id in (SELECT agent_id FROM (SELECT distinct * FROM TB_CHANNEL_INFO t START WITH t.CHANNEL_ID in (select CHANNEL_ID from TB_USER_CHANNEL where USER_ID = 596) CONNECT BY PRIOR t.CHANNEL_ID = t.PARENT_CHANNEL_ID) WHERE agent_id IS NOT NULL)) a left join oss_user_station e on a.agent_id = e.agent_id and e.user_type = 0 left join tb_user_zgy d on e.username = d.username left join act.tb_user_agent_relat c on a.agent_id = c.agent_id group by a.city, a.username, a.real_name, a.phone, d.real_name, a.agent_id) where rownum&gt;0)a left join (select invest_id, order_amount, agent_id, str_day from agent.base_data_invest_info where str_day &gt;= &#x27;20150801&#x27; and str_day&lt;=&#x27;20160821&#x27;) b on a.agent_id = b.agent_id group by a.city, a.agent_id, a.username, a.real_name, a.phone, a.zgy_name, a.login_count, a.user_countkuai-----------------------------------------------------------------------------------------------------------------------------------| Id | Operation | Name | Rows | Bytes |TempSpc| Cost (%CPU)| Time |-----------------------------------------------------------------------------------------------------------------------------------| 0 | SELECT STATEMENT | | 823M| 96G| | 23M (1)| 78:59:52 || 1 | HASH GROUP BY | | 823M| 96G| | 23M (1)| 78:59:52 || 2 | VIEW | VW_DAG_0 | 823M| 96G| | 23M (1)| 78:59:52 || 3 | HASH GROUP BY | | 823M| 98G| 112G| 23M (1)| 78:59:52 ||* 4 | HASH JOIN OUTER | | 823M| 98G| 26M| 41358 (6)| 00:08:17 || 5 | VIEW | | 259K| 23M| | 11090 (1)| 00:02:14 || 6 | COUNT | | | | | | ||* 7 | FILTER | | | | | | || 8 | VIEW | | 259K| 23M| | 11090 (1)| 00:02:14 || 9 | SORT GROUP BY | | 259K| 38M| 41M| 11090 (1)| 00:02:14 ||* 10 | HASH JOIN | | 259K| 38M| | 2111 (1)| 00:00:26 ||* 11 | VIEW | | 16271 | 143K| | 1975 (1)| 00:00:24 || 12 | HASH UNIQUE | | 16271 | 8882K| 10M| 1975 (1)| 00:00:24 ||* 13 | CONNECT BY WITHOUT FILTERING (UNIQUE)| | | | | | ||* 14 | HASH JOIN RIGHT SEMI | | 530 | 146K| | 29 (0)| 00:00:01 ||* 15 | TABLE ACCESS FULL | TB_USER_CHANNEL | 600 | 7800 | | 7 (0)| 00:00:01 || 16 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 1807 | 476K| | 22 (0)| 00:00:01 || 17 | TABLE ACCESS FULL | TB_CHANNEL_INFO | 1807 | 476K| | 22 (0)| 00:00:01 ||* 18 | HASH JOIN OUTER | | 27937 | 4037K| | 134 (0)| 00:00:02 ||* 19 | HASH JOIN RIGHT OUTER | | 1712 | 173K| | 32 (0)| 00:00:01 || 20 | TABLE ACCESS FULL | TB_USER_ZGY | 43 | 903 | | 3 (0)| 00:00:01 ||* 21 | HASH JOIN RIGHT OUTER | | 1712 | 138K| | 29 (0)| 00:00:01 ||* 22 | TABLE ACCESS FULL | OSS_USER_STATION | 1075 | 25800 | | 6 (0)| 00:00:01 || 23 | TABLE ACCESS FULL | TB_AGENT_INFO | 1712 | 98K| | 23 (0)| 00:00:01 || 24 | TABLE ACCESS FULL | TB_USER_AGENT_RELAT | 27937 | 1200K| | 102 (0)| 00:00:02 ||* 25 | TABLE ACCESS FULL | BASE_DATA_INVEST_INFO | 3374K| 109M| | 19375 (1)| 00:03:53 |-----------------------------------------------------------------------------------------------------------------------------------Predicate Information (identified by operation id):--------------------------------------------------- 4 - access(&quot;A&quot;.&quot;AGENT_ID&quot;=&quot;AGENT_ID&quot;(+)) 7 - filter(ROWNUM&gt;0) 10 - access(&quot;AGENT_ID&quot;=&quot;AGENT_ID&quot;) 11 - filter(&quot;AGENT_ID&quot; IS NOT NULL) 13 - access(&quot;T&quot;.&quot;PARENT_CHANNEL_ID&quot;=PRIOR &quot;T&quot;.&quot;CHANNEL_ID&quot;) 14 - access(&quot;T&quot;.&quot;CHANNEL_ID&quot;=&quot;CHANNEL_ID&quot;) 15 - filter(&quot;USER_ID&quot;=596) 18 - access(&quot;AGENT_ID&quot;=&quot;C&quot;.&quot;AGENT_ID&quot;(+)) 19 - access(&quot;C&quot;.&quot;USERNAME&quot;=&quot;D&quot;.&quot;USERNAME&quot;(+)) 21 - access(&quot;AGENT_ID&quot;=&quot;C&quot;.&quot;AGENT_ID&quot;(+)) 22 - filter(&quot;C&quot;.&quot;USER_TYPE&quot;(+)=0) 25 - filter(&quot;STR_DAY&quot;(+)&gt;=&#x27;20150801&#x27; AND &quot;STR_DAY&quot;(+)&lt;=&#x27;20160821&#x27;) ç”¨no_merge hintç¦æ­¢è§†å›¾åˆå¹¶ä¹Ÿå¯ä»¥123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263select a.city, a.agent_id, a.username, a.real_name, phone, zgy_name, login_count, user_count, count(distinct b.invest_id) user_invested, sum(b.order_amount / 100) invest_amount from (select /*+ no_merge */ a.city, a.agent_id, a.username, a.real_name, -- ä¸šä¸»å§“å a.phone, -- ä¸šä¸»æ‰‹æœºå· d.real_name zgy_name, -- æ‰€å±ä¸“ç®¡å‘˜ count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then c.login_name end) login_count, count(distinct case when c.str_day &lt;= &#x27;20160821&#x27; then decode(c.status, 1, c.invest_id, null) end) user_count from (select /*+ qb_name(sb) */ agent_id, city, username, real_name, phone from agent.TB_AGENT_INFO where agent_id in (SELECT agent_id FROM (SELECT distinct * FROM TB_CHANNEL_INFO t START WITH t.CHANNEL_ID in (select CHANNEL_ID from TB_USER_CHANNEL where USER_ID = 596) CONNECT BY PRIOR t.CHANNEL_ID = t.PARENT_CHANNEL_ID) WHERE agent_id IS NOT NULL)) a left join oss_user_station e on a.agent_id = e.agent_id and e.user_type = 0 left join tb_user_zgy d on e.username = d.username left join (select * from act.tb_user_agent_relat c) c on a.agent_id = c.agent_id group by a.city, a.username, a.real_name, a.phone, d.real_name, a.agent_id) a left join (select invest_id, order_amount, agent_id, str_day from agent.base_data_invest_info where str_day &gt;= &#x27;20150801&#x27; and str_day&lt;=&#x27;20160821&#x27;) b on a.agent_id = b.agent_id group by a.city, a.agent_id, a.username, a.real_name, a.phone, a.zgy_name, a.login_count, a.user_count è‡³æ­¤sqlä»ä¸€ä¸ªå°æ—¶éƒ½è·‘ä¸å®Œï¼Œåˆ°æœ€åä¸¤ç§’è·‘å®Œï¼Œå·¥ä½œå·²ç»å®Œæˆï¼Œä½†æ˜¯å•ä»æ…¢çš„æ‰§è¡Œè®¡åˆ’ä¸­å¹¶æ²¡æœ‰çœ‹å‡ºä»€ä¹ˆé—®é¢˜ã€‚æœ‰èšåˆå‡½æ•°group byèµ°hashæ²¡æœ‰é”™ï¼Œè™½ç„¶æœ‰å…¨è¡¨æ‰«æå¸¦*ä½†æ˜¯è¦ä¹ˆè¿‡æ»¤æ€§å¤ªå·®ï¼Œè¦ä¹ˆä¸æ˜¯æ€§èƒ½ç“¶é¢ˆã€‚é‚£ä¸ºä»€ä¹ˆæ€»å…±300å¤šwå°±è·‘ä¸å®Œäº†å‘¢ æ…¢çš„æ‰§è¡Œè®¡åˆ’åšä¸€ä¸ª10046123456789101112131415161718192021222324252627Number of plan statistics captured: 1Rows (1st) Rows (avg) Rows (max) Row Source Operation---------- ---------- ---------- --------------------------------------------------- 0 0 0 HASH GROUP BY (cr=0 pr=0 pw=0 time=278 us cost=3934270 size=6937507584 card=55059584) 0 0 0 VIEW VW_DAG_1 (cr=0 pr=0 pw=0 time=111 us cost=3934270 size=6937507584 card=55059584) 0 0 0 HASH GROUP BY (cr=0 pr=0 pw=0 time=108 us cost=3934270 size=6607150080 card=55059584) 0 0 0 VIEW VM_NWVW_0 (cr=0 pr=0 pw=0 time=32 us cost=2456206 size=6607150080 card=55059584) 0 0 0 SORT GROUP BY (cr=0 pr=0 pw=0 time=31 us cost=2456206 size=11177095552 card=55059584) 148234852 148234852 148234852 HASH JOIN RIGHT OUTER (cr=34882 pr=0 pw=0 time=34098445 us cost=21643 size=11177095552 card=55059584) 29651 29651 29651 TABLE ACCESS FULL TB_USER_AGENT_RELAT (cr=332 pr=0 pw=0 time=8201 us cost=102 size=1229228 card=27937) 703556 703556 703556 HASH JOIN OUTER (cr=34550 pr=0 pw=0 time=1518631 us cost=21392 size=536480628 card=3374092) 612 612 612 HASH JOIN SEMI (cr=272 pr=0 pw=0 time=31359 us cost=2007 size=193456 card=1712) 1751 1751 1751 HASH JOIN RIGHT OUTER (cr=100 pr=0 pw=0 time=11404 us cost=32 size=178048 card=1712) 43 43 43 TABLE ACCESS FULL TB_USER_ZGY (cr=2 pr=0 pw=0 time=103 us cost=3 size=903 card=43) 1751 1751 1751 HASH JOIN RIGHT OUTER (cr=98 pr=0 pw=0 time=6664 us cost=29 size=142096 card=1712) 1312 1312 1312 TABLE ACCESS FULL OSS_USER_STATION (cr=15 pr=0 pw=0 time=420 us cost=6 size=25800 card=1075) 1751 1751 1751 TABLE ACCESS FULL TB_AGENT_INFO (cr=83 pr=0 pw=0 time=1804 us cost=23 size=101008 card=1712) 612 612 612 VIEW VW_NSO_1 (cr=172 pr=0 pw=0 time=19720 us cost=1975 size=146439 card=16271) 612 612 612 VIEW (cr=172 pr=0 pw=0 time=19351 us cost=1975 size=146439 card=16271) 613 613 613 HASH UNIQUE (cr=172 pr=0 pw=0 time=19224 us cost=1975 size=9095489 card=16271) 1215 1215 1215 CONNECT BY WITHOUT FILTERING (UNIQUE) (cr=172 pr=0 pw=0 time=16687 us) 603 603 603 HASH JOIN RIGHT SEMI (cr=97 pr=0 pw=0 time=4922 us cost=29 size=149990 card=530) 603 603 603 TABLE ACCESS FULL TB_USER_CHANNEL (cr=22 pr=0 pw=0 time=550 us cost=7 size=7800 card=600) 1807 1807 1807 TABLE ACCESS FULL TB_CHANNEL_INFO (cr=75 pr=0 pw=0 time=1615 us cost=22 size=487890 card=1807) 1807 1807 1807 TABLE ACCESS FULL TB_CHANNEL_INFO (cr=75 pr=0 pw=0 time=1133 us cost=22 size=487890 card=1807) 1631878 1631878 1631878 TABLE ACCESS FULL BASE_DATA_INVEST_INFO (cr=34278 pr=0 pw=0 time=950767 us cost=19375 size=155208232 card=3374092)id 6 1äº¿4åƒå¤šä¸‡ï¼Œä¸€ä¸ªå¤šå°æ—¶ä¹Ÿæ²¡è·‘å‡ºæ¥å¹¶ä¸”tempæ’‘çˆ†äº†ç¬¬ 43 è¡Œå‡ºç°é”™è¯¯:ORA-01652: æ— æ³•é€šè¿‡ 128 (åœ¨è¡¨ç©ºé—´ TEMP ä¸­) æ‰©å±• temp æ®µä¸€äº¿å››åƒå¤šä¸‡ï¼Œbè¡¨æ‰300ä¸‡ï¼Œsql group byä¹‹å‰ä¹Ÿä¸è¿‡ä¸€ç™¾å¤šä¸‡çš„ç»“æœ æ ¹æ® 6 -access(â€œAGENT_IDâ€=â€Câ€.â€AGENT_IDâ€(+)) æŸ¥çœ‹cå’Œbè¡¨agent_idæ•°æ®åˆ†å¸ƒ1select agent_id,count(*) from act.tb_user_agent_relat group by agent_id order by 2 desc æœ€å¤šçš„6827è¡Œï¼Œæœ€å°‘çš„1è¡Œ1select agent_id,count(*) from agent.base_data_invest_info group by agent_id order by 2 desc æœ€å¤š50wï¼Œæœ€å°‘1è¡Œåˆä¸€æ¬¡è¿›äº†hash joiné“¾æ¥åˆ—æ•°æ®åˆ†å¸ƒä¸å‡åŒ€çš„å‘ï¼Œhash joinåªé€‚åˆæ•°æ®åˆ†å¸ƒå‡åŒ€çš„åˆ—åšé“¾æ¥æ¡ä»¶ åšä¸ªoradebug short_stack12345678910111213141516171819202122232425262728293031323334SQL&gt; select unique sid from v$mystat; SID---------- 1132SQL&gt; select p.spid from v$process p ,v$session s where s.paddr=p.addr and s.sid=1132;SPID------------------------------------------------28539 oradebug setospid 28539SQL&gt; oradebug short_stackksedsts()+465&lt;-ksdxfstk()+32&lt;-ksdxcb()+1927&lt;-sspuser()+112&lt;-__sighandler()&lt;-io_submit()+7&lt;-skgfqio()+1275&lt;-ksfd_skgfqio()+894&lt;-ksfdgo()+423&lt;-ksfdaio()+2290&lt;-kcflbi()+906&lt;-kcbldio()+3104&lt;-kcblsltio()+530&lt;-stsIssueWrite()+118&lt;-stsGetBlock()+442&lt;-sdbinb()+135&lt;-sdbput()+1042&lt;-smbwrt()+247&lt;-smbput()+2503&lt;-sorput()+93&lt;-qesaEvaAndPutDistAggOpns()+590&lt;-qergsRowP()+430&lt;-qerhjWalkHashBucket()+397&lt;-qerhjGenProbeHashTable()+1571&lt;-qerhjGenProbeHashTable()+718&lt;-kdstf11011010000km()+673&lt;-kdsttgr()+153241&lt;-qertbFetch()+2455&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-qergsFetch()+757&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-opifch2()+2766&lt;-kpoal8()+2833&lt;-opiodr()+917&lt;-ttcpip()+2183&lt;-opitsk()+1710&lt;-opiino()+969&lt;-opiodr()+917&lt;-opidrv()+570&lt;-sou2o()+103&lt;-opimai_real()+133&lt;-ssthrdmain()+265&lt;-main()+201&lt;-__libc_start_main()+244SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; oradebug short_stackksedsts()+465&lt;-ksdxfstk()+32&lt;-ksdxcb()+1927&lt;-sspuser()+112&lt;-__sighandler()&lt;-io_submit()+7&lt;-skgfqio()+1275&lt;-ksfd_skgfqio()+894&lt;-ksfdgo()+423&lt;-ksfdaio()+2290&lt;-kcflbi()+906&lt;-kcbldio()+3104&lt;-kcblsltio()+530&lt;-stsIssueWrite()+118&lt;-stsGetBlock()+442&lt;-sdbinb()+135&lt;-sdbput()+1042&lt;-smbwrt()+247&lt;-smbput()+2503&lt;-sorput()+93&lt;-qesaEvaAndPutDistAggOpns()+590&lt;-qergsRowP()+430&lt;-qerhjWalkHashBucket()+397&lt;-qerhjGenProbeHashTable()+1571&lt;-qerhjWalkHashBucket()+397&lt;-qerhjGenProbeHashTable()+1571&lt;-kdstf11011010000km()+673&lt;-kdsttgr()+153241&lt;-qertbFetch()+2455&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-qergsFetch()+757&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-opifch2()+2766&lt;-kpoal8()+2833&lt;-opiodr()+917&lt;-ttcpip()+2183&lt;-opitsk()+1710&lt;-opiino()+969&lt;-opiodr()+917&lt;-opidrv()+570&lt;-sou2o()+103&lt;-opimai_real()+133&lt;-ssthrdmain()+265&lt;-main()+201&lt;-__libc_start_main()+244SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; oradebug short_stackksedsts()+465&lt;-ksdxfstk()+32&lt;-ksdxcb()+1927&lt;-sspuser()+112&lt;-__sighandler()&lt;-qergsRowP()+2161&lt;-qerhjWalkHashBucket()+397&lt;-qerhjGenProbeHashTable()+1571&lt;-qerhjWalkHashBucket()+397&lt;-qerhjGenProbeHashTable()+1571&lt;-kdstf11011010000km()+673&lt;-kdsttgr()+153241&lt;-qertbFetch()+2455&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-qergsFetch()+757&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-opifch2()+2766&lt;-kpoal8()+2833&lt;-opiodr()+917&lt;-ttcpip()+2183&lt;-opitsk()+1710&lt;-opiino()+969&lt;-opiodr()+917&lt;-opidrv()+570&lt;-sou2o()+103&lt;-opimai_real()+133&lt;-ssthrdmain()+265&lt;-main()+201&lt;-__libc_start_main()+244SQL&gt; oradebug short_stackksedsts()+465&lt;-ksdxfstk()+32&lt;-ksdxcb()+1927&lt;-sspuser()+112&lt;-__sighandler()&lt;-lmebco()+63&lt;-qesaSimpleCompare()+73&lt;-smbput()+913&lt;-sorput()+93&lt;-qergsRowP()+1067&lt;-qerhjWalkHashBucket()+397&lt;-qerhjGenProbeHashTable()+1571&lt;-qerhjGenProbeHashTable()+718&lt;-kdstf11011010000km()+673&lt;-kdsttgr()+153241&lt;-qertbFetch()+2455&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-rwsfcd()+103&lt;-qerhjFetch()+1661&lt;-qergsFetch()+757&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-qervwFetch()+139&lt;-qerghFetch()+315&lt;-opifch2()+2766&lt;-kpoal8()+2833&lt;-opiodr()+917&lt;-ttcpip()+2183&lt;-opitsk()+1710&lt;-opiino()+969&lt;-opiodr()+917&lt;-opidrv()+570&lt;-sou2o()+103&lt;-opimai_real()+133&lt;-ssthrdmain()+265&lt;-main()+201&lt;-__libc_start_main()+244å¯ä»¥çœ‹åˆ°qerhjWalkHashBucketqerhjWalkHashBucketå°±è¡¨ç¤ºåœ¨åšhash joinçš„è¿‡ç¨‹ä¸­éœ€è¦éå†hash bucketä¸­çš„æ•°æ®ï¼Œå½“é“¾æ¥åˆ—æ•°æ®åˆ†å¸ƒä¸å‡ï¼ŒæŸäº›å€¼ç‰¹åˆ«å¤šæ—¶ï¼Œéå†å…¶hash bucketçš„æˆæœ¬ä¹Ÿå°±éå¸¸é«˜ï¼Œå¦‚æœpgaæ”¾ä¸ä¸‹äº†ï¼Œå°±ä¼šæ”¾åˆ°tempè¿›è¡Œç£ç›˜ioï¼Œè¿™å°±æ˜¯æ€§èƒ½ç“¶é¢ˆçš„åŸå› ï¼Œè¿™ä¸ªä¾‹å­æŠŠ30gçš„tempè¡¨ç©ºé—´éƒ½æ’‘çˆ†äº†ï¼Œå¯è§hash bucketæœ‰å¤šå¤§ï¼ åšä¸ªSQL MONITORï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œç“¶é¢ˆåœ¨id 6ã€‚å¦‚æœåšä¸€ä¸ªsql rptä¹Ÿå¯ä»¥å‘ç°sqlæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ¯å¦™é€»è¾‘è¯»å®é™…å¹¶ä¸é«˜ï¼Œå› ä¸ºæ—¶é—´éƒ½èŠ±åœ¨äº†éå†hash bucketä¸­","categories":[],"tags":[{"name":"Oracle","slug":"Oracle","permalink":"http://fuxkdb.com/tags/Oracle/"},{"name":"SQL Tuning","slug":"SQL-Tuning","permalink":"http://fuxkdb.com/tags/SQL-Tuning/"}]},{"title":"æŠ“è·‘å¾—æ…¢çš„SQLï¼ŒæŸ¥çœ‹æ­£åœ¨è·‘çš„sqlçš„ç­‰å¾…äº‹ä»¶","slug":"æŠ“è·‘å¾—æ…¢çš„SQLï¼ŒæŸ¥çœ‹æ­£åœ¨è·‘çš„sqlçš„ç­‰å¾…äº‹ä»¶","date":"2017-08-09T13:00:00.000Z","updated":"2017-08-09T07:31:22.000Z","comments":true,"path":"2017/08/09/æŠ“è·‘å¾—æ…¢çš„SQLï¼ŒæŸ¥çœ‹æ­£åœ¨è·‘çš„sqlçš„ç­‰å¾…äº‹ä»¶/","link":"","permalink":"http://fuxkdb.com/2017/08/09/%E6%8A%93%E8%B7%91%E5%BE%97%E6%85%A2%E7%9A%84SQL%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%AD%A3%E5%9C%A8%E8%B7%91%E7%9A%84sql%E7%9A%84%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6/","excerpt":"","text":"12345678910111213141516171819202122232425select (sysdate-a.logon_time)*24*60 minutes, a.username, a.BLOCKING_INSTANCE, a.BLOCKING_SESSION, a.program, a.machine, a.osuser, a.status, a.sid, a.serial#, a.event, a.p1, a.p2, a.p3, a.sql_id, a.sql_child_number, b.sql_text from v$session a, v$sql b where a.sql_address = b.address and a.sql_hash_value = b.hash_value and a.sql_child_number=b.child_number and a.event not in (&#x27;SQL*Net message from client&#x27;,&#x27;Space Manager: slave idle wait&#x27;) -- and a.username like &#x27;%USERNAME%&#x27; order by 1 desc; åœ¨æŸ¥æ‰§è¡Œè®¡åˆ’1Select * from table(dbms_xplan.display_cursor(&#x27;91prd0dh0bs8d&#x27;,0,&#x27;ALL&#x27;));","categories":[],"tags":[{"name":"Oracle","slug":"Oracle","permalink":"http://fuxkdb.com/tags/Oracle/"},{"name":"SQL Script","slug":"SQL-Script","permalink":"http://fuxkdb.com/tags/SQL-Script/"}]},{"title":"Hexoåšå®¢é…ç½®","slug":"Hexoåšå®¢é…ç½®","date":"2017-08-05T08:40:53.000Z","updated":"2017-08-05T09:30:32.000Z","comments":true,"path":"2017/08/05/Hexoåšå®¢é…ç½®/","link":"","permalink":"http://fuxkdb.com/2017/08/05/Hexo%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE/","excerpt":"Hexoåšå®¢é…ç½®åŸºäºhexo-theme-hikerä¸»é¢˜ å…ˆçœ‹myblogä¸‹çš„_config.ymlå®Œæ•´é…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384# Hexo Configuration## Docs: https://hexo.io/docs/configuration.html## Source: https://github.com/hexojs/hexo/# Sitetitle: Fan()subtitle:description:author: a dba&#x27;s bloglanguage: zh-CNtimezone: Asia/Shanghai# URL## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;url: http://yoursite.comroot: /Fandb.github.iopermalink: :year/:month/:day/:title/permalink_defaults:# Directorysource_dir: sourcepublic_dir: publictag_dir: tagsarchive_dir: archivescategory_dir: categoriescode_dir: downloads/codei18n_dir: :langskip_render:# Writingnew_post_name: :title.md # File name of new postsdefault_layout: posttitlecase: false # Transform title into titlecaseexternal_link: true # Open external links in new tabfilename_case: 0render_drafts: falsepost_asset_folder: falserelative_link: falsefuture: truehighlight: enable: true line_number: true auto_detect: true tab_replace:# Home page setting# path: Root path for your blogs index page. (default = &#x27;&#x27;)# per_page: Posts displayed per page. (0 = disable pagination)# order_by: Posts order. (Order by date descending by default)index_generator: path: &#x27;&#x27; per_page: 6 order_by: -date# Category &amp; Tagdefault_category: uncategorizedcategory_map:tag_map:# Date / Time format## Hexo uses Moment.js to parse and display date## You can customize the date format as defined in## http://momentjs.com/docs/#/displaying/format/date_format: YYYY-MM-DDtime_format: HH:mm:ss# Pagination## Set per_page to 0 to disable paginationper_page: 10pagination_dir: page# Extensions## Plugins: https://hexo.io/plugins/## Themes: https://hexo.io/themes/theme: hiker# Deployment## Docs: https://hexo.io/docs/deployment.htmldeploy: type: git repository: github: https://github.com/Fanduzi/Fandb.github.io.git coding: https://git.coding.net/Fandb/Fandb.blog.git branch: master Note å†’å·åé¢è¦ç©ºä¸€æ ¼","text":"Hexoåšå®¢é…ç½®åŸºäºhexo-theme-hikerä¸»é¢˜ å…ˆçœ‹myblogä¸‹çš„_config.ymlå®Œæ•´é…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384# Hexo Configuration## Docs: https://hexo.io/docs/configuration.html## Source: https://github.com/hexojs/hexo/# Sitetitle: Fan()subtitle:description:author: a dba&#x27;s bloglanguage: zh-CNtimezone: Asia/Shanghai# URL## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;url: http://yoursite.comroot: /Fandb.github.iopermalink: :year/:month/:day/:title/permalink_defaults:# Directorysource_dir: sourcepublic_dir: publictag_dir: tagsarchive_dir: archivescategory_dir: categoriescode_dir: downloads/codei18n_dir: :langskip_render:# Writingnew_post_name: :title.md # File name of new postsdefault_layout: posttitlecase: false # Transform title into titlecaseexternal_link: true # Open external links in new tabfilename_case: 0render_drafts: falsepost_asset_folder: falserelative_link: falsefuture: truehighlight: enable: true line_number: true auto_detect: true tab_replace:# Home page setting# path: Root path for your blogs index page. (default = &#x27;&#x27;)# per_page: Posts displayed per page. (0 = disable pagination)# order_by: Posts order. (Order by date descending by default)index_generator: path: &#x27;&#x27; per_page: 6 order_by: -date# Category &amp; Tagdefault_category: uncategorizedcategory_map:tag_map:# Date / Time format## Hexo uses Moment.js to parse and display date## You can customize the date format as defined in## http://momentjs.com/docs/#/displaying/format/date_format: YYYY-MM-DDtime_format: HH:mm:ss# Pagination## Set per_page to 0 to disable paginationper_page: 10pagination_dir: page# Extensions## Plugins: https://hexo.io/plugins/## Themes: https://hexo.io/themes/theme: hiker# Deployment## Docs: https://hexo.io/docs/deployment.htmldeploy: type: git repository: github: https://github.com/Fanduzi/Fandb.github.io.git coding: https://git.coding.net/Fandb/Fandb.blog.git branch: master Note å†’å·åé¢è¦ç©ºä¸€æ ¼ è§£é‡Šéƒ¨åˆ†åŒºå—è®¾ç½®site1234567# Sitetitle: Fan()subtitle:description:author: a dba&#x27;s bloglanguage: zh-CNtimezone: Asia/Shanghai æ­¤å¤„æ§åˆ¶ languageè®¾ç½®ä¸ºzh-CN,å¦åˆ™ä¼šäº§ç”Ÿé—®é¢˜,æ¯”å¦‚ä¼šæ˜¾ç¤ºæˆæ³•æ–‡ timezone: Asia/Shanghai æ²¡å•¥å¯è§£é‡Šçš„äº† writing123456789101112131415# Writingnew_post_name: :title.md # File name of new postsdefault_layout: posttitlecase: false # Transform title into titlecaseexternal_link: true # Open external links in new tabfilename_case: 0render_drafts: falsepost_asset_folder: falserelative_link: falsefuture: truehighlight: enable: true line_number: true auto_detect: true tab_replace: è¿™é‡Œæ§åˆ¶ä»£ç å—çš„æ˜¾ç¤º,å”¯ä¸€è¦æ³¨æ„çš„æ˜¯auto_detect,é»˜è®¤æ˜¯false,ä¸ä¼šæ£€æµ‹è¯­è¨€ä»£ç ,ä»è€Œæ ¹æ®ä¸åŒçš„è¯­è¨€äº§ç”Ÿä¸åŒçš„ä»£ç é«˜äº® Home page setting12345678# Home page setting# path: Root path for your blogs index page. (default = &#x27;&#x27;)# per_page: Posts displayed per page. (0 = disable pagination)# order_by: Posts order. (Order by date descending by default)index_generator: path: &#x27;&#x27; per_page: 6 order_by: -date per_page: 6 è¡¨ç¤ºä¸€é¡µæ˜¾ç¤º6ç¯‡æ–‡ç«  Extensions1234# Extensions## Plugins: https://hexo.io/plugins/## Themes: https://hexo.io/themes/theme: hiker theme: hiker é€‰æ‹©ä½ æƒ³è¦çš„themesæ–‡ä»¶å¤¹ä¸‹çš„ä¸»é¢˜,ä½ å¯ä»¥åœ¨themesæ–‡ä»¶å¤¹ä¸‹ä¸‹è½½å¤šä¸ªä¸»é¢˜,ç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­é€‰æ‹©ä¸€ä¸ªä½¿ç”¨ 12TiM@TiMdeMacBook-Pro î‚° ~/Documents/myblog/themes î‚° lshiker landscape ä¸»é¢˜é…ç½®æ–‡ä»¶è®¾ç½®å…ˆçœ‹å®Œæ•´é…ç½® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163# ---------------------------------------------------------------# Site Information Settings# ---------------------------------------------------------------# Header Menumenu: Home: / Archives: archives #Categories: /categories Tags: /tags About: /aboutrss: /atom.xmlsince: 2013# Set default keywords (Use a comma to separate)keywords: &quot;&quot;# Put your favicon.ico or avatar.jpg into `hexo-site/themes/hiker/source/` directory.avatar: enable: true border: true width: 124 height: 124 top: 0 url: css/images/mylogo.jpeg# Homepage# eg. home_background_image: [css/images/home-bg.jpg, http://t.cn/RMbvEza]home_background_image: enable: true rolling: true url: [css/images/1.jpg, css/images/2.jpg, css/images/3.jpg, css/images/4.jpg]home_logo_image: enable: false border: false url: css/images/homelogo.jpg# AboutPage backgroundabout_big_image: css/images/pose.jpg# Archive paginationarchive_pagination: true# Post Article&#x27;s Contentpost_catalog: enable: true# Contentfancybox: true# Sidebarsidebar: rightwidgets:- social- category- tag- tagcloud- archive- recent_posts# Social Links# Key is the name of FontAwsome icon.# Value is the target link (E.g. GitHub: https://github.com/iTimeTraveler)social: Github: https://github.com/Fanduzi Weibo: http://weibo.com/1278787855/profile?topnav=1&amp;wvr=6 Twitter: https://twitter.com/FanAshic Facebook: Google-plus: Instagram: Pinterest: Flickr: email: 18501341937@163.com# Searchsearch: insight: true # you need to install `hexo-generator-json-content` before using Insight Search swiftype: # enter swiftype install key here baidu: false # you need to disable other search engines to use Baidu search, options: true, false# comment ShortName, you can choose only ONE to display.gentie_productKey: #your-gentie-product-keyduoshuo_shortname:disqus_shortname:livere_shortname: MTAyMC8yOTQ4MS82MDQ5uyan_uid:wumii:# Code Highlight theme# Available value:# default | normal | night | night eighties | night blue | night bright# https://github.com/chriskempson/tomorrow-themehighlight_theme: default# Article theme color# Available value:# random | orange | blue | red | green | blacktheme_color: random# display widgets at the bottom of index pages (pagination == 2)index_widgets: - category - tagcloud - archive# widget behaviorarchive_type: &#x27;monthly&#x27;show_count: true# Google Webmaster tools verification setting# See: https://www.google.com/webmasters/google_site_verification:baidu_site_verification:qihu_site_verification:# Miscellaneousgoogle_analytics:gauges_analytics:baidu_analytics:tencent_analytics:twitter:google_plus:fb_admins:fb_app_id:# Facebook SDK Support.# https://github.com/iissnan/hexo-theme-next/pull/410facebook_sdk: enable: false app_id: #&lt;app_id&gt; fb_admin: #&lt;user_id&gt; like_button: #true webmaster: #true# CNZZ countcnzz_siteid: 1260716016# busuanzi count# http://busuanzi.ibruce.info/show_busuanzi_view_counts: true# donation buttondonate: enable: true message: &#x27;å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!&#x27; wechatImage: https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG65.jpeg alipayImage: https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG64.jpeg Header menu12345678# Header Menumenu: Home: / Archives: archives #Categories: /categories Tags: /tags About: /aboutrss: /atom.xml æ³¨é‡Šæ‰çš„ä¸ä¼šåœ¨èœå•ä¸­æ˜¾ç¤º Tags,Aboutå‚è€ƒhttp://theme-next.iissnan.com/theme-settings.html#tags-pageæˆ‘çš„é…ç½®ä¸æ•ˆæœ12345678910111213141516171819 TiM@TiMdeMacBook-Pro î‚° ~/Documents/myblog/source/tags î‚° more index.md---title: Tagclouddate: 2017-08-04 23:06:48type: &quot;tags&quot;---# [MySQL](https://fanduzi.github.io/Fandb.github.io/tags/MySQL/)- [PMM](https://fanduzi.github.io/Fandb.github.io/tags/PMM/)- [MHA](https://fanduzi.github.io/Fandb.github.io/tags/MHA/)- [Sysbench](https://fanduzi.github.io/Fandb.github.io/tags/Sysbench/) TiM@TiMdeMacBook-Pro î‚° ~/Documents/myblog/source/tags î‚° cd .. TiM@TiMdeMacBook-Pro î‚° ~/Documents/myblog/source î‚° cd about TiM@TiMdeMacBook-Pro î‚° ~/Documents/myblog/source/about î‚° more index.md---title: aboutdate: 2017-08-04 22:40:02---About Meä¸€ä¸ªèœ&lt;U+1F413&gt;dba è‡ªå®šä¹‰titleå›¾ç‰‡12345678# Put your favicon.ico or avatar.jpg into `hexo-site/themes/hiker/source/` directory.avatar: enable: true border: true width: 124 height: 124 top: 0 url: css/images/mylogo.jpeg url: css/images/mylogo.jpeg æ§åˆ¶ Homepage123456# Homepage# eg. home_background_image: [css/images/home-bg.jpg, http://t.cn/RMbvEza]home_background_image: enable: true rolling: true url: [css/images/1.jpg, css/images/2.jpg, css/images/3.jpg, css/images/4.jpg] url: [css/images/1.jpg, css/images/2.jpg, css/images/3.jpg, css/images/4.jpg] æ§åˆ¶è¿™é‡Œçš„å›¾ç‰‡æ»šåŠ¨ ä½ å¯ä»¥å°†è‡ªå·±å–œæ¬¢çš„å›¾ç‰‡æ”¾åˆ° 1myblog/themes/hiker/source/css/images æœç´¢12345# Searchsearch: insight: true # you need to install `hexo-generator-json-content` before using Insight Search swiftype: # enter swiftype install key here baidu: false # you need to disable other search engines to use Baidu search, options: true, false è¦å®‰è£…12cd myblognpm install hexo-generator-json-content saveç„¶åå°±å¯ä»¥çœ‹åˆ°æœç´¢æŒ‰é’®(åšå®¢å†…æ–‡ç« æœç´¢) å…¶ä»–çš„çœ‹æˆ‘çš„é…ç½®å°±å¤§æ¦‚èƒ½çœ‹æ‡‚äº†,ä¸è§£é‡Šäº† éœ€è¦æ³¨æ„çš„æ–‡ç« æ ¼å¼é»˜è®¤æ–‡ç« æ˜¯æ²¡æœ‰æ ‡é¢˜çš„,å¹¶ä¸”æ˜¯å…¨éƒ¨æ˜¾ç¤ºæ²¡æœ‰read moreæŒ‰é’® è¦æ·»åŠ æ–‡ç« æ ‡é¢˜éœ€è¦åœ¨æ–‡ç« å¼€å¤´æ·»åŠ  12345---title: ä½ çš„æ–‡ç« æ ‡é¢˜datte: 2017-08-05 10:10:10tags: [ä½ çš„æ ‡ç­¾,ä½ çš„æ ‡ç­¾2]--- è€Œread moreåˆ™æ˜¯åœ¨æ–‡ç« ä½ æƒ³è¦å¼€å§‹éšè—çš„ä½ç½®å‰æ·»åŠ  1&lt;!-- more --&gt; æ–‡ç« ä¸­çš„å›¾ç‰‡å»ºè®®æˆ‘ä»ç„¶æ”¾åˆ°äº† 1myblog/themes/hiker/source/css/images ç„¶åhexo dä¸Šä¼ ä»£ç å,å»æ‰¾ä¸€ä¸ªå›¾ç‰‡åœ°å€,ç±»ä¼¼äºè¿™æ · 1![img](https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/hexo1.jpg)","categories":[],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"http://fuxkdb.com/tags/Hexo/"}]},{"title":"ä½¿ç”¨Hexo + githubå¿«é€Ÿæ­å»ºä¸ªäººåšå®¢","slug":"ä½¿ç”¨Hexo-+-githubå¿«é€Ÿæ­å»ºä¸ªäººåšå®¢","date":"2017-08-05T07:55:12.000Z","updated":"2017-08-05T08:36:37.000Z","comments":true,"path":"2017/08/05/ä½¿ç”¨Hexo-+-githubå¿«é€Ÿæ­å»ºä¸ªäººåšå®¢/","link":"","permalink":"http://fuxkdb.com/2017/08/05/%E4%BD%BF%E7%94%A8Hexo-+-github%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/","excerpt":"ä½¿ç”¨Hexo + githubå¿«é€Ÿæ­å»ºä¸ªäººåšå®¢å®‰è£…ä¾èµ–è½¯ä»¶å®‰è£…git1sudo brew install git å®‰è£…Node.jsMacä¸‹æœ€ç®€å•çš„åšæ³•ä¾¿æ˜¯ç›´æ¥ä¸‹è½½pkgæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ä¸‹è½½åœ°å€å¦‚ä¸‹ï¼Œé€‰æ‹©åç¼€ä¸ºpkgçš„æ–‡ä»¶ä¸‹è½½å®‰è£…å³å¯ï¼šhttps://nodejs.org/download/release/latest/å®‰è£…å®Œæˆåä¿®æ”¹ç¯å¢ƒå˜é‡123vi ~/.bash_profileæ·»åŠ export PATH=/usr/local/bin:$PATH å°†npmæºæ›¿æ¢æˆæ·˜å®æº1npm config set registry http://registry.npm.taobao.org/ å®‰è£…Hexoå®‰è£…å‰å…ˆä»‹ç»å‡ ä¸ªhexoå¸¸ç”¨çš„å‘½ä»¤1234$ hexo g #å®Œæ•´å‘½ä»¤ä¸ºhexo generateï¼Œç”¨äºç”Ÿæˆé™æ€æ–‡ä»¶$ hexo s #å®Œæ•´å‘½ä»¤ä¸ºhexo serverï¼Œç”¨äºå¯åŠ¨æœåŠ¡å™¨ï¼Œä¸»è¦ç”¨æ¥æœ¬åœ°é¢„è§ˆ$ hexo d #å®Œæ•´å‘½ä»¤ä¸ºhexo deployï¼Œç”¨äºå°†æœ¬åœ°æ–‡ä»¶å‘å¸ƒåˆ°githubä¸Š$ hexo n #å®Œæ•´å‘½ä»¤ä¸ºhexo newï¼Œç”¨äºæ–°å»ºä¸€ç¯‡æ–‡ç« åˆ©ç”¨ npm å‘½ä»¤å®‰è£…ï¼š1sudo npm install -g hexoæŠ¥é”™å¯å°è¯•1npm install --unsafe-perm -g hexo","text":"ä½¿ç”¨Hexo + githubå¿«é€Ÿæ­å»ºä¸ªäººåšå®¢å®‰è£…ä¾èµ–è½¯ä»¶å®‰è£…git1sudo brew install git å®‰è£…Node.jsMacä¸‹æœ€ç®€å•çš„åšæ³•ä¾¿æ˜¯ç›´æ¥ä¸‹è½½pkgæ–‡ä»¶è¿›è¡Œå®‰è£…ï¼Œæœ€æ–°ç‰ˆæœ¬çš„ä¸‹è½½åœ°å€å¦‚ä¸‹ï¼Œé€‰æ‹©åç¼€ä¸ºpkgçš„æ–‡ä»¶ä¸‹è½½å®‰è£…å³å¯ï¼šhttps://nodejs.org/download/release/latest/å®‰è£…å®Œæˆåä¿®æ”¹ç¯å¢ƒå˜é‡123vi ~/.bash_profileæ·»åŠ export PATH=/usr/local/bin:$PATH å°†npmæºæ›¿æ¢æˆæ·˜å®æº1npm config set registry http://registry.npm.taobao.org/ å®‰è£…Hexoå®‰è£…å‰å…ˆä»‹ç»å‡ ä¸ªhexoå¸¸ç”¨çš„å‘½ä»¤1234$ hexo g #å®Œæ•´å‘½ä»¤ä¸ºhexo generateï¼Œç”¨äºç”Ÿæˆé™æ€æ–‡ä»¶$ hexo s #å®Œæ•´å‘½ä»¤ä¸ºhexo serverï¼Œç”¨äºå¯åŠ¨æœåŠ¡å™¨ï¼Œä¸»è¦ç”¨æ¥æœ¬åœ°é¢„è§ˆ$ hexo d #å®Œæ•´å‘½ä»¤ä¸ºhexo deployï¼Œç”¨äºå°†æœ¬åœ°æ–‡ä»¶å‘å¸ƒåˆ°githubä¸Š$ hexo n #å®Œæ•´å‘½ä»¤ä¸ºhexo newï¼Œç”¨äºæ–°å»ºä¸€ç¯‡æ–‡ç« åˆ©ç”¨ npm å‘½ä»¤å®‰è£…ï¼š1sudo npm install -g hexoæŠ¥é”™å¯å°è¯•1npm install --unsafe-perm -g hexo æœ¬åœ°å»ºç«‹åšå®¢å®‰è£…å®Œæˆåï¼Œæ–°å»ºä¸€ä¸ªç›®å½•å¦‚ myblog ç”¨äºå­˜æ”¾åšå®¢ï¼Œåˆ‡æ¢åˆ°è¯¥ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼ŒHexo å³ä¼šåœ¨ç›®æ ‡æ–‡ä»¶å¤¹åˆæ­¥ç”Ÿæˆåšå®¢æ‰€éœ€è¦çš„æ‰€æœ‰æ–‡ä»¶ï¼š1hexo initç„¶ååˆ‡æ¢åˆ°è¯¥ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå®‰è£…æ‰€éœ€è¦çš„ä¾èµ–ï¼š1sudo npm installæˆ–12345678910111213npm install hexo-generator-index --savenpm install hexo-generator-archive --savenpm install hexo-generator-category --savenpm install hexo-generator-tag --savenpm install hexo-server --savenpm install hexo-deployer-git --savenpm install hexo-deployer-heroku --savenpm install hexo-deployer-rsync --savenpm install hexo-deployer-openshift --savenpm install hexo-renderer-marked --savenpm install hexo-renderer-stylus --savenpm install hexo-generator-feed --savenpm install hexo-generator-sitemap --saveä¿®æ”¹themeç½‘ä¸Šæœ‰å¤§é‡å¼€å‘è€…ä»¬åˆ†äº«çš„æ¨¡æ¿å¯ä¾›é€‰æ‹©ä½¿ç”¨ï¼Œå°†å®ƒä»¬çš„ Git ä»“åº“ Clone ä»¥åæ”¾åˆ°åšå®¢ç›®å½•ä¸‹çš„ themes æ–‡ä»¶å¤¹ä¸­å³å¯ï¼šGithub Hexo Themesæœ‰å“ªäº›å¥½çœ‹çš„ Hexo ä¸»é¢˜ï¼Ÿæœ¬åšå®¢çš„æ­å»ºæˆ‘é€‰æ‹©äº†ä½¿ç”¨è¯¥ä¸»é¢˜ï¼šhttps://github.com/iTimeTraveler/hexo-theme-hiker1git clone https://github.com/iTimeTraveler/hexo-theme-hiker.git themes/hikerä¿®æ”¹é…ç½®æ–‡ä»¶1234567cd myblogvi _config.ymlå°†è¿™é‡Œä¿®æ”¹ä¸ºhiker,é»˜è®¤ä¸ºlandspace# Extensions## Plugins: https://hexo.io/plugins/## Themes: https://hexo.io/themes/theme: hiker ç”Ÿæˆé™æ€æ–‡ä»¶,å¹¶æŸ¥çœ‹12$ hexo g$ hexo s hexo sé»˜è®¤ä½¿ç”¨4000ç«¯å£,å¦‚æœå†²çªå¯ä»¥æ”¹ä¸ºhexo s -p4001 ç„¶åç”¨æµè§ˆå™¨è®¿é—®http://localhost:4001/ï¼Œæ­¤æ—¶ï¼Œä½ åº”è¯¥çœ‹åˆ°äº†ä¸€ä¸ªæ¼‚äº®çš„åšå®¢äº†ï¼Œå½“ç„¶è¿™ä¸ªåšå®¢åªæ˜¯åœ¨æœ¬åœ°çš„ï¼Œåˆ«äººæ˜¯çœ‹ä¸åˆ°çš„ éƒ¨ç½²æœ¬åœ°æ–‡ä»¶åˆ°githubé¦–å…ˆå»githubåˆ›å»ºrepository,æ¬¡æ•°çœç•¥.æˆ‘åˆ›å»ºçš„repositoryå«Fandb.github.io1234567891011cd myblogvi _config.ymlæ”¹æˆå¦‚ä¸‹å†…å®¹# Deployment## Docs: https://hexo.io/docs/deployment.htmldeploy:type: gitrepository: github: https://github.com/Fanduzi/Fandb.github.io.git coding: https://git.coding.net/Fandb/Fandb.blog.gitbranch: master å‘å¸ƒåˆ°Github12$ hexo g$ hexo dæ‰§è¡Œä¸Šé¢çš„ç¬¬äºŒä¸ªå‘½ä»¤ï¼Œå¯èƒ½ä¼šè¦ä½ è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œçš†ä¸ºæ³¨å†ŒGithubæ—¶çš„æ•°æ®ï¼Œè¾“å…¥å¯†ç æ˜¯ä¸æ˜¾ç¤ºä»»ä½•ä¸œè¥¿çš„ï¼Œè¾“å…¥å®Œæ¯•å›è½¦å³å¯ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„åšå®¢å·²ç»æ­å»ºèµ·æ¥ï¼Œå¹¶å‘å¸ƒåˆ°Githubä¸Šäº†ï¼Œè¿™æ—¶å¯ä»¥ç™»é™†è‡ªå·±çš„GithubæŸ¥çœ‹ä»£ç æ˜¯å¦å·²ç»æ¨é€åˆ°å¯¹åº”Repositoryï¼Œåœ¨æµè§ˆå™¨è®¿é—®huangjunhui.github.ioå°±èƒ½çœ‹åˆ°è‡ªå·±çš„åšå®¢äº†ã€‚ç¬¬ä¸€æ¬¡è®¿é—®åœ°å€ï¼Œå¯èƒ½è®¿é—®ä¸äº†ï¼Œæ‚¨å¯ä»¥åœ¨å‡ åˆ†é’Ÿåè¿›è¡Œè®¿é—®ï¼Œä¸€èˆ¬ä¸è¶…è¿‡10åˆ†é’Ÿã€‚ éœ€è¦æ³¨æ„çš„æ˜¯,éœ€è¦å°†è¿™é‡Œè®¾ç½®ä¸ºmaster branchå¹¶ä¿å­˜,æ‰èƒ½è®¿é—®ä½ çš„é¡µé¢ å‚è€ƒ http://opiece.me/2015/04/09/hexo-guide/http://www.jianshu.com/p/6902dd4a0e75","categories":[],"tags":[{"name":"Hexo","slug":"Hexo","permalink":"http://fuxkdb.com/tags/Hexo/"}]},{"title":"Percona Monitoring and Managementæ¶æ„","slug":"Percona Monitoring and Managementæ¶æ„","date":"2017-08-02T14:00:00.000Z","updated":"2017-08-04T15:45:39.000Z","comments":true,"path":"2017/08/02/Percona Monitoring and Managementæ¶æ„/","link":"","permalink":"http://fuxkdb.com/2017/08/02/Percona%20Monitoring%20and%20Management%E6%9E%B6%E6%9E%84/","excerpt":"Percona Monitoring and Managementæ¶æ„PMMåŸºäºç®€å•çš„client-serveræ¨¡å‹,å¯å®ç°é«˜æ•ˆçš„æ‰©å±•æ€§,å®ƒåŒ…å«ä»¥ä¸‹æ¨¡å—: PMM Client,å®‰è£…åœ¨ä»»ä½•ä½ å¸Œæœ›è¢«ç›‘æ§çš„æ•°æ®åº“æœåŠ¡å™¨ä¸Š.å®ƒä¼šæ‰‹æœºæœåŠ¡å™¨æŒ‡æ ‡å’ŒæŸ¥è¯¢åˆ†ææ•°æ®ä»¥æä¾›ä¸€ä»½å®Œæ•´çš„æ€§èƒ½æ¦‚è§ˆ.æ•°æ®è¢«æ”¶é›†å¹¶å‘é€åˆ°PMM Server PMM Serveræ˜¯PMMçš„æ ¸å¿ƒéƒ¨åˆ†,å®ƒèšåˆæ‰‹æœºçš„æ•°æ®,å¹¶ä»¥Webç•Œé¢çš„è¡¨æ ¼,ä»ªè¡¨ç›˜å’Œå›¾å½¢çš„å½¢å¼å±•ç° è¿™äº›æ¨¡å—è¢«å°è£…ä»¥æä¾›ç®€å•çš„å®‰è£…å’Œä½¿ç”¨ç»™ç”¨æˆ·,æ— éœ€å…³å¿ƒå®ƒçš„å†…éƒ¨å®ç°æ–¹æ³•.ä½†æ˜¯ï¼Œå¦‚æœè¦åˆ©ç”¨PMMçš„å…¨éƒ¨æ½œåŠ›ï¼Œå†…éƒ¨ç»“æ„å°±å¾ˆé‡è¦. PMM Client PMM Server éƒ¨ç½²æ–¹æ¡ˆ ç®€å•åœºæ™¯ å…¸å‹åœºæ™¯ PMMæ˜¯æ—¨åœ¨æ— ç¼ååŒå·¥ä½œçš„å·¥å…·é›†åˆã€‚ ä¸€äº›æ˜¯ç”±Perconaå¼€å‘çš„ï¼Œä¸€äº›æ˜¯ç¬¬ä¸‰æ–¹å¼€æºå·¥å…·ã€‚","text":"Percona Monitoring and Managementæ¶æ„PMMåŸºäºç®€å•çš„client-serveræ¨¡å‹,å¯å®ç°é«˜æ•ˆçš„æ‰©å±•æ€§,å®ƒåŒ…å«ä»¥ä¸‹æ¨¡å—: PMM Client,å®‰è£…åœ¨ä»»ä½•ä½ å¸Œæœ›è¢«ç›‘æ§çš„æ•°æ®åº“æœåŠ¡å™¨ä¸Š.å®ƒä¼šæ‰‹æœºæœåŠ¡å™¨æŒ‡æ ‡å’ŒæŸ¥è¯¢åˆ†ææ•°æ®ä»¥æä¾›ä¸€ä»½å®Œæ•´çš„æ€§èƒ½æ¦‚è§ˆ.æ•°æ®è¢«æ”¶é›†å¹¶å‘é€åˆ°PMM Server PMM Serveræ˜¯PMMçš„æ ¸å¿ƒéƒ¨åˆ†,å®ƒèšåˆæ‰‹æœºçš„æ•°æ®,å¹¶ä»¥Webç•Œé¢çš„è¡¨æ ¼,ä»ªè¡¨ç›˜å’Œå›¾å½¢çš„å½¢å¼å±•ç° è¿™äº›æ¨¡å—è¢«å°è£…ä»¥æä¾›ç®€å•çš„å®‰è£…å’Œä½¿ç”¨ç»™ç”¨æˆ·,æ— éœ€å…³å¿ƒå®ƒçš„å†…éƒ¨å®ç°æ–¹æ³•.ä½†æ˜¯ï¼Œå¦‚æœè¦åˆ©ç”¨PMMçš„å…¨éƒ¨æ½œåŠ›ï¼Œå†…éƒ¨ç»“æ„å°±å¾ˆé‡è¦. PMM Client PMM Server éƒ¨ç½²æ–¹æ¡ˆ ç®€å•åœºæ™¯ å…¸å‹åœºæ™¯ PMMæ˜¯æ—¨åœ¨æ— ç¼ååŒå·¥ä½œçš„å·¥å…·é›†åˆã€‚ ä¸€äº›æ˜¯ç”±Perconaå¼€å‘çš„ï¼Œä¸€äº›æ˜¯ç¬¬ä¸‰æ–¹å¼€æºå·¥å…·ã€‚ Note æ•´ä¸ªå®¢æˆ·ç«¯ - æœåŠ¡å™¨æ¨¡å‹ä¸å¤ªå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œä½†ç»„åˆæ¯ä¸ªç»„ä»¶çš„å·¥å…·é›†å¯èƒ½éšäº§å“è€Œå˜åŒ–ã€‚ ä¸‹å›¾è¯´æ˜äº†PMMå½“å‰çš„ç»“æ„ï¼š PMM ClientPMMå®¢æˆ·ç«¯è½¯ä»¶åŒ…é€‚ç”¨äºå¤§å¤šæ•°æµè¡Œçš„Linuxå‘è¡Œç‰ˆï¼š DEBç”¨äºåŸºäºDebiançš„å‘è¡Œç‰ˆï¼ˆåŒ…æ‹¬Ubuntuç­‰ï¼‰ Red Hat Enterprise Linuxè¡ç”Ÿäº§å“çš„RPMï¼ˆåŒ…æ‹¬CentOSï¼ŒOracle Linuxï¼ŒAmazon Linuxç­‰ï¼‰ è¿˜æœ‰å¯ä»¥åœ¨ä»»ä½•Linuxç³»ç»Ÿä¸Šä½¿ç”¨çš„é€šç”¨tarballäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å®‰è£…PMMå®¢æˆ·ç«¯ã€‚ PMMå®¢æˆ·ç«¯è½¯ä»¶åŒ…åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š pmm-adminæ˜¯ä¸€ä¸ªç”¨äºç®¡ç†PMM Clientçš„å‘½ä»¤è¡Œå·¥å…·,ä¾‹å¦‚:æ·»åŠ åˆ é™¤æ•°ä½ æƒ³è¦ç›‘æ§çš„æ•°æ®åº“å®ä¾‹ percona-qan-agentæ˜¯ä¸€ä¸ªç”¨äºç®¡ç† Query Analytics (QAN) agentçš„æœåŠ¡ is a service that manages the Query Analytics (QAN) agent as it collects query performance data. It also connects with QAN API in PMM Server and sends over collected data. node-exporteræ˜¯ä¸€ä¸ªPrometheus exporterç”¨äºæ”¶é›†ç³»ç»ŸæŒ‡æ ‡For more information, see https://github.com/percona/node_exporter. mysqld_exporteræ˜¯ä¸€ä¸ªPrometheus exporterç”¨äºæ”¶é›†MySQL serveræŒ‡æ ‡.For more information, see https://github.com/percona/mysqld_exporter. mongodb_exporteræ˜¯ä¸€ä¸ªPrometheus exporterç”¨äºæ”¶é›†MongoDB serveræŒ‡æ ‡.For more information, see https://github.com/percona/mongodb_exporter. proxysql_exporteræ˜¯ä¸€ä¸ªPrometheus exporterç”¨äºæ”¶é›†ProxySQLæ€§èƒ½æŒ‡æ ‡. For more information, see https://github.com/percona/proxysql_exporter. PMM ServerPMMæœåŠ¡å™¨å°†ä½œä¸ºæ‚¨çš„ä¸­å¤®ç›‘æ§ä¸»æœºçš„æœºå™¨è¿è¡Œã€‚ å®ƒé€šè¿‡ä»¥ä¸‹æ–¹å¼ä½œä¸ºè®¾å¤‡åˆ†å‘ï¼š Docker image that you can use to run a container Open Virtual Applianceï¼ˆOVAï¼‰ï¼Œæ‚¨å¯ä»¥åœ¨VirtualBoxæˆ–å…¶ä»–ç®¡ç†ç¨‹åºä¸­è¿è¡Œ Amazon Machine Image (AMI) that you can run via Amazon Web Services (AWS) æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Running PMM Server. PMMæœåŠ¡å™¨ç”±ä»¥ä¸‹å·¥å…·ç»„æˆï¼š Query Analytics (QAN)ä½¿ä½ èƒ½å¤Ÿåˆ†æMySQLæŸ¥è¯¢æ€§èƒ½. é™¤å®¢æˆ·ç«¯QANä»£ç†å¤–ï¼Œè¿˜åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š QAN APIæ˜¯ç”¨äºå­˜å‚¨å’Œè®¿é—®åœ¨PMMå®¢æˆ·ç«¯ä¸Šè¿è¡Œçš„percona-qan-agentæ”¶é›†çš„æŸ¥è¯¢æ•°æ®çš„åç«¯ã€‚ QAN Web Appæ˜¯ä¸€ä¸ªwebç¨‹åºç”¨äºå¯è§†åŒ–æ”¶é›†çš„Query Analyticsæ•°æ® Metrics Monitor (MM)æä¾›å¯¹MySQLæˆ–MongoDBæœåŠ¡å™¨å®ä¾‹è‡³å…³é‡è¦çš„æŒ‡æ ‡çš„å†å²è§†å›¾ã€‚ å®ƒåŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š Prometheusæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ—¶é—´åºåˆ—æ•°æ®åº“,è¿æ¥åˆ°PMM Clientä¸Šè¿è¡Œçš„exporterså¹¶èšåˆæ”¶é›†åˆ°çš„æŒ‡æ ‡.æ›´å¤šä¿¡æ¯è¯·å‚é˜…Prometheus Docs [1]. Consulprovides an API that a PMM Client can use to remotely list,add, and remove hosts for Prometheus. It also stores monitoring metadata. For more information, see Consul Docs [2]. Warning Although the Consul web UI is accessible, do not make any changes to the configuration. Grafanaæ˜¯ç¬¬ä¸‰æ–¹ä»ªè¡¨æ¿å’Œå›¾å½¢æ„å»ºå™¨ï¼Œç”¨äºåœ¨ç›´è§‚çš„Webç•Œé¢ä¸­å¯è§†åŒ–ç”±Prometheusæ±‡æ€»çš„æ•°æ®ã€‚ æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Grafana Docs[3]. Percona Dashboardsæ˜¯ç”±Perconaå¼€å‘çš„Grafanaä»ªè¡¨æ¿. Orchestratoræ˜¯ä¸€ä¸ªMySQLçš„å¤åˆ¶æ‹“æ‰‘ç®¡ç†å’Œå¯è§†åŒ–å·¥å…·ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…Orchestrator Manual [4]. æ‰€æœ‰å·¥å…·éƒ½å¯ä»¥é€šè¿‡PMM Server webç•Œé¢(ç™»å½•é¡µé¢)è®¿é—®.For more information, see Using the Percona Monitoring and Management Platform. éƒ¨ç½²æ–¹æ¡ˆPMMæ—¨åœ¨é’ˆå¯¹å„ç§ç¯å¢ƒè¿›è¡Œæ‰©å±•ã€‚ æ ¹æ®æ‚¨çš„åŸºç¡€æ¶æ„çš„å¤§å°å’Œå¤æ‚æ€§ï¼Œæ‚¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚ ç®€å•åœºæ™¯å¦‚æœæ‚¨åªæœ‰ä¸€ä¸ªMySQLæˆ–MongoDBæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥åœ¨æ­¤æ•°æ®åº“ä¸»æœºä¸Šå®‰è£…å’Œè¿è¡Œä¸¤ä¸ªæ¨¡å—ï¼ˆPMMå®¢æˆ·ç«¯å’ŒPMMæœåŠ¡å™¨ï¼‰ã€‚ å…¸å‹åœºæ™¯å°†å…¸å‹çš„MySQLå’ŒMongoDBæœåŠ¡å™¨å®ä¾‹åˆ†å¸ƒåœ¨ä¸åŒçš„ä¸»æœºä¸Šã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨ä¸“ç”¨ç›‘æ§ä¸»æœºä¸Šè¿è¡ŒPMM Serverï¼Œå¹¶åœ¨è¦ç›‘è§†çš„æ¯ä¸ªæ•°æ®åº“ä¸»æœºä¸Šå®‰è£…PMM Clientã€‚ æ¥è‡ªä¸»æœºçš„æ•°æ®å°†èšåˆåœ¨PMMæœåŠ¡å™¨ä¸Šã€‚","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"PMMéƒ¨ç½²é‡åˆ°çš„å‘","slug":"PMMéƒ¨ç½²é‡åˆ°çš„å‘","date":"2017-08-01T14:00:00.000Z","updated":"2017-12-11T02:54:44.000Z","comments":true,"path":"2017/08/01/PMMéƒ¨ç½²é‡åˆ°çš„å‘/","link":"","permalink":"http://fuxkdb.com/2017/08/01/PMM%E9%83%A8%E7%BD%B2%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/","excerpt":"","text":"PMMéƒ¨ç½²é‡åˆ°çš„å‘ ç³»ç»Ÿ å†…æ ¸ç‰ˆæœ¬ CentOS release 6.4 (Final) 2.6.32-358.el6.x86_64 1.å…¬å¸ç¯å¢ƒpullä¸ä¸‹æ¥ åœ¨è‡ªå·±çš„ç¯å¢ƒpullä¸‹æ¥ç„¶åsave image 123456789[root@slave oracle]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEdocker.io/percona/pmm-server 1.2.0 eb82a0e154c8 2 weeks ago 1.266 GBdocker.io/percona/pmm-server latest eb82a0e154c8 2 weeks ago 1.266 GB[root@slave oracle]# docker save eb82a0e154c8 &gt; pmm-server.tar[root@slave oracle]# scp pmm-server.tar 10.4.2.43:~/root@10.4.2.43&#x27;s password: pmm-server.tar 100% 1232MB 902.5KB/s 23:18 åœ¨åŸç¯å¢ƒå¯¼å…¥ 1[root@test2 ~]# docker load &lt; pmm-server.tar repostoryå’Œtagæ˜¯ 1234[root@test2 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE&lt;none&gt; &lt;none&gt; abdf7c1b7a63 2 weeks ago 1.266 GB&lt;none&gt; &lt;none&gt; 3690474eb5b4 11 months ago 0 B ä¿®æ”¹tag 12345[root@test2 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE&lt;none&gt; &lt;none&gt; abdf7c1b7a63 2 weeks ago 1.266 GB&lt;none&gt; &lt;none&gt; 3690474eb5b4 11 months ago 0 B[root@test2 ~]# docker tag abdf7c1b7a63 docker.io/percona/pmm-server:1.2.0 2.dockerå®¹å™¨æ— æ³•å¯åŠ¨ no such file or directory statusCode=404 è¿™ä¸ªæœäº†åŠå¤©ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ,æ€€ç–‘æ˜¯å†…æ ¸ç‰ˆæœ¬å¤ªä½ å› ä¸ºCentOS6.4è‡ªå¸¦å†…æ ¸ç‰ˆæœ¬æ˜¯2.6.32-358.23.2.el6.x86_64ï¼Œè€ŒDockerè¦æ±‚å†…æ ¸ç‰ˆæœ¬å¤§äº3.0ï¼Œæ¨è3.8ä»¥ä¸Šçš„å†…æ ¸ https://yq.aliyun.com/ziliao/48262 é‚å‡çº§å†…æ ¸ 1wget http://elrepo.org/linux/kernel/el6/x86_64/RPMS/kernel-lt-3.10.107-1.el6.elrepo.x86_64.rpm å¦‚æœè¿æ¥ä¸å¯¹,è‡ªå·±å»http://elrepo.org/linux/kernel/el6/x86_64/RPMS/çœ‹ä¸€çœ¼,æ‰¾ä¸€ä¸ªåˆé€‚çš„ 1rpm -ivh kernel-lt-3.10.107-1.el6.elrepo.x86_64.rpm ä¿®æ”¹grub.conf 1234567891011121314151617181920212223242526vi /etc/grub.conf# grub.conf generated by anaconda## Note that you do not have to rerun grub after making changes to this file# NOTICE: You have a /boot partition. This means that# all kernel and initrd paths are relative to /boot/, eg.# root (hd0,0)# kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-LogVol00# initrd /initrd-[generic-]version.img#boot=/dev/sdadefault=1timeout=5splashimage=(hd0,0)/grub/splash.xpm.gzhiddenmenutitle CentOS (3.10.107-1.el6.elrepo.x86_64) root (hd0,0) kernel /vmlinuz-3.10.107-1.el6.elrepo.x86_64 ro root=/dev/mapper/VolGroup-LogVol00 rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto KEYBOARDTYPE=pc KEYTABLE=us rd_LVM_LV=VolGroup/LogVol00 rd_NO_DM rhgb quiet numa=off elevator=deadline initrd /initramfs-3.10.107-1.el6.elrepo.x86_64.imgtitle CentOS (2.6.32-358.el6.x86_64) root (hd0,0) kernel /vmlinuz-2.6.32-358.el6.x86_64 ro root=/dev/mapper/VolGroup-LogVol00 rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto KEYBOARDTYPE=pc KEYTABLE=us rd_LVM_LV=VolGroup/LogVol00 rd_NO_DM rhgb quiet numa=off elevator=deadline initrd /initramfs-2.6.32-358.el6.x86_64.img ç°åœ¨title CentOS (3.10.107-1.el6.elrepo.x86_64)åœ¨ 0 å·ä½ç½®,æ‰€ä»¥å°†default=1æ”¹ä¸ºdefault=0é‡å¯os é‡å¯å 1234[root@test2 ~]# cat /etc/redhat-release CentOS release 6.9 (Final)[root@test2 ~]# uname -r3.10.107-1.el6.elrepo.x86_64 å†æ¬¡åˆ›å»ºcontaineræˆåŠŸ 12345678910111213141516171819202122232425[root@test2 ~]# docker load &lt; pmm-server.tar [root@test2 ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE&lt;none&gt; &lt;none&gt; abdf7c1b7a63 2 weeks ago 1.266 GB&lt;none&gt; &lt;none&gt; 3690474eb5b4 11 months ago 0 B[root@test2 ~]# docker tag abdf7c1b7a63 docker.io/percona/pmm-server:1.2.0[root@test2 ~]# docker create \\&gt; -v /opt/prometheus/data \\&gt; -v /opt/consul-data \\&gt; -v /var/lib/mysql \\&gt; -v /var/lib/grafana \\&gt; --name pmm-data \\&gt; percona/pmm-server:1.2.0 /bin/true094c63bd911b5139a267abe7939e5c4442cdc857970dedaccb9ae0cb5f165fc9[root@test2 ~]# docker run -d \\&gt; -p 80:80 \\&gt; --volumes-from pmm-data \\&gt; --name pmm-server \\&gt; --restart always \\&gt; percona/pmm-server:1.2.069195dca404bc607fa12a9cd6436a9786a71dcf226a0e4c1d6bf0b9879a14f03[root@test2 ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES69195dca404b percona/pmm-server:1.2.0 &quot;/opt/entrypoint.sh&quot; 11 seconds ago Up 9 seconds 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server 094c63bd911b percona/pmm-server:1.2.0 &quot;/bin/true&quot; 21 seconds ago pmm-data Note PMM-serveré€‰æ‹©ä¸€ä¸ªå†…æ ¸ç‰ˆæœ¬æçš„æœåŠ¡å™¨å°±è¡Œ PMM-clientæ— æ‰€è°“ 3.pmm-data çŠ¶æ€ä¸ºExitedå†…æ ¸ç‰ˆæœ¬ä½ 4.MySQL dashboardæ²¡æ•°æ®é˜²ç«å¢™æ²¡å…³123456pmm-admin check-networkcentos 7åœæ­¢ï¼š systemctl disable firewalldç¦ç”¨ï¼š systemctl stop firewalld 5.å®¹å™¨æ—¶åŒºä¸ºUTCä¸æˆ‘ä»¬ç³»ç»ŸCSTå·®å…«ä¸ªå°æ—¶è¿›å…¥å®¹å™¨1cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtimehttp://www.cnblogs.com/w2206/p/6904446.html","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"éƒ¨ç½²PMM","slug":"éƒ¨ç½²PMM","date":"2017-08-01T14:00:00.000Z","updated":"2018-05-03T08:31:22.000Z","comments":true,"path":"2017/08/01/éƒ¨ç½²PMM/","link":"","permalink":"http://fuxkdb.com/2017/08/01/%E9%83%A8%E7%BD%B2PMM/","excerpt":"","text":"éƒ¨ç½²PMM è¿è¡ŒPMM Server é€šè¿‡Dockerè¿è¡Œ å®‰è£…PMM Client Connect PMM Client to PMM Server Start data collection 1.åœ¨ä¸»æœºä¸Šè¿è¡ŒPMM Serverï¼Œç”¨äºè®¿é—®æ”¶é›†çš„æ•°æ®ï¼ŒæŸ¥çœ‹åŸºäºæ—¶é—´çš„å›¾è¡¨ï¼Œå¹¶æ‰§è¡Œæ€§èƒ½åˆ†æã€‚å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼è¿è¡ŒPMM Server: Run PMM Server using Docker Run PMM Server as a virtual appliance Run PMM Server using Amazon Machine Image (AMI) è¿™é‡Œåªä»‹ç»é€šè¿‡Dockeræ–¹å¼è¿è¡ŒPMM Server Running PMM Server Using DockerPMMæœåŠ¡å™¨çš„Dockeræ˜ åƒå…¬å¼€æ‰˜ç®¡åœ¨https://hub.docker.com/r/percona/pmm-server/ã€‚ å¦‚æœè¦ä»Dockeræ˜ åƒè¿è¡ŒPMM Serverï¼Œåˆ™ä¸»æœºå¿…é¡»èƒ½å¤Ÿè¿è¡ŒDocker 1.12.6æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå¹¶å…·æœ‰ç½‘ç»œè®¿é—®æƒé™ã€‚ 12345678å®‰è£…dockeré¦–å…ˆå®‰è£…epelæºwget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-6.repoyum clean allyum makecacheyum -y install docker-io yum upgrade device-mapper-libs -yservice docker start ä¿®æ”¹dockerå®¹å™¨å­˜å‚¨è·¯å¾„,é»˜è®¤å­˜å‚¨åœ¨/var/lib/dockerä¸‹.è¿™é‡Œä½¿ç”¨è½¯è¿æ¥æ–¹å¼ä¿®æ”¹123456service stop dockercd /var/lib/dockercp -r * /data/docker/mv /var/lib/docker /var/lib/docker.bakln -s /var/lib/docker /data/dockerservice start docker ç¦ç”¨é˜²ç«å¢™12åœæ­¢ï¼š systemctl disable firewalldç¦ç”¨ï¼š systemctl stop firewalldå…³é—­æˆ–è€…è®¾ç½® IPTABLES123#PMM$IPTABLES -A INPUT -p tcp --dport 42002 -j ACCEPT$IPTABLES -A INPUT -p tcp --dport 42000 -j ACCEPTè¿™ä¸¤ä¸ªç«¯å£å·æ˜¯å“ªæ¥çš„çš„å‘¢? æ˜¯åœ¨pmm-admin check-networkçœ‹åˆ°çš„(å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰æè¿°)123456* Connection: Client &lt;-- Server-------------- ---------- --------------------- ------- ---------- ---------SERVICE TYPE NAME REMOTE ENDPOINT STATUS HTTPS/TLS PASSWORD -------------- ---------- --------------------- ------- ---------- ---------linux:metrics pt_slave1 120.27.136.247:42000 OK YES - mysql:metrics pt_slave1 120.27.136.247:42002 OK YES - å®‰è£…Percona-toolkit (Query Analyticséœ€è¦)12yum install percona-xtrabackup-24.x86_64 percona-xtrabackup-24-debuginfo.x86_64 percona-xtrabackup-test-24.x86_64 percona-toolkit.x86_64 percona-toolkit-debuginfo.x86_64 percona-toolkit.x86_64 -yyum install qpress* -yåˆ›å»ºä¸“ç”¨ç”¨æˆ·èµ‹äºˆæƒé™12GRANT SELECT, PROCESS, SUPER, REPLICATION CLIENT, RELOAD ON *.* TO &#x27;pmm&#x27;@&#x27; localhost&#x27; IDENTIFIED BY &#x27;pass&#x27; WITH MAX_USER_CONNECTIONS 10;GRANT SELECT, UPDATE, DELETE, DROP ON performance_schema.* TO &#x27;pmm&#x27;@&#x27; localhost&#x27;;mysql:metrics éœ€è¦REPLICATION CLIENTæƒé™mysql:queries éœ€è¦SUPERæƒé™å…·ä½“å‚è€ƒ [What privileges are required to monitor a MySQL instance?(https://www.percona.com/doc/percona-monitoring-and-management/faq.html#id11) Step 1.åˆ›å»ºPMM Data Container1234567$ docker create \\ -v /opt/prometheus/data \\ -v /opt/consul-data \\ -v /var/lib/mysql \\ -v /var/lib/grafana \\ --name pmm-data \\ percona/pmm-server:latest /bin/true Note å¦‚æœå†æœ¬åœ°æ‰¾ä¸åˆ°,Dockerä¼šä»Dockerhubæ‹‰å–image ç¡®ä¿ä½ åœ¨ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Docker This container does not run, it simply exists to make sure you retain all PMM data when you upgrade to a newer pmm-server image. Do not remove or re-create this container, unless you intend to wipe out all PMM data and start over. ä¸Šè¿°å‘½ä»¤æ‰§è¡Œä»¥ä¸‹å·¥ä½œ: docker createå‘½ä»¤æŒ‡ç¤ºDockerå®ˆæŠ¤ç¨‹åºä»æ˜ åƒåˆ›å»ºä¸€ä¸ªå®¹å™¨. -vé€‰é¡¹åˆå§‹åŒ–å®¹å™¨çš„æ•°æ®å·. --nameé€‰é¡¹ä¸ºå¯ç”¨äºå¼•ç”¨Dockerç½‘ç»œä¸­çš„å®¹å™¨çš„å®¹å™¨åˆ†é…ä¸€ä¸ªè‡ªå®šä¹‰åç§°ã€‚ åœ¨æ¬¡æ•°ä¸ºï¼špmm-data. percona/pmm-server:1.5.2æ˜¯å¯¼å‡ºå®¹å™¨çš„æ˜ åƒçš„åç§°å’Œç‰ˆæœ¬æ ‡ç­¾. /bin/trueæ˜¯å®¹å™¨è¿è¡Œå‘½ä»¤ Step 2.Create and Run the PMM Server Container123456789101112docker run -d \\ -p 80:80 \\ --volumes-from pmm-data \\ --name pmm-server \\ -e SERVER_USER=hehe \\ -e SERVER_PASSWORD=ninainaide \\ -e METRICS_RETENTION=4320h \\ -e METRICS_MEMORY=35651584 \\ -e METRICS_RESOLUTION=3s \\ -e DISABLE_TELEMETRY=true \\ --restart always \\ percona/pmm-server:1.5.2 ä¸Šè¿°å‘½ä»¤æ‰§è¡Œä»¥ä¸‹å·¥ä½œ: docker runå‘½ä»¤æŒ‡ç¤ºdockerå®ˆæŠ¤ç¨‹åºä»æ˜ åƒè¿è¡Œå®¹å™¨ã€‚ -dé€‰é¡¹ä»¥åˆ†ç¦»æ¨¡å¼ï¼ˆå³åå°ï¼‰å¯åŠ¨å®¹å™¨ã€‚ -pé€‰é¡¹æ˜ å°„ç”¨äºè®¿é—®PMMæœåŠ¡å™¨Web UIçš„ç«¯å£ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœç«¯å£80ä¸å¯ç”¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨-p 8080ï¼š80å°†ç€é™†é¡µæ˜ å°„åˆ°ç«¯å£8080ã€‚ --volumes-fromé€‰é¡¹ä»pmm-dataå®¹å™¨ä¸­è£…è½½å·ï¼ˆè¯·å‚é˜…æ­¥éª¤1.åˆ›å»ºä¸€ä¸ªPMMæ•°æ®å®¹å™¨ï¼‰ã€‚ â€”nameé€‰é¡¹ä¸ºå¯ç”¨äºå¼•ç”¨Dockerç½‘ç»œä¸­çš„å®¹å™¨çš„å®¹å™¨åˆ†é…ä¸€ä¸ªè‡ªå®šä¹‰åç§°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼špmm-serverã€‚ â€”restarté€‰é¡¹å®šä¹‰å®¹å™¨çš„é‡æ–°å¯åŠ¨ç­–ç•¥ã€‚ è®¾ç½®å®ƒå§‹ç»ˆç¡®ä¿Dockerå®ˆæŠ¤ç¨‹åºåœ¨å¯åŠ¨æ—¶å¯åŠ¨å®¹å™¨ï¼Œå¹¶åœ¨å®¹å™¨é€€å‡ºæ—¶é‡æ–°å¯åŠ¨å®ƒã€‚ percona / pmm-server:1.5.2æ˜¯å¯¼å‡ºå®¹å™¨çš„æ˜ åƒçš„åç§°å’Œç‰ˆæœ¬æ ‡ç­¾ã€‚ -e SERVER_USER SERVER_PASSWORDæ˜¯ä¸ºäº†å®‰å…¨ï¼Œè®¾ç½®è®¿é—®PMM webé¡µé¢æ‰€éœ€çš„ç”¨æˆ·åå’Œå¯†ç (å¦åˆ™ä»»ä½•æœ‰ä½ pmmåœ°å€çš„äººéƒ½å¯ä»¥è®¿é—®) Security Features in Percona Monitoring and Management -e METRICS_MEMORY é»˜è®¤prometheusä½¿ç”¨768Må†…å­˜å­˜å‚¨æœ€è¿‘çš„data chunks ä½¿ç”¨æ­¤å‚æ•°è®¾ç½® å…·ä½“å‚è€ƒHow to control memory consumption for PMM? -e METRICS_RESOLUTION pmm-server å’Œ client ç½‘ç»œä¸å¤ªå¥½çš„è¯æŠŠè¿™ä¸ªå€¼è®¾å¤§ä¸€ç‚¹ 1~5s è¶…è¿‡5s promethesæ— æ³•å¯åŠ¨ å…·ä½“å‚è€ƒWhat resolution is used for metrics? 2.åœ¨æ‰€æœ‰éœ€è¦ç›‘æ§çš„æœåŠ¡å™¨å®‰è£…PMM Client123å®‰è£…perconaæºrpm -ivh https://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpmsudo yum install pmm-client 3.Connect PMM Client to PMM Serveråœ¨å®‰è£…å®ŒPMM Clientå,å®ƒå¹¶ä¸ä¼šè‡ªåŠ¨è¿æ¥PMM Server. è¦å°†å®¢æˆ·ç«¯è¿æ¥åˆ°PMMæœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨pmm-admin config â€“serverå‘½ä»¤æŒ‡å®šIPåœ°å€ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœPMMæœåŠ¡å™¨åœ¨192.168.100.1ä¸Šè¿è¡Œï¼Œå¹¶ä¸”åœ¨IP 192.168.200.1çš„è®¡ç®—æœºä¸Šå®‰è£…äº†PMM Clientï¼š 123456$ sudo pmm-admin config --server 192.168.100.1 --server-user jsmith --server-password pass1234OK, PMM server is alive.PMM Server | 192.168.100.1Client Name | ubuntu-amd64Client Address | 192.168.200.1 Note If you changed the default port 80 when running PMM Server, specify it after the serverâ€™s IP address. For example: 1$ sudo pmm-admin config --server 192.168.100.1:8080 --server-user jsmith --server-password pass1234 å¯ä»¥æ·»åŠ â€“client-nameå‚æ•°æŒ‡å®šå®¢æˆ·ç«¯åç§°,å¦åˆ™ä¸ºä¸»æœºå,ä½†æ˜¯åƒECSé‚£æ ·çš„é»˜è®¤ä¸»æœºåiZbp1igpeohje7z5ugkdr9Zè‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ 4.Start data collectionAfter you connect the client to PMM Server, enable data collection from the database instance by adding a monitoring service. To enable general system metrics, MySQL metrics, and MySQL query analytics, run: 1sudo pmm-admin add mysql --user mysql --password mysql --socket /data/mysqldata/3306/mysql.sock To enable general system metrics, MongoDB metrics, and MongoDB query analytics, run: 1sudo pmm-admin --dev-enable add mongodb Note MongoDBæŸ¥è¯¢åˆ†ææ˜¯å®éªŒæ€§çš„ï¼Œåœ¨æ·»åŠ æ—¶éœ€è¦â€“dev-enableé€‰é¡¹ã€‚ æ²¡æœ‰æ­¤é€‰é¡¹ï¼Œåˆ™åªä¼šæ·»åŠ ä¸€èˆ¬ç³»ç»ŸæŒ‡æ ‡å’ŒMongoDBæŒ‡æ ‡. To enable ProxySQL performance metrics, run: 1sudo pmm-admin add proxysql:metrics è¦æŸ¥çœ‹æ­£åœ¨ç›‘æ§çš„å†…å®¹ï¼Œè¯·è¿è¡Œ: 1$ sudo pmm-admin list ä¸¾ä¾‹ä½ å¼€å¯äº†ç³»ç»Ÿå’ŒMongoDBæŒ‡æ ‡ç›‘æ§,ä¼šäº§ç”Ÿç±»ä¼¼ä¸‹é¢çš„è¾“å‡º: 12345678910111213$ sudo pmm-admin listpmm-admin 1.1.3PMM Server | 192.168.100.1Client Name | ubuntu-amd64Client Address | 192.168.200.1Service manager | linux-systemd---------------- ----------- ----------- -------- ---------------- --------SERVICE TYPE NAME LOCAL PORT RUNNING DATA SOURCE OPTIONS---------------- ----------- ----------- -------- ---------------- --------linux:metrics mongo-main 42000 YES -mongodb:metrics mongo-main 42003 YES localhost:27017 æœ‰å…³æ·»åŠ å®ä¾‹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è¿è¡Œpmm-admin add â€”help. è£…å®Œä¸€å®šè¦ç”¨pmm-admin check-networkæ£€æŸ¥,ä¸‹é¢çš„æ˜¯æ­£å¸¸çš„123456789101112131415161718192021222324252627282930313233[root@iZbp1igpeohje7z5ugkdr9Z log]# pmm-admin check-networkPMM Network StatusServer Address | xx.xx.xx.xxClient Address | xx.xx.xx.xx * System TimeNTP Server (0.pool.ntp.org) | 2017-09-28 15:44:39 +0800 CSTPMM Server | 2017-09-28 07:44:38 +0000 GMTPMM Client | 2017-09-28 15:44:39 +0800 CSTPMM Server Time Drift | OKPMM Client Time Drift | OKPMM Client to PMM Server Time Drift | OK* Connection: Client --&gt; Server-------------------- ------- SERVER SERVICE STATUS -------------------- ------- Consul API OKPrometheus API OKQuery Analytics API OKConnection duration | 31.032856msRequest duration | 31.557981msFull round trip | 62.590837ms* Connection: Client &lt;-- Server-------------- ---------- -------------------- ------- ---------- ---------SERVICE TYPE NAME REMOTE ENDPOINT STATUS HTTPS/TLS PASSWORD -------------- ---------- -------------------- ------- ---------- ---------linux:metrics pt_slave5 101.37.14.213:42000 OK YES - mysql:metrics pt_slave5 101.37.14.213:42002 OK YES - ä¿®æ”¹å®¹å™¨æ—¶åŒº(ä½ è¯•è¯•ä¸æ”¹æ—¶åŒºgrafanaé‚®ä»¶å‘Šè­¦çš„æ—¶å€™æ—¶é—´å¯¹å— :) )1cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime é‡å¯12345678910111213141516171819[root@test2 ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES69195dca404b percona/pmm-server:1.5.2 &quot;/opt/entrypoint.sh&quot; 28 hours ago Exited (128) 6 minutes ago 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server 094c63bd911b percona/pmm-server:1.5.2 &quot;/bin/true&quot; 28 hours ago pmm-data [root@test2 ~]# docker start 69195dca404bError response from daemon: Cannot start container 69195dca404b: Error getting container 69195dca404bc607fa12a9cd6436a9786a71dcf226a0e4c1d6bf0b9879a14f03 from driver devicemapper: Error mounting &#x27;/dev/mapper/docker-253:0-6947028-69195dca404bc607fa12a9cd6436a9786a71dcf226a0e4c1d6bf0b9879a14f03&#x27; on &#x27;/var/lib/docker/devicemapper/mnt/69195dca404bc607fa12a9cd6436a9786a71dcf226a0e4c1d6bf0b9879a14f03&#x27;: device or resource busyError: failed to start containers: [69195dca404b]umount /var/lib/docker/devicemapper/mnt/69195dca404bc607fa12a9cd6436a9786a71dcf226a0e4c1d6bf0b9879a14f03[root@test2 ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES69195dca404b percona/pmm-server:1.5.2 &quot;/opt/entrypoint.sh&quot; 28 hours ago Exited (128) 8 minutes ago 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server 094c63bd911b percona/pmm-server:1.5.2 &quot;/bin/true&quot; 28 hours ago pmm-data [root@test2 ~]# docker start 69195dca404b69195dca404b[root@test2 ~]# docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES69195dca404b percona/pmm-server:1.5.2 &quot;/opt/entrypoint.sh&quot; 28 hours ago Up 5 seconds 0.0.0.0:80-&gt;80/tcp, 443/tcp pmm-server 094c63bd911b percona/pmm-server:1.5.2 &quot;/bin/true&quot; 28 hours ago pmm-data","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"PMM","slug":"PMM","permalink":"http://fuxkdb.com/tags/PMM/"}]},{"title":"MHAåœ¨ç›‘æ§å’Œæ•…éšœè½¬ç§»æ—¶éƒ½åšäº†ä»€ä¹ˆ","slug":"MHAåœ¨ç›‘æ§å’Œæ•…éšœè½¬ç§»æ—¶éƒ½åšäº†ä»€ä¹ˆ","date":"2017-07-24T14:00:00.000Z","updated":"2017-08-04T15:10:40.000Z","comments":true,"path":"2017/07/24/MHAåœ¨ç›‘æ§å’Œæ•…éšœè½¬ç§»æ—¶éƒ½åšäº†ä»€ä¹ˆ/","link":"","permalink":"http://fuxkdb.com/2017/07/24/MHA%E5%9C%A8%E7%9B%91%E6%8E%A7%E5%92%8C%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB%E6%97%B6%E9%83%BD%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88/","excerpt":"MHAåœ¨ç›‘æ§å’Œæ•…éšœè½¬ç§»æ—¶éƒ½åšäº†ä»€ä¹ˆä»¥ä¸‹æ˜¯MHA(masterha_manager)åœ¨ç›‘æ§å’Œæ•…éšœåˆ‡æ¢ä¸Šçš„åŸºæœ¬æµç¨‹ éªŒè¯å¤åˆ¶é…ç½®å’Œè¯†åˆ«å½“å‰ä¸»åº“ é€šè¿‡è¿æ¥é…ç½®æ–‡ä»¶ä¸­æè¿°çš„æ‰€æœ‰ä¸»æœºæ¥è¯†åˆ«å½“å‰ä¸»åº“.ä½ ä¸å¿…æ‰‹åŠ¨æŒ‡æ˜é‚£ä¸ªä¸»å¥æ˜¯ä¸»åº“,MHAä¼šè‡ªåŠ¨æ£€æŸ¥å¤åˆ¶è®¾ç½®å¹¶è¯†åˆ«å½“å‰ä¸»åº“. æ³¨æ„:MHAæœ¬èº«ä¸èƒ½æ„å»ºå¤åˆ¶ç¯å¢ƒ,MHAç›‘æ§å·²å­˜åœ¨çš„å¤åˆ¶ç¯å¢ƒ If any slave is dead at this stage, terminating the script for safety reasons(If any slave is dead, MHA can not recover the dead slave, of course). å¼€å¯ç›‘æ§æ—¶ä»»ä½•slaveå‘ç”Ÿæ•…éšœéƒ½ä¼šå¯¼è‡´ç›‘æ§é€€å‡º,MHAå¹¶ä¸èƒ½ä¿®å¤ä»åº“ å¦‚æœä»»ä½•å¿…è¦çš„è„šæœ¬æ²¡æœ‰å®‰è£…åœ¨æ‰€æœ‰Node,MHA abortè€Œä¸ä¼šå¯åŠ¨ç›‘æ§","text":"MHAåœ¨ç›‘æ§å’Œæ•…éšœè½¬ç§»æ—¶éƒ½åšäº†ä»€ä¹ˆä»¥ä¸‹æ˜¯MHA(masterha_manager)åœ¨ç›‘æ§å’Œæ•…éšœåˆ‡æ¢ä¸Šçš„åŸºæœ¬æµç¨‹ éªŒè¯å¤åˆ¶é…ç½®å’Œè¯†åˆ«å½“å‰ä¸»åº“ é€šè¿‡è¿æ¥é…ç½®æ–‡ä»¶ä¸­æè¿°çš„æ‰€æœ‰ä¸»æœºæ¥è¯†åˆ«å½“å‰ä¸»åº“.ä½ ä¸å¿…æ‰‹åŠ¨æŒ‡æ˜é‚£ä¸ªä¸»å¥æ˜¯ä¸»åº“,MHAä¼šè‡ªåŠ¨æ£€æŸ¥å¤åˆ¶è®¾ç½®å¹¶è¯†åˆ«å½“å‰ä¸»åº“. æ³¨æ„:MHAæœ¬èº«ä¸èƒ½æ„å»ºå¤åˆ¶ç¯å¢ƒ,MHAç›‘æ§å·²å­˜åœ¨çš„å¤åˆ¶ç¯å¢ƒ If any slave is dead at this stage, terminating the script for safety reasons(If any slave is dead, MHA can not recover the dead slave, of course). å¼€å¯ç›‘æ§æ—¶ä»»ä½•slaveå‘ç”Ÿæ•…éšœéƒ½ä¼šå¯¼è‡´ç›‘æ§é€€å‡º,MHAå¹¶ä¸èƒ½ä¿®å¤ä»åº“ å¦‚æœä»»ä½•å¿…è¦çš„è„šæœ¬æ²¡æœ‰å®‰è£…åœ¨æ‰€æœ‰Node,MHA abortè€Œä¸ä¼šå¯åŠ¨ç›‘æ§ ç›‘æ§ä¸»åº“ ç›‘æ§é˜¶æ®µMHAä¼šæŒç»­ç›‘æ§ä¸»åº“ç›´åˆ°å…¶å‘ç”Ÿæ•…éšœ,MHAå¹¶ä¸ä¼šç›‘æ§ä»åº“.åœæ­¢/é‡å¯/æ·»åŠ /ç§»é™¤ä»åº“ä¸ä¼šå¯¹å½“å‰çš„MHAç›‘æ§äº§ç”Ÿä»»ä½•å½±å“.ä½†æ˜¯æ³¨æ„å½“ä½ æ·»åŠ æˆ–ç§»é™¤ä»åº“ååº”å½“æ›´æ–°MHAé…ç½®æ–‡ä»¶å¹¶é‡å¯MHA ç›‘æµ‹ä¸»åº“æ•…éšœ å¦‚æœMHAè¿ç»­ä¸‰æ¬¡è¿æ¥ä¸»åº“å¤±è´¥,å°†ä¼šè¿›å…¥æ­¤é˜¶æ®µ å¦‚æœä½ åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†secondary_check_scriptè„šæœ¬,MHAä¼šè°ƒç”¨æ¬¡è„šæœ¬äºŒæ¬¡éªŒè¯masterçŠ¶æ€çœ‹çœ‹æ˜¯ä¸æ˜¯çœŸçš„æŒ‚äº† ä»¥ä¸‹æ­¥éª¤ä¹Ÿç”±masterha_master_switchå‘½ä»¤æ‰§è¡Œ. æ‚¨å¯ä»¥ä½¿ç”¨ä¸masterha_managerç›¸åŒçš„å‚æ•°. å†æ¬¡éªŒè¯ä»åº“é…ç½® å†æ¬¡è¯»å–é…ç½®æ–‡ä»¶,å¹¶è¿æ¥æ‰€æœ‰ä¸»æœºå¹¶éªŒè¯å½“å‰æ•…éšœä¸»æœºçŠ¶æ€å’Œæ‰€æœ‰æ­¤ä¸»åº“çš„ä»åº“.å¦‚æœæ£€æµ‹åˆ°ä»»ä½•æ— æ•ˆçš„å¤åˆ¶é…ç½®ï¼ˆå³æŸäº›ä»ç«™ä»ä¸åŒçš„ä¸»ç«™å¤åˆ¶ï¼‰ï¼Œé‚£ä¹ˆMHAå°†åœ¨æ­¤å¤„åœæ­¢ã€‚ æ‚¨å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ignore_failå‚æ•°æ¥æ›´æ”¹æ­¤è¡Œä¸ºã€‚ è¿™ä¸€æ­¥æ˜¯å‡ºäºå®‰å…¨åŸå› ã€‚ ç”±äºmasterha_managerå¯èƒ½è¿è¡Œäº†å¾ˆé•¿æ—¶é—´ï¼ˆå‘¨/æœˆï¼‰ï¼Œå› æ­¤å¤åˆ¶é…ç½®å¯èƒ½ä¼šæ›´æ”¹ï¼Œå› æ­¤é€šå¸¸å»ºè®®è¿›è¡ŒåŒé‡æ£€æŸ¥ã€‚ æ£€æŸ¥ä¸Šä¸€ä¸ªæ•…éšœè½¬ç§»çŠ¶æ€å¦‚æœæœ€åä¸€ä¸ªæ•…éšœè½¬ç§»ä»¥é”™è¯¯ç»“æŸï¼Œæˆ–æœ€è¿‘ä¸€æ¬¡æ•…éšœè½¬ç§»æœ€è¿‘å®Œæˆï¼Œåˆ™MHAå°†åœ¨æ­¤åœæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šå¯åŠ¨æ•…éšœè½¬ç§»ã€‚ æ‚¨å¯ä»¥é€šè¿‡masterha_managerå‘½ä»¤ä¸­çš„ignore_last_failoverå’Œwait_on_failover_errorå‚æ•°æ›´æ”¹æ­¤è¡Œä¸ºã€‚ Shutting down failed master server (optional) å¦‚æœä½ åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº† master_ip_failover_script and/or shutdown_script ,MHAä¼šè°ƒç”¨è¿™äº›è„šæœ¬ å½“å‰ä¸»åº“(æ­»æ‰çš„ä¸»åº“)çš„vipä¼šé€šè¿‡master_ip_failover_scriptæ¼‚ç§»åˆ°æ–°ä¸»åº“ å…³é—­æ•…éšœä¸»åº“çš„æœåŠ¡å™¨,é¿å…è„‘è£‚ Recovering a new master ä»å´©æºƒçš„ä¸»æœºä¸­ä¿å­˜äºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶ï¼ˆå¦‚æœå¯èƒ½ï¼‰ å¦‚æœå¯ä»¥é€šè¿‡SSHè®¿é—®å´©æºƒçš„ä¸»åº“,å¯ä»¥ä»æœ€æ–°çš„slaveçš„end_log_posï¼ˆRead_Master_Log_Posï¼‰ä½ç½®å¼€å§‹å¤åˆ¶äºŒè¿›åˆ¶æ—¥å¿—. é€‰ä¸¾æ–°ä¸»åº“ åŸºäºé…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®å’Œå½“å‰MySQLçš„è®¾ç½® å¦‚æœä½ å¸Œæœ›æŸäº›ä»åº“ä½œä¸ºä¼˜å…ˆå¤‡é€‰ä¸»åº“,å¯ä»¥åœ¨é…ç½®ä¸­æŒ‡å®šcandidate_master=1 å¦‚æœä½ å¸Œæœ›æŸäº›ä»åº“æ°¸è¿œä¸ä¼šæˆä¸ºæ–°ä¸»åº“,å¯ä»¥åœ¨é…ç½®ä¸­æŒ‡å®šno_master=1 è¯†åˆ«æœ€æ–°çš„ä»ä¼—(æ¥æ”¶äº†æœ€æ–°relay logçš„ä»åº“) æ¢å¤å¹¶æå‡æ–°ä¸»åº“ ç”Ÿæˆå·®å¼‚æ—¥å¿—ä¼ è¾“åˆ°æ–°ä¸»åº“ åº”ç”¨è¿™äº›å·®å¼‚æ—¥å¿—åˆ°æ–°ä¸»åº“ å¦‚æœå†æ¬¡é˜¶æ®µäº§ç”Ÿä»»ä½•é”™è¯¯(å¦‚,duplicate key error),MHA aborts,ä¹‹åçš„æ¢å¤æ­¥éª¤,åŒ…æ‹¬æ¢å¤å…¶ä½™ä»åº“å°†ä¸ä¼šå‘ç”Ÿ æ¿€æ´»æ–°ä¸»åº“ å¦‚æœæ‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†master_ip_failover_scriptï¼Œåˆ™MHAä¼šè°ƒç”¨è¯¥è„šæœ¬ æ‚¨å¯ä»¥æ‰§è¡Œä»»ä½•æ“ä½œï¼Œä¾‹å¦‚æ¿€æ´»å½“å‰ä¸»æ§çš„IPåœ°å€ï¼Œåˆ›å»ºç‰¹æƒç”¨æˆ·ç­‰ æ¢å¤å…¶ä»–ä»åº“ æ¢å¤å…¶ä½™ä»åº“ å¹¶è¡Œçš„ä¸ºæ‰€æœ‰ä»åº“ç”Ÿæˆå·®å¼‚æ—¥å¿— å¹¶è¡Œçš„ä¸ºæ‰€æœ‰ä»åº“åº”ç”¨å·®å¼‚æ—¥å¿— change masteråˆ°æ–°ä¸»åº“,å¹¶start slave å³ä½¿åœ¨æ­¤é˜¶æ®µå‘ç”Ÿæ¢å¤é”™è¯¯,MHAä¹Ÿä¸ä¼šç»ˆæ­¢.æ•…éšœçš„ä»åº“å°†ä¸ä¼šä»æ–°ä¸»åº“å¤åˆ¶,è€Œå…¶ä»–æˆåŠŸæ¢å¤çš„ä»åº“å¯ä»¥å¯åŠ¨å¤åˆ¶ é€šçŸ¥(å¯é€‰) å¦‚æœä½ åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†report_script,MHAä¼šè°ƒç”¨æ­¤è„šæœ¬,å†æ¬¡è„šæœ¬ä¸­ä½ å¯ä»¥åšä»»ä½•ä½ æƒ³åšçš„äº‹,ä¾‹å¦‚: å‘é€é‚®ä»¶ åœæ­¢æ–°ä¸»åº“å¾—å®šæ—¶å¤‡ä»½ä»»åŠ¡(å› ä¸ºæˆ‘ä»¬ä¸€èˆ¬å¸Œæœ›å¤‡ä»½åœ¨ä»åº“åš,æ–°ä¸»åº“åº”å–æ¶ˆå®šæ—¶å¤‡ä»½ä»»åŠ¡) æ›´ç»†å†…éƒ¨ç®¡ç†å·¥å…·çŠ¶æ€,ç­‰ç­‰ MHAåœ¨åœ¨çº¿åˆ‡æ¢æ˜¯åšäº†ä»€ä¹ˆ ä»¥ä¸‹æ­¥éª¤å¯ä»¥é€šè¿‡masterha_master_switchå‘½ä»¤ï¼ˆä½¿ç”¨â€“master_state = aliveå‚æ•°ï¼‰å®Œæˆã€‚ éªŒè¯å¤åˆ¶è®¾ç½®å¹¶è¯†åˆ«å½“å‰ä¸»åº“ é€šè¿‡è¿æ¥é…ç½®æ–‡ä»¶ä¸­æè¿°çš„æ‰€æœ‰ä¸»æœºæ¥è¯†åˆ«å½“å‰ä¸»åº“ åœ¨å½“å‰ä¸»åº“æ‰§è¡ŒFLUSH TABLES(å¯é€‰).è¿™ä¸€æ“ä½œç”¨æ¥æœ€å°åŒ–ä¹‹åçš„FLUSH TABLES WITH READ LOCKæ—¶é—´ æ£€æŸ¥MHAä¸»åº“ç›‘æ§å’Œfailoveræ˜¯å¦æ­£åœ¨è¿è¡Œ æ£€æŸ¥æ˜¯å¦ç¬¦åˆä»¥ä¸‹æ¡ä»¶ æ‰€æœ‰ä»åº“ä¸Šçš„IOçº¿ç¨‹æ­£åœ¨è¿è¡Œ æ‰€æœ‰ä»åº“ä¸Šçš„SQLçº¿ç¨‹æ­£åœ¨è¿è¡Œ æ‰€æœ‰ä»åº“çš„Seconds_Behind_Masterå°äº2ç§’(å¯ä»¥ç”¨è¿‡â€”running_updates_limit=Næ›´æ”¹) åœ¨ä¸»åº“ä¸Š,é€šè¿‡show processlistè¾“å‡ºä¸­æ²¡æœ‰æ‰§è¡Œè¶…è¿‡2ç§’çš„updateè¯­å¥ è¯†åˆ«æ–°ä¸»åº“ æ–°ä¸»åº“å¯ä»¥é€šè¿‡â€â€”new_master_hostâ€å‚æ•°æŒ‡å®š.å¦åˆ™å—,å°†ä»é…ç½®æ–‡ä»¶ä¸­è‡ªåŠ¨è¯†åˆ«æ–°çš„ä¸»åº“. æºä¸»åº“å’Œæ–°ä¸»åº“å¿…é¡»æ‹¥æœ‰ä¸€è‡´çš„è¿‡æ»¤è§„åˆ™(binlog-do-db and binlog-ignore-db) æ‹’ç»å½“å‰ä¸»åº“çš„å†™å…¥ å¦‚æœæ‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†master_ip_online_change_scriptå‚æ•°ï¼ŒMHAä¼šè°ƒç”¨è¯¥è„šæœ¬ã€‚ æ‚¨å¯ä»¥ä¼˜é›…åœ°é˜»æ­¢å†™å…¥ï¼ˆå³åˆ é™¤å†™å…¥ç”¨æˆ·ï¼Œæ‰§è¡ŒSET GLOBAL read_only = 1ç­‰ï¼‰ åœ¨å½“å‰ä¸»æœºä¸Šæ‰§è¡ŒFLUSH TABLE WITH READ LOCKæ¥é˜»æ­¢æ‰€æœ‰å†™å…¥ï¼ˆå¯ä»¥ä½¿ç”¨â€“skip_lock_all_tableså‚æ•°è·³è¿‡ï¼‰ ç­‰å¾…æ‰€æœ‰ä»åº“è¿½ä¸Šå¤åˆ¶è¿›åº¦ è¿™é‡Œä¼šä½¿ç”¨MASTER_LOG_POS()å‡½æ•° èµ‹äºˆæ–°ä¸»åº“å†™å…¥æƒé™ æ‰§è¡Œshow master statusæ¥è·å–æ–°ä¸»åº“å¾—fileå’Œposition å¦‚æœä½ åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†master_ip_online_change_script,MHAä¼šè°ƒç”¨æ¬¡è„šæœ¬.ä½ å¯ä»¥åœ¨è„šæœ¬é‡Œæ‰§è¡Œåˆ›å»ºç”¨æˆ·,set GLOBAL read_only=0ç­‰æ“ä½œ ä¸ºå…¶ä»–æ‰€æœ‰ä»åº“åˆ‡æ¢æ–°ä¸»åº“ æ‰€æœ‰ä»åº“å¹¶å‘çš„æ‰§è¡Œchange master,start slave","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"MHAé…ç½®æ–‡ä»¶","slug":"MHA é…ç½®æ–‡ä»¶","date":"2017-07-20T14:00:00.000Z","updated":"2017-08-04T15:43:08.000Z","comments":true,"path":"2017/07/20/MHA é…ç½®æ–‡ä»¶/","link":"","permalink":"http://fuxkdb.com/2017/07/20/MHA%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","excerpt":"MHA é…ç½®æ–‡ä»¶ åˆ›å»ºapplicationé…ç½®æ–‡ä»¶ åˆ›å»ºglobalé…ç½®æ–‡ä»¶ Binlog server åˆ›å»ºapplicationé…ç½®æ–‡ä»¶ç¤ºä¾‹","text":"MHA é…ç½®æ–‡ä»¶ åˆ›å»ºapplicationé…ç½®æ–‡ä»¶ åˆ›å»ºglobalé…ç½®æ–‡ä»¶ Binlog server åˆ›å»ºapplicationé…ç½®æ–‡ä»¶ç¤ºä¾‹manager_host$ cat /etc/app1.cnf 12345678910111213141516171819[server default]# mysql user and passworduser=rootpassword=mysqlpass# working directory on the managermanager_workdir=/var/log/masterha/app1# manager log filemanager_log=/var/log/masterha/app1/app1.log# working directory on MySQL serversremote_workdir=/var/log/masterha/app1[server1]hostname=host1[server2]hostname=host2[server3]hostname=host3 æ‰€æœ‰å‚æ•°å¿…é¡»éµå¾ªâ€param = valueâ€è¯­æ³•ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹å‚æ•°è®¾ç½®ä¸æ­£ç¡®ã€‚ 1234[server1]hostname=host1# incorrect: must be &quot;no_master=1&quot; åº”è¯¥å†™æˆno_master=1no_master [server default]åŒºå—å†…çš„å‚æ•°å¯¹æ‰€æœ‰[serverN]ç”Ÿæ•ˆ,[serverN]åº”è¯¥é…ç½®æ¯ä¸ªserverç‰¹å®šçš„å‚æ•° åˆ›å»ºglobalé…ç½®æ–‡ä»¶å¦‚æœä½ è®¡åˆ’ä½¿ç”¨ä¸€ä¸ªMHA Managerç®¡ç†ä¸¤ä¸ªæˆ–æ›´å¤šçš„applications(å¤šä¸ªä¸»ä»å¯¹),å¯ä»¥åˆ›å»ºä¸€ä¸ªglobalé…ç½®æ–‡ä»¶ç®¡ç†é€šç”¨å‚æ•°.MHA Manageré»˜è®¤ä¼šå»/etc/masterha_default.cnfè¯»å–globalé…ç½®æ–‡ä»¶ globalé…ç½®æ–‡ä»¶ç¤ºä¾‹: Global configuration file (/etc/masterha_default.cnf) 1234567891011[server default]user=rootpassword=rootpassssh_user=rootmaster_binlog_dir= /var/lib/mysqlremote_workdir=/data/log/masterhasecondary_check_script= masterha_secondary_check -s remote_host1 -s remote_host2ping_interval=3master_ip_failover_script=/script/masterha/master_ip_failovershutdown_script= /script/masterha/power_managerreport_script= /script/masterha/send_master_failover_mail ä»¥ä¸Šå‚æ•°åœ¨ä¸¤ä¸ªapplicationé—´æ˜¯å…¬ç”¨çš„ æ¯ä¸ªapplicationéœ€è¦å•ç‹¬æŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶.ä»¥ä¸‹ç¤ºä¾‹ä¸ºapp1(host1-4)å’Œapp2(host11-14)çš„é…ç½®æ–‡ä»¶ app1: manager_host$ cat /etc/app1.cnf 123456789101112131415161718[server default]manager_workdir=/var/log/masterha/app1manager_log=/var/log/masterha/app1/app1.log[server1]hostname=host1candidate_master=1[server2]hostname=host2candidate_master=1[server3]hostname=host3[server4]hostname=host4no_master=1 ä»¥ä¸Šé…ç½®å•ç‹¬æŒ‡å®šäº†app1çš„manager_workdirå’Œmanager_logç­‰ä¿¡æ¯.å¯¹äºç®¡ç†å¤šä¸ªapplicationçš„æƒ…å†µ,åº”å½“å•ç‹¬ä¸ºæ¯ä¸ªappè®¾ç½®manager_workdirå’Œmanager_log app2: manager_host$ cat /etc/app2.cnf 123456789101112131415161718[server default]manager_workdir=/var/log/masterha/app2manager_log=/var/log/masterha/app2/app2.log[server1]hostname=host11candidate_master=1[server2]hostname=host12candidate_master=1[server3]hostname=host13[server4]hostname=host14no_master=1 å¦‚æœä½ åŒæ—¶åœ¨globalé…ç½®æ–‡ä»¶å’Œapplicationé…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†åŒä¸€ä¸ªå‚æ•°,é‚£ä¹ˆåè€…(application)ä¼šè¦†ç›–å‰è€…. Binlog serverä»MHA 0.56ç‰ˆæœ¬å¼€å§‹,MHAæ”¯æŒæ–°åŒºå—[binlogN].åœ¨binlogåŒºå—ä½ å¯ä»¥å®šä¹‰mysqlbinlog streaming servers.å½“MHAä½¿ç”¨åŸºäºGTIDçš„failover,MHAä¼šæ£€æŸ¥binlog servers,å¦‚æœbinlog serverçš„æ—¥å¿—&gt;å…¶ä»–ä»åº“,MHAä¼šä»binlog serverè·å–binlog eventåº”ç”¨åˆ°slave.å½“MHAä½¿ç”¨åŸºäºä¼ ç»Ÿå¤åˆ¶çš„failover,MHAä¼šå¿½ç•¥binlog servers. ä¸‹é¢æ˜¯ç¤ºä¾‹é…ç½® manager_host$ cat /etc/app1.cnf 12345678910111213141516171819202122232425[server default]# mysql user and passworduser=rootpassword=mysqlpass# working directory on the managermanager_workdir=/var/log/masterha/app1# manager log filemanager_log=/var/log/masterha/app1/app1.log# working directory on MySQL serversremote_workdir=/var/log/masterha/app1[server1]hostname=host1[server2]hostname=host2[server3]hostname=host3[binlog1]hostname=binlog_host1[binlog2]hostname=binlog_host2","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"masterha_managerå‚æ•°è¯´æ˜","slug":"masterha_managerå‚æ•°è¯´æ˜","date":"2017-07-20T14:00:00.000Z","updated":"2017-08-04T15:45:59.000Z","comments":true,"path":"2017/07/20/masterha_managerå‚æ•°è¯´æ˜/","link":"","permalink":"http://fuxkdb.com/2017/07/20/masterha_manager%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E/","excerpt":"masterha_manager: Command to run MHA ManagerMHA Manager can be started by executing masterha_manager command. 12# masterha_manager --conf=/etc/conf/masterha/app1.cnf masterha_manager takes below arguments. Common arguments","text":"masterha_manager: Command to run MHA ManagerMHA Manager can be started by executing masterha_manager command. 12# masterha_manager --conf=/etc/conf/masterha/app1.cnf masterha_manager takes below arguments. Common arguments â€“conf=(config file path) Application and local scope configuration file. This argument is mandatory. â€“global_conf=(global config file path) Global scope configuration file. Default is /etc/masterha_default.cnf â€“manager_workdir, â€“workdir Same as manager_workdir parameter. â€“manager_log, â€“log_output Same as manager_log parameter. Monitoring specific arguments â€“wait_on_monitor_error=(seconds) å¦‚æœå†ç›‘æ§è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯,masterha_manager sleep wait_on_monitor_error ç§’ç„¶åé€€å‡º.é»˜è®¤å€¼æ˜¯0.æ­¤åŠŸèƒ½ä¸»è¦ç”¨äºä»å®ˆæŠ¤ç¨‹åºè„šæœ¬æ‰§è¡Œè‡ªåŠ¨åŒ–ä¸»ç›‘æ§å’Œæ•…éšœè½¬ç§»ã€‚ åœ¨é‡æ–°å¯åŠ¨ç›‘è§†ä¹‹å‰ç­‰å¾…ä¸€æ®µæ—¶é—´çš„é”™è¯¯æ˜¯éå¸¸åˆç†çš„ã€‚ This functionality is mainly introduced for doing automated master monitoring and failover from daemon scripts. It is pretty reasonable for waiting for some time on errors before restarting monitoring again. â€“ignore_fail_on_start å½“æœ‰slave èŠ‚ç‚¹å®•æ‰æ—¶ï¼Œé»˜è®¤æ˜¯å¯åŠ¨ä¸äº†çš„ï¼ŒåŠ ä¸Š â€“ignore_fail_on_start å³ä½¿æœ‰èŠ‚ç‚¹å®•æ‰ä¹Ÿèƒ½å¯åŠ¨MHAï¼ŒåŠ ä¸Šè¯¥å‚æ•°ä¼šå¿½ç•¥å¯åŠ¨æ–‡ä»¶ä¸­é…ç½®ignore_fail=1çš„server Failover specific arguments â€“last_failover_minute=(minutes) 1å½“æœ€è¿‘çš„ä¸€ä¸ªfailover åˆ‡æ¢å‘ç”Ÿåœ¨last_failover_minute(é»˜è®¤ä¸º8å°æ—¶) ä¹‹å†…ï¼ŒMHA manager å°†ä¸ä¼šåœ¨åˆ‡æ¢ã€‚å› ä¸ºå®ƒä¼šè®¤ä¸ºæœ‰äº›é—®é¢˜æ²¡æœ‰å¾—åˆ°è§£å†³ã€‚å¦‚æœè®¾ç½®äº† --ignore_last_failover å‚æ•°ï¼Œå‚æ•°(--last_failover_minute) å°†ä¼šå¤±æ•ˆ â€“ignore_last_failover 1å¦‚æœæœ€è¿‘failover å¤±è´¥ï¼ŒMHA å°†ä¸ä¼šå†æ¬¡å¼€å§‹failoveræœºåˆ¶ï¼Œå› ä¸ºè¿™ä¸ªé—®é¢˜å¯èƒ½å†æ¬¡å‘ç”Ÿã€‚å¸¸è§„æ­¥éª¤:æ‰‹åŠ¨æ¸…ç†failover é”™è¯¯æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ä¸€èˆ¬åœ¨manager_workdir/app_name.failover.erroræ–‡ä»¶ï¼Œç„¶ååœ¨å¯åŠ¨failoveræœºåˆ¶ã€‚å¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼ŒMHA å°†ä¼šç»§ç»­failover ä¸ç®¡ä¸Šæ¬¡çš„failoverçŠ¶æ€ â€“wait_on_failover_error=(seconds) åœ¨failoverçš„è¿‡ç¨‹ï¼Œå½“å‘å‡ºé”™è¯¯äº†ï¼Œmasterha_manager ç­‰å¾… wait_no_failover_error çš„æ—¶é—´åï¼Œé€€å‡ºã€‚å¦‚æœè®¾ç½®ä¸ºäº†0ï¼Œç›´æ¥é€€å‡ºã€‚è¿™ä¸ªå¥½å¤„ï¼Œæ˜¯å½“åå°è¿è¡Œmaster monitor å’Œ failover scriptsçš„æ—¶å€™ï¼Œmasterha_manager å¯ä»¥åœ¨ wait_no_failover_error æ—¶é—´åˆ°è¾¾ä¹‹å‰é‡å¯ç›‘æ§ â€“remove_dead_master_conf 12å¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå½“æˆåŠŸfailoveråï¼ŒMHA managerå°†ä¼šè‡ªåŠ¨åˆ é™¤é…ç½®æ–‡ä»¶ä¸­å…³äºdead masterçš„é…ç½®é€‰é¡¹ã€‚ eg: For example, if the dead master&#x27;s hostname is host1 and it belongs to the section of server1, the entire part of the server1 will be removed from the configuration file. By default, the configuration file is not modified at all. After MHA finishes failover, the section of the dead master still exists. If you start masterha_manager immediately (this includes automatic restart from any daemon program), masterha_manager stops with an error that &quot;there is a dead slave&quot; (previous dead master). You might want to change this behavior especially if you want to continuously monitor and failover MySQL master automatically. In such cases, --remove_dead_master_conf argument is helpful.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"MHA Tutorial","slug":"MHA Tutorial","date":"2017-07-19T15:00:00.000Z","updated":"2017-08-04T15:45:47.000Z","comments":true,"path":"2017/07/19/MHA Tutorial/","link":"","permalink":"http://fuxkdb.com/2017/07/19/MHA%20Tutorial/","excerpt":"MHA Tutorialç®€å•æ•…éšœè½¬ç§»æ„å»ºå¤åˆ¶ç¯å¢ƒMHAä¸ä¼šå¸®ä½ æ­å»ºå¤åˆ¶ç¯å¢ƒ,æ‰€ä»¥ä½ éœ€è¦è‡ªå·±æ­å»ºå¤åˆ¶.æ¢å¥è¯è¯´,ä½ å¯ä»¥åœ¨å·²æœ‰ç¯å¢ƒä¸­ä½¿ç”¨MHA.ä¸¾ä¸ªä¾‹å­,å‡è®¾æœ‰å››å°ä¸»æœº:host1,host2,host3,host4.ä¸»åº“è¿è¡Œåœ¨host1,ä¸¤ä¸ªä»åº“åˆ†åˆ«è¿è¡Œåœ¨host2å’Œhost3,è€Œhost4è´Ÿè´£è¿è¡ŒMHA Manager. åœ¨host1-host4å®‰è£…MHA NodeSee Installing MHA Node","text":"MHA Tutorialç®€å•æ•…éšœè½¬ç§»æ„å»ºå¤åˆ¶ç¯å¢ƒMHAä¸ä¼šå¸®ä½ æ­å»ºå¤åˆ¶ç¯å¢ƒ,æ‰€ä»¥ä½ éœ€è¦è‡ªå·±æ­å»ºå¤åˆ¶.æ¢å¥è¯è¯´,ä½ å¯ä»¥åœ¨å·²æœ‰ç¯å¢ƒä¸­ä½¿ç”¨MHA.ä¸¾ä¸ªä¾‹å­,å‡è®¾æœ‰å››å°ä¸»æœº:host1,host2,host3,host4.ä¸»åº“è¿è¡Œåœ¨host1,ä¸¤ä¸ªä»åº“åˆ†åˆ«è¿è¡Œåœ¨host2å’Œhost3,è€Œhost4è´Ÿè´£è¿è¡ŒMHA Manager. åœ¨host1-host4å®‰è£…MHA NodeSee Installing MHA Node åœ¨host4å®‰è£…MHA ManagerSee Installing MHA Manager .ç›‘æ§èŠ‚ç‚¹éœ€è¦åŒæ—¶å®‰è£…MHA Nodeå’ŒMHA Manager åˆ›å»ºé…ç½®æ–‡ä»¶1234567891011121314151617181920manager_host$ cat /etc/app1.cnf[server default]# mysql user and passworduser=rootpassword=mysqlpassssh_user=root# working directory on the managermanager_workdir=/var/log/masterha/app1# working directory on MySQL serversremote_workdir=/var/log/masterha/app1[server1]hostname=host1[server2]hostname=host2[server3]hostname=host3 æ— éœ€æŒ‡å®šhost1ä¸ºmaster,MHAä¼šè‡ªåŠ¨æ¢æµ‹å‡ºè°æ˜¯master æ£€æŸ¥SSHäº’ä¿¡MHA Managerå†…éƒ¨é€šè¿‡SSHè°ƒç”¨åŒ…å«åœ¨MHA NodeåŒ…ä¸­çš„ç¨‹åº.MHA NodeåŒæ ·é€šè¿‡SSH(scp)ä¼ é€’å·®å¼‚ä¸­ç»§æ—¥å¿—åˆ°no-latest slave.ä¸ºäº†ä½¿è¿™äº›è¿‡ç¨‹ä¸éœ€è¦æ‰‹åŠ¨äº¤äº’,å¿…é¡»è¦é…ç½®SSHå…¬é’¥éªŒè¯.MHA Manageræä¾›äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬â€masterha_check_sshâ€æ¥éªŒè¯å„ä¸ªèŠ‚ç‚¹æ˜¯éé…ç½®å¥½äº†SSHäº’ä¿¡. 12345678910111213141516171819# masterha_check_ssh --conf=/etc/app1.cnfSat May 14 14:42:19 2011 - [warn] Global configuration file /etc/masterha_default.cnf not found. Skipping.Sat May 14 14:42:19 2011 - [info] Reading application default configurations from /etc/app1.cnf..Sat May 14 14:42:19 2011 - [info] Reading server configurations from /etc/app1.cnf..Sat May 14 14:42:19 2011 - [info] Starting SSH connection tests..Sat May 14 14:42:19 2011 - [debug] Connecting via SSH from root@host1(192.168.0.1) to root@host2(192.168.0.2)..Sat May 14 14:42:20 2011 - [debug] ok.Sat May 14 14:42:20 2011 - [debug] Connecting via SSH from root@host1(192.168.0.1) to root@host3(192.168.0.3)..Sat May 14 14:42:20 2011 - [debug] ok.Sat May 14 14:42:21 2011 - [debug] Connecting via SSH from root@host2(192.168.0.2) to root@host1(192.168.0.1)..Sat May 14 14:42:21 2011 - [debug] ok.Sat May 14 14:42:21 2011 - [debug] Connecting via SSH from root@host2(192.168.0.2) to root@host3(192.168.0.3)..Sat May 14 14:42:21 2011 - [debug] ok.Sat May 14 14:42:22 2011 - [debug] Connecting via SSH from root@host3(192.168.0.3) to root@host1(192.168.0.1)..Sat May 14 14:42:22 2011 - [debug] ok.Sat May 14 14:42:22 2011 - [debug] Connecting via SSH from root@host3(192.168.0.3) to root@host2(192.168.0.2)..Sat May 14 14:42:22 2011 - [debug] ok.Sat May 14 14:42:22 2011 - [info] All SSH connection tests passed successfully. æ£€æŸ¥å¤åˆ¶é…ç½®ä¸ºäº†ä½¿MHAå¯ä»¥å·¥ä½œ,æ‰€æœ‰åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸»ä»éœ€è¦æ­£å¸¸è¿è¡Œ.MHA Manageræä¾›äº†ä¸€ä¸ªå‘½ä»¤masterha_check_replæ¥å¿«é€Ÿæ£€æŸ¥å¤åˆ¶è¿è¡ŒçŠ¶å†µã€‚ 123manager_host$ masterha_check_repl --conf=/etc/app1.cnf...MySQL Replication Health is OK. å¦‚æœæ‚¨åœ¨æ­¤å¤„é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—å¹¶è§£å†³é—®é¢˜ã€‚ å½“å‰ä¸»åº“ä¸èƒ½æ˜¯ä»åº“(æ„æ€æ˜¯ä¸èƒ½ä½¿å…¶ä»–mysqlçš„ä»åº“)ï¼Œæ‰€æœ‰å…¶ä»–ä»åº“å¿…é¡»ä»ä¸»åº“å¤åˆ¶ã€‚ TypicalErrorsé¡µé¢å¯èƒ½æœ‰åŠ©äºä¿®å¤è®¾ç½®é”™è¯¯ã€‚ å¯åŠ¨Manager1nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /data/masterha/app1/log/manager.log 2&gt;&amp;1 &amp; å¦‚æœæ‰€æœ‰é…ç½®éƒ½æœ‰æ•ˆ,masterha_managerä¼šæŒç»­æ£€æŸ¥MySQLä¸»åº“çš„å¯ç”¨æ€§,çŸ¥é“ä¸»åº“å®•æœº.é»˜è®¤masterha_managerä¼šæ‰“å°é”™è¯¯åˆ°æ ‡å‡†è¾“å‡º,ä½†æ˜¯å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é€šè¿‡manager_logé…ç½®å‚æ•°æ›´æ”¹ä½ç½®.å…¸å‹çš„masterha_manageré”™è¯¯æ˜¯MySQLå¤åˆ¶é…ç½®æ— æ•ˆ,ssh_useræ²¡æœ‰è¶³å¤Ÿçš„æƒé™(æœ€å°è¦æ±‚æ˜¯æœ‰è¯»å–relay logæƒé™å’Œå†™remote_workdiræƒé™).é»˜è®¤masterha_manageråœ¨å‰å°è¿è¡Œ.å¦‚æœå‘é€SIGINT(Ctrl+C)åˆ°masterha_manager,masterha_managerå°†åœæ­¢ç›‘æ§å¹¶é€€å‡º æ£€æŸ¥ManagerçŠ¶æ€MHA Managerå¼€å§‹ç›‘æ§MySQL masteråä¸ä¼šæ‰“å°ä»»ä½•æ—¥å¿—ä¿¡æ¯çŸ¥é“ä¸»åº“æ— æ³•è®¿é—®æˆ–è€…Manageræœ¬èº«è¢«ç»ˆæ­¢.å¯ä»¥é€šè¿‡masterha_check_statuså‘½ä»¤æ£€æŸ¥MHA Managerè¿è¡ŒçŠ¶æ€. 12manager_host$ masterha_check_status --conf=/etc/app1.cnfapp1 (pid:5057) is running(0:PING_OK), master:host1 â€œapp1â€æ˜¯MHAå†…éƒ¨å¤„ç†çš„åº”ç”¨ç¨‹åºåç§°ï¼Œå®ƒæ˜¯é…ç½®æ–‡ä»¶çš„å‰ç¼€åç§°ã€‚ å¦‚æœmanagerè¢«åœæ­¢æˆ–é…ç½®æ–‡ä»¶æ— æ•ˆï¼Œå°†è¿”å›ä»¥ä¸‹é”™è¯¯ã€‚ 12manager_host$ masterha_check_status --conf=/etc/app1.cnfapp1 is stopped(1:NOT_RUNNING). åœæ­¢Managerä½ å¯ä»¥é€šè¿‡masterha_stopåœæ­¢MHA Manager 12manager_host$ masterha_stop --conf=/etc/app1.cnfStopped app1 successfully. æµ‹è¯•master failoverNow MHA Manager monitors MySQL master server availability. Next, letâ€™s test that master failover works correctly. To simulate this, you can simply kill mysqld on the master. 12host1$ killall -9 mysqld mysqld_safe On some distributions like Ubuntu, mysqld will be automatically restarted by angel process. If mysqld restarts very quickly (a few seconds), pings from MHA will succeed again before MHA starts failover. In such cases, failover does not start. If restarting mysqld takes long time (i.e. taking 2 minutes for InnoDB crash recovery), failover will start. If you have difficulties for testing killing mysqld or if you want to test Linux kernel side problem, invoking kernel panic is easy. 12host1# echo c &gt; /proc/sysrq-trigger Check logs on MHA manager, and verify that host2 becomes new mater, and host3 replicates from host2. When failover completes (or ends with errors), MHA Manager process stops. This is an expected behavior. If you want to run MHA Manager permanently, please read â€œRunning MHA Manager in backgroundâ€ section.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"MHA Overview","slug":"MHA Overview","date":"2017-07-19T14:00:00.000Z","updated":"2017-08-04T15:45:52.000Z","comments":true,"path":"2017/07/19/MHA Overview/","link":"","permalink":"http://fuxkdb.com/2017/07/19/MHA%20Overview/","excerpt":"MHAæ¦‚è§ˆMHAèƒ½å¤Ÿå®ç°è‡ªåŠ¨åŒ–çš„master failoverå’Œä»åº“å‡çº§ä¸ºnew master,é€šå¸¸è¿™ä¸€è¿‡ç¨‹åªéœ€è¦10-30ç§’çš„åœæœºæ—¶é—´.MHAæœ€å¤§ç¨‹åº¦ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§,å¯¹æ€§èƒ½é›¶å½±å“,æ˜“äºå®‰è£…,å¹¶ä¸”ä¸éœ€è¦æ”¹å˜ç°æœ‰éƒ¨ç½²æƒ…å†µ. MHAæ”¯æŒè®¡åˆ’æ€§åœ¨çº¿ä¸»åº“åˆ‡æ¢,åœ¨çŸ­æ—¶é—´å†…(0.5-2ç§’)çš„åœæœºæ—¶é—´(ä»…é™é˜»å¡å†™å…¥)ï¼Œå°†å½“å‰è¿è¡Œçš„ä¸»æœºå®‰å…¨åœ°æ›´æ”¹ä¸ºæ–°ä¸»æœº. MHAæä¾›ä»¥ä¸‹åŠŸèƒ½,å¹¶ä¸”å¯ç”¨äºéœ€è¦é«˜å¯ç”¨æ€§,æ•°æ®å®Œæ•´æ€§å’Œè¿‘ä¹ä¸é—´æ–­ä¸»åº“ç»´æŠ¤çš„è®¸å¤šéƒ¨ç½²ä¸­. Automated master monitoring and failover","text":"MHAæ¦‚è§ˆMHAèƒ½å¤Ÿå®ç°è‡ªåŠ¨åŒ–çš„master failoverå’Œä»åº“å‡çº§ä¸ºnew master,é€šå¸¸è¿™ä¸€è¿‡ç¨‹åªéœ€è¦10-30ç§’çš„åœæœºæ—¶é—´.MHAæœ€å¤§ç¨‹åº¦ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§,å¯¹æ€§èƒ½é›¶å½±å“,æ˜“äºå®‰è£…,å¹¶ä¸”ä¸éœ€è¦æ”¹å˜ç°æœ‰éƒ¨ç½²æƒ…å†µ. MHAæ”¯æŒè®¡åˆ’æ€§åœ¨çº¿ä¸»åº“åˆ‡æ¢,åœ¨çŸ­æ—¶é—´å†…(0.5-2ç§’)çš„åœæœºæ—¶é—´(ä»…é™é˜»å¡å†™å…¥)ï¼Œå°†å½“å‰è¿è¡Œçš„ä¸»æœºå®‰å…¨åœ°æ›´æ”¹ä¸ºæ–°ä¸»æœº. MHAæä¾›ä»¥ä¸‹åŠŸèƒ½,å¹¶ä¸”å¯ç”¨äºéœ€è¦é«˜å¯ç”¨æ€§,æ•°æ®å®Œæ•´æ€§å’Œè¿‘ä¹ä¸é—´æ–­ä¸»åº“ç»´æŠ¤çš„è®¸å¤šéƒ¨ç½²ä¸­. Automated master monitoring and failover MHAå¯ä»¥åœ¨ç°æœ‰çš„å¤åˆ¶ç¯å¢ƒä¸­ç›‘æ§ä¸»åº“çŠ¶æ€,åœ¨æ£€æµ‹åˆ°ä¸»åº“æ•…éšœæ—¶æ‰§è¡Œè‡ªåŠ¨åˆ‡æ¢.MHAé€šè¿‡ä»æ‹¥æœ‰æœ€æ–°æ•°æ®çš„slaveè¯†åˆ«ä¸å…¶ä»–slaveçš„æ•°æ®å·®å¼‚,è·å–å·®å¼‚relay logå¹¶åº”ç”¨è‡³æ‰€æœ‰éœ€è¦åŒæ­¥çš„slaveæ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§.MHAå¯ä»¥åœ¨å‡ ç§’é’Ÿå†…å®Œæˆæ•…éšœè½¬ç§»:9-12ç§’é’Ÿå¯ä»¥æ£€æµ‹åˆ°ä¸»åº“æ•…éšœ,7-10ç§’å†…å…³é—­ä¸»æœºä»¥é¿å…è„‘è£‚(å¯é€‰æ‹©ä¸power offä¸»æœåŠ¡å™¨),å‡ ç§’é’Ÿå†…å°†å·®å¼‚ä¸­çº§æ—¥å¿—åº”ç”¨äºæ–°ä¸»åº“. æ€»åœæœºæ—¶é—´é€šå¸¸ä¸º10-30ç§’.å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šå€™é€‰ä¸»åº“.ç”±äºMHAä¿è¯äº†ä»åº“é—´çš„æ•°æ®ä¸€è‡´æ€§,å› æ­¤ä»»ä½•ä»åº“éƒ½èƒ½æå‡ä¸ºæ–°çš„ä¸»åº“.(ä¸»è¦èƒ½å¤Ÿè¿é€šä¸»æœåŠ¡å™¨,è·å–æ—¥å¿—,ç†è®ºä¸Šä¸»å’Œæ‰€æœ‰ä»åº“éƒ½èƒ½ä¿è¯ä¸€è‡´æ€§) äº¤äº’å¼Master Failover MHAå¯ä»¥æ‰‹åŠ¨ï¼ˆéè‡ªåŠ¨ï¼‰ï¼Œäº¤äº’å¼æ•…éšœåˆ‡æ¢ï¼Œè€Œä¸å¼€å¯ä¸»åº“ç›‘æ§ã€‚ é»˜è®¤æ˜¯å¼€å¯masterha_managerç›‘æ§,å‘ç°ä¸»åº“æ•…éšœæ—¶ä¼šè‡ªåŠ¨failoverå’Œé€‰æ‹©æ–°ä¸»åº“,è¿™é‡Œè¯´çš„æ˜¯ä¸å¼€masterha_manager,æ‰‹åŠ¨ä½¿ç”¨masterha_master_switchåˆ‡æ¢ä¸»åº“.äº¤äº’å¼æ˜¯æŒ‡åˆ‡æ¢è¿‡ç¨‹ä¸­éœ€è¦ç”¨æˆ·è¾“å…¥yes/noæ¥é€‰æ‹©æ˜¯å¦ç»§ç»­æ‰§è¡Œ éäº¤äº’å¼Master Failover MHAä¹Ÿæ”¯æŒéäº¤äº’å¼è‡ªåŠ¨Master Failoverè€Œä¸ä½¿ç”¨MHAç›‘æ§ä¸»åº“.è¿™ä¸ªåŠŸèƒ½å¯¹äºå·²ç»é…ç½®äº†å…¶ä»–MySQL masterç›‘æ§è½¯ä»¶çš„æƒ…æ™¯.ä¾‹å¦‚,ä½ å¯ä»¥ä½¿ç”¨Pacemaker(Heartbeat)æ¥ç›‘æµ‹Masteræ•…éšœå’Œvipæ¥ç®¡,ç„¶åä½¿ç”¨MHAåšmaster failoverå’Œå°†slaveæå‡ä¸ºæ–°ä¸»åº“ è¿™é‡Œæ„æ€æ˜¯ä¸ä½¿ç”¨masterha_managerç›‘æ§ä¸»åº“çŠ¶æ€,è€Œæ˜¯æˆ‘ä»¬å·²ç»æœ‰äº†å…¶ä»–ç›‘æ§è½¯ä»¶,ä½†æ˜¯åœ¨å‘ç”Ÿæ•…éšœæ—¶è°ƒç”¨masterha_master_switchæ¥è¿›è¡Œå¤„ç† åœ¨çº¿åˆ‡æ¢ä¸»åº“ å½“ç°æœ‰ä¸»åº“éœ€è¦åšç¡¬ä»¶ç»´æŠ¤ç­‰æ“ä½œæ—¶,å¯ä»¥ä½¿ç”¨MHAæ›´ä¼˜é›…çš„åˆ‡æ¢ä¸»åº“,MHAä»…é˜»å¡0.5-2ç§’çš„å†™å…¥æ“ä½œå³å¯å®Œæˆä¸»åº“åˆ‡æ¢. Difficulties of Master Failoverä¸»æ•…éšœè½¬ç§»å¹¶ä¸åƒçœ‹èµ·æ¥é‚£ä¹ˆç®€å•ã€‚ä»¥æœ€ç»å…¸çš„ä¸€ä¸»å¤šä»æ¶æ„ä¸¾ä¾‹,å½“masterå‡ºç°æ•…éšœ,é€šå¸¸æˆ‘ä»¬ä¼šé€‰æ‹©ä¸€ä¸ªå’Œä¸»åº“æ•°æ®ä¸€è‡´(æˆ–è€…æœ€æ¥è¿‘çš„)çš„ä»åº“ä½œä¸ºæ–°çš„ä¸»åº“,ç„¶åå°†å…¶ä»–ä»åº“change masteråˆ°æ–°ä¸»åº“å¼€å¯å¤åˆ¶.è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå¾ˆå¤æ‚,å³ä¾¿å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªä¸åŸä¸»åº“ä¸€è‡´çš„ä»åº“åšä¸ºæ–°çš„ä¸»åº“,å…¶ä»–ä»åº“ä¹Ÿæœªå¿…æ˜¯åŒæ­¥çš„,å¦‚æœç›´æ¥change masterè€Œæ²¡æœ‰å…ˆè¡¥é½æ•°æ®å·®å¼‚,å°±ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´. MHAæ—¨åœ¨å°½å¯èƒ½å¿«çš„å®Œå…¨è‡ªåŠ¨åŒ–ä¸»åº“æ•…éšœè½¬ç§»å’Œæ¢å¤è¿‡ç¨‹,è€Œæ— éœ€ä»»ä½•å¤‡æœº.æ¢å¤è¿‡ç¨‹åŒ…æ‹¬é€‰æ‹©æ–°ä¸»åº“,è¯†åˆ«ä»åº“é—´relay logå·®å¼‚,å°†å¿…è¦çš„eventsåº”ç”¨åˆ°æ–°ä¸»åº“,åŒæ­¥å…¶ä»–ä»åº“å¹¶ä¸æ–°ä¸»åº“å»ºç«‹å¹¶å¯åŠ¨å¤åˆ¶.MHAé€šå¸¸å¯ä»¥åœ¨10-30ç§’çš„åœæœºæ—¶é—´å†…è¿›è¡Œæ•…éšœè½¬ç§»(10ç§’å†…æ£€æµ‹åˆ°ä¸»åº“æ•…éšœ,å¯é€‰çš„7-10ç§’å†…å…³é—­ä¸»åº“æœåŠ¡å™¨ä»¥é¿å…è„‘è£‚,å‡ ç§’é’Ÿç”¨äºæ¢å¤æ•°æ®è‡³ä¸€è‡´),å…·ä½“æ—¶é—´å–å†³äºå¤åˆ¶å»¶è¿Ÿåº¦. MHAæä¾›è‡ªåŠ¨å’Œæ‰‹åŠ¨æ•…éšœåˆ‡æ¢å‘½ä»¤.è‡ªåŠ¨æ•…éšœåˆ‡æ¢å‘½ä»¤â€œmasterha_managerï¼ˆMHA Managerï¼‰â€ç”±master monitoringå’Œmaster failoverç»„æˆã€‚ masterha_managerä¼šæ°¸ä¹…ç›‘æ§ä¸»æœåŠ¡å™¨çš„å¯ç”¨æ€§ã€‚ å¦‚æœMHA Manageræ— æ³•åˆ°è¾¾ä¸»æœåŠ¡å™¨ï¼Œåˆ™å®ƒå°†è‡ªåŠ¨å¯åŠ¨éäº¤äº’å¼æ•…éšœåˆ‡æ¢è¿‡ç¨‹ã€‚ æ‰‹åŠ¨æ•…éšœè½¬ç§»å‘½ä»¤â€œmasterha_master_switchâ€ä¼šæ£€æŸ¥masteræ˜¯å¦å‡ºç°äº†æ•…éšœ(dead)ã€‚ å¦‚æœmaster deadï¼Œmasterha_master_switchå°†å…¶ä¸­ä¸€ä¸ªä»åº“ä½œä¸ºæ–°çš„ä¸»åº“ï¼ˆæ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªé¦–é€‰ä¸»æœºï¼‰ï¼Œå¹¶å¯åŠ¨æ¢å¤å’Œæ•…éšœåˆ‡æ¢ã€‚ åœ¨å†…éƒ¨ï¼Œå®ƒåšçš„æ›´å¤šï¼Œä½†æ˜¯æ‚¨åªæ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œè€Œæ— éœ€è‡ªå·±æ‰§è¡Œå¤æ‚çš„æ¢å¤å’Œæ•…éšœè½¬ç§»æ“ä½œã€‚ MHAæ¶æ„When a master crashes, MHA recovers rest slaves as below. ä»åº“ä¸Šçš„relay logä¸­,ä¸»åº“çš„binary log positionså†™åœ¨end_log_poséƒ¨åˆ†(example).é€šè¿‡æ¯”è¾ƒä»åº“relay logä¸­æœ€åçš„end_log_pos,æˆ‘ä»¬å¯ä»¥ç¡®å®šå“ªäº›relay log eventsæ²¡æœ‰è¢«å‘é€åˆ°ä»åº“.MHAé€šè¿‡è¿™ä¸ªæœºåˆ¶æ¢å¤ä»åº“.In addition to basic algorithms covered in the slides at the MySQL Conf 2011, MHA does some optimizations and enhancements, such as generating differential relay logs very quickly (indenpendent from relay log file size), making recovery work with row based formats, etc. MHAç»„ä»¶MHAç”±MHA Managerå’ŒMHA Nodeç»„æˆ. Managerå¯ä»¥ç®¡ç†å¤šä¸ª å¤åˆ¶é›†ç¾¤ masterha_manager:æä¾›å®ç°è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ•…éšœè½¬ç§»çš„å‘½ä»¤ masterha_check_ssh æ£€æŸ¥MHAçš„SSHé…ç½®çŠ¶å†µmasterha_check_repl æ£€æŸ¥MySQLå¤åˆ¶çŠ¶å†µmasterha_manger å¯åŠ¨MHAmasterha_check_status æ£€æµ‹å½“å‰MHAè¿è¡ŒçŠ¶æ€masterha_master_monitor æ£€æµ‹masteræ˜¯å¦å®•æœºmasterha_master_switch æ§åˆ¶æ•…éšœè½¬ç§»ï¼ˆè‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨ï¼‰masterha_conf_host æ·»åŠ æˆ–åˆ é™¤é…ç½®çš„serverä¿¡æ¯ Nodeéƒ¨ç½²åœ¨æ‰€æœ‰èŠ‚ç‚¹ save_binary_logs ä¿å­˜å’Œå¤åˆ¶masterçš„äºŒè¿›åˆ¶æ—¥å¿—apply_diff_relay_logs è¯†åˆ«å·®å¼‚çš„ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶å°†å…¶å·®å¼‚çš„äº‹ä»¶åº”ç”¨äºå…¶ä»–çš„slavefilter_mysqlbinlog å»é™¤ä¸å¿…è¦çš„ROLLBACKäº‹ä»¶ï¼ˆMHAå·²ä¸å†ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼‰purge_relay_logs æ¸…é™¤ä¸­ç»§æ—¥å¿—ï¼ˆä¸ä¼šé˜»å¡SQLçº¿ç¨‹ï¼‰ MHA Managerå…·æœ‰å¦‚ç›‘æ§MySQL masterå’Œæ§åˆ¶æ•…éšœè½¬ç§»ç­‰ç¨‹åº MHA Nodeå…·æœ‰ä¸€äº›å¸®åŠ©ä¸»åº“è¿›è¡Œæ•…éšœè½¬ç§»çš„è„šæœ¬,ä¾‹å¦‚:è§£æMySQL binary/relay log;è¯†åˆ«relay logä½ç½®,è¿›è€Œåˆ¤æ–­å“ªäº›eventéœ€è¦åº”ç”¨åˆ°å…¶ä»–ä»åº“;åº”ç”¨eventsåˆ°ç›®æ ‡ä»åº“ç­‰. MHA Nodeè¿è¡Œåœ¨æ¯ä¸ªMySQLæœåŠ¡å™¨ä¸Š å½“MHA Managerè¿›è¡Œæ•…éšœåˆ‡æ¢æ—¶,MHA Manageré€šè¿‡SSHè¿æ¥MHAèŠ‚ç‚¹,å¹¶åœ¨éœ€è¦æ—¶æ‰§è¡ŒMHAèŠ‚ç‚¹å‘½ä»¤. è‡ªå®šä¹‰æ‰©å±•MHAæœ‰å‡ ä¸ªç”¨æˆ·å¯ä»¥è‡ªè¡Œæ‰©å±•çš„è„šæœ¬.ä¾‹å¦‚,MHAå¯ä»¥è°ƒç”¨ä»»ä½•è‡ªå®šä¹‰è„šæœ¬åˆ‡æ¢VIP. secondary_check_scriptï¼šç”¨äºæ£€æŸ¥æ¥è‡ªå¤šä¸ªç½‘ç»œè·¯ç”±çš„ä¸»æœºå¯ç”¨æ€§ master_ip_failover_scriptï¼šç”¨äºæ›´æ–°åº”ç”¨ç¨‹åºä½¿ç”¨çš„ä¸»æœºçš„IPåœ°å€(vip) shutdown_scriptï¼šç”¨äºå¼ºåˆ¶å…³é—­ä¸»æœåŠ¡å™¨ report_scriptï¼šå‘é€æŠ¥å‘Š(é‚®ä»¶) init_conf_load_scriptï¼šç”¨äºåŠ è½½åˆå§‹é…ç½®å‚æ•° master_ip_online_change_scriptï¼šæ›´æ–°ä¸»IPåœ°å€(vip)ã€‚ å½“é€šè¿‡masterha_master_switchæ‰§è¡Œåœ¨çº¿ä¸»åº“åˆ‡æ¢æ—¶,éœ€è¦æ­¤è„šæœ¬æ¥åˆ‡æ¢vip secondary_check_scripté€šå¸¸æ¥è¯´ï¼Œéå¸¸æ¨èä½¿ç”¨ä¸¤ä¸ªæˆ–æ›´å¤šçš„ç½‘ç»œçº¿è·¯æ£€æµ‹MySQL masteræœåŠ¡å™¨çš„å¯ç”¨æ€§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMHA Manageråªæ˜¯ç”¨å•ä¸ªçº¿è·¯æ£€æµ‹ï¼šä»Manageråˆ°Masterã€‚ä½†æ˜¯è¿™ä¸ªå¹¶ä¸æ¨èã€‚MHAé€šè¿‡è°ƒç”¨ä¸€ä¸ªé¢å¤–çš„è„šæœ¬ï¼ˆé€šè¿‡secondary_check_scriptå‚æ•°æŒ‡å®šï¼‰ï¼Œå®é™…ä¸Šå¯ä»¥æœ‰ä¸¤ä¸ªæˆ–æ›´å¤šçš„æ£€æŸ¥çº¿è·¯ã€‚é…ç½®ç¤ºä¾‹ï¼š secondary_check_script =masterha_secondary_check -s remote_host1 -s remote_host2 masterha_secondary_checkåœ¨MHA ManageråŒ…ä¸­å·²ç»åŒ…å«ã€‚å†…ç½®çš„masterha_secondary_check è„šæœ¬åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯æ¯”è¾ƒå¥½çš„ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥è°ƒç”¨å…¶ä»–ä»»æ„è„šæœ¬ã€‚ åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼ŒMHA Manageré€šè¿‡Manager-(A)-&gt;remote_host1-(B)-&gt;master_hostå’Œ Manager-(A)-&gt;remote_host2-(B)-&gt;master_hostæ£€æµ‹MySQL masteræœåŠ¡å™¨ã€‚å¦‚æœåœ¨ä¸¤ä¸ªçº¿è·¯ä¸­éƒ½ä¼šå‡ºç°ï¼šconnection Aæ˜¯æˆåŠŸçš„ï¼Œä½†æ˜¯Bæ˜¯ä¸æˆåŠŸçš„ï¼Œåˆ™masterha_secondary_checkä¼šé€€å‡ºï¼ˆè¿”å›0ï¼‰ï¼Œå¹¶ä¸”MHAManagerå†³å®šMySQL masterçœŸçš„æŒ‚æ‰äº†ï¼Œç„¶åä¼šè¿›è¡Œfailoverã€‚å¦‚æœAæ˜¯ä¸æˆåŠŸçš„ï¼Œmasterha_secondary_checkä¼šé€€å‡ºï¼ˆè¿”å›2ï¼‰ï¼Œå¹¶ä¸”MHAManagerçŒœæµ‹å‘ç”Ÿç½‘ç»œé—®é¢˜ï¼Œä¸ä¼šè¿›è¡Œfailoverã€‚å¦‚æœBæ˜¯æˆåŠŸçš„ï¼Œmasterha_secondary_checkä¼šé€€å‡ºï¼ˆè¿”å›3ï¼‰ï¼Œå¹¶ä¸”MHAManager æ¨æ–­MySQL masteræ˜¯å­˜æ´»çš„ï¼Œä¸ä¼šè¿›è¡Œfailoverã€‚ ä¸€èˆ¬æ¥è®²ï¼Œremote_host1 å’Œ remote_host2 åº”è¯¥ä½äºä¸åŒçš„ç½‘æ®µï¼ˆä»MHA Managerå’ŒMySQLæœåŠ¡å™¨ï¼‰ã€‚ MHA è°ƒç”¨secondary_check_scriptå‚æ•°å®šä¹‰çš„è„šæœ¬ï¼Œè‡ªåŠ¨ä¼ ä¸€ä¸‹å‚æ•°(æ‰€ä»¥ä¸éœ€è¦å†é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä»¥ä¸‹å‚æ•°)ã€‚ masterha_secondary_check åœ¨è®¸å¤šæƒ…å½¢ä¸‹æ˜¯é€‚å®œçš„ï¼Œä½†æ˜¯å¦‚æœä½ éœ€è¦æ›´å¤šåŠŸèƒ½å¯ä»¥è‡ªå·±å†™ä¸€äº›ç½‘ç»œç›‘æµ‹è„šæœ¬ã€‚ â€“user=(è¿œç¨‹hostsçš„SSHç”¨æˆ·åã€‚ssh_user å‚æ•°çš„å€¼ä¼šè¢«ä¼ å…¥) â€“master_host=(masterçš„hostname) â€“master_ip=(masterçš„ip åœ°å€) â€“master_port=(masterçš„ç«¯å£å·) å†…ç½®çš„masterha_secondary_check è„šæœ¬ä¾èµ–äºIO::Socket::INETPerlåŒ…ï¼Œä»Perl v5.6.0å¼€å§‹å·²ç»é»˜è®¤åŒ…å«ã€‚masterha_secondary_check è„šæœ¬ä¹Ÿæ˜¯é€šè¿‡SSHè¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦SSHå…¬å…±å¯†é’¥éªŒè¯ã€‚è¿˜æœ‰ï¼Œmasterha_secondary_check è„šæœ¬å°è¯•ä»è¿œç¨‹æœåŠ¡å™¨ï¼ˆset by -sï¼‰åˆ°MySQLmasterå»ºç«‹TCPè¿æ¥ã€‚my.cnfä¸­è®¾ç½®çš„max_connectionså‚æ•°ä¸ä¼šå½±å“ï¼Œå¦‚æœTCPè¿æ¥æˆåŠŸï¼Œmasterä¸Šçš„aborted_connectså€¼ä¼šåŠ 1ã€‚ master_ip_failover_scriptåœ¨å¸¸è§çš„HAç¯å¢ƒä¸­ï¼Œè®¸å¤šæƒ…å½¢ä¸‹ä¼šåœ¨masterä¸Šåˆ†é…ä¸€ä¸ªè™šæ‹ŸIPåœ°å€ã€‚å¦‚æœmasteræŒ‚æ‰ï¼ŒHAè½¯ä»¶ï¼ˆæ¯”å¦‚ï¼šPacemakerï¼‰ä¼šæ¥ç®¡è™šæ‹ŸIPåˆ°å¤‡æœºä¸Šã€‚ å¦ä¸€ä¸ªå¸¸è§çš„å¤„ç†æ–¹å¼æ˜¯åˆ›å»ºä¸€ä¸ªå…¨å±€æ€§çš„ç›®å½•æ•°æ®åº“ï¼Œè¯¥æ•°æ®åº“åŒ…å«åº”ç”¨åç§°å’Œè¯»å†™IPåœ°å€ä¹‹é—´çš„æ˜ å°„ï¼ˆi.e. {app1_master1, 192.168.0.1}, {app_master2, 192.168.0.2}, â€¦ï¼‰ã€‚è¿™ç§æƒ…å½¢ä¸‹ï¼Œåœ¨å½“å‰masteræŒ‚æ‰ä¹‹åéœ€è¦æ›´æ–°ç›®å½•æ•°æ®åº“ã€‚ ä¸¤è€…æ–¹å¼å„æœ‰ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚MHAä¸å¼ºåˆ¶ä½¿ç”¨å…¶ä¸­ä¸€ç§æ–¹å¼ï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨ä»»ä½•ä¸€ç§IPåœ°å€æ•…éšœåˆ‡æ¢çš„è§£å†³åŠæ³•ï¼Œmaster_ip_failover_scriptå‚æ•°è¢«ç”¨äºè§£å†³è¿™ä¸ªã€‚ æ¢å¥è¯è¯´ï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ªè„šæœ¬ä½¿åº”ç”¨é€æ˜çš„è¿æ¥åˆ°new masterï¼Œå¿…é¡»å®šä¹‰åœ¨master_ip_failover_script å‚æ•°ä¸­ã€‚å®ä¾‹å¦‚ä¸‹ï¼š 1master_ip_failover_script= /usr/local/sample/bin/master_ip_failover ç¤ºä¾‹åŠä¿æœ¬ä½äºï¼ˆMHA ManageråŒ…ï¼‰/samples/scripts/master_ip_failoverã€‚ ç¤ºä¾‹è„šæœ¬åœ¨MHA Managertarballå’ŒGitHupåˆ†æ”¯ä¸­åŒ…å«ã€‚ MHA Manager è°ƒç”¨master_ip_failover_script ä¸‰æ¬¡ã€‚ç¬¬ä¸€æ¬¡åœ¨è¿›å…¥masterç›‘æ§ä¹‹å‰ï¼ˆè„šæœ¬æœ‰æ•ˆæ€§æ£€æŸ¥ï¼‰ï¼Œç¬¬äºŒæ¬¡æ˜¯åœ¨è°ƒç”¨shutdown_scriptè„šæœ¬ä¹‹å‰ï¼Œç¬¬ä¸‰æ¬¡æ˜¯åœ¨åº”ç”¨å·®å¼‚relay logåˆ°new masterä¹‹åã€‚MHA Manager ä¼ å…¥ä»¥ä¸‹å‚æ•°ï¼ˆä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼‰ã€‚ Checking é˜¶æ®µ â€“command=status â€“ssh_user=(å½“å‰masterçš„ssh username) â€“orig_master_host=(å½“å‰master çš„ hostname) â€“orig_master_ip=(å½“å‰ masterçš„ ipåœ°å€) â€“orig_master_port=(å½“å‰masterçš„ç«¯å£å·) å½“å‰master shutdowné˜¶æ®µ â€“command=stop æˆ– stopssh â€“ssh_user=(dead masterçš„ ssh usernameï¼Œå¦‚æœå¯ä»¥é€šè¿‡SSHè®¿é—®) â€“orig_master_host=(current(dead) masterçš„ hostname) â€“orig_master_ip=(current(dead) masterçš„ ip åœ°å€) â€“orig_master_port=(current(dead) masterçš„ ç«¯å£å·) New master æ¿€æ´»é˜¶æ®µ â€“command=start â€“ssh_user=(new masterçš„ ssh username) â€“orig_master_host=(dead masterçš„ hostname) â€“orig_master_ip=(dead masterçš„ ip åœ°å€) â€“orig_master_port=(dead masterçš„ç«¯å£å·) â€“new_master_host=(new masterçš„ hostname) â€“new_master_ip=(new masterçš„ ip åœ°å€) â€“new_master_port(new masterçš„ç«¯å£å·) â€“new_master_user=(new masterçš„ç”¨æˆ·) â€“new_master_password(new masterçš„å¯†ç ) å¦‚æœåœ¨masterä¸Šä½¿ç”¨äº†ä¸€ä¸ªå…±äº«çš„è™šæ‹ŸIPåœ°å€ï¼Œåªè¦åœ¨ä¹‹åshutdown_scriptä¸­å…³æ‰äº†æœºå™¨ï¼Œåœ¨shutdowné˜¶æ®µå¯èƒ½ä¸éœ€è¦åšä»»ä½•äº‹ã€‚åœ¨newmasteræ¿€æ´»é˜¶æ®µï¼Œå¯ä»¥åœ¨new masterä¸ŠæŒ‡å®šè™šæ‹ŸIPã€‚ å¦‚æœä½¿ç”¨äº†ç›®å½•æ•°æ®åº“çš„æ–¹å¼ï¼Œåœ¨master shutdowné˜¶æ®µéœ€è¦deleteæˆ–è€…update dead masterçš„è®°å½•ã€‚åœ¨new masteræ¿€æ´»é˜¶æ®µï¼Œå¯ä»¥insert/update new masterçš„è®°å½•ã€‚è¿˜æœ‰ï¼Œå¯ä»¥åšä»»ä½•ä½ éœ€è¦åšçš„äº‹ï¼Œä½¿å¾—åº”ç”¨å¯ä»¥å†™å…¥new masterã€‚æ¯”å¦‚ï¼ŒSET GLOBAL read_only=0ï¼Œåˆ›å»ºæ‹¥æœ‰writeæƒé™çš„æ•°æ®åº“ç”¨æˆ·ï¼Œç­‰ç­‰ã€‚ MHA Manager æ£€æŸ¥è¯¥è„šæœ¬é€€å‡ºçš„codeï¼ˆreturn codeï¼‰ã€‚å¦‚æœè„šæœ¬è¿”å›çš„codeä¸º0æˆ–è€…10ï¼ŒMHA Manager ç»§ç»­æ“ä½œã€‚ å¦‚æœè„šæœ¬è¿”å›çš„codeä¸æ˜¯0æˆ–è€…10ï¼ŒMHA Managerç»ˆæ­¢ï¼Œä¸ä¼šç»§ç»­æ•…éšœåˆ‡æ¢ã€‚å‚æ•°é»˜è®¤ä¸ºç©ºã€‚ report_scriptfailoverå®Œæˆæˆ–è€…å› ä¸ºé”™è¯¯ç»“æŸçš„æ—¶å€™å¯èƒ½éœ€è¦å‘é€æŠ¥å‘Šï¼ˆi.e. e-mailï¼‰ã€‚report_script ç”¨äºè¿™ä¸ªç›®çš„ã€‚MHA Managerä¼ å…¥ä»¥ä¸‹å‚æ•°ã€‚ â€“orig_master_host=(dead masterçš„ hostname) â€“new_master_host=(new masterçš„ hostname) â€“new_slave_hosts=(new slaves çš„ hostnamesï¼Œé€šè¿‡é€—å·åˆ†éš”) â€“subject=(mail subject) â€“body=(body) å‚æ•°é»˜è®¤ä¸ºç©ºã€‚ ç¤ºä¾‹è„šæœ¬ä½äº(MHA Manager åŒ…)/samples/scripts/send_reportã€‚ç¤ºä¾‹è„šæœ¬åœ¨MHA Managertarball å’Œ GitHubåˆ†æ”¯ä¸­åŒ…å«ã€‚ init_conf_load_scriptå½“ä¸æƒ³åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®çº¯æ–‡æœ¬ï¼ˆi.e. passwordå’Œrepl_passwordï¼‰çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥è„šæœ¬ã€‚é€šè¿‡ä»è¯¥è„šæœ¬è¿”å› â€œname=valueâ€ å¯¹ï¼Œå¯ä»¥è¦†ç›–å…¨å±€é…ç½®æ–‡ä»¶çš„å‚æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹ã€‚ 123#!/usr/bin/perlprint &quot;password=$ROOT_PASS\\n&quot;;print &quot;repl_password=$REPL_PASS\\n&quot;; master_ip_online_change_scriptç±»ä¼¼äºmaster_ip_failover_script å‚æ•°ï¼Œä½†æ˜¯è¯¥å‚æ•°ä¸æ˜¯ç”¨äºmasteræ•…éšœåˆ‡æ¢çš„å‘½ä»¤ï¼Œç”¨äºmasteråœ¨çº¿åˆ‡æ¢å‘½ä»¤ï¼ˆmasterha_master_switchâ€“master_state=aliveï¼‰ã€‚ä¼ å…¥ä»¥ä¸‹å‚æ•°ã€‚ Current masteré˜»å¡å†™å…¥é˜¶æ®µ â€“command=stop æˆ– stopssh â€“orig_master_host=(current masterçš„ hostname) â€“orig_master_ip=(current masterçš„ ip åœ°å€) â€“orig_master_port=(current masterçš„ç«¯å£å·) â€“orig_master_user=(current masterçš„ç”¨æˆ·) â€“orig_master_password=(current masterçš„å¯†ç ) â€“orig_master_ssh_user=(ä»0.56æ”¯æŒ, current masterçš„ ssh user) â€“orig_master_is_new_slave=(ä»0.56æ”¯æŒ, è¡¨ç¤ºåŸæ¥çš„masteræ˜¯å¦ä¼šæˆä¸ºæ–°çš„slave) New master èµ‹writeæƒé™é˜¶æ®µ â€“command=start â€“orig_master_host=(orig masterçš„hostname) â€“orig_master_ip=(orig masterçš„ ip åœ°å€) â€“orig_master_port=(orig masterçš„ç«¯å£å·) â€“new_master_host=(new masterçš„ hostname) â€“new_master_ip=(new masterçš„ip åœ°å€) â€“new_master_port(new masterçš„ç«¯å£å·) â€“new_master_user=(new masterçš„ç”¨æˆ·) â€“new_master_password=(new masterçš„å¯†ç ) â€“new_master_ssh_user=(ä»0.56æ”¯æŒ, new masterçš„ ssh user) å½“å‰masteré˜»å¡å†™é˜¶æ®µï¼ŒMHA åœ¨å½“å‰masterä¸Šæ‰§è¡Œ FLUSH TABLES WITH READ LOCK ã€‚åœ¨new masterèµ‹wirteæƒé™é˜¶æ®µï¼Œå¯ä»¥åšå’Œmaster_ip_failover_scriptä¸€æ ·çš„äº‹æƒ…ã€‚æ¯”å¦‚ï¼Œåˆ›å»ºæœ‰æƒé™çš„ç”¨æˆ·ï¼Œæ‰§è¡ŒSET GLOBAL read_only=0ï¼Œæ›´æ–°ç›®å½•æ•°æ®åº“ï¼Œç­‰ç­‰ã€‚å¦‚æœè„šæœ¬è¿”å›çš„codeä¸æ˜¯0æˆ–10ï¼Œåˆ™MHA Manager ä¼šç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šç»§ç»­masteråˆ‡æ¢ã€‚ é»˜è®¤å‚æ•°ä¸ºç©ºã€‚ ç¤ºä¾‹è„šæœ¬ä½äºï¼ˆMHA ManageråŒ…ï¼‰/samples/scripts/master_ip_online_changeã€‚ å…¸å‹ç”¨ä¾‹ä¸€ä¸»å¤šä»1234 M(RW) M(RW), promoted from S1 | | +------+------+ --(master crash)--&gt; +-----+------+S1(R) S2(R) S3(R) S2(R) S3(R) æœ€å¸¸è§çš„å¤åˆ¶åœºæ™¯ ä¸€ä¸»å¤šä»,å…¶ä¸­ä¸€ä¸ªä»åº“åœ¨å¼‚åœ°1234 M(RW) M(RW), promoted from S1 | | +------+------+ --(master crash)--&gt; +------+------+S1(R) S2(R) Sr(R,no_master=1) S2(R) Sr(R,no_master=1) é€šå¸¸æˆ‘ä»¬å¯èƒ½ä¼šéœ€è¦åœ¨å¼‚åœ°æ•°æ®ä¸­å¿ƒæ­å»ºä¸€ä¸ªä»åº“,ä½†å½“ä¸»åº“å®•æœºæ—¶,æˆ‘ä»¬å¹¶ä¸å¸Œæœ›è¯¥ä»åº“è¢«æå‡ä¸ºæ–°ä¸»åº“,è€Œæ˜¯å¸Œæœ›ä¸€ä¸ªä¸åŸä¸»åº“åŒæœºæˆ¿çš„ä»åº“ä½œä¸ºæ–°ä¸»åº“.å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­å‘SråŒºå—æ·»åŠ no_master=1å‚æ•°æ¥ä»å€™é€‰åå•ä¸­ç§»é™¤Sr ä¸€ä¸»å¤šä»,ä¸€ä¸ªå€™é€‰ä¸»åº“1234 M(RW)-----S0(R,candidate_master=1) M(RW), promoted from S0 | | +------+------+ --(master crash)--&gt; +------+------+S1(R) S2(R) S1(R) S2(R) æœ‰æ—¶æˆ‘ä»¬æƒ³æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„ä»åº“ä½œä¸ºæ–°ä¸»åº“.å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­å‘å¸Œæœ›çš„ä»åº“åŒºå—ä¸‹æ·»åŠ candidate_master=1æ¥å®ç°è¿™ä¸€éœ€æ±‚ åŒä¸»1234 M(RW)&lt;---&gt;M2(R,candidate_master=1) M(RW), promoted from M2 | | +------+------+ --(master crash)--&gt; +------+------+S(R) S2(R) S1(R) S2(R) åŒä¸»,Mè¯»å†™,M2åªè¯», Mä¸‹æŒ‚ä¸¤ä¸ªä»åº“. åˆ‡æ¢åM2ä½œä¸ºæ–°ä¸» S1,S2 change masteråˆ°M2. åªè¦M2æ˜¯åªè¯»çš„,MHAå°±æ”¯æŒå¤šä¸»é…ç½® MHA Manager supports multi-master configurations as long as all non-primary masters (M2 in this figure) are read-only. ä¸‰å±‚å¤åˆ¶1234567 M(RW) M(RW), promoted from S1 | | +------+------+ --(master crash)--&gt; +------+------+S1(R) S2(R) Sr(R) S2(R) Sr(R) | | + + Sr2 Sr2 Mä¸»åº“RWæ¨¡å¼,S1 S2ä¸ºæœ¬åœ°åªè¯»ä»åº“,Srä¸ºè¿œç¨‹åªè¯»ä»åº“,Sr2ä¸ºSrçš„ä»åº“.è¿™ç§ç»“æ„ä¸‹MHAä»ç„¶å¯ä»¥æ”¯æŒmaster failover.åœ¨é…ç½®æ–‡ä»¶é…ç½®masterå’Œæ‰€æœ‰äºŒå±‚çš„ä»åº“(åœ¨è¿™ä¸ªä¾‹å­æ·»åŠ M,S1,S2å’ŒSråˆ°é…ç½®æ–‡ä»¶,ä½†æ˜¯ä¸è¦æ·»åŠ Sr2åˆ°é…ç½®æ–‡ä»¶ä¸­).å¦‚æœæœ‰masterå®•æœº,MHAè‡ªåŠ¨æå‡äºŒå±‚ä»åº“(S1æˆ–S3æˆ–Sr.å–å†³äºä¼˜å…ˆçº§)ä¸ºæ–°ä¸»åº“,å¹¶æ¢å¤å…¶ä»–äºŒå±‚ä»åº“. ç¬¬ä¸‰æ¬¡çš„ä»åº“Sr2ä¸å—MHAç®¡ç†,ä¸è¿‡åªè¦Sr2çš„ä¸»åº“å¯ç”¨,Sr2ä»ç„¶å¯ä»¥ç»§ç»­å¤åˆ¶. å¦‚æœSrå®•æœº,Sr2å°†ä¸èƒ½ç»§ç»­å¤åˆ¶,å› ä¸ºSr2çš„ä¸»åº“æ˜¯Sr.MHAä¸èƒ½å›å¤Sr2 This is where support for global transaction id is desired. Hopefully this is less serious than master crash.æ¯å°æ˜ç™½,æ„æ€æ˜¯è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦GTID?æœ‰äº†GTID Sr2å°±å¯ä»¥change masteråˆ°æ–°ä¸»äº†å§ ä¸‰å±‚å¤åˆ¶,åŒä¸»1234567891011 M1(host1,RW) &lt;-----------------&gt; M2(host2,read-only) | | +------+------+ +S1(host3,R) S2(host4,R) S3(host5,R)=&gt; After failover M2(host2,RW) |+--------------+--------------+S1(host3,R) S2(host4,R) S3(host5,R) MHAé€šç”¨æ”¯æŒè¿™ç§ç»“æ„.åœ¨è¿™ä¸ªç»“æ„ä¸‹host5æ˜¯ä¸€ä¸ªç¬¬ä¸‰å±‚çš„slave,æ‰€ä»¥MHAä¸èƒ½ç®¡ç†host5(MHA does not execute CHANGE MASTER on host5 when the primary master host1 fails).å½“host1 dow,host2å°†ä¼šæˆä¸ºæ–°ä¸»åº“,æ‰€ä»¥host5å¯ä»¥keep replication from host2 without doing anything. ä¸‹é¢æ˜¯é…ç½®æ–‡ä»¶ç¤ºä¾‹. 12345678910111213141516171819[server default]multi_tier_slave=1[server1]hostname=host1candidate_master=1[server2]hostname=host2candidate_master=1[server3]hostname=host3[server4]hostname=host4[server5]hostname=host5","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MHA","slug":"MHA","permalink":"http://fuxkdb.com/tags/MHA/"}]},{"title":"Sysbenchå‡ºå›¾","slug":"Sysbenchå‡ºå›¾","date":"2017-07-06T14:00:00.000Z","updated":"2018-04-24T09:59:31.000Z","comments":true,"path":"2017/07/06/Sysbenchå‡ºå›¾/","link":"","permalink":"http://fuxkdb.com/2017/07/06/Sysbench%E5%87%BA%E5%9B%BE/","excerpt":"Plot-Sysbenchprepare12345678910111213141516171819202122232425262728293031323334353637383940sysbench /tmp/sysbench-master/src/lua/oltp_read_write.lua --mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysql55/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 --threads=30 \\--events=5000000 --report-interval=5 prepare##--table-size=äº”ç™¾ä¸‡,ä¸€ä¸ªè¡¨äº”ç™¾ä¸‡ 10ä¸ªè¡¨ äº”åƒä¸‡##--threads=30 å¼€30ä¸ªçº¿ç¨‹å¹¶å‘prepareInitializing worker threads...Creating table &#x27;sbtest6&#x27;...Creating table &#x27;sbtest4&#x27;...Creating table &#x27;sbtest5&#x27;...Creating table &#x27;sbtest10&#x27;...Creating table &#x27;sbtest8&#x27;...Creating table &#x27;sbtest3&#x27;...Creating table &#x27;sbtest9&#x27;...Creating table &#x27;sbtest1&#x27;...Creating table &#x27;sbtest2&#x27;...Creating table &#x27;sbtest7&#x27;...Inserting 5000000 records into &#x27;sbtest4&#x27;Inserting 5000000 records into &#x27;sbtest5&#x27;Inserting 5000000 records into &#x27;sbtest6&#x27;Inserting 5000000 records into &#x27;sbtest8&#x27;Inserting 5000000 records into &#x27;sbtest3&#x27;Inserting 5000000 records into &#x27;sbtest9&#x27;Inserting 5000000 records into &#x27;sbtest10&#x27;Inserting 5000000 records into &#x27;sbtest7&#x27;Inserting 5000000 records into &#x27;sbtest1&#x27;Inserting 5000000 records into &#x27;sbtest2&#x27;Creating a secondary index on &#x27;sbtest6&#x27;...Creating a secondary index on &#x27;sbtest9&#x27;...Creating a secondary index on &#x27;sbtest4&#x27;...Creating a secondary index on &#x27;sbtest8&#x27;...Creating a secondary index on &#x27;sbtest3&#x27;...Creating a secondary index on &#x27;sbtest7&#x27;...Creating a secondary index on &#x27;sbtest2&#x27;...Creating a secondary index on &#x27;sbtest1&#x27;...Creating a secondary index on &#x27;sbtest5&#x27;...Creating a secondary index on &#x27;sbtest10&#x27;...","text":"Plot-Sysbenchprepare12345678910111213141516171819202122232425262728293031323334353637383940sysbench /tmp/sysbench-master/src/lua/oltp_read_write.lua --mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysql55/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 --threads=30 \\--events=5000000 --report-interval=5 prepare##--table-size=äº”ç™¾ä¸‡,ä¸€ä¸ªè¡¨äº”ç™¾ä¸‡ 10ä¸ªè¡¨ äº”åƒä¸‡##--threads=30 å¼€30ä¸ªçº¿ç¨‹å¹¶å‘prepareInitializing worker threads...Creating table &#x27;sbtest6&#x27;...Creating table &#x27;sbtest4&#x27;...Creating table &#x27;sbtest5&#x27;...Creating table &#x27;sbtest10&#x27;...Creating table &#x27;sbtest8&#x27;...Creating table &#x27;sbtest3&#x27;...Creating table &#x27;sbtest9&#x27;...Creating table &#x27;sbtest1&#x27;...Creating table &#x27;sbtest2&#x27;...Creating table &#x27;sbtest7&#x27;...Inserting 5000000 records into &#x27;sbtest4&#x27;Inserting 5000000 records into &#x27;sbtest5&#x27;Inserting 5000000 records into &#x27;sbtest6&#x27;Inserting 5000000 records into &#x27;sbtest8&#x27;Inserting 5000000 records into &#x27;sbtest3&#x27;Inserting 5000000 records into &#x27;sbtest9&#x27;Inserting 5000000 records into &#x27;sbtest10&#x27;Inserting 5000000 records into &#x27;sbtest7&#x27;Inserting 5000000 records into &#x27;sbtest1&#x27;Inserting 5000000 records into &#x27;sbtest2&#x27;Creating a secondary index on &#x27;sbtest6&#x27;...Creating a secondary index on &#x27;sbtest9&#x27;...Creating a secondary index on &#x27;sbtest4&#x27;...Creating a secondary index on &#x27;sbtest8&#x27;...Creating a secondary index on &#x27;sbtest3&#x27;...Creating a secondary index on &#x27;sbtest7&#x27;...Creating a secondary index on &#x27;sbtest2&#x27;...Creating a secondary index on &#x27;sbtest1&#x27;...Creating a secondary index on &#x27;sbtest5&#x27;...Creating a secondary index on &#x27;sbtest10&#x27;...sysbenchteståº“å¤§å°12[root@uz6535 mysql55]# du -sh sysbenchtest/12G sysbenchtest/ run123456sysbench \\/tmp/sysbench-master/src/lua/oltp_read_write.lua \\--mysql-user=root --mysql-password=mysql --mysql-port=3306 \\--mysql-socket=/data/mysql55/mysql.sock --mysql-host=localhost \\--mysql-db=sysbenchtest --tables=10 --table-size=5000000 \\--threads=30 --report-interval=5 --time=300 run &gt; binlog_off.txtè¾“å‡ºçš„åŸå§‹ç»“æœ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586[ 5s ] thds: 30 tps: 73.76 qps: 1538.67 (r/w/o: 1084.35/300.82/153.51) lat (ms,95%): 733.00 err/s: 0.00 reconn/s: 0.00[ 10s ] thds: 30 tps: 75.80 qps: 1519.27 (r/w/o: 1062.85/304.81/151.61) lat (ms,95%): 590.56 err/s: 0.00 reconn/s: 0.00[ 15s ] thds: 30 tps: 58.39 qps: 1183.57 (r/w/o: 831.24/235.55/116.78) lat (ms,95%): 926.33 err/s: 0.00 reconn/s: 0.00[ 20s ] thds: 30 tps: 48.21 qps: 961.19 (r/w/o: 672.13/192.64/96.42) lat (ms,95%): 1129.24 err/s: 0.00 reconn/s: 0.00[ 25s ] thds: 30 tps: 43.57 qps: 863.96 (r/w/o: 606.66/170.15/87.14) lat (ms,95%): 1109.09 err/s: 0.00 reconn/s: 0.00[ 30s ] thds: 30 tps: 21.70 qps: 418.24 (r/w/o: 291.07/83.77/43.41) lat (ms,95%): 2585.31 err/s: 0.00 reconn/s: 0.00[ 35s ] thds: 30 tps: 19.99 qps: 420.45 (r/w/o: 299.09/81.37/39.99) lat (ms,95%): 3267.19 err/s: 0.00 reconn/s: 0.00[ 40s ] thds: 30 tps: 26.41 qps: 511.99 (r/w/o: 352.53/106.64/52.82) lat (ms,95%): 2198.52 err/s: 0.00 reconn/s: 0.00[ 45s ] thds: 30 tps: 30.20 qps: 608.26 (r/w/o: 427.04/120.81/60.41) lat (ms,95%): 2279.14 err/s: 0.00 reconn/s: 0.00[ 50s ] thds: 30 tps: 20.58 qps: 438.48 (r/w/o: 308.03/89.29/41.15) lat (ms,95%): 1973.38 err/s: 0.00 reconn/s: 0.00[ 55s ] thds: 30 tps: 26.03 qps: 486.74 (r/w/o: 338.97/95.71/52.06) lat (ms,95%): 2279.14 err/s: 0.00 reconn/s: 0.00[ 60s ] thds: 30 tps: 46.98 qps: 955.28 (r/w/o: 670.77/190.54/93.97) lat (ms,95%): 1170.65 err/s: 0.00 reconn/s: 0.00[ 65s ] thds: 30 tps: 40.62 qps: 803.33 (r/w/o: 562.03/160.06/81.23) lat (ms,95%): 1533.66 err/s: 0.00 reconn/s: 0.00[ 70s ] thds: 30 tps: 40.49 qps: 814.29 (r/w/o: 569.19/164.13/80.97) lat (ms,95%): 1903.57 err/s: 0.00 reconn/s: 0.00[ 75s ] thds: 30 tps: 38.90 qps: 779.99 (r/w/o: 550.83/151.36/77.80) lat (ms,95%): 1589.90 err/s: 0.00 reconn/s: 0.00[ 80s ] thds: 30 tps: 30.30 qps: 617.64 (r/w/o: 428.84/128.19/60.61) lat (ms,95%): 2009.23 err/s: 0.00 reconn/s: 0.00[ 85s ] thds: 30 tps: 21.46 qps: 418.45 (r/w/o: 292.27/83.25/42.93) lat (ms,95%): 2449.36 err/s: 0.00 reconn/s: 0.00[ 90s ] thds: 30 tps: 37.61 qps: 755.12 (r/w/o: 527.08/152.82/75.21) lat (ms,95%): 1771.29 err/s: 0.00 reconn/s: 0.00[ 95s ] thds: 30 tps: 32.54 qps: 651.63 (r/w/o: 457.56/128.98/65.08) lat (ms,95%): 1869.60 err/s: 0.00 reconn/s: 0.00[ 100s ] thds: 30 tps: 42.28 qps: 826.39 (r/w/o: 577.77/164.27/84.36) lat (ms,95%): 1453.01 err/s: 0.00 reconn/s: 0.00[ 105s ] thds: 30 tps: 30.84 qps: 653.14 (r/w/o: 460.72/130.55/61.87) lat (ms,95%): 2198.52 err/s: 0.00 reconn/s: 0.00[ 110s ] thds: 30 tps: 49.66 qps: 975.39 (r/w/o: 684.23/191.85/99.31) lat (ms,95%): 1149.76 err/s: 0.00 reconn/s: 0.00[ 115s ] thds: 30 tps: 39.18 qps: 779.72 (r/w/o: 540.44/160.93/78.35) lat (ms,95%): 1376.60 err/s: 0.00 reconn/s: 0.00[ 120s ] thds: 30 tps: 19.13 qps: 370.96 (r/w/o: 258.79/74.11/38.05) lat (ms,95%): 3095.38 err/s: 0.00 reconn/s: 0.00[ 125s ] thds: 30 tps: 21.44 qps: 460.58 (r/w/o: 325.15/92.36/43.07) lat (ms,95%): 3267.19 err/s: 0.00 reconn/s: 0.00[ 130s ] thds: 30 tps: 29.84 qps: 581.09 (r/w/o: 404.44/116.97/59.68) lat (ms,95%): 3040.14 err/s: 0.00 reconn/s: 0.00[ 135s ] thds: 30 tps: 23.97 qps: 467.19 (r/w/o: 328.38/90.86/47.95) lat (ms,95%): 3326.55 err/s: 0.00 reconn/s: 0.00[ 140s ] thds: 30 tps: 25.41 qps: 516.94 (r/w/o: 363.70/102.43/50.81) lat (ms,95%): 2449.36 err/s: 0.00 reconn/s: 0.00[ 145s ] thds: 30 tps: 26.00 qps: 518.58 (r/w/o: 363.19/103.40/52.00) lat (ms,95%): 2778.39 err/s: 0.00 reconn/s: 0.00[ 150s ] thds: 30 tps: 22.56 qps: 447.75 (r/w/o: 314.40/88.25/45.11) lat (ms,95%): 2539.17 err/s: 0.00 reconn/s: 0.00[ 155s ] thds: 30 tps: 23.66 qps: 485.03 (r/w/o: 333.80/103.92/47.31) lat (ms,95%): 2405.65 err/s: 0.00 reconn/s: 0.00[ 160s ] thds: 30 tps: 22.00 qps: 427.88 (r/w/o: 305.20/78.68/44.00) lat (ms,95%): 2932.60 err/s: 0.00 reconn/s: 0.00[ 165s ] thds: 30 tps: 25.84 qps: 521.81 (r/w/o: 362.14/108.00/51.68) lat (ms,95%): 2632.28 err/s: 0.00 reconn/s: 0.00[ 170s ] thds: 30 tps: 40.39 qps: 818.20 (r/w/o: 575.66/161.76/80.78) lat (ms,95%): 2082.91 err/s: 0.00 reconn/s: 0.00[ 175s ] thds: 30 tps: 35.98 qps: 697.47 (r/w/o: 485.77/139.73/71.97) lat (ms,95%): 2045.74 err/s: 0.00 reconn/s: 0.00[ 180s ] thds: 30 tps: 18.50 qps: 391.91 (r/w/o: 277.32/77.59/37.00) lat (ms,95%): 2680.11 err/s: 0.00 reconn/s: 0.00[ 185s ] thds: 30 tps: 26.36 qps: 520.54 (r/w/o: 363.80/104.03/52.72) lat (ms,95%): 1973.38 err/s: 0.00 reconn/s: 0.00[ 190s ] thds: 30 tps: 32.40 qps: 641.60 (r/w/o: 447.40/129.40/64.80) lat (ms,95%): 1903.57 err/s: 0.00 reconn/s: 0.00[ 195s ] thds: 30 tps: 32.60 qps: 668.65 (r/w/o: 465.04/138.41/65.21) lat (ms,95%): 2405.65 err/s: 0.00 reconn/s: 0.00[ 200s ] thds: 30 tps: 23.99 qps: 469.08 (r/w/o: 328.12/92.98/47.99) lat (ms,95%): 2985.89 err/s: 0.00 reconn/s: 0.00[ 205s ] thds: 30 tps: 35.41 qps: 715.31 (r/w/o: 506.48/138.02/70.81) lat (ms,95%): 1903.57 err/s: 0.00 reconn/s: 0.00[ 210s ] thds: 30 tps: 28.97 qps: 571.75 (r/w/o: 396.95/116.87/57.93) lat (ms,95%): 1836.24 err/s: 0.00 reconn/s: 0.00[ 215s ] thds: 30 tps: 27.81 qps: 538.34 (r/w/o: 374.30/108.43/55.61) lat (ms,95%): 2539.17 err/s: 0.00 reconn/s: 0.00[ 220s ] thds: 30 tps: 41.66 qps: 855.75 (r/w/o: 605.81/166.62/83.31) lat (ms,95%): 1213.57 err/s: 0.00 reconn/s: 0.00[ 225s ] thds: 30 tps: 43.58 qps: 844.54 (r/w/o: 584.88/172.51/87.15) lat (ms,95%): 2120.76 err/s: 0.00 reconn/s: 0.00[ 230s ] thds: 30 tps: 29.80 qps: 613.46 (r/w/o: 433.04/120.81/59.61) lat (ms,95%): 1533.66 err/s: 0.00 reconn/s: 0.00[ 235s ] thds: 30 tps: 35.47 qps: 716.43 (r/w/o: 503.19/142.29/70.95) lat (ms,95%): 2198.52 err/s: 0.00 reconn/s: 0.00[ 240s ] thds: 30 tps: 35.54 qps: 702.84 (r/w/o: 487.17/144.58/71.09) lat (ms,95%): 1506.29 err/s: 0.00 reconn/s: 0.00[ 245s ] thds: 30 tps: 28.79 qps: 581.14 (r/w/o: 410.41/113.15/57.57) lat (ms,95%): 1938.16 err/s: 0.00 reconn/s: 0.00[ 250s ] thds: 30 tps: 19.20 qps: 393.79 (r/w/o: 272.59/82.80/38.40) lat (ms,95%): 3151.62 err/s: 0.00 reconn/s: 0.00[ 255s ] thds: 30 tps: 31.60 qps: 608.62 (r/w/o: 427.62/117.80/63.20) lat (ms,95%): 2493.86 err/s: 0.00 reconn/s: 0.00[ 260s ] thds: 30 tps: 29.00 qps: 588.06 (r/w/o: 411.64/118.41/58.01) lat (ms,95%): 2159.29 err/s: 0.00 reconn/s: 0.00[ 265s ] thds: 30 tps: 34.99 qps: 705.06 (r/w/o: 494.30/140.77/69.99) lat (ms,95%): 1836.24 err/s: 0.00 reconn/s: 0.00[ 270s ] thds: 30 tps: 16.41 qps: 333.18 (r/w/o: 229.72/70.64/32.82) lat (ms,95%): 2778.39 err/s: 0.00 reconn/s: 0.00[ 275s ] thds: 30 tps: 32.99 qps: 670.70 (r/w/o: 472.39/132.34/65.97) lat (ms,95%): 3040.14 err/s: 0.00 reconn/s: 0.00[ 280s ] thds: 30 tps: 38.99 qps: 755.84 (r/w/o: 527.09/150.77/77.98) lat (ms,95%): 1771.29 err/s: 0.00 reconn/s: 0.00[ 285s ] thds: 30 tps: 36.41 qps: 720.35 (r/w/o: 503.91/143.63/72.82) lat (ms,95%): 1561.52 err/s: 0.00 reconn/s: 0.00[ 290s ] thds: 30 tps: 35.80 qps: 740.01 (r/w/o: 523.00/145.40/71.60) lat (ms,95%): 1678.14 err/s: 0.00 reconn/s: 0.00[ 295s ] thds: 30 tps: 32.94 qps: 662.28 (r/w/o: 466.61/129.78/65.89) lat (ms,95%): 1973.38 err/s: 0.00 reconn/s: 0.00[ 300s ] thds: 30 tps: 32.27 qps: 639.95 (r/w/o: 439.33/136.09/64.54) lat (ms,95%): 1869.60 err/s: 0.00 reconn/s: 0.00SQL statistics: queries performed: read: 139958 write: 39988 other: 19994 total: 199940 transactions: 9997 (33.18 per sec.) queries: 199940 (663.60 per sec.) ignored errors: 0 (0.00 per sec.) reconnects: 0 (0.00 per sec.)General statistics: total time: 301.2969s total number of events: 9997Latency (ms): min: 13.53 avg: 901.57 max: 5107.53 95th percentile: 2238.47 sum: 9012972.28Threads fairness: events (avg/stddev): 333.2333/6.55 execution time (avg/stddev): 300.4324/0.32shellå¤„ç†ä¸€ä¸‹,æ–‡ä»¶å æœ€å¥½ä¸ºæµ‹è¯•çš„æ¡ä»¶ æ¯”å¦‚binlog_off binlog_on thread_30 thread9012345678grep &quot;^\\[&quot; binlog_off.txt |awk -F&#x27;(&#x27; &#x27;&#123;print $1&#125;&#x27;|sed -e &quot;s/\\[\\ /\\&#123;&#x27;time&#x27;:&#x27;/g&quot; -e &quot;s/\\ \\]//g&quot; -e &quot;s/:\\ /&#x27;:&#x27;/g&quot; -e &quot;s/\\ /&#x27;,&#x27;/g&quot; -e &quot;s/,&#x27;$/\\&#125;/g&quot;&#123;&#x27;time&#x27;:&#x27;5s&#x27;,&#x27;thds&#x27;:&#x27;30&#x27;,&#x27;tps&#x27;:&#x27;14.95&#x27;,&#x27;qps&#x27;:&#x27;391.01&#x27;&#125;&#123;&#x27;time&#x27;:&#x27;10s&#x27;,&#x27;thds&#x27;:&#x27;30&#x27;,&#x27;tps&#x27;:&#x27;27.33&#x27;,&#x27;qps&#x27;:&#x27;549.58&#x27;&#125;&#123;&#x27;time&#x27;:&#x27;15s&#x27;,&#x27;thds&#x27;:&#x27;30&#x27;,&#x27;tps&#x27;:&#x27;29.01&#x27;,&#x27;qps&#x27;:&#x27;585.07&#x27;&#125;&#123;&#x27;time&#x27;:&#x27;20s&#x27;,&#x27;thds&#x27;:&#x27;30&#x27;,&#x27;tps&#x27;:&#x27;27.51&#x27;,&#x27;qps&#x27;:&#x27;528.04&#x27;&#125;&#123;&#x27;time&#x27;:&#x27;25s&#x27;,&#x27;thds&#x27;:&#x27;30&#x27;,&#x27;tps&#x27;:&#x27;24.80&#x27;,&#x27;qps&#x27;:&#x27;503.08&#x27;&#125;&#123;&#x27;time&#x27;:&#x27;30s&#x27;,&#x27;thds&#x27;:&#x27;30&#x27;,&#x27;tps&#x27;:&#x27;34.22&#x27;,&#x27;qps&#x27;:&#x27;688.40&#x27;&#125;å¤„ç†æˆå­—å…¸çš„æ ·å­,ç„¶åç”¨pythonçš„ evalå‡½æ•°å°±èƒ½è½¬æ¢æˆå­—å…¸äº†.æˆ‘è¿™é‡Œåªå–äº†è¾“å‡ºç»“æœçš„tps qps thdséƒ¨åˆ†æ•°æ® å‡ºå›¾ç”¨chartsåº“,æˆ‘ç”¨çš„jupyter notebookç›´æ¥æ‰§è¡Œçš„æµ‹è¯•æœºè·‘å®Œæ–‡ä»¶é‚£ä¸‹æ¥,ç»Ÿä¸€å‘½åæµ‹è¯•æœºè·‘å‡ºæ¥çš„ç»“æœä¸º.txt,å¤„ç†å®Œçš„ä¸º.out1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980import chartsimport subprocessimport osclass MyCharts: def __init__(self,file_list,qpsortps,title,interval=None): self.file_list=file_list self.qpsortps=qpsortps self.interval=interval self.title=title self.options = &#123; &#x27;title&#x27;:&#123;&#x27;text&#x27;:self.title&#125;, &#x27;xAxis&#x27;:&#123; &#x27;labels&#x27;:&#123; &#x27;step&#x27;:1 &#125;, &#125;, &#x27;yAxis&#x27;:&#123; &#x27;title&#x27;:&#123;&#x27;text&#x27;:self.qpsortps&#125;, &#125;, &#x27;chart&#x27;: &#123; &#x27;type&#x27;: &#x27;line&#x27;, &#x27;zoomType&#x27;: &#x27;x&#x27;, &#x27;panning&#x27;: &#x27;true&#x27;, &#x27;panKey&#x27;: &#x27;shift&#x27; &#125;, &#125; def getOne(self,file): with open(file,&#x27;r&#x27;) as data: dicList=[] for line in data: dic=eval(line.strip()) if self.interval: if int(dic[&#x27;time&#x27;][:-1])%self.interval == 0: dicList.append(dic) else: dicList.append(dic) timeList,qpsortpsList=[],[] for i in dicList: timeList.append(int(i[&#x27;time&#x27;][:-1])) if self.qpsortps == &#x27;qps&#x27;: qpsortpsList.append(float(i[&#x27;qps&#x27;])) else: qpsortpsList.append(float(i[&#x27;tps&#x27;])) qpsortpsData=list(zip(timeList,qpsortpsList)) temp = file[file.rindex(&#x27;/&#x27;)+1:file.rindex(&#x27;.&#x27;)] return &#123;&#x27;data&#x27;:qpsortpsData,&#x27;name&#x27;:temp&#125; def getMulti(self): s1List = [] for file in self.file_list: s1List.append(self.getOne(file)) return s1Listdef etl(file_list): for file in file_list: file_txt=&#x27;/Users/TiM/sysbench_file/&#x27;+file+&#x27;.txt&#x27; file_out=&#x27;/Users/TiM/sysbench_file/&#x27;+file+&#x27;.out&#x27; if not os.path.exists(file_out): cmd=&#x27;&#x27;&#x27;grep &quot;^\\[&quot; %s \\ |awk -F&#x27;(&#x27; &#x27;&#123;print $1&#125;&#x27;|sed -e &quot;s/\\[\\ /\\&#123;&#x27;time&#x27;:&#x27;/g&quot; -e \\ &quot;s/\\ \\]//g&quot; -e &quot;s/:\\ /&#x27;:&#x27;/g&quot; -e &quot;s/\\ /&#x27;,&#x27;/g&quot; -e &quot;s/,&#x27;$/\\&#125;/g&quot; \\ &gt; %s&#x27;&#x27;&#x27; % (file_txt,file_out) subprocess.call(cmd,shell=True)etl([&#x27;oltp_point_select&#x27;,&#x27;oltp_read_only&#x27;,&#x27;oltp_read_write&#x27;]) file_list = [ &#x27;/Users/TiM/sysbench_file/oltp_read_write.out&#x27;, &#x27;/Users/TiM/sysbench_file/oltp_point_select.out&#x27;, &#x27;/Users/TiM/sysbench_file/oltp_read_only.out&#x27; ]char_1=MyCharts(file_list,&#x27;qps&#x27;,&#x27;16G 4core Benchmark&#x27;)res=char_1.getMulti()charts.plot(res,options=char_1.options,show=&#x27;inline&#x27;,)","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Sysbench","slug":"Sysbench","permalink":"http://fuxkdb.com/tags/Sysbench/"}]},{"title":"docoptè¯¦è§£","slug":"docoptè¯¦è§£","date":"2017-06-28T14:00:00.000Z","updated":"2017-08-07T02:18:00.000Z","comments":true,"path":"2017/06/28/docoptè¯¦è§£/","link":"","permalink":"http://fuxkdb.com/2017/06/28/docopt%E8%AF%A6%E8%A7%A3/","excerpt":"12345678910111213141516Naval Fate.Usage: naval_fate ship new &lt;name&gt;... naval_fate ship &lt;name&gt; move &lt;x&gt; &lt;y&gt; [--speed=&lt;kn&gt;] naval_fate ship shoot &lt;x&gt; &lt;y&gt; naval_fate mine (set|remove) &lt;x&gt; &lt;y&gt; [--moored|--drifting] naval_fate -h | --help naval_fate --versionOptions: -h --help Show this screen. --version Show version. --speed=&lt;kn&gt; Speed in knots [default: 10]. --moored Moored (anchored) mine. --drifting Drifting mine. è¯¥ç¤ºä¾‹æè¿°äº†å¯æ‰§è¡Œçš„naval_fateçš„ç•Œé¢ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤(shipï¼Œnewï¼Œmoveç­‰)çš„ä¸åŒç»„åˆï¼Œé€‰é¡¹(-hï¼Œâ€“helpï¼Œâ€“speed = ç­‰)å’Œ ä½ç½®å‚æ•°(ï¼Œï¼Œ). ç¤ºä¾‹ä½¿ç”¨æ–¹æ‹¬å·â€œ[]â€ï¼Œåœ†æ‹¬å·â€œ()â€ï¼Œç®¡é“â€œ|â€ å’Œçœç•¥å·â€œâ€¦â€æ¥æè¿°å¯é€‰çš„ï¼Œå¿…éœ€çš„ï¼Œç›¸äº’æ’æ–¥çš„å’Œé‡å¤çš„å…ƒç´ . ä¸€èµ·ï¼Œè¿™äº›å…ƒç´ å½¢æˆæœ‰æ•ˆçš„ä½¿ç”¨æ¨¡å¼ï¼Œæ¯ä¸ªéƒ½ä»¥ç¨‹åºçš„åç§°naval_fateå¼€å¤´. Below the usage patternsï¼Œæœ‰ä¸€ä¸ªåŒ…å«è¯´æ˜çš„é€‰é¡¹åˆ—è¡¨. å®ƒä»¬æè¿°ä¸€ä¸ªé€‰é¡¹æ˜¯å¦å…·æœ‰çŸ­/é•¿å½¢å¼(-hï¼Œâ€“help)ï¼Œé€‰é¡¹æ˜¯å¦å…·æœ‰å‚æ•°(-speed = )ï¼Œä»¥åŠè¯¥å‚æ•°æ˜¯å¦å…·æœ‰é»˜è®¤å€¼([default:10]). Usageæ¨¡å¼åœ¨Usage:(ä¸åŒºåˆ†å¤§å°å†™) å…³é”®å­— é—´å‡ºç°,å¹¶ä¸”æ˜¾ç¤ºçš„ç©ºäº†ä¸€è¡Œçš„éƒ¨åˆ† è¢«è§£é‡Šä¸º usage patternåœ¨â€Usage:â€åå‡ºç°çš„ç¬¬ä¸€ä¸ªå•è¯è¢«è§£é‡Šä¸ºç¨‹åºçš„åå­—. ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ç¤ºä¾‹,è¯¥ç¤ºä¾‹æ²¡æœ‰ä»»ä½•å‘½ä»¤è¡Œå‚æ•°1#### Usage: my_programç¨‹åºå¯ä»¥ä½¿ç”¨ç”¨äºæè¿°æ¨¡å¼çš„å„ç§å…ƒç´ åˆ—å‡ºå‡ ä¸ªæ¨¡å¼:123456Usage: my_program command --option &lt;argument&gt; my_program [&lt;optional-argument&gt;] my_program --another-option=&lt;with-argument&gt; my_program (--either-that-option | &lt;or-this-argument&gt;) my_program &lt;repeating-argument&gt; &lt;repeating-argument&gt;... ARGUMENT","text":"12345678910111213141516Naval Fate.Usage: naval_fate ship new &lt;name&gt;... naval_fate ship &lt;name&gt; move &lt;x&gt; &lt;y&gt; [--speed=&lt;kn&gt;] naval_fate ship shoot &lt;x&gt; &lt;y&gt; naval_fate mine (set|remove) &lt;x&gt; &lt;y&gt; [--moored|--drifting] naval_fate -h | --help naval_fate --versionOptions: -h --help Show this screen. --version Show version. --speed=&lt;kn&gt; Speed in knots [default: 10]. --moored Moored (anchored) mine. --drifting Drifting mine. è¯¥ç¤ºä¾‹æè¿°äº†å¯æ‰§è¡Œçš„naval_fateçš„ç•Œé¢ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤(shipï¼Œnewï¼Œmoveç­‰)çš„ä¸åŒç»„åˆï¼Œé€‰é¡¹(-hï¼Œâ€“helpï¼Œâ€“speed = ç­‰)å’Œ ä½ç½®å‚æ•°(ï¼Œï¼Œ). ç¤ºä¾‹ä½¿ç”¨æ–¹æ‹¬å·â€œ[]â€ï¼Œåœ†æ‹¬å·â€œ()â€ï¼Œç®¡é“â€œ|â€ å’Œçœç•¥å·â€œâ€¦â€æ¥æè¿°å¯é€‰çš„ï¼Œå¿…éœ€çš„ï¼Œç›¸äº’æ’æ–¥çš„å’Œé‡å¤çš„å…ƒç´ . ä¸€èµ·ï¼Œè¿™äº›å…ƒç´ å½¢æˆæœ‰æ•ˆçš„ä½¿ç”¨æ¨¡å¼ï¼Œæ¯ä¸ªéƒ½ä»¥ç¨‹åºçš„åç§°naval_fateå¼€å¤´. Below the usage patternsï¼Œæœ‰ä¸€ä¸ªåŒ…å«è¯´æ˜çš„é€‰é¡¹åˆ—è¡¨. å®ƒä»¬æè¿°ä¸€ä¸ªé€‰é¡¹æ˜¯å¦å…·æœ‰çŸ­/é•¿å½¢å¼(-hï¼Œâ€“help)ï¼Œé€‰é¡¹æ˜¯å¦å…·æœ‰å‚æ•°(-speed = )ï¼Œä»¥åŠè¯¥å‚æ•°æ˜¯å¦å…·æœ‰é»˜è®¤å€¼([default:10]). Usageæ¨¡å¼åœ¨Usage:(ä¸åŒºåˆ†å¤§å°å†™) å…³é”®å­— é—´å‡ºç°,å¹¶ä¸”æ˜¾ç¤ºçš„ç©ºäº†ä¸€è¡Œçš„éƒ¨åˆ† è¢«è§£é‡Šä¸º usage patternåœ¨â€Usage:â€åå‡ºç°çš„ç¬¬ä¸€ä¸ªå•è¯è¢«è§£é‡Šä¸ºç¨‹åºçš„åå­—. ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ç¤ºä¾‹,è¯¥ç¤ºä¾‹æ²¡æœ‰ä»»ä½•å‘½ä»¤è¡Œå‚æ•°1#### Usage: my_programç¨‹åºå¯ä»¥ä½¿ç”¨ç”¨äºæè¿°æ¨¡å¼çš„å„ç§å…ƒç´ åˆ—å‡ºå‡ ä¸ªæ¨¡å¼:123456Usage: my_program command --option &lt;argument&gt; my_program [&lt;optional-argument&gt;] my_program --another-option=&lt;with-argument&gt; my_program (--either-that-option | &lt;or-this-argument&gt;) my_program &lt;repeating-argument&gt; &lt;repeating-argument&gt;... ARGUMENT ä»¥â€&lt;â€å¼€å§‹,â€&gt;â€ç»“å°¾ å’Œ å¤§å†™å­—æ¯çš„è¢«è§£é‡Šä¸º ä½ç½®å‚æ•° ####-o --optionä»¥ä¸€ä¸ªæˆ–ä¸¤ä¸ªç ´æŠ˜å·å¼€å¤´çš„å•è¯(é™¤äº†â€œ - â€ï¼Œâ€œ - â€ä¹‹å¤–)åˆ†åˆ«è¢«è§£é‡Šä¸ºçŸ­(ä¸€ä¸ªå­—æ¯)æˆ–é•¿é€‰é¡¹. çŸ­é€‰é¡¹å¯ä»¥â€œå †å â€ï¼Œè¿™æ„å‘³ç€-abcç­‰åŒäº-a -b -c. é•¿é€‰é¡¹å¯ä»¥åœ¨ç©ºæ ¼æˆ–ç­‰äºâ€œ=â€ä¹‹åæŒ‡å®šå‚æ•°: â€“input = ARGç›¸å½“äº - è¾“å…¥ARG çŸ­é€‰é¡¹å¯ä»¥åœ¨å¯é€‰ç©ºæ ¼ä¹‹åæŒ‡å®šå‚æ•°:-f FILEç­‰æ•ˆäº-fFILE æ³¨æ„ï¼Œå†™å…¥ â€“input(ä¸â€“input = ARGç›¸æ¯”)æ˜¯å®¹æ˜“äº§ç”Ÿæ­§ä¹‰çš„ï¼Œè¿™æ„å‘³ç€ä¸å¯èƒ½çŸ¥é“ARGæ˜¯é€‰é¡¹çš„å‚æ•°è¿˜æ˜¯ä½ç½®å‚æ•°. åœ¨Usage:ä¸­ï¼Œåªæœ‰åœ¨æä¾›è¯¥é€‰é¡¹çš„description(å¦‚ä¸‹æ‰€è¿°)æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹æ‰ä¼šè¢«è§£é‡Šä¸ºå‚æ•°é€‰é¡¹. å¦åˆ™å®ƒå°†è¢«è§£é‡Šä¸ºä¸€ä¸ªé€‰é¡¹å’Œå•ç‹¬çš„ä½ç½®å‚æ•°.åŒæ ·,ä½¿ç”¨-f FILEå’Œ-fFILEä¹Ÿå¯èƒ½äº§ç”Ÿæ­§ä¹‰,åè€…å¯èƒ½æ˜¯ä¸€ç»„æ–­é€‰é¡¹çš„å †å (å°±åƒä¹‹å‰çš„ä¾‹å­-abcæ˜¯-a -b -cçš„å †å ),æˆ–è€…æ˜¯ä¸€ä¸ªå¸¦å‚æ•°å¾—é€‰é¡¹.åªæœ‰åœ¨æä¾›äº†è¯¥é€‰é¡¹çš„descriptionæ—¶ï¼Œè¿™äº›ç¬¦å·æ‰ä¼šè¢«è¢«è§£é‡Šä¸ºä¸€ä¸ªå¸¦å‚æ•°çš„é€‰é¡¹. commandæ‰€æœ‰å…¶ä»–ä¸ç¬¦åˆâ€“optionsæˆ–çš„çº¦å®šçš„å•è¯éƒ½è¢«è§£é‡Šä¸º(sub)command. [optional elements] å¯é€‰å…ƒç´ è¢«æ–¹æ‹¬å·â€[]â€åŒ…å›´èµ·æ¥çš„å…ƒç´ (options, arguments, commands)è¢«æ ‡è®°ä¸ºå¯é€‰é¡¹.Usage: my_program [command --option &lt;argument&gt;]ç­‰ä»·äºUsage: my_program [command] [--option] [&lt;argument&gt;] (required elements) å¿…è¦å…ƒç´ é»˜è®¤æƒ…å†µä¸‹éœ€è¦æ‰€æœ‰å…ƒç´ ï¼Œå¦‚æœä¸åŒ…æ‹¬åœ¨æ‹¬å·â€œ[]â€ä¸­. ä½†æ˜¯ï¼Œæœ‰æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨â€œâ€()â€œæ¥æ˜ç¡®æ ‡è®°å…ƒç´ . ä¾‹å¦‚ï¼Œå½“æ‚¨éœ€è¦ç»„åˆç›¸äº’æ’æ–¥çš„å…ƒç´ (è¯·å‚é˜…ä¸‹ä¸€èŠ‚):1Usage: my_program (--either-this &lt;and-that&gt; | &lt;or-this&gt;)å¦ä¸€ä¸ªç”¨ä¾‹æ˜¯å½“æ‚¨éœ€è¦æŒ‡å®šå¦‚æœå­˜åœ¨ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™éœ€è¦å¦å¤–ä¸€ä¸ªå…ƒç´ :1Usage: my_program [(&lt;one-argument&gt; &lt;another-argument&gt;)]åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰æ•ˆçš„ç¨‹åºè°ƒç”¨å¯ä»¥æ˜¯æ— å‚æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯2ä¸ªå‚æ•°. element|anotherç›¸äº’æ’æ–¥çš„å…ƒç´ å¯ä»¥ç”¨ç®¡é“â€œ|â€åˆ†éš”å¼€ å¦‚ä¸‹:1Usage: my_program go (--up | --down | --left | --right)å½“éœ€è¦ç›¸äº’æ’æ–¥çš„æƒ…å†µä¹‹ä¸€æ—¶ï¼Œä½¿ç”¨æ‹¬å·â€œ()â€å¯¹å…ƒç´ è¿›è¡Œåˆ†ç»„. å½“ä¸éœ€è¦ç›¸äº’æ’æ–¥çš„æƒ…å†µæ—¶ï¼Œä½¿ç”¨æ‹¬å·â€œ[]â€åˆ†ç»„å…ƒç´ : Note, that specifying several patterns works exactly like pipe â€œ|â€, that is:12Usage: my_program run [--fast] my_program jump [--high]ç­‰ä»·äº1Usage: my_program (run [--fast] | jump [--high]) elementâ€¦ä½¿ç”¨çœç•¥å·â€œâ€¦â€æ¥æŒ‡å®šå·¦ä¾§çš„å‚æ•°(æˆ–å‚æ•°ç»„)å¯ä»¥é‡å¤ä¸€æ¬¡æˆ–å¤šæ¬¡:12Usage: my_program open &lt;file&gt;... my_program move (&lt;from&gt; &lt;to&gt;)...æ‚¨å¯ä»¥çµæ´»åœ°æŒ‡å®šæ‰€éœ€çš„å‚æ•°æ•°. ä»¥ä¸‹æ˜¯éœ€è¦é›¶ä¸ªæˆ–å¤šä¸ªå‚æ•°çš„3ç§(å†—ä½™)æ–¹æ³•:123Usage: my_program [&lt;file&gt;...] my_program [&lt;file&gt;]... my_program [&lt;file&gt; [&lt;file&gt; ...]] ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°1Usage: my_program &lt;file&gt;...ä¸¤ä¸ªæˆ–å¤šä¸ªå‚æ•°1Usage: my_program &lt;file&gt; &lt;file&gt;... [options]â€œ[options]â€æ˜¯ä¸€ç§å¿«æ·æ–¹å¼ï¼Œå¯ä»¥é¿å…åœ¨æ¨¡å¼ä¸­åˆ—å‡ºæ‰€æœ‰é€‰é¡¹(å¸¦æœ‰è¯´æ˜çš„é€‰é¡¹åˆ—è¡¨). ä¾‹å¦‚:12345Usage: my_program [options] &lt;path&gt;--all List everything.--long Long output.--human-readable Display in human-readable format.ç­‰ä»·äº12345Usage: my_program [--all --long --human-readable] &lt;path&gt;--all List everything.--long Long output.--human-readable Display in human-readable format.å¦‚æœæ‚¨æœ‰å¾ˆå¤šé€‰é¡¹ï¼Œå¹¶ä¸”æ‰€æœ‰é€‰é¡¹éƒ½é€‚ç”¨äºå…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œè¿™å°†éå¸¸æœ‰ç”¨. æˆ–è€…ï¼Œå¦‚æœæ‚¨æœ‰çŸ­ç‰ˆæœ¬å’Œé•¿ç‰ˆæœ¬çš„é€‰é¡¹(specified in option description part)ï¼Œyou can list either of them in a pattern: 12345Usage: my_program [-alh] &lt;path&gt;-a, --all List everything.-l, --long Long output.-h, --human-readable Display in human-readable format. [â€“]åŒé‡ç ´æŠ˜å·â€œ - â€ï¼Œå½“ä¸æ˜¯é€‰é¡¹çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œé€šå¸¸ç”¨ä½œåˆ†éš”é€‰é¡¹å’Œä½ç½®å‚æ•°çš„çº¦å®šï¼Œä»¥ä¾¿å¤„ç†ä¾‹å¦‚æ–‡ä»¶åå¯èƒ½è¢«è¯¯è®¤ä¸ºé€‰é¡¹çš„æƒ…å†µ. ä¸ºäº†æ”¯æŒè¿™ä¸ªçº¦å®šï¼Œåœ¨ä½ç½®å‚æ•°ä¹‹å‰æ·»åŠ â€œ[ - ]â€åˆ°ä½ çš„æ¨¡å¼ä¸­.1Usage: my_program [options] [--] &lt;file&gt;...Apart from this special meaning, â€œâ€“â€ is just a normal command, so you can apply any previously-described operations, for example, make it required (by dropping brackets â€œ[ ]â€) [-]ä¸€ä¸ªå•ç‹¬çš„ç ´æŠ˜å·â€œ - â€ï¼Œå½“ä¸æ˜¯é€‰é¡¹çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå¸¸å¸¸è¢«ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç¨‹åºåº”è¯¥å¤„ç†stdinè€Œä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶. å¦‚æœä½ æƒ³éµå¾ªè¿™ä¸ªæƒ¯ä¾‹ï¼Œåœ¨ä½ çš„æ¨¡å¼ä¸­æ·»åŠ â€œ[ - ]â€. â€œ - â€æœ¬èº«åªæ˜¯ä¸€ä¸ªæ­£å¸¸çš„å‘½ä»¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ„ä¹‰. Option descriptionsé€‰é¡¹æè¿°åŒ…å«æ‚¨æ”¾åœ¨ä½¿ç”¨æ¨¡å¼ä¸‹çš„é€‰é¡¹åˆ—è¡¨.å³ä½¿åœ¨usage patternä¸­æ²¡æœ‰äº§ç”Ÿæ­§ä¹‰ä¹Ÿå¯ä»¥æŒ‡å®šä»–ä»¬é€‰é¡¹çš„æè¿°å…è®¸æŒ‡å®š: äº’ä¸ºåŒä¹‰è¯çš„çŸ­é€‰é¡¹å’Œé•¿é€‰é¡¹ å¸¦å‚æ•°å¾—é€‰é¡¹ é€‰é¡¹å‚æ•°å¾—é»˜è®¤å€¼ The rules are as follows:ä»¥â€œ - â€æˆ–â€œ â€“ â€(ä¸åŒ…æ‹¬ç©ºæ ¼)å¼€å¤´çš„æ¯ä¸€è¡Œéƒ½è¢«è§†ä¸ºä¸€ä¸ªé€‰é¡¹æè¿°ï¼Œä¾‹å¦‚: 1234Options: --verbose # GOOD -o FILE # GOODOther: --bad # BAD, line does not start with dash &quot;-&quot; é”™è¯¯çš„ç¤ºä¾‹,ä¸æ˜¯ä»¥&#x27;-&#x27;å¼€å¤´çš„è¡Œ è¦æŒ‡å®šä¸€ä¸ªé€‰é¡¹æœ‰ä¸€ä¸ªå‚æ•°ï¼Œè¯·åœ¨ç©ºæ ¼(æˆ–ç­‰äºâ€œ=â€ç¬¦å·)åé¢æ”¾ç½®ä¸€ä¸ªæè¿°è¯¥å‚æ•°çš„å•è¯ï¼Œå¦‚ä¸‹æ‰€ç¤º. éµå¾ªæˆ–UPPER-CASEçº¦å®šçš„é€‰é¡¹å‚æ•°. å¦‚æœè¦åˆ†ç¦»é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨é€—å·. åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸¤è¡Œå‡æœ‰æ•ˆï¼Œä½†å»ºè®®ä½¿ç”¨å•ä¸€æ ·å¼.12-o FILE --output=FILE # without comma, with &quot;=&quot; sign-i &lt;file&gt;, --input &lt;file&gt; # with comma, without &quot;=&quot; sign ä½¿ç”¨ä¸¤ä¸ªç©ºæ ¼åˆ†éš”é€‰é¡¹å’Œå…¶æè¿°ä¿¡æ¯123456--verbose MORE text. # BAD, will be treated as if verbose # option had an argument MORE, so use # 2 spaces instead-q Quit. # GOOD-o FILE Output file. # GOOD--stdout Use stdout. # GOOD, 2 spaceså¦‚æœè¦ä¸ºå‚æ•°çš„é€‰é¡¹è®¾ç½®é»˜è®¤å€¼ï¼Œè¯·å°†å…¶æ”¾å…¥é€‰é¡¹çš„æè¿°ä¸­ï¼Œæ ¼å¼ä¸º[default:].123--coefficient=K The K coefficient [default: 2.95]--output=FILE Output file [default: test.txt]--directory=DIR Some directory [default: ./]","categories":[],"tags":[{"name":"Python","slug":"Python","permalink":"http://fuxkdb.com/tags/Python/"}]},{"title":"ä¼ ç»Ÿå¤åˆ¶åœ¨çº¿åˆ‡æ¢åˆ°GTIDæ¨¡å¼","slug":"ä¼ ç»Ÿå¤åˆ¶åœ¨çº¿åˆ‡æ¢åˆ°GTIDæ¨¡å¼","date":"2017-06-17T14:00:00.000Z","updated":"2017-08-07T02:28:10.000Z","comments":true,"path":"2017/06/17/ä¼ ç»Ÿå¤åˆ¶åœ¨çº¿åˆ‡æ¢åˆ°GTIDæ¨¡å¼/","link":"","permalink":"http://fuxkdb.com/2017/06/17/%E4%BC%A0%E7%BB%9F%E5%A4%8D%E5%88%B6%E5%9C%A8%E7%BA%BF%E5%88%87%E6%8D%A2%E5%88%B0GTID%E6%A8%A1%E5%BC%8F/","excerpt":"ä¼ ç»Ÿå¤åˆ¶åˆ‡æ¢åˆ°GTIDæ¨¡å¼5.7.6ä»¥åå‚æ•°gtid_modeå¯ä»¥åŠ¨æ€ä¿®æ”¹GTID_MODE: OFF å½»åº•å…³é—­GTID,å¦‚æœå…³é—­çŠ¶æ€çš„å¤‡åº“æ¥å—åˆ°å¸¦GTIDçš„äº‹åŠ¡,åˆ™å¤åˆ¶ä¸­æ–­ OFF_PERMISSIVE å¯ä»¥è®¤ä¸ºæ˜¯å…³é—­GTIDå‰çš„è¿‡æ¸¡é˜¶æ®µ,ä¸»åº“åœ¨è®¾ç½®æˆè¯¥å€¼åä¸å†ç”ŸæˆGTID,å¤‡åº“åœ¨æ¥å—åˆ°å¸¦GTID å’Œä¸å¸¦GTIDçš„äº‹åŠ¡éƒ½å¯ä»¥å®¹å¿ä¸»åº“åœ¨å…³é—­GTIDæ—¶,æ‰§è¡Œäº‹åŠ¡ä¼šäº§ç”Ÿä¸€ä¸ªAnonymous_Gtidäº‹ä»¶,ä¼šåœ¨å¤‡åº“æ‰§è¡Œ:SET @@SESSION.GTID_NEXT= â€˜ANONYMOUSâ€™å¤‡åº“åœ¨æ‰§è¡ŒåŒ¿åäº‹åŠ¡æ—¶,å°±ä¸ä¼šå»å°è¯•ç”Ÿæˆæœ¬åœ°GTIDäº† ON_PERMISSIVE å¯ä»¥è®¤ä¸ºæ˜¯æ‰“å¼€GTIDå‰çš„è¿‡æ¸¡é˜¶æ®µ,ä¸»åº“åœ¨è®¾ç½®æˆè¯¥å€¼åä¼šäº§ç”ŸGTID,åŒæ—¶å¤‡åº“ä¾ç„¶å®¹å¿å¸¦GTIDå’Œä¸å¸¦GTIDçš„äº‹åŠ¡ ON å®Œå…¨æ‰“å¼€GTID,å¦‚æœæ‰“å¼€çŠ¶æ€çš„å¤‡åº“æ¥å—åˆ°ä¸å¸¦GTIDçš„äº‹åŠ¡,åˆ™å¤åˆ¶ä¸­æ–­ å‡†å¤‡å·¥ä½œ1.æ‹“æ‰‘ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨éƒ½å¿…é¡»ä½¿ç”¨MySQL 5.7.6æˆ–æ›´é«˜ç‰ˆæœ¬. é™¤éæ‹“æ‰‘ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨éƒ½ä½¿ç”¨æ­¤ç‰ˆæœ¬,å¦åˆ™æ— æ³•åœ¨ä»»ä½•å•ä¸ªæœåŠ¡å™¨ä¸Šå¯ç”¨GTIDäº‹åŠ¡.2.æ‰€æœ‰æœåŠ¡å™¨éƒ½å°†gtid_modeè®¾ç½®ä¸ºé»˜è®¤å€¼OFF. The following procedure can be paused at any time and later resumed where it was, or reversed by jumping to the corresponding step of Section 16.1.5.3, â€œDisabling GTID Transactions Onlineâ€, the online procedure to disable GTIDs. This makes the procedure fault-tolerant because any unrelated issues that may appear in the middle of the procedure can be handled as usual, and then the procedure continued where it was left off.åˆ‡æ¢è¿‡ç¨‹å¯ä»¥å†ä»»æ„æ—¶åˆ»åœæ­¢,å¹¶ç¨åç»§ç»­æ‰§è¡Œ æ³¨æ„åœ¨æ¯ä¸€æ­¥æ‰§è¡Œå®Œå…¨å®Œæˆåå†æ‰§è¡Œä¸‹ä¸€æ­¥","text":"ä¼ ç»Ÿå¤åˆ¶åˆ‡æ¢åˆ°GTIDæ¨¡å¼5.7.6ä»¥åå‚æ•°gtid_modeå¯ä»¥åŠ¨æ€ä¿®æ”¹GTID_MODE: OFF å½»åº•å…³é—­GTID,å¦‚æœå…³é—­çŠ¶æ€çš„å¤‡åº“æ¥å—åˆ°å¸¦GTIDçš„äº‹åŠ¡,åˆ™å¤åˆ¶ä¸­æ–­ OFF_PERMISSIVE å¯ä»¥è®¤ä¸ºæ˜¯å…³é—­GTIDå‰çš„è¿‡æ¸¡é˜¶æ®µ,ä¸»åº“åœ¨è®¾ç½®æˆè¯¥å€¼åä¸å†ç”ŸæˆGTID,å¤‡åº“åœ¨æ¥å—åˆ°å¸¦GTID å’Œä¸å¸¦GTIDçš„äº‹åŠ¡éƒ½å¯ä»¥å®¹å¿ä¸»åº“åœ¨å…³é—­GTIDæ—¶,æ‰§è¡Œäº‹åŠ¡ä¼šäº§ç”Ÿä¸€ä¸ªAnonymous_Gtidäº‹ä»¶,ä¼šåœ¨å¤‡åº“æ‰§è¡Œ:SET @@SESSION.GTID_NEXT= â€˜ANONYMOUSâ€™å¤‡åº“åœ¨æ‰§è¡ŒåŒ¿åäº‹åŠ¡æ—¶,å°±ä¸ä¼šå»å°è¯•ç”Ÿæˆæœ¬åœ°GTIDäº† ON_PERMISSIVE å¯ä»¥è®¤ä¸ºæ˜¯æ‰“å¼€GTIDå‰çš„è¿‡æ¸¡é˜¶æ®µ,ä¸»åº“åœ¨è®¾ç½®æˆè¯¥å€¼åä¼šäº§ç”ŸGTID,åŒæ—¶å¤‡åº“ä¾ç„¶å®¹å¿å¸¦GTIDå’Œä¸å¸¦GTIDçš„äº‹åŠ¡ ON å®Œå…¨æ‰“å¼€GTID,å¦‚æœæ‰“å¼€çŠ¶æ€çš„å¤‡åº“æ¥å—åˆ°ä¸å¸¦GTIDçš„äº‹åŠ¡,åˆ™å¤åˆ¶ä¸­æ–­ å‡†å¤‡å·¥ä½œ1.æ‹“æ‰‘ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨éƒ½å¿…é¡»ä½¿ç”¨MySQL 5.7.6æˆ–æ›´é«˜ç‰ˆæœ¬. é™¤éæ‹“æ‰‘ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨éƒ½ä½¿ç”¨æ­¤ç‰ˆæœ¬,å¦åˆ™æ— æ³•åœ¨ä»»ä½•å•ä¸ªæœåŠ¡å™¨ä¸Šå¯ç”¨GTIDäº‹åŠ¡.2.æ‰€æœ‰æœåŠ¡å™¨éƒ½å°†gtid_modeè®¾ç½®ä¸ºé»˜è®¤å€¼OFF. The following procedure can be paused at any time and later resumed where it was, or reversed by jumping to the corresponding step of Section 16.1.5.3, â€œDisabling GTID Transactions Onlineâ€, the online procedure to disable GTIDs. This makes the procedure fault-tolerant because any unrelated issues that may appear in the middle of the procedure can be handled as usual, and then the procedure continued where it was left off.åˆ‡æ¢è¿‡ç¨‹å¯ä»¥å†ä»»æ„æ—¶åˆ»åœæ­¢,å¹¶ç¨åç»§ç»­æ‰§è¡Œ æ³¨æ„åœ¨æ¯ä¸€æ­¥æ‰§è¡Œå®Œå…¨å®Œæˆåå†æ‰§è¡Œä¸‹ä¸€æ­¥ ä»ä¼ ç»Ÿå¤åˆ¶æ¨¡å¼åˆ‡æ¢åˆ°GTIDæ¨¡å¼1.åœ¨æ¯ä¸ªseveræ‰§è¡Œ:1SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN; è®©æœåŠ¡å™¨ä¸æ‚¨çš„æ­£å¸¸å·¥ä½œè´Ÿè½½è¿è¡Œä¸€æ®µæ—¶é—´å¹¶ç›‘è§†æ—¥å¿—. å¦‚æœæ­¤æ­¥éª¤åœ¨æ—¥å¿—ä¸­å¯¼è‡´ä»»ä½•è­¦å‘Š,è¯·è°ƒæ•´åº”ç”¨ç¨‹åº,ä»¥ä½¿å…¶ä»…ä½¿ç”¨å…¼å®¹GTIDçš„åŠŸèƒ½,å¹¶ä¸”ä¸ä¼šäº§ç”Ÿä»»ä½•è­¦å‘Š. Importantè¿™æ˜¯ç¬¬ä¸€ä¸ªé‡è¦æ­¥éª¤. æ‚¨å¿…é¡»ç¡®ä¿åœ¨è¿›å…¥ä¸‹ä¸€æ­¥éª¤ä¹‹å‰ä¸ä¼šåœ¨é”™è¯¯æ—¥å¿—ä¸­ç”Ÿæˆè­¦å‘Š. 2.åœ¨æ¯ä¸ªseveræ‰§è¡Œ:1SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON; 3.åœ¨æ¯ä¸ªseveræ‰§è¡Œ:1SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE; å“ªä¸ªæœåŠ¡å™¨é¦–å…ˆæ‰§è¡Œæ­¤è¯­å¥æ— å…³ç´§è¦,ä½†é‡è¦çš„æ˜¯æ‰€æœ‰æœåŠ¡å™¨åœ¨ä»»ä½•æœåŠ¡å™¨å¼€å§‹ä¸‹ä¸€æ­¥ä¹‹å‰å®Œæˆæ­¤æ­¥éª¤. 4.åœ¨æ¯ä¸ªseveræ‰§è¡Œ:1SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE; å“ªä¸ªæœåŠ¡å™¨é¦–å…ˆæ‰§è¡Œæ­¤è¯­å¥æ— å…³ç´§è¦. 5.åœ¨æ¯ä¸ªæœåŠ¡å™¨ä¸Š,ç­‰å¾…çŠ¶æ€å˜é‡ONGOING_ANONYMOUS_TRANSACTION_COUNTä¸ºé›¶. å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æŸ¥è¯¢:1SHOW STATUS LIKE &#x27;ONGOING_ANONYMOUS_TRANSACTION_COUNT&#x27;;ONGOING_ANONYMOUS_TRANSACTION_COUNTæ˜¾ç¤ºå·²æ ‡è®°ä¸ºåŒ¿åçš„æ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡çš„æ•°é‡ æ³¨æ„:åœ¨ä»åº“ä¸Š,ç†è®ºä¸Šè¿™ä¸ªå€¼å¯èƒ½æ˜¾ç¤ºä¸ºé›¶,ä¹‹ååˆæ˜¾ç¤ºä¸ºéé›¶å€¼.è¿™å¹¶ä¸æ˜¯é—®é¢˜,åªè¦æ˜¾ç¤ºä¸ºé›¶ä¸€æ¬¡å³å¯ 6.ç­‰å¾…ç”Ÿæˆåˆ°æ­¥éª¤5çš„æ‰€æœ‰äº‹åŠ¡å¤åˆ¶åˆ°æ‰€æœ‰æœåŠ¡å™¨. æ‚¨å¯ä»¥åœ¨ä¸åœæ­¢æ›´æ–°çš„æƒ…å†µä¸‹æ‰§è¡Œæ­¤æ“ä½œï¼šå”¯ä¸€é‡è¦çš„æ˜¯æ‰€æœ‰anonymous transactionséƒ½è¢«å¤åˆ¶äº†. æœ‰å…³æ£€æŸ¥æ‰€æœ‰åŒ¿åäº‹åŠ¡å·²å¤åˆ¶åˆ°æ‰€æœ‰æœåŠ¡å™¨çš„ä¸€ç§æ–¹æ³•,è¯·å‚è§ç¬¬16.1.5.4èŠ‚â€œéªŒè¯åŒ¿åäº‹åŠ¡çš„å¤åˆ¶â€. 7.If you use binary logs for anything other than replication, for example point in time backup and restore, wait until you do not need the old binary logs having transactions without GTIDs. For instance, after step 6 has completed, you can execute FLUSH LOGS on the server where you are taking backups. Then either explicitly take a backup or wait for the next iteration of any periodic backup routine you may have set up. Ideally, wait for the server to purge all binary logs that existed when step 6 was completed. Also wait for any backup taken before step 6 to expire. ImportantThis is the second important point. It is vital to understand that binary logs containing anonymous transactions, without GTIDs cannot be used after the next step. After this step, you must be sure that transactions without GTIDs do not exist anywhere in the topology. 8.åœ¨æ¯ä¸ªseveræ‰§è¡Œ:1SET @@GLOBAL.GTID_MODE = ON; 9.åœ¨æ¯ä¸ªseverçš„my.cnfé…ç½®æ–‡ä»¶ä¸­æ·»åŠ 12gtid-mode=ONENFORCE_GTID_CONSISTENCY = ON ç°åœ¨å¯ä»¥ä¿è¯æ‰€æœ‰äº‹åŠ¡éƒ½å…·æœ‰GTIDï¼ˆé™¤äº†åœ¨æ­¥éª¤5æˆ–æ›´æ—©ç‰ˆæœ¬ä¸­ç”Ÿæˆçš„å·²ç»å¤„ç†çš„äº‹åŠ¡ä¹‹å¤–ï¼‰. è¦å¼€å§‹ä½¿ç”¨GTIDåè®®,ä»¥ä¾¿ç¨åæ‰§è¡Œè‡ªåŠ¨æ•…éšœåˆ‡æ¢,è¯·åœ¨æ¯ä¸ªä»ç«™ä¸Šæ‰§è¡Œä»¥ä¸‹æ“ä½œ. æˆ–è€…,å¦‚æœä½¿ç”¨å¤šæºå¤åˆ¶,è¯·å¯¹æ¯ä¸ªé€šé“æ‰§è¡Œæ­¤æ“ä½œ,å¹¶åŒ…æ‹¬FOR CHANNELé€šé“å­å¥ï¼š123STOP SLAVE [FOR CHANNEL &#x27;channel&#x27;];CHANGE MASTER TO MASTER_AUTO_POSITION = 1 [FOR CHANNEL &#x27;channel&#x27;];START SLAVE [FOR CHANNEL &#x27;channel&#x27;]; å‚è€ƒ https://yq.aliyun.com/articles/41200","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤åˆ¶","slug":"MySQLå¤åˆ¶","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%8D%E5%88%B6/"}]},{"title":"ä¸»ä»åˆ‡æ¢å®ä¾‹(ä¼ ç»Ÿå¤åˆ¶)","slug":"ä¸»ä»åˆ‡æ¢å®ä¾‹(ä¼ ç»Ÿå¤åˆ¶)","date":"2017-06-13T14:00:00.000Z","updated":"2017-08-07T02:27:33.000Z","comments":true,"path":"2017/06/13/ä¸»ä»åˆ‡æ¢å®ä¾‹(ä¼ ç»Ÿå¤åˆ¶)/","link":"","permalink":"http://fuxkdb.com/2017/06/13/%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%E5%AE%9E%E4%BE%8B(%E4%BC%A0%E7%BB%9F%E5%A4%8D%E5%88%B6)/","excerpt":"ä¸»ä»åˆ‡æ¢æ¡ˆä¾‹Mä¸ºä¸»åº“,read writeS* ä¸ºä»åº“,read onlyç°åœ¨è¦å¯¹Mè¿›è¡Œç¡¬ä»¶ç»´æŠ¤,æå‡S1ä¸ºä¸»åº“,æ¥ç®¡ä¸šåŠ¡è¯»å†™. Mç»´æŠ¤å®Œæˆåä½œä¸ºä»åº“,å¦‚ä¸‹å›¾é¦–å…ˆå¯ä»¥è¿›è¡Œå¦‚ä¸‹åˆ‡æ¢ (A)å†è¿›è¡Œå¦‚ä¸‹åˆ‡æ¢(B) Aåˆ‡æ¢æ­¥éª¤é¦–å…ˆåœ¨S1åˆ¶é€ â€é”™è¯¯â€1234set session sql_log_bin=0;create table t_error_maker(id int);set session sql_log_bin=1;drop table t_error_maker;é€šè¿‡åœ¨sessionçº§åˆ«å…³é—­å†™å…¥binlog,å»ºè¡¨,å¼€å¯å†™å…¥binlog,åˆ è¡¨ åˆ¶é€ å¼‚å¸¸, å½“S11 S12 S13éƒ½æ‰§è¡Œåˆ°dropè¯­å¥æ—¶,ä¼šæŠ¥é”™åœæ­¢sql_thread.é€šè¿‡è¿™ç§æ–¹å¼,å¯ä»¥è®©å®ƒä»¬åœæ­¢åœ¨åŒä¸€ä¸ªä½ç½®.S121show master status è·å–File PositionS11 S13123stop slave;change masteråˆ°S12ä¸Šstart slave;S1212set global sql_slave_skip_counter=1;start slave sql_thread; Båˆ‡æ¢æ­¥éª¤M åœæ­¢ä¸šåŠ¡å†™æ“ä½œ123set global read_only=on; æ­¤æ—¶åªæœ‰superæƒé™ç”¨æˆ·èƒ½å†™å…¥set global super_read_only=on;ç¦æ­¢superæƒé™ç”¨æˆ·å†™#è¿™é‡Œæ²¡æœ‰é€šè¿‡ä¿®æ”¹ç”¨æˆ·å¯†ç çš„æ–¹å¼æ˜¯å› ä¸ºä¿®æ”¹ç”¨æˆ·å¯†ç å¯¹å·²ç»è¿æ¥ä¸Šæ¥çš„ç”¨æˆ·æ— æ•ˆç­‰M S1 S12 è·‘ä¸€è‡´å(File Positionç›¸åŒ) åœS12 sql_thread, å°†ä¸šåŠ¡å†™å…¥æ“ä½œæ¥å…¥S1æœ€åM1234set global read_only=off;set global super_read_only=off;change master åˆ°S12start slaveS121start slave sql_thread; ä»¥ä¸Šæ­¥éª¤é€šè¿‡è„šæœ¬å®Œæˆçš„è¯,å¯ä»¥åšåˆ°å¯¹ä¸šåŠ¡é€ æˆå¾ˆå°çš„å½±å“è„šæœ¬å®ä¾‹å¦‚ä¸‹,æ³¨é‡Šæ‰äº†Bæ­¥éª¤,å› ä¸ºéœ€è¦é…åˆåˆ‡æ¢ä¸šåŠ¡å†™å…¥æ“ä½œ","text":"ä¸»ä»åˆ‡æ¢æ¡ˆä¾‹Mä¸ºä¸»åº“,read writeS* ä¸ºä»åº“,read onlyç°åœ¨è¦å¯¹Mè¿›è¡Œç¡¬ä»¶ç»´æŠ¤,æå‡S1ä¸ºä¸»åº“,æ¥ç®¡ä¸šåŠ¡è¯»å†™. Mç»´æŠ¤å®Œæˆåä½œä¸ºä»åº“,å¦‚ä¸‹å›¾é¦–å…ˆå¯ä»¥è¿›è¡Œå¦‚ä¸‹åˆ‡æ¢ (A)å†è¿›è¡Œå¦‚ä¸‹åˆ‡æ¢(B) Aåˆ‡æ¢æ­¥éª¤é¦–å…ˆåœ¨S1åˆ¶é€ â€é”™è¯¯â€1234set session sql_log_bin=0;create table t_error_maker(id int);set session sql_log_bin=1;drop table t_error_maker;é€šè¿‡åœ¨sessionçº§åˆ«å…³é—­å†™å…¥binlog,å»ºè¡¨,å¼€å¯å†™å…¥binlog,åˆ è¡¨ åˆ¶é€ å¼‚å¸¸, å½“S11 S12 S13éƒ½æ‰§è¡Œåˆ°dropè¯­å¥æ—¶,ä¼šæŠ¥é”™åœæ­¢sql_thread.é€šè¿‡è¿™ç§æ–¹å¼,å¯ä»¥è®©å®ƒä»¬åœæ­¢åœ¨åŒä¸€ä¸ªä½ç½®.S121show master status è·å–File PositionS11 S13123stop slave;change masteråˆ°S12ä¸Šstart slave;S1212set global sql_slave_skip_counter=1;start slave sql_thread; Båˆ‡æ¢æ­¥éª¤M åœæ­¢ä¸šåŠ¡å†™æ“ä½œ123set global read_only=on; æ­¤æ—¶åªæœ‰superæƒé™ç”¨æˆ·èƒ½å†™å…¥set global super_read_only=on;ç¦æ­¢superæƒé™ç”¨æˆ·å†™#è¿™é‡Œæ²¡æœ‰é€šè¿‡ä¿®æ”¹ç”¨æˆ·å¯†ç çš„æ–¹å¼æ˜¯å› ä¸ºä¿®æ”¹ç”¨æˆ·å¯†ç å¯¹å·²ç»è¿æ¥ä¸Šæ¥çš„ç”¨æˆ·æ— æ•ˆç­‰M S1 S12 è·‘ä¸€è‡´å(File Positionç›¸åŒ) åœS12 sql_thread, å°†ä¸šåŠ¡å†™å…¥æ“ä½œæ¥å…¥S1æœ€åM1234set global read_only=off;set global super_read_only=off;change master åˆ°S12start slaveS121start slave sql_thread; ä»¥ä¸Šæ­¥éª¤é€šè¿‡è„šæœ¬å®Œæˆçš„è¯,å¯ä»¥åšåˆ°å¯¹ä¸šåŠ¡é€ æˆå¾ˆå°çš„å½±å“è„šæœ¬å®ä¾‹å¦‚ä¸‹,æ³¨é‡Šæ‰äº†Bæ­¥éª¤,å› ä¸ºéœ€è¦é…åˆåˆ‡æ¢ä¸šåŠ¡å†™å…¥æ“ä½œ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165# -*- coding: utf-8 -*- #coding=utf-8import pymysqlimport timefrom warnings import filterwarningsfrom progressive.bar import Barerror_message=u&quot;Error &#x27;Unknown table &#x27;fandb.t_error_maker&#x27;&#x27; on query. Default database: &#x27;fandb&#x27;. Query: &#x27;DROP TABLE `t_error_maker` /* generated by server */&#x27;&quot;def dec_progressive(func): def progess(*args, **kwargs): global i i += 100/9 bar.cursor.restore() bar.draw(value=i) return func(*args, **kwargs) return progess#åˆ›å»ºæ•°æ®åº“è¿æ¥å‡½æ•°@dec_progressivedef get_conn(host,port,user,password,db=&#x27;performance_schema&#x27;,charset=&#x27;utf8&#x27;): return pymysql.connect(host=host, port=int(port), user=user,password=password,db=db,charset=charset)#åˆ¶é€ å¤åˆ¶å¼‚å¸¸å‡½æ•°@dec_progressivedef error_maker(host,port,user,password,db,charset): conn=get_conn(host=host, port=int(port), user=user,password=password,db=db,charset=charset) cursor = conn.cursor() cursor.execute(&quot;set session sql_log_bin=0;&quot;) cursor.execute(&quot;create table t_error_maker(id int)&quot;) cursor.execute(&quot;set session sql_log_bin=1&quot;) cursor.execute(&quot;drop table t_error_maker&quot;) cursor.close() conn.close()#è·å–slave statusdef get_slave_status(conn,sql): cursor = conn.cursor(pymysql.cursors.DictCursor) cursor.execute(sql) result = cursor.fetchone() return result cursor.close()#è·å–master status@dec_progressivedef get_master_status(conn): cursor = conn.cursor(pymysql.cursors.DictCursor) cursor.execute(&quot;show master status;&quot;) result = cursor.fetchone() return result cursor.close()#æ‰§è¡Œchange masterè¯­å¥@dec_progressivedef change_master(conn,change_string): cursor = conn.cursor() cursor.execute(&quot;stop slave;&quot;) cursor.execute(change_string) cursor.execute(&quot;start slave;&quot;) cursor.close()#ä¿®å¤slaveé”™è¯¯@dec_progressivedef repair_slave(conn): cursor = conn.cursor() cursor.execute(&quot;set global sql_slave_skip_counter=1;&quot;) cursor.execute(&quot;start slave sql_thread;&quot;) cursor.close() #è®¾ç½®read only@dec_progressivedef set_read_only(conn,switch): cursor = conn.cursor() if switch == &#x27;on&#x27;: cursor.execute(&quot;set global read_only=on;&quot;) elif switch == &#x27;off&#x27;: cursor.execute(&quot;set global read_only=off;&quot;) cursor.close()#å¯åœ sql_thread@dec_progressivedef set_sql_thread(conn,switch): cursor = conn.cursor() if switch == &#x27;off&#x27;: cursor.execute(&quot;stop slave sql_thread;&quot;) elif switch == &#x27;on&#x27;: cursor.execute(&quot;start slave sql_thread;&quot;) cursor.close()#åˆ¤æ–­ 39 40 41æ˜¯å¦éƒ½å› ä¸ºdrop t_error_makeråœæ­¢@dec_progressivedef get_error_status(): while True: Last_SQL_Error_39 = get_slave_status(conn39,&#x27;show slave status;&#x27;)[&#x27;Last_SQL_Error&#x27;] Last_SQL_Error_40 = get_slave_status(conn40,&#x27;show slave status;&#x27;)[&#x27;Last_SQL_Error&#x27;] Last_SQL_Error_41 = get_slave_status(conn41,&#x27;show slave status;&#x27;)[&#x27;Last_SQL_Error&#x27;] if Last_SQL_Error_39 == Last_SQL_Error_40 == Last_SQL_Error_41 == error_message: break else: time.sleep(1)if __name__ == &#x27;__main__&#x27;: MAX_VALUE = 100 bar = Bar(max_value=MAX_VALUE, fallback=True) bar.cursor.clear_lines(2) bar.cursor.save() i=0 #ä¸æ˜¾ç¤ºMySQLçš„warning filterwarnings(&#x27;ignore&#x27;,category=pymysql.Warning) #è¿æ¥36 åˆ¶é€ å¤åˆ¶å¼‚å¸¸å‡½æ•° print(u&quot;è¿æ¥3306 åˆ¶é€ å¤åˆ¶å¼‚å¸¸å‡½æ•°&quot;) error_maker(host=&#x27;172.16.65.36&#x27;, port=3306, user=&#x27;root&#x27;,password=&#x27;mysql&#x27;,db=&#x27;fandb&#x27;,charset=&#x27;utf8&#x27;) conn39 = get_conn(&#x27;10.0.1.39&#x27;,3306,&#x27;root&#x27;,&#x27;mysql&#x27;) conn40 = get_conn(&#x27;10.0.1.40&#x27;,3306,&#x27;root&#x27;,&#x27;mysql&#x27;) conn41 = get_conn(&#x27;10.0.1.41&#x27;,3306,&#x27;root&#x27;,&#x27;mysql&#x27;) #åˆ¤æ–­ 39 40 41æ˜¯å¦éƒ½å› ä¸ºdrop t_error_makeråœæ­¢ print(u&quot;åˆ¤æ–­ 39 40 41æ˜¯å¦éƒ½å› ä¸ºdrop t_error_makeråœæ­¢&quot;) get_error_status() #è·å–40 master status ä»¥ä¾›39 41åˆ‡æ¢ print(u&quot;è·å–40 master status ä»¥ä¾›39 41åˆ‡æ¢&quot;) master_status_40 = get_master_status(conn40) File_40,Position_40 = master_status_40[&#x27;File&#x27;],master_status_40[&#x27;Position&#x27;] change_string = &quot;&quot;&quot; change master to master_host=&#x27;10.0.1.40&#x27;, master_port=3306, master_user=&#x27;repl&#x27;, master_password=&#x27;repl&#x27;, master_log_file=&#x27;%s&#x27;, master_log_pos=%d; &quot;&quot;&quot; % (File_40,Position_40) #39 41åˆ‡æ¢åˆ°40 print(u&quot;39,41åˆ‡æ¢åˆ°40&quot;) change_master(conn39,change_string) print(u&quot;39åˆ‡æ¢åˆ°40æˆåŠŸ&quot;) change_master(conn41,change_string) print(u&quot;41åˆ‡æ¢åˆ°40æˆåŠŸ&quot;) #ä¿®å¤40 slave print(u&quot;ä¿®å¤40 slave&quot;) repair_slave(conn40) # conn35 = get_conn(&#x27;172.16.65.35&#x27;,3306,&#x27;root&#x27;,&#x27;mysql&#x27;) # conn36 = get_conn(&#x27;172.16.65.36&#x27;,3306,&#x27;root&#x27;,&#x27;mysql&#x27;) # #35 è®¾ç½®read only # set_read_only(conn35,switch=&#x27;on&#x27;) # #åˆ¤æ–­35 36 40 æ˜¯å¦åŒæ­¥ # while True: # res35 = get_slave_status(conn35,&#x27;show master status;&#x27;) # res36 = get_slave_status(conn36,&#x27;show slave status;&#x27;) # res40 = get_slave_status(conn40,&#x27;show slave status;&#x27;) # File_35,Position_35 = res35[&#x27;File&#x27;],res35[&#x27;Position&#x27;] # File_36,Position_36 = res36[&#x27;Relay_Master_Log_File&#x27;],res36[&#x27;Exec_Master_Log_Pos&#x27;] # File_40,Position_40 = res40[&#x27;Relay_Master_Log_File&#x27;],res40[&#x27;Exec_Master_Log_Pos&#x27;] # if File_35 == File_36 == File_40 and Position_35 == Position_36 == Position_40: # break # else: # time.sleep(1) # #åœ40 sql_thread # set_sql_thread(conn40,switch=&#x27;off&#x27;) # #å†™æ¥å…¥36 # #35 read_only=off # set_read_only(conn35,switch=&#x27;off&#x27;) # master_status_40 = get_master_status(conn40) # File_40,Position_40 = master_status_40[&#x27;File&#x27;],master_status_40[&#x27;Position&#x27;] # change_string = &quot;&quot;&quot; # change master to # master_host=&#x27;10.0.1.40&#x27;, # master_port=3306, # master_user=&#x27;repl&#x27;, # master_password=&#x27;repl&#x27;, # master_log_file=&#x27;%s&#x27;, # master_log_pos=%d; # &quot;&quot;&quot; % (File_40,Position_40) # change_master(conn35,change_string) # #èµ·40 sql_thread # set_sql_thread(conn40,switch=&#x27;on&#x27;) bar.cursor.restore() bar.draw(value=100)","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤åˆ¶","slug":"MySQLå¤åˆ¶","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%8D%E5%88%B6/"}]},{"title":"Tpcc-MySQL","slug":"Tpcc-MySQL","date":"2017-05-07T14:00:00.000Z","updated":"2017-08-05T16:02:32.000Z","comments":true,"path":"2017/05/07/Tpcc-MySQL/","link":"","permalink":"http://fuxkdb.com/2017/05/07/Tpcc-MySQL/","excerpt":"Tpcc-MySQLä¸‹è½½å®‰è£…tpcc-mysql123cd /usr/localwget https://github.com/Percona-Lab/tpcc-mysql/archive/master.zipmv tpcc-mysql-master tpcc-mysql å®‰è£…ä¹‹å‰éœ€è¦ä¿è¯å°†mysql_configæ·»åŠ åˆ°$PATH ç¯å¢ƒå˜é‡ä¸­1cd src ; make ( you should have mysql_config available in $PATH) åˆå§‹åŒ–æ•°æ®123456789101112131415161718192021[mysql@master ~]$ mysqladmin -umysql -p -S /data/mysqldata/3306/mysql.sock create tpcc10Enter password: [mysql@master ~]$ mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock tpcc10 &lt; /usr/local/tpcc-mysql/create_table.sql Warning: Using a password on the command line interface can be insecure.[mysql@master ~]$ mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock -e &quot; show tables from tpcc10;&quot;Warning: Using a password on the command line interface can be insecure.+------------------+| Tables_in_tpcc10 |+------------------+| customer || district || history || item || new_orders || order_line || orders || stock || warehouse |+------------------+[mysql@master ~]$ mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock tpcc10 &lt; /usr/local/tpcc-mysql/add_fkey_idx.sql Warning: Using a password on the command line interface can be insecure.","text":"Tpcc-MySQLä¸‹è½½å®‰è£…tpcc-mysql123cd /usr/localwget https://github.com/Percona-Lab/tpcc-mysql/archive/master.zipmv tpcc-mysql-master tpcc-mysql å®‰è£…ä¹‹å‰éœ€è¦ä¿è¯å°†mysql_configæ·»åŠ åˆ°$PATH ç¯å¢ƒå˜é‡ä¸­1cd src ; make ( you should have mysql_config available in $PATH) åˆå§‹åŒ–æ•°æ®123456789101112131415161718192021[mysql@master ~]$ mysqladmin -umysql -p -S /data/mysqldata/3306/mysql.sock create tpcc10Enter password: [mysql@master ~]$ mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock tpcc10 &lt; /usr/local/tpcc-mysql/create_table.sql Warning: Using a password on the command line interface can be insecure.[mysql@master ~]$ mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock -e &quot; show tables from tpcc10;&quot;Warning: Using a password on the command line interface can be insecure.+------------------+| Tables_in_tpcc10 |+------------------+| customer || district || history || item || new_orders || order_line || orders || stock || warehouse |+------------------+[mysql@master ~]$ mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock tpcc10 &lt; /usr/local/tpcc-mysql/add_fkey_idx.sql Warning: Using a password on the command line interface can be insecure. è£…è½½æ•°æ®1234567891011121314151617181920212223242526272829/usr/local/tpcc-mysql/tpcc_load -hlocalhost -d tpcc10 -u mysql -p mysql -w 10å„åˆ—å«ä¹‰ä¸ºï¼š |hostname:port| |dbname| |user| |password| |WAREHOUSESé€‰é¡¹ warehouse æ„ä¸ºæŒ‡å®šæµ‹è¯•åº“ä¸‹çš„ä»“åº“æ•°é‡, åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®è®¾ç½®è‡³å°‘100ä»¥ä¸Šè¿™é‡Œè®¾ç½®10ä¸ªä»“åº“**************************************** TPCC-mysql Data Loader ****************************************option h with value &#x27;localhost&#x27;option d with value &#x27;tpcc10&#x27;option u with value &#x27;mysql&#x27;option p with value &#x27;mysql&#x27;option w with value &#x27;10&#x27;&lt;Parameters&gt; [server]: localhost [port]: 3306 [DBname]: tpcc10 [user]: mysql [pass]: mysql [warehouse]: 10TPCC Data Load Started...Loading Item .................................................. 5000.................................................. 10000.................................................. 15000.................................................. 20000.................................................. 25000.................................................. 30000......DATA LOADING COMPLETED SUCCESSFULLY. å‹åŠ›æµ‹è¯•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100[mysql@master tpcc-mysql]$ /usr/local/tpcc-mysql/tpcc_start -h 172.16.120.130 -P 3306 -d tpcc10 -u mysql -p mysql -w 10 -c 10 -r 10 -l 360 -i 10å„åˆ—å«ä¹‰ä¸ºï¼š |hostname| |port| |dbname| |user| |password| |WAREHOUSES| |CONNECTIONS| |WARMUP TIME| |BENCHMARK TIME|****************************************** ###easy### TPC-C Load Generator ******************************************option h with value &#x27;172.16.120.130&#x27;option P with value &#x27;3306&#x27;option d with value &#x27;tpcc10&#x27;option u with value &#x27;mysql&#x27;option p with value &#x27;mysql&#x27;option w with value &#x27;10&#x27;option c with value &#x27;10&#x27;option r with value &#x27;10&#x27;option l with value &#x27;360&#x27;option i with value &#x27;10&#x27;&lt;Parameters&gt; [server]: 172.16.120.130 [port]: 3306 [DBname]: tpcc10 [user]: mysql [pass]: mysql [warehouse]: 10 [connection]: 10 [rampup]: 10 (sec.) [measure]: 360 (sec.)RAMP-UP TIME.(10 sec.)MEASURING START. 10, trx: 99, 95%: 1276.031, 99%: 1651.666, max_rt: 1900.823, 99|2176.948, 9|453.968, 9|2345.216, 9|4414.681 20, trx: 118, 95%: 820.803, 99%: 1096.353, max_rt: 1103.197, 118|756.232, 13|256.137, 12|1141.656, 14|2324.185 30, trx: 154, 95%: 641.000, 99%: 725.352, max_rt: 806.858, 157|607.721, 15|459.590, 15|1153.335, 15|2572.398 40, trx: 207, 95%: 493.000, 99%: 600.507, max_rt: 655.846, 207|329.540, 20|248.943, 21|980.139, 19|1454.455 50, trx: 225, 95%: 508.894, 99%: 1075.549, max_rt: 1184.488, 221|303.606, 23|263.231, 22|1438.822, 24|1140.145 60, trx: 276, 95%: 375.332, 99%: 444.495, max_rt: 702.731, 281|374.427, 28|332.414, 28|868.740, 28|1169.240 70, trx: 276, 95%: 412.445, 99%: 561.394, max_rt: 613.595, 275|331.192, 27|254.446, 27|1023.836, 28|986.823 80, trx: 346, 95%: 285.151, 99%: 385.697, max_rt: 480.219, 343|465.637, 36|446.044, 35|663.491, 34|836.714 90, trx: 361, 95%: 304.106, 99%: 418.414, max_rt: 454.055, 365|261.836, 35|306.751, 36|706.509, 37|451.790 100, trx: 352, 95%: 329.310, 99%: 379.285, max_rt: 596.875, 350|228.144, 35|314.441, 35|874.110, 35|434.005 110, trx: 391, 95%: 264.116, 99%: 364.263, max_rt: 524.591, 393|300.455, 40|237.326, 39|870.451, 39|368.716 120, trx: 390, 95%: 283.110, 99%: 380.422, max_rt: 796.105, 390|209.881, 39|212.044, 39|649.781, 39|361.857 130, trx: 481, 95%: 211.891, 99%: 273.448, max_rt: 320.599, 478|205.557, 48|401.033, 48|545.170, 48|299.260 140, trx: 394, 95%: 261.676, 99%: 355.964, max_rt: 500.034, 397|457.157, 40|228.973, 40|921.951, 39|338.248 150, trx: 383, 95%: 283.788, 99%: 454.587, max_rt: 566.393, 384|280.592, 37|183.698, 38|848.897, 39|399.204 160, trx: 451, 95%: 231.870, 99%: 340.538, max_rt: 484.727, 448|260.694, 46|361.268, 46|660.337, 44|466.192 170, trx: 462, 95%: 228.493, 99%: 344.949, max_rt: 514.245, 459|181.838, 45|238.782, 44|635.492, 47|380.900 180, trx: 501, 95%: 201.077, 99%: 264.590, max_rt: 367.453, 504|187.646, 51|209.077, 51|592.223, 50|312.695 190, trx: 487, 95%: 208.182, 99%: 248.247, max_rt: 385.329, 487|156.600, 48|268.224, 49|599.426, 48|369.467 200, trx: 549, 95%: 198.565, 99%: 246.544, max_rt: 289.273, 547|125.297, 55|149.780, 55|579.936, 55|288.928 210, trx: 525, 95%: 183.039, 99%: 252.746, max_rt: 348.508, 527|151.534, 53|157.159, 53|538.393, 53|342.113 220, trx: 498, 95%: 212.272, 99%: 454.723, max_rt: 649.610, 499|247.239, 49|373.921, 49|850.496, 50|307.415 230, trx: 593, 95%: 165.673, 99%: 224.628, max_rt: 254.276, 592|161.555, 60|217.229, 59|554.132, 59|274.591 240, trx: 562, 95%: 172.712, 99%: 222.220, max_rt: 462.752, 563|119.360, 56|363.567, 56|444.219, 57|438.265 250, trx: 613, 95%: 156.842, 99%: 210.249, max_rt: 336.516, 609|210.124, 61|162.821, 63|443.805, 60|302.938 260, trx: 581, 95%: 160.451, 99%: 234.803, max_rt: 310.168, 584|134.567, 58|205.125, 57|503.892, 58|354.136 270, trx: 657, 95%: 142.558, 99%: 184.193, max_rt: 236.276, 657|114.116, 66|163.854, 66|398.327, 66|302.011 280, trx: 625, 95%: 154.188, 99%: 325.488, max_rt: 402.501, 627|305.710, 62|220.527, 62|490.638, 63|306.516 290, trx: 648, 95%: 138.147, 99%: 186.747, max_rt: 257.152, 641|176.512, 66|97.194, 65|459.044, 65|268.244 300, trx: 587, 95%: 157.030, 99%: 207.498, max_rt: 356.098, 589|177.653, 58|96.041, 58|439.606, 58|304.784 310, trx: 606, 95%: 158.067, 99%: 200.416, max_rt: 261.933, 609|190.645, 61|147.659, 61|957.198, 61|312.263 320, trx: 641, 95%: 149.149, 99%: 190.587, max_rt: 377.275, 640|111.658, 64|86.510, 64|398.594, 64|255.898 330, trx: 616, 95%: 141.707, 99%: 186.970, max_rt: 325.279, 612|127.490, 61|143.177, 62|539.403, 61|329.158 340, trx: 616, 95%: 146.626, 99%: 205.335, max_rt: 424.379, 621|144.290, 62|114.400, 62|521.001, 62|460.688 350, trx: 659, 95%: 139.143, 99%: 187.250, max_rt: 274.776, 660|121.001, 66|115.034, 66|370.938, 66|260.560 360, trx: 675, 95%: 136.871, 99%: 165.425, max_rt: 249.625, 673|147.049, 67|131.501, 67|462.549, 68|260.771STOPPING THREADS..........&lt;Raw Results&gt; [0] sc:9 lt:16596 rt:0 fl:0 avg_rt: 118.3 (5) [1] sc:678 lt:15928 rt:0 fl:0 avg_rt: 37.0 (5) [2] sc:201 lt:1459 rt:0 fl:0 avg_rt: 51.4 (5) [3] sc:0 lt:1659 rt:0 fl:0 avg_rt: 349.9 (80) [4] sc:1 lt:1661 rt:0 fl:0 avg_rt: 265.4 (20) in 360 sec.&lt;Raw Results2(sum ver.)&gt; [0] sc:9 lt:16596 rt:0 fl:0 [1] sc:678 lt:15928 rt:0 fl:0 [2] sc:201 lt:1459 rt:0 fl:0 [3] sc:0 lt:1659 rt:0 fl:0 [4] sc:1 lt:1661 rt:0 fl:0 &lt;Constraint Check&gt; (all must be [OK]) [transaction percentage] Payment: 43.48% (&gt;=43.0%) [OK] Order-Status: 4.35% (&gt;= 4.0%) [OK] Delivery: 4.34% (&gt;= 4.0%) [OK] Stock-Level: 4.35% (&gt;= 4.0%) [OK] [response time (at least 90% passed)] New-Order: 0.05% [NG] * Payment: 4.08% [NG] * Order-Status: 12.11% [NG] * Delivery: 0.00% [NG] * Stock-Level: 0.06% [NG] *&lt;TpmC&gt; 2767.500 TpmC --æ¯åˆ†é’Ÿ é™¤60å°±æ˜¯tps å«ä¹‰123456710, trx: 12920, 95%: 9.483, 99%: 18.738, max_rt: 213.169, 12919|98.778, 1292|101.096, 1293|443.955, 1293|670.84210 - ä»åŸºå‡†æµ‹è¯•å¼€å§‹åˆ°ç°åœ¨çš„ç§’æ•°trx: 12920 - åœ¨ç»™å®šçš„é—´éš”å†…ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹,åœ¨è¿‡å»çš„10ç§’ï¼‰å†…æ‰§è¡Œçš„æ–°è®¢å•äº¤æ˜“. åŸºæœ¬ä¸Šè¿™æ˜¯æ¯ä¸ªé—´éš”çš„ååé‡. è¶Šå¤šè¶Šå¥½95ï¼…ï¼š9.483ï¼š - æ¯æ¬¡ç»™å®šé—´éš”çš„æ–°è®¢å•äº¤æ˜“çš„95ï¼…å“åº”æ—¶é—´. åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯9.483ç§’99ï¼…ï¼š18.738ï¼š - æ¯æ¬¡ç»™å®šé—´éš”çš„æ–°è®¢å•äº¤æ˜“çš„99ï¼…å“åº”æ—¶é—´. åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯18.738ç§’max_rtï¼š213.169ï¼š - æ¯ä¸ªç»™å®šé—´éš”çš„æ–°è®¢å•äº¤æ˜“çš„æœ€å¤§å“åº”æ—¶é—´. åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯213.169ç§’å…¶ä½™çš„ï¼š12919 | 98.778,1292 | 101.096,1293 | 443.955,1293 | 670.842æ˜¯å…¶ä»–ç±»å‹çš„äº‹åŠ¡çš„ååé‡å’Œæœ€å¤§å“åº”æ—¶é—´,å¯ä»¥å¿½ç•¥ gnuplotå‡ºå›¾/usr/local/tpcc-mysql/scripts ç›®å½•ä¸‹æœ‰ä¸€ä¸ªanalyze.sh ä¿®æ”¹äº†ä¸€ä¸‹,å¦‚æœç”¨gnuplotå‡ºå›¾,åˆ™ä¸º12345678 cat tpcc.txt | grep -v HY000 | grep -v payment | grep -v neword | awk -v timeslot=1 &#x27; BEGIN &#123; FS=&quot;[,():]&quot;; s=0; cntr=0 &#125; /MEASURING START/ &#123; s=1&#125; /STOPPING THREADS/ &#123;s=0&#125; /0/ &#123; if (s==1) &#123; cntr++; &#125; if ( cntr==timeslot ) &#123; printf (&quot;%d %d\\n&quot;,$1,$3) ; cntr=0;&#125;&#125;&#x27; &gt;&gt; tpcc-graphic-data.txt10 9920 11830 15440 20750 225åªè¾“å‡ºæ—¶é—´å’Œtrxåˆ—gnuplot.cnf12345678910set terminal gif small size 800,600 #æŒ‡å®šè¾“å‡ºæˆgifå›¾ç‰‡ï¼Œä¸”å›¾ç‰‡å¤§å°ä¸º550Ã—25set output &quot;tpcc.gif&quot; #æŒ‡å®šè¾“å‡ºgifå›¾ç‰‡çš„æ–‡ä»¶åset title &quot;MySQL Performance&quot; #å›¾ç‰‡æ ‡é¢˜set style data lines #æ˜¾ç¤ºç½‘æ ¼set xlabel &quot;Time/s&quot; #Xè½´æ ‡é¢˜set ylabel &quot;Transactions&quot; #Yè½´æ ‡é¢˜set grid #æ˜¾ç¤ºç½‘æ ¼plot \\&quot;tpcc-graphic-data.txt&quot; using 1:2 title &quot;Total throughput&quot; with lines #ä»tpcc-graphic-data.txtæ–‡ä»¶ä¸­è¯»å–ç¬¬ä¸€åˆ—å’Œç¬¬äºŒåˆ—ä½œä¸ºXè½´å’ŒYè½´æ•°æ®ï¼Œç¤ºä¾‹å&quot;Total throughput&quot;å‡ºå›¾cat gnuplot.cnf | gnuplot highchartså‡ºå›¾ä¿®æ”¹analyze.sh123456789 cat tpcc.txt | grep -v HY000 | grep -v payment | grep -v neword | awk -v timeslot=1 &#x27; BEGIN &#123; FS=&quot;[,():]&quot;; s=0; cntr=0 &#125; /MEASURING START/ &#123; s=1&#125; /STOPPING THREADS/ &#123;s=0&#125; /0/ &#123; if (s==1) &#123; cntr++; &#125; if ( cntr==timeslot ) &#123; printf (&quot;&#x27;&#123;\\&#x27;time\\&#x27;:&#x27;%d&#x27;,\\&#x27;trx\\&#x27;:&#x27;%d&#125;\\n&quot;,$1,$3) ; cntr=0;&#125;&#125;&#x27; &#123;&#x27;time&#x27;:10,&#x27;trx&#x27;:99&#125;&#123;&#x27;time&#x27;:20,&#x27;trx&#x27;:118&#125;&#123;&#x27;time&#x27;:30,&#x27;trx&#x27;:154&#125;&#123;&#x27;time&#x27;:40,&#x27;trx&#x27;:207&#125;&#123;&#x27;time&#x27;:50,&#x27;trx&#x27;:225&#125;&#123;&#x27;time&#x27;:60,&#x27;trx&#x27;:276&#125; å‡ºå›¾123456789101112131415161718192021import chartsdef getData(file): with open(file,&#x27;r&#x27;) as data: dicList=[] for line in data: dic=eval(line.strip()) dicList.append(dic) timeList,trxList=[],[] for i in dicList: timeList.append(i[&#x27;time&#x27;]) trxList.append(i[&#x27;trx&#x27;]) dataList=list(zip(timeList,trxList)) return dataList options = &#123; &#x27;title&#x27;:&#123;&#x27;text&#x27;:&#x27;TPCC-MySQL&#x27;&#125;, &#x27;yAxis&#x27;:&#123;&#x27;title&#x27;:&#123;&#x27;text&#x27;:&#x27;trx&#x27;&#125;&#125; &#125;charts.plot(getData(&#x27;C:\\\\Users\\\\Fan\\\\tpcc.txt&#x27;),name=&#x27;10 warehouse 10 connect&#x27;,options=options,show=&#x27;inline&#x27;,) ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ è¿™é‡Œæ˜¯ trxæ˜¯10ç§’çš„ç´¯è®¡,æ¯åç§’ä¸€ä¸ªtrx å…³äºtpcc_loadtpcc_loadç”¨ä¸Šé¢çš„æ–¹æ³•æ˜¯å¾ˆæ…¢çš„,å®é™…ä¸Štpcc-mysql/ä¸‹æœ‰ä¸€ä¸ªè„šæœ¬load_multi_schema.sh. ä¿®æ”¹ä¸€ä¸‹å12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455tpcc_load -h127.0.0.1 -d tpcc10 -u root -p &quot;&quot; -w 1000å„åˆ—å«ä¹‰ä¸ºï¼š |hostname:port| |dbname| |user| |password| |WAREHOUSESé€‰é¡¹ warehouse æ„ä¸ºæŒ‡å®šæµ‹è¯•åº“ä¸‹çš„ä»“åº“æ•°é‡, åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®è®¾ç½®è‡³å°‘100ä»¥ä¸Š$1 å°†è¦åˆ›å»ºçš„æ•°æ®åº“å$2 ä»“åº“æ•°é‡$3 schemaæ•°é‡,è¿™é‡Œä¸º1$4 æ•°æ®åº“ipè¿™é‡Œmysqlç”¨æˆ·åå¯†ç socketå†™æ­»äº†[root@master2 tpcc-mysql]# more load_multi_schema.sh #export LD_LIBRARY_PATH=/data/opt/bin/mysql-5.7.11-linux-glibc2.5-x86_64/lib/export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/mysql/lib/DBNAME=$1WH=$2NSCHEMA=$3HOST=$4STEP=5 #stepåº”è¯¥å°äºWHschema=0while [ $schema -lt $NSCHEMA ] #ä¸»å¾ªç¯do DBFULLNAME=$&#123;DBNAME&#125;_$&#123;schema&#125; echo &quot;Creating schema $DBFULLNAME&quot; mysqladmin -umysql -pmysql -S /data/mysqldata/3306/mysql.sock -f drop $DBFULLNAME mysqladmin -umysql -pmysql -S /data/mysqldata/3306/mysql.sock create $DBFULLNAME mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock $DBFULLNAME &lt; create_table.sql mysql -umysql -pmysql -S /data/mysqldata/3306/mysql.sock $DBFULLNAME &lt; add_fkey_idx.sql mkdir -p out#ä»¥ä¸Šæ˜¯åˆ›å»ºæ•°æ®åº“,è·‘åˆå§‹åŒ–è„šæœ¬./tpcc_load -h$HOST -d $DBFULLNAME -u mysql -p mysql -w $WH -l 1 -m 1 -n $WH &gt;&gt; out/1_$DBFULLNAME.out &amp;#Usage: tpcc_load -h server_host -P port -d database_name -u mysql_user -p mysql_password -w warehouses -l part -m min_wh -n max_wh#* [part]: 1=ITEMS 2=WAREHOUSE 3=CUSTOMER 4=ORDERS#-m 1 å°±æ˜¯å»ºITEMSx=1#åœ¨å¾ªç¯é‡Œå»ºå‰©ä¸‹çš„-m 1 -n æ­¥é•¿, ä¸€æ¬¡å¾ªç¯å»ºå¤šå°‘ä¸ªwhile [ $x -le $WH ] #ä¸»å¾ªç¯é‡Œçš„åµŒå¥—å¾ªç¯do echo $x $(( $x + $STEP - 1 ))./tpcc_load -h$HOST -d $DBFULLNAME -u mysql -p mysql -w $WH -l 2 -m $x -n $(( $x + $STEP - 1 )) &gt;&gt; out/2_$DBFULLNAME.$x.out &amp;./tpcc_load -h$HOST -d $DBFULLNAME -u mysql -p mysql -w $WH -l 3 -m $x -n $(( $x + $STEP - 1 )) &gt;&gt; out/3_$DBFULLNAME.$x.out &amp;./tpcc_load -h$HOST -d $DBFULLNAME -u mysql -p mysql -w $WH -l 4 -m $x -n $(( $x + $STEP - 1 )) &gt;&gt; out/4_$DBFULLNAME.$x.out &amp; x=$(( $x + $STEP ))donefor job in `jobs -p`doecho $job wait $jobdoneschema=$(( $schema + 1 ))doneç°åœ¨loadæ˜¯å¹¶è¡Œçš„12345678910111213141516171819[mysql@master2 tpcc-mysql]$ ./load_multi_schema.sh tpcc 10 1 192.168.98.128Creating schema tpcc_0Warning: Using a password on the command line interface can be insecure.Database &quot;tpcc_0&quot; droppedWarning: Using a password on the command line interface can be insecure.Warning: Using a password on the command line interface can be insecure.Warning: Using a password on the command line interface can be insecure.1 56 1028496284972849828499285002850128502[mysql@master2 tpcc-mysql]$ outç›®å½•æœ‰æ—¥å¿—","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"Tpcc-MySQL","slug":"Tpcc-MySQL","permalink":"http://fuxkdb.com/tags/Tpcc-MySQL/"}]},{"title":"MySQLå‡çº§","slug":"MySQLå‡çº§","date":"2017-03-03T14:00:00.000Z","updated":"2020-09-24T03:35:06.875Z","comments":true,"path":"2017/03/03/MySQLå‡çº§/","link":"","permalink":"http://fuxkdb.com/2017/03/03/MySQL%E5%8D%87%E7%BA%A7/","excerpt":"Upgrading Mysql æ”¯æŒçš„å‡çº§æ–¹æ³• æ”¯æŒçš„å‡çº§è·¯å¾„ Before You Begin Performing an In-Place Upgrade Supported Upgrade Methodæ”¯æŒçš„å‡çº§æ–¹æ³•åŒ…æ‹¬: In-Place Upgrade:æ¶‰åŠå…³é—­æ—§ç‰ˆæœ¬çš„MySQL,å°†æ—§çš„MySQLäºŒè¿›åˆ¶æ–‡ä»¶æˆ–è½¯ä»¶åŒ…æ›¿æ¢æˆæ–°ç‰ˆæœ¬çš„MySQL,é‡æ–°å¯åŠ¨MySQLä½¿ç”¨åŸæ¥çš„data directory,å¹¶æ‰§è¡Œmysql_upgrade. Logical Upgrade:æ¶‰åŠä½¿ç”¨mysqldumpå¯¼å‡ºæ—§ç‰ˆæœ¬MySQLçš„æ‰€æœ‰æ•°æ®,å®‰è£…æ–°ç‰ˆæœ¬çš„MySQL,å¯¼å…¥dumpæ–‡ä»¶,å¹¶æ‰§è¡Œmysql_upgrade. æ”¯æŒçš„å‡çº§è·¯å¾„é™¤éå¦æœ‰è¯´æ˜ï¼Œå¦åˆ™æ”¯æŒä»¥ä¸‹å‡çº§è·¯å¾„ï¼š Upgrading from a release series version to a newer release series version is supported.å¯ä»¥ä»5.7.9å‡çº§åˆ°5.7.10,æˆ–è€…ç›´æ¥ä»5.7.9å‡çº§åˆ°5.7.11 Upgrading one release level is supported. For example, upgrading from 5.6 to 5.7 is supported.å¯ä»¥ä»5.6å‡çº§åˆ°5.7 Upgrading more than one release level is supported, but only if you upgrade one release level at a time.å‡çº§å¤šä¸ªç‰ˆæœ¬æ˜¯æ”¯æŒçš„ä½†åªèƒ½ä¸€æ¬¡å‡çº§ä¸€ä¸ªç‰ˆæœ¬,æ¯”å¦‚5.5 å…ˆå‡çº§ 5.6 å†å‡çº§åˆ°5.7 ç›´æ¥ä»5.5å‡çº§åˆ°5.7æ˜¯ä¸å»ºè®®ä¸”ä¸æ”¯æŒçš„ä»¥ä¸‹æ¡ä»¶é€‚ç”¨äºæ‰€æœ‰å‡çº§è·¯å¾„ï¼š æ”¯æŒé€šç”¨å¯ç”¨æ€§ï¼ˆGAï¼‰çŠ¶æ€ç‰ˆæœ¬ä¹‹é—´çš„å‡çº§ã€‚ ä¸æ”¯æŒåœ¨é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¹‹é—´ï¼ˆæˆ–ä»é‡Œç¨‹ç¢‘ç‰ˆæœ¬åˆ°GAç‰ˆæœ¬ï¼‰çš„å‡çº§ã€‚ ä¾‹å¦‚ï¼Œä¸æ”¯æŒä»5.7.7å‡çº§åˆ°5.7.8ï¼Œå› ä¸ºGAçŠ¶æ€é‡Šæ”¾ä¹Ÿä¸å—æ”¯æŒ(è¿™æ®µå¯èƒ½å†™é”™äº†)ã€‚ å¯¹äºå·²è¾¾åˆ°GAçŠ¶æ€çš„MySQLç‰ˆæœ¬ç³»åˆ—çš„ç‰ˆæœ¬ä¹‹é—´çš„å‡çº§ï¼Œå¯ä»¥åœ¨å…·æœ‰ç›¸åŒæ¶æ„çš„ç³»ç»Ÿä¸Šåœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´ç§»åŠ¨MySQLæ ¼å¼æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶ã€‚ è¿™å¯¹äºåœ¨é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¹‹é—´çš„å‡çº§ä¸ä¸€å®šæ˜¯çœŸçš„ã€‚ ä½¿ç”¨é‡Œç¨‹ç¢‘ç‰ˆæœ¬æ˜¯æ‚¨è‡ªå·±çš„é£é™©ã€‚ Before You Beginå‡çº§ä¹‹å‰,å»ºè®®æŸ¥çœ‹å¦‚ä¸‹ä¿¡æ¯,å¹¶æ‰§è¡Œå»ºè®®çš„æ­¥éª¤: å‡çº§å‰,å¤‡ä»½æ•°æ®,å°¤å…¶æ˜¯systemåº“. è¯·æŸ¥çœ‹ç‰ˆæœ¬è¯´æ˜ï¼Œæä¾›æœ‰å…³MySQL 5.7ä¸­æ–°å¢åŠŸèƒ½çš„ä¿¡æ¯æˆ–ä¸æ—©æœŸMySQLç‰ˆæœ¬ä¸­å‘ç°çš„åŠŸèƒ½ä¸åŒçš„ä¿¡æ¯ã€‚ å…¶ä¸­ä¸€äº›æ›´æ”¹å¯èƒ½å¯¼è‡´ä¸å…¼å®¹ã€‚å¯¹äºå·²åœ¨MySQL 5.7ä¸­æ·»åŠ ï¼Œå¼ƒç”¨æˆ–åˆ é™¤çš„MySQLæœåŠ¡å™¨å˜é‡å’Œé€‰é¡¹çš„åˆ—è¡¨ï¼Œè¯·å‚è§ç¬¬1.5èŠ‚â€œåœ¨MySQL 5.7ä¸­æ·»åŠ ï¼Œå¼ƒç”¨æˆ–åˆ é™¤çš„æœåŠ¡å™¨å’ŒçŠ¶æ€å˜é‡åŠé€‰é¡¹â€ã€‚å¦‚æœä½¿ç”¨ä»¥ä¸Šä»»ä½•é¡¹ç›®ï¼Œå‡çº§éœ€è¦æ›´æ”¹é…ç½®ã€‚ æŸ¥çœ‹ç¬¬2.11.1.1èŠ‚â€œå½±å“å‡çº§åˆ°MySQL 5.7çš„æ›´æ”¹â€ã€‚æœ¬èŠ‚ä»‹ç»å¯èƒ½éœ€è¦åœ¨å‡çº§ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œæ“ä½œçš„æ›´æ”¹ã€‚ æ£€æŸ¥ç¬¬2.11.3èŠ‚â€œæ£€æŸ¥è¡¨æˆ–ç´¢å¼•æ˜¯å¦å¿…é¡»é‡æ–°æ„å»ºâ€ï¼Œä»¥äº†è§£æ‚¨å½“å‰ç‰ˆæœ¬çš„MySQLä¸è¦å‡çº§çš„ç‰ˆæœ¬ä¹‹é—´æ˜¯å¦å¯¹è¡¨æ ¼å¼æˆ–å­—ç¬¦é›†æˆ–å½’ç±»è¿›è¡Œäº†æ›´æ”¹ã€‚å¦‚æœè¿™äº›æ›´æ”¹å¯¼è‡´MySQLç‰ˆæœ¬ä¹‹é—´ä¸å…¼å®¹ï¼Œåˆ™éœ€è¦ä½¿ç”¨ç¬¬2.11.4èŠ‚â€œé‡å»ºæˆ–ä¿®å¤è¡¨æˆ–ç´¢å¼•â€ä¸­çš„è¯´æ˜å‡çº§å—å½±å“çš„è¡¨ã€‚ å¦‚æœä½¿ç”¨å¤åˆ¶ï¼Œè¯·æŸ¥çœ‹ç¬¬18.4.3èŠ‚â€œå‡çº§å¤åˆ¶è®¾ç½®â€ã€‚ å¦‚æœæ‚¨ä½¿ç”¨XAäº‹åŠ¡ä¸InnoDBï¼Œè¯·åœ¨å‡çº§ä¹‹å‰è¿è¡ŒXA RECOVERä»¥æ£€æŸ¥æœªæäº¤çš„XAäº‹åŠ¡ã€‚å¦‚æœè¿”å›ç»“æœï¼Œåˆ™é€šè¿‡å‘å‡ºXA COMMITæˆ–XA ROLLBACKè¯­å¥æ¥æäº¤æˆ–å›æ»šXAäº‹åŠ¡ã€‚ å¦‚æœæ‚¨çš„MySQLå®‰è£…åŒ…å«å¤§é‡æ•°æ®ï¼Œåœ¨å°±åœ°å‡çº§åå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´è¿›è¡Œè½¬æ¢ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°åˆ›å»ºä¸€ä¸ªâ€œè™šæ‹Ÿâ€æ•°æ®åº“å®ä¾‹ï¼Œç”¨äºè¯„ä¼°å¯èƒ½éœ€è¦çš„è½¬æ¢å’Œæ¶‰åŠçš„å·¥ä½œæ‰§è¡Œå®ƒä»¬ã€‚åˆ¶ä½œä¸€ä»½åŒ…å«mysqlæ•°æ®åº“å®Œæ•´å‰¯æœ¬çš„MySQLå®ä¾‹çš„å‰¯æœ¬ï¼Œä»¥åŠæ²¡æœ‰æ•°æ®çš„æ‰€æœ‰å…¶ä»–æ•°æ®åº“ã€‚åœ¨æ­¤è™šæ‹Ÿå®ä¾‹ä¸Šè¿è¡Œå‡çº§è¿‡ç¨‹ï¼Œä»¥æŸ¥çœ‹å¯èƒ½éœ€è¦æ‰§è¡Œå“ªäº›æ“ä½œï¼Œä»¥ä¾¿åœ¨åŸå§‹æ•°æ®åº“å®ä¾‹ä¸Šæ‰§è¡Œå®é™…æ•°æ®è½¬æ¢æ—¶ï¼Œå¯ä»¥æ›´å¥½åœ°è¯„ä¼°æ‰€æ¶‰åŠçš„å·¥ä½œã€‚ å½“æ‚¨å®‰è£…æˆ–å‡çº§åˆ°æ–°ç‰ˆæœ¬çš„MySQLæ—¶ï¼Œå»ºè®®é‡å»ºå’Œé‡æ–°å®‰è£…MySQLè¯­è¨€æ¥å£ã€‚è¿™é€‚ç”¨äºMySQLæ¥å£ï¼Œå¦‚PHP mysqlæ‰©å±•ï¼ŒPerl DBD :: mysqlæ¨¡å—å’ŒPython MySQLdbæ¨¡å—ã€‚","text":"Upgrading Mysql æ”¯æŒçš„å‡çº§æ–¹æ³• æ”¯æŒçš„å‡çº§è·¯å¾„ Before You Begin Performing an In-Place Upgrade Supported Upgrade Methodæ”¯æŒçš„å‡çº§æ–¹æ³•åŒ…æ‹¬: In-Place Upgrade:æ¶‰åŠå…³é—­æ—§ç‰ˆæœ¬çš„MySQL,å°†æ—§çš„MySQLäºŒè¿›åˆ¶æ–‡ä»¶æˆ–è½¯ä»¶åŒ…æ›¿æ¢æˆæ–°ç‰ˆæœ¬çš„MySQL,é‡æ–°å¯åŠ¨MySQLä½¿ç”¨åŸæ¥çš„data directory,å¹¶æ‰§è¡Œmysql_upgrade. Logical Upgrade:æ¶‰åŠä½¿ç”¨mysqldumpå¯¼å‡ºæ—§ç‰ˆæœ¬MySQLçš„æ‰€æœ‰æ•°æ®,å®‰è£…æ–°ç‰ˆæœ¬çš„MySQL,å¯¼å…¥dumpæ–‡ä»¶,å¹¶æ‰§è¡Œmysql_upgrade. æ”¯æŒçš„å‡çº§è·¯å¾„é™¤éå¦æœ‰è¯´æ˜ï¼Œå¦åˆ™æ”¯æŒä»¥ä¸‹å‡çº§è·¯å¾„ï¼š Upgrading from a release series version to a newer release series version is supported.å¯ä»¥ä»5.7.9å‡çº§åˆ°5.7.10,æˆ–è€…ç›´æ¥ä»5.7.9å‡çº§åˆ°5.7.11 Upgrading one release level is supported. For example, upgrading from 5.6 to 5.7 is supported.å¯ä»¥ä»5.6å‡çº§åˆ°5.7 Upgrading more than one release level is supported, but only if you upgrade one release level at a time.å‡çº§å¤šä¸ªç‰ˆæœ¬æ˜¯æ”¯æŒçš„ä½†åªèƒ½ä¸€æ¬¡å‡çº§ä¸€ä¸ªç‰ˆæœ¬,æ¯”å¦‚5.5 å…ˆå‡çº§ 5.6 å†å‡çº§åˆ°5.7 ç›´æ¥ä»5.5å‡çº§åˆ°5.7æ˜¯ä¸å»ºè®®ä¸”ä¸æ”¯æŒçš„ä»¥ä¸‹æ¡ä»¶é€‚ç”¨äºæ‰€æœ‰å‡çº§è·¯å¾„ï¼š æ”¯æŒé€šç”¨å¯ç”¨æ€§ï¼ˆGAï¼‰çŠ¶æ€ç‰ˆæœ¬ä¹‹é—´çš„å‡çº§ã€‚ ä¸æ”¯æŒåœ¨é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¹‹é—´ï¼ˆæˆ–ä»é‡Œç¨‹ç¢‘ç‰ˆæœ¬åˆ°GAç‰ˆæœ¬ï¼‰çš„å‡çº§ã€‚ ä¾‹å¦‚ï¼Œä¸æ”¯æŒä»5.7.7å‡çº§åˆ°5.7.8ï¼Œå› ä¸ºGAçŠ¶æ€é‡Šæ”¾ä¹Ÿä¸å—æ”¯æŒ(è¿™æ®µå¯èƒ½å†™é”™äº†)ã€‚ å¯¹äºå·²è¾¾åˆ°GAçŠ¶æ€çš„MySQLç‰ˆæœ¬ç³»åˆ—çš„ç‰ˆæœ¬ä¹‹é—´çš„å‡çº§ï¼Œå¯ä»¥åœ¨å…·æœ‰ç›¸åŒæ¶æ„çš„ç³»ç»Ÿä¸Šåœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´ç§»åŠ¨MySQLæ ¼å¼æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶ã€‚ è¿™å¯¹äºåœ¨é‡Œç¨‹ç¢‘ç‰ˆæœ¬ä¹‹é—´çš„å‡çº§ä¸ä¸€å®šæ˜¯çœŸçš„ã€‚ ä½¿ç”¨é‡Œç¨‹ç¢‘ç‰ˆæœ¬æ˜¯æ‚¨è‡ªå·±çš„é£é™©ã€‚ Before You Beginå‡çº§ä¹‹å‰,å»ºè®®æŸ¥çœ‹å¦‚ä¸‹ä¿¡æ¯,å¹¶æ‰§è¡Œå»ºè®®çš„æ­¥éª¤: å‡çº§å‰,å¤‡ä»½æ•°æ®,å°¤å…¶æ˜¯systemåº“. è¯·æŸ¥çœ‹ç‰ˆæœ¬è¯´æ˜ï¼Œæä¾›æœ‰å…³MySQL 5.7ä¸­æ–°å¢åŠŸèƒ½çš„ä¿¡æ¯æˆ–ä¸æ—©æœŸMySQLç‰ˆæœ¬ä¸­å‘ç°çš„åŠŸèƒ½ä¸åŒçš„ä¿¡æ¯ã€‚ å…¶ä¸­ä¸€äº›æ›´æ”¹å¯èƒ½å¯¼è‡´ä¸å…¼å®¹ã€‚å¯¹äºå·²åœ¨MySQL 5.7ä¸­æ·»åŠ ï¼Œå¼ƒç”¨æˆ–åˆ é™¤çš„MySQLæœåŠ¡å™¨å˜é‡å’Œé€‰é¡¹çš„åˆ—è¡¨ï¼Œè¯·å‚è§ç¬¬1.5èŠ‚â€œåœ¨MySQL 5.7ä¸­æ·»åŠ ï¼Œå¼ƒç”¨æˆ–åˆ é™¤çš„æœåŠ¡å™¨å’ŒçŠ¶æ€å˜é‡åŠé€‰é¡¹â€ã€‚å¦‚æœä½¿ç”¨ä»¥ä¸Šä»»ä½•é¡¹ç›®ï¼Œå‡çº§éœ€è¦æ›´æ”¹é…ç½®ã€‚ æŸ¥çœ‹ç¬¬2.11.1.1èŠ‚â€œå½±å“å‡çº§åˆ°MySQL 5.7çš„æ›´æ”¹â€ã€‚æœ¬èŠ‚ä»‹ç»å¯èƒ½éœ€è¦åœ¨å‡çº§ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œæ“ä½œçš„æ›´æ”¹ã€‚ æ£€æŸ¥ç¬¬2.11.3èŠ‚â€œæ£€æŸ¥è¡¨æˆ–ç´¢å¼•æ˜¯å¦å¿…é¡»é‡æ–°æ„å»ºâ€ï¼Œä»¥äº†è§£æ‚¨å½“å‰ç‰ˆæœ¬çš„MySQLä¸è¦å‡çº§çš„ç‰ˆæœ¬ä¹‹é—´æ˜¯å¦å¯¹è¡¨æ ¼å¼æˆ–å­—ç¬¦é›†æˆ–å½’ç±»è¿›è¡Œäº†æ›´æ”¹ã€‚å¦‚æœè¿™äº›æ›´æ”¹å¯¼è‡´MySQLç‰ˆæœ¬ä¹‹é—´ä¸å…¼å®¹ï¼Œåˆ™éœ€è¦ä½¿ç”¨ç¬¬2.11.4èŠ‚â€œé‡å»ºæˆ–ä¿®å¤è¡¨æˆ–ç´¢å¼•â€ä¸­çš„è¯´æ˜å‡çº§å—å½±å“çš„è¡¨ã€‚ å¦‚æœä½¿ç”¨å¤åˆ¶ï¼Œè¯·æŸ¥çœ‹ç¬¬18.4.3èŠ‚â€œå‡çº§å¤åˆ¶è®¾ç½®â€ã€‚ å¦‚æœæ‚¨ä½¿ç”¨XAäº‹åŠ¡ä¸InnoDBï¼Œè¯·åœ¨å‡çº§ä¹‹å‰è¿è¡ŒXA RECOVERä»¥æ£€æŸ¥æœªæäº¤çš„XAäº‹åŠ¡ã€‚å¦‚æœè¿”å›ç»“æœï¼Œåˆ™é€šè¿‡å‘å‡ºXA COMMITæˆ–XA ROLLBACKè¯­å¥æ¥æäº¤æˆ–å›æ»šXAäº‹åŠ¡ã€‚ å¦‚æœæ‚¨çš„MySQLå®‰è£…åŒ…å«å¤§é‡æ•°æ®ï¼Œåœ¨å°±åœ°å‡çº§åå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´è¿›è¡Œè½¬æ¢ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°åˆ›å»ºä¸€ä¸ªâ€œè™šæ‹Ÿâ€æ•°æ®åº“å®ä¾‹ï¼Œç”¨äºè¯„ä¼°å¯èƒ½éœ€è¦çš„è½¬æ¢å’Œæ¶‰åŠçš„å·¥ä½œæ‰§è¡Œå®ƒä»¬ã€‚åˆ¶ä½œä¸€ä»½åŒ…å«mysqlæ•°æ®åº“å®Œæ•´å‰¯æœ¬çš„MySQLå®ä¾‹çš„å‰¯æœ¬ï¼Œä»¥åŠæ²¡æœ‰æ•°æ®çš„æ‰€æœ‰å…¶ä»–æ•°æ®åº“ã€‚åœ¨æ­¤è™šæ‹Ÿå®ä¾‹ä¸Šè¿è¡Œå‡çº§è¿‡ç¨‹ï¼Œä»¥æŸ¥çœ‹å¯èƒ½éœ€è¦æ‰§è¡Œå“ªäº›æ“ä½œï¼Œä»¥ä¾¿åœ¨åŸå§‹æ•°æ®åº“å®ä¾‹ä¸Šæ‰§è¡Œå®é™…æ•°æ®è½¬æ¢æ—¶ï¼Œå¯ä»¥æ›´å¥½åœ°è¯„ä¼°æ‰€æ¶‰åŠçš„å·¥ä½œã€‚ å½“æ‚¨å®‰è£…æˆ–å‡çº§åˆ°æ–°ç‰ˆæœ¬çš„MySQLæ—¶ï¼Œå»ºè®®é‡å»ºå’Œé‡æ–°å®‰è£…MySQLè¯­è¨€æ¥å£ã€‚è¿™é€‚ç”¨äºMySQLæ¥å£ï¼Œå¦‚PHP mysqlæ‰©å±•ï¼ŒPerl DBD :: mysqlæ¨¡å—å’ŒPython MySQLdbæ¨¡å—ã€‚ æ‰§è¡ŒIn-Placeå‡çº§è¦æ‰§è¡ŒIn-Placeå‡çº§:1.æŸ¥çœ‹åœ¨2.11.1.1ç« èŠ‚,â€Changes Affecting Upgrades MySQL5.7â€æè¿°çš„å‡çº§æ‰€é€ æˆçš„æ”¹å˜https://dev.mysql.com/doc/refman/5.7/en/upgrading-from-previous-series.html2.Configure MySQL to perform a slow shutdown by setting innodb_fast_shutdown to 0. For example:1mysql -u root -p --execute=&quot;SET GLOBAL innodb_fast_shutdown=0&quot; With a slow shutdown, InnoDB performs a full purge and change buffer merge before shutting down, which ensures that data files are fully prepared in case of file format differences between releases.3.å…³é—­æ•°æ®åº“1mysqladmin -u root -p shutdown 4.å°†MySQLäºŒè¿›åˆ¶æ–‡ä»¶æˆ–è½¯ä»¶åŒ…æ›¿æ¢æˆæ–°çš„å°±æ˜¯è¯´æŠŠæ—§ç‰ˆæœ¬çš„mysqlè½¯ä»¶æ¢æˆæ–°çš„1234lrwxrwxrwx 1 root mysql 47 Mar 3 03:53 mysql -&gt; mysql-5.7.17/mysql-5.7.17-linux-glibc2.5-x86_64drwxr-xr-x 13 root root 4096 Mar 3 03:44 mysql55drwxrwxr-x 13 root mysql 4096 Dec 15 2014 mysql5.6drwxr-xr-x 3 root root 4096 Mar 3 03:42 mysql-5.7.17 è¿™é‡Œå¯ä»¥è¿™æ ·åš,æ›¿æ¢çš„æ—¶å€™ä½¿ç”¨ln -s å»ºä¸€ä¸ªè¿æ¥,è¿™æ ·æ¯æ¬¡æ›¿æ¢éƒ½åªæ˜¯æ”¹å˜è¿æ¥å–æ¶ˆè¿æ¥unlink5.å¯åŠ¨æ–°ç‰ˆæœ¬çš„MySQL1mysqld_safe --user=mysql --datadir=/path/to/existing-datadir è¿™é‡Œè¦ä¿è¯æ•°æ®æ–‡ä»¶ç›®å½•æŒ‡å®šå¯¹äº†6.æ‰§è¡Œmysql_upgrade1mysql_upgrade -u -p mysql_upgradeæ£€æŸ¥æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ä¸å½“å‰ç‰ˆæœ¬çš„MySQLä¸å…¼å®¹ã€‚ mysql_upgradeè¿˜å‡çº§mysqlç³»ç»Ÿæ•°æ®åº“ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥åˆ©ç”¨æ–°çš„æƒé™æˆ–åŠŸèƒ½ã€‚ ç¿»è¯‘æœ‰é—®é¢˜,åæ­£å°±æ˜¯è¦æ£€æŸ¥æ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨,æ‰€ä»¥ä½ çš„æ•°æ®åº“å¦‚æœå¾ˆå¤§çš„è¯,è¿™ä¸ªå‡çº§è¿‡ç¨‹ä¼šéå¸¸ä¹….å¯ä»¥ä½¿ç”¨ -sé€‰é¡¹åªå‡çº§ç³»ç»Ÿè¡¨ Notemysql_upgrade should not be used when the server is running with â€“gtid-mode=ON. See GTID mode and mysql_upgrade for more information. mysql_upgrade does not upgrade the contents of the help tables. For upgrade instructions, see Section 6.1.10, â€œServer-Side Helpâ€. 7.å…³é—­å¹¶é‡å¯MySQLç¡®ä¿å¯¹ç³»ç»Ÿæ ‡çš„æ”¹å˜ç”Ÿæ•ˆ12mysqladmin -u root -p shutdownmysqld_safe --user=mysql --datadir=/path/to/existing-datadir","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå‡çº§","slug":"MySQLå‡çº§","permalink":"http://fuxkdb.com/tags/MySQL%E5%8D%87%E7%BA%A7/"}]},{"title":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=OFF","slug":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=OFF","date":"2016-12-27T14:00:00.000Z","updated":"2017-08-05T16:01:57.000Z","comments":true,"path":"2016/12/27/MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=OFF/","link":"","permalink":"http://fuxkdb.com/2016/12/27/MySQL%E8%AF%AFDROP%E8%A1%A8%E6%81%A2%E5%A4%8D,innodb_file_per_table=OFF/","excerpt":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=OFFåŸæ–‡https://twindb.com/recover-after-drop-table-innodb_file_per_table-is-off/ Undrop-for-innodbå®‰è£…è¯¦è§https://github.com/chhabhaiya/undrop-for-innodb ä»‹ç»è¯¯æ“ä½œæ˜¯ä¸å¯é¿å…çš„.é”™è¯¯çš„DROP DATABASEæˆ–DROP TABLEä¼šæ‘§æ¯é‡è¦çš„æ•°æ®,æ›´æ‚²å‰§çš„æ˜¯å¤‡ä»½åˆä¸å¯ç”¨.æ¢å¤æ–¹æ³•å–å†³äºInnoDBæ˜¯å°†æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨å•ä¸ªibdata1ä¸­è¿˜æ˜¯æ¯ä¸ªè¡¨éƒ½æœ‰è‡ªå·±çš„è¡¨ç©ºé—´.åœ¨è¿™ç¯‡æ–‡ç« ä¸­,æˆ‘ä»¬å°†è€ƒè™‘innodb_file_per_table = OFFçš„æƒ…å†µ.æ­¤é€‰é¡¹å‡å®šæ‰€æœ‰è¡¨éƒ½å­˜å‚¨åœ¨é€šç”¨æ–‡ä»¶ä¸­,é€šå¸¸ä½äº/var/lib/mysql/ibdata1. è¯¯åˆ è¡¨æ¢å¤è¿™é‡Œä½¿ç”¨sakilaåº“,å‡è®¾æˆ‘ä»¬è¯¯åˆ é™¤äº†actorè¡¨123456789101112131415161718192021222324252627282930313233343536mysql&gt; SELECT * FROM actor LIMIT 10;+----------+------------+--------------+---------------------+| actor_id | first_name | last_name | last_update |+----------+------------+--------------+---------------------+| 1 | PENELOPE | GUINESS | 2006-02-15 04:34:33 || 2 | NICK | WAHLBERG | 2006-02-15 04:34:33 || 3 | ED | CHASE | 2006-02-15 04:34:33 || 4 | JENNIFER | DAVIS | 2006-02-15 04:34:33 || 5 | JOHNNY | LOLLOBRIGIDA | 2006-02-15 04:34:33 || 6 | BETTE | NICHOLSON | 2006-02-15 04:34:33 || 7 | GRACE | MOSTEL | 2006-02-15 04:34:33 || 8 | MATTHEW | JOHANSSON | 2006-02-15 04:34:33 || 9 | JOE | SWANK | 2006-02-15 04:34:33 || 10 | CHRISTIAN | GABLE | 2006-02-15 04:34:33 |+----------+------------+--------------+---------------------+10 rows in set (0.02 sec)æŸ¥çœ‹ä¸€ä¸‹checksummysql&gt; CHECKSUM TABLE actor;+--------------+------------+| Table | Checksum |+--------------+------------+| sakila.actor | 1702520518 |+--------------+------------+1 row in set (0.01 sec)mysql&gt; select count(*) from actor;+----------+| count(*) |+----------+| 200 |+----------+1 row in set (0.01 sec)mysql&gt; DROP TABLE actor;Query OK, 0 rows affected (0.03 sec)","text":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=OFFåŸæ–‡https://twindb.com/recover-after-drop-table-innodb_file_per_table-is-off/ Undrop-for-innodbå®‰è£…è¯¦è§https://github.com/chhabhaiya/undrop-for-innodb ä»‹ç»è¯¯æ“ä½œæ˜¯ä¸å¯é¿å…çš„.é”™è¯¯çš„DROP DATABASEæˆ–DROP TABLEä¼šæ‘§æ¯é‡è¦çš„æ•°æ®,æ›´æ‚²å‰§çš„æ˜¯å¤‡ä»½åˆä¸å¯ç”¨.æ¢å¤æ–¹æ³•å–å†³äºInnoDBæ˜¯å°†æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨å•ä¸ªibdata1ä¸­è¿˜æ˜¯æ¯ä¸ªè¡¨éƒ½æœ‰è‡ªå·±çš„è¡¨ç©ºé—´.åœ¨è¿™ç¯‡æ–‡ç« ä¸­,æˆ‘ä»¬å°†è€ƒè™‘innodb_file_per_table = OFFçš„æƒ…å†µ.æ­¤é€‰é¡¹å‡å®šæ‰€æœ‰è¡¨éƒ½å­˜å‚¨åœ¨é€šç”¨æ–‡ä»¶ä¸­,é€šå¸¸ä½äº/var/lib/mysql/ibdata1. è¯¯åˆ è¡¨æ¢å¤è¿™é‡Œä½¿ç”¨sakilaåº“,å‡è®¾æˆ‘ä»¬è¯¯åˆ é™¤äº†actorè¡¨123456789101112131415161718192021222324252627282930313233343536mysql&gt; SELECT * FROM actor LIMIT 10;+----------+------------+--------------+---------------------+| actor_id | first_name | last_name | last_update |+----------+------------+--------------+---------------------+| 1 | PENELOPE | GUINESS | 2006-02-15 04:34:33 || 2 | NICK | WAHLBERG | 2006-02-15 04:34:33 || 3 | ED | CHASE | 2006-02-15 04:34:33 || 4 | JENNIFER | DAVIS | 2006-02-15 04:34:33 || 5 | JOHNNY | LOLLOBRIGIDA | 2006-02-15 04:34:33 || 6 | BETTE | NICHOLSON | 2006-02-15 04:34:33 || 7 | GRACE | MOSTEL | 2006-02-15 04:34:33 || 8 | MATTHEW | JOHANSSON | 2006-02-15 04:34:33 || 9 | JOE | SWANK | 2006-02-15 04:34:33 || 10 | CHRISTIAN | GABLE | 2006-02-15 04:34:33 |+----------+------------+--------------+---------------------+10 rows in set (0.02 sec)æŸ¥çœ‹ä¸€ä¸‹checksummysql&gt; CHECKSUM TABLE actor;+--------------+------------+| Table | Checksum |+--------------+------------+| sakila.actor | 1702520518 |+--------------+------------+1 row in set (0.01 sec)mysql&gt; select count(*) from actor;+----------+| count(*) |+----------+| 200 |+----------+1 row in set (0.01 sec)mysql&gt; DROP TABLE actor;Query OK, 0 rows affected (0.03 sec) ä»ibdata1æ¢å¤è¯¯åˆ é™¤è¡¨è™½ç„¶è¡¨è¢«åˆ äº†,ä½†æ˜¯æ•°æ®å¯èƒ½ä¾ç„¶å­˜åœ¨äºibdata1ä¸­,ç›´åˆ°è¿™éƒ¨åˆ†æ•°æ®è¢«è¦†ç›–.æ‰€ä»¥è¦èµ¶ç´§åœæ­¢MySQL1234[mysql@master 3307]$ mysqladmin -umysql -p -S /data/mysqldata/3307/mysql.sock shutdownEnter password: 161227 14:13:59 mysqld_safe mysqld from pid file /data/mysqldata/3307/mysql.pid ended[1]+ Done mysqld_safe --defaults-file=/data/mysqldata/3307/my.cnf è§£æInnoDB tablespaceInnoDBé€šè¿‡B+æ ‘å­˜å‚¨æ•°æ®.æ¯ä¸ªè¡¨éƒ½é€šè¿‡ä¸»é”®èšç°‡,æ‰€æœ‰å­—æ®µæ•°æ®éƒ½å­˜å‚¨åœ¨ç´¢å¼•å¶å—ä¸­.å¦‚æœè¡¨æœ‰secondary index,åˆ™æ¯ä¸ªé”®å…·æœ‰ç´¢å¼•.æ¯ä¸ªç´¢å¼•é€šè¿‡index_idæ ‡è¯†.å¦‚æœæˆ‘ä»¬æƒ³è¦æ¢å¤ä¸€ä¸ªè¡¨,å°±è¦æ‰¾å‡ºå±äºç‰¹å®šindex_idçš„æ‰€æœ‰pagestream_parserè¯»å–InnoDB tablespace,å¹¶æŒ‰ç…§typeå’Œindex_idæ’åºInnoDB pages stream_parser reads InnoDB tablespace and sorts InnoDB pages per type and per index_id. 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960[mysql@master undrop-for-innodb]$ ./stream_parser -f /data/mysqldata/3307/data/ibdata1 Opening file: /data/mysqldata/3307/data/ibdata1File information:ID of device containing file: 64768inode number: 104900755protection: 100660 (regular file)number of hard links: 1user ID of owner: 27group ID of owner: 27device ID (if special file): 0blocksize for filesystem I/O: 4096number of blocks allocated: 4194304time of last access: 1482819237 Tue Dec 27 14:13:57 2016time of last modification: 1482819237 Tue Dec 27 14:13:57 2016time of last status change: 1482819237 Tue Dec 27 14:13:57 2016total size, in bytes: 2147483648 (2.000 GiB)Size to process: 2147483648 (2.000 GiB)Worker(0): 5.47% done. 2016-12-27 14:24:21 ETA(in 00:00:18). Processing speed: 104.000 MiB/secWorker(0): 13.67% done. 2016-12-27 14:24:14 ETA(in 00:00:10). Processing speed: 168.000 MiB/secWorker(0): 22.66% done. 2016-12-27 14:24:13 ETA(in 00:00:08). Processing speed: 184.000 MiB/secWorker(0): 28.52% done. 2016-12-27 14:24:18 ETA(in 00:00:12). Processing speed: 120.000 MiB/secWorker(0): 35.94% done. 2016-12-27 14:24:15 ETA(in 00:00:08). Processing speed: 152.000 MiB/secWorker(0): 43.75% done. 2016-12-27 14:24:15 ETA(in 00:00:07). Processing speed: 160.000 MiB/secWorker(0): 51.17% done. 2016-12-27 14:24:15 ETA(in 00:00:06). Processing speed: 152.000 MiB/secWorker(0): 57.81% done. 2016-12-27 14:24:16 ETA(in 00:00:06). Processing speed: 136.000 MiB/secWorker(0): 64.45% done. 2016-12-27 14:24:16 ETA(in 00:00:05). Processing speed: 136.000 MiB/secWorker(0): 71.48% done. 2016-12-27 14:24:16 ETA(in 00:00:04). Processing speed: 144.000 MiB/secWorker(0): 78.91% done. 2016-12-27 14:24:15 ETA(in 00:00:02). Processing speed: 152.000 MiB/secWorker(0): 85.16% done. 2016-12-27 14:24:16 ETA(in 00:00:02). Processing speed: 128.000 MiB/secWorker(0): 92.19% done. 2016-12-27 14:24:16 ETA(in 00:00:01). Processing speed: 144.000 MiB/secAll workers finished in 13 secData from database pages is saved by the stream_parser to folder pages-ibdata1:[mysql@master undrop-for-innodb]$ tree pages-ibdata1/pages-ibdata1/â”œâ”€â”€ FIL_PAGE_INDEXâ”‚ â”œâ”€â”€ 0000000000000001.pageâ”‚ â”œâ”€â”€ 0000000000000002.pageâ”‚ â”œâ”€â”€ 0000000000000003.pageâ”‚ â”œâ”€â”€ 0000000000000004.pageâ”‚ â”œâ”€â”€ 0000000000000005.pageâ”‚ â”œâ”€â”€ 0000000000000011.pageâ”‚ â”œâ”€â”€ 0000000000000012.pageâ”‚ â”œâ”€â”€ 0000000000000013.pageâ”‚ â”œâ”€â”€ 0000000000000014.pageâ”‚ â”œâ”€â”€ 0000000000000015.pageâ”‚ â”œâ”€â”€ 0000000000000016.pageâ”‚ â”œâ”€â”€ 0000000000000017.pageâ”‚ â”œâ”€â”€ 0000000000000018.pageâ”‚ â”œâ”€â”€ 0000000000000019.pageâ”‚ â”œâ”€â”€ 0000000000000020.pageâ”‚ â”œâ”€â”€ 0000000000000021.pageâ”‚ â”œâ”€â”€ 0000000000000022.pageâ”‚ â”œâ”€â”€ 0000000000000023.pageâ”‚ â””â”€â”€ 18446744069414584320.pageâ””â”€â”€ FIL_PAGE_TYPE_BLOB2 directories, 19 files ç°åœ¨ä»InnoDB tablespaceå–å‡ºçš„æ¯ä¸ªindex_idéƒ½è¢«ä¿å­˜åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­.æˆ‘ä»¬å¯ä»¥ä½¿ç”¨c_parserä»pageä¸­å–å›æ•°æ®,ä½†æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“actorè¡¨çš„index_idæ˜¯å¤šå°‘.æˆ‘ä»¬å¯ä»¥é€šè¿‡å­—å…¸è¡¨SYS_TABLESå’ŒSYS_INDEXESä¸­æŸ¥å‡ºactorè¡¨çš„ä¿¡æ¯ SYS_TABLESå­—å…¸è¡¨æ€»æ˜¯å­˜å‚¨åœ¨index_idä¸º1çš„æ–‡ä»¶ä¸­,å³pages-ibdata1/FIL_PAGE_INDEX./0000000000000001.page If MySQL had enough time to flush changes to disk then add -D option which means â€œfind deleted recordsâ€. The dictionary is always in REDUNDANT format, so we specify option -4: 12345[mysql@master undrop-for-innodb]$ ./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000001.page -t dictionary/SYS_TABLES.sql | grep sakila/actorSET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/SYS_TABLES&#x27; REPLACE INTO TABLE `SYS_TABLES` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;SYS_TABLES\\t&#x27; (`NAME`, `ID`, `N_COLS`, `TYPE`, `MIX_ID`, `MIX_LEN`, `CLUSTER_NAME`, `SPACE`);000000000712 0F0000014802C8 SYS_TABLES &quot;sakila/actor&quot; 20 4 1 0 64 &quot;&quot; 0000000000712 0F0000014802C8 SYS_TABLES &quot;sakila/actor&quot; 20 4 1 0 64 &quot;&quot; 0 åœ¨è¡¨åâ€sakila/actorâ€åé¢çš„åˆ—å°±æ˜¯table_idåˆ—,è¿™é‡ŒæŸ¥å‡ºactorè¡¨çš„table_idæ˜¯20æ¥ç€è¦æŸ¥å‡ºactorè¡¨çš„ä¸»é”®ç´¢å¼•çš„index_id,é€šè¿‡è§£æ0000000000000003.pageæ–‡ä»¶å¯ä»¥å–å‡ºSYS_INDEXESå­—å…¸è¡¨çš„æ•°æ®(è¿™ä¸ªè¡¨åŒ…å«index_idå’Œtable_idä¿¡æ¯).1234567[mysql@master undrop-for-innodb]$ ./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000003.page -t dictionary/SYS_INDEXES.sql | grep 20SET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/SYS_INDEXES&#x27; REPLACE INTO TABLE `SYS_INDEXES` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;SYS_INDEXES\\t&#x27; (`TABLE_ID`, `ID`, `NAME`, `N_FIELDS`, `TYPE`, `SPACE`, `PAGE_NO`);000000000712 0F000001480145 SYS_INDEXES 20 22 &quot;PRIMARY&quot; 1 3 0 4294967295000000000712 0F0000014801B7 SYS_INDEXES 20 23 &quot;idx\\_actor\\_last\\_name&quot; 1 0 0 4294967295000000000712 0F000001480145 SYS_INDEXES 20 22 &quot;PRIMARY&quot; 1 3 0 4294967295000000000712 0F0000014801B7 SYS_INDEXES 20 23 &quot;idx\\_actor\\_last\\_name&quot; 1 0 0 4294967295ä»ç»“æœå¯ä»¥çœ‹å‡º,ä¸»é”®çš„index_idæ˜¯22.å› æ­¤æˆ‘ä»¬å°†ä»0000000000000022.pageæ–‡ä»¶ä¸­å–å›actorè¡¨çš„æ•°æ®,éœ€è¦actorè¡¨çš„å»ºè¡¨è¯­å¥123456[mysql@master undrop-for-innodb]$ ./c_parser -6f pages-ibdata1/FIL_PAGE_INDEX/0000000000000022.page -t sakila/actor.sql | head -5-- Page id: 320, Format: COMPACT, Records list: Valid, Expected records: (200 200)000000000709 89000001430110 actor 1 &quot;PENELOPE&quot; &quot;GUINESS&quot; &quot;2006-02-15 04:34:33&quot;000000000709 8900000143011A actor 2 &quot;NICK&quot; &quot;WAHLBERG&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430124 actor 3 &quot;ED&quot; &quot;CHASE&quot; &quot;2006-02-15 04:34:33&quot;000000000709 8900000143012E actor 4 &quot;JENNIFER&quot; &quot;DAVIS&quot; &quot;2006-02-15 04:34:33&quot;ä»ç»“æœæ¥çœ‹æˆ‘ä»¬æ‰¾åˆ°äº†æ•°æ®,ä¸‹é¢é€šè¿‡c_parserç”Ÿæˆload data infileè¯­å¥å’Œæ•°æ®1234[mysql@master undrop-for-innodb]$ mkdir -p dumps/default[mysql@master undrop-for-innodb]$ ./c_parser -6f pages-ibdata1/FIL_PAGE_INDEX/0000000000000022.page -t sakila/actor.sql &gt; dumps/default/actor 2&gt; dumps/default/actor_load.sql[mysql@master undrop-for-innodb]$ ls dumps/default/actor actor_load.sql.sqlæ–‡ä»¶åŒ…å«load dataè¯­å¥123[mysql@master undrop-for-innodb]$ cat dumps/default/actor_load.sqlSET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/actor&#x27; REPLACE INTO TABLE `actor` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;actor\\t&#x27; (`actor_id`, `first_name`, `last_name`, `last_update`);å¦ä¸€ä¸ªæ–‡ä»¶åŒ…å«æ•°æ®12345678910111213[mysql@master undrop-for-innodb]$ more dumps/default/actor-- Page id: 320, Format: COMPACT, Records list: Valid, Expected records: (200 200)000000000709 89000001430110 actor 1 &quot;PENELOPE&quot; &quot;GUINESS&quot; &quot;2006-02-15 04:34:33&quot;000000000709 8900000143011A actor 2 &quot;NICK&quot; &quot;WAHLBERG&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430124 actor 3 &quot;ED&quot; &quot;CHASE&quot; &quot;2006-02-15 04:34:33&quot;000000000709 8900000143012E actor 4 &quot;JENNIFER&quot; &quot;DAVIS&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430138 actor 5 &quot;JOHNNY&quot; &quot;LOLLOBRIGIDA&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430142 actor 6 &quot;BETTE&quot; &quot;NICHOLSON&quot; &quot;2006-02-15 04:34:33&quot;000000000709 8900000143014C actor 7 &quot;GRACE&quot; &quot;MOSTEL&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430156 actor 8 &quot;MATTHEW&quot; &quot;JOHANSSON&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430160 actor 9 &quot;JOE&quot; &quot;SWANK&quot; &quot;2006-02-15 04:34:33&quot;000000000709 8900000143016A actor 10 &quot;CHRISTIAN&quot; &quot;GABLE&quot; &quot;2006-02-15 04:34:33&quot;000000000709 89000001430174 actor 11 &quot;ZERO&quot; &quot;CAGE&quot; &quot;2006-02-15 04:34:33&quot; ##æ¢å¤æ•°æ®å¯åŠ¨æ•°æ®åº“1mysqld_safe --defaults-file=/data/mysqldata/3307/my.cnf &amp;åˆ›å»ºè¡¨123mysql&gt; use sakilaDatabase changedmysql&gt; source sakila/actor.sqlloadå›æ•°æ®12345678910111213141516171819202122mysql&gt; source dumps/default/actor_load.sqlQuery OK, 0 rows affected (0.00 sec)Query OK, 400 rows affected (0.01 sec)Records: 400 Deleted: 0 Skipped: 0 Warnings: 0mysql&gt; select count(*) from actor;+----------+| count(*) |+----------+| 200 |+----------+1 row in set (0.00 sec)checksumå’Œä¹‹å‰ä¹Ÿæ˜¯ä¸€æ ·çš„mysql&gt; CHECKSUM TABLE actor;+--------------+------------+| Table | Checksum |+--------------+------------+| sakila.actor | 1702520518 |+--------------+------------+1 row in set (0.00 sec)","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"æ¢å¤è¡¨ç»“æ„","slug":"æ¢å¤è¡¨ç»“æ„","date":"2016-12-27T14:00:00.000Z","updated":"2017-08-05T16:00:29.000Z","comments":true,"path":"2016/12/27/æ¢å¤è¡¨ç»“æ„/","link":"","permalink":"http://fuxkdb.com/2016/12/27/%E6%81%A2%E5%A4%8D%E8%A1%A8%E7%BB%93%E6%9E%84/","excerpt":"æ¢å¤è¡¨ç»“æ„æ­¤æ–‡æ¡£é€‚ç”¨äº.frmæ–‡ä»¶ä¸¢å¤±,å¹¶ä¸”æ²¡æœ‰å¤‡ä»½æƒ…å†µä¸‹æ¢å¤å‡ºå»ºè¡¨è¯­å¥ æ¢å¤InnoDBå­—å…¸è¡¨é¦–å…ˆåˆ›å»ºç”¨äºæ¢å¤çš„å­—å…¸è¾…åŠ©è¡¨12345678910111213141516mysql&gt; create database sakila_recovered;Query OK, 1 row affected (0.01 sec)[mysql@master undrop-for-innodb]$ cat dictionary/SYS_* | mysql -umysql -pmysql -S /data/mysqldata/3307/mysql.sock sakila_recoveredWarning: Using a password on the command line interface can be insecure.mysql&gt; show tables;+----------------------------+| Tables_in_sakila_recovered |+----------------------------+| SYS_COLUMNS || SYS_FIELDS || SYS_INDEXES || SYS_TABLES |+----------------------------+4 rows in set (0.00 sec)å­—å…¸è¡¨å­˜å‚¨åœ¨ibdata1ä¸­,æ‰€ä»¥è¦è§£æå®ƒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960[mysql@master undrop-for-innodb]$ ./stream_parser -f /data/mysqldata/3307/data/ibdata1 Opening file: /data/mysqldata/3307/data/ibdata1File information:ID of device containing file: 64768inode number: 104900755protection: 100660 (regular file)number of hard links: 1user ID of owner: 27group ID of owner: 27device ID (if special file): 0blocksize for filesystem I/O: 4096number of blocks allocated: 4194304time of last access: 1482819237 Tue Dec 27 14:13:57 2016time of last modification: 1482819237 Tue Dec 27 14:13:57 2016time of last status change: 1482819237 Tue Dec 27 14:13:57 2016total size, in bytes: 2147483648 (2.000 GiB)Size to process: 2147483648 (2.000 GiB)Worker(0): 5.47% done. 2016-12-27 14:24:21 ETA(in 00:00:18). Processing speed: 104.000 MiB/secWorker(0): 13.67% done. 2016-12-27 14:24:14 ETA(in 00:00:10). Processing speed: 168.000 MiB/secWorker(0): 22.66% done. 2016-12-27 14:24:13 ETA(in 00:00:08). Processing speed: 184.000 MiB/secWorker(0): 28.52% done. 2016-12-27 14:24:18 ETA(in 00:00:12). Processing speed: 120.000 MiB/secWorker(0): 35.94% done. 2016-12-27 14:24:15 ETA(in 00:00:08). Processing speed: 152.000 MiB/secWorker(0): 43.75% done. 2016-12-27 14:24:15 ETA(in 00:00:07). Processing speed: 160.000 MiB/secWorker(0): 51.17% done. 2016-12-27 14:24:15 ETA(in 00:00:06). Processing speed: 152.000 MiB/secWorker(0): 57.81% done. 2016-12-27 14:24:16 ETA(in 00:00:06). Processing speed: 136.000 MiB/secWorker(0): 64.45% done. 2016-12-27 14:24:16 ETA(in 00:00:05). Processing speed: 136.000 MiB/secWorker(0): 71.48% done. 2016-12-27 14:24:16 ETA(in 00:00:04). Processing speed: 144.000 MiB/secWorker(0): 78.91% done. 2016-12-27 14:24:15 ETA(in 00:00:02). Processing speed: 152.000 MiB/secWorker(0): 85.16% done. 2016-12-27 14:24:16 ETA(in 00:00:02). Processing speed: 128.000 MiB/secWorker(0): 92.19% done. 2016-12-27 14:24:16 ETA(in 00:00:01). Processing speed: 144.000 MiB/secAll workers finished in 13 secData from database pages is saved by the stream_parser to folder pages-ibdata1:[mysql@master undrop-for-innodb]$ tree pages-ibdata1/pages-ibdata1/â”œâ”€â”€ FIL_PAGE_INDEXâ”‚ â”œâ”€â”€ 0000000000000001.pageâ”‚ â”œâ”€â”€ 0000000000000002.pageâ”‚ â”œâ”€â”€ 0000000000000003.pageâ”‚ â”œâ”€â”€ 0000000000000004.pageâ”‚ â”œâ”€â”€ 0000000000000005.pageâ”‚ â”œâ”€â”€ 0000000000000011.pageâ”‚ â”œâ”€â”€ 0000000000000012.pageâ”‚ â”œâ”€â”€ 0000000000000013.pageâ”‚ â”œâ”€â”€ 0000000000000014.pageâ”‚ â”œâ”€â”€ 0000000000000015.pageâ”‚ â”œâ”€â”€ 0000000000000016.pageâ”‚ â”œâ”€â”€ 0000000000000017.pageâ”‚ â”œâ”€â”€ 0000000000000018.pageâ”‚ â”œâ”€â”€ 0000000000000019.pageâ”‚ â”œâ”€â”€ 0000000000000020.pageâ”‚ â”œâ”€â”€ 0000000000000021.pageâ”‚ â”œâ”€â”€ 0000000000000022.pageâ”‚ â”œâ”€â”€ 0000000000000023.pageâ”‚ â””â”€â”€ 18446744069414584320.pageâ””â”€â”€ FIL_PAGE_TYPE_BLOB2 directories, 19 files","text":"æ¢å¤è¡¨ç»“æ„æ­¤æ–‡æ¡£é€‚ç”¨äº.frmæ–‡ä»¶ä¸¢å¤±,å¹¶ä¸”æ²¡æœ‰å¤‡ä»½æƒ…å†µä¸‹æ¢å¤å‡ºå»ºè¡¨è¯­å¥ æ¢å¤InnoDBå­—å…¸è¡¨é¦–å…ˆåˆ›å»ºç”¨äºæ¢å¤çš„å­—å…¸è¾…åŠ©è¡¨12345678910111213141516mysql&gt; create database sakila_recovered;Query OK, 1 row affected (0.01 sec)[mysql@master undrop-for-innodb]$ cat dictionary/SYS_* | mysql -umysql -pmysql -S /data/mysqldata/3307/mysql.sock sakila_recoveredWarning: Using a password on the command line interface can be insecure.mysql&gt; show tables;+----------------------------+| Tables_in_sakila_recovered |+----------------------------+| SYS_COLUMNS || SYS_FIELDS || SYS_INDEXES || SYS_TABLES |+----------------------------+4 rows in set (0.00 sec)å­—å…¸è¡¨å­˜å‚¨åœ¨ibdata1ä¸­,æ‰€ä»¥è¦è§£æå®ƒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960[mysql@master undrop-for-innodb]$ ./stream_parser -f /data/mysqldata/3307/data/ibdata1 Opening file: /data/mysqldata/3307/data/ibdata1File information:ID of device containing file: 64768inode number: 104900755protection: 100660 (regular file)number of hard links: 1user ID of owner: 27group ID of owner: 27device ID (if special file): 0blocksize for filesystem I/O: 4096number of blocks allocated: 4194304time of last access: 1482819237 Tue Dec 27 14:13:57 2016time of last modification: 1482819237 Tue Dec 27 14:13:57 2016time of last status change: 1482819237 Tue Dec 27 14:13:57 2016total size, in bytes: 2147483648 (2.000 GiB)Size to process: 2147483648 (2.000 GiB)Worker(0): 5.47% done. 2016-12-27 14:24:21 ETA(in 00:00:18). Processing speed: 104.000 MiB/secWorker(0): 13.67% done. 2016-12-27 14:24:14 ETA(in 00:00:10). Processing speed: 168.000 MiB/secWorker(0): 22.66% done. 2016-12-27 14:24:13 ETA(in 00:00:08). Processing speed: 184.000 MiB/secWorker(0): 28.52% done. 2016-12-27 14:24:18 ETA(in 00:00:12). Processing speed: 120.000 MiB/secWorker(0): 35.94% done. 2016-12-27 14:24:15 ETA(in 00:00:08). Processing speed: 152.000 MiB/secWorker(0): 43.75% done. 2016-12-27 14:24:15 ETA(in 00:00:07). Processing speed: 160.000 MiB/secWorker(0): 51.17% done. 2016-12-27 14:24:15 ETA(in 00:00:06). Processing speed: 152.000 MiB/secWorker(0): 57.81% done. 2016-12-27 14:24:16 ETA(in 00:00:06). Processing speed: 136.000 MiB/secWorker(0): 64.45% done. 2016-12-27 14:24:16 ETA(in 00:00:05). Processing speed: 136.000 MiB/secWorker(0): 71.48% done. 2016-12-27 14:24:16 ETA(in 00:00:04). Processing speed: 144.000 MiB/secWorker(0): 78.91% done. 2016-12-27 14:24:15 ETA(in 00:00:02). Processing speed: 152.000 MiB/secWorker(0): 85.16% done. 2016-12-27 14:24:16 ETA(in 00:00:02). Processing speed: 128.000 MiB/secWorker(0): 92.19% done. 2016-12-27 14:24:16 ETA(in 00:00:01). Processing speed: 144.000 MiB/secAll workers finished in 13 secData from database pages is saved by the stream_parser to folder pages-ibdata1:[mysql@master undrop-for-innodb]$ tree pages-ibdata1/pages-ibdata1/â”œâ”€â”€ FIL_PAGE_INDEXâ”‚ â”œâ”€â”€ 0000000000000001.pageâ”‚ â”œâ”€â”€ 0000000000000002.pageâ”‚ â”œâ”€â”€ 0000000000000003.pageâ”‚ â”œâ”€â”€ 0000000000000004.pageâ”‚ â”œâ”€â”€ 0000000000000005.pageâ”‚ â”œâ”€â”€ 0000000000000011.pageâ”‚ â”œâ”€â”€ 0000000000000012.pageâ”‚ â”œâ”€â”€ 0000000000000013.pageâ”‚ â”œâ”€â”€ 0000000000000014.pageâ”‚ â”œâ”€â”€ 0000000000000015.pageâ”‚ â”œâ”€â”€ 0000000000000016.pageâ”‚ â”œâ”€â”€ 0000000000000017.pageâ”‚ â”œâ”€â”€ 0000000000000018.pageâ”‚ â”œâ”€â”€ 0000000000000019.pageâ”‚ â”œâ”€â”€ 0000000000000020.pageâ”‚ â”œâ”€â”€ 0000000000000021.pageâ”‚ â”œâ”€â”€ 0000000000000022.pageâ”‚ â”œâ”€â”€ 0000000000000023.pageâ”‚ â””â”€â”€ 18446744069414584320.pageâ””â”€â”€ FIL_PAGE_TYPE_BLOB2 directories, 19 filesç°åœ¨æˆ‘ä»¬è¦ä»ç”Ÿæˆçš„pageæ–‡ä»¶ä¸­æŠ½å–å­—å…¸è®°å½•,æˆ‘ä»¬å¿åˆ›å»ºä¸€ä¸ªç›®å½•1mkdir -p dumps/defaultAnd now we can generate table dumps and LOAD INFILE commands to load the dumps. We also need to specify -D option to c_parser because the records we need were deleted from the dictionary when the table was dropped.ç°åœ¨å¼€å§‹æ¢å¤å­—å…¸è¡¨SYS_TABLES1234./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000001.page \\ -t dictionary/SYS_TABLES.sql \\ &gt; dumps/default/SYS_TABLES \\ 2&gt; dumps/default/SYS_TABLES.sqlSYS_INDEXES1234./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000003.page \\ -t dictionary/SYS_INDEXES.sql \\ &gt; dumps/default/SYS_INDEXES \\ 2&gt; dumps/default/SYS_INDEXES.sqlSYS_COLUMNS1234./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000002.page \\ -t dictionary/SYS_COLUMNS.sql \\ &gt; dumps/default/SYS_COLUMNS \\ 2&gt; dumps/default/SYS_COLUMNS.sqlSYS_FIELDS1234./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000004.page \\ -t dictionary/SYS_FIELDS.sql \\ &gt; dumps/default/SYS_FIELDS \\ 2&gt; dumps/default/SYS_FIELDS.sqlç”Ÿæˆäº†åŒ…å«æ•°æ®çš„æ–‡ä»¶å’ŒåŒ…å«load data infileè¯­å¥çš„sqlæ–‡ä»¶123[mysql@master undrop-for-innodb]$ ls dumps/default/SYS_COLUMNS SYS_FIELDS SYS_INDEXES SYS_TABLESSYS_COLUMNS.sql SYS_FIELDS.sql SYS_INDEXES.sql SYS_TABLES.sqlæ¢å¤å­—å…¸è¡¨æ•°æ®cat dumps/default/*.sql | mysql -umysql -pmysql -S /data/mysqldata/3307/mysql.sock sakila_recovered ç¼–è¯‘sys_parsersys_parser is a tool that reads dictionary from tables stored in MySQL and generates CREATE TABLE structure for a table. To compile it we will need MySQL libraries and development files. Depending on a distribution they may be in -devel or -dev package. On RedHat based system you can check it with command yum provides â€œ*/mysql_configâ€ . On my server it was package mysql-community-devel. If all necessary packages are installed compilation boils down to simple command:123[mysql@master undrop-for-innodb]$ make sys_parser/usr/local/mysql/bin/mysql_configcc -o sys_parser sys_parser.c `mysql_config --cflags` `mysql_config --libs` æ¢å¤è¡¨ç»“æ„12345678[mysql@master undrop-for-innodb]$ ./sys_parser -u mysql -p mysql -d sakila_recovered sakila/actorCREATE TABLE `actor`( `actor_id` SMALLINT UNSIGNED NOT NULL, `first_name` VARCHAR(45) CHARACTER SET &#x27;utf8&#x27; COLLATE &#x27;utf8_general_ci&#x27; NOT NULL, `last_name` VARCHAR(45) CHARACTER SET &#x27;utf8&#x27; COLLATE &#x27;utf8_general_ci&#x27; NOT NULL, `last_update` TIMESTAMP NOT NULL, PRIMARY KEY (`actor_id`)) ENGINE=InnoDB; é—æ†¾çš„æ˜¯å¥½åƒsys_parserä¸èƒ½æŒ‡å®šsock,åªèƒ½ç”¨é»˜è®¤ç«¯å£å·3306è¿˜æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹:1.InnoDBä¸å­˜å‚¨æ‚¨å¯ä»¥åœ¨frmæ–‡ä»¶ä¸­æ‰¾åˆ°çš„æ‰€æœ‰ä¿¡æ¯ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå­—æ®µæ˜¯AUTO_INCREMENTï¼ŒInnoDBå­—å…¸ä»€ä¹ˆä¹Ÿä¸çŸ¥é“ã€‚å› æ­¤ï¼Œsys_parserå°†ä¸ä¼šæ¢å¤è¯¥å±æ€§ã€‚ å¦‚æœæœ‰ä»»ä½•å­—æ®µæˆ–è¡¨çº§æ³¨é‡Šï¼Œä»–ä»¬å°†ä¸¢å¤±2.sys_parserç”Ÿæˆé€‚åˆè¿›ä¸€æ­¥æ•°æ®æ¢å¤çš„è¡¨ç»“æ„ã€‚ å®ƒå¯ä»¥ä½†ä¸ä¼šæ¢å¤äºŒçº§ç´¢å¼•ï¼Œå¤–é”®ã€‚3.InnoDBä¸å­˜å‚¨DECIMALç±»å‹ä½œä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²ã€‚ å®ƒä¸å­˜å‚¨DECIMALå­—æ®µçš„ç²¾åº¦ã€‚ è¿™æ ·ä¿¡æ¯å°±ä¼šä¸¢å¤±ã€‚ For example, table payment uses DECIMAL to store money.1234567891011# ./sys_parser -u root -p qwerty -d sakila_recovered sakila/paymentCREATE TABLE `payment`( `payment_id` SMALLINT UNSIGNED NOT NULL, `customer_id` SMALLINT UNSIGNED NOT NULL, `staff_id` TINYINT UNSIGNED NOT NULL, `rental_id` INT, `amount` DECIMAL(6,0) NOT NULL, `payment_date` DATETIME NOT NULL, `last_update` TIMESTAMP NOT NULL, PRIMARY KEY (`payment_id`)) ENGINE=InnoDB;å¹¸è¿çš„æ˜¯ï¼ŒOracleè®¡åˆ’æ‰©å±•InnoDBå­—å…¸ï¼Œæœ€ç»ˆæ‘†è„±äº†.frmæ–‡ä»¶ã€‚","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=ON","slug":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=ON","date":"2016-12-26T14:00:00.000Z","updated":"2017-08-05T16:02:05.000Z","comments":true,"path":"2016/12/26/MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=ON/","link":"","permalink":"http://fuxkdb.com/2016/12/26/MySQL%E8%AF%AFDROP%E8%A1%A8%E6%81%A2%E5%A4%8D,innodb_file_per_table=ON/","excerpt":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=ON å‚è€ƒhttps://twindb.com/recover-after-drop-table-innodb_file_per_table-is-on/ Undrop-for-innodbå®‰è£…è¯¦è§https://github.com/chhabhaiya/undrop-for-innodb åˆ é™¤Countryè¡¨å¹¶æ¢å¤ä½¿ç”¨sakilaç¤ºä¾‹æ•°æ®åº“ä½œä¸ºä¾‹å­,sakilaç›¸å½“äºOracleçš„SCOTTinnodbæ¯ä¸ªè¡¨åŒ…å«ä¸¤ä¸ªæ–‡ä»¶.frmæ–‡ä»¶åŒ…å«å»ºè¡¨è¯­å¥.ibdæ–‡ä»¶åŒ…å«æ•°æ®123[mysql@master sakila]$ ll country.*-rw-r----- 1 mysql mysql 8652 Aug 26 14:25 country.frm-rw-r----- 1 mysql mysql 98304 Aug 26 14:25 country.ibd æ¥ä¸‹æ¥åˆ é™¤countryè¡¨,åˆ ä¹‹å‰çœ‹ä¸€ä¸‹checksum1234567891011121314151617SESSION_A&gt; use sakilaDatabase changedSESSION_A&gt; select count(*) from country;+----------+| count(*) |+----------+| 109 |+----------+1 row in set (0.01 sec)SESSION_A&gt;checksum table country;+---------------------+------------+| Table | Checksum |+---------------------+------------+| sakila.country | 2039770088 |+---------------------+------------+1 row in set (0.00 sec)æ¥ä¸‹æ¥åˆ é™¤countryè¡¨12SESSION_A&gt;drop table country;Query OK, 0 rows affected (0.01 sec) drop tableå,.frmå’Œ.ibdæ–‡ä»¶ä¹Ÿè¢«åˆ é™¤äº†12[mysql@master sakila]$ ll country*ls: cannot access country*: No such file or directory","text":"MySQLè¯¯DROPè¡¨æ¢å¤,innodb_file_per_table=ON å‚è€ƒhttps://twindb.com/recover-after-drop-table-innodb_file_per_table-is-on/ Undrop-for-innodbå®‰è£…è¯¦è§https://github.com/chhabhaiya/undrop-for-innodb åˆ é™¤Countryè¡¨å¹¶æ¢å¤ä½¿ç”¨sakilaç¤ºä¾‹æ•°æ®åº“ä½œä¸ºä¾‹å­,sakilaç›¸å½“äºOracleçš„SCOTTinnodbæ¯ä¸ªè¡¨åŒ…å«ä¸¤ä¸ªæ–‡ä»¶.frmæ–‡ä»¶åŒ…å«å»ºè¡¨è¯­å¥.ibdæ–‡ä»¶åŒ…å«æ•°æ®123[mysql@master sakila]$ ll country.*-rw-r----- 1 mysql mysql 8652 Aug 26 14:25 country.frm-rw-r----- 1 mysql mysql 98304 Aug 26 14:25 country.ibd æ¥ä¸‹æ¥åˆ é™¤countryè¡¨,åˆ ä¹‹å‰çœ‹ä¸€ä¸‹checksum1234567891011121314151617SESSION_A&gt; use sakilaDatabase changedSESSION_A&gt; select count(*) from country;+----------+| count(*) |+----------+| 109 |+----------+1 row in set (0.01 sec)SESSION_A&gt;checksum table country;+---------------------+------------+| Table | Checksum |+---------------------+------------+| sakila.country | 2039770088 |+---------------------+------------+1 row in set (0.00 sec)æ¥ä¸‹æ¥åˆ é™¤countryè¡¨12SESSION_A&gt;drop table country;Query OK, 0 rows affected (0.01 sec) drop tableå,.frmå’Œ.ibdæ–‡ä»¶ä¹Ÿè¢«åˆ é™¤äº†12[mysql@master sakila]$ ll country*ls: cannot access country*: No such file or directory æ¢å¤è¡¨è¿™æ˜¯æƒ…å†µæ¯”è¾ƒå¤æ‚,å› ä¸ºè¯¯åˆ é™¤äº†è¡¨,æ­¤æ—¶å¦‚æœæ•°æ®åº“è¿˜æ˜¯æ´»åŠ¨çš„,é‚£ä¹ˆå¾ˆæœ‰å¯èƒ½countryè¡¨çš„æ•°æ®ä¼šè¢«rewrite.æ­¤æ—¶åº”è¯¥ç«‹å³åœæ­¢æ•°æ®åº“,å¹¶æŠŠæ›¾ç»åŒ…å«countryè¡¨æ•°æ®çš„ç£ç›˜åˆ†åŒºè®¾ä¸ºread-onlyä»¥å…è¢«è¦†ç›–.åœ¨è¿™é‡Œ,æˆ‘ä»¬åªåœæ­¢MySQLå°±å¥½äº†12345[mysql@master ~]$ mysqladmin -S /data/mysqldata/3306/mysql.sock -umysql -pmysql shutdownWarning: Using a password on the command line interface can be insecure.[mysql@master ~]$ ps -ef | grep mysqld | grep -v grep[mysql@master ~]$ å°½ç®¡æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç‹¬ç«‹è¡¨ç©ºé—´,ä½†æ˜¯æ•°æ®å­—å…¸ä»ç„¶å­˜å‚¨åœ¨ibdata1ä¸­. ä½¿ç”¨stream_parserè§£ææ•°æ®æ–‡ä»¶12345678910111213141516171819202122232425[mysql@master undrop-for-innodb]$ ./stream_parser -f /data/mysqldata/3306/data/ibdata1 Opening file: /data/mysqldata/3306/data/ibdata1File information:ID of device containing file: 64768inode number: 106448290protection: 100640 (regular file)number of hard links: 1user ID of owner: 27group ID of owner: 27device ID (if special file): 0blocksize for filesystem I/O: 4096number of blocks allocated: 4194304time of last access: 1482762932 Mon Dec 26 22:35:32 2016time of last modification: 1482762932 Mon Dec 26 22:35:32 2016time of last status change: 1482762932 Mon Dec 26 22:35:32 2016total size, in bytes: 2147483648 (2.000 GiB)Size to process: 2147483648 (2.000 GiB)Worker(0): 3.90% done. 2016-12-26 22:36:46 ETA(in 00:00:27). Processing speed: 71.922 MiB/secWorker(0): 30.46% done. 2016-12-26 22:36:22 ETA(in 00:00:02). Processing speed: 544.000 MiB/secWorker(0): 55.46% done. 2016-12-26 22:36:22 ETA(in 00:00:01). Processing speed: 512.000 MiB/secWorker(0): 75.39% done. 2016-12-26 22:36:23 ETA(in 00:00:01). Processing speed: 408.000 MiB/secWorker(0): 92.96% done. 2016-12-26 22:36:23 ETA(in 00:00:00). Processing speed: 360.000 MiB/secAll workers finished in 5 sec è§£æä¹‹åä¼šç”Ÿæˆå¦‚ä¸‹ç›®å½•å’Œæ–‡ä»¶123456789101112131415161718192021222324252627282930[mysql@master undrop-for-innodb]$ tree pages-ibdata1/pages-ibdata1/â”œâ”€â”€ FIL_PAGE_INDEXâ”‚ â”œâ”€â”€ 0000000000000001.pageâ”‚ â”œâ”€â”€ 0000000000000002.pageâ”‚ â”œâ”€â”€ 0000000000000003.pageâ”‚ â”œâ”€â”€ 0000000000000004.pageâ”‚ â”œâ”€â”€ 0000000000000005.pageâ”‚ â”œâ”€â”€ 0000000000000011.pageâ”‚ â”œâ”€â”€ 0000000000000012.pageâ”‚ â”œâ”€â”€ 0000000000000013.pageâ”‚ â”œâ”€â”€ 0000000000000014.pageâ”‚ â”œâ”€â”€ 0000000000000015.pageâ”‚ â”œâ”€â”€ 0000000000000016.pageâ”‚ â”œâ”€â”€ 0000000000000529.pageâ”‚ â”œâ”€â”€ 0000000000000655.pageâ”‚ â”œâ”€â”€ 0000000000000657.pageâ”‚ â”œâ”€â”€ 0000000000000658.pageâ”‚ â”œâ”€â”€ 0000000000000659.pageâ”‚ â”œâ”€â”€ 0000000000000661.pageâ”‚ â”œâ”€â”€ 0000000000000665.pageâ”‚ â”œâ”€â”€ 0000000000000666.pageâ”‚ â”œâ”€â”€ 0000000000000667.pageâ”‚ â”œâ”€â”€ 0000000000000669.pageâ”‚ â”œâ”€â”€ 0000000000000680.pageâ”‚ â”œâ”€â”€ 0000000000000718.pageâ”‚ â””â”€â”€ 18446744069414584320.pageâ””â”€â”€ FIL_PAGE_TYPE_BLOB2 directories, 24 filesä¸ºäº†æ‰¾å‡ºTABLE_IDå’ŒINDEX_ID,æˆ‘ä»¬éœ€è¦æŸ¥çœ‹SYS_TABLESå’ŒSYS_INDEXESæ•°æ®å­—å…¸.æˆ‘ä»¬ä¼šä»ibdata1ä¸­å–å‡ºæ•°æ®.å› ä¸ºæ•°æ®å­—å…¸è®°å½•æ€»æ˜¯å†—ä½™çš„,æ‰€ä»¥æˆ‘ä»¬è¦æ‰§è¡Œ -4é€‰é¡¹,åŒæ—¶æˆ‘ä»¬å‡å®šmysqlå·²ç»å°†å˜åŒ–åˆ·åˆ°ç£ç›˜äº†.æ‰€ä»¥æŒ‡å®š-Dé€‰é¡¹,è¡¨ç¤ºæ‰¾å‡ºåˆ é™¤çš„è®°å½•.SYS_TABLESè¡¨çš„ä¿¡æ¯å­˜å‚¨åœ¨index_id=1çš„æ–‡ä»¶ä¸­,å³pages-ibdata1/FIL_PAGE_INDEX./0000000000000001.page12345[mysql@master undrop-for-innodb]$ ./c_parser -4Df ./pages-ibdata1/FIL_PAGE_INDEX/0000000000000001.page -t ./dictionary/SYS_TABLES.sql | grep countrySET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/SYS_TABLES&#x27; REPLACE INTO TABLE `SYS_TABLES` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;SYS_TABLES\\t&#x27; (`NAME`, `ID`, `N_COLS`, `TYPE`, `MIX_ID`, `MIX_LEN`, `CLUSTER_NAME`, `SPACE`);00000004FA1A 150000037222EC SYS_TABLES &quot;sakila/country&quot; 714 3 65 0 80 &quot;&quot; 70300000004FA1A 150000037222EC SYS_TABLES &quot;sakila/country&quot; 714 3 65 0 80 &quot;&quot; 703æˆ‘ä»¬å¯ä»¥çœ‹åˆ°countryè¡¨çš„table_idæ˜¯714.æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ‰¾åˆ°countryè¡¨çš„ä¸»é”®ç´¢å¼•.æˆ‘ä»¬éœ€è¦æŸ¥çœ‹0000000000000003.pageæ–‡ä»¶ä¸­çš„SYS_INDEXESè¡¨æ•°æ® (SYS_INDEXES table contains mapping between table_id and index_id).1234[mysql@master undrop-for-innodb]$ ./c_parser -4Df ./pages-ibdata1/FIL_PAGE_INDEX/0000000000000003.page -t ./dictionary/SYS_INDEXES.sql | grep 714SET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/SYS_INDEXES&#x27; REPLACE INTO TABLE `SYS_INDEXES` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;SYS_INDEXES\\t&#x27; (`TABLE_ID`, `ID`, `NAME`, `N_FIELDS`, `TYPE`, `SPACE`, `PAGE_NO`);00000004FA1A 150000037221CC SYS_INDEXES 714 729 &quot;PRIMARY&quot; 1 3 703 4294967295æˆ‘ä»¬å¯ä»¥çœ‹åˆ°countryè¡¨çš„index_idæ˜¯729 ç”±äºæ²¡æœ‰å¯ç”¨æ•°æ®çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æ‰«ææ‰€æœ‰å­˜å‚¨è®¾å¤‡ä½œä¸ºåŸå§‹è®¾å¤‡ï¼Œå¹¶æŸ¥æ‰¾é€‚åˆæ•°æ®åº“é¡µé¢çš„é¢„æœŸç»“æ„çš„æ•°æ®ã€‚ é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥ç”¨äºå·²ç»æŸåçš„æ•°æ®æ–‡ä»¶ã€‚ å¦‚æœä¸€äº›æ•°æ®è¢«æŸåï¼Œæ¢å¤å·¥å…·å¯ä»¥æ‰§è¡Œéƒ¨åˆ†æ•°æ®æ¢å¤ã€‚ åœ¨å·¥å…·çš„é€‰é¡¹ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šè®¾å¤‡çš„åç§°å’Œè®¾å¤‡å¤§å°ï¼ˆå¯ä»¥æ˜¯è¿‘ä¼¼å€¼ï¼‰ã€‚ Since there is no file with data available, we will scan through all the storage device as raw device and look for data that fit in expected structure of the database pages. By the way, this approach can be taken in case we have corrupted data files. If some data is corrupted, recovery tool can perform partial data recovery. In the options of the tool we specify name of the device and device size (can be approximate). è¿™é‡Œæˆ‘çš„æ•°æ®æ”¾åœ¨/dev/mapper/centos-oracle ä¸‹ æ‰€ä»¥rootç”¨æˆ·scan 30Gæ•°æ®,ç£ç›˜è¦æœ‰è¶³å¤Ÿç©ºé—´,å¹¶ä¸”è¯·æ³¨æ„ä¸è¦åœ¨æ›¾ç»åŒ…å«è¢«åˆ é™¤è¡¨.ibdæ–‡ä»¶æ‰€æŒ‚è½½çš„ç£ç›˜ä¸‹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤,å› ä¸ºä»–ä¼šç”Ÿæˆå¤§é‡æ–‡ä»¶,å¯èƒ½å¯¼è‡´rewrite.1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162[root@master undrop-for-innodb]# ./stream_parser -f /dev/mapper/centos-oracle -t 20000000kOpening file: /dev/mapper/centos-oracleFile information:ID of device containing file: 5inode number: 15178protection: 60660 (block device)number of hard links: 1user ID of owner: 0group ID of owner: 6device ID (if special file): 64770blocksize for filesystem I/O: 4096number of blocks allocated: 0time of last access: 1482761058 Mon Dec 26 22:04:18 2016time of last modification: 1481179251 Thu Dec 8 14:40:51 2016time of last status change: 1481179251 Thu Dec 8 14:40:51 2016total size, in bytes: 0 (0.000 exp(+0))Size to process: 20480000000 (19.073 GiB)Worker(0): 1.06% done. 2016-12-26 22:41:21 ETA(in 00:01:36). Processing speed: 199.621 MiB/secWorker(0): 2.09% done. 2016-12-26 22:42:58 ETA(in 00:03:11). Processing speed: 99.806 MiB/secWorker(0): 3.11% done. 2016-12-26 22:41:22 ETA(in 00:01:34). Processing speed: 199.612 MiB/secWorker(0): 4.13% done. 2016-12-26 22:42:57 ETA(in 00:03:07). Processing speed: 99.807 MiB/secWorker(0): 5.15% done. 2016-12-26 22:41:23 ETA(in 00:01:32). Processing speed: 199.617 MiB/sec...[mysql@master undrop-for-innodb]$ tree pages-centos-oracle/pages-centos-oracle/â”œâ”€â”€ FIL_PAGE_INDEXâ”‚ â”œâ”€â”€ 0000000000000001.pageâ”‚ â”œâ”€â”€ 0000000000000002.pageâ”‚ â”œâ”€â”€ 0000000000000003.pageâ”‚ â”œâ”€â”€ 0000000000000004.pageâ”‚ â”œâ”€â”€ 0000000000000005.pageâ”‚ â”œâ”€â”€ 0000000000000011.pageâ”‚ â”œâ”€â”€ 0000000000000012.pageâ”‚ â”œâ”€â”€ 0000000000000013.pageâ”‚ â”œâ”€â”€ 0000000000000014.pageâ”‚ â”œâ”€â”€ 0000000000000015.pageâ”‚ â”œâ”€â”€ 0000000000000016.pageâ”‚ â”œâ”€â”€ 0000000000000092.pageâ”‚ â”œâ”€â”€ 0000000000000347.pageâ”‚ â”œâ”€â”€ 0000000000000400.pageâ”‚ â”œâ”€â”€ 0000000000000407.pageâ”‚ â”œâ”€â”€ 0000000000000511.pageâ”‚ â”œâ”€â”€ 0000000000000529.pageâ”‚ â”œâ”€â”€ 0000000000000655.pageâ”‚ â”œâ”€â”€ 0000000000000657.pageâ”‚ â”œâ”€â”€ 0000000000000658.pageâ”‚ â”œâ”€â”€ 0000000000000659.pageâ”‚ â”œâ”€â”€ 0000000000000661.pageâ”‚ â”œâ”€â”€ 0000000000000665.pageâ”‚ â”œâ”€â”€ 0000000000000666.pageâ”‚ â”œâ”€â”€ 0000000000000667.pageâ”‚ â”œâ”€â”€ 0000000000000669.pageâ”‚ â”œâ”€â”€ 0000000000000680.pageâ”‚ â”œâ”€â”€ 0000000000000718.pageâ”‚ â”œâ”€â”€ 0000000000000729.pageâ”‚ â””â”€â”€ 18446744069414584320.pageâ””â”€â”€ FIL_PAGE_TYPE_BLOB2 directories, 30 files0000000000000729.pageä½¿æˆ‘ä»¬éœ€è¦çš„.è¿™é‡Œéœ€è¦countryçš„å»ºè¡¨è¯­å¥country.sql,æ‰€ä»¥è¯´è¯·å¤‡ä»½å¥½å…ƒæ•°æ®.è¿™é‡Œundrop-for-innodbè‡ªå¸¦äº†sakilaçš„å»ºè¡¨è¯­å¥ä»¥ä¾›å®éªŒä½¿ç”¨12345678[mysql@master undrop-for-innodb]$ ./c_parser -6f pages-centos-oracle/FIL_PAGE_INDEX/0000000000000729.page -t sakila/country.sql | head -5SET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/country&#x27; REPLACE INTO TABLE `country` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;country\\t&#x27; (`country_id`, `country`, `last_update`);-- Page id: 3, Format: COMPACT, Records list: Valid, Expected records: (109 109)00000004FA13 90000002820110 country 1 &quot;Afghanistan&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 9000000282011B country 2 &quot;Algeria&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 90000002820126 country 3 &quot;American Samoa&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 90000002820131 country 4 &quot;Angola&quot; &quot;2006-02-15 04:44:00&quot;çœ‹èµ·æ¥æˆ‘ä»¬æ‰¾åˆ°äº†æ•°æ®,ä¸‹é¢é€šè¿‡c_parserç”Ÿæˆload data infileè¯­å¥å’Œæ•°æ®12[mysql@master undrop-for-innodb]$ mkdir -p dumps/default[mysql@master undrop-for-innodb]$ ./c_parser -6f pages-centos-oracle/FIL_PAGE_INDEX/0000000000000729.page -t sakila/country.sql &gt; dumps/default/country 2&gt; dumps/default/country_load.sqlæŸ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„æ–‡ä»¶12345678910111213141516171819[mysql@master undrop-for-innodb]$ cd dumps/default/[mysql@master default]$ lscountry country_load.sqlè¿™æ˜¯åŒ…å«æ•°æ®çš„æ–‡ä»¶[mysql@master default]$ more country -- Page id: 3, Format: COMPACT, Records list: Valid, Expected records: (109 109)00000004FA13 90000002820110 country 1 &quot;Afghanistan&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 9000000282011B country 2 &quot;Algeria&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 90000002820126 country 3 &quot;American Samoa&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 90000002820131 country 4 &quot;Angola&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 9000000282013C country 5 &quot;Anguilla&quot; &quot;2006-02-15 04:44:00&quot;00000004FA13 90000002820147 country 6 &quot;Argentina&quot; &quot;2006-02-15 04:44:00&quot;è¿™æ˜¯ç”Ÿæˆçš„å†™å¥½çš„load data infileè¯­å¥[mysql@master default]$ more country_load.sql SET FOREIGN_KEY_CHECKS=0;LOAD DATA LOCAL INFILE &#x27;/var/lib/mysql/undrop-for-innodb/dumps/default/country&#x27; REPLACE INTO TABLE `country` FIELDS TERMINATED BY &#x27;\\t&#x27; OPTIONALLY ENCLOSED BY &#x27;&quot;&#x27; LINES STARTING BY &#x27;country\\t&#x27; (`country_id`, `country`, `last_update`); å¼€å§‹æ¢å¤æ•°æ®å¯åŠ¨æ•°æ®åº“1mysqld_safe --defaults-file=/data/mysqldata/3306/my.cnf &amp;åˆ›å»ºè¡¨123(mysql@localhost) [(none)]&gt; use sakilaDatabase changed(mysql@localhost) [sakila]&gt; source sakila/country.sqlloadå›æ•°æ®12345678910111213141516171819202122(mysql@localhost) [sakila]&gt; source dumps/default/country_load.sqlQuery OK, 0 rows affected (0.00 sec)Query OK, 109 rows affected (0.01 sec)Records: 109 Deleted: 0 Skipped: 0 Warnings: 0(mysql@localhost) [sakila]&gt; SELECT COUNT(*) FROM country;+----------+| COUNT(*) |+----------+| 109 |+----------+1 row in set (0.00 sec)checksumå’Œä¹‹å‰ä¹Ÿæ˜¯ä¸€æ ·çš„(mysql@localhost) [sakila]&gt; CHECKSUM TABLE country;+---------------------+------------+| Table | Checksum |+---------------------+------------+| sakila.country | 2039770088 |+---------------------+------------+1 row in set (0.00 sec)","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"},{"name":"MySQLå¤‡ä»½æ¢å¤","slug":"MySQLå¤‡ä»½æ¢å¤","permalink":"http://fuxkdb.com/tags/MySQL%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"}]},{"title":"Auto_increment äº§ç”Ÿ GAPçš„åŸå› ","slug":"Auto_increment-äº§ç”Ÿ-GAPçš„åŸå› ","date":"2016-12-20T14:00:00.000Z","updated":"2017-08-05T16:00:44.000Z","comments":true,"path":"2016/12/20/Auto_increment-äº§ç”Ÿ-GAPçš„åŸå› /","link":"","permalink":"http://fuxkdb.com/2016/12/20/Auto_increment-%E4%BA%A7%E7%94%9F-GAP%E7%9A%84%E5%8E%9F%E5%9B%A0/","excerpt":"åŸæ–‡http://thenoyes.com/littlenoise/?p=187 Auto_increment äº§ç”Ÿ GAPçš„åŸå› Why are there gaps in my auto_increment sequence, even if there are no deletes or rolled back transactions?Is it a bug?The manual says, â€œFor lock modes 1 or 2, gaps may occur between successive statements because for bulk inserts the exact number of auto-increment values required by each statement may not be known and overestimation is possible.â€Where does that overestimation come from?An example to illustrate:123456789101112131415161718192021222324252627282930DROP TABLE IF EXISTS t;CREATE TABLE t (a bigint unsigned auto_increment primary key) ENGINE=InnoDB SELECT NULL AS a;/* #1 */ INSERT INTO t SELECT NULL FROM t;/* #2 */ INSERT INTO t SELECT NULL FROM t;/* #3 */ INSERT INTO t SELECT NULL FROM t;/* #4 */ INSERT INTO t SELECT NULL FROM t;SELECT * FROM t;+----+| a |+----+| 1 || 2 || 3 || 4 || 6 || 7 || 8 || 9 || 13 || 14 || 15 || 16 || 17 || 18 || 19 || 20 |+----+16 rows in set (0.02 sec)","text":"åŸæ–‡http://thenoyes.com/littlenoise/?p=187 Auto_increment äº§ç”Ÿ GAPçš„åŸå› Why are there gaps in my auto_increment sequence, even if there are no deletes or rolled back transactions?Is it a bug?The manual says, â€œFor lock modes 1 or 2, gaps may occur between successive statements because for bulk inserts the exact number of auto-increment values required by each statement may not be known and overestimation is possible.â€Where does that overestimation come from?An example to illustrate:123456789101112131415161718192021222324252627282930DROP TABLE IF EXISTS t;CREATE TABLE t (a bigint unsigned auto_increment primary key) ENGINE=InnoDB SELECT NULL AS a;/* #1 */ INSERT INTO t SELECT NULL FROM t;/* #2 */ INSERT INTO t SELECT NULL FROM t;/* #3 */ INSERT INTO t SELECT NULL FROM t;/* #4 */ INSERT INTO t SELECT NULL FROM t;SELECT * FROM t;+----+| a |+----+| 1 || 2 || 3 || 4 || 6 || 7 || 8 || 9 || 13 || 14 || 15 || 16 || 17 || 18 || 19 || 20 |+----+16 rows in set (0.02 sec)Notice that 5 and 10-12 are missing. If we did another insert, weâ€™d be missing 21-27 (try it and see!) Hereâ€™s a model of what MySQL is doing: Create the table and simultaneously insert a single row. That is the row where a=1. 1: Insert as many rows as there are in the table (itâ€™s one row, but MySQL doesnâ€™t know that.) Grab a chunk of auto_increment values. How many in the chunk? One - the value â€˜2â€™. Insert it (one row inserted). No more rows to insert, so all done. 2: Insert as many rows as there are in the table (itâ€™s two rows, but MySQL doesnâ€™t know that.) Grab a chunk of auto_increment values. How many in the chunk? One - the value â€˜3â€™. Insert it (one row inserted). Still more rows to insert. Grab another chunk, twice as big as before - two values, â€˜4â€™ and â€˜5â€™. Insert the â€˜4â€™ (two rows inserted). No more rows to insert. Discard the left over â€˜5â€™. 3: Insert as many rows as there are in the table (itâ€™s four rows, but MySQL doesnâ€™t know that.) Grab a chunk of auto_increment values. How many in the chunk? One - the value â€˜6â€™. Insert it (one row inserted). Still more rows to insert. Grab another chunk, twice as big as before - two values, â€˜7â€™ and â€˜8â€™. Insert them (three rows inserted). Still more rows to insert. Grab another chunk, twice as big as before - four values, â€˜9â€™, â€˜10â€™, â€˜11â€™, â€˜12â€™. Insert the â€˜9â€™ (four rows inserted). No more rows to insert. Discard the left over â€˜10â€™, â€˜11â€™, and â€˜12â€™. 4: Insert as many rows as there are in the table (itâ€™s eight rows, but MySQL doesnâ€™t know that.) Grab a chunk of auto_increment values. How many in the chunk? One - the value â€˜13â€™. Insert it (one row inserted). Still more rows to insert. Grab another chunk, twice as big as before - two values, â€˜14â€™ and â€˜15â€™. Insert them (three rows inserted). Still more rows to insert. Grab another chunk, twice as big as before - four values, â€˜16â€™, â€˜17â€™, â€˜18â€™, â€˜19â€™. Insert them (seven rows inserted). Still more rows to insert. Grab another chunk, twice as big as before - eight values, â€˜20â€™, â€˜21â€™, â€˜22â€™, â€¦, â€˜27â€™. Insert the â€˜20â€™ (eight rows inserted). No more rows to insert. Discard the left over â€˜21â€™, â€˜22â€™, etc. The gap can get as big as 65535 (I didnâ€™t look in the code to confirm that, itâ€™s just what running the test above a few more times seems to suggest). When innodb_autoinc_lock_mode=1, there can be gaps between statements, but not within a statement, because thereâ€™s a lock on the auto_increment until weâ€™re done. #4 above is guaranteed to get 8 consecutive values, you just might not be sure where they are going to start (well, now you are, because you read this post). When innodb_autoinc_lock_mode=2, there can be gaps within a statement, because the auto_increment is not locked. Imagine weâ€™re in the middle of #4 above. Our statement is inserting the â€˜14â€™ and â€˜15â€™, when another statement comes along wanting just a single auto_increment value. It gets the â€˜16â€™. Now itâ€™s our turn to ask for another chunk, and we get â€˜17â€™, â€˜18â€™, â€˜19â€™, â€˜20â€™. While weâ€™re doing those, another statement comes along and steals our â€˜21â€™. So the last row for our statement is â€˜22â€™.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"AUTO-INCé”å’ŒAUTO_INCREMENTåœ¨InnoDBä¸­å¤„ç†æ–¹å¼","slug":"AUTO-INCé”å’ŒAUTO_INCREMENTåœ¨InnoDBä¸­å¤„ç†æ–¹å¼","date":"2016-12-15T14:00:00.000Z","updated":"2017-08-05T16:01:10.000Z","comments":true,"path":"2016/12/15/AUTO-INCé”å’ŒAUTO_INCREMENTåœ¨InnoDBä¸­å¤„ç†æ–¹å¼/","link":"","permalink":"http://fuxkdb.com/2016/12/15/AUTO-INC%E9%94%81%E5%92%8CAUTO_INCREMENT%E5%9C%A8InnoDB%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F/","excerpt":"AUTO-INC Locks An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into the table, any other transactions must wait to do their own inserts into that table, so that rows inserted by the first transaction receive consecutive primary key values. The innodb_autoinc_lock_mode configuration option controls the algorithm used for auto-increment locking. It allows you to choose how to trade off between predictable sequences of auto-increment values and maximum concurrency for insert operations. AUTO-INCé”æ˜¯å½“å‘ä½¿ç”¨å«æœ‰AUTO_INCREMENTåˆ—çš„è¡¨ä¸­æ’å…¥æ•°æ®æ—¶éœ€è¦è·å–çš„ä¸€ç§ç‰¹æ®Šçš„è¡¨çº§é”åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å‘è¡¨ä¸­æ’å…¥å€¼ï¼Œåˆ™ä»»ä½•å…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…å¯¹è¯¥è¡¨æ‰§è¡Œè‡ªå·±çš„æ’å…¥æ“ä½œï¼Œä»¥ä¾¿ç¬¬ä¸€ä¸ªäº‹åŠ¡æ’å…¥çš„è¡Œçš„å€¼æ˜¯è¿ç»­çš„ã€‚innodb_autoinc_lock_modeé…ç½®é€‰é¡¹æ§åˆ¶ç”¨äºè‡ªåŠ¨å¢é‡é”å®šçš„ç®—æ³•ã€‚ å®ƒå…è®¸æ‚¨é€‰æ‹©å¦‚ä½•åœ¨å¯é¢„æµ‹çš„è‡ªåŠ¨é€’å¢å€¼åºåˆ—å’Œæ’å…¥æ“ä½œçš„æœ€å¤§å¹¶å‘æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ AUTO_INCREMENT Handling in InnoDBInnoDBæä¾›äº†ä¸€ä¸ªå¯é…ç½®çš„é”å®šæœºåˆ¶ï¼Œå¯ä»¥æ˜¾ç€æé«˜ä½¿ç”¨AUTO_INCREMENTåˆ—å‘è¡¨ä¸­æ·»åŠ è¡Œçš„SQLè¯­å¥çš„å¯ä¼¸ç¼©æ€§å’Œæ€§èƒ½ã€‚ è¦å¯¹InnoDBè¡¨ä½¿ç”¨AUTO_INCREMENTæœºåˆ¶ï¼Œå¿…é¡»å°†AUTO_INCREMENTåˆ—å®šä¹‰ä¸ºç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œä»¥ä¾¿å¯ä»¥å¯¹è¡¨æ‰§è¡Œç›¸å½“äºç´¢å¼•çš„SELECT MAXï¼ˆai_colï¼‰æŸ¥æ‰¾ä»¥è·å–æœ€å¤§åˆ—å€¼ã€‚ é€šå¸¸ï¼Œè¿™æ˜¯é€šè¿‡ä½¿åˆ—æˆä¸ºæŸäº›è¡¨ç´¢å¼•çš„ç¬¬ä¸€åˆ—æ¥å®ç°çš„ã€‚ æœ¬èŠ‚ä»‹ç»AUTO_INCREMENTé”å®šæ¨¡å¼çš„è¡Œä¸ºï¼Œå¯¹ä¸åŒAUTO_INCREMENTé”å®šæ¨¡å¼è®¾ç½®çš„ä½¿ç”¨å«ä¹‰ï¼Œä»¥åŠInnoDBå¦‚ä½•åˆå§‹åŒ–AUTO_INCREMENTè®¡æ•°å™¨ã€‚ InnoDB AUTO_INCREMENTé”å®šæ¨¡å¼ InnoDB AUTO_INCREMENTé”å®šæ¨¡å¼ä½¿ç”¨å«ä¹‰ InnoDB AUTO_INCREMENTè®¡æ•°å™¨åˆå§‹åŒ–","text":"AUTO-INC Locks An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into the table, any other transactions must wait to do their own inserts into that table, so that rows inserted by the first transaction receive consecutive primary key values. The innodb_autoinc_lock_mode configuration option controls the algorithm used for auto-increment locking. It allows you to choose how to trade off between predictable sequences of auto-increment values and maximum concurrency for insert operations. AUTO-INCé”æ˜¯å½“å‘ä½¿ç”¨å«æœ‰AUTO_INCREMENTåˆ—çš„è¡¨ä¸­æ’å…¥æ•°æ®æ—¶éœ€è¦è·å–çš„ä¸€ç§ç‰¹æ®Šçš„è¡¨çº§é”åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å‘è¡¨ä¸­æ’å…¥å€¼ï¼Œåˆ™ä»»ä½•å…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…å¯¹è¯¥è¡¨æ‰§è¡Œè‡ªå·±çš„æ’å…¥æ“ä½œï¼Œä»¥ä¾¿ç¬¬ä¸€ä¸ªäº‹åŠ¡æ’å…¥çš„è¡Œçš„å€¼æ˜¯è¿ç»­çš„ã€‚innodb_autoinc_lock_modeé…ç½®é€‰é¡¹æ§åˆ¶ç”¨äºè‡ªåŠ¨å¢é‡é”å®šçš„ç®—æ³•ã€‚ å®ƒå…è®¸æ‚¨é€‰æ‹©å¦‚ä½•åœ¨å¯é¢„æµ‹çš„è‡ªåŠ¨é€’å¢å€¼åºåˆ—å’Œæ’å…¥æ“ä½œçš„æœ€å¤§å¹¶å‘æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ AUTO_INCREMENT Handling in InnoDBInnoDBæä¾›äº†ä¸€ä¸ªå¯é…ç½®çš„é”å®šæœºåˆ¶ï¼Œå¯ä»¥æ˜¾ç€æé«˜ä½¿ç”¨AUTO_INCREMENTåˆ—å‘è¡¨ä¸­æ·»åŠ è¡Œçš„SQLè¯­å¥çš„å¯ä¼¸ç¼©æ€§å’Œæ€§èƒ½ã€‚ è¦å¯¹InnoDBè¡¨ä½¿ç”¨AUTO_INCREMENTæœºåˆ¶ï¼Œå¿…é¡»å°†AUTO_INCREMENTåˆ—å®šä¹‰ä¸ºç´¢å¼•çš„ä¸€éƒ¨åˆ†ï¼Œä»¥ä¾¿å¯ä»¥å¯¹è¡¨æ‰§è¡Œç›¸å½“äºç´¢å¼•çš„SELECT MAXï¼ˆai_colï¼‰æŸ¥æ‰¾ä»¥è·å–æœ€å¤§åˆ—å€¼ã€‚ é€šå¸¸ï¼Œè¿™æ˜¯é€šè¿‡ä½¿åˆ—æˆä¸ºæŸäº›è¡¨ç´¢å¼•çš„ç¬¬ä¸€åˆ—æ¥å®ç°çš„ã€‚ æœ¬èŠ‚ä»‹ç»AUTO_INCREMENTé”å®šæ¨¡å¼çš„è¡Œä¸ºï¼Œå¯¹ä¸åŒAUTO_INCREMENTé”å®šæ¨¡å¼è®¾ç½®çš„ä½¿ç”¨å«ä¹‰ï¼Œä»¥åŠInnoDBå¦‚ä½•åˆå§‹åŒ–AUTO_INCREMENTè®¡æ•°å™¨ã€‚ InnoDB AUTO_INCREMENTé”å®šæ¨¡å¼ InnoDB AUTO_INCREMENTé”å®šæ¨¡å¼ä½¿ç”¨å«ä¹‰ InnoDB AUTO_INCREMENTè®¡æ•°å™¨åˆå§‹åŒ– InnoDB AUTO_INCREMENTé”å®šæ¨¡å¼æœ¬èŠ‚ä»‹ç»ç”¨äºç”Ÿæˆè‡ªåŠ¨é€’å¢å€¼çš„AUTO_INCREMENTé”å®šæ¨¡å¼çš„è¡Œä¸ºï¼Œä»¥åŠæ¯ç§é”å®šæ¨¡å¼å¦‚ä½•å½±å“å¤åˆ¶ã€‚ è‡ªåŠ¨é€’å¢é”å®šæ¨¡å¼åœ¨å¯åŠ¨æ—¶ä½¿ç”¨innodb_autoinc_lock_modeé…ç½®å‚æ•°è¿›è¡Œé…ç½®ã€‚ ä»¥ä¸‹æœ¯è¯­ç”¨äºæè¿°innodb_autoinc_lock_modeè®¾ç½®: â€œINSERT-likeâ€ statements(ç±»INSERTè¯­å¥)æ‰€æœ‰å¯ä»¥å‘è¡¨ä¸­å¢åŠ è¡Œçš„è¯­å¥,åŒ…æ‹¬INSERT, INSERT ... SELECT, REPLACE, REPLACE ... SELECT, and LOAD DATA.åŒ…æ‹¬â€œsimple-insertsâ€, â€œbulk-insertsâ€, and â€œmixed-modeâ€ inserts. â€œSimple insertsâ€å¯ä»¥é¢„å…ˆç¡®å®šè¦æ’å…¥çš„è¡Œæ•°ï¼ˆå½“è¯­å¥è¢«åˆå§‹å¤„ç†æ—¶ï¼‰çš„è¯­å¥ã€‚ è¿™åŒ…æ‹¬æ²¡æœ‰åµŒå¥—å­æŸ¥è¯¢çš„å•è¡Œå’Œå¤šè¡ŒINSERTå’ŒREPLACEè¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬INSERT ... ON DUPLICATE KEY UPDATEã€‚ â€œBulk insertsâ€äº‹å…ˆä¸çŸ¥é“è¦æ’å…¥çš„è¡Œæ•°ï¼ˆå’Œæ‰€éœ€è‡ªåŠ¨é€’å¢å€¼çš„æ•°é‡ï¼‰çš„è¯­å¥ã€‚ è¿™åŒ…æ‹¬INSERT ... SELECTï¼ŒREPLACE ... SELECTå’ŒLOAD DATAè¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬çº¯INSERTã€‚ InnoDBåœ¨å¤„ç†æ¯è¡Œæ—¶ä¸€æ¬¡ä¸ºAUTO_INCREMENTåˆ—åˆ†é…ä¸€ä¸ªæ–°å€¼ã€‚ â€œMixed-mode insertsâ€è¿™äº›æ˜¯â€œSimple insertsâ€è¯­å¥ä½†æ˜¯æŒ‡å®šä¸€äº›ï¼ˆä½†ä¸æ˜¯å…¨éƒ¨ï¼‰æ–°è¡Œçš„è‡ªåŠ¨é€’å¢å€¼ã€‚ ç¤ºä¾‹å¦‚ä¸‹ï¼Œå…¶ä¸­c1æ˜¯è¡¨t1çš„AUTO_INCREMENTåˆ—ï¼šINSERT INTO t1 (c1,c2) VALUES (1,&#39;a&#39;), (NULL,&#39;b&#39;), (5,&#39;c&#39;), (NULL,&#39;d&#39;); å¦ä¸€ç§ç±»å‹çš„â€œMixed-mode insertsâ€æ˜¯INSERT ... ON DUPLICATE KEY UPDATEï¼Œå…¶åœ¨æœ€åçš„æƒ…å†µä¸‹å®é™…ä¸Šæ˜¯INSERTè¯­å¥éšååˆè·Ÿäº†ä¸€ä¸ªUPDATEï¼Œå…¶ä¸­AUTO_INCREMENTåˆ—çš„åˆ†é…å€¼ä¸ä¸€å®šä¼šåœ¨ UPDATE é˜¶æ®µä½¿ç”¨ innodb_autoinc_lock_mode = 0 (â€œtraditionalâ€ lock mode)ä¼ ç»Ÿçš„é”å®šæ¨¡å¼æä¾›äº†åœ¨MySQL 5.1ä¸­å¼•å…¥innodb_autoinc_lock_modeé…ç½®å‚æ•°ä¹‹å‰å­˜åœ¨çš„ç›¸åŒè¡Œä¸ºã€‚ä¼ ç»Ÿçš„é”å®šæ¨¡å¼é€‰é¡¹ç”¨äºå‘åå…¼å®¹æ€§ï¼Œæ€§èƒ½æµ‹è¯•ä»¥åŠè§£å†³â€œMixed-mode insertsâ€çš„é—®é¢˜ï¼Œå› ä¸ºè¯­ä¹‰ä¸Šå¯èƒ½å­˜åœ¨å·®å¼‚ã€‚ åœ¨æ­¤é”å®šæ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰â€œINSERT-likeâ€è¯­å¥è·å¾—ä¸€ä¸ªç‰¹æ®Šçš„è¡¨çº§AUTO-INCé”ï¼Œç”¨äºæ’å…¥å…·æœ‰AUTO_INCREMENTåˆ—çš„è¡¨ã€‚æ­¤é”å®šé€šå¸¸ä¿æŒåˆ°è¯­å¥ç»“æŸï¼ˆä¸æ˜¯äº‹åŠ¡ç»“æŸï¼‰ï¼Œä»¥ç¡®ä¿ä¸ºç»™å®šçš„INSERTè¯­å¥åºåˆ—ä»¥å¯é¢„æµ‹å’Œå¯é‡å¤çš„é¡ºåºåˆ†é…è‡ªåŠ¨é€’å¢å€¼ï¼Œå¹¶ç¡®ä¿è‡ªåŠ¨é€’å¢ç”±ä»»ä½•ç»™å®šè¯­å¥åˆ†é…çš„å€¼æ˜¯è¿ç»­çš„ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778SESSION_A&gt;DROP TABLE IF EXISTS t;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;CREATE TABLE t (a bigint unsigned auto_increment primary key) ENGINE=InnoDB;Query OK, 0 rows affected (0.01 sec)SESSION_A&gt;insert into t values(1),(3),(4),(5),(6),(7);Query OK, 6 rows affected (0.01 sec)Records: 6 Duplicates: 0 Warnings: 0SESSION_A&gt;select * from t;+---+| a |+---+| 1 || 3 || 4 || 5 || 6 || 7 |+---+6 rows in set (0.00 sec)SESSION_A&gt;select @@innodb_autoinc_lock_mode;+----------------------------+| @@innodb_autoinc_lock_mode |+----------------------------+| 0 |+----------------------------+1 row in set (0.00 sec)A B C ä¸‰ä¸ªä¼šè¯äº‹åŠ¡éš”ç¦»çº§åˆ«éƒ½æ˜¯ RRSESSION_A&gt;select @@global.tx_isolation,@@session.tx_isolation;+-----------------------+------------------------+| @@global.tx_isolation | @@session.tx_isolation |+-----------------------+------------------------+| REPEATABLE-READ | REPEATABLE-READ |+-----------------------+------------------------+SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;delete from t where a&gt;4;Query OK, 3 rows affected (0.00 sec)Bä¼šè¯è¢«é”,è¿™æ˜¯ç”±äºä¼šè¯ A äº§ç”Ÿçš„ gap lockSESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;insert into t values(null); --æ³¨æ„è¿™é‡Œå› ä¸ºæ˜¯ null, é”éœ€è¦åœ¨å†…å­˜ä¸­åˆ†é… AUTO-INCREMENT å€¼C ä¼šè¯è¢«é˜»å¡SESSION_C&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_C&gt;insert into t values(2); --è¿™é‡Œæ’å…¥2,æ²¡æœ‰ gap lock ä¹Ÿè¢«é”äº†(mysql@localhost) [fandb]&gt; (mysql@localhost) [fandb]&gt; select trx_id,trx_state,trx_requested_lock_id,trx_weight,trx_mysql_thread_id,trx_query, trx_operation_state from information_schema.INNODB_TRX;+--------+-----------+-----------------------+------------+---------------------+----------------------------+-----------------------+| trx_id | trx_state | trx_requested_lock_id | trx_weight | trx_mysql_thread_id | trx_query | trx_operation_state |+--------+-----------+-----------------------+------------+---------------------+----------------------------+-----------------------+| 321912 | LOCK WAIT | 321912:701 | 3 | 7 | insert into t values(2) | setting auto-inc lock || 321911 | LOCK WAIT | 321911:690:3:1 | 3 | 2 | insert into t values(null) | inserting || 321906 | RUNNING | NULL | 5 | 1 | NULL | NULL |+--------+-----------+-----------------------+------------+---------------------+----------------------------+-----------------------+3 rows in set (0.00 sec)å¯ä»¥çœ‹åˆ°,SESSION_Cæ˜¯ç­‰å¾…è‡ªå¢é”ï¼Œä¸€ç›´å¤„äºsetting auto-inc lockçŠ¶æ€(mysql@localhost) [fandb]&gt; select * from information_schema.INNODB_LOCKS;+----------------+-------------+-----------+-----------+-------------+------------+------------+-----------+----------+------------------------+| lock_id | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |+----------------+-------------+-----------+-----------+-------------+------------+------------+-----------+----------+------------------------+| 321912:701 | 321912 | AUTO_INC | TABLE | `fandb`.`t` | NULL | NULL | NULL | NULL | NULL || 321911:701 | 321911 | AUTO_INC | TABLE | `fandb`.`t` | NULL | NULL | NULL | NULL | NULL || 321911:690:3:1 | 321911 | X | RECORD | `fandb`.`t` | PRIMARY | 690 | 3 | 1 | supremum pseudo-record || 321906:690:3:1 | 321906 | X | RECORD | `fandb`.`t` | PRIMARY | 690 | 3 | 1 | supremum pseudo-record |+----------------+-------------+-----------+-----------+-------------+------------+------------+-----------+----------+------------------------+4 rows in set (0.00 sec) åœ¨statement-based replicationçš„æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€å½“åœ¨ä»æœåŠ¡å™¨ä¸Šå¤åˆ¶SQLè¯­å¥æ—¶ï¼Œè‡ªåŠ¨å¢é‡åˆ—ä½¿ç”¨ä¸ä¸»æœåŠ¡å™¨ä¸Šç›¸åŒçš„å€¼ã€‚å¤šä¸ªINSERTè¯­å¥çš„æ‰§è¡Œç»“æœæ˜¯ç¡®å®šæ€§çš„ï¼ŒSLAVEå†ç°ä¸MASTERç›¸åŒçš„æ•°æ®ã€‚å¦‚æœç”±å¤šä¸ªINSERTè¯­å¥ç”Ÿæˆçš„è‡ªåŠ¨é€’å¢å€¼äº¤é”™ï¼Œåˆ™ä¸¤ä¸ªå¹¶å‘INSERTè¯­å¥çš„ç»“æœå°†æ˜¯ä¸ç¡®å®šçš„ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨åŸºäºè¯­å¥çš„å¤åˆ¶å¯é åœ°ä¼ æ’­åˆ°ä»å±æœåŠ¡å™¨ã€‚ ä¸ºäº†è§£é‡Šæ¸…æ¥š,æŸ¥çœ‹ä¸‹é¢çš„ä¾‹å­:12345CREATE TABLE t1 ( c1 INT(11) NOT NULL AUTO_INCREMENT, c2 VARCHAR(10) DEFAULT NULL, PRIMARY KEY (c1)) ENGINE=InnoDB;å‡è®¾æœ‰ä¸¤ä¸ªäº‹åŠ¡æ­£åœ¨è¿è¡Œï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½å°†è¡Œæ’å…¥åˆ°å…·æœ‰AUTO_INCREMENTåˆ—çš„è¡¨ä¸­ã€‚ ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨ä½¿ç”¨æ’å…¥1000è¡Œçš„INSERT â€¦ SELECTè¯­å¥ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨ä½¿ç”¨æ’å…¥ä¸€è¡Œçš„â€œSimple insertsâ€è¯­å¥:12Tx1: INSERT INTO t1 (c2) SELECT 1000 rows from another table ...Tx2: INSERT INTO t1 (c2) VALUES (&#x27;xxx&#x27;);InnoDBä¸èƒ½é¢„å…ˆå¾—çŸ¥æœ‰å¤šå°‘è¡Œä¼šä»TX1çš„selectéƒ¨åˆ†è·å–åˆ°,æ‰€ä»¥åœ¨äº‹åŠ¡è¿›è¡Œè¿‡ç¨‹ä¸­,InnoDBä¸€æ¬¡åªä¼šä¸ºAUTO_INCREMENTåˆ—åˆ†é…ä¸€ä¸ªå€¼.é€šè¿‡ä¸€ä¸ªè¡¨çº§é”çš„æ§åˆ¶,ä¿è¯äº†åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå¼•ç”¨è¡¨t1çš„INSERTè¯­å¥å¯ä»¥æ‰§è¡Œ,ç›´åˆ°æ•´ä¸ªINSERTè¯­å¥ç»“æŸ,å¹¶ä¸”ç”±ä¸åŒè¯­å¥ç”Ÿæˆè‡ªåŠ¨é€’å¢æ•°ä¸ä¼šäº¤é”™ç”±Tx1 INSERT ... SELECTè¯­å¥ç”Ÿæˆçš„è‡ªåŠ¨é€’å¢å€¼å°†æ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”Tx2ä¸­çš„INSERTè¯­å¥ä½¿ç”¨çš„ï¼ˆå•ä¸ªï¼‰è‡ªåŠ¨é€’å¢å€¼å°†å°äºæˆ–å¤§äºç”¨äºTx1çš„æ‰€æœ‰é‚£äº›å€¼ï¼Œå…·ä½“å–å†³äº é‚£ä¸ªè¯­å¥å…ˆæ‰§è¡Œã€‚ åªè¦SQLè¯­å¥åœ¨ä»äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆå½“ä½¿ç”¨åŸºäºè¯­å¥çš„å¤åˆ¶æˆ–åœ¨æ¢å¤æ–¹æ¡ˆä¸­ï¼‰é‡æ”¾æ—¶ä»¥ç›¸åŒçš„é¡ºåºæ‰§è¡Œï¼Œç»“æœå°†ä¸Tx1å’ŒTx2é¦–æ¬¡è¿è¡Œæ—¶çš„ç»“æœç›¸åŒã€‚ å› æ­¤ï¼ŒæŒç»­è‡³è¯­å¥ç»“æŸçš„è¡¨çº§é”å®š( table-level locks)ä¿è¯äº†åœ¨statement-based replicationä¸­å¯¹auto-incrementåˆ—çš„æ’å…¥æ•°æ®çš„å®‰å…¨æ€§. ä½†æ˜¯ï¼Œå½“å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œinsertè¯­å¥æ—¶ï¼Œè¿™äº›è¡¨çº§é”å®šä¼šé™åˆ¶å¹¶å‘æ€§å’Œå¯ä¼¸ç¼©æ€§ã€‚ åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¡¨çº§é”ï¼Œåˆ™Tx2ä¸­ç”¨äºINSERTçš„è‡ªåŠ¨é€’å¢åˆ—çš„å€¼å–å†³äºè¯­å¥æ‰§è¡Œçš„ç¡®åˆ‡æ—¶é—´ã€‚ å¦‚æœTx2çš„INSERTåœ¨Tx1çš„INSERTæ­£åœ¨è¿è¡Œæ—¶ï¼ˆè€Œä¸æ˜¯åœ¨å®ƒå¼€å§‹ä¹‹å‰æˆ–å®Œæˆä¹‹åï¼‰æ‰§è¡Œï¼Œåˆ™ç”±ä¸¤ä¸ªINSERTè¯­å¥åˆ†é…çš„ç‰¹å®šè‡ªåŠ¨é€’å¢å€¼å°†æ˜¯ä¸ç¡®å®šçš„ï¼Œå¹¶ä¸”å¯èƒ½æ¯æ¬¡è¿è¡Œéƒ½ä¼šå¾—åˆ°ä¸åŒçš„å€¼ åœ¨è¿ç»­é”å®šæ¨¡å¼ä¸‹ï¼ŒInnoDBå¯ä»¥é¿å…ä¸ºâ€œSimple insertsâ€è¯­å¥ä½¿ç”¨è¡¨çº§AUTO-INCé”ï¼Œå…¶ä¸­è¡Œæ•°æ˜¯é¢„å…ˆå·²çŸ¥çš„ï¼Œå¹¶ä¸”ä»ç„¶ä¿ç•™åŸºäºè¯­å¥çš„å¤åˆ¶çš„ç¡®å®šæ€§æ‰§è¡Œå’Œå®‰å…¨æ€§ã€‚ å¦‚æœä¸ä½¿ç”¨äºŒè¿›åˆ¶æ—¥å¿—ä½œä¸ºæ¢å¤æˆ–å¤åˆ¶çš„ä¸€éƒ¨åˆ†æ¥é‡æ”¾SQLè¯­å¥ï¼Œåˆ™å¯ä»¥ä½¿ç”¨interleaved lockæ¨¡å¼æ¥æ¶ˆé™¤æ‰€æœ‰ä½¿ç”¨è¡¨çº§AUTO-INCé”ï¼Œä»¥å®ç°æ›´å¤§çš„å¹¶å‘æ€§å’Œæ€§èƒ½,å…¶ä»£ä»·æ˜¯ç”±äºå¹¶å‘çš„è¯­å¥äº¤é”™æ‰§è¡Œ,åŒä¸€è¯­å¥ç”Ÿæˆçš„AUTO-INCREMENTå€¼å¯èƒ½ä¼šäº§ç”ŸGAP innodb_autoinc_lock_mode = 1 (â€œconsecutiveâ€ lock mode)è¿™æ˜¯é»˜è®¤çš„é”å®šæ¨¡å¼.åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹,â€œbulk insertsâ€ä»ç„¶ä½¿ç”¨AUTO-INCè¡¨çº§é”,å¹¶ä¿æŒåˆ°è¯­å¥ç»“æŸ.è¿™é€‚ç”¨äºæ‰€æœ‰INSERT ... SELECTï¼ŒREPLACE ... SELECTå’ŒLOAD DATAè¯­å¥ã€‚åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¯­å¥å¯ä»¥æŒæœ‰AUTO-INCé”. â€œSimple insertsâ€ï¼ˆè¦æ’å…¥çš„è¡Œæ•°äº‹å…ˆå·²çŸ¥ï¼‰é€šè¿‡åœ¨mutexï¼ˆè½»é‡é”ï¼‰çš„æ§åˆ¶ä¸‹è·å¾—æ‰€éœ€æ•°é‡çš„è‡ªåŠ¨é€’å¢å€¼æ¥é¿å…è¡¨çº§AUTO-INCé”ï¼Œ å®ƒåªåœ¨åˆ†é…è¿‡ç¨‹çš„æŒç»­æ—¶é—´å†…ä¿æŒï¼Œè€Œä¸æ˜¯ç›´åˆ°è¯­å¥å®Œæˆã€‚ ä¸ä½¿ç”¨è¡¨çº§AUTO-INCé”ï¼Œé™¤éAUTO-INCé”ç”±å¦ä¸€ä¸ªäº‹åŠ¡ä¿æŒã€‚ å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡ä¿æŒAUTO-INCé”ï¼Œåˆ™â€œç®€å•æ’å…¥â€ç­‰å¾…AUTO-INCé”ï¼Œå¦‚åŒå®ƒæ˜¯ä¸€ä¸ªâ€œæ‰¹é‡æ’å…¥â€ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162SESSION_A&gt;DROP TABLE IF EXISTS t;Query OK, 0 rows affected (0.01 sec)SESSION_A&gt;CREATE TABLE t (a bigint unsigned auto_increment primary key) ENGINE=InnoDB;Query OK, 0 rows affected (0.01 sec)SESSION_A&gt;insert into t values(1),(3),(4),(5),(6),(7);Query OK, 6 rows affected (0.01 sec)Records: 6 Duplicates: 0 Warnings: 0SESSION_A&gt;select @@innodb_autoinc_lock_mode;+----------------------------+| @@innodb_autoinc_lock_mode |+----------------------------+| 1 |+----------------------------+1 row in set (0.00 sec)SESSION_A&gt;select * from t;+---+| a |+---+| 1 || 3 || 4 || 5 || 6 || 7 |+---+6 rows in set (0.00 sec)SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;delete from t where a&gt;4;Query OK, 3 rows affected (0.00 sec)ä¼šè¯ B, è¢« GAP LOCK é˜»å¡SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;insert into t values(null); --ç”±äºæ˜¯`simple-insert`ä¸”`innodb_autoinc_lock_mode=1`,æ‰€ä»¥å¹¶ä¸éœ€è¦AUTO-INCè¡¨çº§é”ä¼šè¯ C æˆåŠŸæ’å…¥æ²¡æœ‰é˜»å¡SESSION_C&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_C&gt;insert into t values(2); --ç”±äºå®ƒä¹Ÿæ˜¯`simple-insert`ä¸”`innodb_autoinc_lock_mode=1`æ‰€ä»¥ä¸éœ€è¦è·å–AUTO-INCè¡¨çº§é”,æ²¡æœ‰é˜»å¡æˆåŠŸæ’å…¥Query OK, 1 row affected (0.00 sec)Cä¼šè¯rollback,Bä¼šè¯æ”¹ä¸ºä½¿ç”¨â€œBulk insertsâ€SESSION_C&gt;rollback;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;insert into t select null;æ­¤æ—¶ C ä¼šè¯åˆè¢«é˜»å¡äº†SESSION_C&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_C&gt;insert into t values(2); --è¿™éªŒè¯äº†å®˜æ–¹æ–‡æ¡£ä¸­çš„è¯´æ³•`If another transaction holds an AUTO-INC lock, a â€œsimple insertâ€ waits for the AUTO-INC lock, as if it were a â€œbulk insertâ€.`Query OK, 1 row affected (41.17 sec) æ­¤é”å®šæ¨¡å¼ç¡®ä¿,å½“è¡Œæ•°ä¸é¢„å…ˆçŸ¥é“çš„INSERTå­˜åœ¨æ—¶(å¹¶ä¸”è‡ªåŠ¨é€’å¢å€¼åœ¨è¯­å¥è¿‡ç¨‹æ‰§è¡Œä¸­åˆ†é…)ç”±ä»»ä½•â€œç±»INSERTâ€è¯­å¥åˆ†é…çš„æ‰€æœ‰è‡ªåŠ¨é€’å¢å€¼æ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”å¯¹äºåŸºäºè¯­å¥çš„å¤åˆ¶(statement-based replication)æ“ä½œæ˜¯å®‰å…¨çš„ã€‚ è¿™ç§é”å®šæ¨¡å¼æ˜¾è‘—åœ°æé«˜äº†å¯æ‰©å±•æ€§,å¹¶ä¸”ä¿è¯äº†å¯¹äºåŸºäºè¯­å¥çš„å¤åˆ¶(statement-based replication)çš„å®‰å…¨æ€§.æ­¤å¤–ï¼Œä¸â€œä¼ ç»Ÿâ€é”å®šæ¨¡å¼ä¸€æ ·ï¼Œç”±ä»»ä½•ç»™å®šè¯­å¥åˆ†é…çš„è‡ªåŠ¨é€’å¢æ•°å­—æ˜¯è¿ç»­çš„ã€‚ ä¸ä½¿ç”¨è‡ªåŠ¨é€’å¢çš„ä»»ä½•è¯­å¥çš„â€œä¼ ç»Ÿâ€æ¨¡å¼ç›¸æ¯”ï¼Œè¯­ä¹‰æ²¡æœ‰å˜åŒ–.ä½†æœ‰ä¸€ä¸ªç‰¹ä¾‹: The exception is for â€œmixed-mode insertsâ€, where the user provides explicit values for an AUTO_INCREMENT column for some, but not all, rows in a multiple-row â€œsimple insertâ€. For such inserts, InnoDB allocates more auto-increment values than the number of rows to be inserted. However, all values automatically assigned are consecutively generated (and thus higher than) the auto-increment value generated by the most recently executed previous statement. â€œExcessâ€ numbers are lost. innodb_autoinc_lock_mode = 2 (â€œinterleavedâ€ lock mode)åœ¨è¿™ç§é”å®šæ¨¡å¼ä¸‹,æ‰€æœ‰ç±»INSERT(â€œINSERT-likeâ€ )è¯­å¥éƒ½ä¸ä¼šä½¿ç”¨è¡¨çº§AUTO-INC lock,å¹¶ä¸”å¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªè¯­å¥ã€‚è¿™æ˜¯æœ€å¿«å’Œæœ€å¯æ‰©å±•çš„é”å®šæ¨¡å¼ï¼Œä½†æ˜¯å½“ä½¿ç”¨åŸºäºè¯­å¥çš„å¤åˆ¶æˆ–æ¢å¤æ–¹æ¡ˆæ—¶ï¼Œä»äºŒè¿›åˆ¶æ—¥å¿—é‡æ’­SQLè¯­å¥æ—¶ï¼Œè¿™æ˜¯ä¸å®‰å…¨çš„ã€‚ åœ¨æ­¤é”å®šæ¨¡å¼ä¸‹ï¼Œè‡ªåŠ¨é€’å¢å€¼ä¿è¯åœ¨æ‰€æœ‰å¹¶å‘æ‰§è¡Œçš„â€œç±»INSERTâ€è¯­å¥ä¸­æ˜¯å”¯ä¸€ä¸”å•è°ƒé€’å¢çš„ã€‚ä½†æ˜¯ï¼Œç”±äºå¤šä¸ªè¯­å¥å¯ä»¥åŒæ—¶ç”Ÿæˆæ•°å­—ï¼ˆå³ï¼Œè·¨è¯­å¥äº¤å‰ç¼–å·ï¼‰ï¼Œä¸ºä»»ä½•ç»™å®šè¯­å¥æ’å…¥çš„è¡Œç”Ÿæˆçš„å€¼å¯èƒ½ä¸æ˜¯è¿ç»­çš„ã€‚ å¦‚æœæ‰§è¡Œçš„è¯­å¥æ˜¯â€œsimple insertsâ€ï¼Œå…¶ä¸­è¦æ’å…¥çš„è¡Œæ•°å·²æå‰çŸ¥é“ï¼Œåˆ™é™¤äº†â€œæ··åˆæ¨¡å¼æ’å…¥â€ä¹‹å¤–ï¼Œä¸ºå•ä¸ªè¯­å¥ç”Ÿæˆçš„æ•°å­—ä¸ä¼šæœ‰é—´éš™ã€‚ç„¶è€Œï¼Œå½“æ‰§è¡Œâ€œæ‰¹é‡æ’å…¥â€æ—¶ï¼Œåœ¨ç”±ä»»ä½•ç»™å®šè¯­å¥åˆ†é…çš„è‡ªåŠ¨é€’å¢å€¼ä¸­å¯èƒ½å­˜åœ¨é—´éš™ã€‚ InnoDB AUTO_INCREMENTé”å®šæ¨¡å¼ä½¿ç”¨å«ä¹‰ åœ¨å¤åˆ¶ç¯èŠ‚ä¸­ä½¿ç”¨è‡ªå¢åˆ—å¦‚æœä½ åœ¨ä½¿ç”¨åŸºäºè¯­å¥çš„å¤åˆ¶(statement-based replication)è¯·å°†innodb_autoinc_lock_modeè®¾ç½®ä¸º0æˆ–1ï¼Œå¹¶åœ¨ä¸»ä»ä¸Šä½¿ç”¨ç›¸åŒçš„å€¼ã€‚ å¦‚æœä½¿ç”¨innodb_autoinc_lock_mode = 2ï¼ˆâ€œinterleavedâ€ï¼‰æˆ–ä¸»ä»ä¸ä½¿ç”¨ç›¸åŒçš„é”å®šæ¨¡å¼çš„é…ç½®ï¼Œè‡ªåŠ¨é€’å¢å€¼ä¸èƒ½ä¿è¯åœ¨ä»æœºä¸Šä¸ä¸»æœºä¸Šç›¸åŒã€‚ å¦‚æœä½¿ç”¨åŸºäºè¡Œçš„æˆ–æ··åˆæ¨¡å¼çš„å¤åˆ¶ï¼Œåˆ™æ‰€æœ‰è‡ªåŠ¨å¢é‡é”å®šæ¨¡å¼éƒ½æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºåŸºäºè¡Œçš„å¤åˆ¶å¯¹SQLè¯­å¥çš„æ‰§è¡Œé¡ºåºä¸æ•æ„Ÿï¼ˆæ··åˆæ¨¡å¼ä¼šåœ¨é‡åˆ°ä¸å®‰å…¨çš„è¯­å¥æ˜¯ä½¿ç”¨åŸºäºè¡Œçš„å¤åˆ¶æ¨¡å¼ï¼‰ã€‚ â€œLostâ€ auto-increment values and sequence gapsåœ¨æ‰€æœ‰é”å®šæ¨¡å¼ï¼ˆ0,1å’Œ2ï¼‰ä¸­ï¼Œå¦‚æœç”Ÿæˆè‡ªåŠ¨é€’å¢å€¼çš„äº‹åŠ¡å›æ»šï¼Œé‚£äº›è‡ªåŠ¨é€’å¢å€¼å°†â€œä¸¢å¤±â€ã€‚ ä¸€æ—¦ä¸ºè‡ªåŠ¨å¢é‡åˆ—ç”Ÿæˆäº†å€¼ï¼Œæ— è®ºæ˜¯å¦å®Œæˆâ€œç±»ä¼¼INSERTâ€è¯­å¥ä»¥åŠåŒ…å«äº‹åŠ¡æ˜¯å¦å›æ»šï¼Œéƒ½ä¸èƒ½å›æ»šã€‚ è¿™ç§ä¸¢å¤±çš„å€¼ä¸è¢«é‡ç”¨ã€‚ å› æ­¤ï¼Œå­˜å‚¨åœ¨è¡¨çš„AUTO_INCREMENTåˆ—ä¸­çš„å€¼å¯èƒ½å­˜åœ¨é—´éš™ã€‚ Specifying NULL or 0 for the AUTO_INCREMENT columnåœ¨æ‰€æœ‰é”å®šæ¨¡å¼ï¼ˆ0,1å’Œ2ï¼‰ä¸­ï¼Œå¦‚æœç”¨æˆ·åœ¨INSERTä¸­ä¸ºAUTO_INCREMENTåˆ—æŒ‡å®šNULLæˆ–0ï¼ŒInnoDBä¼šå°†è¯¥è¡Œè§†ä¸ºæœªæŒ‡å®šå€¼ï¼Œå¹¶ä¸ºå…¶ç”Ÿæˆæ–°å€¼ã€‚ ä¸ºAUTO_INCREMENTåˆ—åˆ†é…ä¸€ä¸ªè´Ÿå€¼åœ¨æ‰€æœ‰é”å®šæ¨¡å¼ï¼ˆ0,1å’Œ2ï¼‰ä¸­ï¼Œå¦‚æœæ‚¨ä¸ºAUTO_INCREMENTåˆ—åˆ†é…äº†ä¸€ä¸ªè´Ÿå€¼ï¼Œåˆ™ä¸ä¼šå®šä¹‰è‡ªåŠ¨å¢é‡æœºåˆ¶çš„è¡Œä¸ºã€‚ å¦‚æœAUTO_INCREMENTå€¼å¤§äºæŒ‡å®šæ•´æ•°ç±»å‹çš„æœ€å¤§æ•´æ•°åœ¨æ‰€æœ‰é”å®šæ¨¡å¼ï¼ˆ0,1å’Œ2ï¼‰ä¸­ï¼Œå¦‚æœå€¼å¤§äºå¯ä»¥å­˜å‚¨åœ¨æŒ‡å®šæ•´æ•°ç±»å‹ä¸­çš„æœ€å¤§æ•´æ•°ï¼Œåˆ™ä¸å®šä¹‰è‡ªåŠ¨é€’å¢æœºåˆ¶çš„è¡Œä¸ºã€‚ Gaps in auto-increment values for â€œbulk insertsâ€å½“innodb_autoinc_lock_modeè®¾ç½®ä¸º0ï¼ˆâ€œtraditionalâ€ï¼‰æˆ–1ï¼ˆâ€œconsecutiveâ€ï¼‰æ—¶,ä»»ä½•ç»™å®šè¯­å¥ç”Ÿæˆçš„è‡ªåŠ¨é€’å¢å€¼æ˜¯è¿ç»­çš„ï¼Œæ²¡æœ‰é—´éš™ï¼Œå› ä¸ºè¡¨çº§AUTO-INCé”ä¼šæŒç»­åˆ° è¯­å¥ç»“æŸ,å¹¶ä¸”ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿™æ ·çš„è¯­å¥ã€‚ å½“innodb_autoinc_lock_modeè®¾ç½®ä¸º2ï¼ˆâ€œinterleavedâ€ï¼‰æ—¶ï¼Œåœ¨â€œbulk insertsâ€ç”Ÿæˆçš„è‡ªåŠ¨é€’å¢å€¼ä¸­å¯èƒ½å­˜åœ¨é—´éš™ï¼Œä½†åªæœ‰åœ¨å¹¶å‘æ‰§è¡Œâ€œINSERT-Likeâ€è¯­å¥æ—¶æ‰ä¼šäº§ç”Ÿè¿™ç§æƒ…å†µã€‚ å¯¹äºé”å®šæ¨¡å¼1æˆ–2ï¼Œåœ¨è¿ç»­è¯­å¥ä¹‹é—´å¯èƒ½å‡ºç°é—´éš™ï¼Œå› ä¸ºå¯¹äºæ‰¹é‡æ’å…¥ï¼Œæ¯ä¸ªè¯­å¥æ‰€éœ€çš„è‡ªåŠ¨é€’å¢å€¼çš„ç¡®åˆ‡æ•°ç›®å¯èƒ½ä¸ä¸ºäººæ‰€çŸ¥ï¼Œå¹¶ä¸”å¯èƒ½è¿›è¡Œè¿‡åº¦ä¼°è®¡ã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697select @@innodb_autoinc_lock_mode;+----------------------------+| @@innodb_autoinc_lock_mode |+----------------------------+| 0 |+----------------------------+DROP TABLE IF EXISTS t;CREATE TABLE t (a bigint unsigned auto_increment primary key) ENGINE=InnoDB SELECT NULL AS a;/* #1 */ INSERT INTO t SELECT NULL FROM t;/* #2 */ INSERT INTO t SELECT NULL FROM t;/* #3 */ INSERT INTO t SELECT NULL FROM t;/* #4 */ INSERT INTO t SELECT NULL FROM t;SELECT * FROM t;+----+| a |+----+| 1 || 2 || 3 || 4 || 5 || 6 || 7 || 8 || 9 || 10 || 11 || 12 || 13 || 14 || 15 || 16 |+----+å½“innodb_autoinc_lock_mode=0 ç±»INSERTè¯­å¥äº§ç”Ÿçš„è‡ªåŠ¨é€’å¢å€¼éƒ½æ˜¯è¿ç»­çš„select @@innodb_autoinc_lock_mode;+----------------------------+| @@innodb_autoinc_lock_mode |+----------------------------+| 1 |+----------------------------+1 row in set (0.00 sec)DROP TABLE IF EXISTS t;CREATE TABLE t (a bigint unsigned auto_increment primary key) ENGINE=InnoDB SELECT NULL AS a;/* #1 */ INSERT INTO t SELECT NULL FROM t;/* #2 */ INSERT INTO t SELECT NULL FROM t;/* #3 */ INSERT INTO t SELECT NULL FROM t;/* #4 */ INSERT INTO t SELECT NULL FROM t;SELECT * FROM t;+----+| a |+----+| 1 || 2 || 3 || 4 || 6 || 7 || 8 || 9 || 13 || 14 || 15 || 16 || 17 || 18 || 19 || 20 |+----+å‡ºç°äº†é—´éš™gap, 5å’Œ10-12éƒ½æ²¡äº†,ä¸‹é¢æ¥è§£é‡Šäº§ç”Ÿè¿™ç§æƒ…å†µçš„åŸå› :/* #1 */ è¿™æ˜¯ç¬¬ä¸€æ¬¡INSERT,æ­¤æ—¶è¡¨ä¸­åªæœ‰ä¸€è¡Œ(åˆ›å»ºè¡¨æ—¶çš„é‚£ä¸€è¡Œ),ä½†æ˜¯MySQLä¸çŸ¥é“æœ‰å¤šå°‘è¡Œ.ç„¶åMySQL Grab a chunk of auto_increment values åœ¨chunkä¸­æœ‰å¤šå°‘ï¼Ÿ ä¸€ åªæœ‰ä¸€ä¸ª,å³&#x27;2&#x27;,å°†å…¶æ’å…¥è¡¨ä¸­.æ²¡æœ‰æ›´å¤šçš„è¡Œæ’å…¥ï¼Œæ‰€ä»¥ä¸€åˆ‡å®Œæˆã€‚/* #2 */ è¿™æ˜¯ç¬¬äºŒæ¬¡INSERT,æ­¤æ—¶è¡¨ä¸­æœ‰ä¸¤è¡Œ(1,2),ä½†æ˜¯MySQLä¸çŸ¥é“æœ‰å¤šå°‘è¡Œ.MySQL Grab a chunk of auto_increment values åœ¨chunkä¸­æœ‰å¤šå°‘ï¼Ÿ ä¸€ åªæœ‰ä¸€ä¸ª,å³&#x27;3&#x27;,å°†å…¶æ’å…¥è¡¨ä¸­.è¿˜æœ‰éœ€è¦æ’å…¥çš„è¡Œ,æ‰€ä»¥Grab another chunk,è¿™æ¬¡æ˜¯å‰ä¸€æ¬¡çš„ä¸¤å€å¤§å° åœ¨chunkä¸­æœ‰å¤šå°‘ï¼Ÿ ä¸€ ä¸¤ä¸ª,&#x27;4&#x27;å’Œ&#x27;5&#x27;. æ’å…¥&#x27;4&#x27;.æ²¡æœ‰æ›´å¤šçš„è¡Œæ’å…¥ï¼Œæ‰€ä»¥ä¸€åˆ‡å®Œæˆ,&#x27;5&#x27;è¢«èˆå¼ƒ,ä½†æ˜¯æ­¤æ—¶ AUTO_INCREMENTçš„ä¸‹ä¸€ä¸ªå€¼æ˜¯6äº†/* #3 */è¿™æ˜¯ç¬¬ä¸‰æ¬¡INSERT,æ­¤æ—¶è¡¨ä¸­æœ‰å››è¡Œ(1,2,3,4),ä½†æ˜¯MySQLä¸çŸ¥é“æœ‰å¤šå°‘è¡Œ.- Grab a chunk of auto_increment values. How many in the chunk? One - the value &#x27;6&#x27;. Insert it (one row inserted).- Still more rows to insert. Grab another chunk, twice as big as before - two values, &#x27;7&#x27; and &#x27;8&#x27;. Insert them (three rows inserted).- Still more rows to insert. Grab another chunk, twice as big as before - four values, &#x27;9&#x27;, &#x27;10&#x27;, &#x27;11&#x27;, &#x27;12&#x27;. Insert the &#x27;9&#x27; (four rows inserted).- No more rows to insert. Discard the left over &#x27;10&#x27;, &#x27;11&#x27;, and &#x27;12&#x27;.#4: Insert as many rows as there are in the table (it&#x27;s eight rows, but MySQL doesn&#x27;t know that.)- Grab a chunk of auto_increment values. How many in the chunk? One - the value &#x27;13&#x27;. Insert it (one row inserted).- Still more rows to insert. Grab another chunk, twice as big as before - two values, &#x27;14&#x27; and &#x27;15&#x27;. Insert them (three rows inserted).- Still more rows to insert. Grab another chunk, twice as big as before - four values, &#x27;16&#x27;, &#x27;17&#x27;, &#x27;18&#x27;, &#x27;19&#x27;. Insert them (seven rows inserted).- Still more rows to insert. Grab another chunk, twice as big as before - eight values, &#x27;20&#x27;, &#x27;21&#x27;, &#x27;22&#x27;, ..., &#x27;27&#x27;. Insert the &#x27;20&#x27; (eight rows inserted).- No more rows to insert. Discard the left over &#x27;21&#x27;, &#x27;22&#x27;, etc.æ‰€ä»¥è¿™å°±æ˜¯ gap äº§ç”Ÿçš„åŸå›  ç”±â€œmixed-mode insertsâ€åˆ†é…çš„è‡ªåŠ¨é€’å¢å€¼è€ƒè™‘ä¸€ä¸‹åœºæ™¯,åœ¨â€œmixed-mode insertâ€ä¸­,å…¶ä¸­ä¸€ä¸ªâ€œsimple insertâ€è¯­å¥æŒ‡å®šäº†ä¸€äº›ï¼ˆä½†ä¸æ˜¯å…¨éƒ¨ï¼‰è¡Œçš„AUTO-INCREMENTå€¼ã€‚ è¿™æ ·çš„è¯­å¥åœ¨é”æ¨¡å¼0,1å’Œ2ä¸­è¡¨ç°ä¸åŒã€‚ä¾‹å¦‚ï¼Œå‡è®¾c1æ˜¯è¡¨t1çš„AUTO_INCREMENTåˆ—ï¼Œå¹¶ä¸”æœ€è¿‘è‡ªåŠ¨ç”Ÿæˆçš„åºåˆ—å·æ˜¯100ã€‚12345mysql&gt; CREATE TABLE t1 ( -&gt; c1 INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, -&gt; c2 CHAR(1) -&gt; ) ENGINE = INNODB; Now, consider the following â€œmixed-mode insertâ€ statement:1mysql&gt; INSERT INTO t1 (c1,c2) VALUES (1,&#x27;a&#x27;), (NULL,&#x27;b&#x27;), (5,&#x27;c&#x27;), (NULL,&#x27;d&#x27;); å½“innodb_autoinc_lock_mode=0æ—¶:123456789mysql&gt; SELECT c1, c2 FROM t1 ORDER BY c2;+-----+------+| c1 | c2 |+-----+------+| 1 | a || 101 | b || 5 | c || 102 | d |+-----+------+ ä¸‹ä¸€ä¸ªå¯ç”¨çš„auto-incrementå€¼103.å› ä¸ºinnodb_autoinc_lock_mode=0æ—¶,auto-incrementå€¼ä¸€æ¬¡åªåˆ†é…ä¸€ä¸ª,è€Œä¸æ˜¯åœ¨å¼€å§‹æ—¶å…¨éƒ¨åˆ†é….ä¸è®ºæ˜¯å¦æœ‰å¹¶å‘çš„å…¶ä»–ç±»INSERTè¯­å¥åŒæ—¶æ‰§è¡Œ,éƒ½ä¼šæ˜¯è¿™æ ·çš„ç»“æœ å½“innodb_autoinc_lock_mode=1æ—¶:123456789mysql&gt; SELECT c1, c2 FROM t1 ORDER BY c2;+-----+------+| c1 | c2 |+-----+------+| 1 | a || 101 | b || 5 | c || 102 | d |+-----+------+ä¸åŒäºinnodb_autoinc_lock_mode=0æ—¶çš„æƒ…å†µ,æ­¤æ—¶ä¸‹ä¸€ä¸ªå¯ç”¨çš„auto-incrementå€¼105,å› ä¸ºauto-incrementå€¼åœ¨è¯­å¥ä¸€å¼€å§‹å°±åˆ†é…äº†,åˆ†é…äº†å››ä¸ª,ä½†æ˜¯åªç”¨äº†ä¿©.ä¸è®ºæ˜¯å¦æœ‰å¹¶å‘çš„å…¶ä»–ç±»INSERTè¯­å¥åŒæ—¶æ‰§è¡Œ,éƒ½ä¼šæ˜¯è¿™æ ·çš„ç»“æœ å½“innodb_autoinc_lock_mode=2æ—¶:123456789mysql&gt; SELECT c1, c2 FROM t1 ORDER BY c2;+-----+------+| c1 | c2 |+-----+------+| 1 | a || x | b || 5 | c || y | d |+-----+------+xå’Œyçš„å€¼æ˜¯å”¯ä¸€çš„ï¼Œå¹¶å¤§äºä»»ä½•å…ˆå‰ç”Ÿæˆçš„è¡Œã€‚ ç„¶è€Œï¼Œxå’Œyçš„å…·ä½“å€¼å–å†³äºé€šè¿‡å¹¶å‘æ‰§è¡Œè¯­å¥ç”Ÿæˆçš„è‡ªåŠ¨å¢é‡å€¼çš„æ•°é‡ã€‚ æœ€åè€ƒè™‘ä¸‹é¢çš„æƒ…å†µ,å½“æœ€è¿‘çš„ AUTO-INCREMENT å€¼ä¸º4æ—¶,æ‰§è¡Œä¸‹é¢çš„è¯­å¥:1mysql&gt; INSERT INTO t1 (c1,c2) VALUES (1,&#x27;a&#x27;), (NULL,&#x27;b&#x27;), (5,&#x27;c&#x27;), (NULL,&#x27;d&#x27;);æ— è®ºinnodb_autoinc_lock_modeå¦‚ä½•è®¾ç½®,éƒ½ä¼šæŠ¥é”™duplicate-key error 23000 (Canâ€™t write; duplicate key in table)å› ä¸º5å·²ç»åˆ†é…ç»™äº†(NULL, â€˜bâ€™),æ‰€ä»¥å¯¼è‡´æ’å…¥(5, â€˜Câ€™)æ—¶æŠ¥é”™ åœ¨INSERTè¯­å¥åºåˆ—çš„ä¸­é—´ä¿®æ”¹AUTO_INCREMENTåˆ—å€¼åœ¨æ‰€æœ‰é”å®šæ¨¡å¼ï¼ˆ0,1å’Œ2ï¼‰ä¸­ï¼Œåœ¨INSERTè¯­å¥åºåˆ—ä¸­é—´ä¿®æ”¹AUTO_INCREMENTåˆ—å€¼å¯èƒ½ä¼šå¯¼è‡´duplicate keyé”™è¯¯ã€‚ 1234567891011121314151617181920212223242526272829mysql&gt; CREATE TABLE t1 ( -&gt; c1 INT NOT NULL AUTO_INCREMENT, -&gt; PRIMARY KEY (c1) -&gt; ) ENGINE = InnoDB;mysql&gt; INSERT INTO t1 VALUES(0), (0), (3); -- 0 0åˆ†é…ä¸¤ä¸ªå€¼1,2. æ‰‹åŠ¨æŒ‡å®š3,åˆ™æ­¤æ—¶AUTO_INCREMENTä¸º3,ä¸‹ä¸€ä¸ªå€¼ä¸º4mysql&gt; SELECT c1 FROM t1;+----+| c1 |+----+| 1 || 2 || 3 |+----+mysql&gt; UPDATE t1 SET c1 = 4 WHERE c1 = 1;mysql&gt; SELECT c1 FROM t1;+----+| c1 |+----+| 2 || 3 || 4 |+----+mysql&gt; INSERT INTO t1 VALUES(0); --ç”±äºåˆ†é…å€¼ä¸º4,æ‰€ä»¥æŠ¥é”™duplicate keyERROR 1062 (23000): Duplicate entry &#x27;4&#x27; for key &#x27;PRIMARY&#x27; InnoDB AUTO_INCREMENTè®¡æ•°å™¨åˆå§‹åŒ–æœ¬ç« èŠ‚è®¨è®º InnoDBå¦‚ä½•åˆå§‹åŒ–AUTO_INCREMENTè®¡æ•°å™¨å¦‚æœä½ ä¸ºä¸€ä¸ªInnodbè¡¨åˆ›å»ºäº†ä¸€ä¸ªAUTO_INCREMENTåˆ—,åˆ™InnoDBæ•°æ®å­—å…¸ä¸­çš„è¡¨å¥æŸ„åŒ…å«ä¸€ä¸ªç§°ä¸ºè‡ªåŠ¨é€’å¢è®¡æ•°å™¨çš„ç‰¹æ®Šè®¡æ•°å™¨ï¼Œç”¨äºä¸ºåˆ—åˆ†é…æ–°å€¼ã€‚ æ­¤è®¡æ•°å™¨ä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œè€Œä¸å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚ è¦åœ¨æœåŠ¡å™¨é‡æ–°å¯åŠ¨ååˆå§‹åŒ–è‡ªåŠ¨é€’å¢è®¡æ•°å™¨ï¼ŒInnoDBå°†åœ¨é¦–æ¬¡æ’å…¥è¡Œåˆ°åŒ…å«AUTO_INCREMENTåˆ—çš„è¡¨æ—¶æ‰§è¡Œä»¥ä¸‹è¯­å¥çš„ç­‰æ•ˆè¯­å¥ã€‚1SELECT MAX(ai_col) FROM table_name FOR UPDATE;InnoDBå¢åŠ è¯­å¥æ£€ç´¢çš„å€¼ï¼Œå¹¶å°†å…¶åˆ†é…ç»™è¡¨å’Œè¡¨çš„è‡ªåŠ¨é€’å¢è®¡æ•°å™¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå€¼å¢åŠ 1.æ­¤é»˜è®¤å€¼å¯ä»¥ç”±auto_increment_incrementé…ç½®è®¾ç½®è¦†ç›–ã€‚ å¦‚æœè¡¨ä¸ºç©ºï¼ŒInnoDBä½¿ç”¨å€¼1.æ­¤é»˜è®¤å€¼å¯ä»¥ç”±auto_increment_offseté…ç½®è®¾ç½®è¦†ç›–ã€‚ å¦‚æœåœ¨è‡ªåŠ¨é€’å¢è®¡æ•°å™¨åˆå§‹åŒ–å‰ä½¿ç”¨SHOW TABLE STATUSè¯­å¥æŸ¥çœ‹è¡¨, InnoDBå°†åˆå§‹åŒ–è®¡æ•°å™¨å€¼,ä½†ä¸ä¼šé€’å¢è¯¥å€¼.è¿™ä¸ªå€¼ä¼šå‚¨å­˜èµ·æ¥ä»¥å¤‡ä¹‹åçš„æ’å…¥è¯­å¥ä½¿ç”¨.è¿™ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨äº†ä¸€ä¸ªæ™®é€šçš„æ’å®ƒé”æ¥è¯»å–è¡¨ä¸­è‡ªå¢åˆ—çš„æœ€å¤§å€¼. InnoDBéµå¾ªç›¸åŒçš„è¿‡ç¨‹æ¥åˆå§‹åŒ–æ–°åˆ›å»ºçš„è¡¨çš„è‡ªåŠ¨é€’å¢è®¡æ•°å™¨ã€‚ åœ¨è‡ªåŠ¨é€’å¢è®¡æ•°å™¨åˆå§‹åŒ–ä¹‹åï¼Œå¦‚æœæ‚¨æœªæ˜ç¡®æŒ‡å®šAUTO_INCREMENTåˆ—çš„å€¼ï¼ŒInnoDBä¼šé€’å¢è®¡æ•°å™¨å¹¶å°†æ–°å€¼åˆ†é…ç»™è¯¥åˆ—ã€‚å¦‚æœæ’å…¥æ˜¾å¼æŒ‡å®šåˆ—å€¼çš„è¡Œï¼Œå¹¶ä¸”è¯¥å€¼å¤§äºå½“å‰è®¡æ•°å™¨å€¼ï¼Œåˆ™å°†è®¡æ•°å™¨è®¾ç½®ä¸ºæŒ‡å®šçš„åˆ—å€¼ã€‚ åªè¦æœåŠ¡å™¨è¿è¡Œï¼ŒInnoDBå°±ä½¿ç”¨å†…å­˜ä¸­è‡ªåŠ¨é€’å¢è®¡æ•°å™¨ã€‚å½“æœåŠ¡å™¨åœæ­¢å¹¶é‡æ–°å¯åŠ¨æ—¶ï¼ŒInnoDBä¼šé‡æ–°åˆå§‹åŒ–æ¯ä¸ªè¡¨çš„è®¡æ•°å™¨ï¼Œä»¥ä¾¿å¯¹è¡¨è¿›è¡Œç¬¬ä¸€æ¬¡INSERTï¼Œå¦‚å‰æ‰€è¿°ã€‚ æœåŠ¡å™¨é‡æ–°å¯åŠ¨è¿˜ä¼šå–æ¶ˆCREATE TABLEå’ŒALTER TABLEè¯­å¥ä¸­çš„AUTO_INCREMENT = Nè¡¨é€‰é¡¹çš„æ•ˆæœ","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"Innodbäº‹åŠ¡éš”ç¦»çº§åˆ«","slug":"Innodbäº‹åŠ¡éš”ç¦»çº§åˆ«","date":"2016-12-13T14:00:00.000Z","updated":"2017-08-17T07:37:52.000Z","comments":true,"path":"2016/12/13/Innodbäº‹åŠ¡éš”ç¦»çº§åˆ«/","link":"","permalink":"http://fuxkdb.com/2016/12/13/Innodb%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/","excerpt":"Innodbäº‹åŠ¡éš”ç¦»çº§åˆ«REPEATABLE READ This is the default isolation level for InnoDB. Consistent reads within the same transaction read the snapshot established by the first read. This means that if you issue several plain (nonlocking) SELECT statements within the same transaction, these SELECT statements are consistent also with respect to each other. è¿™æ˜¯ InnoDB é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«,åŒä¸€äº‹ç‰©é€šè¿‡ç¬¬ä¸€æ¬¡åˆ›å»ºçš„å¿«ç…§æ¥æ„é€ ä¸€è‡´æ€§è¯».è¿™æ„å‘³ç€å¦‚æœä½ åœ¨åŒä¸€ä¼šè¯æ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢(éé”å®šè¯»),é‚£ä¹ˆæ¯æ¬¡è·å–çš„ç»“æœéƒ½æ˜¯å½¼æ­¤ç›¸ç­‰çš„ For locking reads (SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE, and DELETE statements, locking depends on whether the statement uses a unique index with a unique search condition, or a range-type search condition. å¯¹äºé”å®šè¯»,(SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE, å’Œ DELETEè¯­å¥,æ˜¯å¦é”å®šå–å†³äºæ­¤æ¬¡æŸ¥è¯¢(UPDATE DELETE ä¹Ÿæ˜¯ä¸€ç§æŸ¥è¯¢)æ˜¯å¦é€šè¿‡å”¯ä¸€æ¡ä»¶æˆ–èŒƒå›´æ¡ä»¶æŸ¥è¯¢ä½¿ç”¨å”¯ä¸€ç´¢å¼• For a unique index with a unique search condition, InnoDB locks only the index record found, not the gap before it. For a unique index with a unique search condition,InnoDBåªé”ç´¢å¼•è®°å½•,ä¸é” gap For other search conditions, InnoDB locks the index range scanned, using gap locks or next-key locks to block insertions by other sessions into the gaps covered by the range READ COMMITTED Each consistent read, even within the same transaction, sets and reads its own fresh snapshot. For information about consistent reads read viewåœ¨ innodb å¦‚ä½•é¿å…å¹»è¯»ä¸­å·²ç»ä»‹ç»è¿‡ For locking reads (SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE statements, and DELETE statements, InnoDB locks only index records, not the gaps before them, and thus permits the free insertion of new records next to locked records. Gap locking is only used for foreign-key constraint checking and duplicate-key checking. locking reads(SELECT with FOR UPDATE or LOCK IN SHARE MODE),UPDATE è¯­å¥,DELETEè¯­å¥,InnoDB éƒ½åªä¼šé”index records(ä¹Ÿå°±æ˜¯ record lock),ä¸ä¼šäº§ç”Ÿ gap lock,å› æ­¤å…è®¸åœ¨ gap ä¸­æ’å…¥æ–°çš„ records.Gap lockingåªåœ¨å¤–é”®çº¦æŸæ£€æŸ¥å’Œé‡å¤å€¼æ£€æŸ¥æ—¶äº§ç”Ÿ Because gap locking is disabled, phantom problems may occur, as other sessions can insert new rows into the gaps å› ä¸ºgap lockingè¢« disabled,å¹»è¯»é—®é¢˜å¯èƒ½ä¼šäº§ç”Ÿ,å…¶ä»–ä¼šè¯å¯ä»¥åœ¨ gap ä¸­æ’å…¥æ–°çš„è®°å½•","text":"Innodbäº‹åŠ¡éš”ç¦»çº§åˆ«REPEATABLE READ This is the default isolation level for InnoDB. Consistent reads within the same transaction read the snapshot established by the first read. This means that if you issue several plain (nonlocking) SELECT statements within the same transaction, these SELECT statements are consistent also with respect to each other. è¿™æ˜¯ InnoDB é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«,åŒä¸€äº‹ç‰©é€šè¿‡ç¬¬ä¸€æ¬¡åˆ›å»ºçš„å¿«ç…§æ¥æ„é€ ä¸€è‡´æ€§è¯».è¿™æ„å‘³ç€å¦‚æœä½ åœ¨åŒä¸€ä¼šè¯æ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢(éé”å®šè¯»),é‚£ä¹ˆæ¯æ¬¡è·å–çš„ç»“æœéƒ½æ˜¯å½¼æ­¤ç›¸ç­‰çš„ For locking reads (SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE, and DELETE statements, locking depends on whether the statement uses a unique index with a unique search condition, or a range-type search condition. å¯¹äºé”å®šè¯»,(SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE, å’Œ DELETEè¯­å¥,æ˜¯å¦é”å®šå–å†³äºæ­¤æ¬¡æŸ¥è¯¢(UPDATE DELETE ä¹Ÿæ˜¯ä¸€ç§æŸ¥è¯¢)æ˜¯å¦é€šè¿‡å”¯ä¸€æ¡ä»¶æˆ–èŒƒå›´æ¡ä»¶æŸ¥è¯¢ä½¿ç”¨å”¯ä¸€ç´¢å¼• For a unique index with a unique search condition, InnoDB locks only the index record found, not the gap before it. For a unique index with a unique search condition,InnoDBåªé”ç´¢å¼•è®°å½•,ä¸é” gap For other search conditions, InnoDB locks the index range scanned, using gap locks or next-key locks to block insertions by other sessions into the gaps covered by the range READ COMMITTED Each consistent read, even within the same transaction, sets and reads its own fresh snapshot. For information about consistent reads read viewåœ¨ innodb å¦‚ä½•é¿å…å¹»è¯»ä¸­å·²ç»ä»‹ç»è¿‡ For locking reads (SELECT with FOR UPDATE or LOCK IN SHARE MODE), UPDATE statements, and DELETE statements, InnoDB locks only index records, not the gaps before them, and thus permits the free insertion of new records next to locked records. Gap locking is only used for foreign-key constraint checking and duplicate-key checking. locking reads(SELECT with FOR UPDATE or LOCK IN SHARE MODE),UPDATE è¯­å¥,DELETEè¯­å¥,InnoDB éƒ½åªä¼šé”index records(ä¹Ÿå°±æ˜¯ record lock),ä¸ä¼šäº§ç”Ÿ gap lock,å› æ­¤å…è®¸åœ¨ gap ä¸­æ’å…¥æ–°çš„ records.Gap lockingåªåœ¨å¤–é”®çº¦æŸæ£€æŸ¥å’Œé‡å¤å€¼æ£€æŸ¥æ—¶äº§ç”Ÿ Because gap locking is disabled, phantom problems may occur, as other sessions can insert new rows into the gaps å› ä¸ºgap lockingè¢« disabled,å¹»è¯»é—®é¢˜å¯èƒ½ä¼šäº§ç”Ÿ,å…¶ä»–ä¼šè¯å¯ä»¥åœ¨ gap ä¸­æ’å…¥æ–°çš„è®°å½• If you use READ COMMITTED, you must use row-based binary logging. å¦‚æœä½¿ç”¨READ COMMITTEDéš”ç¦»çº§åˆ«,å¿…é¡»è®¾ç½®binlog_formatä¸ºrowä¸¾ä¸ªä¾‹å­,å‡è®¾ä¸¤å¼ è¡¨ T1å’Œ T212345678910111213141516171819202122CREATE TABLE t1 ( id int(11) NOT NULL) ENGINE=InnoDBCREATE TABLE t2 ( id int(11) NOT NULL) ENGINE=InnoDBselect * from t1;+----+| id |+----+| 1 || 2 |+----+ select * from t2;+----+| id |+----+| 2 |+----+ å‡è®¾äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºread commited,å‡è®¾å‘ç”Ÿå¦‚ä¸‹é¡ºåºçš„äº‹åŠ¡begin;//äº‹åŠ¡1insert into t2 select max(id) from t1;//äº‹åŠ¡1ï¼Œt2å¢åŠ äº†ä¸€ä¸ª2begin;//äº‹åŠ¡2insert into t1(id) values(10);//äº‹åŠ¡2ï¼Œt1å¢åŠ äº†ä¸€ä¸ª10commit;//äº‹åŠ¡2commit;//äº‹åŠ¡1æ­¤æ—¶12345678910111213141516select * from t1;+----+| id |+----+| 1 || 2 || 10 |+----+ select * from t2;+----+| id |+----+| 2 || 2 |+----+ å‡å¦‚binlogæ¨¡å¼æ˜¯statementæ¨¡å¼ï¼Œå› ä¸ºäº‹åŠ¡2å…ˆæäº¤ï¼Œä¸”binlogæ˜¯ä¸²è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨binlogçœ‹æ¥ï¼Œæ•´ä½“äº‹åŠ¡ä¸ºbegin;//äº‹åŠ¡2insert into t1(id) values(10);//äº‹åŠ¡2ï¼Œt1å¢åŠ äº†ä¸€ä¸ª10commit;//äº‹åŠ¡2begin;//äº‹åŠ¡1insert into t2 select from max(id) from t1;//äº‹åŠ¡1ï¼Œt2å¢åŠ äº†ä¸€ä¸ª10commit;//äº‹åŠ¡1 æ­¤æ—¶12345678910111213141516select * from t1;+----+| id |+----+| 1 || 2 || 10 |+----+ select * from t2;+----+| id |+----+| 2 || 10 |+----+è¿™å°±é€ æˆäº†ä¸»ä»ä¸ä¸€è‡´,å› æ­¤read commitedäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹è¦ä½¿ç”¨ RBR æ¨¡å¼ ä½¿ç”¨READ COMMITTEDéš”ç¦»çº§åˆ«äº§ç”Ÿçš„é¢å¤–å½±å“: For UPDATE or DELETE statements, InnoDB holds locks only for rows that it updates or deletes. Record locks for nonmatching rows are released after MySQL has evaluated the WHERE condition. This greatly reduces the probability of deadlocks, but they can still happen. å¯¹äº UPDATE å’Œ DELETE è¯­å¥,InnoDBåªå¯¹æ›´æ–°å’Œåˆ é™¤æ¶‰åŠåˆ°çš„è¡ŒæŒæœ‰é”,è€Œå¯¹äºåœ¨ where æ¡ä»¶è¿‡æ»¤åä¸åŒ¹é…çš„è¡Œæºä¼šé‡Šæ”¾é”(é‡Šæ”¾Record locks).è¿™æ˜¾è‘—çš„å‡å°‘äº†å‘ç”Ÿæ­»é”çš„å¯èƒ½æ€§,ä½†å¹¶ä¸æ˜¯è¯´ä¸ä¼šå†å‡ºç°æ­»é”. For UPDATE statements, if a row is already locked, InnoDB performs a â€œsemi-consistentâ€ read, returning the latest committed version to MySQL so that MySQL can determine whether the row matches the WHERE condition of the UPDATE. If the row matches (must be updated), MySQL reads the row again and this time InnoDB either locks it or waits for a lock on it. å¯¹äº UPDATE è¯­å¥,å¦‚æœä¸€è¡Œè®°å½•å·²ç»è¢«é”å®š, InnoDBä¼šæ‰§è¡Œä¸€ä¸ªâ€semi-consistentâ€è¯»MySQL+InnoDB semi-consitent readåŸç†åŠå®ç°åˆ†æ,è·å–æœ€åä¸€æ¬¡æäº¤çš„æ•°æ®ç‰ˆæœ¬,MySQLä»¥è¿™ä¸€ç‰ˆæœ¬çš„æ•°æ®è¿‡æ»¤where æ¡ä»¶åˆ¤æ–­æ˜¯å¦åŒ¹é…UPDATEè¯­å¥,å¦‚æœåŒ¹é…,é‚£ä¹ˆè¿™äº›è¡Œå°†è¢«æ›´æ–°, MySQLå†æ¬¡è¯»å–è¡Œæºå¹¶å¯¹è¿™äº›åŒ¹é…çš„è¡ŒåŠ é”æˆ–è€…ç­‰å¾…åˆ«äººé‡Šæ”¾é”ä»¥åŠ é” è€ƒè™‘ä¸‹é¢çš„ä¾‹å­:åˆ›å»ºè¡¨1234CREATE TABLE t (a INT NOT NULL, b INT) ENGINE = InnoDB;INSERT INTO t VALUES (1,2),(2,3),(3,2),(4,3),(5,2);COMMIT; In this case, table has no indexes, so searches and index scans use the hidden clustered index for record lockingåœ¨è¿™ä¸ªä¾‹å­ä¸­,è¡¨ t æ²¡æœ‰ç´¢å¼•,æ‰€ä»¥æŸ¥è¯¢å’Œç´¢å¼•æ‰«æä½¿ç”¨éšè—çš„èšç°‡ç´¢å¼•æ¥è¿›è¡ŒåŠ é” SESSION_A12SET autocommit = 0;UPDATE t SET b = 5 WHERE b = 3;SESSION_B12SET autocommit = 0;UPDATE t SET b = 4 WHERE b = 2; As InnoDB executes each UPDATE, it first acquires an exclusive lock for each row, and then determines whether to modify it. If InnoDB does not modify the row, it releases the lock. Otherwise, InnoDB retains the lock until the end of the transaction. This affects transaction processing as follows. InnoDB æ‰§è¡Œæ¯æ¬¡UPDATEæ“ä½œ,éƒ½ä¼šé¦–å…ˆå¯¹æ¯ä¸€è¡Œè·å–æ’å®ƒé”,ç„¶åå†å†³å®šæ˜¯å¦ä¿®æ”¹.å¦‚æœInnoDBä¸ä¿®æ”¹è¿™ä¸€è¡Œ,å°±ä¼šé‡Šæ”¾é”,å¦åˆ™InnoDBä¼šæŒæœ‰é”ç›´åˆ°äº‹ç‰©ç»“æŸ å½“æ—¶ä½¿ç”¨é»˜è®¤çš„REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«,SESSION_Açš„æ›´ç»†è·å– x-locks(æ’å®ƒé”)ä¸”ä¸ä¼šé‡Šæ”¾é”:12345x-lock(1,2); retain x-lockx-lock(2,3); update(2,3) to (2,5); retain x-lockx-lock(3,2); retain x-lockx-lock(4,3); update(4,3) to (4,5); retain x-lockx-lock(5,2); retain x-lockSESSION_Bçš„æ›´æ–°æ­¤æ—¶å°±ä¼šè¢«é˜»å¡(å› ä¸ºSESSION_Aåœ¨æ¯ä¸€è¡Œéƒ½åŠ äº†æ’å®ƒé”),ç›´åˆ°SESSION_Aæäº¤æˆ–å›æ»š1x-lock(1,2); block and wait for first UPDATE to commit or roll back å¦‚æœäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºREAD COMMITTED,SESSION_Aè·å–x-locks(æ’å®ƒé”)åä¼šé‡Šæ”¾é‚£äº›ä¸è¢«ä¿®æ”¹çš„è¡Œçš„é”:12345x-lock(1,2); unlock(1,2)x-lock(2,3); update(2,3) to (2,5); retain x-lockx-lock(3,2); unlock(3,2)x-lock(4,3); update(4,3) to (4,5); retain x-lockx-lock(5,2); unlock(5,2)SESSION_Bæ‰§è¡Œæ›´æ–°è¯­å¥,æ­¤æ—¶InnoDBåšäº†ä¸€ä¸ªâ€œsemi-consistentâ€ read,è·å–å¹¶è¿”å›äº†æœ€åä¸€æ¬¡æäº¤çš„æ•°æ®ç‰ˆæœ¬ç»™ MySQL,so MySQL å¯ä»¥åˆ¤æ–­ where æ¡ä»¶è¿‡æ»¤åçš„æ•°æ®æ˜¯å¦éœ€è¦è¢«æ›´æ–°,æ‰¾åˆ°åŒ¹é…çš„è¡Œå,MySQLå†æ¬¡è¯»å–è¡Œæºå¹¶å¯¹è¿™äº›åŒ¹é…çš„è¡ŒåŠ é”12345x-lock(1,2); update(1,2) to (1,4); retain x-lockx-lock(2,3); unlock(2,3)x-lock(3,2); update(3,2) to (3,4); retain x-lockx-lock(4,3); unlock(4,3)x-lock(5,2); update(5,2) to (5,4); retain x-lock ä½¿ç”¨READ COMMITTEDäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸å¯ç”¨åºŸå¼ƒçš„å‚æ•°innodb_locks_unsafe_for_binlogæ˜¯ä¸€æ ·çš„,é™¤äº†ä¸€ä¸‹å‡ ç‚¹: innodb_locks_unsafe_for_binlogæ˜¯ä¸€ä¸ª GLOBAL å‚æ•°,ä¼šå½±å“æ‰€æœ‰ä¼šè¯,ç„¶åäº‹åŠ¡éš”ç¦»çº§åˆ«æ—¢å¯ä»¥é’ˆå¯¹å…¨å±€ä¹Ÿå¯ä»¥é’ˆå¯¹å•ç‹¬ä¼šè¯è¿›è¡Œè®¾ç½® innodb_locks_unsafe_for_binlogåªå¯ä»¥åœ¨MySQL å¯åŠ¨æ—¶è®¾ç½®,ç„¶åäº‹åŠ¡éš”ç¦»çº§åˆ«çº§åˆ«æ—¢å¯ä»¥åœ¨å¯åŠ¨æ—¶è®¾ç½®ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶è®¾ç½® æ‰€ä»¥è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºREAD COMMITTEDç›¸æ¯”ä¿®æ”¹å‚æ•°innodb_locks_unsafe_for_binlogå…·æœ‰æ›´å¥½çš„çµæ´»æ€§ READ UNCOMMITTED SELECT statements are performed in a nonlocking fashion, but a possible earlier version of a row might be used. Thus, using this isolation level, such reads are not consistent. This is also called a dirty read. Otherwise, this isolation level works like READ COMMITTED. ###SERIALIZABLE This level is like REPEATABLE READ, but InnoDB implicitly converts all plain SELECT statements to SELECT â€¦ LOCK IN SHARE MODE if autocommit is disabled. If autocommit is enabled, the SELECT is its own transaction. It therefore is known to be read only and can be serialized if performed as a consistent (nonlocking) read and need not block for other transactions. (To force a plain SELECT to block if other transactions have modified the selected rows, disable autocommit.) è¿™ä¸ªçº§åˆ«æœ‰ç‚¹åƒREPEATABLE READ,ä½†æ˜¯å½“autocommitç¦ç”¨æ—¶æ—¶InnoDBæ˜ç¡®çš„è½¬æ¢æ‰€æœ‰ SELECT è¯­å¥ä¸ºSELECT ... LOCK IN SHARE MODE.","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"MySQL(InnoDB)å¦‚ä½•é¿å…å¹»è¯»","slug":"MySQL(InnoDB)å¦‚ä½•é¿å…å¹»è¯»","date":"2016-12-12T14:00:00.000Z","updated":"2017-08-17T08:24:59.000Z","comments":true,"path":"2016/12/12/MySQL(InnoDB)å¦‚ä½•é¿å…å¹»è¯»/","link":"","permalink":"http://fuxkdb.com/2016/12/12/MySQL(InnoDB)%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%B9%BB%E8%AF%BB/","excerpt":"å¹»è¯»Phantom Rows The so-called phantom problem occurs within a transaction when the same query produces different sets of rows at different times. For example, if a SELECT is executed twice, but returns a row the second time that was not returned the first time, the row is a â€œphantomâ€ row. å¹»è¯»é—®é¢˜æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡ä¸åŒæ—¶é—´çš„ç›¸åŒæŸ¥è¯¢è¿”å›äº†ä¸åŒçš„çš„ç»“æœé›†ã€‚ä¾‹å¦‚:ä¸€ä¸ª select è¯­å¥æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è¿”å›äº†ç¬¬ä¸€æ¬¡æ²¡æœ‰è¿”å›çš„è¡Œ,é‚£ä¹ˆè¿™äº›è¡Œå°±æ˜¯â€œphantomâ€ row. read view(æˆ–è€…è¯´ MVCC)å®ç°äº†ä¸€è‡´æ€§ä¸é”å®šè¯»(Consistent Nonlocking Reads)ï¼Œä»è€Œé¿å…äº†å¹»è¯»å®éªŒ1:å¼€ä¸¤ä¸ªçª—å£è®¾ç½®12345set session tx_isolation=&#x27;REPEATABLE-READ&#x27;;select @@session.autocommit;select @@global.tx_isolation,@@session.tx_isolation;create table read_view(text varchar(50));insert into read_view values(&#x27;init&#x27;); ä¸¤ä¸ªä¼šè¯å¼€å§‹äº‹åŠ¡12345SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec) SESSION_Aæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯ä»¥è®¿é—®ä»»ä½•è¡¨ï¼Œè¿™ä¸ªæŸ¥è¯¢çš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªå½“å‰æ—¶é—´ç‚¹çš„å¿«ç…§START TRANSACTION WITH CONSISTENT SNAPSHOT;ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ 12345678910SESSION_A&gt;select * from dept;+--------+------------+----------+| deptno | dname | loc |+--------+------------+----------+| 10 | ACCOUNTING | NEW YORK || 20 | RESEARCH | DALLAS || 30 | SALES | CHICAGO || 40 | OPERATIONS | BOSTON |+--------+------------+----------+4 rows in set (0.00 sec) SESSION_B æ’å…¥ä¸€æ¡è®°å½•å¹¶æäº¤12345SESSION_B&gt;insert into read_view values(&#x27;after session A select&#x27;);Query OK, 1 row affected (0.01 sec)SESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec) SESSION_A12345678910111213141516171819SESSION_A&gt;select * from read_view;+------+| text |+------+| init |+------+1 row in set (0.00 sec)SESSION_A&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+------------------------+| text |+------------------------+| init || after session A select |+------------------------+2 rows in set (0.00 sec)ç”±äº SESSION_A ç¬¬ä¸€æ¬¡çš„æŸ¥è¯¢å¼€å§‹äº SESSION_B æ’å…¥æ•°æ®å‰ï¼Œé€šè¿‡åˆ›å»ºäº†ä¸€ä¸ªä»¥SELECTæ“ä½œçš„æ—¶é—´ä¸ºåŸºå‡†ç‚¹çš„ read view,é¿å…äº†å¹»è¯»çš„äº§ç”Ÿæ‰€ä»¥åœ¨ SESSION_A çš„äº‹åŠ¡ç»“æŸå‰,æ— æ³•çœ‹åˆ° SESSION_B å¯¹è¡¨ read_view åšå‡ºçš„ä»»ä½•æ›´æ”¹ (insert,delete,update)","text":"å¹»è¯»Phantom Rows The so-called phantom problem occurs within a transaction when the same query produces different sets of rows at different times. For example, if a SELECT is executed twice, but returns a row the second time that was not returned the first time, the row is a â€œphantomâ€ row. å¹»è¯»é—®é¢˜æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡ä¸åŒæ—¶é—´çš„ç›¸åŒæŸ¥è¯¢è¿”å›äº†ä¸åŒçš„çš„ç»“æœé›†ã€‚ä¾‹å¦‚:ä¸€ä¸ª select è¯­å¥æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è¿”å›äº†ç¬¬ä¸€æ¬¡æ²¡æœ‰è¿”å›çš„è¡Œ,é‚£ä¹ˆè¿™äº›è¡Œå°±æ˜¯â€œphantomâ€ row. read view(æˆ–è€…è¯´ MVCC)å®ç°äº†ä¸€è‡´æ€§ä¸é”å®šè¯»(Consistent Nonlocking Reads)ï¼Œä»è€Œé¿å…äº†å¹»è¯»å®éªŒ1:å¼€ä¸¤ä¸ªçª—å£è®¾ç½®12345set session tx_isolation=&#x27;REPEATABLE-READ&#x27;;select @@session.autocommit;select @@global.tx_isolation,@@session.tx_isolation;create table read_view(text varchar(50));insert into read_view values(&#x27;init&#x27;); ä¸¤ä¸ªä¼šè¯å¼€å§‹äº‹åŠ¡12345SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec) SESSION_Aæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯ä»¥è®¿é—®ä»»ä½•è¡¨ï¼Œè¿™ä¸ªæŸ¥è¯¢çš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªå½“å‰æ—¶é—´ç‚¹çš„å¿«ç…§START TRANSACTION WITH CONSISTENT SNAPSHOT;ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ 12345678910SESSION_A&gt;select * from dept;+--------+------------+----------+| deptno | dname | loc |+--------+------------+----------+| 10 | ACCOUNTING | NEW YORK || 20 | RESEARCH | DALLAS || 30 | SALES | CHICAGO || 40 | OPERATIONS | BOSTON |+--------+------------+----------+4 rows in set (0.00 sec) SESSION_B æ’å…¥ä¸€æ¡è®°å½•å¹¶æäº¤12345SESSION_B&gt;insert into read_view values(&#x27;after session A select&#x27;);Query OK, 1 row affected (0.01 sec)SESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec) SESSION_A12345678910111213141516171819SESSION_A&gt;select * from read_view;+------+| text |+------+| init |+------+1 row in set (0.00 sec)SESSION_A&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+------------------------+| text |+------------------------+| init || after session A select |+------------------------+2 rows in set (0.00 sec)ç”±äº SESSION_A ç¬¬ä¸€æ¬¡çš„æŸ¥è¯¢å¼€å§‹äº SESSION_B æ’å…¥æ•°æ®å‰ï¼Œé€šè¿‡åˆ›å»ºäº†ä¸€ä¸ªä»¥SELECTæ“ä½œçš„æ—¶é—´ä¸ºåŸºå‡†ç‚¹çš„ read view,é¿å…äº†å¹»è¯»çš„äº§ç”Ÿæ‰€ä»¥åœ¨ SESSION_A çš„äº‹åŠ¡ç»“æŸå‰,æ— æ³•çœ‹åˆ° SESSION_B å¯¹è¡¨ read_view åšå‡ºçš„ä»»ä½•æ›´æ”¹ (insert,delete,update) å®éªŒ2ä¸¤ä¸ªä¼šè¯å¼€å§‹äº‹åŠ¡12345SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec) SESSION_B åœ¨ SESSION_A åˆ›å»ºread view å‰æ’å…¥æ•°æ®12345SESSION_B&gt;insert into read_view values(&#x27;before Session_A select&#x27;);Query OK, 1 row affected (0.00 sec)SESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec) SESSION_A1234567891011121314151617181920212223SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| init || after session A select || before Session_A select |+-------------------------+3 rows in set (0.00 sec)SESSION_A&gt;commit -&gt; ;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| init || after session A select || before Session_A select |+-------------------------+3 rows in set (0.00 sec)ç”±äº SESSION_A ç¬¬ä¸€æ¬¡æŸ¥è¯¢å¼€å§‹äº SESSION_B å¯¹è¡¨åšå‡ºæ›´æ”¹å¹¶æäº¤å,æ‰€ä»¥è¿™æ¬¡çš„ read view åŒ…å«äº† SESSION_B æ‰€åšå‡ºçš„æ›´æ”¹ åœ¨å®˜æ–¹æ–‡æ¡£ä¸­å†™é“http://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html A consistent read means that InnoDB uses multi-versioning to present to a query a snapshot of the database at a point in time. The query sees the changes made by transactions that committed before that point of time, and no changes made by later or uncommitted transactions. The exception to this rule is that the query sees the changes made by earlier statements within the same transaction. This exception causes the following anomaly: If you update some rows in a table, a SELECT sees the latest version of the updated rows, but it might also see older versions of any rows. If other sessions simultaneously update the same table, the anomaly means that you might see the table in a state that never existed in the database. ä¸€è‡´æ€§è¯»æ˜¯é€šè¿‡ MVCC ä¸ºæŸ¥è¯¢æä¾›äº†ä¸€ä¸ªåŸºäºæ—¶é—´çš„ç‚¹çš„å¿«ç…§ã€‚è¿™ä¸ªæŸ¥è¯¢åªèƒ½çœ‹åˆ°åœ¨è‡ªå·±ä¹‹å‰æäº¤çš„æ•°æ®ï¼Œè€Œåœ¨æŸ¥è¯¢å¼€å§‹ä¹‹åæäº¤çš„æ•°æ®æ˜¯ä¸å¯ä»¥çœ‹åˆ°çš„ã€‚ä¸€ä¸ªç‰¹ä¾‹æ˜¯,è¿™ä¸ªæŸ¥è¯¢å¯ä»¥çœ‹åˆ°äºè‡ªå·±å¼€å§‹ä¹‹åçš„åŒä¸€ä¸ªäº‹åŠ¡äº§ç”Ÿçš„å˜åŒ–ã€‚è¿™ä¸ªç‰¹ä¾‹ä¼šäº§ç”Ÿä¸€äº›åå¸¸çš„ç°è±¡ If the transaction isolation level is REPEATABLE READ (the default level), all consistent reads within the same transaction read the snapshot established by the first such read in that transaction. You can get a fresher snapshot for your queries by committing the current transaction and after that issuing new queries. åœ¨é»˜è®¤éš”ç¦»çº§åˆ«REPEATABLE READä¸‹ï¼ŒåŒä¸€äº‹åŠ¡çš„æ‰€æœ‰ä¸€è‡´æ€§è¯»åªä¼šè¯»å–ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶åˆ›å»ºçš„å¿«ç…§ å®éªŒ3ä¸¤ä¸ªä¼šè¯å¼€å§‹äº‹åŠ¡1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071SESSION_Aå¼€å§‹äº‹åŠ¡å¹¶åˆ›å»ºå¿«ç…§SESSION_A&gt;START TRANSACTION WITH CONSISTENT SNAPSHOT;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| init || after session A select || before Session_A select |+-------------------------+3 rows in set (0.00 sec)SESSION_B&gt;insert into read_view values(&#x27;anomaly&#x27;),(&#x27;anomaly&#x27;);Query OK, 2 rows affected (0.00 sec)Records: 2 Duplicates: 0 Warnings: 0SESSION_B&gt;update read_view set text=&#x27;INIT&#x27; where text=&#x27;init&#x27;;Query OK, 1 row affected (0.00 sec)Rows matched: 1 Changed: 1 Warnings: 0SESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| init || after session A select || before Session_A select |+-------------------------+3 rows in set (0.00 sec)SESSION_Aæ›´æ–°äº†å®ƒå¹¶æ²¡æœ‰&quot;çœ‹&quot;åˆ°çš„è¡ŒSESSION_A&gt;update read_view set text=&#x27;anomaly!&#x27; where text=&#x27;anomaly&#x27;;Query OK, 2 rows affected (0.00 sec)Rows matched: 2 Changed: 2 Warnings: 0SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| init || after session A select || before Session_A select || anomaly! || anomaly! |+-------------------------+5 rows in set (0.00 sec)SESSION_A&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| INIT || after session A select || before Session_A select || anomaly! || anomaly! |+-------------------------+5 rows in set (0.00 sec)è§‚å¯Ÿå®éªŒæ­¥éª¤å¯ä»¥å‘ç°ï¼Œåœ¨å€’æ•°ç¬¬äºŒæ¬¡æŸ¥è¯¢ä¸­ï¼Œå‡ºç°äº†ä¸€ä¸ªå¹¶ä¸å­˜åœ¨çš„çŠ¶æ€ the anomaly means that you might see the table in a state that never existed in the database è¿™é‡ŒAçš„å‰åä¸¤æ¬¡è¯»ï¼Œå‡ä¸ºå¿«ç…§è¯»ï¼Œè€Œä¸”æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚ä½†æ˜¯Bå…ˆæ’å…¥ç›´æ¥æäº¤ï¼Œæ­¤æ—¶Aå†updateï¼Œupdateå±äºå½“å‰è¯»ï¼Œæ‰€ä»¥å¯ä»¥ä½œç”¨äºæ–°æ’å…¥çš„è¡Œï¼Œå¹¶ä¸”å°†ä¿®æ”¹è¡Œçš„å½“å‰ç‰ˆæœ¬å·è®¾ä¸ºAçš„äº‹åŠ¡å·ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡çš„å¿«ç…§è¯»ï¼Œæ˜¯å¯ä»¥è¯»å–åˆ°çš„ï¼Œå› ä¸ºåŒäº‹åŠ¡å·ã€‚è¿™ç§æƒ…å†µç¬¦åˆMVCCçš„è§„åˆ™ï¼Œå¦‚æœè¦ç§°ä¸ºä¸€ç§å¹»è¯»ä¹Ÿéä¸å¯ï¼Œç®—ä¸ºä¸€ä¸ªç‰¹æ®Šæƒ…å†µæ¥çœ‹å¾…å§ã€‚ With READ COMMITTED isolation level, each consistent read within a transaction sets and reads its own fresh snapshot. åœ¨ read commit éš”ç¦»çº§åˆ«ä¸‹ï¼ŒåŒä¸€äº‹åŠ¡çš„æ¯ä¸ªä¸€è‡´æ€§è¯»sets and reads its own fresh snapshot. å®éªŒ4ä¿®æ”¹äº‹åŠ¡éš”ç¦»çº§åˆ«set session tx_isolation=&#39;READ-COMMITTED&#39;ä¸¤ä¸ªä¼šè¯å¼€å§‹äº‹åŠ¡12345678910111213141516171819202122232425262728293031323334353637SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| INIT || after session A select || before Session_A select || anomaly! || anomaly! |+-------------------------+5 rows in set (0.00 sec)SESSION_B&gt;insert into read_view values(&#x27;hehe&#x27;);Query OK, 1 row affected (0.00 sec)SESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from read_view;+-------------------------+| text |+-------------------------+| INIT || after session A select || before Session_A select || anomaly! || anomaly! || hehe |+-------------------------+6 rows in set (0.00 sec)read commit æ¯æ¬¡è¯»å–éƒ½æ˜¯æ–°çš„å¿«ç…§ InnoDBé€šè¿‡Nextkey lockè§£å†³äº†å½“å‰è¯»æ—¶çš„å¹»è¯»é—®é¢˜Innodbè¡Œé”åˆ†ä¸º:| ç±»å‹ | è¯´æ˜ ||â€”â€”â€”â€”â€”-|â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”|| Record Lock: | åœ¨ç´¢å¼•ä¸Šå¯¹å•è¡Œè®°å½•åŠ é”. || Gap Lock: | é”å®šä¸€ä¸ªèŒƒå›´çš„è®°å½•,ä½†ä¸åŒ…æ‹¬è®°å½•æœ¬èº«.é”åŠ åœ¨æœªä½¿ç”¨çš„ç©ºé—²ç©ºé—´ä¸Š,å¯èƒ½æ˜¯ä¸¤ä¸ªç´¢å¼•è®°å½•ä¹‹é—´ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªç´¢å¼•è®°å½•ä¹‹å‰æˆ–æœ€åä¸€ä¸ªç´¢å¼•ä¹‹åçš„ç©ºé—´. || Next-Key Lock: | è¡Œé”ä¸é—´éš™é”ç»„åˆèµ·æ¥ç”¨å°±å«åšNext-Key Lockã€‚é”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«ã€‚å¯¹äºè¡Œçš„æŸ¥è¯¢ï¼Œéƒ½æ˜¯é‡‡ç”¨è¯¥æ–¹æ³•ï¼Œä¸»è¦ç›®çš„æ˜¯è§£å†³å¹»è¯»çš„é—®é¢˜ã€‚ | å®éªŒ5åˆ›å»ºè¡¨123456(mysql@localhost) [fandb]&gt; create table t5(id int,key(id));Query OK, 0 rows affected (0.02 sec)SESSION_A&gt;insert into t5 values(1),(4),(7),(10);Query OK, 4 rows affected (0.00 sec)Records: 4 Duplicates: 0 Warnings: 0 å¼€å§‹å®éªŒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from t5;+------+| id |+------+| 1 || 4 || 7 || 10 |+------+4 rows in set (0.00 sec)SESSION_A&gt;select * from t5 where id=7 for update;+------+| id |+------+| 7 |+------+1 row in set (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;insert into t5 values(2);Query OK, 1 row affected (0.00 sec)SESSION_B&gt;insert into t5 values(12);Query OK, 1 row affected (0.00 sec)SESSION_B&gt;insert into t5 values(5); --è¢«é˜»å¡^CCtrl-C -- sending &quot;KILL QUERY 93&quot; to server ...Ctrl-C -- query aborted.^[[AERROR 1317 (70100): Query execution was interruptedSESSION_B&gt;insert into t5 values(7); --è¢«é˜»å¡^CCtrl-C -- sending &quot;KILL QUERY 93&quot; to server ...Ctrl-C -- query aborted.ERROR 1317 (70100): Query execution was interruptedSESSION_B&gt;insert into t5 values(9); --è¢«é˜»å¡^CCtrl-C -- sending &quot;KILL QUERY 93&quot; to server ...Ctrl-C -- query aborted.ERROR 1317 (70100): Query execution was interruptedSESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from t5;+------+| id |+------+| 1 || 4 || 7 || 10 |+------+4 rows in set (0.00 sec)SESSION_A&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from t5;+------+| id |+------+| 1 || 2 || 4 || 7 || 10 || 12 |+------+6 rows in set (0.00 sec)å½“ä»¥å½“å‰è¯»æ¨¡å¼select * from t5 where id=7 for update;è·å– id=7çš„æ•°æ®æ—¶,äº§ç”Ÿäº† Next-Key Lock,é”ä½äº†4-10èŒƒå›´å’Œ id=7å•ä¸ªrecordä»è€Œé˜»å¡äº† SESSION_Båœ¨è¿™ä¸ªèŒƒå›´å†…æ’å…¥æ•°æ®ï¼Œè€Œåœ¨é™¤æ­¤ä¹‹å¤–çš„èŒƒå›´å†…æ˜¯å¯ä»¥æ’å…¥æ•°æ®çš„ã€‚åœ¨å€’æ•°ç¬¬äºŒä¸ªæŸ¥è¯¢ä¸­,å› ä¸º read view çš„å­˜åœ¨ï¼Œé¿å…äº†æˆ‘ä»¬çœ‹åˆ° 2å’Œ12ä¸¤æ¡æ•°æ®ï¼Œé¿å…äº†å¹»è¯»åŒæ—¶å› ä¸º Next-Key Lock çš„å­˜åœ¨,é˜»å¡äº†å…¶ä»–å›è¯æ’å…¥æ•°æ®ï¼Œå› æ­¤å½“å‰æ¨¡å¼è¯»ä¸ä¼šäº§ç”Ÿå¹»è¯»(select for update æ˜¯ä»¥å½“å‰è¯»æ¨¡å¼è·å–æ•°æ®) å°½é‡ä½¿ç”¨å”¯ä¸€ç´¢å¼•,å› ä¸ºå”¯ä¸€ç´¢å¼•ä¼šæŠŠNext-Key Locké™çº§ä¸ºRecord Lockå®éªŒ6åˆ›å»ºè¡¨(mysql@localhost) [fandb]&gt; create table t6(id int primary key);Query OK, 0 rows affected (0.02 sec) SESSION_A&gt;insert into t6 values(1),(4),(7),(10);Query OK, 4 rows affected (0.00 sec)Records: 4 Duplicates: 0 Warnings: 0 å¼€å§‹å®éªŒ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061SESSION_A&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from t6;+----+| id |+----+| 1 || 4 || 7 || 10 |+----+4 rows in set (0.00 sec)SESSION_A&gt;select * from t6 where id=7 for update;+----+| id |+----+| 7 |+----+1 row in set (0.00 sec)SESSION_B&gt;begin;Query OK, 0 rows affected (0.00 sec)SESSION_B&gt;insert into t6 values(5); --æ’å…¥æˆåŠŸæ²¡æœ‰é˜»å¡Query OK, 1 row affected (0.00 sec)SESSION_B&gt;insert into t6 values(8); --æ’å…¥æˆåŠŸæ²¡æœ‰é˜»å¡Query OK, 1 row affected (0.00 sec)SESSION_B&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from t6;+----+| id |+----+| 1 || 4 || 7 || 10 |+----+4 rows in set (0.00 sec)SESSION_A&gt;commit;Query OK, 0 rows affected (0.00 sec)SESSION_A&gt;select * from t6;+----+| id |+----+| 1 || 4 || 5 || 7 || 8 || 10 |+----+6 rows in set (0.00 sec)å½“ id åˆ—æœ‰å”¯ä¸€ç´¢å¼•,Next-Key Lock ä¼šé™çº§ä¸º Records Lock","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"Auto_incrementè¯¦è§£","slug":"Auto_incrementè¯¦è§£","date":"2016-07-31T14:00:00.000Z","updated":"2017-08-05T16:00:59.000Z","comments":true,"path":"2016/07/31/Auto_incrementè¯¦è§£/","link":"","permalink":"http://fuxkdb.com/2016/07/31/Auto_increment%E8%AF%A6%E8%A7%A3/","excerpt":"Auto_incrementMysql AUTO_INCREMENT 1.Innodbè¡¨çš„è‡ªåŠ¨å¢é•¿åˆ—å¯ä»¥æ‰‹å·¥æ’å…¥ï¼Œä½†æ˜¯æ’å…¥çš„å€¼å¦‚æœæ˜¯ç©ºæˆ–è€…0ï¼Œåˆ™å®é™…æ’å…¥çš„å°†æ˜¯è‡ªåŠ¨å¢é•¿åçš„å€¼1234567891011121314151617181920212223242526mysql&gt; create table t1(id int not null auto_increment primary key,name varchar(10));Query OK, 0 rows affected (0.06 sec)mysql&gt; desc t1;+-------+-------------+------+-----+---------+----------------+| Field | Type | Null | Key | Default | Extra |+-------+-------------+------+-----+---------+----------------+| id | int(11) | NO | PRI | NULL | auto_increment || name | varchar(10) | YES | | NULL | |+-------+-------------+------+-----+---------+----------------+2 rows in set (0.01 sec)mysql&gt; insert into t1 values(0,&#x27;fanboshi&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; insert into t1 values(null,&#x27;duyalan&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t1;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 2 | duyalan |+----+----------+2 rows in set (0.00 sec) 2.å¯ä»¥é€šè¿‡alter table t1 auto_incremenrt=n è¯­å¥å¼ºåˆ¶è®¾ç½®è‡ªåŠ¨å¢é•¿åˆ—çš„åˆå§‹å€¼ï¼Œé»˜è®¤ä»1å¼€å§‹ï¼Œä½†æ˜¯è¯¥å¼ºåˆ¶çš„é»˜è®¤å€¼æ˜¯ä¿ç•™åœ¨å†…å­˜ä¸­çš„ï¼Œå¦‚æœè¯¥å€¼åœ¨ä½¿ç”¨ä¹‹å‰æ•°æ®åº“é‡æ–°å¯åŠ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¼ºåˆ¶çš„é»˜è®¤å€¼å°±ä¼šä¸¢å¤±ï¼Œå°±éœ€è¦æ•°æ®åº“å¯åŠ¨åé‡æ–°è®¾ç½®12345678910111213141516mysql&gt; alter table t1 auto_increment=5;Query OK, 0 rows affected (0.00 sec)Records: 0 Duplicates: 0 Warnings: 0mysql&gt; insert into t1 values(null,&#x27;handudu&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t1;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 2 | duyalan || 5 | handudu |+----+----------+3 rows in set (0.00 sec) 3.å¯ä»¥æ˜¯ç”¨last_insert_id()æŸ¥è¯¢å½“å‰çº¿ç¨‹æœ€åæ’å…¥è®°å½•ä½¿ç”¨çš„å€¼ã€‚å¦‚æœä¸€æ¬¡æ’å…¥å¤šæ¡è®°å½•ï¼Œé‚£ä¹ˆè¿”å›çš„æ˜¯ç¬¬ä¸€æ¡è®°å½•ä½¿ç”¨çš„è‡ªåŠ¨å¢é•¿å€¼ã€‚","text":"Auto_incrementMysql AUTO_INCREMENT 1.Innodbè¡¨çš„è‡ªåŠ¨å¢é•¿åˆ—å¯ä»¥æ‰‹å·¥æ’å…¥ï¼Œä½†æ˜¯æ’å…¥çš„å€¼å¦‚æœæ˜¯ç©ºæˆ–è€…0ï¼Œåˆ™å®é™…æ’å…¥çš„å°†æ˜¯è‡ªåŠ¨å¢é•¿åçš„å€¼1234567891011121314151617181920212223242526mysql&gt; create table t1(id int not null auto_increment primary key,name varchar(10));Query OK, 0 rows affected (0.06 sec)mysql&gt; desc t1;+-------+-------------+------+-----+---------+----------------+| Field | Type | Null | Key | Default | Extra |+-------+-------------+------+-----+---------+----------------+| id | int(11) | NO | PRI | NULL | auto_increment || name | varchar(10) | YES | | NULL | |+-------+-------------+------+-----+---------+----------------+2 rows in set (0.01 sec)mysql&gt; insert into t1 values(0,&#x27;fanboshi&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; insert into t1 values(null,&#x27;duyalan&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t1;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 2 | duyalan |+----+----------+2 rows in set (0.00 sec) 2.å¯ä»¥é€šè¿‡alter table t1 auto_incremenrt=n è¯­å¥å¼ºåˆ¶è®¾ç½®è‡ªåŠ¨å¢é•¿åˆ—çš„åˆå§‹å€¼ï¼Œé»˜è®¤ä»1å¼€å§‹ï¼Œä½†æ˜¯è¯¥å¼ºåˆ¶çš„é»˜è®¤å€¼æ˜¯ä¿ç•™åœ¨å†…å­˜ä¸­çš„ï¼Œå¦‚æœè¯¥å€¼åœ¨ä½¿ç”¨ä¹‹å‰æ•°æ®åº“é‡æ–°å¯åŠ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¼ºåˆ¶çš„é»˜è®¤å€¼å°±ä¼šä¸¢å¤±ï¼Œå°±éœ€è¦æ•°æ®åº“å¯åŠ¨åé‡æ–°è®¾ç½®12345678910111213141516mysql&gt; alter table t1 auto_increment=5;Query OK, 0 rows affected (0.00 sec)Records: 0 Duplicates: 0 Warnings: 0mysql&gt; insert into t1 values(null,&#x27;handudu&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t1;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 2 | duyalan || 5 | handudu |+----+----------+3 rows in set (0.00 sec) 3.å¯ä»¥æ˜¯ç”¨last_insert_id()æŸ¥è¯¢å½“å‰çº¿ç¨‹æœ€åæ’å…¥è®°å½•ä½¿ç”¨çš„å€¼ã€‚å¦‚æœä¸€æ¬¡æ’å…¥å¤šæ¡è®°å½•ï¼Œé‚£ä¹ˆè¿”å›çš„æ˜¯ç¬¬ä¸€æ¡è®°å½•ä½¿ç”¨çš„è‡ªåŠ¨å¢é•¿å€¼ã€‚ 123456789mysql&gt; select last_insert_id();+------------------+| last_insert_id() |+------------------+| 5 |+------------------+1 row in set (0.00 sec)æ³¨æ„last_insert_id()æ˜¯æ‰€æœ‰è¡¨auto_incrementçš„æœ€æ–°æ’å…¥å€¼ï¼Œå› æ­¤åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œè·å–æŸè¡¨çš„æœ€æ–°æ’å…¥auto_incrementå¯èƒ½å‡ºç°é”™è¯¯ 4.å¯¹äºinnodbè¡¨ï¼Œè‡ªåŠ¨å¢é•¿åˆ—å¿…é¡»æ˜¯ç´¢å¼•ï¼Œä¸”å¿…é¡»æ˜¯ç»„åˆç´¢å¼•çš„ç¬¬ä¸€åˆ—ï¼Œä¸”ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªauto_incrementå±æ€§ã€‚mysql&gt; create table t2(id int not null auto_increment,name varchar(10));ERROR 1075 (42000): Incorrect table definition; there can be only one auto column and it must be defined as a key123456789101112131415161718192021222324252627282930313233343536373839éä¸»é”®mysql&gt; create table t2(id int not null auto_increment,name varchar(10),index(id));Query OK, 0 rows affected (0.09 sec)mysql&gt; mysql&gt; show index from t2;+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| t2 | 1 | id | 1 | id | A | 0 | NULL | NULL | | BTREE | | |+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+1 row in set (0.00 sec)mysql&gt; show index from t2;+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+| t2 | 1 | id | 1 | id | A | 0 | NULL | NULL | | BTREE | | |+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+1 row in set (0.00 sec)ä¸æ˜¯ä¸»é”®ï¼Œåªæ˜¯æœ‰ç´¢å¼•mysql&gt; insert into t2 values(1,&#x27;fan&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; insert into t2 values(2,&#x27;fan&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t2;+----+------+| id | name |+----+------+| 1 | fan || 2 | fan |+----+------+2 rows in set (0.00 sec)å¦‚æœæ˜¯ç»„åˆç´¢å¼•ï¼Œä¹Ÿå¿…é¡»æ˜¯ç»„åˆç´¢å¼•çš„ç¬¬ä¸€åˆ—mysql&gt; create table t3(id1 int not null auto_increment,id2 int,name varchar(10),index(id2,id1));ERROR 1075 (42000): Incorrect table definition; there can be only one auto column and it must be defined as a keyä½†æ˜¯å¯¹äºMyISAMè¡¨ï¼Œè‡ªåŠ¨å¢é•¿åˆ—å¯ä»¥ä½¿ç»„åˆç´¢å¼•çš„å…¶ä»–åˆ—ï¼Œè¿™æ ·æ’å…¥è®°å½•åï¼Œè‡ªåŠ¨å¢é•¿åˆ—æ˜¯æŒ‰ç…§ç»„åˆç´¢å¼•çš„å‰é¢å‡ åˆ—è¿›è¡Œæ’åºåé€’å¢çš„ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445mysql&gt; create table t3_myisam(id1 int not null auto_increment,id2 int,name varchar(10),index(id2,id1)) engine=myisam;Query OK, 0 rows affected (0.04 sec)mysql&gt; insert into t3_myisam(id2,name) values(3,&#x27;fanboshi&#x27;),(1,&#x27;duyalan&#x27;),(1,&#x27;daduzi&#x27;),(2,&#x27;fan&#x27;),(5,&#x27;hehe&#x27;),(6,&#x27;keke&#x27;);Query OK, 6 rows affected (0.03 sec)Records: 6 Duplicates: 0 Warnings: 0mysql&gt; select * from t3_myisam;+-----+------+----------+| id1 | id2 | name |+-----+------+----------+| 1 | 3 | fanboshi || 1 | 1 | duyalan || 2 | 1 | daduzi || 1 | 2 | fan || 1 | 5 | hehe || 1 | 6 | keke |+-----+------+----------+6 rows in set (0.00 sec)å¥½åƒçœ‹ä¸å‡ºå•¥è§„å¾‹å†æ’å…¥ä¸€æ¬¡mysql&gt; insert into t3_myisam(id2,name) values(3,&#x27;fanboshi&#x27;),(1,&#x27;duyalan&#x27;),(1,&#x27;daduzi&#x27;),(2,&#x27;fan&#x27;),(5,&#x27;hehe&#x27;),(6,&#x27;keke&#x27;);Query OK, 6 rows affected (0.00 sec)Records: 6 Duplicates: 0 Warnings: 0mysql&gt; select * from t3_myisam order by id2,id1;+-----+------+----------+| id1 | id2 | name |+-----+------+----------+| 1 | 1 | duyalan || 2 | 1 | daduzi || 3 | 1 | duyalan || 4 | 1 | daduzi || 1 | 2 | fan || 2 | 2 | fan || 1 | 3 | fanboshi || 2 | 3 | fanboshi || 1 | 5 | hehe || 2 | 5 | hehe || 1 | 6 | keke || 2 | 6 | keke |+-----+------+----------+12 rows in set (0.00 sec)id2=1æœ‰å››ä¸ªï¼Œæ‰€ä»¥id1æœ‰1,2,3,4id2=2æœ‰ä¿©ï¼Œid1=1,2è‡ªåŠ¨å¢é•¿åˆ—id1ä½œä¸ºç»„åˆç´¢å¼•çš„ç¬¬äºŒåˆ—ï¼Œå¯¹è¯¥è¡¨æ’å…¥ä¸€äº›è®°å½•åï¼Œå¯ä»¥å‘ç°è‡ªåŠ¨å¢é•¿åˆ—æ˜¯æŒ‰ç…§ç»„åˆç´¢å¼•ç¬¬ä¸€åˆ—id2è¿›è¡Œæ’åºååˆ†ç»„é€’å¢çš„ 5.MyISAM åŠINNODBè¡¨ï¼Œè¡¨ä¸­auto_incrementæœ€å¤§å€¼è¢«åˆ é™¤ï¼Œå°†ä¸ä¼šè¢«é‡ç”¨ã€‚å°±æ˜¯è¯´ä¼šè·³å·123456789101112131415161718192021222324252627282930mysql&gt; insert into t1(name) values(&#x27;hehe&#x27;);Query OK, 1 row affected (0.02 sec)mysql&gt; select * from t1;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 2 | duyalan || 5 | handudu || 6 | hehe |+----+----------+4 rows in set (0.00 sec)mysql&gt; delete from t1 where id=6;Query OK, 1 row affected (0.08 sec)mysql&gt; insert into t1(name) values(&#x27;keke&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t1;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 2 | duyalan || 5 | handudu || 7 | keke |+----+----------+4 rows in set (0.00 sec) 6.ç”¨â€WHERE auto_col IS NULLâ€æ¡ä»¶é€‰æ‹©å‡ºæ–°æ’å…¥çš„è¡Œï¼Œå³åœ¨INSERTåé©¬ä¸Šç”¨: SELECT * FROM t4 WHERE id IS NULL;é€‰æ‹©å‡ºæ¥çš„å°†æ˜¯æ–°æ’å…¥çš„è¡Œï¼Œè€ŒéçœŸæ­£çš„æ»¡è¶³â€id IS NULLâ€æ¡ä»¶çš„è¡Œã€‚ä½†ä½ è¦æ˜¯å†æ‰§è¡Œä¸€æ¬¡ä¸Šè¿°æŸ¥è¯¢ï¼Œåˆ™è¿”å›çš„åˆå˜æˆäº†çœŸæ­£çš„æ»¡è¶³â€a IS NULLâ€æ¡ä»¶çš„è¡Œï¼Œç”±äºaæ˜¯ä¸»é”®ï¼Œå› æ­¤è‚¯å®šä¼šè¿”å›ç©ºé›†ã€‚è¿™çœ‹ä¸Šå»å¾ˆè¯¡å¼‚æ˜¯å—ï¼Œä¸è¿‡MySQLä¹Ÿä¸æƒ³è¿™ä¹ˆå¹²ï¼Œä¸ºäº†æ”¯æŒ ODBCæ ‡å‡†ä¸è¿‡å¯ä»¥å°†SQL_AUTO_IS_NULLè®¾ä¸º0æ¥ç¦æ­¢è¿™ä¸€ç”¨æ³•ã€‚æ­¤æ–¹æ³•è·å–last_insert_idä¸æ¨è1234567891011121314151617181920212223242526272829303132333435mysql&gt; insert into t1(name) values(&#x27;new&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; select * from t1 where id is null;Empty set (0.00 sec)mysql&gt; show variables like &#x27;sql_auto_is_null&#x27;;+------------------+-------+| Variable_name | Value |+------------------+-------+| sql_auto_is_null | OFF |+------------------+-------+1 row in set (0.00 sec)mysql&gt; set session sql_auto_is_null=on;Query OK, 0 rows affected (0.02 sec)mysql&gt; show variables like &#x27;sql_auto_is_null&#x27;;+------------------+-------+| Variable_name | Value |+------------------+-------+| sql_auto_is_null | ON |+------------------+-------+1 row in set (0.00 sec)mysql&gt; select * from t1 where id is null;+----+------+| id | name |+----+------+| 8 | new |+----+------+1 row in set (0.01 sec)mysql&gt; select * from t1 where id is null;Empty set (0.00 sec) 7.AUTO_INCREMENTå±æ€§ä¹Ÿç»™å¤åˆ¶å¸¦æ¥äº†éº»çƒ¦ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å¤åˆ¶AUTO_INCREMENTå±æ€§èƒ½æ­£ç¡®å·¥ä½œï¼Œä½†ä»¥ä¸‹æƒ…å†µè¿˜æ˜¯æœ‰é—®é¢˜ï¼š INSERT DELAYED â€¦ VALUES(LAST_INSERT_ID())ä¸èƒ½è¢«æ­£ç¡®å¤åˆ¶ å­˜å‚¨è¿‡ç¨‹æ’å…¥çš„ä½¿ç”¨AUTO_INCREMENTå±æ€§çš„è®°å½•ä¸èƒ½è¢«æ­£ç¡®å¤åˆ¶ é€šè¿‡â€ALTER TABLEâ€å‘½ä»¤å¢åŠ AUTO_INCREMENTå±æ€§æ—¶åœ¨ä¸»ä»èŠ‚ç‚¹ä¸Šäº§ç”Ÿçš„å€¼å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› ä¸ºè¿™ä¸ªå„è¡ŒAUTO_INCREMENTå±æ€§çš„å€¼å–å†³äºç‰©ç†ä¸Šçš„å­˜å‚¨é¡ºåºã€‚ 8.å¯¹äºreplicationçš„master-masteræ–¹å¼ ä¸ºé˜²æ­¢auto_incrementå­—æ®µçš„é‡å¤ï¼Œå¯åšå¦‚ä¸‹è®¾ç½®AæœåŠ¡å™¨çš„my.cnfè®¾ç½®å¦‚ä¸‹ï¼š auto_increment_offset = 1auto_increment_increment = 2 è¿™æ ·Açš„auto_incrementå­—æ®µäº§ç”Ÿçš„æ•°å€¼æ˜¯ï¼š1, 3, 5, 7, â€¦ BæœåŠ¡å™¨çš„my.cnfè®¾ç½®å¦‚ä¸‹ï¼š auto_increment_offset = 2auto_increment_increment = 2 è¿™æ ·Bçš„auto_incrementå­—æ®µäº§ç”Ÿçš„æ•°å€¼æ˜¯ï¼š2, 4, 6, 8, â€¦ 3å’ŒèŠ‚ç‚¹A offset=1 incr=3B offset=2 incr=3C offset=3 incr=3 8.æ ¹æ®å®˜æ–¹çš„è¯´æ˜ï¼šIf the value of auto_increment_offset is greater than that of auto_increment_increment, the value of auto_increment_offset is ignored. ï¼ˆå¦‚æœauto_increment_offsetçš„å€¼å¤§äºauto_increment_incrementçš„å€¼ï¼Œåˆ™auto_increment_offsetçš„å€¼ä¼šè¢«å¿½ç•¥ï¼‰1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162mysql&gt; show variables like &#x27;auto_increment%&#x27;;+--------------------------+-------+| Variable_name | Value |+--------------------------+-------+| auto_increment_increment | 1 || auto_increment_offset | 1 |+--------------------------+-------+2 rows in set (0.00 sec)mysql&gt; set session auto_increment_offset=5;Query OK, 0 rows affected (0.00 sec)mysql&gt; show variables like &#x27;auto_increment%&#x27;;+--------------------------+-------+| Variable_name | Value |+--------------------------+-------+| auto_increment_increment | 1 || auto_increment_offset | 5 |+--------------------------+-------+2 rows in set (0.00 sec)mysql&gt; create table t5 like t1;Query OK, 0 rows affected (0.07 sec)mysql&gt; desc t5;+-------+-------------+------+-----+---------+----------------+| Field | Type | Null | Key | Default | Extra |+-------+-------------+------+-----+---------+----------------+| id | int(11) | NO | PRI | NULL | auto_increment || name | varchar(10) | YES | | NULL | |+-------+-------------+------+-----+---------+----------------+2 rows in set (0.00 sec)mysql&gt; insert into t5(name) values(&#x27;fanboshi&#x27;);Query OK, 1 row affected (0.01 sec)mysql&gt; select * from t5;+----+----------+| id | name |+----+----------+| 1 | fanboshi |+----+----------+1 row in set (0.00 sec)mysql&gt; set session auto_increment_increment=5;Query OK, 0 rows affected (0.00 sec)mysql&gt; insert into t5(name) values(&#x27;duyalan&#x27;);Query OK, 1 row affected (0.00 sec)mysql&gt; insert into t5(name) values(&#x27;heheda&#x27;);Query OK, 1 row affected (0.02 sec)mysql&gt; select * from t5;+----+----------+| id | name |+----+----------+| 1 | fanboshi || 5 | duyalan || 10 | heheda |+----+----------+3 rows in set (0.00 sec)","categories":[],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://fuxkdb.com/tags/MySQL/"}]},{"title":"Hello World","slug":"hello-world","date":"2015-12-31T17:02:03.000Z","updated":"2017-08-05T15:33:01.000Z","comments":true,"path":"2016/01/01/hello-world/","link":"","permalink":"http://fuxkdb.com/2016/01/01/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[]}]}