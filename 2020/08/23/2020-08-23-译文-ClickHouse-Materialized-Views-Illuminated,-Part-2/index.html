<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>译文 clickhouse materialized views illuminated, part 2 | Fan()</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="ClickHouse物化视图" />
  
  
  
  
  <meta name="description" content="ClickHouse Materialized Views Illuminated, Part 2 Read part 1">
<meta property="og:type" content="article">
<meta property="og:title" content="译文 ClickHouse Materialized Views Illuminated, Part 2">
<meta property="og:url" content="http://fuxkdb.com/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-2/index.html">
<meta property="og:site_name" content="Fan()">
<meta property="og:description" content="ClickHouse Materialized Views Illuminated, Part 2 Read part 1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://altinity.com/wp-content/uploads/2020/02/d1a1c-stockvault-abstract-glowing-multicolor-wireframe-background268674_small.png">
<meta property="og:image" content="https://altinity.com/wp-content/uploads/2019/09/6c5f0-aggregate-functions-2.png">
<meta property="og:image" content="https://altinity.com/wp-content/uploads/2019/09/71938-mat-view-plumbing-with-target-table.png">
<meta property="article:published_time" content="2020-08-23T11:05:00.000Z">
<meta property="article:modified_time" content="2020-08-24T07:44:14.541Z">
<meta property="article:author" content="大范">
<meta property="article:tag" content="ClickHouse">
<meta property="article:tag" content="物化视图">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://altinity.com/wp-content/uploads/2020/02/d1a1c-stockvault-abstract-glowing-multicolor-wireframe-background268674_small.png">
  
    <link rel="alternate" href="/atom.xml" title="Fan()" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo.jpeg">
  <link rel="apple-touch-icon" href="/css/images/mylogo.jpeg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt; src:url("/css/fonts/FuturaPTBold.otf") format("woff");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt-light; src:url("/css/fonts/FuturaPTBook.otf") format("woff");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt-italic; src:url("/css/fonts/FuturaPTBookOblique.otf") format("woff");font-weight:400;font-style:italic;}
}

  </style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  
    <link rel="stylesheet" href="/css/vdonate.css" >
  

<meta name="generator" content="Hexo 6.2.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 0px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="124px" height="124px" alt="Hike News" src="/css/images/mylogo.jpeg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li> <a class="main-nav-link" href="/about">关于</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2020-08-23-译文-ClickHouse-Materialized-Views-Illuminated,-Part-2" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      译文 ClickHouse Materialized Views Illuminated, Part 2
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-2/" class="article-date">
	  <time datetime="2020-08-23T11:05:00.000Z" itemprop="datePublished">2020-08-23</time>
	</a>

      
      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

      

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ClickHouse-Materialized-Views-Illuminated-Part-2"><a href="#ClickHouse-Materialized-Views-Illuminated-Part-2" class="headerlink" title="ClickHouse Materialized Views Illuminated, Part 2"></a><a target="_blank" rel="noopener" href="https://altinity.com/blog/clickhouse-materialized-views-illuminated-part-2">ClickHouse Materialized Views Illuminated, Part 2</a></h1><p><img src="https://altinity.com/wp-content/uploads/2020/02/d1a1c-stockvault-abstract-glowing-multicolor-wireframe-background268674_small.png" alt="header"></p>
<p><strong><a target="_blank" rel="noopener" href="https://www.altinity.com/blog/clickhouse-materialized-views-illuminated-part-1">Read part 1</a></strong></p>
<a id="more"></a>
<p>在上一篇关于物化视图的博文中, 我们介绍了一种构造ClickHouse物化视图的方法, 该视图使用<a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/summingmergetree/">SummingMergeTree</a>引擎计算总和和计数. SummingMergeTree可以为这两种类型的聚合使用普通的SQL语法. 我们还让物化视图定义自动为数据创建基础表(.inner表).  这两种技术都很快速, 但对生产系统有限制(都不太适用于生产环境). </p>
<p>在本篇文章中, 我们将展示如何在现有的表上创建一个具有一系列聚合类型的物化视图. 当您需要计算的不仅仅是简单的总和时, 此方法非常适合. 对于表中有大量正在插入的数据(针对Part 1)中的 <code>POPULATE</code>, 使用POPULATE会填充历史数据, 但这期间向原表中新插入数据会被忽略掉而不会写入物化视图中)或必须处理表结构变更的情况, 这也非常方便.</p>
<h2 id="使用State函数和To-Tables创建更灵活的物化视图"><a href="#使用State函数和To-Tables创建更灵活的物化视图" class="headerlink" title="使用State函数和To Tables创建更灵活的物化视图"></a>使用State函数和To Tables创建更灵活的物化视图</h2><p>在线面的例子中, 我们将测量设备的读数. 让我们从表定义开始.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> counter (</span><br><span class="line">  <span class="keyword">when</span> DateTime <span class="keyword">DEFAULT</span> <span class="keyword">now</span>(),</span><br><span class="line">  device UInt32,</span><br><span class="line">  <span class="keyword">value</span> Float32</span><br><span class="line">) <span class="keyword">ENGINE</span>=MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(<span class="keyword">when</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (device, <span class="keyword">when</span>)</span><br></pre></td></tr></table></figure>
<p>接下来, 我们添加足够的数据, 以使查询速度变得足够慢: 10个设备的10亿行合成数据. 注意: 如果您要尝试这些操作, 只需输入100万行即可. 无论数据量如何, 示例都可以工作.</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO counter SELECT </span><br><span class="line">    toDateTime(<span class="string">&#x27;2015-01-01 00:00:00&#x27;</span>) + toInt64(number / <span class="number">10</span>) AS when, </span><br><span class="line">    (number % <span class="number">10</span>) + <span class="number">1</span> AS device, </span><br><span class="line">    ((device * <span class="number">3</span>) + (number / <span class="number">10000</span>)) + ((rand() % <span class="number">53</span>) * <span class="number">0.1</span>) AS value</span><br><span class="line">FROM system.numbers</span><br><span class="line">LIMIT <span class="number">1000000000</span></span><br><span class="line"></span><br><span class="line">↓ Progress: <span class="number">1.00</span> billion rows, <span class="number">8.00</span> GB (<span class="number">5.13</span> million rows/s., <span class="number">41.07</span> MB/s.) Ok.</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">194.814</span> sec. Processed <span class="number">1.00</span> billion rows, <span class="number">8.00</span> GB (<span class="number">5.13</span> million rows/s., <span class="number">41.07</span> MB/s.) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT count(*)</span><br><span class="line">FROM counter</span><br><span class="line"></span><br><span class="line">┌────count()─┐</span><br><span class="line">│ <span class="number">1000000000</span> │</span><br><span class="line">└────────────┘</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM counter</span><br><span class="line">LIMIT <span class="number">1</span></span><br><span class="line"></span><br><span class="line">┌────────────────when─┬─device─┬─value─┐</span><br><span class="line">│ <span class="number">2015</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │      <span class="number">1</span> │   <span class="number">3.6</span> │</span><br><span class="line">└─────────────────────┴────────┴───────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-02</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">30</span> /data/clickhouse/node2/data/duyalan]</span><br><span class="line">#du -sh counter/</span><br><span class="line"><span class="number">13</span>G     counter/</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-02</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">35</span> /data/clickhouse/node2/data/duyalan]</span><br><span class="line">#du -sh counter/</span><br><span class="line"><span class="number">12</span>G     counter/</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>bj2-all-clickhouse-test<span class="number">-02</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">04</span> /data/clickhouse/node2/data/duyalan]</span><br><span class="line">#du -sh counter/</span><br><span class="line"><span class="number">6.5</span>G    counter/</span><br><span class="line">数据慢慢被压实</span><br></pre></td></tr></table></figure>
<p>现在, 让我们看一下我们希望定期运行的示例查询.  它汇总了整个采样期间所有设备的所有数据. 在这种情况下, 这意味着表中3.25年的数据, 都是在2019年之前. </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    count(*) AS count, </span><br><span class="line">    max(value) AS max, </span><br><span class="line">    min(value) AS min, </span><br><span class="line">    avg(value) AS avg</span><br><span class="line">FROM counter</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">100000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.077</span> │ <span class="number">50005.599374785554</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">100000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0761</span> │  <span class="number">50008.59962170133</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">100000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │ <span class="number">50011.599634214646</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">100000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">50014.59989124005</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">100000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0384</span> │  <span class="number">50017.59997032414</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">100000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.1045</span> │  <span class="number">50020.60019940771</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">100000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │  <span class="number">50023.60046194672</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">100000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0477</span> │  <span class="number">50026.60002471252</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">100000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">50029.60008679837</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">100000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0629</span> │  <span class="number">50032.60051765903</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">12.036</span> sec. Processed <span class="number">1.00</span> billion rows, <span class="number">8.00</span> GB (<span class="number">83.08</span> million rows/s., <span class="number">664.67</span> MB/s.) </span><br><span class="line"></span><br><span class="line">bj2-all-clickhouse-test<span class="number">-02</span> :) select min(when),max(when) <span class="keyword">from</span> counter;</span><br><span class="line"></span><br><span class="line">SELECT </span><br><span class="line">    min(when), </span><br><span class="line">    max(when)</span><br><span class="line">FROM counter</span><br><span class="line"></span><br><span class="line">┌───────────min(when)─┬───────────max(when)─┐</span><br><span class="line">│ <span class="number">2015</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> │ <span class="number">2018</span><span class="number">-03</span><span class="number">-03</span> <span class="number">09</span>:<span class="number">46</span>:<span class="number">39</span> │</span><br><span class="line">└─────────────────────┴─────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">9.941</span> sec. Processed <span class="number">1.00</span> billion rows, <span class="number">4.00</span> GB (<span class="number">100.59</span> million rows/s., <span class="number">402.36</span> MB/s.) </span><br></pre></td></tr></table></figure>
<p>前面的查询很慢, 因为它必须读取表中的所有数据才能获得答案.  我们想要设计一个物化视图, 该视图读取的数据要少得多.  事实证明, 如果我们定义了一个每天汇总数据的视图, 则ClickHouse将正确地在整个时间间隔内汇总每天的数据. </p>
<p>与前面的简单示例(Part 1)不同, 我们将自己定义目标(.inner表)表.  这样做的好处是, 该表现在可见, 这使得加载数据以及进行模式迁移(表结构变更)更加容易.  下面是目标表的定义. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> counter_daily (</span><br><span class="line">  <span class="keyword">day</span> DateTime,</span><br><span class="line">  device UInt32,</span><br><span class="line">  <span class="keyword">count</span> UInt64,</span><br><span class="line">  max_value_state AggregateFunction(<span class="keyword">max</span>, Float32),</span><br><span class="line">  min_value_state AggregateFunction(<span class="keyword">min</span>, Float32),</span><br><span class="line">  avg_value_state AggregateFunction(<span class="keyword">avg</span>, Float32)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENGINE</span> = SummingMergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> tuple()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (device, <span class="keyword">day</span>)</span><br></pre></td></tr></table></figure>
<p>该表定义引入了一种新的数据类型, 称为<a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/en/sql-reference/data-types/aggregatefunction/">AggregateFunction</a>, 该数据类型保存部分聚合的数据(which holds partially aggregated data). 这个数据类型用于sum和count以外的聚合需求. 接下来, 我们创建相应的物化视图. 它从counter(源表)中选择数据, 并使用CREATE语句中的特殊TO语法将数据发送到counter_daily(目标表). 该表有聚合函数, SELECT语句有与之相匹配的函数, 如’ maxState ‘. 我们将在详细讨论聚合函数时讨论它们之间的关系. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> counter_daily_mv</span><br><span class="line"><span class="keyword">TO</span> counter_daily</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    toStartOfDay(<span class="keyword">when</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">    device,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span>,</span><br><span class="line">    maxState(<span class="keyword">value</span>) <span class="keyword">AS</span> max_value_state,</span><br><span class="line">    minState(<span class="keyword">value</span>) <span class="keyword">AS</span> min_value_state,</span><br><span class="line">    avgState(<span class="keyword">value</span>) <span class="keyword">AS</span> avg_value_state</span><br><span class="line"><span class="keyword">FROM</span> counter</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">when</span> &gt;= toDate(<span class="string">&#x27;2019-01-01 00:00:00&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>TO关键字使我们可以指向目标表(存储物化视图数据的表, 在本例中即是counter_daily表), 但有一个缺点.  ClickHouse不允许在TO中使用POPULATE关键字.  因此, 物化视图创建后没有任何数据.  我们将手动加载数据.  但是, 我们还将使用一个不错的技巧, 使我们可以避免在同时进行活动数据加载的情况下出现问题. </p>
<p>注意, 视图定义有一个WHERE子句. 这意味着2019年之前的任何数据都应该被忽略. 我们现在有了一种不丢失数据的方法来处理数据加载. 该视图将处理2019年到达的新数据. 同时, 我们可以通过插入加载2018年及之前的旧数据. </p>
<p>让我们通过将新数据加载到counter表中来演示它是如何工作的. 新数据将于2019年开始, 并将自动加载到视图中. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> counter</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    toDateTime(<span class="string">&#x27;2019-01-01 00:00:00&#x27;</span>) + toInt64(<span class="built_in">number</span>/<span class="number">10</span>) <span class="keyword">AS</span> <span class="keyword">when</span>,</span><br><span class="line">    (<span class="built_in">number</span> % <span class="number">10</span>) + <span class="number">1</span> <span class="keyword">AS</span> device,</span><br><span class="line">    (device * <span class="number">3</span>) +  (<span class="built_in">number</span> / <span class="number">10000</span>) + (<span class="keyword">rand</span>() % <span class="number">53</span>) * <span class="number">0.1</span> <span class="keyword">AS</span> <span class="keyword">value</span></span><br><span class="line">  <span class="keyword">FROM</span> system.numbers <span class="keyword">LIMIT</span> <span class="number">100000000</span></span><br></pre></td></tr></table></figure>
<p>现在, 使用以下INSERT手动加载旧数据.  它会加载2018年及之前的所有数据. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> counter_daily</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  toStartOfDay(<span class="keyword">when</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">  device,</span><br><span class="line">  <span class="keyword">count</span>(*) <span class="keyword">AS</span> <span class="keyword">count</span>,</span><br><span class="line">  maxState(<span class="keyword">value</span>) <span class="keyword">AS</span> max_value_state,</span><br><span class="line">  minState(<span class="keyword">value</span>) <span class="keyword">AS</span> min_value_state,</span><br><span class="line">  avgState(<span class="keyword">value</span>) <span class="keyword">AS</span> avg_value_state</span><br><span class="line"><span class="keyword">FROM</span> counter</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">when</span> &lt; toDateTime(<span class="string">&#x27;2019-01-01 00:00:00&#x27;</span>)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>我们终于可以从视图中查询数据了.  与目标表和物化化视图一样, ClickHouse使用专用语法从视图中进行选择. </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">物化视图目标表</span><br><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    sum(count) AS count, </span><br><span class="line">    maxMerge(max_value_state) AS max, </span><br><span class="line">    minMerge(min_value_state) AS min, </span><br><span class="line">    avgMerge(avg_value_state) AS avg</span><br><span class="line">FROM counter_daily</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">110000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.051</span> │  <span class="number">45914.69035234097</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">110000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0291</span> │  <span class="number">45917.69056040798</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">110000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │ <span class="number">45920.690478928045</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">110000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">45923.69086044358</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">110000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0114</span> │  <span class="number">45926.69083122718</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">110000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.0475</span> │ <span class="number">45929.691088042426</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">110000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │  <span class="number">45932.69135215635</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">110000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0107</span> │ <span class="number">45935.690912335944</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">110000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">45938.69098338585</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">110000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0429</span> │  <span class="number">45941.69140548378</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.019</span> sec. Processed <span class="number">13.69</span> thousand rows, <span class="number">1.12</span> MB (<span class="number">729.14</span> thousand rows/s., <span class="number">59.84</span> MB/s.) </span><br><span class="line"></span><br><span class="line">物化视图</span><br><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    sum(count) AS count, </span><br><span class="line">    maxMerge(max_value_state) AS max, </span><br><span class="line">    minMerge(min_value_state) AS min, </span><br><span class="line">    avgMerge(avg_value_state) AS avg</span><br><span class="line">FROM counter_daily_mv</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">110000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.051</span> │  <span class="number">45914.69035234097</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">110000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0291</span> │  <span class="number">45917.69056040798</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">110000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │ <span class="number">45920.690478928045</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">110000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">45923.69086044358</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">110000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0114</span> │  <span class="number">45926.69083122718</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">110000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.0475</span> │ <span class="number">45929.691088042426</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">110000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │  <span class="number">45932.69135215635</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">110000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0107</span> │ <span class="number">45935.690912335944</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">110000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">45938.69098338585</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">110000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0429</span> │  <span class="number">45941.69140548378</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">0.003</span> sec. Processed <span class="number">13.69</span> thousand rows, <span class="number">1.12</span> MB (<span class="number">3.99</span> million rows/s., <span class="number">327.87</span> MB/s.) </span><br><span class="line"></span><br><span class="line">源表</span><br><span class="line">SELECT </span><br><span class="line">    device, </span><br><span class="line">    count(*) AS count, </span><br><span class="line">    max(value) AS max, </span><br><span class="line">    min(value) AS min, </span><br><span class="line">    avg(value) AS avg</span><br><span class="line">FROM counter</span><br><span class="line">GROUP BY device</span><br><span class="line">ORDER BY device ASC</span><br><span class="line"></span><br><span class="line">┌─device─┬─────count─┬────────max─┬─────min─┬────────────────avg─┐</span><br><span class="line">│      <span class="number">1</span> │ <span class="number">110000000</span> │  <span class="number">100008.15</span> │   <span class="number">3.051</span> │  <span class="number">45914.69035234098</span> │</span><br><span class="line">│      <span class="number">2</span> │ <span class="number">110000000</span> │ <span class="number">100011.164</span> │  <span class="number">6.0291</span> │  <span class="number">45917.69056040798</span> │</span><br><span class="line">│      <span class="number">3</span> │ <span class="number">110000000</span> │   <span class="number">100014.1</span> │  <span class="number">9.0022</span> │  <span class="number">45920.69047892806</span> │</span><br><span class="line">│      <span class="number">4</span> │ <span class="number">110000000</span> │  <span class="number">100017.17</span> │ <span class="number">12.0063</span> │  <span class="number">45923.69086044358</span> │</span><br><span class="line">│      <span class="number">5</span> │ <span class="number">110000000</span> │ <span class="number">100020.164</span> │ <span class="number">15.0114</span> │ <span class="number">45926.690831227155</span> │</span><br><span class="line">│      <span class="number">6</span> │ <span class="number">110000000</span> │  <span class="number">100023.19</span> │ <span class="number">18.0475</span> │  <span class="number">45929.69108804243</span> │</span><br><span class="line">│      <span class="number">7</span> │ <span class="number">110000000</span> │ <span class="number">100026.055</span> │ <span class="number">21.0566</span> │ <span class="number">45932.691352156355</span> │</span><br><span class="line">│      <span class="number">8</span> │ <span class="number">110000000</span> │  <span class="number">100029.14</span> │ <span class="number">24.0107</span> │ <span class="number">45935.690912335944</span> │</span><br><span class="line">│      <span class="number">9</span> │ <span class="number">110000000</span> │  <span class="number">100032.17</span> │ <span class="number">27.0218</span> │  <span class="number">45938.69098338586</span> │</span><br><span class="line">│     <span class="number">10</span> │ <span class="number">110000000</span> │  <span class="number">100035.02</span> │ <span class="number">30.0429</span> │  <span class="number">45941.69140548378</span> │</span><br><span class="line">└────────┴───────────┴────────────┴─────────┴────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span>. Elapsed: <span class="number">14.041</span> sec. Processed <span class="number">1.10</span> billion rows, <span class="number">8.80</span> GB (<span class="number">78.34</span> million rows/s., <span class="number">626.72</span> MB/s.) </span><br></pre></td></tr></table></figure>
<p>该查询正确总结了包括新插入数据在内的所有数据. 您可以通过在counter表上重新运行原始选择来检查计算结果是否一致. 不同之处在于, 物化视图返回数据的速度要快900倍(在我的测试中为4680倍). 由此可见, 学习一些新语法是值得的!!</p>
<p>此时, 我们可以回过头来解释一下在这一切的幕后发生了什么. </p>
<h2 id="Aggregate-Functions"><a href="#Aggregate-Functions" class="headerlink" title="Aggregate Functions"></a>Aggregate Functions</h2><p>Aggregate functions类似于收集器(collectors), 允许ClickHouse从分布在多个parts上的数据构建聚合. 下面的图表显示了如何计算平均值. 我们从源表中的一个可选值开始. 物化视图使用avgState函数将数据转换为<code>partial aggregate</code>, avgState函数是一个内部结构. 最后, 在查询数据时, 应用avgMerge将partial aggregates的数据累加为最终的数字. </p>
<p><img src="https://altinity.com/wp-content/uploads/2019/09/6c5f0-aggregate-functions-2.png" alt="af"></p>
<p><code>partial aggregate</code>使物化视图能够处理分布在多个节点上的多个parts上的数据. 即使您更改了group by列, merge函数也可以正确地组装聚合. 仅仅结合简单的平均值是行不通的, 因为它们在将每个部分平均值加到总数时缺乏必要的权重. 这种行为有一个重要的后果(这段不会翻译, 原文: It would not work just to combine simple average values, because they would be lacking the weights necessary to scale each partial average as it added to the total. This behavior has an important consequence.). </p>
<p>还记得上面我们提到过, ClickHouse可以使用带有汇总的每日数据的物化视图来回答我们的示例查询吗?这是聚合函数工作的结果. 这意味着我们的daily视图还可以回答关于周、月、年或整个间隔的问题. </p>
<p>ClickHouse有点不寻常, 它直接以SQL语法公开了partial aggregates, 但是它们解决问题的方式非常强大.  当您设计实例化视图时, 请尝试使用每日汇总之类的技巧来解决单个视图中的多个问题.  单个视图可以回答很多问题. </p>
<h2 id="Table-Engines-for-Materialized-Views"><a href="#Table-Engines-for-Materialized-Views" class="headerlink" title="Table Engines for Materialized Views"></a>Table Engines for Materialized Views</h2><p>ClickHouse有多个对物化视图有用的引擎. AggregatingMergeTree引擎只使用聚合函数. 如果您想做计数或求和, 您需要使用目标表中的AggregateFunction数据类型来定义它们. 您还需要在视图和select语句中使用state和merge函数. 例如, 要处理计数(count), 您需要在上面的示例中使用countState(count)和countMerge(count). </p>
<p>我们建议使用SummingMergeTree引擎在物化视图中进行聚合. 它可以很好地处理聚合函数. 它可以很好地处理聚合函数.  但是, 它会将它们隐藏起来以进行总数和计数, 这对于简单的案例来说非常方便. 在这种情况下, 它不会阻止您使用state和merge函数; 只是你没必要这么做. 同时, 它完成了AggregatingMergeTree的所有工作. </p>
<h2 id="Schema-Migration"><a href="#Schema-Migration" class="headerlink" title="Schema Migration"></a>Schema Migration</h2><p>在生产系统中, 数据库模式往往会发生变化, 特别是那些正在积极开发的系统. 当使用带有显式目标表的物化视图时, 可以相对容易地管理这些更改. </p>
<p>让我们举一个简单的例子. 假设counter表的名称更改为counter_replicated. 一旦应用了此更改, 物化视图将无法工作. 更糟糕的是, 这个错误将阻止对counter表的插入. 您可以按照以下方式处理更改. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Delete view prior to schema change.</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> counter_daily_mv</span><br><span class="line"><span class="comment">-- Rename source table.</span></span><br><span class="line"><span class="keyword">RENAME</span> <span class="keyword">TABLE</span> counter <span class="keyword">TO</span> counter_replicated</span><br><span class="line"><span class="comment">-- Recreate view with correct source table name.</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">MATERIALIZED</span> <span class="keyword">VIEW</span> counter_daily_mv</span><br><span class="line"><span class="keyword">TO</span> counter_daily</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">  toStartOfDay(<span class="keyword">when</span>) <span class="keyword">as</span> <span class="keyword">day</span>,</span><br><span class="line">  device,</span><br><span class="line">  <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span>,</span><br><span class="line">  maxState(<span class="keyword">value</span>) <span class="keyword">AS</span> max_value_state,</span><br><span class="line">  minState(<span class="keyword">value</span>) <span class="keyword">AS</span> min_value_state,</span><br><span class="line">  avgState(<span class="keyword">value</span>) <span class="keyword">AS</span> avg_value_state</span><br><span class="line"><span class="keyword">FROM</span> counter_replicated</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> device, <span class="keyword">day</span></span><br></pre></td></tr></table></figure>
<p>根据架构迁移中的实际步骤, 您可能必须处理更改物化视图定义时插入到源表的数据(这些数据未插入到物化视图中).  您可以使用过滤条件和手动加载来处理该问题, 如我们在主要示例中所示. </p>
<h2 id="Materialized-View-Plumbing-and-Data-Sizes"><a href="#Materialized-View-Plumbing-and-Data-Sizes" class="headerlink" title="Materialized View Plumbing and Data Sizes"></a>Materialized View Plumbing and Data Sizes</h2><p>最后, 让我们再看看数据表和物化视图之间的关系. 目标表是一个普通表. 您可以从目标表或物化视图中选择数据. 没有区别. 此外, 如果您删除物化视图, 目标表扔将保留. 正如我们刚才所展示的, 您可以通过简单地删除和重新创建视图来对其进行模式更改. 如果需要更改目标表本身, 可以像对任何其他表一样运行ALTER table命令. </p>
<p><img src="https://altinity.com/wp-content/uploads/2019/09/71938-mat-view-plumbing-with-target-table.png" alt="img"></p>
<p>该图还显示了源表和目标表的数据大小.  物化视图通常远小于其汇总数据的表.  我们的示例就是这样的结果.  以下查询显示了此示例的大小差异. </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">table</span>, </span><br><span class="line">    formatReadableSize(sum(data_compressed_bytes)) <span class="keyword">AS</span> tc, </span><br><span class="line">    formatReadableSize(sum(data_uncompressed_bytes)) <span class="keyword">AS</span> tu, </span><br><span class="line">    sum(data_compressed_bytes) / sum(data_uncompressed_bytes) <span class="keyword">AS</span> ratio</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">system</span>.<span class="keyword">columns</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">database</span> = currentDatabase()</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">table</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">table</span> <span class="keyword">ASC</span></span><br><span class="line"></span><br><span class="line">┌─<span class="keyword">table</span>────────────────────────────────┬─tc─────────┬─tu─────────┬──────────────ratio─┐</span><br><span class="line">│ counter                              │ <span class="number">7.14</span> GiB   │ <span class="number">12.29</span> GiB  │ <span class="number">0.5805970993939394</span> │</span><br><span class="line">│ counter_daily                        │ <span class="number">248.77</span> KiB │ <span class="number">494.31</span> KiB │  <span class="number">0.503261750004939</span> │</span><br><span class="line">│ counter_daily_mv                     │ <span class="number">0.00</span> B     │ <span class="number">0.00</span> B     │                <span class="keyword">nan</span> │</span><br><span class="line">└──────────────────────────────────────┴────────────┴────────────┴────────────────────┘</span><br></pre></td></tr></table></figure>
<p>如计算所示, 物化视图目标表大约比物化视图派生的源数据小3万倍. 这种差异极大地加快了查询速度. 如前面所示, 在使用来自物化视图的数据时, 测试查询的运行速度大约快了900x(我这里测试为4680x). </p>
<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap-up"></a>Wrap-up</h2><p>ClickHouse物化视图非常灵活, 这得益于强大的聚合功能以及源表、物化视图和目标表之间的简单关系. 物化视图允许显式目标表, 这是一个有用的特性, 可以简化模式迁移. 您还可以通过向视图选择定义添加筛选条件并手动加载丢失的数据来减少可能丢失的视图更新. </p>
<p>物化视图还有许多其他方法可以帮助转换数据. 我们已经描述了其中的一些问题, 比如 <a target="_blank" rel="noopener" href="https://www.altinity.com/blog/clickhouse-continues-to-crush-time-series">last point queries</a>, 并且计划将来在这个博客上写一些其他的问题. 欲了解更多信息, 请查看我们最近的网络研讨会<a target="_blank" rel="noopener" href="https://www.altinity.com/events/2019/6/26/clickhouse-and-the-magic-of-materialized-views">ClickHouse and the Magic of Materialized Views</a>. 我们在这里介绍了几个用例示例. </p>
<p>最后, 如果你正在以你认为其他用户会感兴趣的方式使用物化视图, 写一篇文章或者在当地的ClickHouse会议上发言. 我们很乐意在Altinity的博客上发布社区用户的内容, 并在未来的聚会上寻找演讲者. 如果你有什么想与社区分享的, 请让我们知道. </p>

      
    </div>
    <footer class="article-footer">
      
        <div id="donation_div"></div>


<script src="/js/vdonate.js"></script>

<script>
var a = new Donate({
  title: '如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!', // 可选参数，打赏标题
  btnText: '打赏支持', // 可选参数，打赏按钮文字
  el: document.getElementById('donation_div'),
  wechatImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG65.jpeg',
  alipayImage: 'https://raw.githubusercontent.com/Fanduzi/Fandb.github.io/master/css/images/WechatIMG64.jpeg'
});
</script>
      
      
      <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
          <strong>本文作者:  </strong>大范</a>
          </li>
          <li class="post-copyright-link">
          <strong>本文链接:  </strong>
          <a href="/2020/08/23/2020-08-23-译文-ClickHouse-Materialized-Views-Illuminated,-Part-2/" target="_blank" title="译文 ClickHouse Materialized Views Illuminated, Part 2">http://fuxkdb.com/2020/08/23/2020-08-23-译文-ClickHouse-Materialized-Views-Illuminated,-Part-2/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明:   </strong>
            本博客所有文章除特别声明外，均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
            许可协议。转载请注明出处
          </li>
         
        </ul>
<div>

      
      
        
	<div id="comment">
		<!-- 来必力City版安装代码 -->
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTQ4MS82MDQ5">
		<script type="text/javascript">
		   (function(d, s) {
		       var j, e = d.getElementsByTagName(s)[0];

		       if (typeof LivereTower === 'function') { return; }

		       j = d.createElement(s);
		       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
		       j.async = true;

		       e.parentNode.insertBefore(j, e);
		   })(document, 'script');
		</script>
		<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
		</div>
		<!-- City版安装代码已完成 -->
	</div>



      
      
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ClickHouse/" rel="tag">ClickHouse</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE/" rel="tag">物化视图</a></li></ul>

      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/08/28/2020-08-28-ClickHouse%E6%9F%A5%E8%AF%A2%E5%88%86%E5%B8%83%E5%BC%8F%E8%A1%A8LEFT-JOIN%E6%94%B9RIGHT-JOIN%E7%9A%84%E5%A4%A7%E5%9D%91/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          ClickHouse查询分布式表LEFT JOIN改RIGHT JOIN的大坑
        
      </div>
    </a>
  
  
    <a href="/2020/08/23/2020-08-23-%E8%AF%91%E6%96%87-ClickHouse-Materialized-Views-Illuminated,-Part-1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">译文 ClickHouse Materialized Views Illuminated, Part 1</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ClickHouse-Materialized-Views-Illuminated-Part-2"><span class="nav-number">1.</span> <span class="nav-text">ClickHouse Materialized Views Illuminated, Part 2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8State%E5%87%BD%E6%95%B0%E5%92%8CTo-Tables%E5%88%9B%E5%BB%BA%E6%9B%B4%E7%81%B5%E6%B4%BB%E7%9A%84%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE"><span class="nav-number">1.1.</span> <span class="nav-text">使用State函数和To Tables创建更灵活的物化视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aggregate-Functions"><span class="nav-number">1.2.</span> <span class="nav-text">Aggregate Functions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Table-Engines-for-Materialized-Views"><span class="nav-number">1.3.</span> <span class="nav-text">Table Engines for Materialized Views</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Schema-Migration"><span class="nav-number">1.4.</span> <span class="nav-text">Schema Migration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Materialized-View-Plumbing-and-Data-Sizes"><span class="nav-number">1.5.</span> <span class="nav-text">Materialized View Plumbing and Data Sizes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wrap-up"><span class="nav-number">1.6.</span> <span class="nav-text">Wrap-up</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2022 Fan() All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>





  
<script src="/js/dialog.js"></script>









	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            Fan()
          </div>
          <div class="panel-body">
            Copyright © 2022 大范 All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>